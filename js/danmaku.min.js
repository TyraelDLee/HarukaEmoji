function DanmakuWSS(a,b=1,c){this.firstPackageReveiced=!1,this.retry=3,this.retried=0,this.ver=b,this.timer=null,this.wss=null,this.frontEndHost=c,this.onUserBehave=!1,this.roomID=a.room_id,this.biggest_list=null===a.biggest_list?100:a.biggest_list,this.AUTH_PAYLOAD={uid:a.uid,roomid:this.roomID,protover:3,buvid:a.buvid,platform:"web",clientver:"1.8.5",type:2,key:a.token};const d={emoji:[{text:"[dog]",asset:"4428c84e694fbf4e0ef6c06e958d9352c3582740"},{text:"[\u82B1]",asset:"7dd2ef03e13998575e4d8a803c6e12909f94e72b"},{text:"[\u5999]",asset:"08f735d950a0fba267dda140673c9ab2edf6410d"},{text:"[\u54C7]",asset:"650c3e22c06edcbca9756365754d38952fc019c3"},{text:"[\u7231]",asset:"1daaa5d284dafaa16c51409447da851ff1ec557f"},{text:"[\u624B\u673A]",asset:"b159f90431148a973824f596288e7ad6a8db014b"},{text:"[\u6487\u5634]",asset:"4255ce6ed5d15b60311728a803d03dd9a24366b2"},{text:"[\u59D4\u5C48]",asset:"69312e99a00d1db2de34ef2db9220c5686643a3f"},{text:"[\u6293\u72C2]",asset:"a7feb260bb5b15f97d7119b444fc698e82516b9f"},{text:"[\u6BD4\u5FC3]",asset:"4e029593562283f00d39b99e0557878c4199c71d"},{text:"[\u8D5E]",asset:"2dd666d3651bafe8683acf770b7f4163a5f49809"},{text:"[\u6ED1\u7A3D]",asset:"8624fd172037573c8600b2597e3731ef0e5ea983"},{text:"[\u5403\u74DC]",asset:"ffb53c252b085d042173379ac724694ce3196194"},{text:"[\u7B11\u54ED]",asset:"c5436c6806c32b28d471bb23d42f0f8f164a187a"},{text:"[\u6342\u8138]",asset:"e6073c6849f735ae6cb7af3a20ff7dcec962b4c5"},{text:"[\u559D\u5F69]",asset:"b51824125d09923a4ca064f0c0b49fc97d3fab79"},{text:"[\u5077\u7B11]",asset:"e2ba16f947a23179cdc00420b71cc1d627d8ae25"},{text:"[\u5927\u7B11]",asset:"e2589d086df0db8a7b5ca2b1273c02d31d4433d4"},{text:"[\u60CA\u559C]",asset:"9c75761c5b6e1ff59b29577deb8e6ad996b86bd7"},{text:"[\u50B2\u5A07]",asset:"b5b44f099059a1bafb2c2722cfe9a6f62c1dc531"},{text:"[\u75BC]",asset:"492b10d03545b7863919033db7d1ae3ef342df2f"},{text:"[\u5413]",asset:"c6bed64ffb78c97c93a83fbd22f6fdf951400f31"},{text:"[\u9634\u9669]",asset:"a4df45c035b0ca0c58f162b5fb5058cf273d0d09"},{text:"[\u60CA\u8BB6]",asset:"bc26f29f62340091737c82109b8b91f32e6675ad"},{text:"[\u751F\u75C5]",asset:"84c92239591e5ece0f986c75a39050a5c61c803c"},{text:"[\u5618]",asset:"b6226219384befa5da1d437cb2ff4ba06c303844"},{text:"[\u5978\u7B11]",asset:"5935e6a4103d024955f749d428311f39e120a58a"},{text:"[\u56E7]",asset:"204413d3cf330e122230dcc99d29056f2a60e6f2"},{text:"[\u6342\u81382]",asset:"a2ad0cc7e390a303f6d243821479452d31902a5f"},{text:"[\u51FA\u7A8D]",asset:"bb8e95fa54512ffea07023ea4f2abee4a163e7a0"},{text:"[\u5410\u4E86\u554A]",asset:"2b6b4cc33be42c3257dc1f6ef3a39d666b6b4b1a"},{text:"[\u9F3B\u5B50]",asset:"f4ed20a70d0cb85a22c0c59c628aedfe30566b37"},{text:"[\u8C03\u76AE]",asset:"84fe12ecde5d3875e1090d83ac9027cb7d7fba9f"},{text:"[\u9178]",asset:"98fd92c6115b0d305f544b209c78ec322e4bb4ff"},{text:"[\u51B7]",asset:"b804118a1bdb8f3bec67d9b108d5ade6e3aa93a9"},{text:"[OK]",asset:"86268b09e35fbe4215815a28ef3cf25ec71c124f"},{text:"[\u5FAE\u7B11]",asset:"f605dd8229fa0115e57d2f16cb019da28545452b"},{text:"[\u85CF\u72D0]",asset:"05ef7849e7313e9c32887df922613a7c1ad27f12"},{text:"[\u9F87\u7259]",asset:"8b99266ea7b9e86cf9d25c3d1151d80c5ba5c9a1"},{text:"[\u9632\u62A4]",asset:"17435e60dcc28ce306762103a2a646046ff10b0a"},{text:"[\u7B11]",asset:"a91a27f83c38b5576f4cd08d4e11a2880de78918"},{text:"[\u4E00\u822C]",asset:"8d436de0c3701d87e4ca9c1be01c01b199ac198e"},{text:"[\u5ACC\u5F03]",asset:"c409425ba1ad2c6534f0df7de350ba83a9c949e5"},{text:"[\u65E0\u8BED]",asset:"4781a77be9c8f0d4658274eb4e3012c47a159f23"},{text:"[\u54C8\u6B20]",asset:"6e496946725cd66e7ff1b53021bf1cc0fc240288"},{text:"[\u53EF\u601C]",asset:"8e88e6a137463703e96d4f27629f878efa323456"},{text:"[\u6B6A\u5634\u7B11]",asset:"bea1f0497888f3e9056d3ce14ba452885a485c02"},{text:"[\u4EB2\u4EB2]",asset:"10662d9c0d6ddb3203ecf50e77788b959d4d1928"},{text:"[\u95EE\u53F7]",asset:"a0c456b6d9e3187399327828a9783901323bfdb5"},{text:"[\u6CE2\u5409]",asset:"57dee478868ed9f1ce3cf25a36bc50bde489c404"},{text:"[OH]",asset:"0d5123cddf389302df6f605087189fd10919dc3c"},{text:"[\u518D\u89C1]",asset:"f408e2af700adcc2baeca15510ef620bed8d4c43"},{text:"[\u767D\u773C]",asset:"7fa907ae85fa6327a0466e123aee1ac32d7c85f7"},{text:"[\u9F13\u638C]",asset:"d581d0bc30c8f9712b46ec02303579840c72c42d"},{text:"[\u5927\u54ED]",asset:"816402551e6ce30d08b37a917f76dea8851fe529"},{text:"[\u5446]",asset:"179c7e2d232cd74f30b672e12fc728f8f62be9ec"},{text:"[\u6D41\u6C57]",asset:"b00e2e02904096377061ec5f93bf0dd3321f1964"},{text:"[\u751F\u6C14]",asset:"2c69dad2e5c0f72f01b92746bc9d148aee1993b2"},{text:"[\u52A0\u6CB9]",asset:"fbc3c8bc4152a65bbf4a9fd5a5d27710fbff2119"},{text:"[\u5BB3\u7F9E]",asset:"d8ce9b05c0e40cec61a15ba1979c8517edd270bf"},{text:"[\u864E\u5E74]",asset:"a51af0d7d9e60ce24f139c468a3853f9ba9bb184"},{text:"[doge2]",asset:"f547cc853cf43e70f1e39095d9b3b5ac1bf70a8d"},{text:"[\u91D1\u94B1\u8C79]",asset:"b6e8131897a9a718ee280f2510bfa92f1d84429b"},{text:"[\u74DC\u5B50]",asset:"fd35718ac5a278fd05fe5287ebd41de40a59259d"},{text:"[\u58A8\u955C]",asset:"5e01c237642c8b662a69e21b8e0fbe6e7dbc2aa1"},{text:"[\u96BE\u8FC7]",asset:"5776481e380648c0fb3d4ad6173475f69f1ce149"},{text:"[\u62B1\u62B1]",asset:"abddb0b621b389fc8c2322b1cfcf122d8936ba91"},{text:"[\u8DEA\u4E86]",asset:"4f2155b108047d60c1fa9dccdc4d7abba18379a0"},{text:"[\u644A\u624B]",asset:"1e0a2baf088a34d56e2cc226b2de36a5f8d6c926"},{text:"[\u70ED]",asset:"6df760280b17a6cbac8c1874d357298f982ba4cf"},{text:"[\u4E09\u661F\u5806]",asset:"0a1ab3f0f2f2e29de35c702ac1ecfec7f90e325d"},{text:"[\u9F20]",asset:"98f842994035505c728e32e32045d649e371ecd6"},{text:"[\u6C64\u5706]",asset:"23ae12d3a71b9d7a22c8773343969fcbb94b20d0"},{text:"[\u6CFC\u6C34]",asset:"29533893115c4609a4af336f49060ea13173ca78"},{text:"[\u9B3C\u9B42]",asset:"5d86d55ba9a2f99856b523d8311cf75cfdcccdbc"},{text:"[\u4E0D\u884C]",asset:"607f74ccf5eec7d2b17d91b9bb36be61a5dd196b"},{text:"[\u54CD\u6307]",asset:"3b2fedf09b0ac79679b5a47f5eb3e8a38e702387"},{text:"[\u725B]",asset:"5e61223561203c50340b4c9b41ba7e4b05e48ae2"},{text:"[\u4FDD\u4F51]",asset:"241b13adb4933e38b7ea6f5204e0648725e76fbf"},{text:"[\u62B1\u62F3]",asset:"3f170894dd08827ee293afcb5a3d2b60aecdb5b1"},{text:"[\u7ED9\u529B]",asset:"d1ba5f4c54332a21ed2ca0dcecaedd2add587839"},{text:"[\u8036]",asset:"eb2d84ba623e2335a48f73fb5bef87bcf53c1239"}]};DanmakuWSS.prototype.unPackage=function(a){let b=new TextDecoder().decode(a).split(/}.{16}{/);for(let c,d=0;d<b.length;d++){c=b[d],0==d?(c=c.substring(16),1<b.length&&(c+="}")):(c="{"+c+"}",d===b.length-1&&(c=c.substring(0,c.length-1)));let a=JSON.parse(c);if("DANMU_MSG"===a.cmd){console.log(a);let b={type:"DANMU_MSG",danmaku_content:a.info[1],user:1===a.info[2][2]?4:""===a.info[2][7]?0:"#00D1F1"===a.info[2][7]?1:"#E17AFF"===a.info[2][7]?2:3,userName:a.info[2][1],userID:a.info[2][0],madel:a.info[3],content_emoji:a.info[0][13]};this.renderFrontEnd(b)}else;}},DanmakuWSS.prototype.nonPackage=function(a){const b=new DataView(a),c=b.getUint32(0),d=b.getUint16(4),e=b.getUint16(6),f=b.getUint32(8),g=b.getUint32(12);let h,i=a.slice(d,c);if(5===f)if(0===e){const a=JSON.parse(this.unicodeDecoding(new Uint8Array(i)));"DANMU_MSG"===a.cmd?(console.log(a),h={type:"DANMU_MSG",danmaku_content:a.info[1],user:1===a.info[2][2]?4:""===a.info[2][7]?0:"#00D1F1"===a.info[2][7]?1:"#E17AFF"===a.info[2][7]?2:3,userName:a.info[2][1],userID:a.info[2][0],madel:a.info[3],content_emoji:a.info[0][13]},this.renderFrontEnd(h)):console.log(a)}else try{this.unPackage(decompress(new Uint8Array(i)).buffer)}catch(a){console.log("Failed to uncompress incoming payload: "+a)}},DanmakuWSS.prototype.packageDm=function(a,b){let c=this.unicodeEncoding(a),d=new ArrayBuffer(c.byteLength+16),e=new DataView(d);e.setUint32(0,c.byteLength+16),e.setUint16(4,16),e.setUint16(6,this.ver),e.setUint32(8,b),e.setUint32(12,1);for(let d=0;d<c.byteLength;d++)e.setUint8(16+d,c[d]);return d},DanmakuWSS.prototype.unicodeEncoding=function(a){let b=[];for(let c=0;c<a.length;c++)b.push(a[c].charCodeAt(0));return new Uint8Array(b)},DanmakuWSS.prototype.unicodeDecoding=function(a){return new TextDecoder().decode(a)},DanmakuWSS.prototype.connect=function(){try{this.wss=new WebSocket(`wss://broadcastlv.chat.bilibili.com:2245/sub`)}catch(a){console.log("Failed to establish the wss connection: \r\n"+a)}if(null!==this.wss){const a=this.packageDm("[object Object]",2),b=this.packageDm(JSON.stringify(this.AUTH_PAYLOAD),7);this.wss.onopen=()=>{this.onUserBehave=!1,this.wss.send(b),this.wss.send(a),this.__sent_system_package("\u6B63\u5728\u8FDE\u63A5\u81F3"+this.roomID),this.timer=setInterval(()=>{this.wss.send(a)},3e4)},this.wss.onmessage=a=>{this.firstPackageReveiced||(this.__sent_system_package("\u5DF2\u8FDE\u63A5\u81F3"+this.roomID),this.firstPackageReveiced=!0);let b=new FileReader;b.readAsArrayBuffer(a.data),b.onload=()=>{this.nonPackage(b.result)}},this.wss.onclose=()=>{this.onUserBehave||this.__handel_reconnection(0)},this.wss.onerror=()=>{this.onUserBehave||this.__handel_reconnection(1)}}},DanmakuWSS.prototype.disconnect=function(){this.onUserBehave=!0;try{this.__sent_system_package(`与${this.roomID}的连接已断开`),this.wss.close(),clearInterval(this.timer),this.timer=null,this.firstPackageReveiced=!1,this.retried=0}catch(a){console.log(`Failed to close the wss connection.`)}},DanmakuWSS.prototype.__sent_system_package=function(a){this.renderFrontEnd({type:"SYSTEM_MSG",danmaku_content:a,user:"System"})},DanmakuWSS.prototype.__handel_reconnection=function(a){clearInterval(this.timer),this.timer=null,this.firstPackageReveiced=!1,this.__sent_system_package(`与${this.roomID}的连接${0===a?"\u88AB\u5173\u95ED":"\u51FA\u73B0\u9519\u8BEF"}`),this.retried<this.retry?(this.__sent_system_package("\u6B63\u5728\u5C1D\u8BD5\u91CD\u65B0\u8FDE\u63A5\u81F3"+this.roomID),this.retried++,this.connect()):this.disconnect()},DanmakuWSS.prototype.renderFrontEnd=function(a){switch(a.type){case"DANMU_MSG":if(a.danmaku_content!=="\u559C\u6B22\u4E3B\u64AD\u52A0\u5173\u6CE8\uFF0C\u70B9\u70B9\u7EA2\u5305\u62BD\u793C\u7269"){let b=a.danmaku_content;null!==a.content_emoji&&"string"!=typeof a.content_emoji&&(b=`<img src="${a.content_emoji.url}" title="${a.danmaku_content}" alt="" class="emoji">`);for(let a=0;a<d.emoji.length;a++)b=b.replaceAll(d.emoji[a].text,`<img src="${"../images/huangdou/"+d.emoji[a].asset}.png" alt="" class="intext-emoji">`);const c=document.createElement("div");c.classList.add("rua-dm-item"),this.frontEndHost.appendChild(c),c.innerHTML=`<div class="rua-dm-name-tag">
                <div class="rua-dm-name-tag-avatar" style="display: none"><img src="${""}"></div>
                <div class="rua-dm-name-tag-username">${a.userName}</div>
                <div class="rua-dm-name-tag-madel" style="${0===a.madel.length?"none":"block"}">
                    <span class="rua-dm-name-tag-madel-name">${0<a.madel.length?a.madel[1]:""}</span>
                    <span class="rua-dm-name-tag-madel-level">${0<a.madel.length?a.madel[0]:""}</span>
                </div>
                </div>
                <div class="rua-dm-content">
                    <div class="rua-dm-danmaku-content normal-dm privilege-${a.user}">${""===b?a.danmaku_content:b}</div>
                </div>
                `}break;case"SYSTEM_MSG":const b=document.createElement("div");b.classList.add("rua-dm-item"),this.frontEndHost.appendChild(b),b.innerHTML=`<div class="rua-dm-name-tag">
                <div class="rua-dm-name-tag-avatar" style="display: none"><img src="${""}"></div>
                <div class="rua-dm-name-tag-username system-dm">${a.user}</div></div>
                <div class="rua-dm-content">
                <div class="rua-dm-danmaku-content system-dm">${a.danmaku_content}</div></div>`;break;case"GIFT_MSG":break;case"FLEET_MSG":break;case"SC_MSG":break;default:}window.scrollTo(0,document.body.scrollHeight)},DanmakuWSS.prototype.setRetryTime=function(a){this.retry=a},DanmakuWSS.prototype.setNewRoom=function(a){this.disconnect(),setTimeout(()=>{this.roomID=a.room_id,this.biggest_list=null===a.biggest_list?100:a.biggest_list,this.AUTH_PAYLOAD={uid:a.uid,roomid:this.roomID,protover:3,buvid:a.buvid,platform:"web",clientver:"1.8.5",type:2,key:a.token},this.connect()},2e3)}}!function(){function a(a){return fetch("https://api.live.bilibili.com/room/v1/Room/room_init?id="+a,{method:"GET",credentials:"include",body:null}).then(a=>a.json()).then(a=>{if(0===a.code)return b(a.data.room_id);throw a})}function b(a){return fetch(`http://api.live.bilibili.com/xlive/web-room/v1/index/getDanmuInfo?id=${a}`,{method:"GET",credentials:"include",body:null}).then(a=>a.json()).then(b=>{if(0===b.code){let c=b.data;return c.room_id=a,c}return{}}).catch(()=>({}))}function c(a){chrome.cookies.get({url:"https://www.bilibili.com/",name:"DedeUserID"},b=>{chrome.cookies.get({url:"https://www.bilibili.com/",name:"buvid3"},c=>{null===d?(d=new DanmakuWSS({uid:b.value-0,room_id:a.room_id,token:a.token,biggest_list:100,buvid:c.value},1,document.getElementById("danmaku-list")),d.connect()):d.setNewRoom({uid:b.value-0,room_id:a.room_id,token:a.token,biggest_list:100,buvid:c.value})})})}let d=null,e=-1,f=document.getElementById("add-room");f.onclick=async()=>{let b=document.getElementById("room-id-value").value;if(e!==b-0){e=b;let d=await a(b-0);console.log("Grab room info:"),console.log(d),c(d)}}}();