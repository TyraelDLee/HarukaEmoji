!function(){let a=window.location.pathname.replaceAll("/","").replace("blanc",""),b=0,c=0,d=-1,e=!1,f=/^\d*$/;if(f.test(a)){function f(){g=window.innerHeight*m,h=window.innerWidth*m}function r(){return fetch("https://api.live.bilibili.com/room/v1/Room/room_init?id="+a,{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((b)=>{0===b.code?(a=b.data.room_id,d=b.data.uid):setTimeout(r,1e3)}).catch(()=>{setTimeout(r,1e3)})}function s(a,b,c,d){var e=Math.abs;return 0===e(a-c)&&0===e(b-d)}function t(){if(console.log("load complete"),"-1"==i||"-1"==j)K.innerHTML="<div id='load'>\u52A0\u8F7D\u5931\u8D25\uFF0C<br>\u8BF7<a href="+window.location+">\u70B9\u51FB\u8FD9\u91CC</a>\u91CD\u8BD5<br><br>\u5982\u672A\u767B\u5F55\uFF0C\u8BF7\u5148\u767B\u5F55</div>",document.getElementById("load").style.marginTop="130px";else{function a(){document.getElementsByClassName("fullscreen-danmaku")[0].classList.add("emoji-fullscreen-danmaku"),j.style.display="none",k.style.display="none",g.style.display="none",f.style.display="none",g.classList.add("emoji_sec"),g.setAttribute("id","fullscreen-table"),h.classList.add("emoji-table"),z(8,l,h,m),y(8,i),g.appendChild(h),g.appendChild(i),f.setAttribute("id","fs-emoji-bg"),l.placeholder="\u53D1\u4E2A\u5F39\u5E55\u5457~",l.setAttribute("id","fullscreen-input"),m.setAttribute("id","fullscreen-text-length"),m.innerHTML=" 0/"+p,j.setAttribute("id","first-child"),j.appendChild(l),j.appendChild(m),k.innerHTML="\u53D1\u9001",k.classList.add("send-danmaku"),k.setAttribute("id","fullscreen-sub-btn"),document.getElementsByClassName("emoji-fullscreen-danmaku")[0].appendChild(j),document.getElementsByClassName("emoji-fullscreen-danmaku")[0].appendChild(k),document.getElementsByClassName("emoji-fullscreen-danmaku")[0].appendChild(f),document.getElementsByClassName("emoji-fullscreen-danmaku")[0].appendChild(g)}function b(){n.style.display="none",o.style.display="none",j.style.display="block",k.style.display="block",g.style.display="block",f.style.display="block",document.getElementsByClassName("emoji-fullscreen-danmaku")[0].addEventListener("mouseenter",function(){g.classList.remove("fullscreen-hoverout"),g.classList.add("fullscreen-hoverin")}),document.getElementsByClassName("fullscreen-danmaku")[0].addEventListener("mouseleave",function(){g.classList.remove("fullscreen-hoverin"),g.classList.add("fullscreen-hoverout")}),document.getElementById("live-player").addEventListener("mousemove",d),k.addEventListener("click",function(){w(l.value),l.value="",m.innerHTML=" 0/"+p})}function c(){n.style.display="block",o.style.display="block",j.style.display="none",k.style.display="none",g.style.display="none",f.style.display="none",document.getElementById("live-player").removeEventListener("mousemove",d)}function d(){clearTimeout(e),e=setTimeout(function(){g.classList.remove("fullscreen-hoverout")},2e3)}O.innerHTML=" 0/"+p,M.style.display="block",N.style.display="block",O.style.display="block",Q.style.display="block",P.style.display="block",z(4,M,K,O),y(4,L),N.onclick=function(){w(M.value),O.innerHTML=" 0/"+document.getElementsByClassName("input-limit-hint")[0].innerHTML.split("/")[1],M.value=""},S.addEventListener("change",function(){this.checked?b():c()});let e=null;const f=document.createElement("div"),g=document.createElement("div"),h=document.createElement("table"),i=document.createElement("table"),j=document.createElement("div"),k=document.createElement("div"),l=document.createElement("input"),m=document.createElement("span");let n,o;setTimeout(()=>{n=document.getElementsByClassName("fullscreen-danmaku")[0].getElementsByTagName("div")[0],o=document.getElementsByClassName("fullscreen-danmaku")[0].getElementsByTagName("div")[1],a(),b()},2e3)}}function u(){try{chrome.runtime.sendMessage({msg:"get_LoginInfo"},function(a){i=a.res.split(",")[0],j=a.res.split(",")[1]})}catch(a){}}function v(){return Math.round(Date.now()/1e3)}function w(b,c){let d=new FormData;d.append("bubble","0"),d.append("msg",b),d.append("color","16777215"),d.append("mode","1"),c!==void 0&&"systemEmoji"===c&&d.append("dm_type","1"),d.append("fontsize","25"),d.append("rnd",v()+""),d.append("roomid",a),d.append("csrf",i),d.append("csrf_token",i),0!==b.length&&x(d)}function x(a){fetch("https://api.live.bilibili.com/msg/send?requestFrom=rua5",{method:"POST",credentials:"include",body:a}).then(()=>{console.log("sent")}).catch((a)=>{console.error("Error:",a)})}function y(d,e){fetch("https://api.live.bilibili.com/xlive/web-ucenter/v2/emoticon/GetEmoticons?platform=pc&room_id="+a,{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((a)=>{if(0===a.code){let g="";for(let e=2;0<=e;e--)if(a.data.data[e]!==void 0&&null!==a.data.data[e]){console.log(c),g+=`</tr></tbody><thead><tr><th colspan='4' class='rua-table-header'>${a.data.data[e].pkg_name}</th></tr></thead><tbody><tr>`;for(let f,h=0;h<a.data.data[e].emoticons.length;h++)f=b<=a.data.data[e].emoticons[h].identity&&a.data.data[e].emoticons[h].unlock_need_level<=c,0==h%d&&0!==h&&(g+="</tr><tr>"),g+=`<td colspan="1" title="${a.data.data[e].emoticons[h].emoji}" id="${a.data.data[e].emoticons[h].emoticon_unique}"><div  class="rua-emoji-icon ${f?"rua-emoji-icon-active":"rua-emoji-icon-inactive"}" style="width:60px; height:60px; background-image:url('${a.data.data[e].emoticons[h].url.replace("http://","https://")}');"></div><div class="rua-emoji-requirement" style="background-color: ${a.data.data[e].emoticons[h].unlock_show_color};"><div class="rua-emoji-requirement-text">${a.data.data[e].emoticons[h].unlock_show_text}</div></div></td>`}g+="</tr></tbody>",e.innerHTML=g;for(let a=0;a<e.rows.length;a++){var f=e.rows[a].cells;for(let a=0;a<f.length;a++){const b=f[a].getElementsByTagName("div")[0];f[a].onclick=function(a){0===a.button&&b.classList.contains("rua-emoji-icon-active")&&w(this.id,"systemEmoji")}}}}0===K.innerHTML.length&&25>=L.innerHTML.length&&(L.innerHTML=`<div id="load">当前直播间没有表情包，<br>如显示不正确，请<a href="${window.location}">点击这里</a>重试<br><br></div>`)}).catch(()=>{})}function z(a,b,c,d){try{let f=[0,0];b.addEventListener("compositionstart",()=>{T=!1,U=!1}),b.addEventListener("compositionend",()=>{T=!0,console.log("compositionend")}),b.addEventListener("keyup",(a)=>{13===a.keyCode&&U&&(a.preventDefault(),w(b.value),b.value=""),T&&(U=!0),f=B(d,b)}),b.addEventListener("keydown",(a)=>{"Enter"===a.code&&a.preventDefault()}),b.addEventListener("select",(a)=>{f=[a.target.selectionStart,a.target.selectionEnd]});let g="<thead><tr><th colspan=\"4\" class=\"rua-table-header\">\u5F39\u5E55\u673A\u8868\u60C5</th></tr></thead>";g+="<tbody><tr>";for(let b=0;b<imgs.length;b++)0==b%a&&0!==b&&(g+="</tr><tr>"),g+=`<td colspan="${imgs[b].getSpan()}" title="${emoji[b]}" class="rua-emoji-icon" style="background-image:url('${imgs[b].getURL()}');"></td>`;g+="</tr></tbody>",c.innerHTML=g;for(let g=1;g<c.rows.length;g++){var e=c.rows[g].cells;for(let c=0;c<e.length;c++)e[c].onclick=function(h){0===h.button&&(b.value=b.value.substr(0,f[0])+"("+emoji[c+(g-1)*a]+")"+b.value.substr(f[1]),f=B(d,b))}}}catch(a){c.innerHTML=""}}function A(a,b){a.innerHTML=10>b?" "+b+"/"+p:b+"/"+p}function B(a,b){return A(a,b.value.length),[b.selectionStart,b.selectionEnd]}function C(a){let b=document.getElementById(a),c=[b.offsetLeft,b.offsetTop],d=b.offsetParent;for(;null!==d;)c[0]+=d.offsetLeft,c[1]+=d.offsetTop+d.clientTop,d=d.offsetParent;return c[0]+=b.clientWidth-60,c[1]+=b.clientHeight-60,c}function D(){let a=C("rank-list-vm");o=[h-a[0],a[1],a[0]],o[2]>h-60?(H.style.left=h-60+"px",I.style.left=h-370+"px"):(H.style.left=o[2]+"px",I.style.left=o[2]-310+"px")}function E(){if(null===localStorage.getItem("rua_pos"))D(),n=!1;else if(localStorage.getItem("rua_pos").includes("undefined"))localStorage.removeItem("rua_pos"),D(),n=!1;else{n=!0;for(let a=0;3>a;a++)o[a]=parseInt(localStorage.getItem("rua_pos").split(",")[a]);let a=0;a=o[0]<o[2]?h-o[0]:o[2],o[1]>g-50&&(o[1]=g-50),H.style.left=a+"px",I.style.left=320>a?a+60+"px":a-310+"px"}}function F(a){a?(I.style.background="#151515",J.style.opacity="0.8",N.style.opacity="0.8",M.style.background="#151515",M.style.borderColor="#2b2b2b"):(I.style.removeProperty("background"),J.style.removeProperty("opacity"),N.style.removeProperty("opacity"),M.style.removeProperty("background"),M.style.removeProperty("border-color"))}var g,h,i="-1",j="-1",k=window.innerWidth,l=[],m=1;f(),u(),setInterval(u,3e3);var n=!1,o=[100,100,100];const G=document.body,H=document.createElement("div"),I=document.createElement("div"),J=document.createElement("div"),K=document.createElement("table"),L=document.createElement("table"),M=document.createElement("textarea"),N=document.createElement("button"),O=document.createElement("span"),P=document.createElement("span"),Q=document.createElement("section"),R=document.createElement("div"),S=document.createElement("input");var p;(async function f(){let g=0;await r(),await fetch("https://api.live.bilibili.com/xlive/web-room/v1/index/getInfoByUser?from=0&room_id="+a,{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((a)=>{0===a.code?(b=4-a.data.privilege.privilege_type,g=a.data.info.uid,console.log(b),e=a.data.relation.is_in_fansclub,p=a.data.property.danmu.length):setTimeout(f,1e3)}).catch(()=>{setTimeout(f,1e3)}),await fetch("https://api.live.bilibili.com/xlive/web-ucenter/user/MedalWall?target_id="+g,{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((a)=>{if(0===a.code)for(let b of a.data.list)b.medal_info.target_id===d&&(c=b.medal_info.level)}).catch(()=>{})})(),0===document.getElementsByTagName("article").length&&function(){E(),H.setAttribute("id","emoji-popup"),H.style.background="url("+chrome.runtime.getURL("../images/haruka/abaaba.svg")+") no-repeat center";try{H.style.background="url("+link+") no-repeat center"}catch(a){}H.style.backgroundSize="contain",H.style.cursor="pointer",H.innerHTML="<!---->",I.setAttribute("id","emoji-selection"),I.classList.add("emoji_sec"),I.style.display="none",I.innerHTML="",J.setAttribute("id","emoji-tray"),J.classList.add("emoji_sec"),J.appendChild(K),J.appendChild(L),K.setAttribute("class","emoji-table"),K.innerHTML="<div id='load'>\u52A0\u8F7D\u5F39\u5E55\u4E2D...</div>",L.setAttribute("class","emoji-table"),I.appendChild(J),G.appendChild(I),G.appendChild(H),H.style.top=o[1]+"px",I.style.top=o[1]-5+"px",N.setAttribute("id","input-button"),N.innerHTML="<span>\u53D1\u9001</span>",N.style.display="none",M.setAttribute("id","input-form"),M.placeholder="\u8FD9\u91CC\u4E5F\u53EF\u4EE5\u53D1\u5F39\u5E55~",M.style.display="none",O.setAttribute("id","length-indicator"),O.style.display="none",Q.classList.add("button"),R.classList.add("checkbox"),S.type="checkbox",S.checked=!0,R.appendChild(S),R.appendChild(document.createElement("label")),Q.appendChild(R),Q.style.display="none",P.setAttribute("id","fullscreen-label"),P.innerHTML="\u5168\u5C4F\u663E\u793A",P.style.display="none",I.appendChild(M),I.appendChild(N),I.appendChild(Q),I.appendChild(P),I.appendChild(O);var a=[0,0],b=[0,0];window.onload=function(){H.onmousedown=function(c){let d,e;document.body.style.userSelect="none",H.className="popup-click-in";const f=c||event,i=f.clientX-H.offsetLeft,j=f.clientY-H.offsetTop;a=[H.offsetLeft,H.offsetTop],b=[H.offsetLeft,H.offsetTop],document.onmousemove=function(a){const c=a||event;0<=c.clientX-i&&c.clientX-i<=h-60&&(d=c.clientX-i),0<=c.clientY-j&&c.clientY-j<=g-60&&(e=c.clientY-j),b=[d,e],H.style.left=d+"px",H.style.top=e+"px",I.style.left=320>d?d+60+"px":d-310+"px",I.style.top=e>g-360?g-360+"px":e-5+"px",e===void 0&&(e=H.offsetTop),-1<d&&(o=[h-d,e,d])},document.onmouseup=function(){document.body.style.userSelect="auto",H.className="popup-click-out",s(a[0],a[1],b[0],b[1])?"none"===I.style.display?(I.classList.remove("selection-fade-out"),I.style.display="block",I.classList.add("selection-fade-in")):(I.classList.remove("selection-fade-in"),I.classList.add("selection-fade-out"),setTimeout(()=>{I.style.display="none"},300)):(n=!0,localStorage.setItem("rua_pos",o[0]+","+o[1]+","+o[2])),document.onmousemove=null,document.onmouseup=null}},H.onmouseenter=function(){H.className="popup-click-hoverin"},H.onmouseleave=function(){H.className="popup-click-hoverout"}},window.addEventListener("resize",function(){let a,b=o[0]<o[2]?o[0]/k:o[2]/k;f(),n?(a=o[0]<o[2]?h-o[0]:o[2],H.style.left=a+"px"):D(),o[1]>g-60&&(H.style.top=g-60+"px",I.style.top=g-360+"px"),I.style.left=320>a?a+60+"px":a-310+"px"}),setTimeout(t,1e3)}();let T=!0,U=!0;var q=new MutationObserver(function(a){a.forEach(function(a){"attributes"===a.type&&(null===V.getAttribute("lab-style")?F(!1):(l=V.getAttribute("lab-style").split(","),-1===l.indexOf("dark")?F(!1):F(!0)))})});const V=document.documentElement;q.observe(V,{attributes:!0})}}();