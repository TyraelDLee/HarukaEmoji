!function(){function a(){try{chrome.runtime.sendMessage({msg:"get_LoginInfo"},function(a){h=a.res.split(",")[1],j.test(i)&&b(3).then((a)=>{null!==a&&c()})})}catch(a){}}function b(a){return fetch(`https://api.bilibili.com/audio/music-service-c/url?songid=${i}&quality=${a}&privilege=2&mid=${h}&platform=web`,{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((a)=>0===a.code&&null!=a.data?{url:a.data.cdns[0],up:"",title:a.data.title,cover:a.data.cover}:null).catch(()=>{})}function c(){document.getElementById("rua-download")!==void 0&&null!==document.getElementById("rua-download")&&document.getElementById("rua-download").parentNode.removeChild(document.getElementById("rua-download"));let a=document.createElement("div");a.setAttribute("id","rua-download"),a.setAttribute("data-v-60025db2",""),a.classList.add("song-playbtn"),a.innerHTML=`<i id="rua-download-icon"><img src="${g}"></i> <span data-v-60025db2 class="song-play" style="margin-left: 20px;">下载</span>`,document.getElementsByClassName("share-board")[0].insertBefore(a,document.getElementsByClassName("song-share")[0]),a.addEventListener("click",async()=>{if(!a.classList.contains("rua-clicked")){a.classList.add("rua-clicked"),a.getElementsByClassName("song-play")[0].innerText=`取流中...`;let c=await e();const g=c.lyrics;""!==g&&(c.lyrics=await f(g)),b(3).then((b)=>{let e=0,f=0;fetch(b.url,{method:"GET",body:null}).then((b)=>(a.getElementsByClassName("song-play")[0].innerText=`下载中...`,e=b.headers.get("Content-Length"),b.body)).then((b)=>{const c=b.getReader();return new Response(new ReadableStream({start(b){function g(){return c.read().then((c)=>{const{done:h,value:i}=c;return h&&b.close(),f+=i.length||0,d(a,100*(f/e)),b.enqueue(i),g()})}return g()}})).blob()}).then((d)=>{let e=window.URL.createObjectURL(d);if(-1===c){const c=document.createElement("a");c.style.display="none",c.href=e,c.download=`${b.title}${(b.title+"").includes(".m4a")?".m4a":".flac"}`,document.body.appendChild(c),c.click(),document.body.removeChild(c),window.URL.revokeObjectURL(e)}else chrome.runtime.sendMessage({msg:"requestEncode",blob:e,filename:c.title,startTime:-1,duration:-1,requestType:"songRecord",metadata:c},function(a){console.log(a.status)});a.setAttribute("style",""),a.getElementsByClassName("song-play")[0].innerText=`下载`,a.classList.remove("rua-clicked")}).catch(()=>{})}).catch(()=>{})}})}function d(a,b){a.setAttribute("style","background: linear-gradient(to right, #23ade5 0%, #23ade5 "+b+"%, #fb7299 "+b+"%, #fb7299);")}function e(){return fetch(`https://www.bilibili.com/audio/music-service-c/web/song/info?sid=${i}`,{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((a)=>0===a.code?{title:a.data.title,artist:a.data.author,year:new Date(1e3*(a.data.passtime-1+1)).getFullYear(),cover:a.data.cover,lyrics:a.data.lyric,description:a.data.intro}:-1).catch(()=>{})}function f(a){return fetch(a.replace("http://","https://"),{method:"GET",credentials:"omit",body:null}).then((a)=>a.arrayBuffer()).then((a)=>new TextDecoder().decode(new Uint8Array(a)))}const g=chrome.runtime.getURL("../images/haruka/abaaba.svg");let h,i=window.location.pathname.replaceAll("/","").replace("audio","").replaceAll("au",""),j=/^\d*$/;new MutationObserver(()=>{const b=window.location.pathname.replaceAll("/","").replace("audio","").replaceAll("au","");null!==b&&b!==i&&j.test(b)&&(i=b,a())}).observe(document,{subtree:!0,childList:!0}),a()}();