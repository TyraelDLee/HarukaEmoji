!function(){function a(){try{chrome.runtime.sendMessage({msg:"get_LoginInfo"},function(a){j=a.res.split(",")[1],l.test(k)&&b(3).then((a)=>{null!==a&&c()})})}catch(a){}}function b(a){return fetch(`https://api.bilibili.com/audio/music-service-c/url?songid=${k}&quality=${a}&privilege=2&mid=${j}&platform=web`,{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((a)=>0===a.code&&null!=a.data?{url:a.data.cdns[0],up:"",title:a.data.title,cover:a.data.cover}:null).catch(()=>{})}function c(){document.getElementById("rua-download")!==void 0&&null!==document.getElementById("rua-download")&&document.getElementById("rua-download").parentNode.removeChild(document.getElementById("rua-download"));let a=document.createElement("div");a.setAttribute("id","rua-download"),a.setAttribute("data-v-60025db2",""),a.classList.add("song-playbtn"),a.innerHTML=`<i id="rua-download-icon"><img src="${h}"></i> <span data-v-60025db2 class="song-play" style="margin-left: 20px;">下载</span>`,document.getElementsByClassName("share-board")[0].insertBefore(a,document.getElementsByClassName("song-share")[0]),a.addEventListener("click",async()=>{if(!a.classList.contains("rua-clicked")){a.classList.add("rua-clicked"),a.getElementsByClassName("song-play")[0].innerText=`取流中...`;let c=await f();const h=c.lyrics;""!==h&&(c.lyrics=await g(h)),b(3).then((b)=>{let f=0,g=0;fetch(b.url,{method:"GET",body:null}).then((b)=>(a.getElementsByClassName("song-play")[0].innerText=`下载中...`,f=b.headers.get("Content-Length"),b.body)).then((b)=>{const c=b.getReader();return new Response(new ReadableStream({start(b){function d(){return c.read().then((c)=>{const{done:h,value:i}=c;return h&&b.close(),g+=i.length||0,e(a,100*(g/f)),b.enqueue(i),d()})}return d()}})).blob()}).then((e)=>{let f=window.URL.createObjectURL(e);if(-1===c){const c=document.createElement("a");c.style.display="none",c.href=f,c.download=`${b.title}${(b.title+"").includes(".m4a")?".m4a":".flac"}`,document.body.appendChild(c),c.click(),document.body.removeChild(c),window.URL.revokeObjectURL(f)}else d(f,c,c.title);a.setAttribute("style",""),a.getElementsByClassName("song-play")[0].innerText=`下载`,a.classList.remove("rua-clicked")}).catch(()=>{})}).catch(()=>{})}})}async function d(b,c,d){let e,f,g;const{createFFmpeg:h,fetchFile:j}=FFmpeg,k=h({corePath:i,mainName:"main",log:!1});await k.load(),k.FS("writeFile","audio.m4s",(await j(b))),await k.run("-i","audio.m4s","-c","copy","-metadata",`title=${eval("'"+encodeURI(c.title).replace(/%/gm,"\\x")+"'")}`,"-metadata",`artist=${eval("'"+encodeURI(c.artist).replace(/%/gm,"\\x")+"'")}`,"-metadata",`description=${eval("'"+encodeURI(c.description).replace(/%/gm,"\\x")+"'")}`,"-metadata",`lyrics=${eval("'"+encodeURI(c.lyrics).replace(/%/gm,"\\x")+"'")}`,"-metadata",`year=${c.year}`,"final.m4a"),e=k.FS("readFile","final.m4a"),f=d+".m4a",g=URL.createObjectURL(new Blob([e.buffer],{type:"audio/mp4"}));const l=document.createElement("a");l.style.display="none",l.href=g,l.download=f,document.body.appendChild(l),l.click(),document.body.removeChild(l),window.URL.revokeObjectURL(g)}function e(a,b){a.setAttribute("style","background: linear-gradient(to right, #23ade5 0%, #23ade5 "+b+"%, #fb7299 "+b+"%, #fb7299);")}function f(){return fetch(`https://www.bilibili.com/audio/music-service-c/web/song/info?sid=${k}`,{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((a)=>0===a.code?{title:a.data.title,artist:a.data.author,year:new Date(1e3*(a.data.passtime-1+1)).getFullYear(),cover:a.data.cover,lyrics:a.data.lyric,description:a.data.intro}:-1).catch(()=>{})}function g(a){return fetch(a.replace("http://","https://"),{method:"GET",credentials:"omit",body:null}).then((a)=>a.arrayBuffer()).then((a)=>new TextDecoder().decode(new Uint8Array(a)))}const h=chrome.runtime.getURL("../images/haruka/abaaba.svg"),i=chrome.runtime.getURL("../ffmpeg/ffmpeg-core.wasm");let j,k=window.location.pathname.replaceAll("/","").replace("audio","").replaceAll("au",""),l=/^\d*$/;new MutationObserver(()=>{const b=window.location.pathname.replaceAll("/","").replace("audio","").replaceAll("au","");null!==b&&b!==k&&l.test(b)&&(k=b,a())}).observe(document,{subtree:!0,childList:!0}),a()}();