!function(){function a(a){return fetch(`https://api.bilibili.com/audio/music-service-c/url?songid=${f}&quality=${a}&privilege=2&mid=${e}&platform=web`,{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((a)=>0===a.code&&null!=a.data?{url:a.data.cdns[0],up:"",title:a.data.title,cover:a.data.cover}:null).catch(()=>{})}function b(){document.getElementById("rua-download")!==void 0&&null!==document.getElementById("rua-download")&&document.getElementById("rua-download").parentNode.removeChild(document.getElementById("rua-download"));let b=document.createElement("div");b.setAttribute("id","rua-download"),b.setAttribute("data-v-60025db2",""),b.classList.add("song-playbtn"),b.innerHTML=`<i id="rua-download-icon"><img src="${d}"></i> <span data-v-60025db2 class="song-play" style="margin-left: 0;">下载</span>`,document.getElementsByClassName("share-board")[0].insertBefore(b,document.getElementsByClassName("song-share")[0]),b.addEventListener("click",async()=>{b.classList.contains("rua-clicked")||(b.classList.add("rua-clicked"),a(3).then((d)=>{let a=0,e=0;fetch(d.url,{method:"GET",body:null}).then((c)=>(b.getElementsByClassName("song-play")[0].innerText=`下载中...`,a=c.headers.get("Content-Length"),c.body)).then((d)=>{const f=d.getReader();return new Response(new ReadableStream({start(d){function g(){return f.read().then((f)=>{const{done:h,value:i}=f;return h&&d.close(),e+=i.length||0,c(b,100*(e/a)),d.enqueue(i),g()})}return g()}})).blob()}).then((c)=>{let e=window.URL.createObjectURL(c);const f=document.createElement("a");f.style.display="none",f.href=e,f.download=`${d.title}${(d.title+"").includes(".m4a")?".m4a":".flac"}`,document.body.appendChild(f),f.click(),document.body.removeChild(f),window.URL.revokeObjectURL(e),b.setAttribute("style",""),b.getElementsByClassName("song-play")[0].innerText=`下载`,b.classList.remove("rua-clicked")}).catch(()=>{})}).catch(()=>{}))})}function c(a,b){a.setAttribute("style","background: linear-gradient(to right, #23ade5 0%, #23ade5 "+b+"%, #fb7299 "+b+"%, #fb7299);")}const d=chrome.runtime.getURL("../images/haruka/abaaba.svg");let e,f=window.location.pathname.replaceAll("/","").replace("audio","").replaceAll("au","");new MutationObserver(()=>{const c=window.location.pathname.replaceAll("/","").replace("audio","").replaceAll("au","");null!==c&&c!==f&&(f=c,a(3).then((a)=>{""!==a&&b()}))}).observe(document,{subtree:!0,childList:!0}),function(){try{chrome.runtime.sendMessage({msg:"get_LoginInfo"},function(a){e=a.res.split(",")[1]})}catch(a){}}(),setTimeout(()=>{a(3).then((a)=>{null!==a&&b()})},1e3)}();