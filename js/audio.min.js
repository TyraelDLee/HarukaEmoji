!function(){function a(){try{chrome.runtime.sendMessage({msg:"get_LoginInfo"},function(a){f=a.res.split(",")[1],h.test(g)&&b(3).then((a)=>{null!==a&&c()})})}catch(a){}}function b(a){return fetch(`https://api.bilibili.com/audio/music-service-c/url?songid=${g}&quality=${a}&privilege=2&mid=${f}&platform=web`,{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((a)=>0===a.code&&null!=a.data?{url:a.data.cdns[0],up:"",title:a.data.title,cover:a.data.cover}:null).catch(()=>{})}function c(){document.getElementById("rua-download")!==void 0&&null!==document.getElementById("rua-download")&&document.getElementById("rua-download").parentNode.removeChild(document.getElementById("rua-download"));let c=document.createElement("div");c.setAttribute("id","rua-download"),c.setAttribute("data-v-60025db2",""),c.classList.add("song-playbtn"),c.innerHTML=`<i id="rua-download-icon"><img src="${e}"></i> <span data-v-60025db2 class="song-play" style="margin-left: 0;">下载</span>`,document.getElementsByClassName("share-board")[0].insertBefore(c,document.getElementsByClassName("song-share")[0]),c.addEventListener("click",async()=>{c.classList.contains("rua-clicked")||(c.classList.add("rua-clicked"),c.getElementsByClassName("song-play")[0].innerText=`取流中...`,b(3).then((b)=>{let a=0,e=0;fetch(b.url,{method:"GET",body:null}).then((b)=>(c.getElementsByClassName("song-play")[0].innerText=`下载中...`,a=b.headers.get("Content-Length"),b.body)).then((b)=>{const f=b.getReader();return new Response(new ReadableStream({start(b){function g(){return f.read().then((f)=>{const{done:h,value:i}=f;return h&&b.close(),e+=i.length||0,d(c,100*(e/a)),b.enqueue(i),g()})}return g()}})).blob()}).then((d)=>{let e=window.URL.createObjectURL(d);const f=document.createElement("a");f.style.display="none",f.href=e,f.download=`${b.title}${(b.title+"").includes(".m4a")?".m4a":".flac"}`,document.body.appendChild(f),f.click(),document.body.removeChild(f),window.URL.revokeObjectURL(e),c.setAttribute("style",""),c.getElementsByClassName("song-play")[0].innerText=`下载`,c.classList.remove("rua-clicked")}).catch(()=>{})}).catch(()=>{}))})}function d(a,b){a.setAttribute("style","background: linear-gradient(to right, #23ade5 0%, #23ade5 "+b+"%, #fb7299 "+b+"%, #fb7299);")}const e=chrome.runtime.getURL("../images/haruka/abaaba.svg");let f,g=window.location.pathname.replaceAll("/","").replace("audio","").replaceAll("au",""),h=/^\d*$/;new MutationObserver(()=>{const b=window.location.pathname.replaceAll("/","").replace("audio","").replaceAll("au","");null!==b&&b!==g&&h.test(b)&&(g=b,a())}).observe(document,{subtree:!0,childList:!0}),a()}();