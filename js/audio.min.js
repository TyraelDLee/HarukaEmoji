!function(){function a(){try{chrome.runtime.sendMessage({msg:"get_LoginInfo"},function(a){k=a.res.split(",")[1],m.test(l)&&b(3).then((a)=>{null!==a&&c()})})}catch(a){}}function b(a){return fetch(`https://api.bilibili.com/audio/music-service-c/url?songid=${l}&quality=${a}&privilege=2&mid=${k}&platform=web`,{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((a)=>0===a.code&&null!=a.data?{url:a.data.cdns[0],up:"",title:a.data.title,cover:a.data.cover}:null).catch(()=>{})}function c(){document.getElementById("rua-download")!==void 0&&null!==document.getElementById("rua-download")&&document.getElementById("rua-download").parentNode.removeChild(document.getElementById("rua-download"));let a=document.createElement("div");a.setAttribute("id","rua-download"),a.setAttribute("data-v-60025db2",""),a.classList.add("song-playbtn"),a.innerHTML=`<i id="rua-download-icon"><img src="${i}"></i> <span data-v-60025db2 class="song-play" style="margin-left: 20px;">下载</span>`,document.getElementsByClassName("share-board")[0].insertBefore(a,document.getElementsByClassName("song-share")[0]),a.addEventListener("click",async()=>{if(!a.classList.contains("rua-clicked")){a.classList.add("rua-clicked"),a.getElementsByClassName("song-play")[0].innerText=`取流中...`;let c=await g();const e=c.lyrics;""!==e&&(c.lyrics=await h(e)),b(3).then((b)=>{let e=0,g=0;fetch(b.url,{method:"GET",body:null}).then((b)=>(a.getElementsByClassName("song-play")[0].innerText=`下载中...`,e=b.headers.get("Content-Length"),b.body)).then((b)=>{const c=b.getReader();return new Response(new ReadableStream({start(b){function d(){return c.read().then((c)=>{const{done:h,value:i}=c;return h&&b.close(),g+=i.length||0,f(a,100*(g/e)),b.enqueue(i),d()})}return d()}})).blob()}).then((e)=>{let f=window.URL.createObjectURL(e);if(-1===c){const c=document.createElement("a");c.style.display="none",c.href=f,c.download=`${b.title}${(b.title+"").includes(".m4a")?".m4a":".flac"}`,document.body.appendChild(c),c.click(),document.body.removeChild(c),window.URL.revokeObjectURL(f)}else d(f,c,c.title);a.setAttribute("style",""),a.getElementsByClassName("song-play")[0].innerText=`下载`,a.classList.remove("rua-clicked")}).catch(()=>{})}).catch(()=>{})}})}async function d(b,c,d){let f,g,h;const{createFFmpeg:i,fetchFile:k}=FFmpeg,l=i({corePath:j,mainName:"main",log:!1});await l.load(),l.FS("writeFile","audio.m4s",(await k(b))),await l.run("-i","audio.m4s","-c","copy","-metadata",`title=${e(c.title)}`,"-metadata",`artist=${e(c.artist)}`,"-metadata",`description=${e(c.description)}`,"-metadata",`lyrics=${e(c.lyrics)}`,"-metadata",`year=${c.year}`,"final.m4a"),f=l.FS("readFile","final.m4a"),g=d+".m4a",h=URL.createObjectURL(new Blob([f.buffer],{type:"audio/mp4"}));const m=document.createElement("a");m.style.display="none",m.href=h,m.download=g,document.body.appendChild(m),m.click(),document.body.removeChild(m),window.URL.revokeObjectURL(h)}function e(a){let b=new TextEncoder("utf8"),c=b.encode(a),d="";for(let b=0;b<c.length;++b)d+=String.fromCharCode(c[b]);return d}function f(a,b){a.setAttribute("style","background: linear-gradient(to right, #23ade5 0%, #23ade5 "+b+"%, #fb7299 "+b+"%, #fb7299);")}function g(){return fetch(`https://www.bilibili.com/audio/music-service-c/web/song/info?sid=${l}`,{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((a)=>0===a.code?{title:a.data.title,artist:a.data.author,year:new Date(1e3*(a.data.passtime-1+1)).getFullYear(),cover:a.data.cover,lyrics:a.data.lyric,description:a.data.intro}:-1).catch(()=>{})}function h(a){return fetch(a.replace("http://","https://"),{method:"GET",credentials:"omit",body:null}).then((a)=>a.arrayBuffer()).then((a)=>new TextDecoder().decode(new Uint8Array(a)))}const i=chrome.runtime.getURL("../images/haruka/abaaba.svg"),j=chrome.runtime.getURL("../ffmpeg/ffmpeg-core.wasm");let k,l=window.location.pathname.replaceAll("/","").replace("audio","").replaceAll("au",""),m=/^\d*$/;m.test(l)&&a(),new MutationObserver(()=>{const b=window.location.pathname.replaceAll("/","").replace("audio","").replaceAll("au","");null!==b&&b!==l&&m.test(b)&&(l=b,a())}).observe(document,{subtree:!0,childList:!0})}();