importScripts("./crypto-js.min.js");class WindowIDList{static convertFromJSON(e){let i=new WindowIDList;return i.list=e.id,i}constructor(){this.list=[]}push(e){this.remove(e),this.list.push(e)}remove(e){-1<this.list.indexOf(e)&&this.list.splice(this.list.indexOf(e),1)}getCurrent(){return 0<this.list.length?this.list[this.list.length-1]:-1}length(){return this.list.length}toJSONObject(){return{id:this.list}}}class DanmakuObj{constructor(e,i,t,a,n,d,s,o){this.time=e,this.mid=i,this.content=t,this.name=[],this.look=!0,this.color=a,this.mode=n,this.fontsize=d,this.ts=s,this.weight=o}setName(e){this.name=e}}class DanmakuArr{constructor(){this.list=[],this.size=0,this.displaySize=this.size}push(e){this.list.push(e),this.size++}concat(e){this.list=this.list.concat(e.list),this.size+=e.size}get(e){return this.list[e]}max(){let e=0;for(let t=0;t<this.list.length;t++)e<this.list[t].time&&(e=this.list[t].time);return e}min(){let e=Number.MAX_VALUE;for(let t=0;t<this.list.length;t++)e>this.list[t].time&&(e=this.list[t].time);return e}sort(e){function i(e,a,i){const n=e[a];e[a]=e[i],e[i]=n}const t=this.max(),a=this.min(),n=[],d=Math.floor((t-a)/e)+1;for(let t=0;t<this.size;t++){const e=~~(this.list[t].ts/d);n[e]||(n[e]=[]),n[e].push(this.list[t]);for(let t=n[e].length;0<t;)void 0!==n[e][t]&&n[e][t].ts<n[e][t-1].ts&&i(n[e],t,t-1),t--}let s=[];for(let t=0;t<n.length;t++)n[t]&&(s=s.concat(n[t]));this.list=s}find(e){function t(e){return e.replaceAll(",","\uFF0C").replaceAll(".","\u3002").replaceAll("?","\uFF1F").replaceAll("!","\uFF01").replaceAll(";","\uFF1B").replaceAll(":","\uFF1A").replaceAll("\u201C","\"").replaceAll("\u201D","\"").replaceAll("(","\uFF08").replaceAll(")","\uFF09")}let a=new DanmakuArr;if(e=t(e),""===e)return this;for(let n=0;n<this.size;n++)t(this.list[n].content).includes(e)&&a.push(this.list[n]);return a}}class NotificationList{constructor(){this.map=new Map}add(e){this.map.has(e+"")||this.map.set(e+"",0)}update(e,i){this.map.set(e+"",i)}getState(e){return this.map.get(e+"")}loadFromStorage(e){const i=JSON.parse(e);this.map=new Map(Object.entries(i))}stringify(){const e=Object.fromEntries(this.map);return JSON.stringify(e)}}class CRC32{static initCrc32Table(e){for(let t,a=0;256>a;a++){t=a;for(let e=0;8>e;e++)1&t?t=3988292384^t>>>1:t>>>=1;e[a]=t}}constructor(){this.crc32Table=new Uint32Array(256),CRC32.initCrc32Table(this.crc32Table),this.rainbowTableHash=new Uint32Array(1e5),this.rainbowTableValue=new Uint32Array(1e5);let e=new Uint32Array(1e5),t=new Uint32Array(65537);for(let a,n=0;1e5>n;n++)a=this.compute(n)>>>0,e[n]=a,t[a>>>16]++;let a=0;this.shortHashBucketStarts=t.map(e=>a+=e);for(let t,a=0;1e5>a;a++)t=--this.shortHashBucketStarts[e[a]>>>16],this.rainbowTableHash[t]=e[a],this.rainbowTableValue[t]=a}compute(e,i=!1){let t=0;for(let a of e.toString())t=this.crc32Update(t,+a);if(i)for(let e=0;5>e;e++)t=this.crc32Update(t,0);return t}crack(e){var i=Math.pow;let t=[],a=~+("0x"+e)>>>0,n=4294967295;for(let d=1;10>d;d++)if(n=this.crc32Update(n,48),6>d)t=t.concat(this.lookup(a^n));else{let e=i(10,d-6),s=i(10,d-5);for(let i=e;i<s;i++)for(let e of this.lookup(a^n^this.compute(i,!0)))t.push(1e5*i+e)}return t}crc32Update(e,i){return e>>>8^this.crc32Table[255&(e^i)]}lookup(e){e>>>=0;let t=[],a=e>>>16;for(let n=this.shortHashBucketStarts[a];n<this.shortHashBucketStarts[a+1];n++)this.rainbowTableHash[n]===e&&t.push(this.rainbowTableValue[n]);return t}}chrome.action.setBadgeBackgroundColor({color:"#00A0FF"}),chrome.windows.getAll(function(e){let t=new WindowIDList;for(let a=0;a<e.length;a++)t.push(e[a].id);chrome.storage.local.set({winIDList:t.toJSONObject()},()=>{})}),chrome.windows.onCreated.addListener(function(e){chrome.storage.local.get(["winIDList"],i=>{let t=WindowIDList.convertFromJSON(i.winIDList);t.push(e.id),chrome.storage.local.set({winIDList:t.toJSONObject()},()=>{})})}),chrome.windows.onRemoved.addListener(function(e){chrome.storage.local.get(["winIDList"],i=>{let t=WindowIDList.convertFromJSON(i.winIDList);t.remove(e),chrome.storage.local.set({winIDList:t.toJSONObject()},()=>{})})}),chrome.windows.onFocusChanged.addListener(function(e){-1!==e&&chrome.storage.local.get(["winIDList"],i=>{let t=WindowIDList.convertFromJSON(i.winIDList);t.push(e),chrome.storage.local.set({winIDList:t.toJSONObject()},()=>{})})}),chrome.runtime.onInstalled.addListener(initialize);async function initialize(e){if(await chrome.alarms.clearAll(),chrome.notifications.getAll(e=>{for(let i in e)chrome.notifications.clear(i)}),await chrome.tabs.create({url:"./readme.html"}),await chrome.storage.local.get(["rua_lastDK"],e=>{console.log(e.rua_lastDK),(null===e.rua_lastDK||void 0===e.rua_lastDK)&&chrome.storage.local.set({rua_lastDK:"1970-01-01"},()=>{})}),await chrome.storage.sync.get(["imageNotice"],function(e){(null===e.imageNotice||void 0===e.imageNotice)&&chrome.storage.sync.set({imageNotice:!1},function(){})}),setInitValue("notification",!0),setInitValue("medal",!0),setInitValue("checkIn",!0),setInitValue("bcoin",!0),setInitValue("qn",!0),setInitValue("qnvalue","\u539F\u753B"),setInitValue("dynamicPush",!0),setInitValue("videoPush",!0),setInitValue("pgcPush",!0),setInitValue("articlePush",!0),setInitValue("hiddenEntry",!1),setInitValue("daka",!0),setInitValue("record",!1),setInitValue("prerecord",300),setInitValue("enhancedHiddenEntry",!1),setInitValue("unreadSwitch",!0),setInitValue("dynamicSwitch",!0),setInitValue("blackListLive",[]),setInitValue("blackListDynamic",[]),setInitValue("blackListVideo",[]),setInitValue("blackListDK",[]),setInitValue("blackListHB",[]),setInitValue("darkMode",!1),setInitValue("darkModeSystem",!1),setInitValue("commentEmoji",!0),setInitValue("heartBeatSwitch",!0),setInitValue("squareCover",!0),setInitValue("liveroom-medal-switch",0),setInitValue("liveroom-reconnection-time",10),setInitValue("liveroom-heart-beat",!0),setInitValue("liveroom-quality",1e4),setInitValue("liveroom-auto-frame-chasing",0),setInitValue("liveroom-name-always-on",!1),setInitValue("dkWord",""),setInitValue("hiddenOnVideoBtn",!1),setInitValue("notificationMaster",!0),setInitValue("liveRoomList",[]),setInitValue("popupDisable",!1),setInitValue("popupAlwaysOnTop",!0),setInitValue("dm-ban-word",[]),setInitValue("liveroom-asmr-volume",10),setInitValue("liveroom-asmr-volume-restore",!1),chrome.storage.local.set({followingIDs:[]},()=>{}),!e||"boolean"!=typeof e)try{chrome.contextMenus.create({contexts:["selection","link"],title:"\u7528bilibili\u641C\u7D22",type:"normal",id:"rua-contextMenu-v3"})}catch(i){}chrome.alarms.create("checkUpd",{when:Date.now(),periodInMinutes:720}),await chrome.storage.local.set({uuid:-1,jct:-1,p_uuid:-1,updateAvailable:!1,availableBranch:"https://gitee.com/tyrael-lee/HarukaEmoji/releases",downloadFileName:"",video_id_list:[],pgc_id_list:[],article_id_list:[],unreadData:"{\"at\":0,\"chat\":0,\"like\":0,\"reply\":0,\"sys_msg\":0,\"up\":0}",unreadMessage:0,dynamicList:[],notificationList:"",videoInit:!0,dynamicInit:!0,unreadInit:!0,dakaUid:[],watchingList:{},heartRhythm:[],medalList:[],liveroomOn:[-1,-1],tempRoomNumber:-1,windowSize:[0,0]},()=>{}),chrome.alarms.create("getUID_CSRF",{when:Date.now(),periodInMinutes:.3}),chrome.alarms.create("heartRate",{when:Date.now()+60000,periodInMinutes:1}),chrome.alarms.create("refreshHB",{when:Date.now()+3600000,periodInMinutes:60})}function getNextDay(){let e=new Date;return e.setDate(e.getDate()+1),e.setUTCHours(0,0,0,0),e.getTime()-288e5}function setInitValue(e,i){chrome.storage.sync.get([e],function(t){(null===t[e]||t[e]===void 0)&&chrome.storage.sync.set({[e]:i},function(){})})}chrome.contextMenus.onClicked.addListener(e=>{"rua-contextMenu-v3"===e.menuItemId&&legalVideoLink(e.selectionText).then(i=>{i?chrome.tabs.create({url:"https://www.bilibili.com/video/"+e.selectionText}):chrome.tabs.create({url:"https://search.bilibili.com/all?keyword="+e.selectionText})})}),chrome.storage.onChanged.addListener(function(e){for(let[i,{oldValue:t,newValue:a}]of Object.entries(e))"checkIn"===i&&a&&checkingIn(),"bcoin"===i&&a&&queryBcoin(),"hiddenEntry"===i&&(a?chrome.declarativeNetRequest.updateEnabledRulesets({enableRulesetIds:["redirect"]},()=>{}):chrome.declarativeNetRequest.updateEnabledRulesets({disableRulesetIds:["redirect"]},()=>{})),"enhancedHiddenEntry"===i&&(a?chrome.declarativeNetRequest.updateEnabledRulesets({enableRulesetIds:["cookieOmit"]},()=>{}):chrome.declarativeNetRequest.updateEnabledRulesets({disableRulesetIds:["cookieOmit"]},()=>{})),"daka"===i&&a&&checkMedalDaka()}),chrome.runtime.onMessage.addListener(function(e,i,t){if("get_LoginInfo"===e.msg&&chrome.cookies.get({url:"https://www.bilibili.com/",name:"bili_jct"},function(e){null===e?chrome.storage.local.set({jct:-1},()=>{}):chrome.storage.local.set({jct:e.value},()=>{}),chrome.storage.local.get(["jct","uuid"],e=>{t({res:e.jct+","+e.uuid+","+e.uuid})})}),"get_LIVE_BUVID"===e.msg&&chrome.cookies.get({url:"https://live.bilibili.com/",name:"LIVE_BUVID"},function(e){null===e?chrome.storage.local.set({buvid:-1},()=>{}):chrome.storage.local.set({buvid:e.value},()=>{}),t({res:e})}),"get_UUID"===e.msg&&chrome.storage.local.get(["uuid"],e=>{t({res:e.uuid})}),"get_LoginStatus"===e.msg&&chrome.cookies.get({url:"https://www.bilibili.com/",name:"DedeUserID"},e=>{null===e||void 0===e?t({login:!1,vip:0}):fetch(`https://api.bilibili.com/x/space/acc/info?mid=${e.value}`,{method:"GET",credentials:"include",body:null}).then(e=>e.json()).then(e=>{0===e.code&&null!==e.data?t({login:!0,vip:e.data.vip.type}):t({login:!0,vip:1})}).catch(i=>{console.log(`Error occurs @anonymous function chrome.runtime.onMessage.addListener-get_LoginStatus, failed to fetch (dest: api.bilibili.com/x/space/acc/info); ${i}`),t({login:!0,vip:1})})}),"updateStatus"===e.msg&&chrome.storage.local.get(["updateAvailable","availableBranch"],e=>{t({res:e.updateAvailable,address:e.availableBranch})}),"popupfired"===e.msg&&(setBadge("rua\u8C79\u5668",""),t({res:"ok"})),"requestDownload"===e.msg&&(chrome.downloads.download({filename:e.fileName,url:e.url},()=>{}),t({res:"ok"})),"requestDanmaku"===e.msg){let a=new DanmakuArr;for(let t=0;t<e.danmakuObj.length;t++)void 0===e.danmakuObj[t].progress&&(e.danmakuObj[t].progress=0),a.push(new DanmakuObj(convertMSToS(e.danmakuObj[t].progress),e.danmakuObj[t].midHash,e.danmakuObj[t].content,e.danmakuObj[t].color,e.danmakuObj[t].mode,e.danmakuObj[t].fontsize,e.danmakuObj[t].progress,e.danmakuObj[t].weight));a.sort(a.size-1),t({danmakuContent:a,danmakuPoolSize:e.danmakuObj.length})}return"requestCrackUID"===e.msg&&t({response:new CRC32().crack(e.mid)}),"requestUserInfo"===e.msg&&fetch("https://api.bilibili.com/x/web-interface/card?mid="+e.mid+"&photo=true&requestFrom=rua5",{method:"GET",headers:{Accept:"application/json"},credentials:"include",body:null}).then(e=>e.json()).then(e=>{0===e.code&&null!==e.data&&t({response:e.data.card})}),"requestOSInfo"===e.msg&&chrome.runtime.getPlatformInfo(e=>{t({os:e.os})}),"requestReload"===e.msg&&initialize(!0).then(()=>{t({res:"ok"})}),e.msg.includes("QNV")&&(chrome.storage.sync.set({qnvalue:e.msg.split("?")[1]},function(){}),t({res:"ok"})),"launchLiveRoom"===e.msg&&(chrome.tabs.remove(i.tab.id).then(()=>{}),chrome.storage.local.get(["liveroomOn"],e=>{-1!==e.liveroomOn[0]&&-1!==e.liveroomOn[1]?(chrome.windows.update(e.liveroomOn[0],{focused:!0}),chrome.tabs.update(e.liveroomOn[1],{active:!0,highlighted:!0})):chrome.tabs.create({url:"./liveroom.html"})})),"requestDownloader"===e.msg&&(console.log(e.fileName),chrome.downloads.download({url:e.url,filename:e.fileName.replaceAll("/","-")},()=>{t({res:"download finished"})})),"downloaderReady"===e.msg,!0});function convertMSToS(e){var i=Math.floor;e/=1e3;let t=i(e%60),a=i(e/60%60),n=i(e/3600%60);return n=0===n?"":(10>n&&0<n?"0"+n:n)+":",a=10>a?"0"+a:a,t=10>t?"0"+t:t,n+a+":"+t}function getFollowingListLegacy(e){const i=e.uid,t=e.pn;let a=e.list;return fetch(`https://api.bilibili.com/x/relation/followings?vmid=${i}&pn=${t}&ps=50&order=desc`,{method:"GET",credentials:"include",body:null}).then(e=>e.json()).then(e=>{if(0==e.code-0){const n=e.data.list;for(const e of n)a.push(e.mid);return{uid:i,pn:t,list:a,isLast:50>n.length}}throw"error"}).catch(()=>({uid:i,pn:-1,list:a,isLast:!0}))}function getFollowingNewerAPI(){let e=[];return fetch(`https://api.bilibili.com/x/polymer/web-dynamic/v1/mention/search`,{method:"GET",credentials:"include",body:null}).then(e=>e.json()).then(i=>{if(0==i.code-0){const t=i.data.groups;for(const i of t[0].items)e.push(i.uid);if("undefined"!=typeof t[1])for(const i of t[1].items)e.push(i.uid);return e}throw"error"}).catch(()=>e)}function grabFollowingIDs(){chrome.storage.local.get(["uuid"],i=>{fetch(`https://api.vc.bilibili.com/dynamic_mix/v1/dynamic_mix/at_list?uid=${i.uuid}`,{method:"GET",credentials:"include",body:null}).then(e=>e.json()).then(e=>{0===e.code&&chrome.storage.sync.get(["blackListLive","blackListHB"],()=>{let t=[];for(let a=0;a<e.data.groups.length;a++)for(let i=0;i<e.data.groups[""+a].items.length;i++)t.push(e.data.groups[""+a].items[i+""].uid);chrome.storage.local.set({followingIDs:t},()=>{})})}).catch(i=>{errorHandler("grabFollowingIDs",i,"grabFollowingIDs()")})})}function getFollowingList(){chrome.storage.local.get(["uuid","followingIDs"],async i=>{let e=i.followingIDs;if(null!=e&&"undefined"!=typeof e&&0<e.length)chrome.storage.sync.get(["blackListLive","blackListHB"],i=>{queryLivingRoom(e,i.blackListLive,i.blackListHB)});else{let e=[];e=await getFollowingNewerAPI(),chrome.storage.sync.get(["blackListLive","blackListHB"],i=>{queryLivingRoom(e,i.blackListLive,i.blackListHB)})}})}function queryLivingRoom(e,i,t){let a=new AbortController;setTimeout(()=>{a.abort("timeout")},3e3),chrome.storage.local.get(["uuid","notificationList","watchingList","heartRhythm","buvid","medalList","jct"],d=>{let s=d.notificationList,o=d.watchingList,l=d.heartRhythm,r=new NotificationList;""!==d.notificationList&&r.loadFromStorage(d.notificationList);for(const i of e)r.add(i);fetch("https://api.live.bilibili.com/room/v1/Room/get_status_info_by_uids?requestFrom=rua5",{method:"POST",credentials:"omit",signal:a.signal,body:"{\"uids\": ["+e+"]}"}).then(e=>e.json()).then(a=>{if(0===a.code){let s=a.data;"undefined"!=typeof s&&chrome.notifications.getAll(a=>{for(const n of e)if("undefined"!=typeof s[n]){if(1===r.getState(s[n].uid)&&1!==s[n].live_status)for(const e in a)"live.bilibili.com/"===e.split(":")[2]&&e.split(":")[0]===s[n].uid+""&&chrome.notifications.clear(e);1===r.getState(s[n].uid)||1!==s[n].live_status||i.includes(s[n].uid)||chrome.storage.sync.get(["notification"],e=>{e.notification&&(console.log(s[n].title+" "+s[n].uname+" "+new Date),zan(d.uuid,d.jct,n,s[n].room_id),pushNotificationChrome(s[n].title,s[n].uname,s[n].room_id,s[n].cover_from_user,1===s[n].broadcast_type?1:0,s[n].face,n))}),r.update(s[n].uid,s[n].live_status),1!==s[n].live_status||-1!==l.findIndex(i=>i.ruid===s[n].uid)||t.includes(s[n].uid)||l.push({id:[s[n].area_v2_parent_id,s[n].area_v2_id,0,s[n].room_id],device:[d.buvid,getUUID()],ruid:s[n].uid});let e=[];for(const t of d.medalList)for(let a=0;a<l.length;a++)if(null!==l[a]&&"undefined"!=typeof l[a]&&20>t.medal_info.level&&t.medal_info.target_id===l[a].ruid&&t.medal_info.today_feed<t.medal_info.day_limit&&e.push(l[a]),null!==l[a]&&"undefined"!=typeof l[a]&&1!==s[n].live_status&&l[a].ruid===s[n].uid){let i=e.indexOf(l[a]);e.splice(i,1)}l=[],l=e}chrome.storage.local.set({notificationList:r.stringify(),heartRhythm:l},()=>{}),r=null})}a=null}).catch(e=>{errorHandler("getFollowing",e,"queryLivingRoom()")})})}function getUUID(){let e="";for(let t=0;36>t;t++){const i=Math.floor(16*Math.random());e+=8==t||13===t||18===t||23===t?"-":14===t?"4":19===t?(8|3&i).toString(16):i.toString(16)}return e}function pushNotificationChrome(e,i,t,a,n,d,s){try{let o=i+" \u5F00\u64AD\u5566!\r\n\u662F"+(0===n?"\u7535\u8111":"\u624B\u673A")+"\u76F4\u64AD\uFF01";chrome.storage.sync.get(["notificationMaster"],i=>{i.notificationMaster&&chrome.storage.local.get(["imageNotice"],i=>{i.imageNotice?imageNotification(s,e,o,t,a,d,"live.bilibili.com/"):basicNotification(s,e,o,t,d,"live.bilibili.com/")})})}catch(i){}}function basicNotification(e,i,t,a,n,d){chrome.storage.sync.get(["notificationMaster"],s=>{s.notificationMaster&&(n=null==n.length||0===n.length?"../images/haruka128.png":n,chrome.notifications.create(e+":"+a+":"+d,{type:"basic",iconUrl:n,title:i,message:t,contextMessage:"rua\u8C79\u5668"},function(){}))})}function imageNotification(e,i,t,a,n,d,s){d=null==d.length||0===d.length?"../images/haruka128.png":d,n=null==n.length||0===n.length?d:n,chrome.notifications.create(e+":"+a+":"+s,{type:"image",iconUrl:d,title:i,message:t,imageUrl:n,contextMessage:"rua\u8C79\u5668"},function(){})}chrome.notifications.onClicked.addListener(function(e){chrome.storage.local.get(["winIDList"],i=>{let t=WindowIDList.convertFromJSON(i.winIDList);chrome.windows.getAll(function(i){0<i.length?(chrome.windows.update(t.getCurrent(),{focused:!0}),chrome.tabs.create({url:`https://${e.split(":")[2]}${e.split(":")[1]}`})):chrome.storage.local.get(["windowSize"],i=>{0===i[0]||0===i[1]?chrome.windows.create({url:`https://${e.split(":")[2]}${e.split(":")[1]}`}):chrome.windows.create({url:`https://${e.split(":")[2]}${e.split(":")[1]}`,width:i[0],height:i[1]})})})}),chrome.notifications.clear(e)});function scheduleCheckIn(e){chrome.alarms.create("checkIn",{when:Date.now()+e,periodInMinutes:720}),chrome.alarms.create("bcoin",{when:Date.now()+1e3+e,periodInMinutes:720}),chrome.alarms.create("daka",{when:Date.now()+2e3+e,periodInMinutes:360})}function reloadCookies(){chrome.cookies.get({url:"https://www.bilibili.com/",name:"DedeUserID"},function(e){null===e||null===e.expirationDate||e.expirationDate<Date.parse(new Date)/1e3?chrome.storage.local.set({uuid:-1},()=>{}):chrome.storage.local.set({uuid:e.value},()=>{}),chrome.storage.local.get(["uuid","p_uuid"],e=>{-1===e.uuid&&e.uuid!==e.p_uuid&&(console.log("Session info does not exist, liver stream info listener cleared."),chrome.alarms.getAll(e=>{for(let i of e)console.log(`alarm ${i.name} found`),"checkUpd"!==i.name&&"getUID_CSRF"!==i.name&&chrome.alarms.clear(i.name).then(e=>{console.log(`${i.name} was cleared ${e}`)})})),-1!==e.uuid&&e.uuid!==e.p_uuid&&(console.log("Session info got."),refreshHeartBeatList(),chrome.storage.local.set({followingIDs:[]},()=>{}),chrome.alarms.create("getNewVideos",{when:Date.now(),periodInMinutes:.5}),chrome.alarms.create("getFollowing",{when:Date.now(),periodInMinutes:.2}),chrome.alarms.create("grabFollowingIDs",{when:Date.now(),periodInMinutes:30}),chrome.alarms.create("getNewUnreads",{when:Date.now()+5e3,periodInMinutes:.2}),chrome.alarms.create("getNewDynamics",{when:Date.now()+11e3,periodInMinutes:.33}),scheduleCheckIn(3e3)),chrome.storage.local.set({p_uuid:e.uuid},()=>{})})}),chrome.cookies.get({url:"https://www.bilibili.com/",name:"bili_jct"},function(e){null===e?chrome.storage.local.set({jct:-1},()=>{}):chrome.storage.local.set({jct:e.value},()=>{})}),chrome.cookies.get({url:"https://live.bilibili.com/",name:"LIVE_BUVID"},function(e){null===e?chrome.storage.local.set({buvid:-1},()=>{}):chrome.storage.local.set({buvid:e.value},()=>{})})}chrome.alarms.onAlarm.addListener(e=>{"getUID_CSRF"===e.name&&reloadCookies(),"checkUpd"===e.name&&checkUpdate("https://tyrael-lee.gitee.io/harukaemoji/?_="),chrome.storage.local.get(["uuid","jct","dakaUid"],i=>{switch(e.name){case"grabFollowingIDs":grabFollowingIDs();break;case"getFollowing":getFollowingList();break;case"getNewVideos":videoNotify(i.uuid);break;case"getNewUnreads":getNewUnread();break;case"getNewDynamics":dynamicNotify();break;case"checkIn":checkingIn();break;case"daka":checkMedalDaka();break;case"bcoin":queryBcoin();break;case"dakaRoom":chrome.storage.sync.get(["dkWord"],e=>{daka(i.dakaUid,i.jct,""===e.dkWord?"\u6253\u5361":e.dkWord)});break;case"heartRate":chrome.storage.sync.get(["heartBeatSwitch"],e=>{e.heartBeatSwitch&&heartBeat()});break;case"refreshHB":refreshHeartBeatList();break;case"refreshHBRetry":refreshHeartBeatList()}})});function checkingIn(){chrome.storage.sync.get(["checkIn"],e=>{e.checkIn&&fetch("https://api.live.bilibili.com/xlive/web-ucenter/v1/sign/DoSign",{method:"GET",credentials:"include",body:null}).then(()=>{console.log("\u7B7E\u5230\u6210\u529F "+new Date().toUTCString())}).catch(e=>{errorHandler("checkIn",e,"checkingIn()")})})}function errorHandler(e,i,t){console.log(`Error occurs @function ${t}; ${i}`);let a=.2;a=e.includes("checkIn")||e.includes("bcoin")?720:e.includes("daka")?360:.2,e.includes("Dynamic")?chrome.storage.local.set({dynamicInit:!0},()=>{}):e.includes("Video")?chrome.storage.local.set({videoInit:!0},()=>{}):e.includes("Unread")&&chrome.storage.local.set({unreadInit:!0},()=>{}),"undefined"!=typeof i.responseJSON&&-412===i.responseJSON.code||-412==i?chrome.alarms.clear(e).then(()=>{chrome.alarms.create(e,{when:Date.now()+15e5,periodInMinutes:a})}):!(i+"").includes("AbortError: The user aborted a request")&&chrome.alarms.clear(e).then(()=>{chrome.alarms.create(e,{when:Date.now()+2e4,periodInMinutes:a})})}function exchangeBCoin(e){let i=new FormData;i.append("type","1"),i.append("csrf",e),fetch("https://api.bilibili.com/x/vip/privilege/receive?requestFrom=rua5",{method:"POST",credentials:"include",body:i}).then(e=>e.json()).then(e=>{switch(e.code){case 0:console.log("\u5151\u6362\u6210\u529F\uFF01\u597D\u8036( \u2022\u0300 \u03C9 \u2022\u0301 )\u2727"),chrome.notifications.create(Math.random()+"",{type:"basic",iconUrl:"./images/abaaba.png",title:"\u672C\u6708\u5927\u4F1A\u5458\u76845B\u5E01\u5151\u6362\u6210\u529F\uFF01",message:""},function(e){setTimeout(function(){chrome.notifications.clear(e)},3e3)});break;case 69155:console.log("\u5F53\u524D\u975E\u5927\u4F1A\u5458");break;default:console.log("\u5151\u6362\u5931\u8D25\uFF0C\u4F4D\u7F6E\u9519\u8BEF")}}).catch(e=>{errorHandler("bcoin",e,"exchangeBCoin()")})}function queryBcoin(){chrome.storage.sync.get(["bcoin"],e=>{e.bcoin&&fetch("https://api.bilibili.com/x/vip/privilege/my",{method:"GET",credentials:"include",body:null}).then(e=>e.json()).then(e=>{console.log("checked vip status"),0===e.code&&(1===e.data.list[0].type&&0===e.data.list[0].state?chrome.storage.local.get(["jct"],e=>{exchangeBCoin(e.jct)}):1===e.data.list[0].type&&1===e.data.list[0].state&&console.log("\u8FD9\u4E2A\u6708\u7684\u5DF2\u7ECF\u5151\u6362\u8FC7\u4E86\uFF0C\u597D\u8036\uFF01( \u2022\u0300 \u03C9 \u2022\u0301 )\u2727"))}).catch(e=>{errorHandler("bcoin",e,"queryBcoin()")})})}function getNewPost(e){let i=new AbortController;return setTimeout(()=>{i.abort("timeout")},3e3),new Promise((t,a)=>{chrome.storage.local.get(["video_id_list","pgc_id_list","article_id_list","videoInit"],n=>{let d="video"===e?n.video_id_list:"pgc"===e?n.pgc_id_list:n.article_id_list;fetch(`https://api.bilibili.com/x/polymer/web-dynamic/v1/feed/all?page=1&type=${e}`,{method:"GET",credentials:"include",signal:i.signal,body:null}).then(e=>e.json()).then(i=>{chrome.storage.sync.get(["dynamicPush","blackListVideo","videoPush","pgcPush","articlePush"],s=>{if(0!==i.code)a(i.code);else if(0===i.code&&s.dynamicPush){let a=i.data.items;for(let t=0;t<a.length;t++){let i=a[t+""].modules.module_dynamic.major,o="video"===e?i.archive:"pgc"===e?i.pgc:i.article,l=a[t+""].modules.module_author,r=l.mid-0;d.includes(a[t+""].id_str)||s.blackListVideo.includes(r)||(!n.videoInit&&"video"===e&&s.videoPush&&isNew(l.pub_ts)&&(console.log(`你关注的up ${l.name} 投稿了新视频！${o.title} see:${o.bvid}`),basicNotification(a[t+""].id_str,`你关注的up ${l.name} 投稿了新视频！`,o.title,o.bvid,l.face,"b23.tv/")),!n.videoInit&&"pgc"===e&&s.pgcPush&&(console.log("\u4F60\u5173\u6CE8\u7684\u756A\u5267 "+l.name+" \u66F4\u65B0\u4E86\uFF01"+o.title+" see:"+o.jump_url),basicNotification(a[t+""].id_str,"\u4F60\u5173\u6CE8\u7684\u756A\u5267 "+l.name+" \u66F4\u65B0\u4E86\uFF01",o.title,o.jump_url.replaceAll("https://","").replaceAll("http://",""),o.cover,"")),!n.videoInit&&"article"===e&&s.articlePush&&isNew(l.pub_ts)&&(console.log(`你关注的up ${l.name} 投稿了文章！${o.title} see:${o.id}`),basicNotification(a[t+""].id_str,`你关注的up ${l.name} 投稿了文章！`,o.title,o.id,l.face,"www.bilibili.com/read/cv")),d.push(a[t+""].id_str))}40<=d.length&&d.splice(0,10),"video"===e?chrome.storage.local.set({video_id_list:d},()=>{}):"pgc"===e?chrome.storage.local.set({pgc_id_list:d},()=>{}):"article"===e?chrome.storage.local.set({article_id_list:d},()=>{}):void 0,d=null,t(200)}})}).catch(i=>{a(i)})})})}function isNew(e){return 600>Date.now()/1e3-(e-0)}async function videoNotify(){try{await getNewPost("video"),await getNewPost("pgc"),await getNewPost("article")}catch(i){console.log(i),errorHandler("getNewVideos",i,"videoNotify()")}await chrome.storage.local.set({videoInit:!1},()=>{})}function dynamicNotify(){let e=new AbortController;setTimeout(()=>{e.abort("timeout")},3e3),chrome.storage.local.get(["dynamicList","dynamicInit"],t=>{let a=t.dynamicList,n=Date.now()/1e3;fetch(`https://api.vc.bilibili.com/dynamic_svr/v1/dynamic_svr/dynamic_new?type_list=1,2,4`,{method:"GET",credentials:"include",signal:e.signal,body:null}).then(e=>e.json()).then(e=>{0===e.code?chrome.storage.sync.get(["dynamicSwitch","blackListDynamic"],d=>{let s=e.data.cards;for(let e=0;e<s.length;e++){let i=JSON.parse(s[e+""].card),o=s[e+""].desc.type,l=s[e+""].desc.uid-0;!a.includes(s[e+""].desc.dynamic_id)&&300>n-(s[e+""].desc.timestamp-0)&&(t.dynamicInit||!d.dynamicSwitch||d.blackListDynamic.includes(l)||(1===o?(console.log("\u4F60\u5173\u6CE8\u7684up "+i.user.uname+" \u8F6C\u53D1\u4E86\u4E00\u6761\u65B0\u52A8\u6001 "+i.item.content+" see:"+`https://t.bilibili.com/${s[e+""].desc.dynamic_id_str}`),basicNotification(s[e+""].desc.dynamic_id,`你关注的up ${i.user.uname} 转发了一条动态`,i.item.content+"",s[e+""].desc.dynamic_id_str,i.user.face,"t.bilibili.com/")):2===o?(console.log("\u4F60\u5173\u6CE8\u7684up "+i.user.name+" \u53D1\u4E86\u4E00\u6761\u65B0\u52A8\u6001 "+i.item.description+" see: "+`https://t.bilibili.com/${s[e+""].desc.dynamic_id_str}`),basicNotification(s[e+""].desc.dynamic_id,`你关注的up ${i.user.name} 发了一条图片动态`,i.item.description+"",s[e+""].desc.dynamic_id_str,i.user.head_url,"t.bilibili.com/")):4===o?(console.log("\u4F60\u5173\u6CE8\u7684up "+i.user.uname+" \u53D1\u4E86\u4E00\u6761\u65B0\u52A8\u6001 "+i.item.content+" see: "+`https://t.bilibili.com/${s[e+""].desc.dynamic_id_str}`),basicNotification(s[e+""].desc.dynamic_id,`你关注的up ${i.user.uname} 发了一条新动态`,i.item.content+"",s[e+""].desc.dynamic_id_str,i.user.face,"t.bilibili.com/")):void 0),a.push(s[e+""].desc.dynamic_id),40<a.length&&a.splice(0,1))}chrome.storage.local.set({dynamicList:a},()=>{})}):errorHandler("getNewDynamics",e.code,"dynamicNotify()"),chrome.storage.local.set({dynamicInit:!1},()=>{})}).catch(i=>{errorHandler("getNewDynamics",i,"dynamicNotify()")})})}function getNewUnread(){chrome.storage.local.get(["unreadData","unreadInit","unreadMessage"],async e=>{let i=JSON.parse(e.unreadData);await fetch("https://api.bilibili.com/x/msgfeed/unread",{method:"GET",credentials:"include",body:null}).then(e=>e.json()).then(t=>{0===t.code?chrome.storage.sync.get(["unreadSwitch"],a=>{if(a.unreadSwitch){if(!e.unreadInit&&(0<t.data.at-i.at||0<t.data.like-i.like||0<t.data.reply-i.reply||0<t.data.sys_msg-i.sys_msg||0<t.data.up-i.up)){let e=`${0<t.data.at-i.at?t.data.at-i.at+"\u4E2A@, ":""}${0<t.data.like-i.like?t.data.like-i.like+"\u4E2A\u8D5E, ":""}${0<t.data.reply-i.reply?t.data.reply-i.reply+"\u4E2A\u56DE\u590D, ":""}${0<t.data.sys_msg-i.sys_msg?t.data.sys_msg-i.sys_msg+"\u4E2A\u7CFB\u7EDF\u901A\u77E5, ":""}${0<t.data.up-i.up?t.data.up-i.up+"\u4E2Aup\u52A9\u624B\u63D0\u9192, ":""}`;chrome.notifications.clear("-276492:reply:message.bilibili.com/#/"),basicNotification(-276492,"\u4F60\u6536\u5230\u4E86\u65B0\u7684\u6D88\u606F:",e.substring(0,e.length-2),`reply`,"",`message.bilibili.com/#/`)}i=t.data,chrome.storage.local.set({unreadData:JSON.stringify(i)},()=>{})}}):errorHandler("getNewUnreads",t.code,"getUnread()")}).catch(i=>{errorHandler("getNewUnreads",i,"getUnread()")}),await fetch("https://api.vc.bilibili.com/session_svr/v1/session_svr/single_unread",{method:"GET",credentials:"include",body:null}).then(e=>e.json()).then(i=>{0===i.code?chrome.storage.sync.get(["unreadSwitch"],t=>{t.unreadSwitch&&!e.unreadInit&&0<i.data.biz_msg_follow_unread+i.data.biz_msg_unfollow_unread+i.data.dustbin_push_msg+i.data.dustbin_unread+i.data.follow_unread+i.data.unfollow_push_msg+i.data.unfollow_unread-e.unreadMessage&&(chrome.notifications.clear("-276491:reply:message.bilibili.com/#/"),basicNotification(-276491,`你收到了${i.data.biz_msg_follow_unread+i.data.biz_msg_unfollow_unread+i.data.dustbin_push_msg+i.data.dustbin_unread+i.data.follow_unread+i.data.unfollow_push_msg+i.data.unfollow_unread-e.unreadMessage}条新私信`,"",`reply`,"",`message.bilibili.com/#/`)),chrome.storage.local.set({unreadMessage:i.data.biz_msg_follow_unread+i.data.biz_msg_unfollow_unread+i.data.dustbin_push_msg+i.data.dustbin_unread+i.data.follow_unread+i.data.unfollow_push_msg+i.data.unfollow_unread},()=>{})}):errorHandler("getUnread",i.code,"getUnread()")}).catch(i=>{errorHandler("getUnread",i,"getUnread()")}),chrome.storage.local.set({unreadInit:!1},()=>{})})}function checkMedalDaka(){chrome.storage.sync.get(["daka","blackListDK"],e=>{console.log("Grabbing medal info"),chrome.storage.local.get(["rua_lastDK","uuid","dakaUid"],t=>{if(e.daka&&(null===t.rua_lastDK||isNewerThan(t.rua_lastDK.split("-"),(getUTC8Time().getFullYear()+"-"+getUTC8Time().getMonth()+"-"+getUTC8Time().getDate()).split("-")))){let a=[];chrome.storage.local.set({rua_lastDK:getUTC8Time().getFullYear()+"-"+getUTC8Time().getMonth()+"-"+getUTC8Time().getDate()},()=>{}),fetch("https://api.live.bilibili.com/xlive/web-ucenter/user/MedalWall?target_id="+t.uuid,{method:"GET",credentials:"include",body:null}).then(e=>e.json()).then(n=>{console.log(n.data.list.length+" medal founded."),console.log(`${n.data.list.length} medal founded, ${e.blackListDK.length} ignored.`),console.log(t.dakaUid);for(let d=0;d<n.data.list.length;d++)-1===e.blackListDK.indexOf(n.data.list[d].medal_info.target_id)&&-1===t.dakaUid.indexOf(n.data.list[d].medal_info.target_id)&&100>n.data.list[d].medal_info.today_feed&&a.push(n.data.list[d].medal_info.target_id);chrome.storage.local.set({dakaUid:a},()=>{chrome.alarms.create("dakaRoom",{when:Date.now(),periodInMinutes:.1})})}).catch(e=>{chrome.storage.local.set({rua_lastDK:"1970-01-01"},()=>{}),errorHandler("daka",e,"checkMedalDaka()")})}else console.log("No more grab needed.")})})}function daka(e,i,t){0===e.length?chrome.alarms.clear("dakaRoom",()=>{}):fetch("https://api.live.bilibili.com/live_user/v1/Master/info?uid="+e[0],{method:"GET",credentials:"include",body:null}).then(e=>e.json()).then(a=>{if(0===a.code||0<a.data.length){let n=new FormData;n.append("bubble","0"),n.append("msg",t),n.append("color","16777215"),n.append("mode","1"),n.append("fontsize","25"),n.append("rnd",Math.round(Date.now()/1e3)+""),n.append("roomid",a.data.room_id),n.append("csrf",i),n.append("csrf_token",i),fetch("https://api.live.bilibili.com/msg/send?requestFrom=rua5",{method:"POST",credentials:"include",body:n}).then(()=>{console.log("\u6253\u5361\u6210\u529F: https://live.bilibili.com/"+a.data.room_id);let i=e;i.splice(0,1),chrome.storage.local.set({dakaUid:i},()=>{})}).catch(e=>{console.log(`Error occurs @function daka(), failed to fetch (dest: api.live.bilibili.com/msg/send); ${e}`)})}}).catch(i=>{console.log(`Error occurs @function daka(); ${i}`)})}async function legalVideoLink(e){return!!("AaBb".includes(e.charAt(0))&&"Vv".includes(e.charAt(1)))&&("AaBb".substr(0,2).includes(e.charAt(0))?await findVideo("aid="+e.substr(2,e.length-1)):await findVideo("bvid="+e))}function findVideo(e){return fetch("https://api.bilibili.com/x/web-interface/view?"+e,{method:"GET",credentials:"include",body:null}).then(e=>e.json()).then(e=>0===e.code).catch(i=>{console.log(`Error occurs @function findVideo(); ${i}`)})}function checkUpdate(i){console.log("checking update at "+new URL(i).hostname);let t=chrome.runtime.getManifest().version.split(".");fetch(i+new Date().getTime(),{method:"GET",credentials:"omit",body:null}).then(e=>e.text()).then(e=>{null!==e&&null!==/<meta name="current-version" content="(.*?)">/m.exec(e)&&t!==/<meta name="current-version" content="(.*?)">/m.exec(e)[1]&&(t=/<meta name="current-version" content="(.*?)">/m.exec(e)[1].split("."),t[0]-0>chrome.runtime.getManifest().version.split(".")[0]-0||t[0]-0>=chrome.runtime.getManifest().version.split(".")[0]-0&&t[1]-0>chrome.runtime.getManifest().version.split(".")[1]-0?(console.log(`A newer version found: ${t[0]}.${t[1]}`),chrome.storage.local.set({updateAvailable:!0},()=>{}),chrome.storage.local.set({availableBranch:new URL(i).hostname.includes("github")?"https://github.com/TyraelDLee/HarukaEmoji/releases/latest":"https://gitee.com/tyrael-lee/HarukaEmoji/releases"},()=>{}),setBadge("rua\u8C79\u5668 \u6709\u66F4\u65B0\u53EF\u7528","1")):(console.log("Current version is latest."),chrome.storage.local.set({updateAvailable:!1},()=>{}),setBadge("rua\u8C79\u5668","")))}).catch(t=>{console.log(`Error occurs @function checkUpdate; ${t}`),i.includes("github")?console.log(`Unable to access Gitee and GitHub, stop check today.`):(console.log(`Unable to access Gitee, retry at GitHub source.`),checkUpdate("https://tyraeldlee.github.io/HarukaEmoji/?_="))})}function isNewerThan(e,i){return!!(parseInt(e[0])<parseInt(i[0]))||!(parseInt(e[0])>parseInt(i[0]))&&(!!(parseInt(e[1])<parseInt(i[1]))||!(parseInt(e[1])>parseInt(i[1]))&&parseInt(e[2])<parseInt(i[2]))}function getUTC8Time(){return new Date(new Date().getTime()+6e4*new Date().getTimezoneOffset())}function setBadge(e,i){chrome.action.setTitle({title:e}),chrome.action.setBadgeText({text:i})}function heartBeat(){chrome.storage.local.get(["jct","uuid","heartRhythm"],async e=>{(-1===e.uuid||-1===e.jct)&&chrome.storage.local.set({heartRhythm:[]},()=>{});let t=e.heartRhythm,a=[];if(0<t.length)for(let n=0;n<t.length;n++)if(null!==t[n]&&"undefined"!=typeof t[n]){const i=await QRSComplex(t[n],e.jct);t[n]=i,a.push(i)}chrome.storage.local.set({heartRhythm:a},()=>{})})}function QRSComplex(e,i){let t;return 0===e.id[2]?t={id:e.id,device:e.device,ruid:e.ruid,ts:Date.now(),is_patch:0,heart_beat:[]}:(t={id:e.id,device:e.device,ruid:e.ruid,ets:e.ets,benchmark:e.benchmark,ts:Date.now(),time:e.time},t=Object.assign({s:function(e,t){let a=JSON.stringify({platform:"web",parent_id:e.id[0],area_id:e.id[1],seq_id:e.id[2],room_id:e.id[3],buvid:e.device[0],uuid:e.device[1],ets:e.ets,time:e.time,ts:e.ts});for(let n of t)0===n?a=CryptoJS.HmacMD5(a,e.benchmark).toString(CryptoJS.enc.Hex):1===n?a=CryptoJS.HmacSHA1(a,e.benchmark).toString(CryptoJS.enc.Hex):2===n?a=CryptoJS.HmacSHA256(a,e.benchmark).toString(CryptoJS.enc.Hex):3===n?a=CryptoJS.HmacSHA224(a,e.benchmark).toString(CryptoJS.enc.Hex):4===n?a=CryptoJS.HmacSHA512(a,e.benchmark).toString(CryptoJS.enc.Hex):5===n?a=CryptoJS.HmacSHA384(a,e.benchmark).toString(CryptoJS.enc.Hex):void 0;return a}(t,e.secret_rule)},t)),fetch(`https://live-trace.bilibili.com/xlive/data-interface/v1/x25Kn/${0===e.id[2]?"E":"X"}`,{method:"POST",credentials:"include",headers:{"content-type":"application/x-www-form-urlencoded"},body:`${function(e){let t="";for(const a in e)t+=`${a}=${encodeURIComponent("id"==a||"device"===a?JSON.stringify(e[a]):e[a])}&`;return t.slice(0,-1)}(t)}&ua=${self.navigator.userAgent}&csrf_token=${i}&csrf=${i}&visit_id:`}).then(e=>e.json()).then(i=>{if(0===i.code){let t=e.id[2]+1;return{id:[e.id[0],e.id[1],t,e.id[3]],device:e.device,ruid:e.ruid,ets:i.data.timestamp,benchmark:i.data.secret_key,time:i.data.heartbeat_interval,secret_rule:i.data.secret_rule}}return{id:[e.id[0],e.id[1],0,e.id[3]],device:e.device,ruid:e.ruid}}).catch(i=>{console.log(`Error occurs @function QRSComplex; ${i}`)})}function refreshHeartBeatList(){chrome.storage.local.get(["uuid"],e=>{fetch(`https://api.live.bilibili.com/xlive/web-ucenter/user/MedalWall?target_id=${e.uuid}`,{method:"GET",credentials:"include",body:null}).then(e=>e.json()).then(e=>{0===e.code?chrome.storage.local.set({medalList:e.data.list},()=>{}):chrome.alarms.create("refreshHBRetry",{delayInMinutes:1})}).catch(i=>{console.log(`Error occurs @function refreshHeartBeatList(); ${i}`),chrome.alarms.create("refreshHBRetry",{delayInMinutes:1})})})}function zan(e,i,t,a){let n=new FormData;n.append("click_time","50"),n.append("room_id",a),n.append("uid",e),n.append("anchor_id",t),n.append("csrf_token",i),n.append("csrf",i),fetch("https://api.live.bilibili.com/xlive/app-ucenter/v1/like_info_v3/like/likeReportV3",{method:"POST",credentials:"include",body:n}).then(()=>{})}