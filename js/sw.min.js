class WindowIDList{static convertFromJSON(a){let b=new WindowIDList;return b.list=a.id,b}constructor(){this.list=[]}push(a){this.remove(a),this.list.push(a)}remove(a){-1<this.list.indexOf(a)&&this.list.splice(this.list.indexOf(a),1)}getCurrent(){return 0<this.list.length?this.list[this.list.length-1]:-1}length(){return this.list.length}toJSONObject(){return{id:this.list}}}class DanmakuObj{constructor(a,b,c,d,e,f,g,h){this.time=a,this.mid=b,this.content=c,this.name=[],this.look=!0,this.color=d,this.mode=e,this.fontsize=f,this.ts=g,this.weight=h}setName(a){this.name=a}}class DanmakuArr{constructor(){this.list=[],this.size=0,this.displaySize=this.size}push(a){this.list.push(a),this.size++}concat(a){this.list=this.list.concat(a.list),this.size+=a.size}get(a){return this.list[a]}max(){let a=0;for(let b=0;b<this.list.length;b++)a<this.list[b].time&&(a=this.list[b].time);return a}min(){let a=Number.MAX_VALUE;for(let b=0;b<this.list.length;b++)a>this.list[b].time&&(a=this.list[b].time);return a}sort(a){function b(a,b,c){const d=a[b];a[b]=a[c],a[c]=d}const c=this.max(),d=this.min(),e=[],f=Math.floor((c-d)/a)+1;for(let c=0;c<this.size;c++){const a=~~(this.list[c].ts/f);e[a]||(e[a]=[]),e[a].push(this.list[c]);for(let c=e[a].length;0<c;)void 0!==e[a][c]&&e[a][c].ts<e[a][c-1].ts&&b(e[a],c,c-1),c--}let g=[];for(let b=0;b<e.length;b++)e[b]&&(g=g.concat(e[b]));this.list=g}find(a){function b(a){return a.replaceAll(",","\uFF0C").replaceAll(".","\u3002").replaceAll("?","\uFF1F").replaceAll("!","\uFF01").replaceAll(";","\uFF1B").replaceAll(":","\uFF1A").replaceAll("\u201C","\"").replaceAll("\u201D","\"").replaceAll("(","\uFF08").replaceAll(")","\uFF09")}let c=new DanmakuArr;if(a=b(a),""===a)return this;for(let d=0;d<this.size;d++)b(this.list[d].content).includes(a)&&c.push(this.list[d]);return c}}class CRC32{static initCrc32Table(a){for(let b,c=0;256>c;c++){b=c;for(let a=0;8>a;a++)1&b?b=3988292384^b>>>1:b>>>=1;a[c]=b}}constructor(){this.crc32Table=new Uint32Array(256),CRC32.initCrc32Table(this.crc32Table),this.rainbowTableHash=new Uint32Array(1e5),this.rainbowTableValue=new Uint32Array(1e5);let a=new Uint32Array(1e5),b=new Uint32Array(65537);for(let c,d=0;1e5>d;d++)c=this.compute(d)>>>0,a[d]=c,b[c>>>16]++;let c=0;this.shortHashBucketStarts=b.map((a)=>c+=a);for(let b,c=0;1e5>c;c++)b=--this.shortHashBucketStarts[a[c]>>>16],this.rainbowTableHash[b]=a[c],this.rainbowTableValue[b]=c}compute(a,b=!1){let c=0;for(let d of a.toString())c=this.crc32Update(c,+d);if(b)for(let a=0;5>a;a++)c=this.crc32Update(c,0);return c}crack(a){var b=Math.pow;let c=[],d=~+("0x"+a)>>>0,e=4294967295;for(let f=1;10>f;f++)if(e=this.crc32Update(e,48),6>f)c=c.concat(this.lookup(d^e));else{let a=b(10,f-6),g=b(10,f-5);for(let b=a;b<g;b++)for(let a of this.lookup(d^e^this.compute(b,!0)))c.push(1e5*b+a)}return c}crc32Update(a,b){return a>>>8^this.crc32Table[255&(a^b)]}lookup(a){a>>>=0;let b=[],c=a>>>16;for(let d=this.shortHashBucketStarts[c];d<this.shortHashBucketStarts[c+1];d++)this.rainbowTableHash[d]===a&&b.push(this.rainbowTableValue[d]);return b}}chrome.action.setBadgeBackgroundColor({color:"#00A0FF"}),chrome.windows.getAll(function(a){let b=new WindowIDList;for(let c=0;c<a.length;c++)b.push(a[c].id);chrome.storage.local.set({winIDList:b.toJSONObject()},()=>{})}),chrome.windows.onCreated.addListener(function(a){chrome.storage.local.get(["winIDList"],(b)=>{let c=WindowIDList.convertFromJSON(b.winIDList);c.push(a.id),chrome.storage.local.set({winIDList:c.toJSONObject()},()=>{})})}),chrome.windows.onRemoved.addListener(function(a){chrome.storage.local.get(["winIDList"],(b)=>{let c=WindowIDList.convertFromJSON(b.winIDList);c.remove(a),chrome.storage.local.set({winIDList:c.toJSONObject()},()=>{})})}),chrome.windows.onFocusChanged.addListener(function(a){-1!==a&&chrome.storage.local.get(["winIDList"],(b)=>{let c=WindowIDList.convertFromJSON(b.winIDList);c.push(a),chrome.storage.local.set({winIDList:c.toJSONObject()},()=>{})})}),chrome.runtime.onInstalled.addListener(async function(){chrome.notifications.getAll((a)=>{for(let b in a)chrome.notifications.clear(b)}),await chrome.tabs.create({url:"./readme.html"}),await chrome.storage.local.get(["rua_lastDK"],(a)=>{console.log(a.rua_lastDK),(null===a.rua_lastDK||a.rua_lastDK===void 0)&&chrome.storage.local.set({rua_lastDK:"1970-01-01"},()=>{})}),await chrome.storage.local.set({imageNotice:!1},function(){}),await chrome.storage.sync.set({notification:!0,medal:!0,checkIn:!0,bcoin:!0,qn:!0,qnvalue:"\u539F\u753B",dynamicPush:!0,hiddenEntry:!1,daka:!0,record:!1,prerecord:300,enhancedHiddenEntry:!1,unreadSwitch:!0,dynamicSwitch:!0},function(){}),chrome.contextMenus.create({contexts:["selection","link"],title:"\u7528bilibili\u641C\u7D22",type:"normal",id:"rua-contextMenu-v3"}),chrome.alarms.create("checkUpd",{when:Date.now(),periodInMinutes:720}),await chrome.storage.local.set({uuid:-1,jct:-1,p_uuid:-1,updateAvailable:!1,availableBranch:"https://gitee.com/tyrael-lee/HarukaEmoji/releases",downloadFileName:"",dynamic_id_list:[],unreadData:"{\"at\":0,\"chat\":0,\"like\":0,\"reply\":0,\"sys_msg\":0,\"up\":0}",unreadMessage:0,dynamicList:[],notificationList:[],videoInit:!0,dynamicInit:!0,unreadInit:!0,dakaUid:[]},()=>{}),chrome.alarms.create("getUID_CSRF",{when:Date.now(),periodInMinutes:0.3})}),chrome.contextMenus.onClicked.addListener((a)=>{"rua-contextMenu-v3"===a.menuItemId&&legalVideoLink(a.selectionText).then((b)=>{b?chrome.tabs.create({url:"https://www.bilibili.com/video/"+a.selectionText}):chrome.tabs.create({url:"https://search.bilibili.com/all?keyword="+a.selectionText})})}),chrome.runtime.onConnect.addListener(function(a){"popup"===a.name&&a.onDisconnect.addListener(function(){})}),chrome.storage.onChanged.addListener(function(a){for(let[b,{oldValue:c,newValue:d}]of Object.entries(a))"checkIn"===b&&d&&checkingIn(),"bcoin"===b&&d&&queryBcoin(),"hiddenEntry"===b&&(d?chrome.declarativeNetRequest.updateEnabledRulesets({enableRulesetIds:["redirect"]},()=>{}):chrome.declarativeNetRequest.updateEnabledRulesets({disableRulesetIds:["redirect"]},()=>{})),"enhancedHiddenEntry"===b&&(d?chrome.declarativeNetRequest.updateEnabledRulesets({enableRulesetIds:["cookieOmit"]},()=>{}):chrome.declarativeNetRequest.updateEnabledRulesets({disableRulesetIds:["cookieOmit"]},()=>{})),"daka"===b&&d&&checkMedalDaka()}),chrome.runtime.onMessage.addListener(function(a,b,c){if("get_LoginInfo"===a.msg&&chrome.cookies.get({url:"https://www.bilibili.com/",name:"bili_jct"},function(a){null===a?chrome.storage.local.set({jct:-1},()=>{}):chrome.storage.local.set({jct:a.value},()=>{}),chrome.storage.local.get(["jct","uuid"],(a)=>{c({res:a.jct+","+a.uuid+","+a.uuid})})}),"get_UUID"===a.msg&&chrome.storage.local.get(["uuid"],(a)=>{c({res:a.uuid})}),"get_LoginStatus"===a.msg&&chrome.cookies.get({url:"https://www.bilibili.com/",name:"DedeUserID"},(a)=>{null===a||void 0===a?c({login:!1,vip:0}):fetch(`https://api.bilibili.com/x/space/acc/info?mid=${a.value}`,{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((a)=>{0===a.code&&null!==a.data?c({login:!0,vip:a.data.vip.type}):c({login:!0,vip:1})})}),"updateStatus"===a.msg&&chrome.storage.local.get(["updateAvailable","availableBranch"],(a)=>{c({res:a.updateAvailable,address:a.availableBranch})}),"popupfired"===a.msg&&setBadge("rua\u8C79\u5668",""),"requestDownload"===a.msg&&(chrome.downloads.download({filename:a.fileName,url:a.url},()=>{}),c({res:"ok"})),"requestDanmaku"===a.msg){let b=new DanmakuArr;for(let c=0;c<a.danmakuObj.length;c++)void 0===a.danmakuObj[c].progress&&(a.danmakuObj[c].progress=0),b.push(new DanmakuObj(convertMSToS(a.danmakuObj[c].progress),a.danmakuObj[c].midHash,a.danmakuObj[c].content,a.danmakuObj[c].color,a.danmakuObj[c].mode,a.danmakuObj[c].fontsize,a.danmakuObj[c].progress,a.danmakuObj[c].weight));b.sort(b.size-1),c({danmakuContent:b,danmakuPoolSize:a.danmakuObj.length})}return"requestCrackUID"===a.msg&&c({response:new CRC32().crack(a.mid)}),"requestUserInfo"===a.msg&&fetch("https://api.bilibili.com/x/web-interface/card?mid="+a.mid+"&photo=true&requestFrom=rua5",{method:"GET",headers:{Accept:"application/json"},credentials:"include",body:null}).then((a)=>a.json()).then((a)=>{0===a.code&&null!==a.data&&c({response:a.data.card})}),"requestOSInfo"===a.msg&&chrome.runtime.getPlatformInfo((a)=>{c({os:a.os})}),a.msg.includes("QNV")&&(chrome.storage.sync.set({qnvalue:a.msg.split("?")[1]},function(){}),c({res:"ok"})),!0});function convertMSToS(a){var b=Math.floor;a/=1e3;let c=b(a%60),d=b(a/60%60),e=b(a/3600%60);return e=0===e?"":(10>e&&0<e?"0"+e:e)+":",d=10>d?"0"+d:d,c=10>c?"0"+c:c,e+d+":"+c}function queryLivingRoom(a){chrome.storage.local.get(["uuid","notificationList"],(b)=>{let c=b.notificationList;fetch("https://api.live.bilibili.com/room/v1/Room/get_status_info_by_uids?requestFrom=rua5",{method:"POST",credentials:"omit",body:"{\"uids\": ["+a+"]}"}).then((a)=>a.json()).then((b)=>{if(0===b.code){let d=b.data;chrome.notifications.getAll((b)=>{for(let d in b)-1===a.indexOf(d.split(":")[0]-1+1)&&"live.bilibili.com/"===d.split(":")[2]&&(chrome.notifications.clear(d),-1!==c.indexOf(d.split(":")[1]-1+1)&&c.splice(c.indexOf(d.split(":")[1]-1+1),1));for(let e=0;e<a.length;e++)void 0!==d[a[e]]&&(1!==d[a[e]].live_status&&-1!==c.indexOf(d[a[e]].room_id)&&(chrome.notifications.clear(`${a[e]}:${d[a[e]].room_id}:live.bilibili.com/`),c.splice(c.indexOf(d[a[e]].room_id),1)),1===d[a[e]].live_status&&-1===c.indexOf(d[a[e]].room_id)&&(c.push(d[a[e]].room_id),chrome.storage.sync.get(["notification"],(b)=>{b.notification&&(console.log(d[a[e]].title+" "+d[a[e]].uname+" "+new Date),pushNotificationChrome(d[a[e]].title,d[a[e]].uname,d[a[e]].room_id,d[a[e]].cover_from_user,1===d[a[e]].broadcast_type?1:0,d[a[e]].face,a[e]))})));chrome.storage.local.set({notificationList:c},()=>{})})}}).catch((a)=>{errorHandler("getNewVideos",a,"queryLivingRoom()")})})}function pushNotificationChrome(a,b,c,d,e,f,g){try{let h=b+" \u5F00\u64AD\u5566!\r\n\u662F"+(0===e?"\u7535\u8111":"\u624B\u673A")+"\u76F4\u64AD\uFF01";chrome.storage.local.get(["imageNotice"],(b)=>{b.imageNotice?imageNotification(g,a,h,c,d,f,"live.bilibili.com/"):basicNotification(g,a,h,c,f,"live.bilibili.com/")})}catch(a){}}function basicNotification(a,b,c,d,e,f){e=null==e.length||0===e.length?"../images/haruka128.png":e,chrome.notifications.create(a+":"+d+":"+f,{type:"basic",iconUrl:e,title:b,message:c,contextMessage:"rua\u8C79\u5668"},function(){})}function imageNotification(a,b,c,d,e,f,g){f=null==f.length||0===f.length?"../images/haruka128.png":f,e=null==e.length||0===e.length?f:e,chrome.notifications.create(a+":"+d+":"+g,{type:"image",iconUrl:f,title:b,message:c,imageUrl:e,contextMessage:"rua\u8C79\u5668"},function(){})}chrome.notifications.onClicked.addListener(function(a){chrome.storage.local.get(["winIDList"],(b)=>{let c=WindowIDList.convertFromJSON(b.winIDList);chrome.windows.getAll(function(b){0<b.length?(chrome.windows.update(c.getCurrent(),{focused:!0}),chrome.tabs.create({url:`https://${a.split(":")[2]}${a.split(":")[1]}`})):chrome.windows.create({url:`https://${a.split(":")[2]}${a.split(":")[1]}`})})}),chrome.notifications.clear(a)});function scheduleCheckIn(a){chrome.alarms.create("checkIn",{when:Date.now()+a,periodInMinutes:720}),chrome.alarms.create("bcoin",{when:Date.now()+1e3+a,periodInMinutes:720}),chrome.alarms.create("daka",{when:Date.now()+2e3+a,periodInMinutes:360})}function reloadCookies(){chrome.cookies.get({url:"https://www.bilibili.com/",name:"DedeUserID"},function(a){null===a||null===a.expirationDate||a.expirationDate<Date.parse(new Date)/1e3?chrome.storage.local.set({uuid:-1},()=>{}):chrome.storage.local.set({uuid:a.value},()=>{}),chrome.storage.local.get(["uuid","p_uuid"],(a)=>{-1===a.uuid&&a.uuid!==a.p_uuid&&(console.log("Session info does not exist, liver stream info listener cleared."),chrome.alarms.getAll((a)=>{for(let b of a)console.log(`alarm ${b.name} found`),"checkUpd"!==b.name&&chrome.alarms.clear(b.name).then((a)=>{console.log(`${b.name} was cleared ${a}`)})})),-1!==a.uuid&&a.uuid!==a.p_uuid&&(console.log("Session info got."),chrome.alarms.create("getNewVideos",{when:Date.now(),periodInMinutes:0.2}),chrome.alarms.create("getNewUnreads",{when:Date.now()+1e3,periodInMinutes:0.2}),chrome.alarms.create("getNewDynamics",{when:Date.now()+2e3,periodInMinutes:0.2}),scheduleCheckIn(3e3)),chrome.storage.local.set({p_uuid:a.uuid},()=>{})})}),chrome.cookies.get({url:"https://www.bilibili.com/",name:"bili_jct"},function(a){null===a?chrome.storage.local.set({jct:-1},()=>{}):chrome.storage.local.set({jct:a.value},()=>{})})}chrome.alarms.onAlarm.addListener((a)=>{"getUID_CSRF"===a.name&&reloadCookies(),"checkUpd"===a.name&&checkUpdate("https://tyrael-lee.gitee.io/harukaemoji/?_="),chrome.storage.local.get(["uuid","jct","dakaUid"],(b)=>{switch(a.name){case"getNewVideos":videoNotify(b.uuid);break;case"getNewUnreads":getNewUnread();break;case"getNewDynamics":dynamicNotify();break;case"checkIn":checkingIn();break;case"daka":checkMedalDaka();break;case"bcoin":queryBcoin();break;case"dakaRoom":daka(b.dakaUid,b.jct,"\u6253\u5361");}})});function checkingIn(){chrome.storage.sync.get(["checkIn"],(a)=>{a.checkIn&&fetch("https://api.live.bilibili.com/xlive/web-ucenter/v1/sign/DoSign",{method:"GET",credentials:"include",body:null}).then(()=>{console.log("\u7B7E\u5230\u6210\u529F "+new Date().toUTCString())}).catch((a)=>{errorHandler("checkIn",a,"checkIn()")})})}function errorHandler(a,b,c){console.log("ERROR found @ "+new Date+":"),console.log(`${b} at function ${c}`);let d=0.2;d=a.includes("checkIn")||a.includes("bcoin")?720:a.includes("daka")?360:0.2,a.includes("Dynamic")?chrome.storage.local.set({dynamicInit:!0},()=>{}):a.includes("Video")?chrome.storage.local.set({videoInit:!0},()=>{}):a.includes("Unread")&&chrome.storage.local.set({unreadInit:!0},()=>{}),"undefined"!=typeof b.responseJSON&&-412===b.responseJSON.code||-412==b?chrome.alarms.clear(a).then(()=>{chrome.alarms.create(a,{when:Date.now()+1.5e6,periodInMinutes:d})}):chrome.alarms.clear(a).then(()=>{chrome.alarms.create(a,{when:Date.now()+2e4,periodInMinutes:d})})}function exchangeBCoin(a){let b=new FormData;b.append("type","1"),b.append("csrf",a),fetch("https://api.bilibili.com/x/vip/privilege/receive?requestFrom=rua5",{method:"POST",credentials:"include",body:b}).then((a)=>a.json()).then(()=>{console.log("\u5151\u6362\u6210\u529F\uFF01\u597D\u8036( \u2022\u0300 \u03C9 \u2022\u0301 )\u2727"),chrome.notifications.create(Math.random()+"",{type:"basic",iconUrl:"./images/abaaba.png",title:"\u672C\u6708\u5927\u4F1A\u5458\u76845B\u5E01\u5151\u6362\u6210\u529F\uFF01",message:""},function(a){setTimeout(function(){chrome.notifications.clear(a)},3e3)})}).catch((a)=>{errorHandler("bcoin",a,"exchangeBCoin()")})}function queryBcoin(){chrome.storage.sync.get(["bcoin"],(a)=>{a.bcoin&&fetch("https://api.bilibili.com/x/vip/privilege/my",{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((a)=>{console.log("checked vip status"),0===a.code&&(1===a.data.list[0].type&&0===a.data.list[0].state?chrome.storage.local.get(["jct"],(a)=>{exchangeBCoin(a.jct)}):1===a.data.list[0].type&&1===a.data.list[0].state&&console.log("\u8FD9\u4E2A\u6708\u7684\u5DF2\u7ECF\u5151\u6362\u8FC7\u4E86\uFF0C\u597D\u8036\uFF01( \u2022\u0300 \u03C9 \u2022\u0301 )\u2727"))}).catch((a)=>{errorHandler("bcoin",a,"queryBcoin()")})})}function videoNotify(a){chrome.storage.local.get(["dynamic_id_list","videoInit"],(b)=>{let d=b.dynamic_id_list;fetch("https://api.vc.bilibili.com/dynamic_svr/v1/dynamic_svr/dynamic_new?type_list=8,512,4097,4098,4099,4100,4101",{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((c)=>{chrome.storage.sync.get(["dynamicPush"],(e)=>{if(0!==c.code)errorHandler("getNewVideos",c.code,"videoNotify()");else if(0===c.code){if("undefined"!=typeof c.data&&0!==c.data.length){let b=c.data.attentions.uids;b.splice(c.data.attentions.uids.indexOf(a-1+1),1),console.log(`Load following list complete. ${b.length} followings found.`),queryLivingRoom(b)}if(e.dynamicPush){let a=c.data.cards;for(let e=0;e<a.length;e++){let f=JSON.parse(a[e+""].card),c=a[e+""].desc.type;b.videoInit||d.includes(a[e+""].desc.dynamic_id)||(8===c?(console.log("\u4F60\u5173\u6CE8\u7684up "+a[e+""].desc.user_profile.info.uname+" \u6295\u7A3F\u4E86\u65B0\u89C6\u9891\uFF01"+f.title+" see:"+a[e+""].desc.bvid),basicNotification(a[e+""].desc.dynamic_id,"\u4F60\u5173\u6CE8\u7684up "+a[e+""].desc.user_profile.info.uname+" \u6295\u7A3F\u4E86\u65B0\u89C6\u9891\uFF01",f.title,a[e+""].desc.bvid,a[e+""].desc.user_profile.info.face,"b23.tv/")):512<=c&&4101>=c&&(console.log("\u4F60\u5173\u6CE8\u7684\u756A\u5267 "+f.apiSeasonInfo.title+" \u66F4\u65B0\u4E86\uFF01"+f.index+" see:"+f.url),basicNotification(a[e+""].desc.dynamic_id,"\u4F60\u5173\u6CE8\u7684\u756A\u5267 "+f.apiSeasonInfo.title+" \u66F4\u65B0\u4E86\uFF01",f.new_desc,f.url.replace("https://www.bilibili.com/",""),f.cover,"www.bilibili.com/"))),d.push(a[e+""].desc.dynamic_id),30<d.length&&d.splice(0,1)}chrome.storage.local.set({dynamic_id_list:d},()=>{})}}chrome.storage.local.set({videoInit:!1},()=>{})})}).catch((a)=>{errorHandler("getNewVideos",a,"videoNotify()")})})}function dynamicNotify(){chrome.storage.local.get(["dynamicList","dynamicInit"],(a)=>{let b=a.dynamicList;fetch(`https://api.vc.bilibili.com/dynamic_svr/v1/dynamic_svr/dynamic_new?type_list=1,2,4`,{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((c)=>{0===c.code?chrome.storage.sync.get(["dynamicSwitch"],(d)=>{let e=c.data.cards;for(let f=0;f<e.length;f++){let g=JSON.parse(e[f+""].card),c=e[f+""].desc.type;b.includes(e[f+""].desc.dynamic_id)||(!a.dynamicInit&&d.dynamicSwitch&&(1===c?(console.log("\u4F60\u5173\u6CE8\u7684up "+g.user.uname+" \u8F6C\u53D1\u4E86\u4E00\u6761\u65B0\u52A8\u6001 "+g.item.content+" see:"+`https://t.bilibili.com/${e[f+""].desc.dynamic_id_str}`),basicNotification(e[f+""].desc.dynamic_id,`你关注的up ${g.user.uname} 转发了一条动态`,g.item.content+"",e[f+""].desc.dynamic_id_str,g.user.face,"t.bilibili.com/")):2===c?(console.log("\u4F60\u5173\u6CE8\u7684up "+g.user.name+" \u53D1\u4E86\u4E00\u6761\u65B0\u52A8\u6001 "+g.item.description+" see: "+`https://t.bilibili.com/${e[f+""].desc.dynamic_id_str}`),basicNotification(e[f+""].desc.dynamic_id,`你关注的up ${g.user.name} 发了一条图片动态`,g.item.description+"",e[f+""].desc.dynamic_id_str,g.user.head_url,"t.bilibili.com/")):4===c?(console.log("\u4F60\u5173\u6CE8\u7684up "+g.user.uname+" \u53D1\u4E86\u4E00\u6761\u65B0\u52A8\u6001 "+g.item.content+" see: "+`https://t.bilibili.com/${e[f+""].desc.dynamic_id_str}`),basicNotification(e[f+""].desc.dynamic_id,`你关注的up ${g.user.uname} 发了一条新动态`,g.item.content+"",e[f+""].desc.dynamic_id_str,g.user.face,"t.bilibili.com/")):void 0),b.push(e[f+""].desc.dynamic_id),40<b.length&&b.splice(0,1))}chrome.storage.local.set({dynamicList:b},()=>{})}):errorHandler("getNewDynamics",c.code,"dynamicNotify()"),chrome.storage.local.set({dynamicInit:!1},()=>{})}).catch((a)=>{errorHandler("getNewDynamics",a,"dynamicNotify()")})})}function getNewUnread(){chrome.storage.local.get(["unreadData","unreadInit","unreadMessage"],async(a)=>{let b=JSON.parse(a.unreadData);await fetch("https://api.bilibili.com/x/msgfeed/unread",{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((c)=>{0===c.code?chrome.storage.sync.get(["unreadSwitch"],(d)=>{if(d.unreadSwitch){if(!a.unreadInit&&(0<c.data.at-b.at||0<c.data.like-b.like||0<c.data.reply-b.reply||0<c.data.sys_msg-b.sys_msg||0<c.data.up-b.up)){let a=`${0<c.data.at-b.at?c.data.at-b.at+"\u4E2A@, ":""}${0<c.data.like-b.like?c.data.like-b.like+"\u4E2A\u8D5E, ":""}${0<c.data.reply-b.reply?c.data.reply-b.reply+"\u4E2A\u56DE\u590D, ":""}${0<c.data.sys_msg-b.sys_msg?c.data.sys_msg-b.sys_msg+"\u4E2A\u7CFB\u7EDF\u901A\u77E5, ":""}${0<c.data.up-b.up?c.data.up-b.up+"\u4E2Aup\u52A9\u624B\u63D0\u9192, ":""}`;chrome.notifications.clear("-276492:reply:message.bilibili.com/#/"),basicNotification(-276492,"\u4F60\u6536\u5230\u4E86\u65B0\u7684\u6D88\u606F:",a.substring(0,a.length-2),`reply`,"",`message.bilibili.com/#/`)}b=c.data,chrome.storage.local.set({unreadData:JSON.stringify(b)},()=>{})}}):errorHandler("getNewUnreads",c.code,"getUnread()")}).catch((a)=>{errorHandler("getNewUnreads",a,"getUnread()")}),await fetch("https://api.vc.bilibili.com/session_svr/v1/session_svr/single_unread",{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((b)=>{0===b.code?chrome.storage.sync.get(["unreadSwitch"],(c)=>{c.unreadSwitch&&!a.unreadInit&&0<b.data.biz_msg_follow_unread+b.data.biz_msg_unfollow_unread+b.data.dustbin_push_msg+b.data.dustbin_unread+b.data.follow_unread+b.data.unfollow_push_msg+b.data.unfollow_unread-a.unreadMessage&&(chrome.notifications.clear("-276491:reply:message.bilibili.com/#/"),basicNotification(-276491,`你收到了${b.data.biz_msg_follow_unread+b.data.biz_msg_unfollow_unread+b.data.dustbin_push_msg+b.data.dustbin_unread+b.data.follow_unread+b.data.unfollow_push_msg+b.data.unfollow_unread-a.unreadMessage}条新私信`,"",`reply`,"",`message.bilibili.com/#/`)),chrome.storage.local.set({unreadMessage:b.data.biz_msg_follow_unread+b.data.biz_msg_unfollow_unread+b.data.dustbin_push_msg+b.data.dustbin_unread+b.data.follow_unread+b.data.unfollow_push_msg+b.data.unfollow_unread},()=>{})}):errorHandler("getUnread","getUnread()")}).catch((a)=>{errorHandler("getUnread",a,"getUnread()")}),chrome.storage.local.set({unreadInit:!1},()=>{})})}function checkMedalDaka(){chrome.storage.sync.get(["daka"],(a)=>{console.log("Grabbing medal info"),chrome.storage.local.get(["rua_lastDK","uuid","dakaUid"],(b)=>{if(a.daka&&(null===b.rua_lastDK||isNewerThan(b.rua_lastDK.split("-"),(getUTC8Time().getFullYear()+"-"+getUTC8Time().getMonth()+"-"+getUTC8Time().getDate()).split("-")))){let a=[];chrome.storage.local.set({rua_lastDK:getUTC8Time().getFullYear()+"-"+getUTC8Time().getMonth()+"-"+getUTC8Time().getDate()},()=>{}),fetch("https://api.live.bilibili.com/xlive/web-ucenter/user/MedalWall?target_id="+b.uuid,{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((c)=>{console.log(c.data.list.length+" medal founded."),console.log(b.dakaUid);for(let d=0;d<c.data.list.length;d++)-1===b.dakaUid.indexOf(c.data.list[d].medal_info.target_id)&&100>c.data.list[d].medal_info.today_feed&&a.push(c.data.list[d].medal_info.target_id);chrome.storage.local.set({dakaUid:a},()=>{chrome.alarms.create("dakaRoom",{when:Date.now(),periodInMinutes:0.1})})}).catch((a)=>{chrome.storage.local.set({rua_lastDK:"1970-01-01"},()=>{}),errorHandler("daka",a,"checkMedalDaka()")})}else console.log("No more grab needed.")})})}function daka(a,b,c){0===a.length?chrome.alarms.clear("dakaRoom",()=>{}):(console.log(a),fetch("https://api.live.bilibili.com/live_user/v1/Master/info?uid="+a[0],{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((d)=>{if(0===d.code||0<d.data.length){let e=new FormData;e.append("bubble","0"),e.append("msg",c),e.append("color","16777215"),e.append("mode","1"),e.append("fontsize","25"),e.append("rnd",Math.round(Date.now()/1e3)+""),e.append("roomid",d.data.room_id),e.append("csrf",b),e.append("csrf_token",b),fetch("https://api.live.bilibili.com/msg/send?requestFrom=rua5",{method:"POST",credentials:"include",body:e}).then(()=>{console.log("\u6253\u5361\u6210\u529F: https://live.bilibili.com/"+d.data.room_id);let b=a;b.splice(0,1),chrome.storage.local.set({dakaUid:b},()=>{})}).catch((a)=>{console.error("Error:",a)})}}))}async function legalVideoLink(a){let b="AaBb";return b.includes(a.charAt(0))&&"Vv".includes(a.charAt(1))&&(b.substr(0,2).includes(a.charAt(0))?await findVideo("aid="+a.substr(2,a.length-1)):await findVideo("bvid="+a))}function findVideo(a){return fetch("https://api.bilibili.com/x/web-interface/view?"+a,{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((a)=>0===a.code)}function checkUpdate(a){console.log("checking update at "+new URL(a).hostname);let b=chrome.runtime.getManifest().version.split(".");fetch(a+new Date().getTime(),{method:"GET",credentials:"omit",body:null}).then((a)=>a.text()).then((c)=>{null!==c&&null!==/<meta name="current-version" content="(.*?)">/m.exec(c)&&b!==/<meta name="current-version" content="(.*?)">/m.exec(c)[1]&&(b=/<meta name="current-version" content="(.*?)">/m.exec(c)[1].split("."),b[0]-0>chrome.runtime.getManifest().version.split(".")[0]-0||b[0]-0>=chrome.runtime.getManifest().version.split(".")[0]-0&&b[1]-0>chrome.runtime.getManifest().version.split(".")[1]-0?(console.log(`A newer version found: ${b[0]}.${b[1]}`),chrome.storage.local.set({updateAvailable:!0},()=>{}),chrome.storage.local.set({availableBranch:new URL(a).hostname.includes("github")?"https://github.com/TyraelDLee/HarukaEmoji/releases/latest":"https://gitee.com/tyrael-lee/HarukaEmoji/releases"},()=>{}),setBadge("rua\u8C79\u5668 \u6709\u66F4\u65B0\u53EF\u7528","1")):(console.log("Current version is latest."),chrome.storage.local.set({updateAvailable:!1},()=>{}),setBadge("rua\u8C79\u5668","")))}).catch((b)=>{console.log(b),checkUpdate(a.includes("github")?"https://tyrael-lee.gitee.io/harukaemoji/?_=":"https://tyraeldlee.github.io/HarukaEmoji/?_=")})}function isNewerThan(a,b){return!!(parseInt(a[0])<parseInt(b[0]))||!(parseInt(a[0])>parseInt(b[0]))&&(!!(parseInt(a[1])<parseInt(b[1]))||!(parseInt(a[1])>parseInt(b[1]))&&parseInt(a[2])<parseInt(b[2]))}function getUTC8Time(){return new Date(new Date().getTime()+6e4*new Date().getTimezoneOffset())}function setBadge(a,b){chrome.action.setTitle({title:a}),chrome.action.setBadgeText({text:b})}