importScripts("./crypto-js.min.js");class WindowIDList{static convertFromJSON(e){let t=new WindowIDList;return t.list=e.id,t}constructor(){this.list=[]}push(e){this.remove(e),this.list.push(e)}remove(e){-1<this.list.indexOf(e)&&this.list.splice(this.list.indexOf(e),1)}getCurrent(){return 0<this.list.length?this.list[this.list.length-1]:-1}length(){return this.list.length}toJSONObject(){return{id:this.list}}}class DanmakuObj{constructor(e,t,i,a,n,s,d,o){this.time=e,this.mid=t,this.content=i,this.name=[],this.look=!0,this.color=a,this.mode=n,this.fontsize=s,this.ts=d,this.weight=o}setName(e){this.name=e}}class DanmakuArr{constructor(){this.list=[],this.size=0,this.displaySize=this.size}push(e){this.list.push(e),this.size++}concat(e){this.list=this.list.concat(e.list),this.size+=e.size}get(e){return this.list[e]}max(){let e=0;for(let t=0;t<this.list.length;t++)e<this.list[t].time&&(e=this.list[t].time);return e}min(){let e=Number.MAX_VALUE;for(let t=0;t<this.list.length;t++)e>this.list[t].time&&(e=this.list[t].time);return e}sort(e){function t(e,a,i){const n=e[a];e[a]=e[i],e[i]=n}const i=this.max(),a=this.min(),n=[],s=Math.floor((i-a)/e)+1;for(let a=0;a<this.size;a++){const e=~~(this.list[a].ts/s);n[e]||(n[e]=[]),n[e].push(this.list[a]);for(let i=n[e].length;0<i;)void 0!==n[e][i]&&n[e][i].ts<n[e][i-1].ts&&t(n[e],i,i-1),i--}let d=[];for(let t=0;t<n.length;t++)n[t]&&(d=d.concat(n[t]));this.list=d}find(e){function t(e){return e.replaceAll(",","\uFF0C").replaceAll(".","\u3002").replaceAll("?","\uFF1F").replaceAll("!","\uFF01").replaceAll(";","\uFF1B").replaceAll(":","\uFF1A").replaceAll("\u201C","\"").replaceAll("\u201D","\"").replaceAll("(","\uFF08").replaceAll(")","\uFF09")}let a=new DanmakuArr;if(e=t(e),""===e)return this;for(let n=0;n<this.size;n++)t(this.list[n].content).includes(e)&&a.push(this.list[n]);return a}}class NotificationList{constructor(){this.map=new Map}add(e){this.map.has(e+"")||this.map.set(e+"",0)}update(e,t){this.map.set(e+"",t)}getState(e){return this.map.get(e+"")}loadFromStorage(e){const t=JSON.parse(e);this.map=new Map(Object.entries(t))}stringify(){const e=Object.fromEntries(this.map);return JSON.stringify(e)}}class CRC32{static initCrc32Table(e){for(let t,a=0;256>a;a++){t=a;for(let e=0;8>e;e++)1&t?t=3988292384^t>>>1:t>>>=1;e[a]=t}}constructor(){this.crc32Table=new Uint32Array(256),CRC32.initCrc32Table(this.crc32Table),this.rainbowTableHash=new Uint32Array(1e5),this.rainbowTableValue=new Uint32Array(1e5);let e=new Uint32Array(1e5),t=new Uint32Array(65537);for(let a,n=0;1e5>n;n++)a=this.compute(n)>>>0,e[n]=a,t[a>>>16]++;let i=0;this.shortHashBucketStarts=t.map(e=>i+=e);for(let t,a=0;1e5>a;a++)t=--this.shortHashBucketStarts[e[a]>>>16],this.rainbowTableHash[t]=e[a],this.rainbowTableValue[t]=a}compute(e,t=!1){let a=0;for(let i of e.toString())a=this.crc32Update(a,+i);if(t)for(let e=0;5>e;e++)a=this.crc32Update(a,0);return a}crack(e){var t=Math.pow;let i=[],a=~+("0x"+e)>>>0,n=4294967295;for(let s=1;10>s;s++)if(n=this.crc32Update(n,48),6>s)i=i.concat(this.lookup(a^n));else{let e=t(10,s-6),d=t(10,s-5);for(let t=e;t<d;t++)for(let e of this.lookup(a^n^this.compute(t,!0)))i.push(1e5*t+e)}return i}crc32Update(e,t){return e>>>8^this.crc32Table[255&(e^t)]}lookup(e){e>>>=0;let t=[],a=e>>>16;for(let n=this.shortHashBucketStarts[a];n<this.shortHashBucketStarts[a+1];n++)this.rainbowTableHash[n]===e&&t.push(this.rainbowTableValue[n]);return t}}chrome.action.setBadgeBackgroundColor({color:"#00A0FF"}),chrome.windows.getAll(function(e){let t=new WindowIDList;for(let a=0;a<e.length;a++)t.push(e[a].id);chrome.storage.local.set({winIDList:t.toJSONObject()},()=>{})}),chrome.windows.onCreated.addListener(function(e){chrome.storage.local.get(["winIDList"],t=>{let i=WindowIDList.convertFromJSON(t.winIDList);i.push(e.id),chrome.storage.local.set({winIDList:i.toJSONObject()},()=>{})})}),chrome.windows.onRemoved.addListener(function(e){chrome.storage.local.get(["winIDList"],t=>{let i=WindowIDList.convertFromJSON(t.winIDList);i.remove(e),chrome.storage.local.set({winIDList:i.toJSONObject()},()=>{})})}),chrome.windows.onFocusChanged.addListener(function(e){-1!==e&&chrome.storage.local.get(["winIDList"],t=>{let i=WindowIDList.convertFromJSON(t.winIDList);i.push(e),chrome.storage.local.set({winIDList:i.toJSONObject()},()=>{})})}),chrome.runtime.onInstalled.addListener(initialize);async function initialize(e){await chrome.alarms.clearAll(),chrome.notifications.getAll(e=>{for(let t in e)chrome.notifications.clear(t)}),await chrome.tabs.create({url:"./readme.html"}),await chrome.storage.local.get(["rua_lastDK"],e=>{console.log(e.rua_lastDK),(null===e.rua_lastDK||e.rua_lastDK===void 0)&&chrome.storage.local.set({rua_lastDK:"1970-01-01"},()=>{})}),await chrome.storage.local.set({imageNotice:!1},function(){}),setInitValue("notification",!0),setInitValue("medal",!0),setInitValue("checkIn",!0),setInitValue("bcoin",!0),setInitValue("qn",!0),setInitValue("qnvalue","\u539F\u753B"),setInitValue("dynamicPush",!0),setInitValue("videoPush",!0),setInitValue("pgcPush",!0),setInitValue("articlePush",!0),setInitValue("hiddenEntry",!1),setInitValue("daka",!0),setInitValue("record",!1),setInitValue("prerecord",300),setInitValue("enhancedHiddenEntry",!1),setInitValue("unreadSwitch",!0),setInitValue("dynamicSwitch",!0),setInitValue("blackListLive",[]),setInitValue("blackListDynamic",[]),setInitValue("blackListVideo",[]),setInitValue("blackListDK",[]),setInitValue("blackListHB",[]),setInitValue("darkMode",!1),setInitValue("darkModeSystem",!1),setInitValue("commentEmoji",!0),setInitValue("heartBeatSwitch",!0),setInitValue("squareCover",!0),setInitValue("liveroom-medal-switch",0),setInitValue("liveroom-reconnection-time",10),setInitValue("liveroom-heart-beat",!0),setInitValue("liveroom-quality",1e4),setInitValue("liveroom-auto-frame-chasing",0),setInitValue("dkWord",""),setInitValue("hiddenOnVideoBtn",!1),setInitValue("notificationMaster",!0),setInitValue("liveRoomList",[]),e&&"boolean"==typeof e||chrome.contextMenus.create({contexts:["selection","link"],title:"\u7528bilibili\u641C\u7D22",type:"normal",id:"rua-contextMenu-v3"}),chrome.alarms.create("checkUpd",{when:Date.now(),periodInMinutes:720}),await chrome.storage.local.set({uuid:-1,jct:-1,p_uuid:-1,updateAvailable:!1,availableBranch:"https://gitee.com/tyrael-lee/HarukaEmoji/releases",downloadFileName:"",video_id_list:[],pgc_id_list:[],article_id_list:[],unreadData:"{\"at\":0,\"chat\":0,\"like\":0,\"reply\":0,\"sys_msg\":0,\"up\":0}",unreadMessage:0,dynamicList:[],notificationList:"",videoInit:!0,dynamicInit:!0,unreadInit:!0,dakaUid:[],watchingList:{},heartRhythm:[],medalList:[],liveroomOn:[-1,-1],tempRoomNumber:-1,windowSize:[0,0]},()=>{}),chrome.alarms.create("getUID_CSRF",{when:Date.now(),periodInMinutes:.3}),chrome.alarms.create("heartRate",{when:Date.now()+60000,periodInMinutes:1}),chrome.alarms.create("refreshHB",{when:Date.now()+3600000,periodInMinutes:60})}function getNextDay(){let e=new Date;return e.setDate(e.getDate()+1),e.setUTCHours(0,0,0,0),e.getTime()-288e5}function setInitValue(e,t){chrome.storage.sync.get([e],function(i){(null===i[e]||i[e]===void 0)&&chrome.storage.sync.set({[e]:t},function(){})})}chrome.contextMenus.onClicked.addListener(e=>{"rua-contextMenu-v3"===e.menuItemId&&legalVideoLink(e.selectionText).then(t=>{t?chrome.tabs.create({url:"https://www.bilibili.com/video/"+e.selectionText}):chrome.tabs.create({url:"https://search.bilibili.com/all?keyword="+e.selectionText})})}),chrome.storage.onChanged.addListener(function(e){for(let[t,{oldValue:i,newValue:a}]of Object.entries(e))"checkIn"===t&&a&&checkingIn(),"bcoin"===t&&a&&queryBcoin(),"hiddenEntry"===t&&(a?chrome.declarativeNetRequest.updateEnabledRulesets({enableRulesetIds:["redirect"]},()=>{}):chrome.declarativeNetRequest.updateEnabledRulesets({disableRulesetIds:["redirect"]},()=>{})),"enhancedHiddenEntry"===t&&(a?chrome.declarativeNetRequest.updateEnabledRulesets({enableRulesetIds:["cookieOmit"]},()=>{}):chrome.declarativeNetRequest.updateEnabledRulesets({disableRulesetIds:["cookieOmit"]},()=>{})),"daka"===t&&a&&checkMedalDaka()}),chrome.runtime.onMessage.addListener(function(e,t,i){if("get_LoginInfo"===e.msg&&chrome.cookies.get({url:"https://www.bilibili.com/",name:"bili_jct"},function(e){null===e?chrome.storage.local.set({jct:-1},()=>{}):chrome.storage.local.set({jct:e.value},()=>{}),chrome.storage.local.get(["jct","uuid"],e=>{i({res:e.jct+","+e.uuid+","+e.uuid})})}),"get_LIVE_BUVID"===e.msg&&chrome.cookies.get({url:"https://live.bilibili.com/",name:"LIVE_BUVID"},function(e){null===e?chrome.storage.local.set({buvid:-1},()=>{}):chrome.storage.local.set({buvid:e.value},()=>{}),i({res:e})}),"get_UUID"===e.msg&&chrome.storage.local.get(["uuid"],e=>{i({res:e.uuid})}),"get_LoginStatus"===e.msg&&chrome.cookies.get({url:"https://www.bilibili.com/",name:"DedeUserID"},e=>{null===e||void 0===e?i({login:!1,vip:0}):fetch(`https://api.bilibili.com/x/space/acc/info?mid=${e.value}`,{method:"GET",credentials:"include",body:null}).then(e=>e.json()).then(e=>{0===e.code&&null!==e.data?i({login:!0,vip:e.data.vip.type}):i({login:!0,vip:1})}).catch(()=>{i({login:!0,vip:1})})}),"updateStatus"===e.msg&&chrome.storage.local.get(["updateAvailable","availableBranch"],e=>{i({res:e.updateAvailable,address:e.availableBranch})}),"popupfired"===e.msg&&(setBadge("rua\u8C79\u5668",""),i({res:"ok"})),"requestDownload"===e.msg&&(chrome.downloads.download({filename:e.fileName,url:e.url},()=>{}),i({res:"ok"})),"requestDanmaku"===e.msg){let t=new DanmakuArr;for(let a=0;a<e.danmakuObj.length;a++)void 0===e.danmakuObj[a].progress&&(e.danmakuObj[a].progress=0),t.push(new DanmakuObj(convertMSToS(e.danmakuObj[a].progress),e.danmakuObj[a].midHash,e.danmakuObj[a].content,e.danmakuObj[a].color,e.danmakuObj[a].mode,e.danmakuObj[a].fontsize,e.danmakuObj[a].progress,e.danmakuObj[a].weight));t.sort(t.size-1),i({danmakuContent:t,danmakuPoolSize:e.danmakuObj.length})}return"requestCrackUID"===e.msg&&i({response:new CRC32().crack(e.mid)}),"requestUserInfo"===e.msg&&fetch("https://api.bilibili.com/x/web-interface/card?mid="+e.mid+"&photo=true&requestFrom=rua5",{method:"GET",headers:{Accept:"application/json"},credentials:"include",body:null}).then(e=>e.json()).then(e=>{0===e.code&&null!==e.data&&i({response:e.data.card})}),"requestOSInfo"===e.msg&&chrome.runtime.getPlatformInfo(e=>{i({os:e.os})}),"requestReload"===e.msg&&initialize(!0).then(()=>{i({res:"ok"})}),e.msg.includes("QNV")&&(chrome.storage.sync.set({qnvalue:e.msg.split("?")[1]},function(){}),i({res:"ok"})),"launchLiveRoom"===e.msg&&(chrome.tabs.remove(t.tab.id).then(()=>{}),chrome.storage.local.get(["liveroomOn"],e=>{-1!==e.liveroomOn[0]&&-1!==e.liveroomOn[1]?(chrome.windows.update(e.liveroomOn[0],{focused:!0}),chrome.tabs.update(e.liveroomOn[1],{active:!0,highlighted:!0})):chrome.tabs.create({url:"./liveroom.html"})})),!0});function convertMSToS(e){var t=Math.floor;e/=1e3;let i=t(e%60),a=t(e/60%60),n=t(e/3600%60);return n=0===n?"":(10>n&&0<n?"0"+n:n)+":",a=10>a?"0"+a:a,i=10>i?"0"+i:i,n+a+":"+i}function getFollowingList(){chrome.storage.local.get(["uuid"],t=>{let e=new AbortController;setTimeout(()=>{e.abort("timeout")},3e3),fetch(`https://api.vc.bilibili.com/dynamic_mix/v1/dynamic_mix/at_list?uid=${t.uuid}`,{method:"GET",credentials:"include",signal:e.signal,body:null}).then(e=>e.json()).then(e=>{0===e.code&&chrome.storage.sync.get(["blackListLive","blackListHB"],t=>{let a=[];for(let n=0;n<e.data.groups.length;n++)for(let t=0;t<e.data.groups[""+n].items.length;t++)a.push(e.data.groups[""+n].items[t+""].uid);queryLivingRoom(a,t.blackListLive,t.blackListHB)})}).catch(t=>{errorHandler("getFollowing",t,"getFollowingList(); line 500")})})}function queryLivingRoom(e,t,i){let a=new AbortController;setTimeout(()=>{a.abort("timeout")},3e3),chrome.storage.local.get(["uuid","notificationList","watchingList","heartRhythm","buvid","medalList"],s=>{let d=s.notificationList,o=s.watchingList,l=s.heartRhythm,r=new NotificationList;""!==s.notificationList&&r.loadFromStorage(s.notificationList);for(const t of e)r.add(t);fetch("https://api.live.bilibili.com/room/v1/Room/get_status_info_by_uids?requestFrom=rua5",{method:"POST",credentials:"omit",signal:a.signal,body:"{\"uids\": ["+e+"]}"}).then(e=>e.json()).then(a=>{if(0===a.code){let d=a.data;"undefined"!=typeof d&&chrome.notifications.getAll(a=>{for(const n of e)if("undefined"!=typeof d[n]){if(1===r.getState(d[n].uid)&&1!==d[n].live_status)for(const e in a)"live.bilibili.com/"===e.split(":")[2]&&e.split(":")[0]===d[n].uid+""&&chrome.notifications.clear(e);1===r.getState(d[n].uid)||1!==d[n].live_status||t.includes(d[n].uid)||chrome.storage.sync.get(["notification"],e=>{e.notification&&(console.log(d[n].title+" "+d[n].uname+" "+new Date),pushNotificationChrome(d[n].title,d[n].uname,d[n].room_id,d[n].cover_from_user,1===d[n].broadcast_type?1:0,d[n].face,n))}),r.update(d[n].uid,d[n].live_status),1!==d[n].live_status||-1!==l.findIndex(t=>t.ruid===d[n].uid)||i.includes(d[n].uid)||l.push({id:[d[n].area_v2_parent_id,d[n].area_v2_id,0,d[n].room_id],device:[s.buvid,getUUID()],ruid:d[n].uid});let e=[];for(const t of s.medalList)for(let a=0;a<l.length;a++)20>t.medal_info.level&&t.medal_info.target_id===l[a].ruid&&t.medal_info.today_feed<t.medal_info.day_limit&&e.push(l[a]);l=[],l=e}chrome.storage.local.set({notificationList:r.stringify(),heartRhythm:l},()=>{})})}}).catch(e=>{errorHandler("getFollowing",e,"queryLivingRoom(); line 500")})})}function getUUID(){let e="";for(let t=0;36>t;t++){const i=Math.floor(16*Math.random());e+=8==t||13===t||18===t||23===t?"-":14===t?"4":19===t?(8|3&i).toString(16):i.toString(16)}return e}function pushNotificationChrome(e,t,i,a,n,s,d){try{let o=t+" \u5F00\u64AD\u5566!\r\n\u662F"+(0===n?"\u7535\u8111":"\u624B\u673A")+"\u76F4\u64AD\uFF01";chrome.storage.sync.get(["notificationMaster"],t=>{t.notificationMaster&&chrome.storage.local.get(["imageNotice"],t=>{t.imageNotice?imageNotification(d,e,o,i,a,s,"live.bilibili.com/"):basicNotification(d,e,o,i,s,"live.bilibili.com/")})})}catch(t){}}function basicNotification(e,t,i,a,n,s){chrome.storage.sync.get(["notificationMaster"],d=>{d.notificationMaster&&(n=null==n.length||0===n.length?"../images/haruka128.png":n,chrome.notifications.create(e+":"+a+":"+s,{type:"basic",iconUrl:n,title:t,message:i,contextMessage:"rua\u8C79\u5668"},function(){}))})}function imageNotification(e,t,i,a,n,s,d){s=null==s.length||0===s.length?"../images/haruka128.png":s,n=null==n.length||0===n.length?s:n,chrome.notifications.create(e+":"+a+":"+d,{type:"image",iconUrl:s,title:t,message:i,imageUrl:n,contextMessage:"rua\u8C79\u5668"},function(){})}chrome.notifications.onClicked.addListener(function(e){chrome.storage.local.get(["winIDList"],t=>{let i=WindowIDList.convertFromJSON(t.winIDList);chrome.windows.getAll(function(t){0<t.length?(chrome.windows.update(i.getCurrent(),{focused:!0}),chrome.tabs.create({url:`https://${e.split(":")[2]}${e.split(":")[1]}`})):chrome.storage.local.get(["windowSize"],t=>{0===t[0]||0===t[1]?chrome.windows.create({url:`https://${e.split(":")[2]}${e.split(":")[1]}`}):chrome.windows.create({url:`https://${e.split(":")[2]}${e.split(":")[1]}`,width:t[0],height:t[1]})})})}),chrome.notifications.clear(e)});function scheduleCheckIn(e){chrome.alarms.create("checkIn",{when:Date.now()+e,periodInMinutes:720}),chrome.alarms.create("bcoin",{when:Date.now()+1e3+e,periodInMinutes:720}),chrome.alarms.create("daka",{when:Date.now()+2e3+e,periodInMinutes:360})}function reloadCookies(){chrome.cookies.get({url:"https://www.bilibili.com/",name:"DedeUserID"},function(e){null===e||null===e.expirationDate||e.expirationDate<Date.parse(new Date)/1e3?chrome.storage.local.set({uuid:-1},()=>{}):chrome.storage.local.set({uuid:e.value},()=>{}),chrome.storage.local.get(["uuid","p_uuid"],e=>{-1===e.uuid&&e.uuid!==e.p_uuid&&(console.log("Session info does not exist, liver stream info listener cleared."),chrome.alarms.getAll(e=>{for(let t of e)console.log(`alarm ${t.name} found`),"checkUpd"!==t.name&&"getUID_CSRF"!==t.name&&chrome.alarms.clear(t.name).then(e=>{console.log(`${t.name} was cleared ${e}`)})})),-1!==e.uuid&&e.uuid!==e.p_uuid&&(console.log("Session info got."),refreshHeartBeatList(),chrome.alarms.create("getNewVideos",{when:Date.now(),periodInMinutes:.5}),chrome.alarms.create("getFollowing",{when:Date.now(),periodInMinutes:.2}),chrome.alarms.create("getNewUnreads",{when:Date.now()+5e3,periodInMinutes:.2}),chrome.alarms.create("getNewDynamics",{when:Date.now()+11e3,periodInMinutes:.33}),scheduleCheckIn(3e3)),chrome.storage.local.set({p_uuid:e.uuid},()=>{})})}),chrome.cookies.get({url:"https://www.bilibili.com/",name:"bili_jct"},function(e){null===e?chrome.storage.local.set({jct:-1},()=>{}):chrome.storage.local.set({jct:e.value},()=>{})}),chrome.cookies.get({url:"https://live.bilibili.com/",name:"LIVE_BUVID"},function(e){null===e?chrome.storage.local.set({buvid:-1},()=>{}):chrome.storage.local.set({buvid:e.value},()=>{})})}chrome.alarms.onAlarm.addListener(e=>{"getUID_CSRF"===e.name&&reloadCookies(),"checkUpd"===e.name&&checkUpdate("https://tyrael-lee.gitee.io/harukaemoji/?_="),chrome.storage.local.get(["uuid","jct","dakaUid"],t=>{switch(e.name){case"getFollowing":getFollowingList();break;case"getNewVideos":videoNotify(t.uuid);break;case"getNewUnreads":getNewUnread();break;case"getNewDynamics":dynamicNotify();break;case"checkIn":checkingIn();break;case"daka":checkMedalDaka();break;case"bcoin":queryBcoin();break;case"dakaRoom":chrome.storage.sync.get(["dkWord"],e=>{daka(t.dakaUid,t.jct,""===e.dkWord?"\u6253\u5361":e.dkWord)});break;case"heartRate":chrome.storage.sync.get(["heartBeatSwitch"],e=>{e.heartBeatSwitch&&heartBeat()});break;case"refreshHB":refreshHeartBeatList();break;case"refreshHBRetry":refreshHeartBeatList()}})});function checkingIn(){chrome.storage.sync.get(["checkIn"],e=>{e.checkIn&&fetch("https://api.live.bilibili.com/xlive/web-ucenter/v1/sign/DoSign",{method:"GET",credentials:"include",body:null}).then(()=>{console.log("\u7B7E\u5230\u6210\u529F "+new Date().toUTCString())}).catch(e=>{errorHandler("checkIn",e,"checkIn(); line 673")})})}function errorHandler(e,t,i){console.log("ERROR found @ "+new Date+":"),console.log(`${t} at function ${i}`);let a=.2;a=e.includes("checkIn")||e.includes("bcoin")?720:e.includes("daka")?360:.2,e.includes("Dynamic")?chrome.storage.local.set({dynamicInit:!0},()=>{}):e.includes("Video")?chrome.storage.local.set({videoInit:!0},()=>{}):e.includes("Unread")&&chrome.storage.local.set({unreadInit:!0},()=>{}),"undefined"!=typeof t.responseJSON&&-412===t.responseJSON.code||-412==t?chrome.alarms.clear(e).then(()=>{chrome.alarms.create(e,{when:Date.now()+15e5,periodInMinutes:a})}):!(t+"").includes("AbortError: The user aborted a request")&&chrome.alarms.clear(e).then(()=>{chrome.alarms.create(e,{when:Date.now()+2e4,periodInMinutes:a})})}function exchangeBCoin(e){let t=new FormData;t.append("type","1"),t.append("csrf",e),fetch("https://api.bilibili.com/x/vip/privilege/receive?requestFrom=rua5",{method:"POST",credentials:"include",body:t}).then(e=>e.json()).then(e=>{switch(e.code){case 0:console.log("\u5151\u6362\u6210\u529F\uFF01\u597D\u8036( \u2022\u0300 \u03C9 \u2022\u0301 )\u2727"),chrome.notifications.create(Math.random()+"",{type:"basic",iconUrl:"./images/abaaba.png",title:"\u672C\u6708\u5927\u4F1A\u5458\u76845B\u5E01\u5151\u6362\u6210\u529F\uFF01",message:""},function(e){setTimeout(function(){chrome.notifications.clear(e)},3e3)});break;case 69155:console.log("\u5F53\u524D\u975E\u5927\u4F1A\u5458");break;default:console.log("\u5151\u6362\u5931\u8D25\uFF0C\u4F4D\u7F6E\u9519\u8BEF")}}).catch(e=>{errorHandler("bcoin",e,"exchangeBCoin(); line 742")})}function queryBcoin(){chrome.storage.sync.get(["bcoin"],e=>{e.bcoin&&fetch("https://api.bilibili.com/x/vip/privilege/my",{method:"GET",credentials:"include",body:null}).then(e=>e.json()).then(e=>{console.log("checked vip status"),0===e.code&&(1===e.data.list[0].type&&0===e.data.list[0].state?chrome.storage.local.get(["jct"],e=>{exchangeBCoin(e.jct)}):1===e.data.list[0].type&&1===e.data.list[0].state&&console.log("\u8FD9\u4E2A\u6708\u7684\u5DF2\u7ECF\u5151\u6362\u8FC7\u4E86\uFF0C\u597D\u8036\uFF01( \u2022\u0300 \u03C9 \u2022\u0301 )\u2727"))}).catch(e=>{errorHandler("bcoin",e,"queryBcoin(); line 765")})})}function getNewPost(e){let t=new AbortController;return setTimeout(()=>{t.abort("timeout")},3e3),new Promise((i,a)=>{chrome.storage.local.get(["video_id_list","pgc_id_list","article_id_list","videoInit"],n=>{let s="video"===e?n.video_id_list:"pgc"===e?n.pgc_id_list:n.article_id_list;fetch(`https://api.bilibili.com/x/polymer/web-dynamic/v1/feed/all?page=1&type=${e}`,{method:"GET",credentials:"include",signal:t.signal,body:null}).then(e=>e.json()).then(t=>{chrome.storage.sync.get(["dynamicPush","blackListVideo","videoPush","pgcPush","articlePush"],d=>{if(0!==t.code)a(t.code);else if(0===t.code&&d.dynamicPush){let a=t.data.items;for(let t=0;t<a.length;t++){let i=a[t+""].modules.module_dynamic.major,o="video"===e?i.archive:"pgc"===e?i.pgc:i.article,l=a[t+""].modules.module_author,r=l.mid-0;s.includes(a[t+""].id_str)||d.blackListVideo.includes(r)||(!n.videoInit&&"video"===e&&d.videoPush&&isNew(l.pub_ts)&&(console.log(`你关注的up ${l.name} 投稿了新视频！${o.title} see:${o.bvid}`),basicNotification(a[t+""].id_str,`你关注的up ${l.name} 投稿了新视频！`,o.title,o.bvid,l.face,"b23.tv/")),!n.videoInit&&"pgc"===e&&d.pgcPush&&(console.log("\u4F60\u5173\u6CE8\u7684\u756A\u5267 "+l.name+" \u66F4\u65B0\u4E86\uFF01"+o.title+" see:"+o.jump_url),basicNotification(a[t+""].id_str,"\u4F60\u5173\u6CE8\u7684\u756A\u5267 "+l.name+" \u66F4\u65B0\u4E86\uFF01",o.title,o.jump_url.replaceAll("https://","").replaceAll("http://",""),o.cover,"")),!n.videoInit&&"article"===e&&d.articlePush&&isNew(l.pub_ts)&&(console.log(`你关注的up ${l.name} 投稿了文章！${o.title} see:${o.id}`),basicNotification(a[t+""].id_str,`你关注的up ${l.name} 投稿了文章！`,o.title,o.id,l.face,"www.bilibili.com/read/cv")),s.push(a[t+""].id_str))}40<=s.length&&s.splice(0,10),"video"===e?chrome.storage.local.set({video_id_list:s},()=>{}):"pgc"===e?chrome.storage.local.set({pgc_id_list:s},()=>{}):"article"===e?chrome.storage.local.set({article_id_list:s},()=>{}):void 0,i(200)}})}).catch(t=>{a(t)})})})}function isNew(e){return 600>Date.now()/1e3-(e-0)}async function videoNotify(){try{await getNewPost("video"),await getNewPost("pgc"),await getNewPost("article")}catch(t){console.log(t),errorHandler("getNewVideos",t,"videoNotify(); line 934")}await chrome.storage.local.set({videoInit:!1},()=>{})}function dynamicNotify(){let e=new AbortController;setTimeout(()=>{e.abort("timeout")},3e3),chrome.storage.local.get(["dynamicList","dynamicInit"],t=>{let a=t.dynamicList,n=Date.now()/1e3;fetch(`https://api.vc.bilibili.com/dynamic_svr/v1/dynamic_svr/dynamic_new?type_list=1,2,4`,{method:"GET",credentials:"include",signal:e.signal,body:null}).then(e=>e.json()).then(e=>{0===e.code?chrome.storage.sync.get(["dynamicSwitch","blackListDynamic"],s=>{let d=e.data.cards;for(let e=0;e<d.length;e++){let i=JSON.parse(d[e+""].card),o=d[e+""].desc.type,l=d[e+""].desc.uid-0;!a.includes(d[e+""].desc.dynamic_id)&&300>n-(d[e+""].desc.timestamp-0)&&(t.dynamicInit||!s.dynamicSwitch||s.blackListDynamic.includes(l)||(1===o?(console.log("\u4F60\u5173\u6CE8\u7684up "+i.user.uname+" \u8F6C\u53D1\u4E86\u4E00\u6761\u65B0\u52A8\u6001 "+i.item.content+" see:"+`https://t.bilibili.com/${d[e+""].desc.dynamic_id_str}`),basicNotification(d[e+""].desc.dynamic_id,`你关注的up ${i.user.uname} 转发了一条动态`,i.item.content+"",d[e+""].desc.dynamic_id_str,i.user.face,"t.bilibili.com/")):2===o?(console.log("\u4F60\u5173\u6CE8\u7684up "+i.user.name+" \u53D1\u4E86\u4E00\u6761\u65B0\u52A8\u6001 "+i.item.description+" see: "+`https://t.bilibili.com/${d[e+""].desc.dynamic_id_str}`),basicNotification(d[e+""].desc.dynamic_id,`你关注的up ${i.user.name} 发了一条图片动态`,i.item.description+"",d[e+""].desc.dynamic_id_str,i.user.head_url,"t.bilibili.com/")):4===o?(console.log("\u4F60\u5173\u6CE8\u7684up "+i.user.uname+" \u53D1\u4E86\u4E00\u6761\u65B0\u52A8\u6001 "+i.item.content+" see: "+`https://t.bilibili.com/${d[e+""].desc.dynamic_id_str}`),basicNotification(d[e+""].desc.dynamic_id,`你关注的up ${i.user.uname} 发了一条新动态`,i.item.content+"",d[e+""].desc.dynamic_id_str,i.user.face,"t.bilibili.com/")):void 0),a.push(d[e+""].desc.dynamic_id),40<a.length&&a.splice(0,1))}chrome.storage.local.set({dynamicList:a},()=>{})}):errorHandler("getNewDynamics",e.code,"dynamicNotify(); line 841"),chrome.storage.local.set({dynamicInit:!1},()=>{})}).catch(t=>{errorHandler("getNewDynamics",t,"dynamicNotify(); line 875")})})}function getNewUnread(){chrome.storage.local.get(["unreadData","unreadInit","unreadMessage"],async e=>{let t=JSON.parse(e.unreadData);await fetch("https://api.bilibili.com/x/msgfeed/unread",{method:"GET",credentials:"include",body:null}).then(e=>e.json()).then(i=>{0===i.code?chrome.storage.sync.get(["unreadSwitch"],a=>{if(a.unreadSwitch){if(!e.unreadInit&&(0<i.data.at-t.at||0<i.data.like-t.like||0<i.data.reply-t.reply||0<i.data.sys_msg-t.sys_msg||0<i.data.up-t.up)){let e=`${0<i.data.at-t.at?i.data.at-t.at+"\u4E2A@, ":""}${0<i.data.like-t.like?i.data.like-t.like+"\u4E2A\u8D5E, ":""}${0<i.data.reply-t.reply?i.data.reply-t.reply+"\u4E2A\u56DE\u590D, ":""}${0<i.data.sys_msg-t.sys_msg?i.data.sys_msg-t.sys_msg+"\u4E2A\u7CFB\u7EDF\u901A\u77E5, ":""}${0<i.data.up-t.up?i.data.up-t.up+"\u4E2Aup\u52A9\u624B\u63D0\u9192, ":""}`;chrome.notifications.clear("-276492:reply:message.bilibili.com/#/"),basicNotification(-276492,"\u4F60\u6536\u5230\u4E86\u65B0\u7684\u6D88\u606F:",e.substring(0,e.length-2),`reply`,"",`message.bilibili.com/#/`)}t=i.data,chrome.storage.local.set({unreadData:JSON.stringify(t)},()=>{})}}):errorHandler("getNewUnreads",i.code,"getUnread(); line 905")}).catch(t=>{errorHandler("getNewUnreads",t,"getUnread(); line 909")}),await fetch("https://api.vc.bilibili.com/session_svr/v1/session_svr/single_unread",{method:"GET",credentials:"include",body:null}).then(e=>e.json()).then(t=>{0===t.code?chrome.storage.sync.get(["unreadSwitch"],i=>{i.unreadSwitch&&!e.unreadInit&&0<t.data.biz_msg_follow_unread+t.data.biz_msg_unfollow_unread+t.data.dustbin_push_msg+t.data.dustbin_unread+t.data.follow_unread+t.data.unfollow_push_msg+t.data.unfollow_unread-e.unreadMessage&&(chrome.notifications.clear("-276491:reply:message.bilibili.com/#/"),basicNotification(-276491,`你收到了${t.data.biz_msg_follow_unread+t.data.biz_msg_unfollow_unread+t.data.dustbin_push_msg+t.data.dustbin_unread+t.data.follow_unread+t.data.unfollow_push_msg+t.data.unfollow_unread-e.unreadMessage}条新私信`,"",`reply`,"",`message.bilibili.com/#/`)),chrome.storage.local.set({unreadMessage:t.data.biz_msg_follow_unread+t.data.biz_msg_unfollow_unread+t.data.dustbin_push_msg+t.data.dustbin_unread+t.data.follow_unread+t.data.unfollow_push_msg+t.data.unfollow_unread},()=>{})}):errorHandler("getUnread",t.code,"getUnread(); line 929")}).catch(t=>{errorHandler("getUnread",t,"getUnread(; line 933)")}),chrome.storage.local.set({unreadInit:!1},()=>{})})}function checkMedalDaka(){chrome.storage.sync.get(["daka","blackListDK"],e=>{console.log("Grabbing medal info"),chrome.storage.local.get(["rua_lastDK","uuid","dakaUid"],t=>{if(e.daka&&(null===t.rua_lastDK||isNewerThan(t.rua_lastDK.split("-"),(getUTC8Time().getFullYear()+"-"+getUTC8Time().getMonth()+"-"+getUTC8Time().getDate()).split("-")))){let a=[];chrome.storage.local.set({rua_lastDK:getUTC8Time().getFullYear()+"-"+getUTC8Time().getMonth()+"-"+getUTC8Time().getDate()},()=>{}),fetch("https://api.live.bilibili.com/xlive/web-ucenter/user/MedalWall?target_id="+t.uuid,{method:"GET",credentials:"include",body:null}).then(e=>e.json()).then(n=>{console.log(n.data.list.length+" medal founded."),console.log(`${n.data.list.length} medal founded, ${e.blackListDK.length} ignored.`),console.log(t.dakaUid);for(let s=0;s<n.data.list.length;s++)-1===e.blackListDK.indexOf(n.data.list[s].medal_info.target_id)&&-1===t.dakaUid.indexOf(n.data.list[s].medal_info.target_id)&&100>n.data.list[s].medal_info.today_feed&&a.push(n.data.list[s].medal_info.target_id);chrome.storage.local.set({dakaUid:a},()=>{chrome.alarms.create("dakaRoom",{when:Date.now(),periodInMinutes:.1})})}).catch(e=>{chrome.storage.local.set({rua_lastDK:"1970-01-01"},()=>{}),errorHandler("daka",e,"checkMedalDaka(); line 968")})}else console.log("No more grab needed.")})})}function daka(e,t,i){0===e.length?chrome.alarms.clear("dakaRoom",()=>{}):fetch("https://api.live.bilibili.com/live_user/v1/Master/info?uid="+e[0],{method:"GET",credentials:"include",body:null}).then(e=>e.json()).then(a=>{if(0===a.code||0<a.data.length){let n=new FormData;n.append("bubble","0"),n.append("msg",i),n.append("color","16777215"),n.append("mode","1"),n.append("fontsize","25"),n.append("rnd",Math.round(Date.now()/1e3)+""),n.append("roomid",a.data.room_id),n.append("csrf",t),n.append("csrf_token",t),fetch("https://api.live.bilibili.com/msg/send?requestFrom=rua5",{method:"POST",credentials:"include",body:n}).then(()=>{console.log("\u6253\u5361\u6210\u529F: https://live.bilibili.com/"+a.data.room_id);let t=e;t.splice(0,1),chrome.storage.local.set({dakaUid:t},()=>{})}).catch(e=>{console.error("Error:",e)})}})}async function legalVideoLink(e){return!!("AaBb".includes(e.charAt(0))&&"Vv".includes(e.charAt(1)))&&("AaBb".substr(0,2).includes(e.charAt(0))?await findVideo("aid="+e.substr(2,e.length-1)):await findVideo("bvid="+e))}function findVideo(e){return fetch("https://api.bilibili.com/x/web-interface/view?"+e,{method:"GET",credentials:"include",body:null}).then(e=>e.json()).then(e=>0===e.code)}function checkUpdate(t){console.log("checking update at "+new URL(t).hostname);let i=chrome.runtime.getManifest().version.split(".");fetch(t+new Date().getTime(),{method:"GET",credentials:"omit",body:null}).then(e=>e.text()).then(e=>{null!==e&&null!==/<meta name="current-version" content="(.*?)">/m.exec(e)&&i!==/<meta name="current-version" content="(.*?)">/m.exec(e)[1]&&(i=/<meta name="current-version" content="(.*?)">/m.exec(e)[1].split("."),i[0]-0>chrome.runtime.getManifest().version.split(".")[0]-0||i[0]-0>=chrome.runtime.getManifest().version.split(".")[0]-0&&i[1]-0>chrome.runtime.getManifest().version.split(".")[1]-0?(console.log(`A newer version found: ${i[0]}.${i[1]}`),chrome.storage.local.set({updateAvailable:!0},()=>{}),chrome.storage.local.set({availableBranch:new URL(t).hostname.includes("github")?"https://github.com/TyraelDLee/HarukaEmoji/releases/latest":"https://gitee.com/tyrael-lee/HarukaEmoji/releases"},()=>{}),setBadge("rua\u8C79\u5668 \u6709\u66F4\u65B0\u53EF\u7528","1")):(console.log("Current version is latest."),chrome.storage.local.set({updateAvailable:!1},()=>{}),setBadge("rua\u8C79\u5668","")))}).catch(i=>{console.log(i),checkUpdate(t.includes("github")?"https://tyrael-lee.gitee.io/harukaemoji/?_=":"https://tyraeldlee.github.io/HarukaEmoji/?_=")})}function isNewerThan(e,t){return!!(parseInt(e[0])<parseInt(t[0]))||!(parseInt(e[0])>parseInt(t[0]))&&(!!(parseInt(e[1])<parseInt(t[1]))||!(parseInt(e[1])>parseInt(t[1]))&&parseInt(e[2])<parseInt(t[2]))}function getUTC8Time(){return new Date(new Date().getTime()+6e4*new Date().getTimezoneOffset())}function setBadge(e,t){chrome.action.setTitle({title:e}),chrome.action.setBadgeText({text:t})}function heartBeat(){chrome.storage.local.get(["jct","uuid","heartRhythm"],async e=>{(-1===e.uuid||-1===e.jct)&&chrome.storage.local.set({heartRhythm:[]},()=>{});let t=e.heartRhythm;if(0<t.length)for(let a=0;a<t.length;a++)t[a]=await QRSComplex(t[a],e.jct);chrome.storage.local.set({heartRhythm:t},()=>{})})}function QRSComplex(e,t){function i(e){let t="";for(const a in e)t+=`${a}=${encodeURIComponent("id"==a||"device"===a?JSON.stringify(e[a]):e[a])}&`;return t.slice(0,-1)}let a;return 0===e.id[2]?a={id:e.id,device:e.device,ruid:e.ruid,ts:Date.now(),is_patch:0,heart_beat:[]}:(a={id:e.id,device:e.device,ruid:e.ruid,ets:e.ets,benchmark:e.benchmark,ts:Date.now(),time:e.time},a=Object.assign({s:function(e,t){let a=JSON.stringify({platform:"web",parent_id:e.id[0],area_id:e.id[1],seq_id:e.id[2],room_id:e.id[3],buvid:e.device[0],uuid:e.device[1],ets:e.ets,time:e.time,ts:e.ts});for(let n of t)0===n?a=CryptoJS.HmacMD5(a,e.benchmark).toString(CryptoJS.enc.Hex):1===n?a=CryptoJS.HmacSHA1(a,e.benchmark).toString(CryptoJS.enc.Hex):2===n?a=CryptoJS.HmacSHA256(a,e.benchmark).toString(CryptoJS.enc.Hex):3===n?a=CryptoJS.HmacSHA224(a,e.benchmark).toString(CryptoJS.enc.Hex):4===n?a=CryptoJS.HmacSHA512(a,e.benchmark).toString(CryptoJS.enc.Hex):5===n?a=CryptoJS.HmacSHA384(a,e.benchmark).toString(CryptoJS.enc.Hex):void 0;return a}(a,e.secret_rule)},a)),fetch(`https://live-trace.bilibili.com/xlive/data-interface/v1/x25Kn/${0===e.id[2]?"E":"X"}`,{method:"POST",credentials:"include",headers:{"content-type":"application/x-www-form-urlencoded"},body:`${i(a)}&ua=${self.navigator.userAgent}&csrf_token=${t}&csrf=${t}&visit_id:`}).then(e=>e.json()).then(t=>{if(0===t.code){let i=e.id[2]+1;return{id:[e.id[0],e.id[1],i,e.id[3]],device:e.device,ruid:e.ruid,ets:t.data.timestamp,benchmark:t.data.secret_key,time:t.data.heartbeat_interval,secret_rule:t.data.secret_rule}}return console.log(`${t.code} at ${i(a)}`),{id:[e.id[0],e.id[1],0,e.id[3]],device:e.device,ruid:e.ruid}})}function refreshHeartBeatList(){chrome.storage.local.get(["uuid"],e=>{fetch(`https://api.live.bilibili.com/xlive/web-ucenter/user/MedalWall?target_id=${e.uuid}`,{method:"GET",credentials:"include",body:null}).then(e=>e.json()).then(e=>{0===e.code?chrome.storage.local.set({medalList:e.data.list},()=>{}):chrome.alarms.create("refreshHBRetry",{delayInMinutes:1})}).catch(()=>{chrome.alarms.create("refreshHBRetry",{delayInMinutes:1})})})}