!function(){var a=Math.ceil;function b(){q=window.innerHeight*1,r=window.innerWidth*1}function c(b){$.ajax({url:"https://api.bilibili.com/x/player/playurl?bvid="+u+"&cid="+b+"&qn=120&type=flv&fourk=1",type:"GET",dataType:"json",json:"callback",xhrFields:{withCredentials:!0},success:function(c){if(I.innerHTML="<b style='user-select: none'>\u89C6\u9891ID:</b> av"+t+" / "+u+" "+(v-1+2)+"p/"+w.length+"p",n(),N.innerHTML="",0===c.code){for(let a=0;a<c.data.accept_quality.length;a++){x[c.data.accept_quality[a]]={accept_description:c.data.accept_description[a],accept_format:c.data.accept_format.split(",")[a]};let d=document.createElement("div");d.setAttribute("id","qn-"+c.data.accept_quality[a]),d.classList.add("rua-download-block"),d.innerHTML="<div class='rua-quality-des'>"+x[c.data.accept_quality[a]].accept_description+"</div>",N.appendChild(d),z.push(d),d.onclick=()=>{l(u,b,c.data.accept_quality[a],y[v]+" "+c.data.accept_description[a])}}N.style.height=40*a(z.length/3)+"px",d(b),console.log(x)}}})}function d(b){$.ajax({url:"https://api.bilibili.com/x/player/playurl?bvid="+u+"&cid="+b+"&qn=120&fnval=16",type:"GET",dataType:"json",json:"callback",xhrFields:{withCredentials:!0},success:function(b){if(0===b.code&&null!==b.data&&(console.log(b.data.dash.audio[0].baseUrl),null!==b.data.dash.audio[0].baseUrl)){let c=document.createElement("div");c.setAttribute("id","qn-sound"),c.classList.add("rua-download-block"),c.innerHTML="<div class='rua-quality-des'>Sound Only</div>",N.appendChild(c),z.push(c),N.style.height=40*a(z.length/3)+"px",c.onclick=()=>{const c=b.data.dash.audio[0].baseUrl+"&requestFrom=ruaDL";chrome.runtime.sendMessage({msg:"requestDownload",fileName:(y[v]+" SoundOnly").replaceAll(" ","_")});const d=document.createElement("a");document.body.appendChild(d),d.style.display="none",d.href=c,d.target="_Blank",d.referrerPolicy="unsafe-url",d.download,d.click(),document.body.removeChild(d)}}}})}function e(){$.ajax({url:"https://api.bilibili.com/x/web-interface/view?"+o(s),type:"GET",dataType:"json",json:"callback",xhrFields:{withCredentials:!0},success:function(a){if(v=0>v?0:v,w=[],y=[],0===a.code){t=a.data.aid,u=a.data.bvid;for(let b=0;b<a.data.pages.length;b++)w.push(a.data.pages[b].cid),1===a.data.pages.length?y.push(a.data.title):y.push(a.data.pages[b].part);console.log(u),console.log(w),c(w[v])}}})}function f(){J.innerText="\u52A0\u8F7D\u5F39\u5E55\u4E2D...",j(),F.setAttribute("id","emoji-popup"),F.style.background="url("+p+") no-repeat center",F.style.backgroundSize="contain",F.style.cursor="pointer",F.innerHTML="<!---->",G.setAttribute("id","emoji-selection"),G.classList.add("emoji_sec"),G.style.display="none",G.innerHTML="",G.appendChild(H),G.appendChild(K),G.appendChild(L),E.appendChild(G),E.appendChild(F),F.style.top=D[1]+"px",G.style.top=D[1]-5+"px";var a=[0,0],c=[0,0];window.onload=function(){F.onmousedown=function(b){let d,e;document.body.style.userSelect="none",F.className="popup-click-in";const f=b||event,h=f.clientX-F.offsetLeft,i=f.clientY-F.offsetTop;a=[F.offsetLeft,F.offsetTop],c=[F.offsetLeft,F.offsetTop],document.onmousemove=function(a){const b=a||event;0<=b.clientX-h&&b.clientX-h<=r-70&&(d=b.clientX-h),0<=b.clientY-i&&b.clientY-i<=q-60&&(e=b.clientY-i),c=[d,e],F.style.left=d+"px",F.style.top=e+"px",G.style.left=320>d?d+60+"px":d-310+"px",G.style.top=e>q-360?q-360+"px":e-5+"px",e===void 0&&(e=F.offsetTop),-1<d&&(D=[r-d,e,d])},document.onmouseup=function(){document.body.style.userSelect="auto",F.className="popup-click-out",g(a[0],a[1],c[0],c[1])?"none"===G.style.display?(G.classList.remove("selection-fade-out"),G.style.display="block",G.classList.add("selection-fade-in")):(G.classList.remove("selection-fade-in"),G.classList.add("selection-fade-out"),setTimeout(()=>{G.style.display="none"},300)):(C=!0,localStorage.setItem("rua_pos",D[0]+","+D[1]+","+D[2])),document.onmousemove=null,document.onmouseup=null}},F.onmouseenter=function(){F.className="popup-click-hoverin"},F.onmouseleave=function(){F.className="popup-click-hoverout"}},window.addEventListener("resize",function(){let a,c=D[0]<D[2]?D[0]/A:D[2]/A;b(),C?(a=D[0]<D[2]?r-D[0]:D[2],F.style.left=a+"px"):i(),D[1]>q-60&&(F.style.top=q-60+"px",G.style.top=q-360+"px"),G.style.left=320>a?a+60+"px":a-310+"px"})}function g(a,b,c,d){var e=Math.abs;return 0===e(a-c)&&0===e(b-d)}function h(a){let b=document.getElementById(a),c=[b.offsetLeft,b.offsetTop],d=b.offsetParent;for(;null!==d;)c[0]+=d.offsetLeft,c[1]+=d.offsetTop+d.clientTop,d=d.offsetParent;return c[0]+=b.clientWidth-60,c[1]+=b.clientHeight-60,c}function i(){let a=h("danmukuBox");D=[r-a[0],a[1],a[0]],D[2]>r-60?(F.style.left=r-60+"px",G.style.left=r-370+"px"):(F.style.left=D[2]+"px",G.style.left=D[2]-310+"px")}function j(){if(null===localStorage.getItem("rua_pos"))i(),C=!1;else if(localStorage.getItem("rua_pos").includes("undefined"))localStorage.removeItem("rua_pos"),i(),C=!1;else{C=!0;for(let a=0;3>a;a++)D[a]=parseInt(localStorage.getItem("rua_pos").split(",")[a]);let a=0;a=D[0]<D[2]?r-D[0]:D[2],D[1]>q-50&&(D[1]=q-50),F.style.left=a+"px",G.style.left=320>a?a+60+"px":a-310+"px"}}function k(a){a?G.style.background="#151515":G.style.removeProperty("background")}function l(a,b,c,d){let e=new XMLHttpRequest;e.withCredentials=!0,e.open("GET","https://api.bilibili.com/x/player/playurl?bvid="+u+"&cid="+b+"&qn="+c+"&type=flv&fourk=1"),e.send(null),e.onload=function(){200===e.status&&0===JSON.parse(e.responseText).code&&null!==JSON.parse(e.responseText).data.durl&&m(JSON.parse(e.responseText).data.durl,d,0,JSON.parse(e.responseText).data.durl.length)}}function m(b,c,d,e){const f=b[d].url+"&requestFrom=ruaDL";chrome.runtime.sendMessage({msg:"requestDownload",fileName:(c+(1===b.length?"":"_p"+d)).replaceAll(" ","_")});const g=document.createElement("a");document.body.appendChild(g),g.style.display="none",g.href=f,g.target="_Blank",g.referrerPolicy="unsafe-url",g.download,g.click(),document.body.removeChild(g),++d,d<e&&setTimeout(()=>{m(b,c,d,e)},2e3)}function n(){for(let a=0;a<z.length;a++)z[a].onclick=null;z=[]}function o(a){if("AaBb".includes(a.charAt(0))&&"Vv".includes(a.charAt(1)))return"AaBb".substr(0,2).includes(a.charAt(0))?"aid="+a.replace("av",""):"bvid="+a}const p=chrome.runtime.getURL("../images/haruka/abaaba.svg");var q,r,s=window.location.pathname.replaceAll("/","").replace("video",""),t="",u="0",v=null===new URLSearchParams(window.location.search).get("p")?0:new URLSearchParams(window.location.search).get("p")-1,w=[],x={},y=[],z=[],A=window.innerWidth,B=[];new MutationObserver(()=>{const a=new URLSearchParams(window.location.search).get("p")-1,b=window.location.pathname.replaceAll("/","").replace("video","");null!==new URLSearchParams(window.location.search).get("p")&&v!==a&&(v=a,c(w[a])),null!==b&&b!==s&&(s=b,e())}).observe(document,{subtree:!0,childList:!0}),b();var C=!1,D=[100,100,100];const E=document.body,F=document.createElement("div"),G=document.createElement("div"),H=document.createElement("div");H.setAttribute("id","rua-video-info"),H.style.paddingTop="2px";const I=document.createElement("div");I.style.float="left",I.style.paddingLeft="5px",H.appendChild(I);const J=document.createElement("table"),K=document.createElement("div");K.setAttribute("id","rua-damaku"),K.classList.add("emoji_sec"),K.appendChild(J);const L=document.createElement("div");L.setAttribute("id","rua-download"),L.classList.add("emoji_sec");const M=document.createElement("div");M.setAttribute("style","width: 290px; position: fixed; background: #fff"),M.innerHTML="<div style='float: left; user-select: none; padding-left: 5px'><b>\u89C6\u9891\u4E0B\u8F7D\uFF1A</b></div>",L.appendChild(M);const N=document.createElement("div");N.setAttribute("style","margin: 20px 0 0 15px;"),L.appendChild(N),e(),0===document.getElementsByTagName("article").length&&f();var O=new MutationObserver(function(a){a.forEach(function(a){"attributes"===a.type&&(null===P.getAttribute("lab-style")?k(!1):(B=P.getAttribute("lab-style").split(","),-1===B.indexOf("dark")?k(!1):k(!0)))})});const P=document.documentElement;O.observe(P,{attributes:!0})}();