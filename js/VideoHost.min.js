!function(){function a(){o=window.innerHeight*1,p=window.innerWidth*1}function b(a){$.ajax({url:"https://api.bilibili.com/x/player/playurl?bvid="+q+"&cid="+a+"&qn=120&type=flv&fourk=1",type:"GET",dataType:"json",json:"callback",xhrFields:{withCredentials:!0},success:function(b){if(H.innerHTML="",0===b.code){for(let d=0;d<b.data.accept_quality.length;d++){u[b.data.accept_quality[d]]={accept_description:b.data.accept_description[d],accept_format:b.data.accept_format.split(",")[d]};let e=document.createElement("div");e.setAttribute("id","qn-"+b.data.accept_quality[d]),e.classList.add("rua-download-block"),e.innerHTML="<div class='rua-quality-des'>"+u[b.data.accept_quality[d]].accept_description+"</div>",H.appendChild(e),e.onclick=()=>{c(q,a,b.data.accept_quality[d]).then(c=>{console.log(c);for(let e=0;e<c.length;e++){c[e]+="&requestFrom=ruaDL",chrome.runtime.sendMessage({msg:"requestDownload",fileName:(v[s]+" "+b.data.accept_description[d]+(1===c.length?"":"_p"+e)).replaceAll(" ","_")});const f=document.createElement("a");document.body.appendChild(f),f.style.display="none",f.href=c[e],f.target="_Blank",f.referrerPolicy="unsafe-url",f.download,f.click(),document.body.removeChild(f)}})}}console.log(u)}}})}async function c(a,b,c){return await k(a,b,c)}function d(){F.innerText="\u52A0\u8F7D\u5F39\u5E55\u4E2D...",i(),D.setAttribute("id","emoji-popup"),D.style.background="url("+m+") no-repeat center",D.style.backgroundSize="contain",D.style.cursor="pointer",D.innerHTML="<!---->",E.setAttribute("id","emoji-selection"),E.classList.add("emoji_sec"),E.style.display="none",E.innerHTML="",E.appendChild(G),E.appendChild(H),C.appendChild(E),C.appendChild(D),D.style.top=B[1]+"px",E.style.top=B[1]-5+"px";var b=[0,0],c=[0,0];window.onload=function(){D.onmousedown=function(a){let d,f;document.body.style.userSelect="none",D.className="popup-click-in";const g=a||event,h=g.clientX-D.offsetLeft,i=g.clientY-D.offsetTop;b=[D.offsetLeft,D.offsetTop],c=[D.offsetLeft,D.offsetTop],document.onmousemove=function(a){const b=a||event;0<=b.clientX-h&&b.clientX-h<=p-70&&(d=b.clientX-h),0<=b.clientY-i&&b.clientY-i<=o-60&&(f=b.clientY-i),c=[d,f],D.style.left=d+"px",D.style.top=f+"px",E.style.left=320>d?d+60+"px":d-310+"px",E.style.top=f>o-360?o-360+"px":f-5+"px",f===void 0&&(f=D.offsetTop),-1<d&&(B=[p-d,f,d])},document.onmouseup=function(){document.body.style.userSelect="auto",D.className="popup-click-out",e(b[0],b[1],c[0],c[1])?"none"===E.style.display?(E.classList.remove("selection-fade-out"),E.style.display="block",E.classList.add("selection-fade-in")):(E.classList.remove("selection-fade-in"),E.classList.add("selection-fade-out"),setTimeout(()=>{E.style.display="none"},300)):(A=!0,localStorage.setItem("rua_pos",B[0]+","+B[1]+","+B[2])),document.onmousemove=null,document.onmouseup=null}},D.onmouseenter=function(){D.className="popup-click-hoverin"},D.onmouseleave=function(){D.className="popup-click-hoverout"}},window.addEventListener("resize",function(){let b,c=B[0]<B[2]?B[0]/y:B[2]/y;a(),A?(b=B[0]<B[2]?p-B[0]:B[2],D.style.left=b+"px"):h(),B[1]>o-60&&(D.style.top=o-60+"px",E.style.top=o-360+"px"),E.style.left=320>b?b+60+"px":b-310+"px"})}function e(a,b,c,d){var e=Math.abs;return 0===e(a-c)&&0===e(b-d)}function f(){"undefined"!=typeof chrome.app.isInstalled&&chrome.runtime.sendMessage({msg:"get_LoginInfo"},function(a){w=a.res.split(",")[0],x=a.res.split(",")[1]})}function g(a){let b=document.getElementById(a),c=[b.offsetLeft,b.offsetTop],d=b.offsetParent;for(;null!==d;)c[0]+=d.offsetLeft,c[1]+=d.offsetTop+d.clientTop,d=d.offsetParent;return c[0]+=b.clientWidth-60,c[1]+=b.clientHeight-60,c}function h(){let a=g("danmukuBox");B=[p-a[0],a[1],a[0]],B[2]>p-60?(D.style.left=p-60+"px",E.style.left=p-370+"px"):(D.style.left=B[2]+"px",E.style.left=B[2]-310+"px")}function i(){if(null===localStorage.getItem("rua_pos"))h(),A=!1;else if(localStorage.getItem("rua_pos").includes("undefined"))localStorage.removeItem("rua_pos"),h(),A=!1;else{A=!0;for(let a=0;3>a;a++)B[a]=parseInt(localStorage.getItem("rua_pos").split(",")[a]);let a=0;a=B[0]<B[2]?p-B[0]:B[2],B[1]>o-50&&(B[1]=o-50),D.style.left=a+"px",E.style.left=320>a?a+60+"px":a-310+"px"}}function j(a){a?E.style.background="#151515":E.style.removeProperty("background")}function k(a,b,c){return new Promise(function(a){let d=[],e=new XMLHttpRequest;e.withCredentials=!0,e.open("GET","https://api.bilibili.com/x/player/playurl?bvid="+q+"&cid="+b+"&qn="+c+"&type=flv&fourk=1"),e.send(null),e.onload=function(){if(200===e.status&&0===JSON.parse(e.responseText).code&&null!==JSON.parse(e.responseText).data.durl)for(let a=0;a<JSON.parse(e.responseText).data.durl.length;a++)d.push(JSON.parse(e.responseText).data.durl[a].url);a(d)}})}function l(a){if("AaBb".includes(a.charAt(0))&&"Vv".includes(a.charAt(1)))return"AaBb".substr(0,2).includes(a.charAt(0))?"aid="+a.replace("av",""):"bvid="+a}const m=chrome.runtime.getURL("../images/haruka/abaaba.svg"),n=window.location.pathname.replaceAll("/","").replace("video","");var o,p,q="0",s=null===new URLSearchParams(window.location.search).get("p")?0:new URLSearchParams(window.location.search).get("p")-1,t=[],u={},v=[],w="-1",x="-1",y=window.innerWidth,z=[];new MutationObserver(()=>{const a=new URLSearchParams(window.location.search).get("p")-1;null!==new URLSearchParams(window.location.search).get("p")&&s!==a&&(s=a,b(t[a]))}).observe(document,{subtree:!0,childList:!0}),a(),f(),setInterval(f,3e3);var A=!1,B=[100,100,100];const C=document.body,D=document.createElement("div"),E=document.createElement("div"),F=document.createElement("table"),G=document.createElement("div");G.setAttribute("id","rua-damaku"),G.classList.add("emoji_sec"),G.appendChild(F);const H=document.createElement("div");H.setAttribute("id","rua-download"),H.classList.add("emoji_sec"),function(){$.ajax({url:"https://api.bilibili.com/x/web-interface/view?"+l(n),type:"GET",dataType:"json",json:"callback",xhrFields:{withCredentials:!0},success:function(a){if(s=0>s?0:s,0===a.code||0<a.data.length){q=a.data.bvid;for(let b=0;b<a.data.pages.length;b++)t.push(a.data.pages[b].cid),1===a.data.pages.length?v.push(a.data.title):v.push(a.data.pages[b].part);console.log(s),console.log(t),b(t[s])}}})}(),0===document.getElementsByTagName("article").length&&d();var I=new MutationObserver(function(a){a.forEach(function(a){"attributes"===a.type&&(null===J.getAttribute("lab-style")?j(!1):(z=J.getAttribute("lab-style").split(","),-1===z.indexOf("dark")?j(!1):j(!0)))})});const J=document.documentElement;I.observe(J,{attributes:!0})}();