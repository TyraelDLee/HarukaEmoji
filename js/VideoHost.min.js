!function(){var e=Math.ceil;function t(){V=window.innerHeight*1,P=window.innerWidth*1}function a(e){return 180-8*e.length}function d(){l(),re.setAttribute("id","emoji-popup"),re.style.background="url("+U+") no-repeat center",re.style.backgroundSize="contain",re.style.cursor="pointer",re.innerHTML="<!---->",ue.setAttribute("id","emoji-selection"),ue.classList.add("emoji_sec"),ue.style.display="none",ue.innerHTML="",ue.appendChild(ce),ue.appendChild(ve),ue.appendChild(he),ue.appendChild(me),ue.appendChild(ge),ue.appendChild(ye),oe.appendChild(ue),oe.appendChild(re),re.style.top=le[1]+"px",ue.style.top=le[1]-5+"px";var e=[0,0],a=[0,0];window.onload=function(){re.onmousedown=function(t){let d,i;document.body.style.userSelect="none",re.classList.remove("popup-click-hoverout"),re.classList.remove("popup-click-hoverin"),re.classList.remove("popup-click-out"),re.classList.add("popup-click-in");const s=t||event,l=s.clientX-re.offsetLeft,o=s.clientY-re.offsetTop;e=[re.offsetLeft,re.offsetTop],a=[re.offsetLeft,re.offsetTop],document.onmousemove=function(e){const t=e||event;0<=t.clientX-l&&t.clientX-l<=P-70&&(d=t.clientX-l),0<=t.clientY-o&&t.clientY-o<=V-60&&(i=t.clientY-o),a=[d,i],re.style.left=d+"px",re.style.top=i+"px",ue.style.left=320>d?d+60+"px":d-310+"px",ue.style.top=i>V-360?V-360+"px":i-5+"px",i===void 0&&(i=re.offsetTop),-1<d&&(le=[P-d,i,d])},document.onmouseup=function(){document.body.style.userSelect="auto",re.classList.remove("popup-click-hoverout"),re.classList.remove("popup-click-hoverin"),re.classList.remove("popup-click-in"),re.classList.add("popup-click-out"),n(e[0],e[1],a[0],a[1])?"none"===ue.style.display?(ue.classList.remove("selection-fade-out"),ue.style.display="block",ue.classList.add("selection-fade-in")):(ue.classList.remove("selection-fade-in"),ue.classList.add("selection-fade-out"),setTimeout(()=>{ue.style.display="none"},300)):(se=!0,localStorage.setItem("rua_pos",le[0]+","+le[1]+","+le[2])),document.onmousemove=null,document.onmouseup=null}},re.onmouseenter=function(){re.classList.remove("popup-click-hoverout"),re.classList.add("popup-click-hoverin")},re.onmouseleave=function(){re.classList.remove("popup-click-hoverin"),re.classList.add("popup-click-hoverout")}},window.addEventListener("resize",function(){let e,a=le[0]<le[2]?le[0]/de:le[2]/de;t(),se?(e=le[0]<le[2]?P-le[0]:le[2],re.style.left=e+"px"):s(),le[1]>V-60&&(re.style.top=V-60+"px",ue.style.top=V-360+"px"),ue.style.left=320>e?e+60+"px":e-310+"px"}),document.getElementById("rua-danmaku-download").addEventListener("click",()=>{0===document.getElementById("rua-danmaku-download").getAttribute("style").length&&(G.feedDanmaku(ee),G.downloadASS())}),document.getElementById("rua-danmaku-intense").addEventListener("change",function(){let e=this.value-1+1;G.setWeight(10-e)})}function n(e,t,a,d){var n=Math.abs;return 0===n(e-a)&&0===n(t-d)}function i(t,a,d){let n=document.getElementById(t),e=[n.offsetLeft,n.offsetTop],i=n.offsetParent;for(;null!==i;)e[0]+=i.offsetLeft,e[1]+=i.offsetTop+i.clientTop,i=i.offsetParent;return e[0]+=n.clientWidth+a,e[1]+=n.clientHeight+d,e}function s(){let e=i("danmukuBox",-60,-60);le=[P-e[0],e[1],e[0]],le[2]>P-60?(re.style.left=P-60+"px",ue.style.left=P-370+"px"):(re.style.left=le[2]+"px",ue.style.left=le[2]-310+"px")}function l(){if(null===localStorage.getItem("rua_pos"))s(),se=!1;else if(localStorage.getItem("rua_pos").includes("undefined"))localStorage.removeItem("rua_pos"),s(),se=!1;else{se=!0;for(let e=0;3>e;e++)le[e]=parseInt(localStorage.getItem("rua_pos").split(",")[e]);let e=0;e=le[0]<le[2]?P-le[0]:le[2],le[1]>V-50&&(le[1]=V-50),re.style.left=e+"px",ue.style.left=320>e?e+60+"px":e-310+"px"}}function o(e){e?ue.style.background="#151515":ue.style.removeProperty("background")}function r(t,a,d,n,s){const l=document.createElement("div");l.setAttribute("id","rua-copy-tips"),l.setAttribute("style",`opacity: 0; display: block; left: ${i(d,n,s)[0]}px; top: ${i(d,n,s)[1]}px;`),l.innerText=a,document.getElementById("app").appendChild(l),setTimeout(()=>{l.style.opacity="1"},10),setTimeout(()=>{l.style.opacity="0"},1e3),setTimeout(()=>{l.style.display="none",document.getElementById("app").removeChild(l)},1400),navigator.clipboard.writeText(t).catch(a=>{console.log("Failed to access clipboard, using execCommand.");const e=document.createElement("textarea");e.value=t,document.body.appendChild(e),e.select(),document.execCommand("Copy"),e.remove()})}function u(){X=0>X?0:X,J=[],K=[],document.getElementById("rua-danmaku-size").innerText="\u51710 \u5F39\u5E55",me.getElementsByTagName("div")[0].style.height="0px","ss"!==D.substring(0,2)&&"ep"!==D.substring(0,2)?fetch("https://api.bilibili.com/x/web-interface/view?"+h(D),{method:"GET",credentials:"include",body:null}).then(e=>e.json()).then(e=>{if(0===e.code){Y=e.data.aid,W=e.data.bvid,K.push(e.data.title);for(let t=0;t<e.data.pages.length;t++)J.push(e.data.pages[t].cid),1<e.data.pages.length&&K.push(e.data.pages[t].part);p(e.data.pic),y(J[X])}}):(document.getElementById("emoji-selection").style.fontSize="12px",console.log(document.querySelector("link[rel=\"canonical\"]").href.replace("https://www.bilibili.com/bangumi/play/","")),c(document.querySelector("link[rel=\"canonical\"]").href.replace("https://www.bilibili.com/bangumi/play/","")))}function c(e){fetch("https://api.bilibili.com/pgc/view/web/season?"+f(e),{method:"GET",credentials:"include",body:null}).then(e=>e.json()).then(t=>{p(t.result.cover),m(t,e)})}function p(t){Ee.onclick=null,Ee.onclick=d=>{const e=document.createElement("a");e.href=t,e.target="_blank",e.style.display="none",document.body.appendChild(e),e.click(),document.body.removeChild(e)}}function m(e,t){let a,d;chrome.runtime.sendMessage({msg:"get_LoginStatus"},function(a){if(0===e.code){let n=!1;try{for(let a=0;a<e.result.episodes.length;a++)if(t.includes(e.result.episodes[a].id+"")){Y=e.result.episodes[a].aid,W=e.result.episodes[a].bvid,d=e.result.episodes[a].badge_info.text,K.push(e.result.season_title+"-"+e.result.episodes[a].long_title),J.push(e.result.episodes[a].cid),n=!0;break}console.log(e.result.section.length);for(let a=0;a<e.result.section.length;a++)if(!n)for(let s=0;s<e.result.section[a].episodes.length;s++)if(t.includes(e.result.section[a].episodes[s].id+"")){Y=e.result.section[a].episodes[s].aid,W=e.result.section[a].episodes[s].bvid,d=e.result.section[a].episodes[s].badge_info.text,K.push(e.result.season_title+e.result.section[a].episodes[s].long_title),J.push(e.result.section[a].episodes[s].cid),n=!0;break}}catch(t){console.log(t)}n&&y(J[0],""===d||"\u9650\u514D"===d||"\u4F1A\u5458"===d&&0<a.vip?"":`<span class="rua-video-right-info">${"\u4F1A\u5458"===d?"\u6B64\u89C6\u9891\u9700\u8981\u5927\u4F1A\u5458":"\u60A8\u6240\u5728\u7684\u5730\u533A\u65E0\u6CD5\u89C2\u770B\u672C\u7247"}。</span>`)}})}function h(e){let t="AaBb",a="Vv";if("AaBb".includes(e.charAt(0))&&a.includes(e.charAt(1)))return"AaBb".substr(0,2).includes(e.charAt(0))?"aid="+e.replace("av",""):"bvid="+e}function f(e){return(e=e.toUpperCase(),"SS"===e.substring(0,2))?"season_id="+e.replace("SS",""):"EP"===e.substring(0,2)?"ep_id="+e.replace("EP",""):void 0}function y(e,t=``){for(pe.innerHTML=`<b style='user-select: none'>视频ID：</b><div style="display: flex; margin-left: -45px"><span>av${Y}</span><span style='user-select: none; margin: 0 2px'>/</span><span>cid:${e}</span><span title="复制ID" class="rua-video-info-copy" id="rua-video-info-copy"><svg viewBox="0 0 400 400" width="18" height="18" style="position: absolute" xmlns="http://www.w3.org/2000/svg"><rect width="400" height="400" fill='#aaa' mask='url(#rua-copy-mask)'/><mask id="rua-copy-mask"><rect x='150' y='40' rx="20" ry="20" width="200" height="280" style="fill:#fff" /><rect x="190" y="110" width="120" height="20" fill="black"/><rect x="190" y="160" width="120" height="20" fill="black"/><rect x="190" y="210" width="120" height="20" fill="black"/><rect x='55' y='75' rx="20" ry="20" width="200" height="280" style="fill:#000"/><rect x='50' y='80' rx="20" ry="20" width="200" height="280" style="fill:#fff"/><rect x="90" y="150" width="120" height="20" fill="black"/><rect x="90" y="200" width="120" height="20" fill="black"/><rect x="90" y="250" width="120" height="20" fill="black"/></mask></svg></span></div><div style="padding-right:5px; user-select: none;">${X-0+1}p/${J.length}p</div>`,document.getElementById("rua-video-info-copy").addEventListener("click",()=>{r(`av号: av${Y}\r\nBV号: ${W}\r\ncid: ${e}`,"\u89C6\u9891ID\u5DF2\u590D\u5236\u5230\u7C98\u8D34\u677F","rua-video-info-copy",-75,18)}),R(),be.innerHTML=t,Z=0,$=0,ee=new DanmakuArr,te=new DanmakuArr,document.getElementById("rua-danmaku-search-input").value="";fe.hasChildNodes();)fe.firstChild.onmousedown=null,fe.removeChild(fe.firstChild);ae=!0,fetch("https://api.bilibili.com/x/player/playurl?bvid="+W+"&cid="+e+"&qn=120&type=flv&fourk=1",{method:"GET",credentials:"include",body:null}).then(e=>e.json()).then(async t=>{if(-404===t.code&&(he.style.display="none",me.style.display="none",ge.style.display="none"),0===t.code){await chrome.runtime.sendMessage({msg:"get_LoginStatus"},function(e){}),await b(e);for(let e=0;e<t.data.durl.length;e++)Z+=t.data.durl[e].length-1+1;g(e,!0,!0,!0),N(e,Y,1,F(Z))}})}function g(e,t,a,d){fetch("https://api.bilibili.com/x/player/playurl?bvid="+W+"&cid="+e+"&qn=120&fnval=272",{method:"GET",credentials:"include",body:null}).then(e=>e.json()).then(n=>{if(0===n.code&&null!==n.data&&null!==n.data.dash&&n.data.dash!==void 0){try{null!==n.data.dash.flac.audio.base_url&&d&&E(e,"flac","Hi-Res",0)}catch(t){}null!==n.data.dash.dolby.audio&&t&&E(e,"dolby","\u675C\u6BD4\u5168\u666F\u58F0",0),null!==n.data.dash.audio[0].base_url&&a&&E(e,"audio","\u97F3\u9891",0)}})}async function b(e){await fetch(`https://api.bilibili.com/x/player/playurl?bvid=${W}&cid=${e}&qn=127&fourk=1&fnver=0&fnval=4048`,{method:"GET",credentials:"include",body:null}).then(e=>e.json()).then(t=>{if(0===t.code){let a=t.data.accept_description,d=t.data.accept_quality;for(let t=0;t<d.length;t++)E(e,"dash",a[t],d[t]-0)}})}function v(){return fetch(`https://api.bilibili.com/x/web-interface/view?bvid=${W}`,{method:"GET",credentials:"include",body:null}).then(e=>e.json()).then(e=>{if(0===e.code)return"undefined"==typeof e.data.pic||null===e.data.pic||""===e.data.pic?e.data.owner.face.replace("http://","https://"):e.data.pic.replace("http://","https://");throw"error"}).catch(t=>"")}function E(t,a,d,n){const i=[`https://api.bilibili.com/x/player/playurl?bvid=${W}&cid=${t}&qn=125&fnval=336`,`https://api.bilibili.com/x/player/playurl?bvid=${W}&cid=${t}&qn=120&fnval=272`,`https://api.bilibili.com/x/player/playurl?cid=${t}&bvid=${W}&qn=127&fourk=1&fnver=0&fnval=4048`];let s=document.createElement("div");s.setAttribute("id",`qn-${a}`),s.classList.add("rua-download-block"),s.innerHTML=`<div class='rua-quality-des' title='${d}'>${d}</div>`,be.appendChild(s),Q.push(s),be.style.height=40*e(Q.length/3)+"px";let l=new AbortController;s.onclick=async()=>{if(!s.classList.contains("rua-downloading")){l=new AbortController,s.classList.add("rua-downloading"),s.getElementsByClassName("rua-quality-des")[0].innerText=`取流中...`;let e=[];await fetch("hdr"===a?i[0]:"8k"===a||"dash"===a?i[2]:i[1],{method:"GET",credentials:"include",body:null}).then(e=>e.json()).then(t=>{if(0===t.code&&null!==t.data)switch(a){case"hdr":e[0]=t.data.dash.video[0].base_url,e[1]=null===t.data.dash.dolby.audio?null!==t.data.dash.flac&&null!==t.data.dash.flac.audio?t.data.dash.flac.audio.base_url:t.data.dash.audio[0].base_url:t.data.dash.dolby.audio[0].base_url;break;case"audio":e[0]=t.data.dash.audio[0].base_url;break;case"dolby":e[0]=t.data.dash.dolby.audio[0].base_url;break;case"flac":e[0]=t.data.dash.flac.audio.base_url;break;case"8k":e[0]=t.data.dash.video[0].base_url,e[1]=null===t.data.dash.dolby.audio?null!==t.data.dash.flac&&null!==t.data.dash.flac.audio?t.data.dash.flac.audio.base_url:t.data.dash.audio[0].base_url:t.data.dash.dolby.audio[0].base_url;break;case"dash":let a=0,d="";for(let e=0;e<t.data.dash.video.length;e++)t.data.dash.video[e].bandwidth>a&&t.data.dash.video[e].id===n&&(a=t.data.dash.video[e].bandwidth,d=t.data.dash.video[e].base_url);e[0]=d,e[1]=null===t.data.dash.dolby.audio?null!==t.data.dash.flac&&null!==t.data.dash.flac.audio?t.data.dash.flac.audio.base_url:t.data.dash.audio[0].base_url:t.data.dash.dolby.audio[0].base_url;break;default:}}),await L(e,K[0]+(1===K.length?"":" "+K[X+1]),t,s,a+"Record",!0,l)}else l.abort("User"),x(s)},k(s)}function k(e){e.onmouseenter=()=>{if(e.classList.contains("rua-downloading")){let t=e.getElementsByTagName("div")[0].innerText;e.getElementsByTagName("div")[0].innerText="\u53D6\u6D88\u4E0B\u8F7D",e.onmouseleave=()=>{e.classList.contains("rua-downloading")&&(e.getElementsByTagName("div")[0].innerText=t),e.onmouseleave=null}}}}function x(e){e.getElementsByTagName("div")[0].innerText=e.getElementsByTagName("div")[0].getAttribute("title"),e.removeAttribute("style"),e.classList.remove("rua-downloading")}async function L(e,t,a,d,n,i=!0,s){function l(){d.removeAttribute("style"),d.classList.remove("rua-downloading"),d.getElementsByClassName("rua-quality-des")[0].innerText=u}let o=new AbortController,r=0,u=d.getElementsByClassName("rua-quality-des")[0].getAttribute("title"),c=[],p={};await fetch(e[0],{method:"GET",body:null,signal:o.signal}).then(e=>{r=e.headers.get("Content-Length"),o.abort()}),i?r<1610612736?(c[0]=await _(e[0],d,a,u,"hdrRecord"===n||"8kRecord"===n||"dashRecord"===n?"\u89C6\u9891":"",!0,s),("hdrRecord"===n||"8kRecord"===n||"dashRecord"===n)&&!s.signal.aborted&&(c[1]=await _(e[1],d,a,u,"\u97F3\u9891",!0,s)),("audioRecord"===n||"flacRecord"===n)&&(p=await A(),c[1]=await v(),ie&&(c[1]=await w(c[1]))),!s.signal.aborted&&B(c,t,n,p).then(e=>{l()})):(c[0]=await _(e[0],d,a,u,"hdrRecord"===n||"8kRecord"===n||"dashRecord"===n?"\u89C6\u9891":"",!1,s,"mp4"),C(c[0],t+".mp4"),("hdrRecord"===n||"8kRecord"===n||"dashRecord"===n)&&!s.signal.aborted&&(c[1]=await _(e[1],d,a,u,"\u97F3\u9891",!1,s,"m4a"),C(c[1],t+".m4a")),l()):(c[0]=await _(e[0],d,a,u,n.includes(":")?"\u5206\u6BB5"+n.split(":")[1]:"\u89C6\u9891",!1,s,"flv"),C(c[0],t+".flv"),l())}function C(e,t){"undefined"==typeof e||e.includes("undefined")||chrome.runtime.sendMessage({msg:"requestDownloader",url:e,fileName:t},t=>{console.log(t.res),"download finished"===t.res&&window.URL.revokeObjectURL(e)})}function w(e){return new Promise((t,a)=>{const d=new Image;d.src=e,d.crossOrigin="anonymous";const n=document.createElement("canvas"),i=n.getContext("2d");d.onload=()=>{const e=d.width>d.height?d.height:d.width,a=(d.width-e)/2,s=(d.height-e)/2;n.width=e,n.height=e,i.drawImage(d,a,s,e,e,0,0,e,e),n.toBlob(e=>{t(URL.createObjectURL(e))})}})}async function B(e,t,a,d){let n,i,s;const{createFFmpeg:l,fetchFile:o}=FFmpeg,r=l({corePath:H,mainName:"main",log:!1});await r.load(),"audioRecord"===a&&(r.FS("writeFile","audio.m4s",await o(e[0])),0<e[1].length?(console.log(e[1]),console.log(`cover.${e[1].substring(e[1].length-3)}`),r.FS("writeFile",`cover`,await o(e[1])),await r.run("-i","audio.m4s","-i",`cover`,"-map","0","-map","1","-c","copy","-disposition:v:0","attached_pic","-metadata",`title=${T(d.title)}`,"-metadata",`artist=${T(d.artist)}`,"-metadata",`year="${d.year}"`,"-metadata",`comment=${W}`,"final.m4a")):await r.run("-i","audio.m4s","-c","copy","-metadata",`title=${T(d.title)}`,"-metadata",`artist=${T(d.artist)}`,"-metadata",`year="${d.year}"`,"-metadata",`comment=${W}`,"final.m4a"),n=r.FS("readFile","final.m4a"),i=t+".m4a",s=URL.createObjectURL(new Blob([n.buffer],{type:"audio/m4a"}))),"dolbyRecord"===a&&(r.FS("writeFile","audio.m4s",await o(e[0])),await r.run("-i","audio.m4s","-c","copy","final.mp4"),n=r.FS("readFile","final.mp4"),i=t+".mp4",s=URL.createObjectURL(new Blob([n.buffer],{type:"audio/mp4"}))),"flacRecord"===a&&(0<e[1].length?(r.FS("writeFile","audio.m4s",await o(e[0])),r.FS("writeFile",`cover`,await o(e[1])),await r.run("-i","audio.m4s","-i",`cover`,"-map","0","-map","1","-c:v","copy","-disposition:v:0","attached_pic","-c:a","alac","-metadata",`title=${T(d.title)}`,"-metadata",`artist=${T(d.artist)}`,"-metadata",`year="${d.year}"`,"-metadata",`comment=${W}`,"final.m4a")):await r.run("-i","audio.m4s","-c:a","alac","-metadata",`title=${T(d.title)}`,"-metadata",`artist=${T(d.artist)}`,"-metadata",`year="${d.year}"`,"-metadata",`comment=${W}`,"final.m4a"),n=r.FS("readFile","final.m4a"),i=t+".m4a",s=URL.createObjectURL(new Blob([n.buffer],{type:"audio/m4a"}))),("hdrRecord"===a||"8kRecord"===a||"dashRecord"===a)&&(r.FS("writeFile","video.m4s",await o(e[0])),r.FS("writeFile","audio.m4s",await o(e[1])),await r.run("-i","video.m4s","-i","audio.m4s","-map","0:v","-map","1:a","-c","copy","final.mkv"),n=r.FS("readFile","final.mkv"),i=t+".mkv",s=URL.createObjectURL(new Blob([n.buffer],{type:"video/mkv"}))),C(s,i)}function T(e){let t=new TextEncoder("utf8"),a=t.encode(e),d="";for(let t=0;t<a.length;++t)d+=String.fromCharCode(a[t]);return d}async function A(){return fetch(`https://api.bilibili.com/x/web-interface/view?bvid=${W}`,{method:"GET",credentials:"include",body:null}).then(e=>e.json()).then(e=>{if(0===e.code&&null!==e.data){let t="";if(null===e.data.staff||e.data.staff===void 0)t=e.data.owner.name;else{for(let a of e.data.staff)t+=a.name+", ";t=t.slice(0,t.length-2)}return{title:e.data.title,artist:t,year:new Date(1e3*(e.data.pubdate-1+1)).getFullYear(),cover:e.data.pic,desc:e.data.desc}}return null}).catch(t=>{})}async function _(e,t,a,d,n,i,s,l=""){let o=0,r=0;return fetch(e,{method:"GET",body:null,signal:s.signal}).then(e=>(t.getElementsByClassName("rua-quality-des")[0].innerText=`下载${n}中...`,o=e.headers.get("Content-Length"),e.body)).then(e=>{const a=e.getReader();return new Response(new ReadableStream({async start(e){function d(){return a.read().then(async a=>{const{done:n,value:s}=a;return n&&(e.close(),i&&(t.getElementsByClassName("rua-quality-des")[0].innerText="\u8F6C\u7801\u4E2D...")),r+=s.length||0,I(t,100*(r/o)),e.enqueue(s),d()})}return d()}})).blob()}).then(e=>(""!==l&&(e=new Blob([e],{type:`${"m4a"===l||"flac"===l?"audio":"video"}/${l}`})),window.URL.createObjectURL(e))).catch(n=>{s.signal.aborted||S(t,a,n.toString(),!1,d)})}function I(e,t){e.setAttribute("style","background: linear-gradient(to right, var(--bili-blue) 0%, var(--bili-blue) "+t+"%, var(--bili-pink) "+t+"%, var(--bili-pink));")}function S(e,t,a,d,n){function i(){e.removeAttribute("style"),e.getElementsByClassName("rua-quality-des")[0].innerText=n,e.removeEventListener("click",i)}console.log(a),e.classList.remove("rua-downloading"),e.setAttribute("style","background: #ff4650;"),e.getElementsByClassName("rua-quality-des")[0].innerText=d?"\u8F6C\u7801\u5931\u8D25":"\u4E0B\u8F7D\u5931\u8D25",e.addEventListener("click",i)}function R(){for(let e=0;e<Q.length;e++)Q[e].onclick=null;Q=[]}function N(e,t,d,n){fetch("https://api.bilibili.com/x/v2/dm/web/seg.so?type=1&oid="+e+"&pid="+t+"&segment_index="+d,{method:"GET",credentials:"include",body:null}).then(e=>e.arrayBuffer()).then(i=>{const s=new Uint8Array(i);chrome.runtime.sendMessage({msg:"requestDanmaku",danmakuObj:$root.bilibili.community.service.dm.v1.DmSegMobileReply.decode(s).elems},function(e){if(ee.concat(e.danmakuContent),te.concat(e.danmakuContent),$+=e.danmakuPoolSize,document.getElementById("rua-danmaku-size").innerText="\u5171"+$+" \u5F39\u5E55",document.getElementById("rua-input-container").setAttribute("style",`width: ${a($+"")}px`),fe.style.height=20*te.size+"px",ae){for(let e=0;20>e;e++)!M(fe,"rua-danmaku-content","rua-danmaku-"+e)&&e<te.size&&te.get(e).look&&fe.appendChild(q(te.get(e).time,te.get(e).content,te.get(e).mid,e));ae=20>te.size}d===n&&(document.getElementById("rua-danmaku-download").setAttribute("style",""),document.getElementById("rua-danmaku-download").innerText="\u5F39\u5E55\u4E0B\u8F7D",G.setTitle(K[0]+(1===K.length?"":K[X+1])))}),d<n&&(d++,N(e,t,d,n))}).catch(e=>{console.log(e)})}function F(t){return e(t/36e4)}function j(e){let t=Math.floor(e/20)-5;for(;fe.hasChildNodes();)fe.firstChild.onmousedown=null,fe.removeChild(fe.firstChild);for(let a=0;25>a;a++)void 0!==te.get(t+a)&&fe.appendChild(q(te.get(a+t).time,te.get(a+t).content,te.get(a+t).mid,a+t))}function q(e,t,a,d){const n=document.createElement("div"),i=document.createElement("span"),s=document.createElement("span"),l=document.createElement("span"),o=e.split(":"),u=[1,60,3600];let c=0;for(let n=o.length-1;0<=n;n--)c+=(o[o.length-1-n]-1+1)*u[n];return n.setAttribute("title",t),n.setAttribute("id","rua-danmaku-"+d),n.style.top=20*d+"px",n.classList.add("rua-danmaku-content"),i.setAttribute("class","seek-video rua-danmaku-time"),i.setAttribute("data-time",c),i.innerText=e,n.appendChild(i),s.classList.add("rua-danmaku"),s.innerText=t,n.appendChild(s),l.classList.add("rua-danmaku-copy"),l.innerText="\u590D\u5236",n.appendChild(l),i.onclick=t=>{document.getElementsByTagName("video")[0].currentTime=c},s.onmousedown=function(t){0===t.button&&z(document.body,a,ue.style.left.replace("px","")-1+1,t.clientY-140,d)},l.onmousedown=function(t){r(s.innerText,"\u5F39\u5E55\u5DF2\u590D\u5236\u5230\u7C98\u8D34\u677F",`rua-danmaku-${d}`,-200,-me.scrollTop-18)},n}async function z(t,a,d,n,i){const s=document.createElement("div");s.setAttribute("class","rua-danmaku-user-info"),s.setAttribute("style","top:"+n+"px;left:"+d+"px;");const e=document.createElement("div");e.setAttribute("class","rua-danmaku-user-host");const l=document.createElement("div");l.setAttribute("id","rua-user-control-bar"),l.innerHTML="<b style=\"padding-left: 20px;\">\u7528\u6237\u4FE1\u606F</b>";const o=document.createElement("div");if(o.setAttribute("style","position: absolute; top: 2px; left: 280px; width: 14px; height: 14px;"),o.innerHTML="<svg width=\"14\" height=\"14\"><circle cx=\"7\" cy=\"7\" r=\"7\" fill=\"#f16c59\"/><line class=\"rua-cross\" x1=\"4\" y1=\"4\" x2=\"10.5\" y2=\"10.5\" style=\"stroke:#ff5e57;stroke-width:1\"/><line class=\"rua-cross\" x1=\"10.5\" y1=\"4\" x2=\"4\" y2=\"10.5\" style=\"stroke:#ff5e57;stroke-width:1\"/></svg>",l.appendChild(o),0<document.body.getElementsByClassName("rua-danmaku-user-info").length){o.onmouseenter=null,o.onmouseleave=null,o.onmousedown=null,document.getElementById("app").onmousedown=null;for(let e=0;e<document.body.getElementsByClassName("rua-danmaku-user-info").length;e++)document.body.removeChild(document.body.getElementsByClassName("rua-danmaku-user-info")[e])}o.onmouseenter=()=>{for(let e=0;e<o.getElementsByClassName("rua-cross").length;e++)o.getElementsByClassName("rua-cross")[e].style.stroke="#A0000A"},o.onmouseleave=()=>{for(let e=0;e<o.getElementsByClassName("rua-cross").length;e++)o.getElementsByClassName("rua-cross")[e].style.stroke="#ff5e57"},o.onmousedown=a=>{0===a.button&&(o.onmouseenter=null,o.onmouseleave=null,o.onmousedown=null,document.getElementById("app").onmousedown=null,t.removeChild(s))};const u=document.createElement("div");u.setAttribute("id","rua-user-host"),u.classList.add("emoji_sec"),chrome.runtime.sendMessage({msg:"requestCrackUID",mid:a},a=>{for(let e=0;e<a.response.length;e++)chrome.runtime.sendMessage({msg:"requestUserInfo",mid:a.response[e]},t=>{if(0!==t.response.fans||0!==t.response.friend||2<=t.response.level_info.current_level||1===a.response.length||"undefined"!=typeof a.response){const d=document.createElement("div");d.setAttribute("class","rua-user");const n=document.createElement("a"),i=document.createElement("img");n.href="https://space.bilibili.com/"+a.response[e],n.target="_Blank",n.setAttribute("class","rua-user-avatar"),i.classList.add("bili-avatar-img"),i.setAttribute("src",t.response.face.replace("http://","https://")),n.appendChild(i),d.appendChild(n);const s=document.createElement("div");s.setAttribute("style","padding-left: 50px; padding-top: 9px;min-width: 100px;");const l=document.createElement("a");l.href="https://space.bilibili.com/"+a.response[e],l.target="_Blank";const o=document.createElement("b");o.innerText=t.response.name;const r=document.createElement("a");r.href="https://space.bilibili.com/"+a.response[e],r.target="_Blank",r.innerText="uid: "+a.response[e];const c=document.createElement("br");l.appendChild(o),s.appendChild(l),s.appendChild(c),s.appendChild(r),d.appendChild(s),u.appendChild(d)}});e.appendChild(l),e.appendChild(u),s.appendChild(e),t.appendChild(s),document.getElementById("app").onmousedown=()=>{o.onmouseenter=null,o.onmouseleave=null,o.onmousedown=null,document.getElementById("app").onmousedown=null,t.removeChild(s)}})}function M(e,t,a){for(let d=0;d<e.getElementsByClassName(t).length;d++)if(e.getElementsByClassName(t)[d].id===a)return!0;return!1}function O(e){const t=document.getElementById("bilibili-player").querySelector(".bpx-player-cmd-dm-wrap");t.style.display=e?"none":"unset"}const U=chrome.runtime.getURL("../images/haruka/abaaba.svg"),H=chrome.runtime.getURL("../ffmpeg/ffmpeg-core.wasm"),G=new AssConvert(1280,720);var D=window.location.pathname.replaceAll("/","").replace("video","").replace("bangumi","").replace("play","");window.location.pathname.includes("festival")&&window.location.search.includes("bvid")&&(D=new URLSearchParams(window.location.search).get("bvid"));var V,P,Y="",W="0",X=null===new URLSearchParams(window.location.search).get("p")?0:new URLSearchParams(window.location.search).get("p")-1,J=[],K=[],Q=[],Z=0,$=0,ee=new DanmakuArr,te=new DanmakuArr,ae=!0,de=window.innerWidth,ne=[];let ie;chrome.storage.sync.get(["squareCover","hiddenOnVideoBtn"],e=>{ie=e.squareCover,O(e.hiddenOnVideoBtn)}),chrome.storage.onChanged.addListener((e,t)=>{for(let[a,{oldValue:d,newValue:n}]of Object.entries(e))"squareCover"===a&&(ie=n),"hiddenOnVideoBtn"===a&&O(n)});new MutationObserver(()=>{const e=new URLSearchParams(window.location.search).get("p")-1;let t=window.location.pathname.replaceAll("/","").replace("video","").replace("bangumi","").replace("play","");null!==new URLSearchParams(window.location.search).get("p")&&X!==e&&(X=e,y(J[e])),window.location.pathname.includes("festival")&&window.location.search.includes("bvid")&&(t=new URLSearchParams(window.location.search).get("bvid")),null!==t&&t!==D&&(D=t,u())}).observe(document,{subtree:!0,childList:!0}),t();var se=!1,le=[100,100,100];const oe=document.body,re=document.createElement("div"),ue=document.createElement("div"),ce=document.createElement("div");ce.setAttribute("id","rua-video-info"),ce.style.paddingTop="2px";const pe=document.createElement("div");pe.setAttribute("style","display: flex; padding-left:5px; justify-content: space-between;"),ce.appendChild(pe);const me=document.createElement("div");me.setAttribute("id","rua-danmaku"),me.classList.add("emoji_sec");const he=document.createElement("div");he.setAttribute("style","width: 300px; position: fixed;"),he.innerHTML=`<div style='float: left; padding-left: 5px; user-select: none;'><b>弹幕：</b></div><div style='float: right; padding-right: 5px; user-select: none;' id='rua-danmaku-size'>共${$} 弹幕</div><div style='float: right; padding-right: 5px;user-select: none;cursor: pointer' id='rua-danmaku-search' title='查询弹幕内容'><svg width='18' height='18' viewBox='0 0 18 18' xmlns=\"http://www.w3.org/2000/svg\"><circle cx=\"8\" cy=\"8\" r=\"5\" style=\"stroke:#aaa;stroke-width:2; fill: none\"/><line x1=\"11.5\" y1=\"11.5\" x2=\"15\" y2=\"15\" style=\"stroke:#aaa;stroke-width:2\" /></svg></div><div id='rua-input-container' style='width: ${a($+"")}px'><textarea id='rua-danmaku-search-input' class='rua-danmaku-search-out' style='display: none' placeholder='输入要查询的弹幕内容'></textarea></div>`;const fe=document.createElement("div");fe.style.position="relative",me.appendChild(fe);const ye=document.createElement("div");ye.setAttribute("id","rua-download"),ye.classList.add("emoji_sec");const ge=document.createElement("div");ge.setAttribute("style","width: 290px; position: fixed;"),ge.innerHTML=`<div style='float: left; user-select: none; padding-left: 5px'><b>视频下载：</b></div><div id="rua-danmaku-download" style="opacity: 0.8; cursor: not-allowed;" title="将弹幕保存为ass文件">加载中</div><div style="float: right; margin: -2px 10px 0 0"><label for="rua-danmaku-intense"></label><select id="rua-danmaku-intense"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10" selected>10</option></select></div><div style="float: right; margin-right: 5px;">弹幕强度</div></div>`;const be=document.createElement("div");be.setAttribute("style","margin: 0 0 0 15px;"),ye.appendChild(be);const ve=document.createElement("div"),Ee=document.createElement("div");Ee.classList.add("rua-cover"),Ee.innerText="\u4E0B\u8F7D\u5C01\u9762",ve.appendChild(Ee),chrome.storage.sync.get(["popupDisable","popupAlwaysOnTop"],t=>{t.popupDisable&&(re.style.display="none",ue.style.display="none"),t.popupAlwaysOnTop&&(re.classList.add("rua-always-on-top"),ue.classList.add("rua-always-on-top"))}),chrome.storage.onChanged.addListener((e,t)=>{for(let[a,{oldValue:d,newValue:n}]of Object.entries(e))"popupDisable"===a&&(n?(re.style.display="none",ue.style.display="none"):re.style.display="block"),"popupAlwaysOnTop"===a&&(n?(re.classList.add("rua-always-on-top"),ue.classList.add("rua-always-on-top")):(re.classList.remove("rua-always-on-top"),ue.classList.remove("rua-always-on-top")))}),0===document.getElementsByTagName("article").length&&d();var ke=new MutationObserver(function(e){e.forEach(function(e){"attributes"===e.type&&(null===xe.getAttribute("lab-style")?o(!1):(ne=xe.getAttribute("lab-style").split(","),-1===ne.indexOf("dark")?o(!1):o(!0)))})});const xe=document.documentElement;ke.observe(xe,{attributes:!0}),u(),me.onscroll=function(t){20<=te.size&&j(t.target.scrollTop)},document.getElementById("rua-danmaku-search-input").addEventListener("focus",()=>{document.getElementById("rua-danmaku-search-input").style.borderColor="#23ade5"}),document.getElementById("rua-danmaku-search-input").addEventListener("blur",()=>{document.getElementById("rua-danmaku-search-input").style.borderColor="#aaa"}),document.getElementById("rua-danmaku-search-input").addEventListener("input",t=>{te=ee.find(t.target.value),fe.style.height=20*te.size+"px",fe.scrollTop=0,j(0)});let Le=!1;document.getElementById("rua-danmaku-search").onclick=()=>{Le?(Le=!1,document.getElementById("rua-danmaku-search-input").classList.remove("rua-danmaku-search-in"),document.getElementById("rua-danmaku-search-input").classList.add("rua-danmaku-search-out"),setTimeout(()=>{document.getElementById("rua-danmaku-search-input").style.display="none"},800)):(Le=!0,document.getElementById("rua-danmaku-search-input").style.display="block",document.getElementById("rua-danmaku-search-input").classList.remove("rua-danmaku-search-out"),document.getElementById("rua-danmaku-search-input").classList.add("rua-danmaku-search-in"))}}();