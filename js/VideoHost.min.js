!function(){var a=Math.ceil;function b(){S=window.innerHeight*1,T=window.innerWidth*1}function c(a){return 180-8*a.length}function d(){h(),ja.setAttribute("id","emoji-popup"),ja.style.background="url("+O+") no-repeat center",ja.style.backgroundSize="contain",ja.style.cursor="pointer",ja.innerHTML="<!---->",ka.setAttribute("id","emoji-selection"),ka.classList.add("emoji_sec"),ka.style.display="none",ka.innerHTML="",ka.appendChild(la),ka.appendChild(ta),ka.appendChild(oa),ka.appendChild(na),ka.appendChild(ra),ka.appendChild(qa),ia.appendChild(ka),ia.appendChild(ja),ja.style.top=ha[1]+"px",ka.style.top=ha[1]-5+"px";var a=[0,0],c=[0,0];window.onload=function(){ja.onmousedown=function(b){let d,f;document.body.style.userSelect="none",ja.className="popup-click-in";const g=b||event,h=g.clientX-ja.offsetLeft,i=g.clientY-ja.offsetTop;a=[ja.offsetLeft,ja.offsetTop],c=[ja.offsetLeft,ja.offsetTop],document.onmousemove=function(a){const b=a||event;0<=b.clientX-h&&b.clientX-h<=T-70&&(d=b.clientX-h),0<=b.clientY-i&&b.clientY-i<=S-60&&(f=b.clientY-i),c=[d,f],ja.style.left=d+"px",ja.style.top=f+"px",ka.style.left=320>d?d+60+"px":d-310+"px",ka.style.top=f>S-360?S-360+"px":f-5+"px",f===void 0&&(f=ja.offsetTop),-1<d&&(ha=[T-d,f,d])},document.onmouseup=function(){document.body.style.userSelect="auto",ja.className="popup-click-out",e(a[0],a[1],c[0],c[1])?"none"===ka.style.display?(ka.classList.remove("selection-fade-out"),ka.style.display="block",ka.classList.add("selection-fade-in")):(ka.classList.remove("selection-fade-in"),ka.classList.add("selection-fade-out"),setTimeout(()=>{ka.style.display="none"},300)):(ga=!0,localStorage.setItem("rua_pos",ha[0]+","+ha[1]+","+ha[2])),document.onmousemove=null,document.onmouseup=null}},ja.onmouseenter=function(){ja.className="popup-click-hoverin"},ja.onmouseleave=function(){ja.className="popup-click-hoverout"}},window.addEventListener("resize",function(){let a,c=ha[0]<ha[2]?ha[0]/da:ha[2]/da;b(),ga?(a=ha[0]<ha[2]?T-ha[0]:ha[2],ja.style.left=a+"px"):g(),ha[1]>S-60&&(ja.style.top=S-60+"px",ka.style.top=S-360+"px"),ka.style.left=320>a?a+60+"px":a-310+"px"}),document.getElementById("rua-danmaku-download").addEventListener("click",()=>{0===document.getElementById("rua-danmaku-download").getAttribute("style").length&&(Q.feedDanmaku(aa),Q.downloadASS())}),document.getElementById("rua-danmaku-intense").addEventListener("change",function(){let a=this.value-1+1;Q.setWeight(10-a)})}function e(a,b,c,d){var e=Math.abs;return 0===e(a-c)&&0===e(b-d)}function f(a,b,c){let d=document.getElementById(a),e=[d.offsetLeft,d.offsetTop],f=d.offsetParent;for(;null!==f;)e[0]+=f.offsetLeft,e[1]+=f.offsetTop+f.clientTop,f=f.offsetParent;return e[0]+=d.clientWidth+b,e[1]+=d.clientHeight+c,e}function g(){let a=f("danmukuBox",-60,-60);ha=[T-a[0],a[1],a[0]],ha[2]>T-60?(ja.style.left=T-60+"px",ka.style.left=T-370+"px"):(ja.style.left=ha[2]+"px",ka.style.left=ha[2]-310+"px")}function h(){if(null===localStorage.getItem("rua_pos"))g(),ga=!1;else if(localStorage.getItem("rua_pos").includes("undefined"))localStorage.removeItem("rua_pos"),g(),ga=!1;else{ga=!0;for(let a=0;3>a;a++)ha[a]=parseInt(localStorage.getItem("rua_pos").split(",")[a]);let a=0;a=ha[0]<ha[2]?T-ha[0]:ha[2],ha[1]>S-50&&(ha[1]=S-50),ja.style.left=a+"px",ka.style.left=320>a?a+60+"px":a-310+"px"}}function i(a){a?ka.style.background="#151515":ka.style.removeProperty("background")}function j(a,b,c,d,e){const g=document.createElement("div");g.setAttribute("id","rua-copy-tips"),g.setAttribute("style",`opacity: 0; display: block; left: ${f(c,d,e)[0]}px; top: ${f(c,d,e)[1]}px;`),g.innerText=b,document.getElementById("app").appendChild(g),setTimeout(()=>{g.style.opacity="1"},10),setTimeout(()=>{g.style.opacity="0"},1e3),setTimeout(()=>{g.style.display="none",document.getElementById("app").removeChild(g)},1400),navigator.clipboard.writeText(a).catch(b=>{console.log("Failed to access clipboard, using execCommand.");const c=document.createElement("textarea");c.value=a,document.body.appendChild(c),c.select(),document.execCommand("Copy"),c.remove()})}function k(){W=0>W?0:W,X=[],Y=[],document.getElementById("rua-danmaku-size").innerText="\u51710 \u5F39\u5E55",na.getElementsByTagName("div")[0].style.height="0px","ss"!==R.substring(0,2)&&"ep"!==R.substring(0,2)?fetch("https://api.bilibili.com/x/web-interface/view?"+o(R),{method:"GET",credentials:"include",body:null}).then(a=>a.json()).then(a=>{if(0===a.code){U=a.data.aid,V=a.data.bvid,Y.push(a.data.title);for(let b=0;b<a.data.pages.length;b++)X.push(a.data.pages[b].cid),1<a.data.pages.length&&Y.push(a.data.pages[b].part);m(a.data.pic),q(X[W])}}):(document.getElementById("emoji-selection").style.fontSize="12px",console.log(document.querySelector("link[rel=\"canonical\"]").href.replace("https://www.bilibili.com/bangumi/play/","")),l(document.querySelector("link[rel=\"canonical\"]").href.replace("https://www.bilibili.com/bangumi/play/","")))}function l(a){fetch("https://api.bilibili.com/pgc/view/web/season?"+p(a),{method:"GET",credentials:"include",body:null}).then(a=>a.json()).then(b=>{m(b.result.cover),n(b,a)})}function m(a){ua.onclick=null,ua.onclick=b=>{y(a,"")}}function n(a,b){let c,d;chrome.runtime.sendMessage({msg:"get_LoginStatus"},function(c){if(0===a.code){let e=!1;try{for(let c=0;c<a.result.episodes.length;c++)if(b.includes(a.result.episodes[c].id+"")){U=a.result.episodes[c].aid,V=a.result.episodes[c].bvid,d=a.result.episodes[c].badge_info.text,Y.push(a.result.season_title+"-"+a.result.episodes[c].long_title),X.push(a.result.episodes[c].cid),e=!0;break}console.log(a.result.section.length);for(let c=0;c<a.result.section.length;c++)if(!e)for(let f=0;f<a.result.section[c].episodes.length;f++)if(b.includes(a.result.section[c].episodes[f].id+"")){U=a.result.section[c].episodes[f].aid,V=a.result.section[c].episodes[f].bvid,d=a.result.section[c].episodes[f].badge_info.text,Y.push(a.result.season_title+a.result.section[c].episodes[f].long_title),X.push(a.result.section[c].episodes[f].cid),e=!0;break}}catch(a){console.log(a)}e&&q(X[0],""===d||"\u9650\u514D"===d||"\u4F1A\u5458"===d&&0<c.vip?"":`<span class="rua-video-right-info">${"\u4F1A\u5458"===d?"\u6B64\u89C6\u9891\u9700\u8981\u5927\u4F1A\u5458":"\u60A8\u6240\u5728\u7684\u5730\u533A\u65E0\u6CD5\u89C2\u770B\u672C\u7247"}。</span>`)}})}function o(a){let b="AaBb",c="Vv";if("AaBb".includes(a.charAt(0))&&c.includes(a.charAt(1)))return"AaBb".substr(0,2).includes(a.charAt(0))?"aid="+a.replace("av",""):"bvid="+a}function p(a){return(a=a.toUpperCase(),"SS"===a.substring(0,2))?"season_id="+a.replace("SS",""):"EP"===a.substring(0,2)?"ep_id="+a.replace("EP",""):void 0}function q(a,b=``){for(ma.innerHTML=`<b style='user-select: none'>视频ID：</b><div style="display: flex; margin-left: -45px"><span>av${U}</span><span style='user-select: none; margin: 0 2px'>/</span><span>cid:${a}</span><span title="复制ID" class="rua-video-info-copy" id="rua-video-info-copy"><svg viewBox="0 0 400 400" width="18" height="18" style="position: absolute" xmlns="http://www.w3.org/2000/svg"><rect width="400" height="400" fill='#aaa' mask='url(#rua-copy-mask)'/><mask id="rua-copy-mask"><rect x='150' y='40' rx="20" ry="20" width="200" height="280" style="fill:#fff" /><rect x="190" y="110" width="120" height="20" fill="black"/><rect x="190" y="160" width="120" height="20" fill="black"/><rect x="190" y="210" width="120" height="20" fill="black"/><rect x='55' y='75' rx="20" ry="20" width="200" height="280" style="fill:#000"/><rect x='50' y='80' rx="20" ry="20" width="200" height="280" style="fill:#fff"/><rect x="90" y="150" width="120" height="20" fill="black"/><rect x="90" y="200" width="120" height="20" fill="black"/><rect x="90" y="250" width="120" height="20" fill="black"/></mask></svg></span></div><div style="padding-right:5px; user-select: none;">${W-0+1}p/${X.length}p</div>`,document.getElementById("rua-video-info-copy").addEventListener("click",()=>{j(`av号: av${U}\r\nBV号: ${V}\r\ncid: ${a}`,"\u89C6\u9891ID\u5DF2\u590D\u5236\u5230\u7C98\u8D34\u677F","rua-video-info-copy",-75,18)}),G(),sa.innerHTML=b,$=0,_=0,aa=new DanmakuArr,ba=new DanmakuArr,document.getElementById("rua-danmaku-search-input").value="";pa.hasChildNodes();)pa.firstChild.onmousedown=null,pa.removeChild(pa.firstChild);ca=!0,fetch("https://api.bilibili.com/x/player/playurl?bvid="+V+"&cid="+a+"&qn=120&type=flv&fourk=1",{method:"GET",credentials:"include",body:null}).then(a=>a.json()).then(async b=>{if(-404===b.code&&(oa.style.display="none",na.style.display="none",ra.style.display="none"),0===b.code){await chrome.runtime.sendMessage({msg:"get_LoginStatus"},function(a){}),await s(a);for(let a=0;a<b.data.durl.length;a++)$+=b.data.durl[a].length-1+1;r(a,!0,!0,!0),H(a,U,1,I($))}})}function r(a,b,c,d){fetch("https://api.bilibili.com/x/player/playurl?bvid="+V+"&cid="+a+"&qn=120&fnval=272",{method:"GET",credentials:"include",body:null}).then(a=>a.json()).then(e=>{if(0===e.code&&null!==e.data&&null!==e.data.dash&&e.data.dash!==void 0){try{null!==e.data.dash.flac.audio.base_url&&d&&u(a,"flac","Hi-Res",0)}catch(a){}null!==e.data.dash.dolby.audio&&b&&u(a,"dolby","\u675C\u6BD4\u5168\u666F\u58F0",0),null!==e.data.dash.audio[0].base_url&&c&&u(a,"audio","\u97F3\u9891",0)}})}async function s(a){await fetch(`https://api.bilibili.com/x/player/playurl?bvid=${V}&cid=${a}&qn=127&fourk=1&fnver=0&fnval=4048`,{method:"GET",credentials:"include",body:null}).then(a=>a.json()).then(b=>{if(0===b.code){let c=b.data.accept_description,d=b.data.accept_quality;for(let b=0;b<d.length;b++)u(a,"dash",c[b],d[b]-0)}})}function t(){return fetch(`https://api.bilibili.com/x/web-interface/view?bvid=${V}`,{method:"GET",credentials:"include",body:null}).then(a=>a.json()).then(a=>{if(0===a.code)return"undefined"==typeof a.data.pic||null===a.data.pic||""===a.data.pic?a.data.owner.face.replace("http://","https://"):a.data.pic.replace("http://","https://");throw"error"}).catch(a=>"")}function u(b,c,d,e){const f=[`https://api.bilibili.com/x/player/playurl?bvid=${V}&cid=${b}&qn=125&fnval=336`,`https://api.bilibili.com/x/player/playurl?bvid=${V}&cid=${b}&qn=120&fnval=272`,`https://api.bilibili.com/x/player/playurl?cid=${b}&bvid=${V}&qn=127&fourk=1&fnver=0&fnval=4048`];let g=document.createElement("div");g.setAttribute("id",`qn-${c}`),g.classList.add("rua-download-block"),g.innerHTML=`<div class='rua-quality-des' title='${d}'>${d}</div>`,sa.appendChild(g),Z.push(g),sa.style.height=40*a(Z.length/3)+"px";let h=new AbortController;g.onclick=async()=>{if(!g.classList.contains("rua-downloading")){h=new AbortController,g.classList.add("rua-downloading"),g.getElementsByClassName("rua-quality-des")[0].innerText=`取流中...`;let a=[];await fetch("hdr"===c?f[0]:"8k"===c||"dash"===c?f[2]:f[1],{method:"GET",credentials:"include",body:null}).then(a=>a.json()).then(b=>{if(0===b.code&&null!==b.data)switch(c){case"hdr":a[0]=b.data.dash.video[0].base_url,a[1]=null===b.data.dash.dolby.audio?null!==b.data.dash.flac&&null!==b.data.dash.flac.audio?b.data.dash.flac.audio.base_url:b.data.dash.audio[0].base_url:b.data.dash.dolby.audio[0].base_url;break;case"audio":a[0]=b.data.dash.audio[0].base_url;break;case"dolby":a[0]=b.data.dash.dolby.audio[0].base_url;break;case"flac":a[0]=b.data.dash.flac.audio.base_url;break;case"8k":a[0]=b.data.dash.video[0].base_url,a[1]=null===b.data.dash.dolby.audio?null!==b.data.dash.flac&&null!==b.data.dash.flac.audio?b.data.dash.flac.audio.base_url:b.data.dash.audio[0].base_url:b.data.dash.dolby.audio[0].base_url;break;case"dash":let c=0,d="";for(let a=0;a<b.data.dash.video.length;a++)b.data.dash.video[a].bandwidth>c&&b.data.dash.video[a].id===e&&(c=b.data.dash.video[a].bandwidth,d=b.data.dash.video[a].base_url);a[0]=d,a[1]=null===b.data.dash.dolby.audio?null!==b.data.dash.flac&&null!==b.data.dash.flac.audio?b.data.dash.flac.audio.base_url:b.data.dash.audio[0].base_url:b.data.dash.dolby.audio[0].base_url;break;default:}}),await x(a,Y[0]+(1===Y.length?"":" "+Y[W+1]),b,g,c+"Record",!0,h)}else h.abort("User"),w(g)},v(g)}function v(a){a.onmouseenter=()=>{if(a.classList.contains("rua-downloading")){let b=a.getElementsByTagName("div")[0].innerText;a.getElementsByTagName("div")[0].innerText="\u53D6\u6D88\u4E0B\u8F7D",a.onmouseleave=()=>{a.classList.contains("rua-downloading")&&(a.getElementsByTagName("div")[0].innerText=b),a.onmouseleave=null}}}}function w(a){a.getElementsByTagName("div")[0].innerText=a.getElementsByTagName("div")[0].getAttribute("title"),a.removeAttribute("style"),a.classList.remove("rua-downloading")}async function x(a,b,c,d,e,f=!0,g){function h(){d.removeAttribute("style"),d.classList.remove("rua-downloading"),d.getElementsByClassName("rua-quality-des")[0].innerText=k,window.URL.revokeObjectURL(l[0]),("hdrRecord"===e||"8kRecord"===e)&&window.URL.revokeObjectURL(l[1])}let i=new AbortController,j=0,k=d.getElementsByClassName("rua-quality-des")[0].getAttribute("title"),l=[],m={};await fetch(a[0],{method:"GET",body:null,signal:i.signal}).then(a=>{j=a.headers.get("Content-Length"),i.abort()}),f?j<1610612736?(l[0]=await D(a[0],d,c,k,"hdrRecord"===e||"8kRecord"===e||"dashRecord"===e?"\u89C6\u9891":"",!0,g),("hdrRecord"===e||"8kRecord"===e||"dashRecord"===e)&&!g.signal.aborted&&(l[1]=await D(a[1],d,c,k,"\u97F3\u9891",!0,g)),("audioRecord"===e||"flacRecord"===e)&&(m=await C(),l[1]=await t(),fa&&(l[1]=await z(l[1]))),!g.signal.aborted&&A(l,b,e,m).then(a=>{h()})):(l[0]=await D(a[0],d,c,k,"hdrRecord"===e||"8kRecord"===e||"dashRecord"===e?"\u89C6\u9891":"",!1,g),y(l[0],b+".mp4"),("hdrRecord"===e||"8kRecord"===e||"dashRecord"===e)&&!g.signal.aborted&&(l[1]=await D(a[1],d,c,k,"\u97F3\u9891",!1,g),y(l[1],b+".m4a")),h()):(l[0]=await D(a[0],d,c,k,e.includes(":")?"\u5206\u6BB5"+e.split(":")[1]:"\u89C6\u9891",!1,g),y(l[0],b+".flv"),h())}function y(b,c){if("undefined"!=typeof b&&!b.includes("undefined")){const d=document.createElement("a");d.href=b,d.target="_blank",d.style.display="none",d.download=c,document.body.appendChild(d),d.click(),document.body.removeChild(d)}}function z(a){return new Promise((b,c)=>{const d=new Image;d.src=a,d.crossOrigin="anonymous";const e=document.createElement("canvas"),f=e.getContext("2d");d.onload=()=>{const a=d.width>d.height?d.height:d.width,c=(d.width-a)/2,g=(d.height-a)/2;e.width=a,e.height=a,f.drawImage(d,c,g,a,a,0,0,a,a),e.toBlob(a=>{b(URL.createObjectURL(a))})}})}async function A(a,b,c,d){let e,f,g;const{createFFmpeg:h,fetchFile:i}=FFmpeg,j=h({corePath:P,mainName:"main",log:!1});await j.load(),"audioRecord"===c&&(j.FS("writeFile","audio.m4s",await i(a[0])),0<a[1].length?(console.log(a[1]),console.log(`cover.${a[1].substring(a[1].length-3)}`),j.FS("writeFile",`cover`,await i(a[1])),await j.run("-i","audio.m4s","-i",`cover`,"-map","0","-map","1","-c","copy","-disposition:v:0","attached_pic","-metadata",`title=${B(d.title)}`,"-metadata",`artist=${B(d.artist)}`,"-metadata",`year="${d.year}"`,"-metadata",`comment=${V}`,"final.m4a")):await j.run("-i","audio.m4s","-c","copy","-metadata",`title=${B(d.title)}`,"-metadata",`artist=${B(d.artist)}`,"-metadata",`year="${d.year}"`,"-metadata",`comment=${V}`,"final.m4a"),e=j.FS("readFile","final.m4a"),f=b+".m4a",g=URL.createObjectURL(new Blob([e.buffer],{type:"audio/mp4"}))),"dolbyRecord"===c&&(j.FS("writeFile","audio.m4s",await i(a[0])),await j.run("-i","audio.m4s","-c","copy","final.mp4"),e=j.FS("readFile","final.mp4"),f=b+".mp4",g=URL.createObjectURL(new Blob([e.buffer],{type:"audio/mp4"}))),"flacRecord"===c&&(0<a[1].length?(j.FS("writeFile","audio.m4s",await i(a[0])),j.FS("writeFile",`cover`,await i(a[1])),await j.run("-i","audio.m4s","-i",`cover`,"-map","0","-map","1","-c:v","copy","-disposition:v:0","attached_pic","-c:a","alac","-metadata",`title=${B(d.title)}`,"-metadata",`artist=${B(d.artist)}`,"-metadata",`year="${d.year}"`,"-metadata",`comment=${V}`,"final.m4a")):await j.run("-i","audio.m4s","-c:a","alac","-metadata",`title=${B(d.title)}`,"-metadata",`artist=${B(d.artist)}`,"-metadata",`year="${d.year}"`,"-metadata",`comment=${V}`,"final.m4a"),e=j.FS("readFile","final.m4a"),f=b+".m4a",g=URL.createObjectURL(new Blob([e.buffer]))),("hdrRecord"===c||"8kRecord"===c||"dashRecord"===c)&&(j.FS("writeFile","video.m4s",await i(a[0])),j.FS("writeFile","audio.m4s",await i(a[1])),await j.run("-i","video.m4s","-i","audio.m4s","-map","0:v","-map","1:a","-c","copy","final.mkv"),e=j.FS("readFile","final.mkv"),f=b+".mkv",g=URL.createObjectURL(new Blob([e.buffer]))),y(g,f),window.URL.revokeObjectURL(g)}function B(a){let b=new TextEncoder("utf8"),c=b.encode(a),d="";for(let b=0;b<c.length;++b)d+=String.fromCharCode(c[b]);return d}async function C(){return fetch(`https://api.bilibili.com/x/web-interface/view?bvid=${V}`,{method:"GET",credentials:"include",body:null}).then(a=>a.json()).then(a=>{if(0===a.code&&null!==a.data){let b="";if(null===a.data.staff||a.data.staff===void 0)b=a.data.owner.name;else{for(let c of a.data.staff)b+=c.name+", ";b=b.slice(0,b.length-2)}return{title:a.data.title,artist:b,year:new Date(1e3*(a.data.pubdate-1+1)).getFullYear(),cover:a.data.pic,desc:a.data.desc}}return null}).catch(a=>{})}async function D(a,b,c,d,e,f,g){let h=0,i=0;return fetch(a,{method:"GET",body:null,signal:g.signal}).then(a=>(b.getElementsByClassName("rua-quality-des")[0].innerText=`下载${e}中...`,h=a.headers.get("Content-Length"),a.body)).then(a=>{const c=a.getReader();return new Response(new ReadableStream({async start(a){function d(){return c.read().then(async c=>{const{done:e,value:g}=c;return e&&(a.close(),f&&(b.getElementsByClassName("rua-quality-des")[0].innerText="\u8F6C\u7801\u4E2D...")),i+=g.length||0,E(b,100*(i/h)),a.enqueue(g),d()})}return d()}})).blob()}).then(a=>window.URL.createObjectURL(a)).catch(a=>{g.signal.aborted||F(b,c,a.toString(),!1,d)})}function E(a,b){a.setAttribute("style","background: linear-gradient(to right, var(--bili-blue) 0%, var(--bili-blue) "+b+"%, var(--bili-pink) "+b+"%, var(--bili-pink));")}function F(a,b,c,d,e){function f(){a.removeAttribute("style"),a.getElementsByClassName("rua-quality-des")[0].innerText=e,a.removeEventListener("click",f)}console.log(c),a.classList.remove("rua-downloading"),a.setAttribute("style","background: #ff4650;"),a.getElementsByClassName("rua-quality-des")[0].innerText=d?"\u8F6C\u7801\u5931\u8D25":"\u4E0B\u8F7D\u5931\u8D25",a.addEventListener("click",f)}function G(){for(let a=0;a<Z.length;a++)Z[a].onclick=null;Z=[]}function H(a,b,d,e){fetch("https://api.bilibili.com/x/v2/dm/web/seg.so?type=1&oid="+a+"&pid="+b+"&segment_index="+d,{method:"GET",credentials:"include",body:null}).then(a=>a.arrayBuffer()).then(f=>{const g=new Uint8Array(f);chrome.runtime.sendMessage({msg:"requestDanmaku",danmakuObj:$root.bilibili.community.service.dm.v1.DmSegMobileReply.decode(g).elems},function(a){if(aa.concat(a.danmakuContent),ba.concat(a.danmakuContent),_+=a.danmakuPoolSize,document.getElementById("rua-danmaku-size").innerText="\u5171"+_+" \u5F39\u5E55",document.getElementById("rua-input-container").setAttribute("style",`width: ${c(_+"")}px`),pa.style.height=20*ba.size+"px",ca){for(let a=0;20>a;a++)!M(pa,"rua-danmaku-content","rua-danmaku-"+a)&&a<ba.size&&ba.get(a).look&&pa.appendChild(K(ba.get(a).time,ba.get(a).content,ba.get(a).mid,a));ca=20>ba.size}d===e&&(document.getElementById("rua-danmaku-download").setAttribute("style",""),document.getElementById("rua-danmaku-download").innerText="\u5F39\u5E55\u4E0B\u8F7D",Q.setTitle(Y[0]+(1===Y.length?"":Y[W+1])))}),d<e&&(d++,H(a,b,d,e))}).catch(a=>{console.log(a)})}function I(b){return a(b/36e4)}function J(a){let b=Math.floor(a/20)-5;for(;pa.hasChildNodes();)pa.firstChild.onmousedown=null,pa.removeChild(pa.firstChild);for(let c=0;25>c;c++)void 0!==ba.get(b+c)&&pa.appendChild(K(ba.get(c+b).time,ba.get(c+b).content,ba.get(c+b).mid,c+b))}function K(a,b,c,d){const e=document.createElement("div"),f=document.createElement("span"),g=document.createElement("span"),h=document.createElement("span"),k=a.split(":"),l=[1,60,3600];let m=0;for(let e=k.length-1;0<=e;e--)m+=(k[k.length-1-e]-1+1)*l[e];return e.setAttribute("title",b),e.setAttribute("id","rua-danmaku-"+d),e.style.top=20*d+"px",e.classList.add("rua-danmaku-content"),f.setAttribute("class","seek-video rua-danmaku-time"),f.setAttribute("data-time",m),f.innerText=a,e.appendChild(f),g.classList.add("rua-danmaku"),g.innerText=b,e.appendChild(g),h.classList.add("rua-danmaku-copy"),h.innerText="\u590D\u5236",e.appendChild(h),f.onclick=a=>{document.getElementsByTagName("video")[0].currentTime=m},g.onmousedown=function(a){0===a.button&&L(document.body,c,ka.style.left.replace("px","")-1+1,a.clientY-140,d)},h.onmousedown=function(a){j(g.innerText,"\u5F39\u5E55\u5DF2\u590D\u5236\u5230\u7C98\u8D34\u677F",`rua-danmaku-${d}`,-200,-na.scrollTop-18)},e}async function L(a,b,c,d,e){const f=document.createElement("div");f.setAttribute("class","rua-danmaku-user-info"),f.setAttribute("style","top:"+d+"px;left:"+c+"px;");const g=document.createElement("div");g.setAttribute("class","rua-danmaku-user-host");const h=document.createElement("div");h.setAttribute("id","rua-user-control-bar"),h.innerHTML="<b style=\"padding-left: 20px;\">\u7528\u6237\u4FE1\u606F</b>";const j=document.createElement("div");if(j.setAttribute("style","position: absolute; top: 2px; left: 280px; width: 14px; height: 14px;"),j.innerHTML="<svg width=\"14\" height=\"14\"><circle cx=\"7\" cy=\"7\" r=\"7\" fill=\"#f16c59\"/><line class=\"rua-cross\" x1=\"4\" y1=\"4\" x2=\"10.5\" y2=\"10.5\" style=\"stroke:#ff5e57;stroke-width:1\"/><line class=\"rua-cross\" x1=\"10.5\" y1=\"4\" x2=\"4\" y2=\"10.5\" style=\"stroke:#ff5e57;stroke-width:1\"/></svg>",h.appendChild(j),0<document.body.getElementsByClassName("rua-danmaku-user-info").length){j.onmouseenter=null,j.onmouseleave=null,j.onmousedown=null,document.getElementById("app").onmousedown=null;for(let a=0;a<document.body.getElementsByClassName("rua-danmaku-user-info").length;a++)document.body.removeChild(document.body.getElementsByClassName("rua-danmaku-user-info")[a])}j.onmouseenter=()=>{for(let a=0;a<j.getElementsByClassName("rua-cross").length;a++)j.getElementsByClassName("rua-cross")[a].style.stroke="#A0000A"},j.onmouseleave=()=>{for(let a=0;a<j.getElementsByClassName("rua-cross").length;a++)j.getElementsByClassName("rua-cross")[a].style.stroke="#ff5e57"},j.onmousedown=b=>{0===b.button&&(j.onmouseenter=null,j.onmouseleave=null,j.onmousedown=null,document.getElementById("app").onmousedown=null,a.removeChild(f))};const k=document.createElement("div");k.setAttribute("id","rua-user-host"),k.classList.add("emoji_sec"),chrome.runtime.sendMessage({msg:"requestCrackUID",mid:b},b=>{for(let a=0;a<b.response.length;a++)chrome.runtime.sendMessage({msg:"requestUserInfo",mid:b.response[a]},c=>{if(0!==c.response.fans||0!==c.response.friend||2<=c.response.level_info.current_level||1===b.response.length||"undefined"!=typeof b.response){const d=document.createElement("div");d.setAttribute("class","rua-user");const e=document.createElement("a"),f=document.createElement("img");e.href="https://space.bilibili.com/"+b.response[a],e.target="_Blank",e.setAttribute("class","rua-user-avatar"),f.classList.add("bili-avatar-img"),f.setAttribute("src",c.response.face.replace("http://","https://")),e.appendChild(f),d.appendChild(e);const g=document.createElement("div");g.setAttribute("style","padding-left: 50px; padding-top: 9px;min-width: 100px;");const h=document.createElement("a");h.href="https://space.bilibili.com/"+b.response[a],h.target="_Blank";const i=document.createElement("b");i.innerText=c.response.name;const j=document.createElement("a");j.href="https://space.bilibili.com/"+b.response[a],j.target="_Blank",j.innerText="uid: "+b.response[a];const l=document.createElement("br");h.appendChild(i),g.appendChild(h),g.appendChild(l),g.appendChild(j),d.appendChild(g),k.appendChild(d)}});g.appendChild(h),g.appendChild(k),f.appendChild(g),a.appendChild(f),document.getElementById("app").onmousedown=()=>{j.onmouseenter=null,j.onmouseleave=null,j.onmousedown=null,document.getElementById("app").onmousedown=null,a.removeChild(f)}})}function M(a,b,c){for(let d=0;d<a.getElementsByClassName(b).length;d++)if(a.getElementsByClassName(b)[d].id===c)return!0;return!1}function N(a){const b=document.getElementById("bilibili-player").querySelector(".bpx-player-cmd-dm-wrap");b.style.display=a?"none":"unset"}const O=chrome.runtime.getURL("../images/haruka/abaaba.svg"),P=chrome.runtime.getURL("../ffmpeg/ffmpeg-core.wasm"),Q=new AssConvert(1280,720);var R=window.location.pathname.replaceAll("/","").replace("video","").replace("bangumi","").replace("play","");window.location.pathname.includes("festival")&&window.location.search.includes("bvid")&&(R=new URLSearchParams(window.location.search).get("bvid"));var S,T,U="",V="0",W=null===new URLSearchParams(window.location.search).get("p")?0:new URLSearchParams(window.location.search).get("p")-1,X=[],Y=[],Z=[],$=0,_=0,aa=new DanmakuArr,ba=new DanmakuArr,ca=!0,da=window.innerWidth,ea=[];let fa;chrome.storage.sync.get(["squareCover","hiddenOnVideoBtn"],a=>{fa=a.squareCover,N(a.hiddenOnVideoBtn)}),chrome.storage.onChanged.addListener((a,b)=>{for(let[c,{oldValue:d,newValue:e}]of Object.entries(a))"squareCover"===c&&(fa=e),"hiddenOnVideoBtn"===c&&N(e)});new MutationObserver(()=>{const a=new URLSearchParams(window.location.search).get("p")-1;let b=window.location.pathname.replaceAll("/","").replace("video","").replace("bangumi","").replace("play","");null!==new URLSearchParams(window.location.search).get("p")&&W!==a&&(W=a,q(X[a])),window.location.pathname.includes("festival")&&window.location.search.includes("bvid")&&(b=new URLSearchParams(window.location.search).get("bvid")),null!==b&&b!==R&&(R=b,k())}).observe(document,{subtree:!0,childList:!0}),b();var ga=!1,ha=[100,100,100];const ia=document.body,ja=document.createElement("div"),ka=document.createElement("div"),la=document.createElement("div");la.setAttribute("id","rua-video-info"),la.style.paddingTop="2px";const ma=document.createElement("div");ma.setAttribute("style","display: flex; padding-left:5px; justify-content: space-between;"),la.appendChild(ma);const na=document.createElement("div");na.setAttribute("id","rua-danmaku"),na.classList.add("emoji_sec");const oa=document.createElement("div");oa.setAttribute("style","width: 300px; position: fixed;"),oa.innerHTML=`<div style='float: left; padding-left: 5px; user-select: none;'><b>弹幕：</b></div><div style='float: right; padding-right: 5px; user-select: none;' id='rua-danmaku-size'>共${_} 弹幕</div><div style='float: right; padding-right: 5px;user-select: none;cursor: pointer' id='rua-danmaku-search' title='查询弹幕内容'><svg width='18' height='18' viewBox='0 0 18 18' xmlns=\"http://www.w3.org/2000/svg\"><circle cx=\"8\" cy=\"8\" r=\"5\" style=\"stroke:#aaa;stroke-width:2; fill: none\"/><line x1=\"11.5\" y1=\"11.5\" x2=\"15\" y2=\"15\" style=\"stroke:#aaa;stroke-width:2\" /></svg></div><div id='rua-input-container' style='width: ${c(_+"")}px'><textarea id='rua-danmaku-search-input' class='rua-danmaku-search-out' style='display: none' placeholder='输入要查询的弹幕内容'></textarea></div>`;const pa=document.createElement("div");pa.style.position="relative",na.appendChild(pa);const qa=document.createElement("div");qa.setAttribute("id","rua-download"),qa.classList.add("emoji_sec");const ra=document.createElement("div");ra.setAttribute("style","width: 290px; position: fixed;"),ra.innerHTML=`<div style='float: left; user-select: none; padding-left: 5px'><b>视频下载：</b></div><div id="rua-danmaku-download" style="opacity: 0.8; cursor: not-allowed;" title="将弹幕保存为ass文件">加载中</div><div style="float: right; margin: -2px 10px 0 0"><label for="rua-danmaku-intense"></label><select id="rua-danmaku-intense"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10" selected>10</option></select></div><div style="float: right; margin-right: 5px;">弹幕强度</div></div>`;const sa=document.createElement("div");sa.setAttribute("style","margin: 0 0 0 15px;"),qa.appendChild(sa);const ta=document.createElement("div"),ua=document.createElement("div");ua.classList.add("rua-cover"),ua.innerText="\u4E0B\u8F7D\u5C01\u9762",ta.appendChild(ua),0===document.getElementsByTagName("article").length&&d();var va=new MutationObserver(function(a){a.forEach(function(a){"attributes"===a.type&&(null===wa.getAttribute("lab-style")?i(!1):(ea=wa.getAttribute("lab-style").split(","),-1===ea.indexOf("dark")?i(!1):i(!0)))})});const wa=document.documentElement;va.observe(wa,{attributes:!0}),k(),na.onscroll=function(a){20<=ba.size&&J(a.target.scrollTop)},document.getElementById("rua-danmaku-search-input").addEventListener("focus",()=>{document.getElementById("rua-danmaku-search-input").style.borderColor="#23ade5"}),document.getElementById("rua-danmaku-search-input").addEventListener("blur",()=>{document.getElementById("rua-danmaku-search-input").style.borderColor="#aaa"}),document.getElementById("rua-danmaku-search-input").addEventListener("input",a=>{ba=aa.find(a.target.value),pa.style.height=20*ba.size+"px",pa.scrollTop=0,J(0)});let xa=!1;document.getElementById("rua-danmaku-search").onclick=()=>{xa?(xa=!1,document.getElementById("rua-danmaku-search-input").classList.remove("rua-danmaku-search-in"),document.getElementById("rua-danmaku-search-input").classList.add("rua-danmaku-search-out"),setTimeout(()=>{document.getElementById("rua-danmaku-search-input").style.display="none"},800)):(xa=!0,document.getElementById("rua-danmaku-search-input").style.display="block",document.getElementById("rua-danmaku-search-input").classList.remove("rua-danmaku-search-out"),document.getElementById("rua-danmaku-search-input").classList.add("rua-danmaku-search-in"))}}();