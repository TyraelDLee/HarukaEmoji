!function(){function a(){L=window.innerHeight*aa,M=window.innerWidth*aa}function b(a){return 180-8*a.length}function c(a,b,c,d){var e=Math.abs;return 0===e(a-c)&&0===e(b-d)}function d(a,b,c){let d=document.getElementById(a),e=[d.offsetLeft,d.offsetTop],f=d.offsetParent;for(;null!==f;)e[0]+=f.offsetLeft,e[1]+=f.offsetTop+f.clientTop,f=f.offsetParent;return e[0]+=d.clientWidth+b,e[1]+=d.clientHeight+c,e}function e(){let a=d("danmukuBox",-60,-60);da=[M-a[0],a[1],a[0]],da[2]>M-60?(fa.style.left=M-60+"px",ga.style.left=M-370+"px"):(fa.style.left=da[2]+"px",ga.style.left=da[2]-310+"px")}function f(){if(null===localStorage.getItem("rua_pos"))e(),ca=!1;else if(localStorage.getItem("rua_pos").includes("undefined"))localStorage.removeItem("rua_pos"),e(),ca=!1;else{ca=!0;for(let a=0;3>a;a++)da[a]=parseInt(localStorage.getItem("rua_pos").split(",")[a]);let a=0;a=da[0]<da[2]?M-da[0]:da[2],da[1]>L-50&&(da[1]=L-50),fa.style.left=a+"px",ga.style.left=320>a?a+60+"px":a-310+"px"}}function g(a){a?ga.style.background="#151515":ga.style.removeProperty("background")}function h(a,b,c,e,f){const g=document.createElement("div");g.setAttribute("id","rua-copy-tips"),g.setAttribute("style",`opacity: 0; display: block; left: ${d(c,e,f)[0]}px; top: ${d(c,e,f)[1]}px;`),g.innerText=b,document.getElementById("app").appendChild(g),setTimeout(()=>{g.style.opacity="1"},10),setTimeout(()=>{g.style.opacity="0"},1e3),setTimeout(()=>{g.style.display="none",document.getElementById("app").removeChild(g)},1400),navigator.clipboard.writeText(a).catch(()=>{console.log("Failed to access clipboard, using execCommand.");const b=document.createElement("textarea");b.value=a,document.body.appendChild(b),b.select(),document.execCommand("Copy"),b.remove()})}function i(){if(Q=0>Q?0:Q,R=[],T=[],document.getElementById("rua-danmaku-size").innerText="\u51710 \u5F39\u5E55",ka.getElementsByTagName("div")[0].style.height="0px","ss"!==N.substring(0,2)&&"ep"!==N.substring(0,2))fetch("https://api.bilibili.com/x/web-interface/view?"+k(N),{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((a)=>{if(0===a.code){O=a.data.aid,P=a.data.bvid,T.push(a.data.title);for(let b=0;b<a.data.pages.length;b++)R.push(a.data.pages[b].cid),1<a.data.pages.length&&T.push(a.data.pages[b].part);m(R[Q])}});else{document.getElementById("emoji-selection").style.fontSize="12px";let a=!1;for(const b of document.getElementById("media_module").getElementsByClassName("media-right")[0].getElementsByClassName("pub-wrapper")[0].getElementsByTagName("a"))b.classList.contains("av-link")&&(a=!0,fetch("https://api.bilibili.com/pgc/view/web/season?"+l(N),{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((a)=>{j(a,b.innerText)}));if(!a){const a=new MutationObserver((a)=>{a.forEach(function(a){if("childList"===a.type&&void 0!==a.addedNodes[0]&&a.addedNodes[0].classList.contains("av-link")){const b=a.addedNodes[0].innerText;fetch("https://api.bilibili.com/pgc/view/web/season?"+l(N),{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((a)=>{j(a,b)})}})});a.observe(document.getElementById("media_module").getElementsByClassName("media-right")[0].getElementsByClassName("pub-wrapper")[0],{childList:!0})}}}function j(a,b){let c;chrome.runtime.sendMessage({msg:"get_LoginStatus"},function(d){if(0===a.code){let e=!1;for(let d=0;d<a.result.episodes.length;d++)if(a.result.episodes[d].bvid+""===b){O=a.result.episodes[d].aid,P=a.result.episodes[d].bvid,c=a.result.episodes[d].badge_info.text,T.push(a.result.season_title+"-"+a.result.episodes[d].long_title),R.push(a.result.episodes[d].cid),e=!0;break}if(!e)for(let d=0;d<a.result.section[0].episodes.length;d++)if(a.result.section[0].episodes[d].bvid+""===b){O=a.result.section[0].episodes[d].aid,P=a.result.section[0].episodes[d].bvid,c=a.result.episodes[d].badge_info.text,T.push(a.result.season_title+"-\u82B1\u7D6E-"+a.result.section[0].episodes[d].long_title),R.push(a.result.section[0].episodes[d].cid),e=!0;break}if(!e)for(let d=0;d<a.result.section[1].episodes.length;d++)if(a.result.section[1].episodes[d].bvid+""===b){O=a.result.section[1].episodes[d].aid,P=a.result.section[1].episodes[d].bvid,c=a.result.episodes[d].badge_info.text,T.push(a.result.season_title+"-\u4E8C\u521B-"+a.result.section[1].episodes[d].long_title),R.push(a.result.section[1].episodes[d].cid),e=!0;break}e&&m(R[0],""===c||"\u4F1A\u5458"===c&&0<d.vip?"":`<span class="rua-video-right-info">${"\u4F1A\u5458"===c?"\u6B64\u89C6\u9891\u9700\u8981\u5927\u4F1A\u5458":"\u60A8\u6240\u5728\u7684\u5730\u533A\u65E0\u6CD5\u89C2\u770B\u672C\u7247"}。</span>`)}})}function k(a){let b="AaBb";if(b.includes(a.charAt(0))&&"Vv".includes(a.charAt(1)))return b.substr(0,2).includes(a.charAt(0))?"aid="+a.replace("av",""):"bvid="+a}function l(a){return(a=a.toUpperCase(),"SS"===a.substring(0,2))?"season_id="+a.replace("SS",""):"EP"===a.substring(0,2)?"ep_id="+a.replace("EP",""):void 0}function m(a,b=""){for(ia.innerHTML=`<b style='user-select: none'>视频ID：</b><span>av${O}</span><span style='user-select: none'> / </span><span>cid:${a}</span><span title="复制ID" class="rua-video-info-copy" id="rua-video-info-copy"><svg viewBox="0 0 400 400" width="18" height="18" style="position: absolute" xmlns="http://www.w3.org/2000/svg"><rect width="400" height="400" fill='#aaa' mask='url(#rua-copy-mask)'/><mask id="rua-copy-mask"><rect x='150' y='40' rx="20" ry="20" width="200" height="280" style="fill:#fff" /><rect x="190" y="110" width="120" height="20" fill="black"/><rect x="190" y="160" width="120" height="20" fill="black"/><rect x="190" y="210" width="120" height="20" fill="black"/><rect x='55' y='75' rx="20" ry="20" width="200" height="280" style="fill:#000"/><rect x='50' y='80' rx="20" ry="20" width="200" height="280" style="fill:#fff"/><rect x="90" y="150" width="120" height="20" fill="black"/><rect x="90" y="200" width="120" height="20" fill="black"/><rect x="90" y="250" width="120" height="20" fill="black"/></mask></svg></span>`,ja.innerText=Q-1+2+"p/"+R.length+"p",document.getElementById("rua-video-info-copy").addEventListener("click",()=>{h(`av号: av${O}\r\nBV号: ${P}\r\ncid: ${a}`,"\u89C6\u9891ID\u5DF2\u590D\u5236\u5230\u7C98\u8D34\u677F","rua-video-info-copy",-75,18)}),A(),pa.innerHTML=b,V=0,W=0,X=new DanmakuArr,Y=new DanmakuArr,document.getElementById("rua-danmaku-search-input").value="";ma.hasChildNodes();)ma.firstChild.onmousedown=null,ma.removeChild(ma.firstChild);Z=!0,fetch("https://api.bilibili.com/x/player/playurl?bvid="+P+"&cid="+a+"&qn=120&type=flv&fourk=1",{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then(async(b)=>{if(0===b.code){await chrome.runtime.sendMessage({msg:"get_LoginStatus"},function(a){ba=a}),await p(a,125,"hdr","HDR"),await p(a,127,"8k","8K \u8D85\u9AD8\u6E05");for(let a=0;a<b.data.durl.length;a++)V+=b.data.durl[a].length-1+1;for(let c=0;c<b.data.support_formats.length;c++){S[c]={accept_description:b.data.support_formats[c].new_description,accept_format:b.data.support_formats[c].quality};let d=document.createElement("div");d.setAttribute("id","qn-"+S[c].accept_format),d.classList.add("rua-download-block"),d.innerHTML=`<div class='rua-quality-des' title='${S[c].accept_description}'>${S[c].accept_description}</div>`,(!ba.login&&63<S[c].accept_format-0||ba.login&&0===ba.vip&&80<S[c].accept_format-0)&&d.classList.add("rua-download-block-disabled"),pa.appendChild(d),U.push(d),d.onclick=()=>{d.classList.contains("rua-downloading")||(d.classList.add("rua-downloading"),!d.classList.contains("rua-download-block-disabled")&&y(P,a,b.data.accept_quality[c],T[0]+(1===T.length?"":T[Q+1])+" "+S[c].accept_description,d))}}pa.style.height=40*H(U.length/3)+"px",n(a,!0,!0),B(a,O,1,C(V))}})}function n(a,b,c){fetch("https://api.bilibili.com/x/player/playurl?bvid="+P+"&cid="+a+"&qn=120&fnval=272",{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((d)=>{0===d.code&&null!==d.data&&null!==d.data.dash&&d.data.dash!==void 0&&(null!==d.data.dash.dolby&&b&&o(a,"dolby","\u675C\u6BD4\u5168\u666F\u58F0"),null!==d.data.dash.audio[0].base_url&&c&&o(a,"audio","Sound Only"))})}function o(a,b,c){const d=[`https://api.bilibili.com/x/player/playurl?bvid=${P}&cid=${a}&qn=125&fnval=336`,`https://api.bilibili.com/x/player/playurl?bvid=${P}&cid=${a}&qn=120&fnval=272`,`https://api.bilibili.com/x/player/playurl?cid=${a}&bvid=${P}&qn=127&fourk=1&fnver=0&fnval=4048`];let e=document.createElement("div");e.setAttribute("id",`qn-${b}`),e.classList.add("rua-download-block"),e.innerHTML=`<div class='rua-quality-des' title='${c}'>${c}</div>`,pa.appendChild(e),U.push(e),pa.style.height=40*H(U.length/3)+"px",e.onclick=async()=>{if(!e.classList.contains("rua-downloading")){e.classList.add("rua-downloading"),e.getElementsByClassName("rua-quality-des")[0].innerText=`取流中...`;let c=[];await fetch("hdr"===b?d[0]:"8k"===b?d[2]:d[1],{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((a)=>{if(0===a.code&&null!==a.data)switch(b){case"hdr":c[0]=a.data.dash.video[0].base_url,c[1]=null===a.data.dash.dolby?a.data.dash.audio[0].base_url:a.data.dash.audio[0].base_url;break;case"audio":c[0]=a.data.dash.audio[0].base_url;break;case"dolby":c[0]=a.data.dash.dolby.audio[0].base_url;break;case"8k":c[0]=a.data.dash.video[0].base_url,c[1]=null===a.data.dash.dolby?a.data.dash.audio[0].base_url:a.data.dash.audio[0].base_url;break;default:}}),await q(c,T[0]+(1===T.length?"":" "+T[Q+1]),a,e,b+"Record")}}}async function p(a,b,c,d){await fetch(`https://api.bilibili.com/x/player/playurl?bvid=${P}&cid=${a}&qn=${b}&fourk=1&fnver=0&fnval=4048`,{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((e)=>{0===e.code&&null!==e.data&&null!==e.data.dash&&e.data.dash!==void 0&&e.data.dash.video[0].id===b&&o(a,c,d)})}async function q(a,b,c,d,e,f=!0){function g(){d.removeAttribute("style"),d.classList.remove("rua-downloading"),d.getElementsByClassName("rua-quality-des")[0].innerText=j,window.URL.revokeObjectURL(k[0]),("hdrRecord"===e||"8kRecord"===e)&&window.URL.revokeObjectURL(k[1])}let h=new AbortController,i=0,j=d.getElementsByClassName("rua-quality-des")[0].getAttribute("title"),k=[],l={};await fetch(a[0],{method:"GET",body:null,signal:h.signal}).then((a)=>{i=a.headers.get("Content-Length"),h.abort()}),f?i<1610612736?(k[0]=await v(a[0],d,c,j,"hdrRecord"===e||"8kRecord"===e?"\u89C6\u9891":"",!0),("hdrRecord"===e||"8kRecord"===e)&&(k[1]=await v(a[1],d,c,j,"\u97F3\u9891",!0)),"audioRecord"===e&&(l=await u()),s(k,b,e,l).then(()=>{g()})):(k[0]=await v(a[0],d,c,j,"hdrRecord"===e||"8kRecord"===e?"\u89C6\u9891":"",!1),r(k[0],b+".mp4"),("hdrRecord"===e||"8kRecord"===e)&&(k[1]=await v(a[1],d,c,j,"\u97F3\u9891",!1),r(k[1],b+".m4a")),g()):(k[0]=await v(a[0],d,c,j,e.includes(":")?"\u5206\u6BB5"+e.split(":")[1]:"\u89C6\u9891",!1),r(k[0],b+".flv"),g())}function r(b,c){if(!b.includes("undefined")){let d=document.createElement("a");d.href=b,d.style.display="none",d.download=c,document.body.appendChild(d),d.click(),document.body.removeChild(d)}}async function s(b,c,d,e){let f,g,h;const{createFFmpeg:i,fetchFile:j}=FFmpeg,k=i({corePath:J,mainName:"main",log:!1});await k.load(),"audioRecord"===d&&(k.FS("writeFile","audio.m4s",(await j(b[0]))),await k.run("-i","audio.m4s","-c","copy","-metadata",`title=${t(e.title)}`,"-metadata",`artist=${t(e.artist)}`,"-metadata",`year=${e.year}`,"final.m4a"),f=k.FS("readFile","final.m4a"),g=c+".m4a",h=URL.createObjectURL(new Blob([f.buffer],{type:"audio/mp4"}))),"dolbyRecord"===d&&(k.FS("writeFile","audio.m4s",(await j(b[0]))),await k.run("-i","audio.m4s","-c","copy","final.mp4"),f=k.FS("readFile","final.mp4"),g=c+".mp4",h=URL.createObjectURL(new Blob([f.buffer],{type:"audio/mp4"}))),("hdrRecord"===d||"8kRecord"===d)&&(k.FS("writeFile","video.m4s",(await j(b[0]))),k.FS("writeFile","audio.m4s",(await j(b[1]))),await k.run("-i","video.m4s","-i","audio.m4s","-map","0:v","-map","1:a","-c","copy","final.mkv"),f=k.FS("readFile","final.mkv"),g=c+".mkv",h=URL.createObjectURL(new Blob([f.buffer])));const l=document.createElement("a");l.style.display="none",l.href=h,l.download=g,document.body.appendChild(l),l.click(),document.body.removeChild(l),window.URL.revokeObjectURL(h)}function t(a){let b=new TextEncoder("utf8"),c=b.encode(a),d="";for(let b=0;b<c.length;++b)d+=String.fromCharCode(c[b]);return d}async function u(){return fetch(`https://api.bilibili.com/x/web-interface/view?bvid=${P}`,{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((a)=>{if(0===a.code&&null!==a.data){let b="";if(null===a.data.staff||a.data.staff===void 0)b=a.data.owner.name;else{for(let c of a.data.staff)b+=c.name+", ";b=b.slice(0,b.length-2)}return{title:a.data.title,artist:b,year:new Date(1e3*(a.data.pubdate-1+1)).getFullYear(),cover:a.data.pic}}return null}).catch(()=>{})}async function v(a,b,c,d,e,f){let g=0,h=0;return fetch(a,{method:"GET",body:null}).then((a)=>(b.getElementsByClassName("rua-quality-des")[0].innerText=`下载${e}中...`,g=a.headers.get("Content-Length"),a.body)).then((a)=>{const c=a.getReader();return new Response(new ReadableStream({async start(a){function d(){return c.read().then(async(c)=>{const{done:e,value:i}=c;return e&&(a.close(),f&&(b.getElementsByClassName("rua-quality-des")[0].innerText="\u8F6C\u7801\u4E2D...")),h+=i.length||0,w(b,100*(h/g)),a.enqueue(i),d()})}return d()}})).blob()}).then((a)=>window.URL.createObjectURL(a)).catch((a)=>{x(b,c,a.toString(),!1,d)})}function w(a,b){a.setAttribute("style","background: linear-gradient(to right, #23ade5 0%, #23ade5 "+b+"%, #fb7299 "+b+"%, #fb7299);")}function x(a,b,c,d,e){function f(){a.removeAttribute("style"),a.getElementsByClassName("rua-quality-des")[0].innerText=e,a.removeEventListener("click",f)}console.log(c),a.classList.remove("rua-downloading"),a.setAttribute("style","background: #ff4650;"),a.setAttribute("title",c),a.getElementsByClassName("rua-quality-des")[0].innerText=d?"\u8F6C\u7801\u5931\u8D25":"\u4E0B\u8F7D\u5931\u8D25",a.addEventListener("click",f)}function y(a,b,c,d,e){e.getElementsByClassName("rua-quality-des")[0].innerText=`取流中...`,fetch(`https://api.bilibili.com/x/player/playurl?bvid=${P}&cid=${b}&qn=${c}&type=flv&fourk=1`,{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((a)=>{0===a.code&&null!==a.data.durl&&z(a.data.durl,d,0,a.data.durl.length,b,e)}).catch((a)=>{console.log(a)})}function z(a,b,c,d,e,f){q([a[c].url],b+(1<d?"-s"+c:""),e,f,"video"+(1<d?":"+c:""),!1).then(()=>{++c,c<d&&z(a,b,c,d,e,f)})}function A(){for(let a=0;a<U.length;a++)U[a].onclick=null;U=[]}function B(a,c,d,e){fetch("https://api.bilibili.com/x/v2/dm/web/seg.so?type=1&oid="+a+"&pid="+c+"&segment_index="+d,{method:"GET",credentials:"include",body:null}).then((a)=>a.arrayBuffer()).then((f)=>{const g=new Uint8Array(f);chrome.runtime.sendMessage({msg:"requestDanmaku",danmakuObj:$root.bilibili.community.service.dm.v1.DmSegMobileReply.decode(g).elems},function(a){if(X.concat(a.danmakuContent),Y.concat(a.danmakuContent),W+=a.danmakuPoolSize,document.getElementById("rua-danmaku-size").innerText="\u5171"+W+" \u5F39\u5E55",document.getElementById("rua-input-container").setAttribute("style",`width: ${b(W+"")}px`),ma.style.height=20*Y.size+"px",Z){for(let a=0;20>a;a++)!G(ma,"rua-danmaku-content","rua-danmaku-"+a)&&a<Y.size&&Y.get(a).look&&ma.appendChild(E(Y.get(a).time,Y.get(a).content,Y.get(a).mid,a));Z=20>Y.size}d===e&&(document.getElementById("rua-danmaku-download").setAttribute("style",""),document.getElementById("rua-danmaku-download").innerText="\u5F39\u5E55\u4E0B\u8F7D",K.setTitle(T[0]+(1===T.length?"":T[Q+1])))}),d<e&&(d++,B(a,c,d,e))}).catch((a)=>{console.log(a)})}function C(a){return H(a/3.6e5)}function D(a){let b=Math.floor(a/20)-5;for(;ma.hasChildNodes();)ma.firstChild.onmousedown=null,ma.removeChild(ma.firstChild);for(let c=0;25>c;c++)void 0!==Y.get(b+c)&&ma.appendChild(E(Y.get(c+b).time,Y.get(c+b).content,Y.get(c+b).mid,c+b))}function E(a,b,c,d){const e=document.createElement("div"),f=document.createElement("span"),g=document.createElement("span"),i=document.createElement("span"),j=a.split(":"),k=[1,60,3600];let l=0;for(let e=j.length-1;0<=e;e--)l+=(j[j.length-1-e]-1+1)*k[e];return e.setAttribute("title",b),e.setAttribute("id","rua-danmaku-"+d),e.style.top=20*d+"px",e.classList.add("rua-danmaku-content"),f.setAttribute("class","seek-video rua-danmaku-time"),f.setAttribute("data-time",l),f.innerText=a,e.appendChild(f),g.classList.add("rua-danmaku"),g.innerText=b,e.appendChild(g),i.classList.add("rua-danmaku-copy"),i.innerText="\u590D\u5236",e.appendChild(i),g.onmousedown=function(a){0===a.button&&F(document.body,c,ga.style.left.replace("px","")-1+1,a.clientY-140,d)},i.onmousedown=function(){h(g.innerText,"\u5F39\u5E55\u5DF2\u590D\u5236\u5230\u7C98\u8D34\u677F",`rua-danmaku-${d}`,-200,-ka.scrollTop-18)},e}async function F(a,b,c,d){const f=document.createElement("div");f.setAttribute("class","rua-danmaku-user-info"),f.setAttribute("style","top:"+d+"px;left:"+c+"px;");const e=document.createElement("div");e.setAttribute("class","rua-danmaku-user-host");const g=document.createElement("div");g.setAttribute("id","rua-user-control-bar"),g.innerHTML="<b style=\"padding-left: 20px;\">\u7528\u6237\u4FE1\u606F</b>";const h=document.createElement("div");if(h.setAttribute("style","position: absolute; top: 2px; left: 280px; width: 14px; height: 14px;"),h.innerHTML="<svg width=\"14\" height=\"14\"><circle cx=\"7\" cy=\"7\" r=\"7\" fill=\"#f16c59\"/><line class=\"rua-cross\" x1=\"4\" y1=\"4\" x2=\"10.5\" y2=\"10.5\" style=\"stroke:#ff5e57;stroke-width:1\"/><line class=\"rua-cross\" x1=\"10.5\" y1=\"4\" x2=\"4\" y2=\"10.5\" style=\"stroke:#ff5e57;stroke-width:1\"/></svg>",g.appendChild(h),0<document.body.getElementsByClassName("rua-danmaku-user-info").length){h.onmouseenter=null,h.onmouseleave=null,h.onmousedown=null,document.getElementById("app").onmousedown=null;for(let a=0;a<document.body.getElementsByClassName("rua-danmaku-user-info").length;a++)document.body.removeChild(document.body.getElementsByClassName("rua-danmaku-user-info")[a])}h.onmouseenter=()=>{for(let a=0;a<h.getElementsByClassName("rua-cross").length;a++)h.getElementsByClassName("rua-cross")[a].style.stroke="#A0000A"},h.onmouseleave=()=>{for(let a=0;a<h.getElementsByClassName("rua-cross").length;a++)h.getElementsByClassName("rua-cross")[a].style.stroke="#ff5e57"},h.onmousedown=(b)=>{0===b.button&&(h.onmouseenter=null,h.onmouseleave=null,h.onmousedown=null,document.getElementById("app").onmousedown=null,a.removeChild(f))};const j=document.createElement("div");j.setAttribute("id","rua-user-host"),j.classList.add("emoji_sec"),chrome.runtime.sendMessage({msg:"requestCrackUID",mid:b},(b)=>{for(let a=0;a<b.response.length;a++)chrome.runtime.sendMessage({msg:"requestUserInfo",mid:b.response[a]},(c)=>{if(0!==c.response.fans||0!==c.response.friend||"undefined"!=typeof b.response){const d=document.createElement("div");d.setAttribute("class","rua-user");const e=document.createElement("a"),f=document.createElement("img");e.href="https://space.bilibili.com/"+b.response[a],e.target="_Blank",e.setAttribute("class","rua-user-avatar"),f.classList.add("bili-avatar-img"),f.setAttribute("src",c.response.face.replace("http://","https://")),e.appendChild(f),d.appendChild(e);const g=document.createElement("div");g.setAttribute("style","padding-left: 50px; padding-top: 9px;min-width: 100px;");const h=document.createElement("a");h.href="https://space.bilibili.com/"+b.response[a],h.target="_Blank";const i=document.createElement("b");i.innerText=c.response.name;const k=document.createElement("a");k.href="https://space.bilibili.com/"+b.response[a],k.target="_Blank",k.innerText="uid: "+b.response[a];const l=document.createElement("br");h.appendChild(i),g.appendChild(h),g.appendChild(l),g.appendChild(k),d.appendChild(g),j.appendChild(d)}});e.appendChild(g),e.appendChild(j),f.appendChild(e),a.appendChild(f),document.getElementById("app").onmousedown=()=>{h.onmouseenter=null,h.onmouseleave=null,h.onmousedown=null,document.getElementById("app").onmousedown=null,a.removeChild(f)}})}function G(a,b,c){for(let d=0;d<a.getElementsByClassName(b).length;d++)if(a.getElementsByClassName(b)[d].id===c)return!0;return!1}var H=Math.ceil;const I=chrome.runtime.getURL("../images/haruka/abaaba.svg"),J=chrome.runtime.getURL("../ffmpeg/ffmpeg-core.wasm"),K=new AssConvert(1280,720);var L,M,N=window.location.pathname.replaceAll("/","").replace("video","").replace("bangumi","").replace("play",""),O="",P="0",Q=null===new URLSearchParams(window.location.search).get("p")?0:new URLSearchParams(window.location.search).get("p")-1,R=[],S={},T=[],U=[],V=0,W=0,X=new DanmakuArr,Y=new DanmakuArr,Z=!0,$=window.innerWidth,_=[],aa=1;let ba=null;new MutationObserver(()=>{const a=new URLSearchParams(window.location.search).get("p")-1,b=window.location.pathname.replaceAll("/","").replace("video","").replace("bangumi","").replace("play","");null!==new URLSearchParams(window.location.search).get("p")&&Q!=a&&(Q=a,m(R[a])),null!==b&&b!==N&&(N=b,i())}).observe(document,{subtree:!0,childList:!0}),a();var ca=!1,da=[100,100,100];const ea=document.body,fa=document.createElement("div"),ga=document.createElement("div"),ha=document.createElement("div");ha.setAttribute("id","rua-video-info"),ha.style.paddingTop="2px";const ia=document.createElement("div");ia.setAttribute("style","float: left; padding-left:5px"),ha.appendChild(ia);const ja=document.createElement("span");ja.setAttribute("style","float: right; padding-right:5px; user-select: none;"),ha.appendChild(ja);const ka=document.createElement("div");ka.setAttribute("id","rua-danmaku"),ka.classList.add("emoji_sec");const la=document.createElement("div");la.setAttribute("style","width: 300px; position: fixed; background: #fff"),la.innerHTML=`<div style='float: left; padding-left: 5px; user-select: none;'><b>弹幕：</b></div><div style='float: right; padding-right: 5px; user-select: none;' id='rua-danmaku-size'>共${W} 弹幕</div><div style='float: right; padding-right: 5px;user-select: none;cursor: pointer' id='rua-danmaku-search' title='查询弹幕内容'><svg width='18' height='18' viewBox='0 0 18 18' xmlns=\"http://www.w3.org/2000/svg\"><circle cx=\"8\" cy=\"8\" r=\"5\" style=\"stroke:#aaa;stroke-width:2; fill: none\"/><line x1=\"11.5\" y1=\"11.5\" x2=\"15\" y2=\"15\" style=\"stroke:#aaa;stroke-width:2\" /></svg></div><div id='rua-input-container' style='width: ${b(W+"")}px'><textarea id='rua-danmaku-search-input' class='rua-danmaku-search-out' style='display: none' placeholder='输入要查询的弹幕内容'></textarea></div>`;const ma=document.createElement("div");ma.style.position="relative",ka.appendChild(ma);const na=document.createElement("div");na.setAttribute("id","rua-download"),na.classList.add("emoji_sec");const oa=document.createElement("div");oa.setAttribute("style","width: 290px; position: fixed; background: #fff"),oa.innerHTML=`<div style='float: left; user-select: none; padding-left: 5px'><b>视频下载：</b></div><div id="rua-danmaku-download" style="opacity: 0.8; cursor: not-allowed;" title="将弹幕保存为ass文件">加载中</div><div style="float: right; margin: -2px 10px 0 0"><label for="rua-danmaku-intense"></label><select id="rua-danmaku-intense"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10" selected>10</option></select></div><div style="float: right; margin-right: 5px;">弹幕强度</div></div>`;const pa=document.createElement("div");pa.setAttribute("style","margin: 0 0 0 15px;"),na.appendChild(pa),0===document.getElementsByTagName("article").length&&function(){f(),fa.setAttribute("id","emoji-popup"),fa.style.background="url("+I+") no-repeat center",fa.style.backgroundSize="contain",fa.style.cursor="pointer",fa.innerHTML="<!---->",ga.setAttribute("id","emoji-selection"),ga.classList.add("emoji_sec"),ga.style.display="none",ga.innerHTML="",ga.appendChild(ha),ga.appendChild(la),ga.appendChild(ka),ga.appendChild(oa),ga.appendChild(na),ea.appendChild(ga),ea.appendChild(fa),fa.style.top=da[1]+"px",ga.style.top=da[1]-5+"px";var b=[0,0],d=[0,0];window.onload=function(){fa.onmousedown=function(a){let e,f;document.body.style.userSelect="none",fa.className="popup-click-in";const g=a||event,h=g.clientX-fa.offsetLeft,i=g.clientY-fa.offsetTop;b=[fa.offsetLeft,fa.offsetTop],d=[fa.offsetLeft,fa.offsetTop],document.onmousemove=function(a){const b=a||event;0<=b.clientX-h&&b.clientX-h<=M-70&&(e=b.clientX-h),0<=b.clientY-i&&b.clientY-i<=L-60&&(f=b.clientY-i),d=[e,f],fa.style.left=e+"px",fa.style.top=f+"px",ga.style.left=320>e?e+60+"px":e-310+"px",ga.style.top=f>L-360?L-360+"px":f-5+"px",f===void 0&&(f=fa.offsetTop),-1<e&&(da=[M-e,f,e])},document.onmouseup=function(){document.body.style.userSelect="auto",fa.className="popup-click-out",c(b[0],b[1],d[0],d[1])?"none"===ga.style.display?(ga.classList.remove("selection-fade-out"),ga.style.display="block",ga.classList.add("selection-fade-in")):(ga.classList.remove("selection-fade-in"),ga.classList.add("selection-fade-out"),setTimeout(()=>{ga.style.display="none"},300)):(ca=!0,localStorage.setItem("rua_pos",da[0]+","+da[1]+","+da[2])),document.onmousemove=null,document.onmouseup=null}},fa.onmouseenter=function(){fa.className="popup-click-hoverin"},fa.onmouseleave=function(){fa.className="popup-click-hoverout"}},window.addEventListener("resize",function(){let b,c=da[0]<da[2]?da[0]/$:da[2]/$;a(),ca?(b=da[0]<da[2]?M-da[0]:da[2],fa.style.left=b+"px"):e(),da[1]>L-60&&(fa.style.top=L-60+"px",ga.style.top=L-360+"px"),ga.style.left=320>b?b+60+"px":b-310+"px"}),document.getElementById("rua-danmaku-download").addEventListener("click",()=>{0===document.getElementById("rua-danmaku-download").getAttribute("style").length&&(K.feedDanmaku(X),K.downloadASS())}),document.getElementById("rua-danmaku-intense").addEventListener("change",function(){console.log(this.value);let a=this.value-1+1;K.setWeight(10-a)})}();var qa=new MutationObserver(function(a){a.forEach(function(a){"attributes"===a.type&&(null===ra.getAttribute("lab-style")?g(!1):(_=ra.getAttribute("lab-style").split(","),-1===_.indexOf("dark")?g(!1):g(!0)))})});const ra=document.documentElement;qa.observe(ra,{attributes:!0}),i(),ka.onscroll=function(a){20<=Y.size&&D(a.target.scrollTop)},document.getElementById("rua-danmaku-search-input").addEventListener("focus",()=>{document.getElementById("rua-danmaku-search-input").style.borderColor="#23ade5"}),document.getElementById("rua-danmaku-search-input").addEventListener("blur",()=>{document.getElementById("rua-danmaku-search-input").style.borderColor="#aaa"}),document.getElementById("rua-danmaku-search-input").addEventListener("input",(a)=>{Y=X.find(a.target.value),ma.style.height=20*Y.size+"px",ma.scrollTop=0,D(0)});let sa=!1;document.getElementById("rua-danmaku-search").onclick=()=>{sa?(sa=!1,document.getElementById("rua-danmaku-search-input").classList.remove("rua-danmaku-search-in"),document.getElementById("rua-danmaku-search-input").classList.add("rua-danmaku-search-out"),setTimeout(()=>{document.getElementById("rua-danmaku-search-input").style.display="none"},800)):(sa=!0,document.getElementById("rua-danmaku-search-input").style.display="block",document.getElementById("rua-danmaku-search-input").classList.remove("rua-danmaku-search-out"),document.getElementById("rua-danmaku-search-input").classList.add("rua-danmaku-search-in"))}}();