class AssConvert{constructor(a,b){this.dmexistsTime=15000*(a/1920),this.title='',this.filename='',this.resX=a,this.resY=b,this.danmaku=void 0,this.payload='',this.dmNormalChannel=[],this.dmTopChannel=[],this.dmDownChannel=[],this.dmRevChannel=[],this.initChannel(),this.weight=0}initChannel(){for(let a=0;a<(this.resY-50)/25;a++)this.dmNormalChannel.push(-1),this.dmTopChannel.push(-1),this.dmDownChannel.push(-1),this.dmRevChannel.push(-1)}genAssTitle(){this.title=`[Script Info]
Title: ${this.title}
ScriptType: v4.00+
Collisions: Normal
PlayResX: ${this.resX}
PlayResY: ${this.resY}
Timer: 10.0000

[V4+ Styles]
Format: Name, Fontname, Fontsize, PrimaryColour, SecondaryColour, OutlineColour, BackColour, Bold, Italic, Underline, StrikeOut, ScaleX, ScaleY, Spacing, Angle, BorderStyle, Outline, Shadow, Alignment, MarginL, MarginR, MarginV, Encoding
Style: DMs,Microsoft YaHei UI,18,&H00FFFFFF,&H00FFFFFF,&H66000000,&H66000000,1,0,0,0,100,100,0,0,1,2,0,2,20,20,2,0
Style: DMm,Microsoft YaHei UI,25,&H00FFFFFF,&H00FFFFFF,&H66000000,&H66000000,1,0,0,0,100,100,0,0,1,2,0,2,20,20,2,0
Style: DMl,Microsoft YaHei UI,32,&H00FFFFFF,&H00FFFFFF,&H66000000,&H66000000,1,0,0,0,100,100,0,0,1,2,0,2,20,20,2,0

[Events]
Format: Layer, Start, End, Style, Name, MarginL, MarginR, MarginV, Effect, Text
`}genDanmaku(){for(let a=0;a<this.danmaku.size;a++)if(this.danmaku.get(a).weight>this.weight){let b=25;for(let c=0;c<this.dmNormalChannel.length;c++)if(this.danmaku.get(a).ts>this.dmNormalChannel[c]){this.dmNormalChannel[c]=this.calculateDMOutTime(this.danmaku.get(a).content,this.danmaku.get(a).ts),b*=c+1;break}let c='';switch(this.danmaku.get(a).mode){case 4:this.dmexistsTime=4e3,c=`\\pos(${this.calculateStringMiddle()},${b})`;break;case 5:this.dmexistsTime=4e3,c=`\\pos(${this.calculateStringMiddle()},${this.resY-b})`;break;case 6:this.dmexistsTime=15000*(this.resX/1920),c=`\\move(${0-this.calculateStringLength(this.danmaku.get(a).content)},${b},${this.resX+this.calculateStringLength(this.danmaku.get(a).content)},${b})`;break;default:this.dmexistsTime=15000*(this.resX/1920),c=`\\move(${this.resX+this.calculateStringLength(this.danmaku.get(a).content)},${b},${0-this.calculateStringLength(this.danmaku.get(a).content)},${b})`;}this.payload+=`Dialogue: 0,${this.convertMSToS(this.danmaku.get(a).ts)},${this.convertMSToS(this.danmaku.get(a).ts+this.dmexistsTime)},${18===this.danmaku.get(a).fontsize?'DMs':25===this.danmaku.get(a).fontsize?'DMm':32===this.danmaku.get(a).fontsize?'DMl':'DMm'},,20,20,2,,{${c}${16777215==this.danmaku.get(a).color-1+1?'':'\\c&H'+this.colorDecToHex(this.danmaku.get(a).color-1+1)}}${this.danmaku.get(a).content}
`}}calculateStringLength(a,b){return AssConvert.stringLength(a)*(25===b?6.25:18===b?4.5:32===b?8:6.25)}calculateStringMiddle(){return this.resX/2}calculateDMOutTime(a,b){return(this.calculateStringLength(a)+50)*this.dmexistsTime/this.resY+b}colorDecToHex(a){return('000000'+a.toString(16).toUpperCase()).slice(-6)}convertMSToS(a){var b=Math.floor;let c=a%1e3;c=('00'+c).slice(-2),a/=1e3;let d=b(a%60),e=b(a/60%60),f=b(a/3600%60);return f=(10>f&&0<f?'0'+f:f)+':',e=10>e?'0'+e:e,d=10>d?'0'+d:d,f+e+':'+d+'.'+c}downloadASS(){const b=URL.createObjectURL(new Blob([this.title+this.payload])),c=document.createElement('a');c.style.display='none',c.href=b,c.download=this.filename,document.body.appendChild(c),c.click(),document.body.removeChild(c),window.URL.revokeObjectURL(b)}setWeight(a){this.danmaku=void 0,this.weight=a}feedDanmaku(a){this.danmaku=a,this.genDanmaku()}setTitle(a){this.title=a,this.filename=a+'.ass',this.genAssTitle()}static stringLength(a){let b=0;return Array.from(a).map(function(a){255<a.charCodeAt(0)?b+=2:b++}),b}}