class WindowIDList{static convertFromJSON(a){let b=new WindowIDList;return b.list=a.id,b}constructor(){this.list=[]}push(a){this.remove(a),this.list.push(a)}remove(a){-1<this.list.indexOf(a)&&this.list.splice(this.list.indexOf(a),1)}getCurrent(){return 0<this.list.length?this.list[this.list.length-1]:-1}length(){return this.list.length}toJSONObject(){return{id:this.list}}}class DanmakuObj{constructor(a,b,c,d,e,f,g,h){this.time=a,this.mid=b,this.content=c,this.name=[],this.look=!0,this.color=d,this.mode=e,this.fontsize=f,this.ts=g,this.weight=h}setName(a){this.name=a}}class DanmakuArr{constructor(){this.list=[],this.size=0,this.displaySize=this.size}push(a){this.list.push(a),this.size++}concat(a){this.list=this.list.concat(a.list),this.size+=a.size}get(a){return this.list[a]}max(){let a=0;for(let b=0;b<this.list.length;b++)a<this.list[b].time&&(a=this.list[b].time);return a}min(){let a=Number.MAX_VALUE;for(let b=0;b<this.list.length;b++)a>this.list[b].time&&(a=this.list[b].time);return a}sort(a){function b(a,b,c){const d=a[b];a[b]=a[c],a[c]=d}const c=this.max(),d=this.min(),e=[],f=Math.floor((c-d)/a)+1;for(let c=0;c<this.size;c++){const a=~~(this.list[c].ts/f);e[a]||(e[a]=[]),e[a].push(this.list[c]);for(let c=e[a].length;0<c;)void 0!==e[a][c]&&e[a][c].ts<e[a][c-1].ts&&b(e[a],c,c-1),c--}let g=[];for(let b=0;b<e.length;b++)e[b]&&(g=g.concat(e[b]));this.list=g}find(a){function b(a){return a.replaceAll(",","\uFF0C").replaceAll(".","\u3002").replaceAll("?","\uFF1F").replaceAll("!","\uFF01").replaceAll(";","\uFF1B").replaceAll(":","\uFF1A").replaceAll("\u201C","\"").replaceAll("\u201D","\"").replaceAll("(","\uFF08").replaceAll(")","\uFF09")}let c=new DanmakuArr;if(a=b(a),""===a)return this;for(let d=0;d<this.size;d++)b(this.list[d].content).includes(a)&&c.push(this.list[d]);return c}}class CRC32{static initCrc32Table(a){for(let b,c=0;256>c;c++){b=c;for(let a=0;8>a;a++)1&b?b=3988292384^b>>>1:b>>>=1;a[c]=b}}constructor(){this.crc32Table=new Uint32Array(256),CRC32.initCrc32Table(this.crc32Table),this.rainbowTableHash=new Uint32Array(1e5),this.rainbowTableValue=new Uint32Array(1e5);let a=new Uint32Array(1e5),b=new Uint32Array(65537);for(let c,d=0;1e5>d;d++)c=this.compute(d)>>>0,a[d]=c,b[c>>>16]++;let c=0;this.shortHashBucketStarts=b.map((a)=>c+=a);for(let b,c=0;1e5>c;c++)b=--this.shortHashBucketStarts[a[c]>>>16],this.rainbowTableHash[b]=a[c],this.rainbowTableValue[b]=c}compute(a,b=!1){let c=0;for(let d of a.toString())c=this.crc32Update(c,+d);if(b)for(let a=0;5>a;a++)c=this.crc32Update(c,0);return c}crack(a){var b=Math.pow;let c=[],d=~+("0x"+a)>>>0,e=4294967295;for(let f=1;10>f;f++)if(e=this.crc32Update(e,48),6>f)c=c.concat(this.lookup(d^e));else{let a=b(10,f-6),g=b(10,f-5);for(let b=a;b<g;b++)for(let a of this.lookup(d^e^this.compute(b,!0)))c.push(1e5*b+a)}return c}crc32Update(a,b){return a>>>8^this.crc32Table[255&(a^b)]}lookup(a){a>>>=0;let b=[],c=a>>>16;for(let d=this.shortHashBucketStarts[c];d<this.shortHashBucketStarts[c+1];d++)this.rainbowTableHash[d]===a&&b.push(this.rainbowTableValue[d]);return b}}!function(){function a(a,b){chrome.storage.sync.get([a],function(a){null===a.key&&chrome.storage.sync.set({key:b},function(){})})}function b(a){let b=new TextEncoder("utf8"),c=b.encode(a),d="";for(let b=0;b<c.length;++b)d+=String.fromCharCode(c[b]);return d}function c(a){a/=1e3;let b=y(a%60),c=y(a/60%60),d=y(a/3600%60);return d=0===d?"":(10>d&&0<d?"0"+d:d)+":",c=10>c?"0"+c:c,b=10>b?"0"+b:b,d+c+":"+b}function d(a){fetch("https://api.live.bilibili.com/room/v1/Room/get_status_info_by_uids?requestFrom=rua5",{method:"POST",credentials:"omit",body:"{\"uids\": ["+a+"]}"}).then((a)=>a.json()).then((b)=>{if(0===b.code){let c=b.data;chrome.notifications.getAll((b)=>{for(let c in b)-1===a.indexOf(c.split(":")[0]-1+1)&&"live.bilibili.com/"===c.split(":")[2]&&(chrome.notifications.clear(c),-1!==X.indexOf(c.split(":")[1]-1+1)&&X.splice(X.indexOf(c.split(":")[1]-1+1),1));for(let d=0;d<a.length;d++)void 0!==c[a[d]]&&(1!==c[a[d]].live_status&&-1!==X.indexOf(c[a[d]].room_id)&&(chrome.notifications.clear(`${a[d]}:${X.indexOf(c[a[d]].room_id)}:live.bilibili.com/`),X.splice(X.indexOf(c[a[d]].room_id),1)),1===c[a[d]].live_status&&-1===X.indexOf(c[a[d]].room_id)&&(X.push(c[a[d]].room_id),I&&(console.log(c[a[d]].title+" "+c[a[d]].uname+" "+new Date),e(c[a[d]].title,c[a[d]].uname,c[a[d]].room_id,c[a[d]].cover_from_user,1===c[a[d]].broadcast_type?1:0,c[a[d]].face,a[d]))))})}}).catch((a)=>{k(n,a,"queryLivingRoom()")})}function e(a,b,c,d,e,h,i){try{let j=b+" \u5F00\u64AD\u5566!\r\n\u662F"+(0===e?"\u7535\u8111":"\u624B\u673A")+"\u76F4\u64AD\uFF01";K?g(i,a,j,c,d,h,"live.bilibili.com/"):f(i,a,j,c,h,"live.bilibili.com/")}catch(a){}}function f(a,b,c,d,e,f){e=null==e.length||0===e.length?"../images/haruka128.png":e,chrome.notifications.create(a+":"+d+":"+f,{type:"basic",iconUrl:e,title:b,message:c,contextMessage:"rua\u8C79\u5668"},function(){})}function g(a,b,c,d,e,f,g){f=null==f.length||0===f.length?"../images/haruka128.png":f,e=null==e.length||0===e.length?f:e,chrome.notifications.create(a+":"+d+":"+g,{type:"image",iconUrl:f,title:b,message:c,imageUrl:e,contextMessage:"rua\u8C79\u5668"},function(){})}function h(){j(),m(),p(),B=setInterval(j,2.16e7),C=setInterval(m,4.32e7),D=setInterval(p,3.6e6)}function i(){chrome.cookies.get({url:"https://www.bilibili.com/",name:"DedeUserID"},function(a){T=null===a||null===a.expirationDate||a.expirationDate<Date.parse(new Date)/1e3?-1:a.value,-1===T&&T!==V&&(console.log("Session info does not exist, liver stream info listener cleared."),clearInterval(B),clearInterval(C),clearInterval(D)),-1!==T&&T!==V&&(console.log("Session info got."),X=[],n(!1),x(!0),o(!0),h()),V=T}),chrome.cookies.get({url:"https://www.bilibili.com/",name:"bili_jct"},function(a){U=null===a?-1:a.value})}function j(){J&&fetch("https://api.live.bilibili.com/xlive/web-ucenter/v1/sign/DoSign",{method:"GET",credentials:"include",body:null}).then(()=>{console.log("\u7B7E\u5230\u6210\u529F "+new Date().toUTCString())}).catch((a)=>{k(j,a,"checkIn()")})}function k(a,b,c){console.log("ERROR found @ "+new Date+":"),console.log(`${b} at function ${c}`),"undefined"!=typeof b.responseJSON&&-412===b.responseJSON.code||-412==b?setTimeout(a,1.5e6):setTimeout(a,2e4)}function l(){let a=new FormData;a.append("type","1"),a.append("csrf",U),fetch("https://api.bilibili.com/x/vip/privilege/receive?requestFrom=rua5",{method:"POST",credentials:"include",body:a}).then((a)=>a.json()).then(()=>{console.log("\u5151\u6362\u6210\u529F\uFF01\u597D\u8036( \u2022\u0300 \u03C9 \u2022\u0301 )\u2727"),chrome.notifications.create(Math.random()+"",{type:"basic",iconUrl:"./images/abaaba.png",title:"\u672C\u6708\u5927\u4F1A\u5458\u76845B\u5E01\u5151\u6362\u6210\u529F\uFF01",message:""},function(a){setTimeout(function(){chrome.notifications.clear(a)},3e3)})}).catch((a)=>{k(m,a,"exchangeBCoin()")})}function m(){L&&fetch("https://api.bilibili.com/x/vip/privilege/my",{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((a)=>{console.log("checked vip status"),0===a.code&&(1===a.data.list[0].type&&0===a.data.list[0].state?l():1===a.data.list[0].type&&1===a.data.list[0].state&&console.log("\u8FD9\u4E2A\u6708\u7684\u5DF2\u7ECF\u5151\u6362\u8FC7\u4E86\uFF0C\u597D\u8036\uFF01( \u2022\u0300 \u03C9 \u2022\u0301 )\u2727"))}).catch((a)=>{k(m,a,"queryBcoin()")})}function n(a){fetch("https://api.vc.bilibili.com/dynamic_svr/v1/dynamic_svr/dynamic_new?type_list=8,512,4097,4098,4099,4100,4101",{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((b)=>{if(0===b.code){if("undefined"!=typeof b.data&&0!==b.data.length){let a=b.data.attentions.uids;a.splice(b.data.attentions.uids.indexOf(T-1+1),1),console.log(`Load following list complete. ${a.length} followings found.`),d(a)}if(O){let d=b.data.cards;for(let b=0;b<d.length;b++){let e=JSON.parse(d[b+""].card),c=d[b+""].desc.type;Y.includes(d[b+""].desc.dynamic_id)||((a||void 0===a)&&(8===c?(console.log("\u4F60\u5173\u6CE8\u7684up "+d[b+""].desc.user_profile.info.uname+" \u6295\u7A3F\u4E86\u65B0\u89C6\u9891\uFF01"+e.title+" see:"+d[b+""].desc.bvid),f(d[b+""].desc.dynamic_id,"\u4F60\u5173\u6CE8\u7684up "+d[b+""].desc.user_profile.info.uname+" \u6295\u7A3F\u4E86\u65B0\u89C6\u9891\uFF01",e.title,d[b+""].desc.bvid,d[b+""].desc.user_profile.info.face,"b23.tv/")):512<=c&&4101>=c&&(console.log("\u4F60\u5173\u6CE8\u7684\u756A\u5267 "+e.apiSeasonInfo.title+" \u66F4\u65B0\u4E86\uFF01"+e.index+" see:"+e.url),f(d[b+""].desc.dynamic_id,"\u4F60\u5173\u6CE8\u7684\u756A\u5267 "+e.apiSeasonInfo.title+" \u66F4\u65B0\u4E86\uFF01",e.new_desc,e.url.replace("https://www.bilibili.com/",""),e.cover,"www.bilibili.com/"))),Y.push(d[b+""].desc.dynamic_id))}}}setTimeout(()=>{n(!0)},1e4)}).catch((a)=>{k(n,a,"videoNotify()")})}function o(a){chrome.storage.local.get(["dynamicList"],(b)=>{let d=b.dynamicList;fetch(`https://api.vc.bilibili.com/dynamic_svr/v1/dynamic_svr/dynamic_new?type_list=1,2,4`,{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((b)=>{0===b.code?chrome.storage.sync.get(["dynamicSwitch"],(e)=>{let g=b.data.cards;for(let b=0;b<g.length;b++){let h=JSON.parse(g[b+""].card),c=g[b+""].desc.type;d.includes(g[b+""].desc.dynamic_id)||(!a&&e.dynamicSwitch&&(1===c?(console.log("\u4F60\u5173\u6CE8\u7684up "+h.user.uname+" \u8F6C\u53D1\u4E86\u4E00\u6761\u65B0\u52A8\u6001 "+h.item.content+" see:"+`https://t.bilibili.com/${g[b+""].desc.dynamic_id_str}`),f(g[b+""].desc.dynamic_id,`你关注的up ${h.user.uname}  转发了一条新动态`,h.item.content+"",g[b+""].desc.dynamic_id_str,h.user.face,"t.bilibili.com/")):2===c?(console.log("\u4F60\u5173\u6CE8\u7684up "+h.user.name+" \u53D1\u4E86\u4E00\u6761\u65B0\u52A8\u6001 "+h.item.description+" see: "+`https://t.bilibili.com/${g[b+""].desc.dynamic_id_str}`),f(g[b+""].desc.dynamic_id,`你关注的up ${h.user.name}  发了一条图片动态`,h.item.description+"",g[b+""].desc.dynamic_id_str,h.user.head_url,"t.bilibili.com/")):4===c?(console.log("\u4F60\u5173\u6CE8\u7684up "+h.user.uname+" \u53D1\u4E86\u4E00\u6761\u65B0\u52A8\u6001 "+h.item.content+" see: "+`https://t.bilibili.com/${g[b+""].desc.dynamic_id_str}`),f(g[b+""].desc.dynamic_id,`你关注的up ${h.user.uname}  发了一条新动态`,h.item.content+"",g[b+""].desc.dynamic_id_str,h.user.face,"t.bilibili.com/")):void 0),d.push(g[b+""].desc.dynamic_id))}chrome.storage.local.set({dynamicList:d},()=>{}),setTimeout(()=>{o()},1e4)}):k(o,b.code,"dynamicNotify()")}).catch((a)=>{k(o,a,"dynamicNotify()")})})}function p(){if(console.log("Grabbing medal info"),Q&&(null===localStorage.getItem("rua_lastDK")||u(localStorage.getItem("rua_lastDK").split("-"),(v().getFullYear()+"-"+v().getMonth()+"-"+v().getDate()).split("-")))){let a=[];localStorage.setItem("rua_lastDK",v().getFullYear()+"-"+v().getMonth()+"-"+v().getDate()),fetch("https://api.live.bilibili.com/xlive/web-ucenter/user/MedalWall?target_id="+T,{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((b)=>{console.log(b.data.list.length+" medal founded.");for(let c=0;c<b.data.list.length;c++)100>b.data.list[c].medal_info.today_feed&&a.push(b.data.list[c].medal_info.target_id);q(a)}).catch((a)=>{localStorage.setItem("rua_lastDK","1970-01-01"),k(p,a,"checkMedalDaka()")})}else console.log("No more grab needed.")}function q(a){let b=0;(function c(){fetch("https://api.live.bilibili.com/live_user/v1/Master/info?uid="+a[b],{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((d)=>{if(0===d.code||0<d.data.length){let e=new FormData;e.append("bubble","0"),e.append("msg","\u6253\u5361"),e.append("color","16777215"),e.append("mode","1"),e.append("fontsize","25"),e.append("rnd",Math.round(Date.now()/1e3)+""),e.append("roomid",d.data.room_id),e.append("csrf",U),e.append("csrf_token",U),fetch("https://api.live.bilibili.com/msg/send?requestFrom=rua5",{method:"POST",credentials:"include",body:e}).then(()=>{console.log("\u6253\u5361\u6210\u529F: https://live.bilibili.com/"+d.data.room_id),b++,b<a.length&&setTimeout(()=>{c()},1e3*(5*Math.random()+10))}).catch((a)=>{console.error("Error:",a)})}})})()}async function r(a){let b="AaBb";return b.includes(a.charAt(0))&&"Vv".includes(a.charAt(1))&&(b.substr(0,2).includes(a.charAt(0))?await s("aid="+a.substr(2,a.length-1)):await s("bvid="+a))}function s(a){return new Promise(function(b){let c=new XMLHttpRequest;c.open("GET","https://api.bilibili.com/x/web-interface/view?"+a,!0),c.send(null),c.onload=function(){200===c.status?b(0===JSON.parse(c.responseText).code):b(!1)}})}function t(a){console.log("checking update at "+new URL(a).hostname),fetch(a+new Date().getTime(),{method:"GET",credentials:"omit",body:null}).then((a)=>a.text()).then((b)=>{null!==b&&null!==/<meta name="current-version" content="(.*?)">/m.exec(b)&&E!==/<meta name="current-version" content="(.*?)">/m.exec(b)[1]&&(E=/<meta name="current-version" content="(.*?)">/m.exec(b)[1].split("."),E[0]-0>chrome.runtime.getManifest().version.split(".")[0]-0||E[0]-0>=chrome.runtime.getManifest().version.split(".")[0]-0&&E[1]-0>chrome.runtime.getManifest().version.split(".")[1]-0?(console.log(`A newer version found: ${E[0]}.${E[1]}`),F=!0,G=new URL(a).hostname.includes("github")?"https://github.com/TyraelDLee/HarukaEmoji/releases/latest":"https://gitee.com/tyrael-lee/HarukaEmoji/releases",w("rua\u8C79\u5668 \u6709\u66F4\u65B0\u53EF\u7528","1")):(console.log("Current version is latest."),F=!1,w("rua\u8C79\u5668","")))}).catch((b)=>{console.log(b),checkUpdate(a.includes("github")?"https://tyrael-lee.gitee.io/harukaemoji/?_=":"https://tyraeldlee.github.io/HarukaEmoji/?_=")})}function u(a,b){return!!(parseInt(a[0])<parseInt(b[0]))||!(parseInt(a[0])>parseInt(b[0]))&&(!!(parseInt(a[1])<parseInt(b[1]))||!(parseInt(a[1])>parseInt(b[1]))&&parseInt(a[2])<parseInt(b[2]))}function v(){return new Date(new Date().getTime()+6e4*new Date().getTimezoneOffset())}function w(a,b){chrome.browserAction.setTitle({title:a}),chrome.browserAction.setBadgeText({text:b})}function x(a){chrome.storage.local.get(["unreadData","unreadMessage"],async(b)=>{let c=JSON.parse(b.unreadData);await fetch("https://api.bilibili.com/x/msgfeed/unread",{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((b)=>{0===b.code?chrome.storage.sync.get(["unreadSwitch"],(d)=>{if(d.unreadSwitch){if(!a&&(0<b.data.at-c.at||0<b.data.like-c.like||0<b.data.reply-c.reply||0<b.data.sys_msg-c.sys_msg||0<b.data.up-c.up)){let a=`${0<b.data.at-c.at?b.data.at-c.at+"\u4E2A@, ":""}${0<b.data.like-c.like?b.data.like-c.like+"\u4E2A\u8D5E, ":""}${0<b.data.reply-c.reply?b.data.reply-c.reply+"\u4E2A\u56DE\u590D, ":""}${0<b.data.sys_msg-c.sys_msg?b.data.sys_msg-c.sys_msg+"\u4E2A\u7CFB\u7EDF\u901A\u77E5, ":""}${0<b.data.up-c.up?b.data.up-c.up+"\u4E2Aup\u52A9\u624B\u63D0\u9192, ":""}`;chrome.notifications.clear("-276492:reply:message.bilibili.com/#/"),f(-276492,"\u4F60\u6536\u5230\u4E86\u65B0\u7684\u6D88\u606F:",a.substring(0,a.length-2),`reply`,"",`message.bilibili.com/#/`)}c=b.data,chrome.storage.local.set({unreadData:JSON.stringify(c)},()=>{})}}):k(x,b.code,"getUnread()")}).catch((a)=>{k(x,a,"getUnread()")}),await fetch("https://api.vc.bilibili.com/session_svr/v1/session_svr/single_unread",{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((c)=>{0===c.code?(chrome.storage.sync.get(["unreadSwitch"],(d)=>{d.unreadSwitch&&!a&&0<c.data.biz_msg_follow_unread+c.data.biz_msg_unfollow_unread+c.data.dustbin_push_msg+c.data.dustbin_unread+c.data.follow_unread+c.data.unfollow_push_msg+c.data.unfollow_unread-b.unreadMessage&&(chrome.notifications.clear("-276491:reply:message.bilibili.com/#/"),f(-276491,`你收到了${c.data.biz_msg_follow_unread+c.data.biz_msg_unfollow_unread+c.data.dustbin_push_msg+c.data.dustbin_unread+c.data.follow_unread+c.data.unfollow_push_msg+c.data.unfollow_unread-b.unreadMessage}条新私信`,"",`reply`,"",`message.bilibili.com/#/`)),chrome.storage.local.set({unreadMessage:c.data.biz_msg_follow_unread+c.data.biz_msg_unfollow_unread+c.data.dustbin_push_msg+c.data.dustbin_unread+c.data.follow_unread+c.data.unfollow_push_msg+c.data.unfollow_unread},()=>{})}),setTimeout(()=>{x()},1e4)):k(x,c.code,"getUnread()")}).catch((a)=>{k(x,a,"getUnread()")})})}var y=Math.floor;const z=chrome.runtime.getManifest().version,A=new CRC32;var B,C,D,E=z.split("."),F=!1,G="https://gitee.com/tyrael-lee/HarukaEmoji/releases",H="",I=!0,J=!0,K=!1,L=!0,M=!0,N="\u539F\u753B",O=!1,P=!1,Q=!0,R="";let S=!1;var T=-1,U=-1,V=T,W=new WindowIDList;let X=[];chrome.notifications.getAll((a)=>{for(let b in a)chrome.notifications.clear(b)}),chrome.storage.local.set({unreadData:"{\"at\":0,\"chat\":0,\"like\":0,\"reply\":0,\"sys_msg\":0,\"up\":0}",unreadMessage:0,dynamicList:[]},function(){}),chrome.runtime.getPlatformInfo((a)=>{R=a.os}),chrome.browserAction.setBadgeBackgroundColor({color:"#00A0FF"}),chrome.windows.getAll(function(a){for(let b=0;b<a.length;b++)W.push(a[b].id)}),chrome.windows.onCreated.addListener(function(a){W.push(a.id)}),chrome.windows.onRemoved.addListener(function(a){W.remove(a)}),chrome.windows.onFocusChanged.addListener(function(a){-1!==a&&W.push(a)}),chrome.runtime.onInstalled.addListener(function(){null===localStorage.getItem("rua_lastDK")&&localStorage.setItem("rua_lastDK","1970-01-01"),a("notification",!0),a("medal",!0),a("checkIn",!0),a("bcoin",!0),a("qn",!0),a("qnvalue","\u539F\u753B"),a("dynamicPush",!0),a("hiddenEntry",!1),a("daka",!0),a("record",!1),a("prerecord",300),a("enhancedHiddenEntry",!1),a("unreadSwitch",!0),a("dynamicSwitch",!0),chrome.storage.local.set({imageNotice:!1},function(){K=!1}),chrome.tabs.create({url:"./readme.html"})}),chrome.storage.onChanged.addListener(function(a){for(let[b,{oldValue:c,newValue:d}]of Object.entries(a))"notification"===b?I=d:"checkIn"===b?(J=d,J&&j()):"imageNotice"===b?K=d:"bcoin"===b?(L=d,L&&m()):"dynamicPush"===b?O=d:"hiddenEntry"===b?P=d:"enhancedHiddenEntry"===b?S=d:"daka"===b?(Q=d,Q&&p()):void 0}),chrome.runtime.onMessage.addListener(function(d,a,e){if("get_LoginInfo"===d.msg&&chrome.cookies.get({url:"https://www.bilibili.com/",name:"bili_jct"},function(a){U=null===a?-1:a.value,e({res:U+","+T+","+T})}),"get_LoginStatus"===d.msg&&chrome.cookies.get({url:"https://www.bilibili.com/",name:"DedeUserID"},(a)=>{null===a||void 0===a?e({login:!1,vip:0}):fetch(`https://api.bilibili.com/x/space/acc/info?mid=${a.value}`,{method:"GET",credentials:"include",body:null}).then((a)=>a.json()).then((a)=>{0===a.code&&null!==a.data?e({login:!0,vip:a.data.vip.type}):e({login:!0,vip:1})})}),"get_UUID"===d.msg&&e({res:T}),"updateStatus"===d.msg&&e({res:F,address:G}),"popupfired"===d.msg&&w("rua\u8C79\u5668",""),"requestDownload"===d.msg&&(chrome.downloads.download({filename:d.fileName,url:d.url},()=>{}),e({res:"ok"})),"requestDanmaku"===d.msg){let a=new DanmakuArr;for(let b=0;b<d.danmakuObj.length;b++)void 0===d.danmakuObj[b].progress&&(d.danmakuObj[b].progress=0),a.push(new DanmakuObj(c(d.danmakuObj[b].progress),A.crack(d.danmakuObj[b].midHash),d.danmakuObj[b].content,d.danmakuObj[b].color,d.danmakuObj[b].mode,d.danmakuObj[b].fontsize,d.danmakuObj[b].progress,d.danmakuObj[b].weight));a.sort(a.size-1),e({danmakuContent:a,danmakuPoolSize:d.danmakuObj.length})}if("requestUserInfo"===d.msg&&fetch("https://api.bilibili.com/x/web-interface/card?mid="+d.mid+"&photo=true&requestFrom=rua5",{method:"GET",headers:{Accept:"application/json"},credentials:"include",body:null}).then((a)=>a.json()).then((a)=>{0===a.code&&null!==a.data&&e({response:a.data.card})}),"requestEncode"===d.msg){const{createFFmpeg:a,fetchFile:c}=FFmpeg,f=a({corePath:"./ffmpeg/ffmpeg-core.js",log:!1});(async()=>{let g,h,i;await f.load(),"videoRecord"===d.requestType&&(f.FS("writeFile","video.mp4",(await c(d.blob))),1<d.startTime?(await f.run("-i","video.mp4","-ss",d.startTime+"","-c","copy","footage.mp4"),await f.run("-i","footage.mp4","-threads","4","-vcodec","copy","-acodec","aac","final.mp4")):await f.run("-i","video.mp4","-threads","4","-vcodec","copy","-acodec","aac","final.mp4"),g=f.FS("readFile","final.mp4"),h=d.filename+".mp4",i=URL.createObjectURL(new Blob([g.buffer],{type:"video/mp4"}))),"audioRecord"===d.requestType&&(f.FS("writeFile","audio.m4s",(await c(d.blob[0]))),await f.run("-i","audio.m4s","-c","copy","-metadata",`title=${b(d.metadata.title)}`,"-metadata",`artist=${b(d.metadata.artist)}`,"-metadata",`year=${d.metadata.year}`,"final.m4a"),g=f.FS("readFile","final.m4a"),h=d.filename+".m4a",i=URL.createObjectURL(new Blob([g.buffer],{type:"audio/mp4"}))),"dolbyRecord"===d.requestType&&(f.FS("writeFile","audio.m4s",(await c(d.blob[0]))),await f.run("-i","audio.m4s","-c","copy","final.mp4"),g=f.FS("readFile","final.mp4"),h=d.filename+".mp4",i=URL.createObjectURL(new Blob([g.buffer],{type:"audio/mp4"}))),"hdrRecord"===d.requestType&&(f.FS("writeFile","video.m4s",(await c(d.blob[0]))),f.FS("writeFile","audio.m4s",(await c(d.blob[1]))),await f.run("-i","video.m4s","-i","audio.m4s","-map","0:v","-map","1:a","-c","copy","final.mkv"),g=f.FS("readFile","final.mkv"),h=d.filename+".mkv",i=URL.createObjectURL(new Blob([g.buffer]))),"songRecord"===d.requestType&&(f.FS("writeFile","audio.m4s",(await c(d.blob))),await f.run("-i","audio.m4s","-c","copy","-metadata",`title=${b(d.metadata.title)}`,"-metadata",`artist=${b(d.metadata.artist)}`,"-metadata",`description=${b(d.metadata.description)}`,"-metadata",`lyrics=${d.metadata.lyrics}`,"-metadata",`year=${d.metadata.year}`,"final.m4a"),g=f.FS("readFile","final.m4a"),h=d.filename+".m4a",i=URL.createObjectURL(new Blob([g.buffer],{type:"audio/mp4"})));const j=document.createElement("a");j.style.display="none",j.href=i,j.download=h,document.body.appendChild(j),j.click(),document.body.removeChild(j),window.URL.revokeObjectURL(i),e({status:"ok"})})()}return"requestOSInfo"===d.msg&&e({os:R}),d.msg.includes("QNV")&&(N=d.msg.split("?")[1],e({res:"ok"})),!0}),chrome.runtime.onConnect.addListener(function(a){"popup"===a.name&&a.onDisconnect.addListener(function(){chrome.storage.sync.set({qnvalue:N},function(){})})}),chrome.notifications.onClicked.addListener(function(a){chrome.storage.local.get(["winIDList"],(b)=>{let c=WindowIDList.convertFromJSON(b.winIDList);chrome.windows.getAll(function(b){0<b.length?(chrome.windows.update(c.getCurrent(),{focused:!0}),chrome.tabs.create({url:`https://${a.split(":")[2]}${a.split(":")[1]}`})):chrome.windows.create({url:`https://${a.split(":")[2]}${a.split(":")[1]}`})})}),chrome.notifications.clear(a)}),t("https://tyrael-lee.gitee.io/harukaemoji/?_="),setTimeout(function(){chrome.storage.sync.get(["notification","checkIn","bcoin","qn","dynamicPush","hiddenEntry","daka","enhancedHiddenEntry"],(a)=>{I=a.notification,J=a.checkIn,L=a.bcoin,M=a.qn,O=a.dynamicPush,P=a.hiddenEntry,Q=a.daka,S=a.enhancedHiddenEntry}),chrome.storage.local.get(["imageNotice"],(a)=>{K=a.imageNotice})},100),setTimeout(i,200),setInterval(i,5e3),setInterval(()=>{t("https://tyrael-lee.gitee.io/harukaemoji/?_=")},4.32e7);let Y=[];chrome.webRequest.onBeforeSendHeaders.addListener(function(a){let b=a.requestHeaders;if("rua5"===new URLSearchParams(new URL(a.url).search).get("requestFrom"))for(let a in b)"Origin"===b[a].name&&(b[a].value="https://www.bilibili.com/");return{requestHeaders:a.requestHeaders}},{urls:["https://api.bilibili.com/x/vip/privilege/receive*","https://api.live.bilibili.com/room/v1/Room/get_status_info_by_uids*","https://api.bilibili.com/x/web-interface/card*"]},["blocking","requestHeaders","extraHeaders"]),chrome.webRequest.onBeforeSendHeaders.addListener(function(a){let b=a.requestHeaders;if("rua5"===new URLSearchParams(new URL(a.url).search).get("requestFrom")){for(let a in b)"Origin"===b[a].name&&(b[a].value="https://live.bilibili.com"),"Sec-Fetch-Site"===b[a].name&&(b[a].value="same-site");a.requestHeaders.push({name:"Referer",value:"https://live.bilibili.com/"})}return{requestHeaders:a.requestHeaders}},{urls:["https://api.live.bilibili.com/msg/send*"]},["blocking","requestHeaders","extraHeaders"]),chrome.webRequest.onBeforeRequest.addListener((a)=>!P||S||a.url.includes("room_id=2842865")?void 0:{redirectUrl:"https://api.live.bilibili.com/xlive/web-room/v1/index/getInfoByUser?room_id=2842865&from=0"},{urls:["*://api.live.bilibili.com/xlive/web-room/v1/index/getInfoByUser*"]},["blocking"]),chrome.webRequest.onBeforeSendHeaders.addListener((a)=>{let b=a.requestHeaders;if(S)for(let a in b)"Cookie"===b[a].name&&(b[a].value="");return{requestHeaders:a.requestHeaders}},{urls:["*://api.live.bilibili.com/xlive/web-room/v1/index/getDanmuInfo*","*://api.live.bilibili.com/room/v1/Room/room_init*","*://api.live.bilibili.com/xlive/web-room/v2/index/getRoomPlayInfo*","*://api.live.bilibili.com/xlive/web-room/v1/index/roomEntryAction","*://api.live.bilibili.com/xlive/web-room/v1/index/getIpInfo*","*://api.live.bilibili.com/xlive/web-interface/v1/index/getWebAreaList*","*://api.live.bilibili.com/relation/v1/Feed/heartBeat*","*://api.live.bilibili.com/xlive/web-room/v1/index/getInfoByUser?*","*://api.live.bilibili.com/xlive/activity-interface/v1/widgetBanner/GetWidgetBannerList*","*://api.live.bilibili.com/xlive/web-room/v1/index/getOffLiveList*","*://api.live.bilibili.com/xlive/lottery-interface/v1/lottery/getLotteryInfoWeb*","*://api.live.bilibili.com/xlive/web-room/v1/giftPanel/giftData*","*://api.live.bilibili.com/xlive/web-room/v1/giftPanel/giftConfig*","*://api.live.bilibili.com/xlive/open-interface/v1/query_resource*","*://api.live.bilibili.com/xlive/web-room/v1/dM/gethistory*"]},["blocking","requestHeaders","extraHeaders"]),chrome.webRequest.onHeadersReceived.addListener((a)=>{if("ruaDL"===new URLSearchParams(new URL(a.url).search).get("requestFrom")){let b=new URL(a.url).pathname.substr(new URL(a.url).pathname.length-4,4);".m4s"===b&&(b=".mp3"),a.responseHeaders.push({name:"Content-Disposition",value:"attachment; filename=\""+H+b+"\"; filename*=\"UTF-8''"+H+b+"\""})}return{responseHeaders:a.responseHeaders}},{urls:["*://*.bilivideo.com/upgcxcode/*","*://*.akamaized.net/upgcxcode/*"]},["responseHeaders","blocking"]),function(){chrome.contextMenus.create({contexts:["selection","link"],title:"\u7528bilibili\u641C\u7D22",type:"normal",id:"rua-contextMenu"}),chrome.contextMenus.onClicked.addListener((a)=>{"rua-contextMenu"===a.menuItemId&&r(a.selectionText).then((b)=>{b?chrome.tabs.create({url:"https://www.bilibili.com/video/"+a.selectionText}):chrome.tabs.create({url:"https://search.bilibili.com/all?keyword="+a.selectionText})})})}()}();