!function(){function a(){if(-1!==M&&-1!==N){U++;let c=0;$.ajax({url:"https://api.bilibili.com/x/relation/followings?vmid="+M+"&pn="+U,type:"GET",dataType:"json",json:"callback",xhrFields:{withCredentials:!0},success:function(d){if("undefined"!=typeof d.data&&0!==d.data.length){var e=d.data.list;c=e.length;for(let a,b=0;b<e.length;b++)a=new FollowingMember(e[b].mid,e[b].uname),R.push(a),S.push(a);0===c&&0!==R.length()&&(U=0,R.update(S),S.clearAll(),console.log("Load following list complete. "+R.length()+" followings found."),b()),0!==c&&a()}},error:function(b){U=0,k(a,b)}})}}function b(){$.ajax({url:"https://api.live.bilibili.com/room/v1/Room/get_status_info_by_uids",type:"POST",data:{uids:R.getUIDList()},dataType:"json",json:"callback",success:function(a){if(0===a.code){let b=new FollowingMemberList,d=a.data;for(let a=0;a<R.getUIDList().length;a++)if(d[R.getUIDList()[a]+""]!==void 0&&1===d[R.getUIDList()[a]+""].live_status){let c=new FollowingMember(d[R.getUIDList()[a]+""].uid,d[R.getUIDList()[a]+""].uname,d[R.getUIDList()[a]+""].face,d[R.getUIDList()[a]+""].cover_from_user,d[R.getUIDList()[a]+""].keyframe,d[R.getUIDList()[a]+""].room_id,d[R.getUIDList()[a]+""].title);c.ONAIR=!0,c.TYPE=1===d[R.getUIDList()[a]+""].broadcast_type?1:0,b.push(c)}0<b.list.length&&c(b)}},error:function(b){U=0,k(a,b)}})}function c(b){if(0<R.length()){for(let a=0;a<b.length();a++)b.updateStatus(a,R.get(R.indexOf(b.get(a))).PUSHED),R.updateElementOnAirStatus(b.get(a),!0);for(let a=0;a<R.length();a++)R.get(a).ONAIR&&(-1===b.indexOf(R.get(a))?(R.get(a).COVER=void 0,R.get(a).FACE=void 0,R.get(a).KEYFRAME=void 0,R.get(a).ROOM_URL=void 0,R.get(a).TITLE=void 0,R.updateStatus(a,!1),R.updateElementOnAirStatus(R.get(a),!1)):!R.get(a).PUSHED&&(R.updateStatus(a,!0),console.log(R.get(a).TITLE+" "+R.get(a).NAME+" "+new Date),E&&d(R.get(a).TITLE,R.get(a).NAME,R.get(a).ROOM_URL,0===R.get(a).COVER.length||null==R.get(a).COVER.length?0===R.get(a).FACE.length||null==R.get(a).FACE.length?"../images/haruka128.png":R.get(a).FACE:R.get(a).COVER,R.get(a).TYPE,0===R.get(a).FACE.length||null==R.get(a).FACE.length?"../images/haruka128.png":R.get(a).FACE)))}setTimeout(a,1e4)}function d(a,b,c,d,g,h){let i=Math.random(),j=b+" \u5F00\u64AD\u5566!\r\n\u662F"+(0===g?"\u7535\u8111":"\u624B\u673A")+"\u76F4\u64AD\uFF01";G?f(i,a,j,c,d,h,"https://live.bilibili.com/"):e(i,a,j,c,h,"https://live.bilibili.com/")}function e(a,b,c,d,e,f){chrome.notifications.create(a+":"+d,{type:"basic",iconUrl:e,title:b,message:c,contextMessage:"rua\u8C79\u5668"},function(a){g(a,f)})}function f(a,b,c,d,e,f,h){chrome.notifications.create(a+":"+d,{type:"image",iconUrl:f,title:b,message:c,imageUrl:e,contextMessage:"rua\u8C79\u5668"},function(a){g(a,h)})}function g(a,b){chrome.notifications.onClicked.addListener(function(c){c===a&&(chrome.windows.getAll(function(a){0<a.length?(chrome.windows.update(T.getCurrent(),{focused:!0}),chrome.tabs.create({url:b+c.split(":")[1]})):chrome.windows.create({url:b+c.split(":")[1]})}),chrome.notifications.clear(a))})}function h(){j(),m(),o(),y=setInterval(j,216e5),z=setInterval(m,432e5),A=setInterval(o,36e5)}function i(){chrome.cookies.get({url:"https://www.bilibili.com/",name:"DedeUserID"},function(b){chrome.cookies.get({url:"https://www.bilibili.com/",name:"SESSDATA"},function(c){M=null===b?-1:b.value,N=null===c?-1:c.value,(-1===M||-1===N)&&M!==P&&N!==Q&&(console.log("Session info does not exist, liver stream info listener cleared."),clearInterval(y),clearInterval(z),clearInterval(A)),-1!==M&&-1!==N&&M!==P&&N!==Q&&(console.log("Session info got."),R.clearAll(),U=0,n(!1),h(),a()),P=M,Q=N})}),chrome.cookies.get({url:"https://www.bilibili.com/",name:"bili_jct"},function(a){O=null===a?-1:a.value})}function j(){F&&$.ajax({url:"https://api.live.bilibili.com/xlive/web-ucenter/v1/sign/DoSign",type:"GET",dataType:"json",json:"callback",xhrFields:{withCredentials:!0},success:function(){console.log("\u7B7E\u5230\u6210\u529F "+new Date().toUTCString())},error:function(a){k(j,a)}})}function k(a,b){console.log("ERROR found @ "+new Date+":"),console.log(b),"undefined"!=typeof b.responseJSON&&-412===b.responseJSON.code?setTimeout(a,9e5):setTimeout(a,2e4)}function l(){$.ajax({url:"https://api.bilibili.com/x/vip/privilege/receive",type:"POST",data:{type:1,csrf:O},dataType:"json",json:"callback",success:function(){console.log("\u5151\u6362\u6210\u529F\uFF01\u597D\u8036( \u2022\u0300 \u03C9 \u2022\u0301 )\u2727"),chrome.notifications.create(Math.random()+"",{type:"basic",iconUrl:"./images/abaaba.png",title:"\u672C\u6708\u5927\u4F1A\u5458\u76845B\u5E01\u5151\u6362\u6210\u529F\uFF01",message:""},function(a){setTimeout(function(){chrome.notifications.clear(a)},3e3)})},error:function(a){k(m,a)}})}function m(){H&&$.ajax({url:"https://api.bilibili.com/x/vip/privilege/my",type:"GET",dataType:"json",json:"callback",success:function(a){console.log("checked vip status"),0===a.code&&(1===a.data.list[0].type&&0===a.data.list[0].state?l():1===a.data.list[0].type&&1===a.data.list[0].state&&console.log("\u8FD9\u4E2A\u6708\u7684\u5DF2\u7ECF\u5151\u6362\u8FC7\u4E86\uFF0C\u597D\u8036\uFF01( \u2022\u0300 \u03C9 \u2022\u0301 )\u2727"))},error:function(a){k(m,a)}})}function n(a){$.ajax({url:"https://api.vc.bilibili.com/dynamic_svr/v1/dynamic_svr/dynamic_new?uid="+M+"&type_list=8,512,4097,4098,4099,4100,4101",type:"GET",dataType:"json",json:"callback",success:function(b){if(0===b.code&&J){let d=b.data.cards;for(let b=0;b<d.length;b++){let f=JSON.parse(d[b+""].card),c=d[b+""].desc.type;V.includes(d[b+""].desc.dynamic_id)||((a||a===void 0)&&(8===c?(console.log("\u4F60\u5173\u6CE8\u7684up "+f.owner.name+" \u6295\u7A3F\u4E86\u65B0\u89C6\u9891\uFF01"+f.title+" see:"+d[b+""].desc.bvid),e(d[b+""].desc.dynamic_id,"\u4F60\u5173\u6CE8\u7684up "+f.owner.name+" \u6295\u7A3F\u4E86\u65B0\u89C6\u9891\uFF01",f.title,d[b+""].desc.bvid,f.owner.face,"https://b23.tv/")):512<=c&&4101>=c&&(console.log("\u4F60\u5173\u6CE8\u7684\u756A\u5267 "+f.apiSeasonInfo.title+" \u66F4\u65B0\u4E86\uFF01"+f.index+" see:"+f.url),e(d[b+""].desc.dynamic_id,"\u4F60\u5173\u6CE8\u7684\u756A\u5267 "+f.apiSeasonInfo.title+" \u66F4\u65B0\u4E86\uFF01",f.new_desc,f.url.replace("https://www.bilibili.com/",""),f.cover,"https://www.bilibili.com/"))),V.push(d[b+""].desc.dynamic_id))}}setTimeout(()=>{n(!0)},1e4)},error:function(a){k(n,a)}})}function o(){if(console.log("Grabbing medal info"),L&&u(localStorage.getItem("rua_lastDK").split("-"),(v().getFullYear()+"-"+v().getMonth()+"-"+v().getDate()).split("-"))){let a=[];localStorage.setItem("rua_lastDK",v().getFullYear()+"-"+v().getMonth()+"-"+v().getDate()),$.ajax({url:"https://api.live.bilibili.com/xlive/web-ucenter/user/MedalWall?target_id="+M,type:"GET",dataType:"json",json:"callback",xhrFields:{withCredentials:!0},success:function(b){console.log(b.data.list.length+" medal founded.");for(let c=0;c<b.data.list.length;c++)a.push(b.data.list[c].medal_info.target_id);q(a)},error:function(a){localStorage.setItem("rua_lastDK","1970-01-01"),k(o,a)}})}else console.log("No more grab needed.")}function q(a){let b=0;(function c(){$.ajax({url:"https://api.live.bilibili.com/live_user/v1/Master/info?uid="+a[b],type:"GET",dataType:"json",json:"callback",xhrFields:{withCredentials:!0},success:function(d){if(0===d.code||d.data.length){let e=new FormData;e.append("bubble","0"),e.append("msg","\u6253\u5361"),e.append("color","16777215"),e.append("mode","1"),e.append("fontsize","25"),e.append("rnd",Math.round(Date.now()/1e3)+""),e.append("roomid",d.data.room_id),e.append("csrf",O),e.append("csrf_token",O),fetch("https://api.live.bilibili.com/msg/send",{method:"POST",credentials:"include",body:e}).then(()=>{console.log("\u6253\u5361\u6210\u529F: https://live.bilibili.com/"+d.data.room_id),b<a.length&&(setTimeout(()=>{c()},1e3*(5*Math.random()+10)),b++)}).catch(a=>{console.error("Error:",a)})}}})})()}async function r(a){return!!("AaBb".includes(a.charAt(0))&&"Vv".includes(a.charAt(1)))&&("AaBb".substr(0,2).includes(a.charAt(0))?await s("aid="+a.substr(2,a.length-1)):await s("bvid="+a))}function s(a){return new Promise(function(b){let c=new XMLHttpRequest;c.open("GET","https://api.bilibili.com/x/web-interface/view?"+a,!0),c.send(null),c.onload=function(){200===c.status?b(0===JSON.parse(c.responseText).code):b(!1)}})}function t(a){console.log("checking update at "+new URL(a).hostname);var b=new XMLHttpRequest;b.open("GET",a+new Date().getTime(),!0),b.timeout=5e3,b.onreadystatechange=function(){null!==b.responseText&&4==b.readyState&&B!==/<title>(.*?)<\/title>/m.exec(b.responseText)[1]&&(B=/<title>(.*?)<\/title>/m.exec(b.responseText)[1],B===x?(console.log("Current version is latest."),C=!1,w("rua\u8C79\u5668","")):(console.log("A newer version found: "+B),C=!0,D=new URL(a).hostname.includes("github")?"https://github.com/TyraelDLee/HarukaEmoji/releases/latest":"https://gitee.com/tyrael-lee/HarukaEmoji/releases",w("rua\u8C79\u5668 \u6709\u66F4\u65B0\u53EF\u7528","1")))},b.send(),b.ontimeout=function(){t(a.includes("github")?"https://tyrael-lee.gitee.io/harukaemoji/?_=":"https://tyraeldlee.github.io/HarukaEmoji/?_=")},b.onerror=function(){setTimeout(()=>{t(a.includes("github")?"https://tyrael-lee.gitee.io/harukaemoji/?_=":"https://tyraeldlee.github.io/HarukaEmoji/?_=")},18e5)}}function u(a,b){return!!(parseInt(a[0])<parseInt(b[0]))||!(parseInt(a[0])>parseInt(b[0]))&&(!!(parseInt(a[1])<parseInt(b[1]))||!(parseInt(a[1])>parseInt(b[1]))&&parseInt(a[2])<parseInt(b[2]))}function v(){return new Date(new Date().getTime()+6e4*new Date().getTimezoneOffset()+288e5)}function w(a,b){chrome.browserAction.setTitle({title:a}),chrome.browserAction.setBadgeText({text:b})}const x="4.14.3";var y,z,A,B="4.14.3",C=!1,D="https://gitee.com/tyrael-lee/HarukaEmoji/releases",E=!0,F=!0,G=!1,H=!0,I="\u539F\u753B",J=!1,K=!1,L=!0,M=-1,N=-1,O=-1,P=M,Q=N,R=new FollowingMemberList,S=new FollowingMemberList,T=new WindowIDList,U=0;chrome.browserAction.setBadgeBackgroundColor({color:"#00A0FF"}),chrome.windows.getAll(function(a){for(let b=0;b<a.length;b++)T.push(a[b].id)}),chrome.windows.onCreated.addListener(function(a){T.push(a.id)}),chrome.windows.onRemoved.addListener(function(a){T.remove(a)}),chrome.windows.onFocusChanged.addListener(function(a){-1!==a&&T.push(a)}),chrome.runtime.onInstalled.addListener(function(){null===localStorage.getItem("rua_lastDK")&&localStorage.setItem("rua_lastDK","1970-01-01"),chrome.storage.sync.set({notification:!0},function(){E=!0}),chrome.storage.sync.set({medal:!0},function(){}),chrome.storage.sync.set({checkIn:!0},function(){F=!0}),chrome.storage.sync.set({imageNotice:!1},function(){G=!1}),chrome.storage.sync.set({bcoin:!0},function(){H=!0}),chrome.storage.sync.set({qn:!1},function(){}),chrome.storage.sync.set({qnvalue:"\u539F\u753B"},function(){}),chrome.storage.sync.set({dynamicPush:!0},function(){J=!0}),chrome.storage.sync.set({hiddenEntry:!1},function(){K=!1}),chrome.storage.sync.set({daka:!0},function(){L=!0}),chrome.tabs.create({url:"./readme.html"})}),chrome.storage.onChanged.addListener(function(a){for(let[b,{oldValue:c,newValue:d}]of Object.entries(a))"notification"===b&&(E=d),"checkIn"===b&&(F=d,F&&j()),"imageNotice"===b&&(G=d),"bcoin"===b&&(H=d,H&&m()),"dynamicPush"===b&&(J=d),"hiddenEntry"===b&&(K=d),"daka"===b&&(L=d,L&&o())}),chrome.runtime.onMessage.addListener(function(a,b,c){return"get_LoginInfo"===a.msg&&chrome.cookies.get({url:"https://www.bilibili.com/",name:"bili_jct"},function(a){O=null===a?-1:a.value,chrome.cookies.get({url:"https://www.bilibili.com/",name:"SESSDATA"},function(a){N=null===a?-1:a.value,c({res:O+","+N})})}),"get_UUID"===a.msg&&c({res:M}),"updateStatus"===a.msg&&c({res:C,address:D}),"popupfired"===a.msg&&w("rua\u8C79\u5668",""),a.msg.includes("QNV")&&(I=a.msg.split("?")[1],c({res:"ok"})),!0}),chrome.runtime.onConnect.addListener(function(a){"popup"===a.name&&a.onDisconnect.addListener(function(){chrome.storage.sync.set({qnvalue:I},function(){})})}),t("https://tyrael-lee.gitee.io/harukaemoji/?_="),setTimeout(function(){chrome.storage.sync.get(["notification"],a=>{E=a.notification}),chrome.storage.sync.get(["checkIn"],a=>{F=a.checkIn}),chrome.storage.sync.get(["imageNotice"],a=>{G=a.imageNotice}),chrome.storage.sync.get(["bcoin"],a=>{H=a.bcoin}),chrome.storage.sync.get(["qn"],a=>{a.qn}),chrome.storage.sync.get(["dynamicPush"],a=>{J=a.dynamicPush}),chrome.storage.sync.get(["hiddenEntry"],a=>{K=a.hiddenEntry}),chrome.storage.sync.get(["daka"],a=>{L=a.daka})},100),setTimeout(i,200),setInterval(i,5e3),setInterval(()=>{t("https://tyrael-lee.gitee.io/harukaemoji/?_=")},432e5);let V=[];chrome.webRequest.onBeforeSendHeaders.addListener(function(a){let b=a.requestHeaders;for(let c in b)"Cookie"===b[c].name&&(b[c].value="");return{requestHeaders:a.requestHeaders}},{urls:["https://api.live.bilibili.com/room/v1/Room/get_status_info_by_uids"]},["blocking","requestHeaders","extraHeaders"]),chrome.webRequest.onBeforeSendHeaders.addListener(function(a){let b=a.requestHeaders;for(let c in b)"Origin"===b[c].name&&(b[c].value="https://www.bilibili.com/");return{requestHeaders:a.requestHeaders}},{urls:["https://api.bilibili.com/x/vip/privilege/receive","https://api.live.bilibili.com/room/v1/Room/get_status_info_by_uids"]},["blocking","requestHeaders","extraHeaders"]),chrome.webRequest.onBeforeSendHeaders.addListener(function(a){let b=a.requestHeaders;for(let c in b)"Origin"===b[c].name&&(b[c].value="https://live.bilibili.com"),"Sec-Fetch-Site"===b[c].name&&(b[c].value="same-site");return a.requestHeaders.push({name:"Referer",value:"https://live.bilibili.com/"}),{requestHeaders:a.requestHeaders}},{urls:["https://api.live.bilibili.com/msg/send"]},["blocking","requestHeaders","extraHeaders"]),chrome.webRequest.onBeforeRequest.addListener(a=>K&&!a.url.includes("room_id=2842865")?{redirectUrl:"https://api.live.bilibili.com/xlive/web-room/v1/index/getInfoByUser?room_id=2842865&from=0"}:void 0,{urls:["*://api.live.bilibili.com/xlive/web-room/v1/index/getInfoByUser*"]},["blocking"]),function(){chrome.contextMenus.create({contexts:["selection","link"],title:"\u7528bilibili\u641C\u7D22",type:"normal",id:"rua-contextMenu"}),chrome.contextMenus.onClicked.addListener(a=>{"rua-contextMenu"===a.menuItemId&&r(a.selectionText).then(b=>{b?chrome.tabs.create({url:"https://www.bilibili.com/video/"+a.selectionText}):chrome.tabs.create({url:"https://search.bilibili.com/all?keyword="+a.selectionText})})})}()}();