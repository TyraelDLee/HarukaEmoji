!function(){function a(a){var b=Math.floor;a/=1e3;let c=b(a%60),d=b(a/60%60),e=b(a/3600%60);return e=0===e?"":(10>e&&0<e?"0"+e:e)+":",d=10>d?"0"+d:d,c=10>c?"0"+c:c,e+d+":"+c}function b(){if(-1!==P&&-1!==Q){X++;let a=0;fetch("https://api.bilibili.com/x/relation/followings?vmid="+P+"&pn="+X,{method:"GET",credentials:"include",body:null}).then(a=>a.json()).then(d=>{if("undefined"!=typeof d.data&&0!==d.data.length){var e=d.data.list;a=e.length;for(let a,b=0;b<e.length;b++)a=new FollowingMember(e[b].mid,e[b].uname),U.push(a),V.push(a);0===a&&0!==U.length()&&(X=0,U.update(V),V.clearAll(),console.log("Load following list complete. "+U.length()+" followings found."),c()),0!==a&&b()}}).catch(a=>{X=0,l(b,a)})}}function c(){let a="{\"uids\": ["+U.getUIDList().toString()+"]}";fetch("https://api.live.bilibili.com/room/v1/Room/get_status_info_by_uids?requestFrom=rua5",{method:"POST",credentials:"omit",body:a}).then(a=>a.json()).then(a=>{if(0===a.code){let b=new FollowingMemberList,c=a.data;for(let a=0;a<U.getUIDList().length;a++)if(c[U.getUIDList()[a]+""]!==void 0&&1===c[U.getUIDList()[a]+""].live_status){let d=new FollowingMember(c[U.getUIDList()[a]+""].uid,c[U.getUIDList()[a]+""].uname,c[U.getUIDList()[a]+""].face,c[U.getUIDList()[a]+""].cover_from_user,c[U.getUIDList()[a]+""].keyframe,c[U.getUIDList()[a]+""].room_id,c[U.getUIDList()[a]+""].title);d.ONAIR=!0,d.TYPE=1===c[U.getUIDList()[a]+""].broadcast_type?1:0,b.push(d)}0<b.list.length&&d(b)}}).catch(a=>{X=0,l(b,a)})}function d(a){if(0<U.length()){for(let b=0;b<a.length();b++)a.updateStatus(b,U.get(U.indexOf(a.get(b))).PUSHED),U.updateElementOnAirStatus(a.get(b),!0);for(let b=0;b<U.length();b++)U.get(b).ONAIR&&(-1===a.indexOf(U.get(b))?(U.get(b).COVER=void 0,U.get(b).FACE=void 0,U.get(b).KEYFRAME=void 0,U.get(b).ROOM_URL=void 0,U.get(b).TITLE=void 0,U.updateStatus(b,!1),U.updateElementOnAirStatus(U.get(b),!1)):!U.get(b).PUSHED&&(U.updateStatus(b,!0),console.log(U.get(b).TITLE+" "+U.get(b).NAME+" "+new Date),H&&e(U.get(b).TITLE,U.get(b).NAME,U.get(b).ROOM_URL,U.get(b).COVER,U.get(b).TYPE,U.get(b).FACE)))}setTimeout(b,1e4)}function e(a,b,c,d,e,h){let i=Math.random(),j=b+" \u5F00\u64AD\u5566!\r\n\u662F"+(0===e?"\u7535\u8111":"\u624B\u673A")+"\u76F4\u64AD\uFF01";J?g(i,a,j,c,d,h,"https://live.bilibili.com/"):f(i,a,j,c,h,"https://live.bilibili.com/")}function f(a,b,c,d,e,f){e=null==e.length||0===e.length?"../images/haruka128.png":e,chrome.notifications.create(a+":"+d,{type:"basic",iconUrl:e,title:b,message:c,contextMessage:"rua\u8C79\u5668"},function(a){h(a,f)})}function g(a,b,c,d,e,f,g){f=null==f.length||0===f.length?"../images/haruka128.png":f,e=null==e.length||0===e.length?f:e,chrome.notifications.create(a+":"+d,{type:"image",iconUrl:f,title:b,message:c,imageUrl:e,contextMessage:"rua\u8C79\u5668"},function(a){h(a,g)})}function h(a,b){chrome.notifications.onClicked.addListener(function(c){c===a&&(chrome.windows.getAll(function(a){0<a.length?(chrome.windows.update(W.getCurrent(),{focused:!0}),chrome.tabs.create({url:b+c.split(":")[1]})):chrome.windows.create({url:b+c.split(":")[1]})}),chrome.notifications.clear(a))})}function i(){k(),n(),q(),A=setInterval(k,216e5),B=setInterval(n,432e5),C=setInterval(q,36e5)}function j(){chrome.cookies.get({url:"https://www.bilibili.com/",name:"DedeUserID"},function(a){chrome.cookies.get({url:"https://www.bilibili.com/",name:"SESSDATA"},function(c){P=null===a?-1:a.value,Q=null===c?-1:c.value,(-1===P||-1===Q)&&P!==S&&Q!==T&&(console.log("Session info does not exist, liver stream info listener cleared."),clearInterval(A),clearInterval(B),clearInterval(C)),-1!==P&&-1!==Q&&P!==S&&Q!==T&&(console.log("Session info got."),U.clearAll(),X=0,o(!1),i(),b()),S=P,T=Q})}),chrome.cookies.get({url:"https://www.bilibili.com/",name:"bili_jct"},function(a){R=null===a?-1:a.value})}function k(){I&&fetch("https://api.live.bilibili.com/xlive/web-ucenter/v1/sign/DoSign",{method:"GET",credentials:"include",body:null}).then(()=>{console.log("\u7B7E\u5230\u6210\u529F "+new Date().toUTCString())}).catch(a=>{l(k,a)})}function l(a,b){console.log("ERROR found @ "+new Date+":"),console.log(b),"undefined"!=typeof b.responseJSON&&-412===b.responseJSON.code?setTimeout(a,9e5):setTimeout(a,2e4)}function m(){fetch("https://api.bilibili.com/x/vip/privilege/receive?requestFrom=rua5",{method:"POST",credentials:"include",body:{type:1,csrf:R}}).then(a=>a.json()).then(()=>{console.log("\u5151\u6362\u6210\u529F\uFF01\u597D\u8036( \u2022\u0300 \u03C9 \u2022\u0301 )\u2727"),chrome.notifications.create(Math.random()+"",{type:"basic",iconUrl:"./images/abaaba.png",title:"\u672C\u6708\u5927\u4F1A\u5458\u76845B\u5E01\u5151\u6362\u6210\u529F\uFF01",message:""},function(a){setTimeout(function(){chrome.notifications.clear(a)},3e3)})}).catch(a=>{l(n,a)})}function n(){K&&fetch("https://api.bilibili.com/x/vip/privilege/my",{method:"GET",credentials:"include",body:null}).then(a=>a.json()).then(a=>{console.log("checked vip status"),0===a.code&&(1===a.data.list[0].type&&0===a.data.list[0].state?m():1===a.data.list[0].type&&1===a.data.list[0].state&&console.log("\u8FD9\u4E2A\u6708\u7684\u5DF2\u7ECF\u5151\u6362\u8FC7\u4E86\uFF0C\u597D\u8036\uFF01( \u2022\u0300 \u03C9 \u2022\u0301 )\u2727"))}).catch(a=>{l(n,a)})}function o(a){fetch("https://api.vc.bilibili.com/dynamic_svr/v1/dynamic_svr/dynamic_new?uid="+P+"&type_list=8,512,4097,4098,4099,4100,4101",{method:"GET",credentials:"include",body:null}).then(a=>a.json()).then(b=>{if(0===b.code&&M){let d=b.data.cards;for(let b=0;b<d.length;b++){let e=JSON.parse(d[b+""].card),c=d[b+""].desc.type;$.includes(d[b+""].desc.dynamic_id)||((a||a===void 0)&&(8===c?(console.log("\u4F60\u5173\u6CE8\u7684up "+d[b+""].desc.user_profile.info.uname+" \u6295\u7A3F\u4E86\u65B0\u89C6\u9891\uFF01"+e.title+" see:"+d[b+""].desc.bvid),f(d[b+""].desc.dynamic_id,"\u4F60\u5173\u6CE8\u7684up "+d[b+""].desc.user_profile.info.uname+" \u6295\u7A3F\u4E86\u65B0\u89C6\u9891\uFF01",e.title,d[b+""].desc.bvid,d[b+""].desc.user_profile.info.face,"https://b23.tv/")):512<=c&&4101>=c&&(console.log("\u4F60\u5173\u6CE8\u7684\u756A\u5267 "+e.apiSeasonInfo.title+" \u66F4\u65B0\u4E86\uFF01"+e.index+" see:"+e.url),f(d[b+""].desc.dynamic_id,"\u4F60\u5173\u6CE8\u7684\u756A\u5267 "+e.apiSeasonInfo.title+" \u66F4\u65B0\u4E86\uFF01",e.new_desc,e.url.replace("https://www.bilibili.com/",""),e.cover,"https://www.bilibili.com/"))),$.push(d[b+""].desc.dynamic_id))}}setTimeout(()=>{o(!0)},1e4)}).catch(a=>{l(o,a)})}function q(){if(console.log("Grabbing medal info"),O&&(null===localStorage.getItem("rua_lastDK")||v(localStorage.getItem("rua_lastDK").split("-"),(w().getFullYear()+"-"+w().getMonth()+"-"+w().getDate()).split("-")))){let a=[];localStorage.setItem("rua_lastDK",w().getFullYear()+"-"+w().getMonth()+"-"+w().getDate()),fetch("https://api.live.bilibili.com/xlive/web-ucenter/user/MedalWall?target_id="+P,{method:"GET",credentials:"include",body:null}).then(a=>a.json()).then(b=>{console.log(b.data.list.length+" medal founded.");for(let c=0;c<b.data.list.length;c++)a.push(b.data.list[c].medal_info.target_id);r(a)}).catch(a=>{localStorage.setItem("rua_lastDK","1970-01-01"),l(q,a)})}else console.log("No more grab needed.")}function r(a){let b=0;(function c(){fetch("https://api.live.bilibili.com/live_user/v1/Master/info?uid="+a[b],{method:"GET",credentials:"include",body:null}).then(a=>a.json()).then(d=>{if(0===d.code||0<d.data.length){let e=new FormData;e.append("bubble","0"),e.append("msg","\u6253\u5361"),e.append("color","16777215"),e.append("mode","1"),e.append("fontsize","25"),e.append("rnd",Math.round(Date.now()/1e3)+""),e.append("roomid",d.data.room_id),e.append("csrf",R),e.append("csrf_token",R),fetch("https://api.live.bilibili.com/msg/send?requestFrom=rua5",{method:"POST",credentials:"include",body:e}).then(()=>{console.log("\u6253\u5361\u6210\u529F: https://live.bilibili.com/"+d.data.room_id),b<a.length&&(setTimeout(()=>{c()},1e3*(5*Math.random()+10)),b++)}).catch(a=>{console.error("Error:",a)})}})})()}async function s(a){return!!("AaBb".includes(a.charAt(0))&&"Vv".includes(a.charAt(1)))&&("AaBb".substr(0,2).includes(a.charAt(0))?await t("aid="+a.substr(2,a.length-1)):await t("bvid="+a))}function t(a){return new Promise(function(b){let c=new XMLHttpRequest;c.open("GET","https://api.bilibili.com/x/web-interface/view?"+a,!0),c.send(null),c.onload=function(){200===c.status?b(0===JSON.parse(c.responseText).code):b(!1)}})}function u(a){console.log("checking update at "+new URL(a).hostname);var b=new XMLHttpRequest;b.open("GET",a+new Date().getTime(),!0),b.timeout=5e3,b.onreadystatechange=function(){null!==b.responseText&&4==b.readyState&&null!==/<title>(.*?)<\/title>/m.exec(b.responseText)&&D!==/<title>(.*?)<\/title>/m.exec(b.responseText)[1]&&(D=/<title>(.*?)<\/title>/m.exec(b.responseText)[1],D===y?(console.log("Current version is latest."),E=!1,x("rua\u8C79\u5668","")):(console.log("A newer version found: "+D),E=!0,F=new URL(a).hostname.includes("github")?"https://github.com/TyraelDLee/HarukaEmoji/releases/latest":"https://gitee.com/tyrael-lee/HarukaEmoji/releases",x("rua\u8C79\u5668 \u6709\u66F4\u65B0\u53EF\u7528","1")))},b.send(),b.ontimeout=function(){u(a.includes("github")?"https://tyrael-lee.gitee.io/harukaemoji/?_=":"https://tyraeldlee.github.io/HarukaEmoji/?_=")},b.onerror=function(){setTimeout(()=>{u(a.includes("github")?"https://tyrael-lee.gitee.io/harukaemoji/?_=":"https://tyraeldlee.github.io/HarukaEmoji/?_=")},18e5)}}function v(a,b){return!!(parseInt(a[0])<parseInt(b[0]))||!(parseInt(a[0])>parseInt(b[0]))&&(!!(parseInt(a[1])<parseInt(b[1]))||!(parseInt(a[1])>parseInt(b[1]))&&parseInt(a[2])<parseInt(b[2]))}function w(){return new Date(new Date().getTime()+6e4*new Date().getTimezoneOffset()+288e5)}function x(a,b){chrome.browserAction.setTitle({title:a}),chrome.browserAction.setBadgeText({text:b})}const y=chrome.runtime.getManifest().version,z=new CRC32;var A,B,C,D=y,E=!1,F="https://gitee.com/tyrael-lee/HarukaEmoji/releases",G="",H=!0,I=!0,J=!1,K=!0,L="\u539F\u753B",M=!1,N=!1,O=!0,P=-1,Q=-1,R=-1,S=P,T=Q,U=new FollowingMemberList,V=new FollowingMemberList,W=new WindowIDList,X=0,Y=4,Z="superfast";chrome.browserAction.setBadgeBackgroundColor({color:"#00A0FF"}),chrome.windows.getAll(function(a){for(let b=0;b<a.length;b++)W.push(a[b].id)}),chrome.windows.onCreated.addListener(function(a){W.push(a.id)}),chrome.windows.onRemoved.addListener(function(a){W.remove(a)}),chrome.windows.onFocusChanged.addListener(function(a){-1!==a&&W.push(a)}),chrome.runtime.onInstalled.addListener(function(){null===localStorage.getItem("rua_lastDK")&&localStorage.setItem("rua_lastDK","1970-01-01"),chrome.storage.sync.set({notification:!0},function(){H=!0}),chrome.storage.sync.set({medal:!0},function(){}),chrome.storage.sync.set({checkIn:!0},function(){I=!0}),chrome.storage.sync.set({imageNotice:!1},function(){J=!1}),chrome.storage.sync.set({bcoin:!0},function(){K=!0}),chrome.storage.sync.set({qn:!1},function(){}),chrome.storage.sync.set({qnvalue:"\u539F\u753B"},function(){}),chrome.storage.sync.set({dynamicPush:!0},function(){M=!0}),chrome.storage.sync.set({hiddenEntry:!1},function(){N=!1}),chrome.storage.sync.set({daka:!0},function(){O=!0}),chrome.storage.sync.set({record:!0}),chrome.storage.sync.set({decodeThread:4},function(){Y=4}),chrome.storage.sync.set({decodePreset:"superfast"},function(){Z="superfast"}),chrome.storage.sync.set({prerecord:300},function(){}),chrome.tabs.create({url:"./readme.html"})}),chrome.storage.onChanged.addListener(function(a){for(let[b,{oldValue:c,newValue:d}]of Object.entries(a))"notification"===b&&(H=d),"checkIn"===b&&(I=d,I&&k()),"imageNotice"===b&&(J=d),"bcoin"===b&&(K=d,K&&n()),"dynamicPush"===b&&(M=d),"hiddenEntry"===b&&(N=d),"daka"===b&&(O=d,O&&q()),"decodePreset"===b&&(Z=d),"decodeThread"===b&&(Y=d)}),chrome.runtime.onMessage.addListener(function(b,c,d){if("get_LoginInfo"===b.msg&&chrome.cookies.get({url:"https://www.bilibili.com/",name:"bili_jct"},function(a){R=null===a?-1:a.value,chrome.cookies.get({url:"https://www.bilibili.com/",name:"SESSDATA"},function(a){Q=null===a?-1:a.value,d({res:R+","+Q+","+P})})}),"get_UUID"===b.msg&&d({res:P}),"updateStatus"===b.msg&&d({res:E,address:F}),"popupfired"===b.msg&&x("rua\u8C79\u5668",""),"requestDownload"===b.msg&&(G=b.fileName),"requestDanmaku"===b.msg){let c=new DanmakuArr;for(let d=0;d<b.danmakuObj.length;d++)void 0===b.danmakuObj[d].progress&&(b.danmakuObj[d].progress=0),c.push(new DanmakuObj(a(b.danmakuObj[d].progress),z.crack(b.danmakuObj[d].midHash),b.danmakuObj[d].content));c.sort(c.size-1),d({danmakuContent:c,danmakuPoolSize:b.danmakuObj.length})}if("requestUserInfo"===b.msg&&fetch("https://api.bilibili.com/x/web-interface/card?mid="+b.mid+"&photo=true&requestFrom=rua5",{method:"GET",headers:{Accept:"application/json"},credentials:"include",body:null}).then(a=>a.json()).then(a=>{0===a.code&&null!==a.data&&d({response:a.data.card})}),"requestEncode"===b.msg){console.log(Y+" "+Z+" ");const c=b.blob,{createFFmpeg:d,fetchFile:e}=FFmpeg,f=d({corePath:"./ffmpeg/ffmpeg-core.js",log:!0});(async()=>{let d;await f.load(),f.FS("writeFile","video.mp4",await e(c)),1<b.startTime?(await f.run("-i","video.mp4","-ss",b.startTime+"","-c","copy","footage.mp4"),await f.run("-i","footage.mp4","-threads",Y+"","-preset",Z,"final.mp4")):await f.run("-i","video.mp4","-threads",Y+"","-preset",Z,"final.mp4"),d=f.FS("readFile","final.mp4"),window.URL.revokeObjectURL(c);const g=URL.createObjectURL(new Blob([d.buffer],{type:"video/mp4"})),h=document.createElement("a");h.style.display="none",h.href=g,h.download=b.filename+".mp4",document.body.appendChild(h),h.click(),document.body.removeChild(h),window.URL.revokeObjectURL(g)})()}return b.msg.includes("QNV")&&(L=b.msg.split("?")[1],d({res:"ok"})),!0}),chrome.runtime.onConnect.addListener(function(a){"popup"===a.name&&a.onDisconnect.addListener(function(){chrome.storage.sync.set({qnvalue:L},function(){})})}),u("https://tyrael-lee.gitee.io/harukaemoji/?_="),setTimeout(function(){chrome.storage.sync.get(["notification"],a=>{H=a.notification}),chrome.storage.sync.get(["checkIn"],a=>{I=a.checkIn}),chrome.storage.sync.get(["imageNotice"],a=>{J=a.imageNotice}),chrome.storage.sync.get(["bcoin"],a=>{K=a.bcoin}),chrome.storage.sync.get(["qn"],a=>{a.qn}),chrome.storage.sync.get(["dynamicPush"],a=>{M=a.dynamicPush}),chrome.storage.sync.get(["hiddenEntry"],a=>{N=a.hiddenEntry}),chrome.storage.sync.get(["daka"],a=>{O=a.daka}),chrome.storage.sync.get(["decodeThread"],a=>{Y=a.decodeThread}),chrome.storage.sync.get(["decodePreset"],a=>{Z=a.decodePreset})},100),setTimeout(j,200),setInterval(j,5e3),setInterval(()=>{u("https://tyrael-lee.gitee.io/harukaemoji/?_=")},432e5);let $=[];chrome.webRequest.onBeforeSendHeaders.addListener(function(a){let b=a.requestHeaders;if("rua5"===new URLSearchParams(new URL(a.url).search).get("requestFrom"))for(let a in b)"Origin"===b[a].name&&(b[a].value="https://www.bilibili.com/");return{requestHeaders:a.requestHeaders}},{urls:["https://api.bilibili.com/x/vip/privilege/receive*","https://api.live.bilibili.com/room/v1/Room/get_status_info_by_uids*","https://api.bilibili.com/x/web-interface/card*"]},["blocking","requestHeaders","extraHeaders"]),chrome.webRequest.onBeforeSendHeaders.addListener(function(a){let b=a.requestHeaders;if("rua5"===new URLSearchParams(new URL(a.url).search).get("requestFrom")){for(let a in b)"Origin"===b[a].name&&(b[a].value="https://live.bilibili.com"),"Sec-Fetch-Site"===b[a].name&&(b[a].value="same-site");a.requestHeaders.push({name:"Referer",value:"https://live.bilibili.com/"})}return{requestHeaders:a.requestHeaders}},{urls:["https://api.live.bilibili.com/msg/send*"]},["blocking","requestHeaders","extraHeaders"]),chrome.webRequest.onBeforeRequest.addListener(a=>N&&!a.url.includes("room_id=2842865")?{redirectUrl:"https://api.live.bilibili.com/xlive/web-room/v1/index/getInfoByUser?room_id=2842865&from=0"}:void 0,{urls:["*://api.live.bilibili.com/xlive/web-room/v1/index/getInfoByUser*"]},["blocking"]),chrome.webRequest.onHeadersReceived.addListener(a=>{if("ruaDL"===new URLSearchParams(new URL(a.url).search).get("requestFrom")){let b=new URL(a.url).pathname.substr(new URL(a.url).pathname.length-4,4);".m4s"===b&&(b=".mp3"),a.responseHeaders.push({name:"Content-Disposition",value:"attachment; filename=\""+G+b+"\"; filename*=\"UTF-8''"+G+b+"\""})}return{responseHeaders:a.responseHeaders}},{urls:["*://*.bilivideo.com/upgcxcode/*","*://*.akamaized.net/upgcxcode/*"]},["responseHeaders","blocking"]),function(){chrome.contextMenus.create({contexts:["selection","link"],title:"\u7528bilibili\u641C\u7D22",type:"normal",id:"rua-contextMenu"}),chrome.contextMenus.onClicked.addListener(a=>{"rua-contextMenu"===a.menuItemId&&s(a.selectionText).then(b=>{b?chrome.tabs.create({url:"https://www.bilibili.com/video/"+a.selectionText}):chrome.tabs.create({url:"https://search.bilibili.com/all?keyword="+a.selectionText})})})}()}();