!function(){function e(){chrome.storage.local.get(['tempRoomNumber'],(e)=>{if(-1!==e.tempRoomNumber){let t=e.tempRoomNumber;chrome.storage.local.set({tempRoomNumber:-1},()=>{}),d(t).then((e)=>{if(1!==e.liveStatus)throw e;else s([e.up])}).catch((t)=>{console.log(t)})}})}function t(){document.getElementsByClassName('panel-container')[0].style.zIndex='-1',document.getElementsByClassName('panel-container')[0].style.display='none',document.getElementsByClassName('add-room-panel')[0].style.display='none',document.getElementsByClassName('setting-panel')[0].style.display='none',document.getElementsByClassName('following-block')[0].innerHTML='',document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('input')[0].onkeyup=null,document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('input')[0].value='',document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('input')[0].classList.contains('error-input')&&(document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('input')[0].classList.remove('error-input'),document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('span')[0].innerHTML='',document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('span')[0].removeAttribute('style'))}function n(){_.style.opacity='0',T.style.visibility='hidden'}function a(){fetch('https://api.bilibili.com/x/v2/reply/at',{method:'GET',credentials:'include',body:null}).then((e)=>e.json()).then((e)=>{let t=[];if(0===e.code)for(let n=0;n<e.data.groups.length;n++)for(let a=0;a<e.data.groups[''+n].items.length;a++)t.push(e.data.groups[''+n].items[a+''].mid);return t}).then((e)=>{s(e)})}function s(e){fetch('https://api.live.bilibili.com/room/v1/Room/get_status_info_by_uids?requestFrom=rua5',{method:'POST',credentials:'omit',body:'{"uids": ['+e+']}'}).then((e)=>e.json()).then((n)=>{if(0===n.code){let a=n.data,s=document.getElementsByClassName('following-block')[0];if(1===e.length){let n=a[e[0]];i(n),t()}else for(let n=0;n<e.length;n++)if(void 0!==a[e[n]]&&1===a[e[n]].live_status){let l=a[e[n]],o=document.createElement('div');o.classList.add('following-liver'),o.innerHTML=`<div class="user-face"><img src="${l.face}"></div><div class="following-room-info"><span class="room-title">${l.title}</span><span class="user-name">${l.uname}</span></div>`,s.append(o),o.addEventListener('click',()=>{i(l),t()})}}})}function l(t){let e=[t.offsetLeft,t.offsetTop],n=t.offsetParent;for(;null!==n;)e[0]+=n.offsetLeft,e[1]+=n.offsetTop+n.clientTop,n=n.offsetParent;return e[0]+=t.clientWidth-60,e[1]+=t.clientHeight-60,e}async function i(t){function e(e,t){1===t?e.setAttribute('style',`--number-of-row:1; --number-of-column:1;`):2===t?e.setAttribute('style',`--number-of-row:1; --number-of-column:0.5;`):5>t?e.setAttribute('style',`--number-of-row:0.5; --number-of-column:0.5;`):7>t?e.setAttribute('style',`--number-of-row:0.5; --number-of-column:0.3333;`):10>t?e.setAttribute('style',`--number-of-row:0.3333; --number-of-column:0.3333;`):13>t?e.setAttribute('style',`--number-of-row:0.3333; --number-of-column:0.25;`):e.setAttribute('style',`--number-of-row:0.25; --number-of-column:0.25;`)}function n(e,t,a){fetch(`https://api.live.bilibili.com/xlive/web-room/v2/index/getRoomPlayInfo?room_id=${e}&no_playurl=0&mask=1&qn=0&platform=web&protocol=0,1&format=0,1,2&codec=0,1&dolby=5&panorama=1`,{method:'GET',credentials:'include',signal:u.signal,body:null}).then((e)=>e.json()).then((s)=>{if(0===s.code){console.log(N);let l=null;l='undefined'==typeof s.data.playurl_info.playurl.stream[0].format[0].codec[1]?s.data.playurl_info.playurl.stream[0].format[0].codec[0]:s.data.playurl_info.playurl.stream[0].format[0].codec[1],i=mpegts.createPlayer({type:'flv',isLive:!0,url:l.url_info[a].host+l.base_url+l.url_info[a].extra}),i.attachMediaElement(t),i.load();try{i.play()}catch(t){}i.on(mpegts.Events.ERROR,()=>{N&&(i.unload(),g=setTimeout(()=>{let s=0===a?1:0;n(e,t,s)},1e3))})}})}function a(e,t,n=0){function l(t,n,o){let d=null;s=mpegts.createPlayer({type:'flv',isLive:!0,url:t.url_info[o].host+t.base_url+t.url_info[o].extra}),s.attachMediaElement(n),s.load();try{s.play(),d=setTimeout(()=>{n.currentTime=n.buffered.end(0)-1},2e3)}catch(t){}s.on(mpegts.Events.ERROR,(i)=>{console.log(i),++o,s.unload(),clearTimeout(d),o===t.url_info.length?setTimeout(()=>{a(e,n)},1e3):l(t,n,o)}),s.on(mpegts.Events.MEDIA_INFO,(e)=>{console.log(e),u.abort('no needed'),N=!1,null!==g&&(clearTimeout(g),g=null),i.destroy(),B.remove(),n.removeAttribute('style')})}fetch(`https://api.live.bilibili.com/xlive/web-room/v2/index/getRoomPlayInfo?room_id=${e}&protocol=0&format=0,1,2&codec=0,1&platform=web&ptype=8&dolby=5&panorama=1&qn=${A}`,{method:'GET',credentials:'include',signal:r.signal,body:null}).then((e)=>e.json()).then((s)=>{if(0===s.code){let i=s.data.playurl_info.playurl.stream[0].format[0].codec[0],o=s.data.playurl_info.playurl.stream[0].format[0].codec[1];(null===o||'undefined'==typeof o)&&(o=i),(null===i||'undefined'==typeof i)&&(i=o),(null===o||'undefined'==typeof o)&&(null===i||'undefined'==typeof i)?a(e,t):l(i,t,n)}else throw s.code}).catch((n)=>{console.log(n),setTimeout(()=>{a(e,t)},1e3)})}console.log(t);let s=null,i=null,r=new AbortController,u=new AbortController,g=null,p=null,N=!0,h=document.createElement('video');h.classList.add('video-player'),h.setAttribute('style','display: none;');let B=document.createElement('video');if(B.classList.add('video-player'),B.classList.add('video-player-preview'),16>j.size&&!j.has(t.uid)){function i(){S||I||(T.style.visibility='hidden',k.firstElementChild.style.display='none',_.style.display='none',R=!1)}function g(e){const t=document.createElement('canvas'),n=t.getContext('2d');t.width=300,t.height=60,n.drawImage(h,0,e?60:0,300,60);let a=n.getImageData(0,0,300,60).data,s=0,l=0,o=0;for(let t=0;18000>t;t++)s+=a[4*t],l+=a[4*t+1],o+=a[4*t+2];s/=18000,l/=18000,o/=18000;let i=0.299*s+0.587*l+0.114*o;_.style.color=192>i?'#aaa':'#555'}function N(){h.onpause=null,B.onpause=null,C.onmousemove=null,C.onclick=null,k.onmouseenter=null,k.onmouseleave=null,k.getElementsByClassName('volume')[0].onmouseenter=null,k.getElementsByClassName('volume')[0].onmouseleave=null,q.onmousedown=null,q.onmouseleave=null,q.onmousemove=null,q.onmouseup=null,k.getElementsByClassName('volume')[0].onwheel=null,k.getElementsByClassName('icon')[0].onmouseup=null,k.getElementsByClassName('close')[0].onclick=null,D.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].onkeyup,D.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].onkeydown,D.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].onselect=null,D.getElementsByClassName('send-danmaku')[0].onclick=null,k.getElementsByClassName('frame-chasing')[0].onclick=null,k.getElementsByClassName('refresh-stream')[0].onclick=null,b.disconnect()}j.set(t.uid,t);let f=document.getElementsByClassName('video-container')[0];e(f,j.size);let C=document.createElement('div'),b=new MutationObserver(async function(n){if(0<n.length){let l=n[0];if('attributes'===l.type&&null===h.getAttribute('src')){let n=await d(t.room_id);1===n.liveStatus?a(t.room_id,h,1):(null!=s&&s.destroy(),r.abort('user cancel'),console.log(`Stream ${t.uid} closed.`),N(),C.remove(),j.delete(t.uid),e(f,j.size),null!=p&&p.stop())}}});C.classList.add('video-stream'),C.append(h),C.append(B),h.onpause=()=>{h.play().catch(()=>{})},B.onpause=()=>{B.play().catch(()=>{})};let _=document.createElement('div');_.style.display='none',_.classList.add('video-owner-info-container'),_.innerHTML=`
            <a class="owner-avatar" style="background-image: url(${t.face})" href="https://space.bilibili.com/${t.uid}" target="_blank"></a>
            <div class="owner-text-info">
                <div class="owner-room-title"><a href="https://live.bilibili.com/${t.room_id}" target="_blank">${t.title}</a></div>
                <div class="owner-misc">
                    <div class="owner-name"><a href="https://space.bilibili.com/${t.uid}" target="_blank">${t.uname}</a></div>
                    <div style="margin: 0 5px">|</div>
                    <div class="live-zone">${t.area_v2_name}</div>
                </div>
            </div>`;let T=document.createElement('div');T.setAttribute('style',`display: block; position: absolute; bottom: 0px; width: 100%; height: 56px; background-image: linear-gradient(rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.7)); visibility: hidden;z-index:2`),C.append(T);let k=document.createElement('div');k.innerHTML+=`<div style="position: relative; user-select: none; z-index: 5; display: none"><div class="control-area"><div class="left"><div class="volume"><div class="volume-control" style="display: none"><div class="vertical-slider"><div class="number">100</div><div class="slider-rail"><div class="rail-background"></div><div class="slider-handle" style="top: 0px;"></div><div class="slider-track" style="height: 100%;"></div></div></div></div><span class="icon"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 36 36" style="enable-background:new 0 0 36 36; display: none;" xml:space="preserve"><path class="st0" d="M25.8,25.8c0.4,0.4,0.4,1,0,1.4s-1,0.4-1.4,0l-2.3-2.3c-0.2,0.1-0.4,0.2-0.6,0.3c-0.5,0.2-1.1,0-1.3-0.5\tc-0.2-0.5,0-1.1,0.5-1.3l0,0l-2.6-2.6v3.1c0,0.3-0.2,0.5-0.5,0.5c-0.1,0-0.2,0-0.3-0.1l-4.2-3.4h-1c-1.1,0-2-0.9-2-2v-2\tc0-1.1,0.9-2,2-2h0.2l-3.4-3.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0L25.8,25.8z"></path><path class="st0" d="M21.4,10.8c4,1.9,5.7,6.7,3.8,10.7c-0.1,0.2-0.2,0.4-0.3,0.6l-1.5-1.5c1.4-3,0.2-6.6-2.8-8l0,0\tc-0.5-0.2-0.7-0.8-0.5-1.3l0,0C20.4,10.7,21,10.5,21.4,10.8z"></path><path class="st0" d="M20,14.5c1.2,0.7,2,2,2,3.5c0,0.3,0,0.7-0.1,1L20,17.1V14.5z"></path><path class="st0" d="M17.9,11.7C18,11.8,18,11.9,18,12v3.1l-2.3-2.3l1.5-1.2C17.4,11.5,17.7,11.5,17.9,11.7z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 36 36" style="enable-background:new 0 0 36 36;" xml:space="preserve"><path class="st0" d="M20,14.5c1.9,1.1,2.6,3.6,1.5,5.5c-0.3,0.6-0.9,1.1-1.5,1.5V14.5z"></path><path class="st0" d="M21.4,10.7c4,1.9,5.7,6.7,3.8,10.7c-0.8,1.7-2,3-3.7,3.8c-0.5,0.2-1.1,0-1.3-0.5l0,0c-0.2-0.5,0-1.1,0.5-1.3\tc2.9-1.5,4.1-4.9,2.7-8c-0.6-1.2-1.6-2.3-2.8-2.8c-0.5-0.2-0.7-0.8-0.5-1.3S20.8,10.5,21.4,10.7C21.3,10.7,21.3,10.7,21.4,10.7\tL21.4,10.7z"></path><path class="st0" d="M17.9,11.7c0.1,0.1,0.1,0.1,0.1,0.2l0.1,12c0,0.3-0.2,0.5-0.5,0.5c-0.1,0-0.2,0-0.3-0.1l-4.2-3.4h-1\tc-1.1,0-2-0.9-2-2v-2c0-1.1,0.9-2,2-2h1l4.1-3.3C17.4,11.5,17.7,11.5,17.9,11.7L17.9,11.7z"></path></svg></span></div><div class="refresh-stream"><span class="icon"><svg viewBox="0 0 36 36" version="1.1" xmlns="http://www.w3.org/2000/svg"><g id="终稿" stroke="none" stroke-width="1" fill-rule="evenodd" opacity="0.9"><g id="图标切图" transform="translate(-475.000000, -74.000000)" fill-rule="nonzero"><g id="编组-3" transform="translate(421.000000, 56.000000)"><g id="编组-12" transform="translate(54.000000, 18.000000)"><g id="icon_刷新" transform="translate(11.000000, 9.000000)"><path d="M1.1040804,5.51795009 L2.56593636,6.98003284 C2.20442812,7.67167421 2,8.45841034 2,9.29289322 C2,12.054317 4.23857625,14.2928932 7,14.2928932 L7,12.5 C7,12.3673918 7.05267842,12.2402148 7.14644661,12.1464466 C7.34170876,11.9511845 7.65829124,11.9511845 7.85355339,12.1464466 L7.85355339,12.1464466 L10.6464466,14.9393398 C10.8417088,15.134602 10.8417088,15.4511845 10.6464466,15.6464466 L10.6464466,15.6464466 L7.85355339,18.4393398 C7.7597852,18.533108 7.63260824,18.5857864 7.5,18.5857864 C7.22385763,18.5857864 7,18.3619288 7,18.0857864 L7,18.0857864 L7,16.2928932 C3.13400675,16.2928932 0,13.1588865 0,9.29289322 C0,7.90269507 0.405257589,6.6071499 1.1040804,5.51795009 Z M6.85355339,0.146446609 C6.94732158,0.240214799 7,0.367391755 7,0.5 L7,2.29289322 C10.8659932,2.29289322 14,5.42689997 14,9.29289322 C14,10.682663 13.5949921,11.977838 12.8965656,13.0668293 L11.4343158,11.6052711 C11.7956669,10.9137463 12,10.127182 12,9.29289322 C12,6.53146947 9.76142375,4.29289322 7,4.29289322 L7,6.08578644 C7,6.36192881 6.77614237,6.58578644 6.5,6.58578644 C6.36739176,6.58578644 6.2402148,6.53310802 6.14644661,6.43933983 L3.35355339,3.64644661 C3.15829124,3.45118446 3.15829124,3.13460197 3.35355339,2.93933983 L6.14644661,0.146446609 C6.34170876,-0.0488155365 6.65829124,-0.0488155365 6.85355339,0.146446609 Z" id="Combined-Shape"></path></g></g></g></g></g></svg></span></div><div class="frame-chasing"><div><span class="icon"><svg class="squirtle-svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 22 22"><path d="M16 5a1 1 0 00-1 1v4.615a1.431 1.431 0 00-.615-.829L7.21 5.23A1.439 1.439 0 005 6.445v9.11a1.44 1.44 0 002.21 1.215l7.175-4.555a1.436 1.436 0 00.616-.828V16a1 1 0 002 0V6C17 5.448 16.552 5 16 5z" style="transform: scale(0.75);transform-origin: center;"></path></svg></span></div></div></div><div class="danmaku"><div class="input-container"><input placeholder="发个弹幕呗～"><span>0/20</span></div><div class="send-danmaku">发送</div><div class="emoji-bg"></div><div class="emoji-sec"></div></div><div class="right"><div class="close"><div><span class="icon"><svg class="rua-cross" viewBox="0 0 100 100"><rect x="25" y="45" rx="5" ry="5" width="50" height="10" style="transform: rotate(45deg);"/><rect x="25" y="45" rx="5" ry="5" width="50" height="10" style="transform: rotate(135deg);"/></svg></span></div></div></div></div></div>`;let L=100,w=L,P=!1,H=null,S=!1,I=!1,R=!1;C.onmousemove=()=>{clearTimeout(H),T.style.visibility='visible',k.firstElementChild.style.display='block',_.style.display='flex',H=setTimeout(i,1e3),R||g(1===j.size),R=!0},C.onclick=()=>{i()},k.onmouseenter=()=>{S=!0},k.onmouseleave=()=>{S=!1},k.getElementsByClassName('volume')[0].onmouseenter=()=>{k.getElementsByClassName('volume-control')[0].style.display='block'},k.getElementsByClassName('volume')[0].onmouseleave=()=>{x||(k.getElementsByClassName('volume-control')[0].style.display='none')};let q=k.getElementsByClassName('slider-rail')[0];q.onmousedown=(t)=>{t.stopPropagation(),x=!0;let n=l(q)[1]-100;0<=t.y-n&&53>=t.y-n&&(q.getElementsByClassName('slider-handle')[0].style.top=t.y-n+'px',L=v(100*(1-(t.y-n)/53)),k.getElementsByClassName('number')[0].innerText=L,q.getElementsByClassName('slider-track')[0].style.height=L+'%',h.volume=L/100,B.volume=L/100,0===L?(P=!P,w=L,k.getElementsByClassName('icon')[0].getElementsByTagName('svg')[1].style.display='none',k.getElementsByClassName('icon')[0].getElementsByTagName('svg')[0].style.display='block'):(P=!1,k.getElementsByClassName('icon')[0].getElementsByTagName('svg')[0].style.display='none',k.getElementsByClassName('icon')[0].getElementsByTagName('svg')[1].style.display='block')),q.onmousemove=(t)=>{t.stopPropagation(),0<=t.y-n&&53>=t.y-n&&(q.getElementsByClassName('slider-handle')[0].style.transition='none',q.getElementsByClassName('slider-track')[0].style.transition='none',q.getElementsByClassName('slider-handle')[0].style.top=t.y-n+'px',L=v(100*(1-(t.y-n)/53)),k.getElementsByClassName('number')[0].innerText=L,q.getElementsByClassName('slider-track')[0].style.height=L+'%',h.volume=L/100,B.volume=L/100,0===L?(P=!P,w=L,k.getElementsByClassName('icon')[0].getElementsByTagName('svg')[1].style.display='none',k.getElementsByClassName('icon')[0].getElementsByTagName('svg')[0].style.display='block'):(P=!1,k.getElementsByClassName('icon')[0].getElementsByTagName('svg')[0].style.display='none',k.getElementsByClassName('icon')[0].getElementsByTagName('svg')[1].style.display='block'))},q.onmouseup=(t)=>{t.stopPropagation(),q.onmousemove=null,q.onmouseup=null,q.getElementsByClassName('slider-handle')[0].style.transition='',q.getElementsByClassName('slider-track')[0].style.transition='',x=!1},q.onmouseleave=(t)=>{t.stopPropagation(),q.onmousemove=null,q.onmouseup=null,q.getElementsByClassName('slider-handle')[0].style.transition='',q.getElementsByClassName('slider-track')[0].style.transition=''}},k.getElementsByClassName('volume')[0].onwheel=(t)=>{L-=t.deltaY/10,100<L&&(L=100),0>L&&(L=0),0===L?(P=!0,k.getElementsByClassName('icon')[0].getElementsByTagName('svg')[1].style.display='none',k.getElementsByClassName('icon')[0].getElementsByTagName('svg')[0].style.display='block'):P&&(k.getElementsByClassName('icon')[0].getElementsByTagName('svg')[0].style.display='none',k.getElementsByClassName('icon')[0].getElementsByTagName('svg')[1].style.display='block',P=!1),L=v(L),h.volume=L/100,B.volume=L/100,k.getElementsByClassName('number')[0].innerText=L,q.getElementsByClassName('slider-handle')[0].style.top=53-53*(L/100)+'px',q.getElementsByClassName('slider-track')[0].style.height=L+'%'},k.getElementsByClassName('icon')[0].onmouseup=(t)=>{t.stopPropagation(),P?(k.getElementsByClassName('icon')[0].getElementsByTagName('svg')[0].style.display='none',k.getElementsByClassName('icon')[0].getElementsByTagName('svg')[1].style.display='block',L=w):(k.getElementsByClassName('icon')[0].getElementsByTagName('svg')[1].style.display='none',k.getElementsByClassName('icon')[0].getElementsByTagName('svg')[0].style.display='block',w=L,L=0),P=!P,h.volume=L/100,B.volume=L/100,k.getElementsByClassName('number')[0].innerText=L,q.getElementsByClassName('slider-handle')[0].style.top=53-53*(L/100)+'px',q.getElementsByClassName('slider-track')[0].style.height=L+'%'},k.getElementsByClassName('close')[0].onclick=()=>{null!=s&&s.destroy(),r.abort('user cancel'),u.abort('user cancel'),console.log('close '+t.uid),N(),C.remove(),j.delete(t.uid),e(f,j.size),null!=p&&p.stop()},k.getElementsByClassName('refresh-stream')[0].onclick=()=>{null!=s&&s.destroy()},k.getElementsByClassName('frame-chasing')[0].onclick=()=>{try{h.currentTime=h.buffered.end(0)-1}catch(t){}},k.classList.add('video-player-control'),C.append(_),C.append(k),f.append(C),o(t.uid,!0),console.log(A),0!=A&&setTimeout(()=>{a(t.room_id,h)},2e3),n(0===t.short_id?t.room_id:t.short_id,B,0),M&&(p=new E(t.area_v2_parent_id,t.area_v2_id,t.room_id,t.uid),p.E());let O=await m(t.room_id),z=await y(O.uid,t.uid),D=k.getElementsByClassName('danmaku')[0],F=[0,0],G=!0,X=!0;D.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].onfocus=()=>{I=!0},D.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].onblur=()=>{I=!1},D.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].addEventListener('compositionstart',()=>{G=!1,X=!1}),D.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].addEventListener('compositionend',()=>{G=!0}),D.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].onkeyup=(n)=>{13===n.keyCode&&X&&(n.preventDefault(),c(D.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].value,0,t.room_id,t.uid),D.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].value=''),G&&(X=!0),F=[D.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].selectionStart,D.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].selectionEnd],D.getElementsByClassName('input-container')[0].getElementsByTagName('span')[0].innerText=`${10>D.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].value.length?' ':''}${D.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].value.length}/${O.totalLength}`},D.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].onkeydown=(t)=>{'Enter'===t.code&&t.preventDefault()},D.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].onselect=(t)=>{F=[t.target.selectionStart,t.target.selectionEnd]},D.getElementsByClassName('send-danmaku')[0].onclick=()=>{c(D.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].value,0,t.room_id,t.uid),D.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].value='',D.getElementsByClassName('input-container')[0].getElementsByTagName('span')[0].innerText=`0/${O.totalLength}`},D.getElementsByClassName('input-container')[0].getElementsByTagName('span')[0].innerText=`0/${O.totalLength}`;let K=0;fetch('https://api.live.bilibili.com/xlive/web-ucenter/v2/emoticon/GetEmoticons?platform=pc&room_id='+t.room_id,{method:'GET',credentials:'include',body:null}).then((e)=>e.json()).then((e)=>{if(0===e.code){let n=D.getElementsByClassName('emoji-sec')[0];if(n.classList.add('emoji-tray'),0===e.code){const a=document.createElement('div'),s=document.createElement('div');s.classList.add('rua-emoji-header'),a.appendChild(s),n.appendChild(a),s.addEventListener('wheel',(t)=>{s.scrollLeft+=t.deltaY,s.scrollLeft+=t.deltaX,t.preventDefault()});const l=e.data.data;K>l.length&&(K=0);for(let e=0;e<l.length;e++){const a=document.createElement('div');a.classList.add('rua-header-item');const i=document.createElement('div');i.classList.add('rua-emoji-container'),e===K&&(a.classList.add('active'),i.classList.add('rua-emoji-container-show'),0===e&&i.classList.add('rua-emoji-container-show-xs')),a.innerHTML+=`<img src="${l[e].current_cover}"></div>`,a.onclick=()=>{for(let e=0;e<s.childNodes.length;e++)s.childNodes.item(e).classList.remove('active'),n.getElementsByClassName('rua-emoji-container')[e].classList.remove('rua-emoji-container-show'),0===e&&n.getElementsByClassName('rua-emoji-container')[e].classList.remove('rua-emoji-container-show-xs'),s.childNodes.item(e)===a&&(n.getElementsByClassName('rua-emoji-container')[e].classList.add('rua-emoji-container-show'),0===e&&n.getElementsByClassName('rua-emoji-container')[e].classList.add('rua-emoji-container-show-xs'),K=e);a.classList.add('active')},s.appendChild(a);for(let n=0;n<l[e].emoticons.length;n++){const a=document.createElement('div');a.classList.add('rua-emoji-icon'),a.classList.add('rua-emoji-item'),a.title=l[e].emoticons[n].emoji,0===e&&a.classList.add('rua-emoji-item-xs'),a.innerHTML+=`<div class="rua-emoji-requirement" style="background-color: ${l[e].emoticons[n].unlock_show_color};"><div class="rua-emoji-requirement-text">${l[e].emoticons[n].unlock_show_text}</div></div><img class="${1===l[e].emoticons[n].perm?'rua-emoji-icon-active':'rua-emoji-icon-inactive-new'}" src="${l[e].emoticons[n].url}">`,a.onclick=()=>{let s=D.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0];if(a.classList.contains('rua-emoji-icon-inactive-new')||0===e||c(l[e].emoticons[n].emoticon_unique,'systemEmoji',t.room_id,t.uid),0===e){if(s.selectionStart===s.selectionEnd)s.value=s.value.substring(0,s.selectionStart)+a.title+s.value.substring(s.selectionEnd,s.value.length);else{let e=s.value.substring(0,s.selectionStart),t=s.value.substring(s.selectionEnd,s.value.length);s.value=e+a.title+t}s.focus()}},i.append(a)}n.appendChild(i)}}}}).catch((e)=>{console.log(e)}),b.observe(h,{attributes:!0})}}async function o(e,t=!1){if(t&&(await y(N).then((e)=>{w=e})),1===H||-1===H&&1===w[0].medal_info.wearing_status)if(-1===H)p(w[0].medal_info.medal_id);else{P=e;for(const e of w)if(e.medal_info.target_id===P){p(e.medal_info.medal_id);break}}}function d(e){return fetch('https://api.live.bilibili.com/room/v1/Room/room_init?id='+e,{method:'GET',credentials:'include',body:null}).then((e)=>e.json()).then((e)=>{if(0===e.code)return{up:e.data.uid,roomid:e.data.room_id,liveStatus:e.data.live_status};throw e})}function m(e){return fetch('https://api.live.bilibili.com/xlive/web-room/v1/index/getInfoByUser?from=0&room_id='+e,{method:'GET',credentials:'include',body:null}).then((e)=>e.json()).then((e)=>{if(0===e.code){let t=0==e.data.privilege.privilege_type-1+1?4:e.data.privilege.privilege_type,n=e.data.info.uid,a=e.data.property.danmu.length;return{totalLength:a,uid:n,emojiRequiredPrivilege:t}}return{totalLength:0,uid:-1,emojiRequiredPrivilege:-1}}).catch(()=>({totalLength:0,uid:-1,emojiRequiredPrivilege:-1}))}function r(){try{chrome.runtime.sendMessage({msg:'get_LoginInfo'},function(e){B=e.res.split(',')[0],N=e.res.split(',')[1]}),chrome.runtime.sendMessage({msg:'get_LIVE_BUVID'},function(e){h=e.res.value})}catch(t){console.log(t)}}function u(){return v(Date.now()/1e3)}async function c(e,t,n,a){if(P!==a&&1===H){P=a;for(const e of w)if(e.medal_info.target_id===P){await p(e.medal_info.medal_id);break}}let s=new FormData;s.append('bubble','0'),s.append('msg',e),s.append('color','16777215'),s.append('mode','1'),t!==void 0&&'systemEmoji'===t&&s.append('dm_type','1'),s.append('fontsize','25'),s.append('rnd',u()+''),s.append('roomid',n),s.append('csrf',B),s.append('csrf_token',B),0!==e.length&&g(s)}function g(e){fetch('https://api.live.bilibili.com/msg/send?requestFrom=rua5',{method:'POST',credentials:'include',body:e}).then((e)=>e.json()).then((e)=>{console.log('sent'),0===e.message.length?'\u4F60\u6240\u5728\u7684\u5730\u533A\u6682\u65E0\u6CD5\u53D1\u8A00'===e.message&&console.log('Error:','\u4F60\u6240\u5728\u7684\u5730\u533A\u6682\u65E0\u6CD5\u53D1\u8A00'):console.log('Error:','\u4F60\u7684\u5F39\u5E55\u88AB\u7CFB\u7EDF\u541E\u4E86\uFF0C\u91CD\u8BD5\u4E00\u4E0B\u5427\u3002')}).catch((e)=>{console.log('Error:',e)})}function y(e,t){return fetch('https://api.live.bilibili.com/xlive/web-ucenter/user/MedalWall?target_id='+e,{method:'GET',credentials:'include',body:null}).then((e)=>e.json()).then((e)=>{if(0===e.code){if('undefined'!=typeof t){for(let n of e.data.list)if(n.medal_info.target_id===t)return{emojiRequiredMedalLevel:n.medal_info.level,medal_id:n.medal_info.medal_id,medal_name:n.medal_info.medal_name};return{emojiRequiredMedalLevel:0,medal_id:-1,medal_name:''}}return e.data.list}return{emojiRequiredMedalLevel:0,medal_id:-1,medal_name:''}}).catch(()=>({emojiRequiredMedalLevel:0,medal_id:-1,medal_name:''}))}function p(e){if('-1'!==B&&-1!==e&&0!==H){var t=new FormData;t.append('medal_id',e),t.append('csrf',B),t.append('csrf_token',B),fetch(-1===H?'https://api.live.bilibili.com/xlive/app-ucenter/v1/fansMedal/take_off':`https://api.live.bilibili.com/xlive/web-room/v1/fansMedal/wear`,{method:'POST',credentials:'include',body:t}).then(()=>{console.log('ware medal successful, MID='+e)})}}function E(e,t,n,a){function s(e){let t='';for(const n in e)t+=`${n}=${encodeURIComponent('id'===n||'device'===n?JSON.stringify(e[n]):e[n])}&`;return t.slice(0,-1)}function l(e,t){let n=JSON.stringify({platform:'web',parent_id:e.id[0],area_id:e.id[1],seq_id:e.id[2],room_id:e.id[3],buvid:e.device[0],uuid:e.device[1],ets:e.ets,time:e.time,ts:e.ts});for(let a of t)0===a?n=CryptoJS.HmacMD5(n,e.benchmark).toString(CryptoJS.enc.Hex):1===a?n=CryptoJS.HmacSHA1(n,e.benchmark).toString(CryptoJS.enc.Hex):2===a?n=CryptoJS.HmacSHA256(n,e.benchmark).toString(CryptoJS.enc.Hex):3===a?n=CryptoJS.HmacSHA224(n,e.benchmark).toString(CryptoJS.enc.Hex):4===a?n=CryptoJS.HmacSHA512(n,e.benchmark).toString(CryptoJS.enc.Hex):5===a?n=CryptoJS.HmacSHA384(n,e.benchmark).toString(CryptoJS.enc.Hex):void 0;return n}const i=window.navigator.userAgent;this.packageNumber=0,this.packagePayload={id:[e,t,this.packageNumber,n],device:[h,function(){let e='';for(let t=0;36>t;t++){const n=Math.floor(16*Math.random());e+=8===t||13===t||18===t||23===t?'-':14===t?'4':19===t?(8|3&n).toString(16):n.toString(16)}return e}()],ruid:a,ts:Date.now(),is_patch:0,heart_beat:[],ua:i},this.replayPayload={},this.timer=null,E.prototype.E=async function(){await fetch('https://live-trace.bilibili.com/xlive/data-interface/v1/x25Kn/E',{method:'POST',credentials:'include',headers:{"content-type":'application/x-www-form-urlencoded'},body:`${s(this.packagePayload)}&csrf_token=${B}&csrf=${B}&visit_id:`}).then((e)=>e.json()).then((a)=>{0===a.code&&(this.packageNumber++,this.timer=setInterval(()=>{this.X()},1e3*(a.data.heartbeat_interval-0)),this.replayPayload={id:[e,t,this.packageNumber,n],device:this.packagePayload.device,ruid:this.packagePayload.ruid,ets:a.data.timestamp,benchmark:a.data.secret_key,time:a.data.heartbeat_interval,ts:Date.now(),ua:i},this.replayPayload=Object.assign({s:l(this.replayPayload,a.data.secret_rule)},this.replayPayload))}).catch(()=>{this.stop(),this.E()})},E.prototype.X=async function(){await fetch('https://live-trace.bilibili.com/xlive/data-interface/v1/x25Kn/X',{method:'POST',credentials:'include',headers:{"content-type":'application/x-www-form-urlencoded'},body:`${s(this.replayPayload)}&csrf_token=${B}&csrf=${B}&visit_id:`}).then((e)=>e.json()).then((e)=>{0===e.code?(this.packageNumber++,this.replayPayload.id=[this.replayPayload.id[0],this.replayPayload.id[1],this.packageNumber,this.replayPayload.id[3]],this.replayPayload.benchmark=e.data.secret_key,this.replayPayload.time=e.data.heartbeat_interval,this.replayPayload.ets=e.data.timestamp,this.replayPayload.s=l(this.replayPayload,e.data.secret_rule)):(this.stop(),this.E())})},E.prototype.stop=function(){null!==this.timer&&(clearInterval(this.timer),this.timer=null)}}var v=Math.round;mpegts.LoggingControl.applyConfig({enableError:!1}),chrome.tabs.getCurrent().then((e)=>{chrome.windows.getCurrent().then((t)=>{chrome.storage.local.set({liveroomOn:[t.id,e.id]},()=>{})})}),chrome.windows.onFocusChanged.addListener(()=>{chrome.tabs.getCurrent().then((e)=>{chrome.windows.getCurrent().then((t)=>{chrome.storage.local.set({liveroomOn:[t.id,e.id]},()=>{})})})});let N,B,h,f=null,C=null,b=null,_=document.getElementsByClassName('control-bar')[0],T=document.getElementsByClassName('control-bar-bg')[0],k=null,L=!1,w=null,j=new Map,x=!1,P=-1,H=1,S=10,A=1e4,M=!0;r(),setInterval(r,3e3),setTimeout(()=>{y(N).then((e)=>{w=e})},100),window.addEventListener('focus',function(){(-1<P||-1==H)&&null!==w&&'undefined'!=typeof w&&o(P,-1==H),e()}),e(),window.addEventListener('beforeunload',()=>{chrome.storage.local.set({liveroomOn:[-1,-1]},()=>{})}),!function(){f=document.getElementsByClassName('add-room')[0].getElementsByTagName('svg')[0],b=document.getElementsByClassName('setting')[0].getElementsByTagName('svg')[0],C=document.getElementsByClassName('fullscreen')[0].getElementsByTagName('svg')[0];let e=document.getElementById('setting-heart-beat'),l=document.getElementById('setting-quality'),i=document.getElementById('setting-medal-switch-on'),m=document.getElementById('setting-medal-switch-off'),r=document.getElementById('setting-medal-switch-none');document.body.addEventListener('mousemove',()=>{clearTimeout(k),_.style.opacity='1',T.style.visibility='unset',k=setTimeout(n,1e3)}),document.body.addEventListener('mouseup',()=>{for(let e=0;e<document.body.getElementsByClassName('volume-control').length;e++)document.body.getElementsByClassName('volume-control')[e].style.display='none'}),chrome.storage.sync.get(['liveroom-medal-switch','liveroom-reconnection-time','liveroom-quality','liveroom-heart-beat'],function(t){H=t['liveroom-medal-switch'];-1===H?r.setAttribute('checked','true'):0===H?m.setAttribute('checked','true'):1===H?i.setAttribute('checked','true'):void 0;M=t['liveroom-heart-beat'],e.checked=M,S=t['liveroom-reconnection-time'],A=t['liveroom-quality'],l.value=A}),i.addEventListener('change',()=>{H=1,chrome.storage.sync.set({"liveroom-medal-switch":H},()=>{})}),m.addEventListener('change',()=>{H=0,chrome.storage.sync.set({"liveroom-medal-switch":H},()=>{})}),r.addEventListener('change',()=>{H=-1,o(0,-1===H),chrome.storage.sync.set({"liveroom-medal-switch":H},()=>{})}),e.addEventListener('change',()=>{M=e.checked,chrome.storage.sync.set({"liveroom-heart-beat":M},function(){})}),l.addEventListener('change',()=>{console.log(l.value),A=l.value,chrome.storage.sync.set({"liveroom-quality":A},function(){})}),f.addEventListener('click',()=>{document.getElementsByClassName('panel-container')[0].removeEventListener('click',t),document.getElementsByClassName('panel-container')[0].style.zIndex='10',document.getElementsByClassName('panel-container')[0].style.display='block',document.getElementsByClassName('panel-container')[0].addEventListener('click',t),document.getElementsByClassName('add-room-panel')[0].style.display='flex',document.getElementsByClassName('add-room-panel')[0].addEventListener('click',(t)=>{t.stopPropagation()}),document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('input')[0].onkeyup=(t)=>{document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('input')[0].classList.contains('error-input')&&(document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('input')[0].classList.remove('error-input'),document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('span')[0].innerHTML='',document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('span')[0].removeAttribute('style')),'Enter'===t.code&&d(t.target.value).then((e)=>{if(1!==e.liveStatus)throw e;else s([e.up])}).catch((t)=>{console.log(t),document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('input')[0].classList.add('error-input'),document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('span')[0].setAttribute('style',`transform: translateY(0px);`),1===t.liveStatus?'\u76F4\u64AD\u95F4\u4E0D\u5B58\u5728'===t.msg&&(document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('span')[0].innerHTML='\u76F4\u64AD\u95F4\u4E0D\u5B58\u5728'):document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('span')[0].innerHTML='\u4E3B\u64AD\u672A\u5F00\u64AD'})},a()}),b.addEventListener('click',()=>{document.getElementsByClassName('panel-container')[0].removeEventListener('click',t),document.getElementsByClassName('panel-container')[0].style.zIndex='10',document.getElementsByClassName('panel-container')[0].style.display='block',document.getElementsByClassName('panel-container')[0].addEventListener('click',t),document.getElementsByClassName('setting-panel')[0].style.display='flex',document.getElementsByClassName('setting-panel')[0].addEventListener('click',(t)=>{t.stopPropagation()})}),C.addEventListener('click',()=>{L?document.exitFullscreen().then(()=>{L=!1}).catch(()=>{document.body.requestFullscreen().then(),L=!0}):document.body.requestFullscreen().then(()=>{L=!0}).catch(()=>{document.exitFullscreen().then(),L=!1})})}()}();