!function(){function a(){chrome.storage.local.get(['tempRoomNumber'],(a)=>{if(-1!==a.tempRoomNumber){let b=a.tempRoomNumber;chrome.storage.local.set({tempRoomNumber:-1},()=>{}),i(b).then((a)=>{if(1!==a.liveStatus)throw a;else e([a.up])}).catch((a)=>{console.log(a)})}})}function b(){document.getElementsByClassName('panel-container')[0].style.zIndex='-1',document.getElementsByClassName('panel-container')[0].style.display='none',document.getElementsByClassName('add-room-panel')[0].style.display='none',document.getElementsByClassName('setting-panel')[0].style.display='none',document.getElementsByClassName('following-block')[0].innerHTML='',document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('input')[0].onkeyup=null,document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('input')[0].value='',document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('input')[0].classList.contains('error-input')&&(document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('input')[0].classList.remove('error-input'),document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('span')[0].innerHTML='',document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('span')[0].removeAttribute('style'))}function c(){y.style.opacity='0',z.style.visibility='hidden'}function d(){fetch('https://api.bilibili.com/x/v2/reply/at',{method:'GET',credentials:'include',body:null}).then((a)=>a.json()).then((a)=>{let b=[];if(0===a.code)for(let c=0;c<a.data.groups.length;c++)for(let d=0;d<a.data.groups[''+c].items.length;d++)b.push(a.data.groups[''+c].items[d+''].mid);return b}).then((a)=>{e(a)})}function e(a){fetch('https://api.live.bilibili.com/room/v1/Room/get_status_info_by_uids?requestFrom=rua5',{method:'POST',credentials:'omit',body:'{"uids": ['+a+']}'}).then((a)=>a.json()).then((c)=>{if(0===c.code){let d=c.data,e=document.getElementsByClassName('following-block')[0];if(1===a.length){let c=d[a[0]];g(c),b()}else for(let c=0;c<a.length;c++)if(void 0!==d[a[c]]&&1===d[a[c]].live_status){let f=d[a[c]],h=document.createElement('div');h.classList.add('following-liver'),h.innerHTML=`<div class="user-face"><img src="${f.face}"></div><div class="following-room-info"><span class="room-title">${f.title}</span><span class="user-name">${f.uname}</span></div>`,e.append(h),h.addEventListener('click',()=>{g(f),b()})}}})}function f(a){let b=[a.offsetLeft,a.offsetTop],c=a.offsetParent;for(;null!==c;)b[0]+=c.offsetLeft,b[1]+=c.offsetTop+c.clientTop,c=c.offsetParent;return b[0]+=a.clientWidth-60,b[1]+=a.clientHeight-60,b}async function g(a){function b(a,b){1===b?a.setAttribute('style',`--number-of-row:1; --number-of-column:1;`):2===b?a.setAttribute('style',`--number-of-row:1; --number-of-column:0.5;`):5>b?a.setAttribute('style',`--number-of-row:0.5; --number-of-column:0.5;`):7>b?a.setAttribute('style',`--number-of-row:0.5; --number-of-column:0.3333;`):10>b?a.setAttribute('style',`--number-of-row:0.3333; --number-of-column:0.3333;`):13>b?a.setAttribute('style',`--number-of-row:0.3333; --number-of-column:0.25;`):a.setAttribute('style',`--number-of-row:0.25; --number-of-column:0.25;`)}function c(a){a.innerHTML=`
                    <div class="video-status-info-row">
                        <div class="video-status-info-title">Mime 类型:</div>
                        <div class="video-status-info-data">${u.mimeType}</div>
                    </div>
                    <div class="video-status-info-row">
                        <div class="video-status-info-title">视频信息:</div>
                        <div class="video-status-info-data">${u.width}x${u.height}, ${u.fps}FPS, ${u.videoDataRate}Kbps</div>
                    </div>
                    <div class="video-status-info-row">
                        <div class="video-status-info-title">音频信息:</div>
                        <div class="video-status-info-data">${(u.audioSampleRate-0)/1e3}KHz, ${2===u.audioChannelCount?'Stereo':u.audioChannelCount}, ${u.audioDataRate}Kbps</div>
                    </div>
                    <div class="video-status-info-row">
                        <div class="video-status-info-title">编码器:</div>
                        <div class="video-status-info-data">${u.metadata.encoder}</div>
                    </div>
                    <div class="video-status-info-row">
                        <div class="video-status-info-title">视频编码:</div>
                        <div class="video-status-info-data">${u.videoCodec}</div>
                    </div>
                    <div class="video-status-info-row">
                        <div class="video-status-info-title">视频流源:</div>
                        <div class="video-status-info-data">${u.streamURL}</div>
                    </div>`}function d(a,b,e){fetch(`https://api.live.bilibili.com/xlive/web-room/v2/index/getRoomPlayInfo?room_id=${a}&no_playurl=0&mask=1&qn=0&platform=web&protocol=0,1&format=0,1,2&codec=0,1&dolby=5&panorama=1`,{method:'GET',credentials:'include',signal:n.signal,body:null}).then((a)=>a.json()).then((f)=>{if(0===f.code){console.log(t);let g=null;g='undefined'==typeof f.data.playurl_info.playurl.stream[0].format[0].codec[1]?f.data.playurl_info.playurl.stream[0].format[0].codec[0]:f.data.playurl_info.playurl.stream[0].format[0].codec[1],k=mpegts.createPlayer({type:'flv',isLive:!0,url:g.url_info[e].host+g.base_url+g.url_info[e].extra}),k.attachMediaElement(b),k.load();try{k.play().catch(()=>{})}catch(a){}k.on(mpegts.Events.ERROR,()=>{t&&(k.unload(),p=setTimeout(()=>{let c=0===e?1:0;d(a,b,c)},1e3))}),k.on(mpegts.Events.MEDIA_INFO,(b)=>{u=b,u.streamURL=g.url_info[e].host,c(document.getElementById(`video-status-info-container-${a}`))})}})}function e(a,b,d=0){function f(b,d,h){let i=null;g=mpegts.createPlayer({type:'flv',isLive:!0,url:b.url_info[h].host+b.base_url+b.url_info[h].extra}),g.attachMediaElement(d),g.load();try{g.play().catch(()=>{}),i=setTimeout(()=>{d.currentTime=d.buffered.end(0)-1},2e3)}catch(a){}g.on(mpegts.Events.ERROR,(c)=>{console.log(c),++h,g.unload(),clearTimeout(i),h===b.url_info.length?setTimeout(()=>{e(a,d)},1e3):f(b,d,h)}),g.on(mpegts.Events.MEDIA_INFO,(e)=>{console.log(e),u=e,u.streamURL=b.url_info[h].host,c(document.getElementById(`video-status-info-container-${a}`)),n.abort('no needed'),t=!1,null!==p&&(clearTimeout(p),p=null),k.destroy(),x.remove(),d.removeAttribute('style')})}fetch(`https://api.live.bilibili.com/xlive/web-room/v2/index/getRoomPlayInfo?room_id=${a}&protocol=0&format=0,1,2&codec=0,1&platform=web&ptype=8&dolby=5&panorama=1&qn=${I}`,{method:'GET',credentials:'include',signal:l.signal,body:null}).then((a)=>a.json()).then((c)=>{if(0!==c.code)throw c.code;else if(null===c.data.playurl_info||null===c.data.playurl_info.playurl)g.destroy();else{let g=c.data.playurl_info.playurl.stream[0].format[0].codec[0],h=c.data.playurl_info.playurl.stream[0].format[0].codec[1];(null===h||'undefined'==typeof h)&&(h=g),(null===g||'undefined'==typeof g)&&(g=h),(null===h||'undefined'==typeof h)&&(null===g||'undefined'==typeof g)?e(a,b):f(g,b,d)}}).catch((c)=>{console.log(c),l.signal.aborted||setTimeout(()=>{e(a,b)},1e3)})}console.log(a);let g=null,k=null,l=new AbortController,n=new AbortController,p=null,s=null,t=!0,u={mimeType:'',width:'0',height:'0',fps:'NaN',videoDataRate:'0',audioSampleRate:0,audioChannelCount:'NaN',audioDataRate:'0',videoCodec:'NaN',metadata:{encoder:'NaN'},streamURL:''},v=!1,w=document.createElement('video');w.classList.add('video-player'),w.setAttribute('style','display: none;');let x=document.createElement('video');if(x.classList.add('video-player'),x.classList.add('video-player-preview'),16>D.size&&!D.has(a.uid)){function k(){K||L||v||(A.style.visibility='hidden',B.firstElementChild.style.display='none',z.style.display='none')}function p(){w.onpause=null,x.onpause=null,u.onmousemove=null,u.onclick=null,B.onmouseenter=null,B.onmouseleave=null,B.getElementsByClassName('volume')[0].onmouseenter=null,B.getElementsByClassName('volume')[0].onmouseleave=null,M.onmousedown=null,M.onmouseleave=null,M.onmousemove=null,M.onmouseup=null,B.getElementsByClassName('volume')[0].onwheel=null,B.getElementsByClassName('icon')[0].onmouseup=null,B.getElementsByClassName('close')[0].onclick=null,R.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].onkeyup,R.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].onkeydown,R.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].onselect=null,R.getElementsByClassName('send-danmaku')[0].onclick=null,B.getElementsByClassName('frame-chasing')[0].onclick=null,B.getElementsByClassName('refresh-stream')[0].onclick=null,y.disconnect(),O.onclick=null}D.set(a.uid,a);let t=document.getElementsByClassName('video-container')[0];b(t,D.size);let u=document.createElement('div'),y=new MutationObserver(async function(c){if(0<c.length){let d=c[0];if('attributes'===d.type&&null===w.getAttribute('src')){let c=await i(a.room_id);1===c.liveStatus?e(a.room_id,w,1):(null!=g&&g.destroy(),l.abort('user cancel'),console.log(`Stream ${a.uid} closed.`),p(),u.remove(),D.delete(a.uid),b(t,D.size),null!=s&&s.stop())}}});u.classList.add('video-stream'),u.append(w),u.append(x),w.onpause=()=>{w.play().catch(()=>{})},x.onpause=()=>{x.play().catch(()=>{})};let z=document.createElement('div');z.style.display='none',z.classList.add('video-owner-info-container'),z.innerHTML=`
            
                <a class="owner-avatar" href="https://space.bilibili.com/${a.uid}" target="_blank"><img src="${a.face}"></a>
                <div class="owner-text-info">
                    <div class="owner-room-title"><a href="https://live.bilibili.com/${a.room_id}" target="_blank">${a.title}</a></div>
                    <div class="owner-misc">
                        <div class="owner-name"><a href="https://space.bilibili.com/${a.uid}" target="_blank">${a.uname}</a></div>
                        <div style="margin: 0 5px">|</div>
                        <div class="live-zone">${a.area_v2_name}</div>
                        <div style="margin: 0 5px">|</div>
                        <div class="live-status-btn" style="cursor: pointer" id="live-status-btn-${a.room_id}">显示统计信息</div>
                    </div>
                </div>
            
            `;let A=document.createElement('div');A.setAttribute('style',`display: block; position: absolute; bottom: 0px; width: 100%; height: 56px; background-image: linear-gradient(rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.7)); visibility: hidden;z-index:2`),u.append(A);let B=document.createElement('div');B.innerHTML+=`<div style="position: relative; user-select: none; z-index: 5; display: none"><div class="control-area"><div class="left"><div class="volume"><div class="volume-control" style="display: none"><div class="vertical-slider"><div class="number">100</div><div class="slider-rail"><div class="rail-background"></div><div class="slider-handle" style="top: 0px;"></div><div class="slider-track" style="height: 100%;"></div></div></div></div><span class="icon"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 36 36" style="enable-background:new 0 0 36 36; display: none;" xml:space="preserve"><path class="st0" d="M25.8,25.8c0.4,0.4,0.4,1,0,1.4s-1,0.4-1.4,0l-2.3-2.3c-0.2,0.1-0.4,0.2-0.6,0.3c-0.5,0.2-1.1,0-1.3-0.5\tc-0.2-0.5,0-1.1,0.5-1.3l0,0l-2.6-2.6v3.1c0,0.3-0.2,0.5-0.5,0.5c-0.1,0-0.2,0-0.3-0.1l-4.2-3.4h-1c-1.1,0-2-0.9-2-2v-2\tc0-1.1,0.9-2,2-2h0.2l-3.4-3.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0L25.8,25.8z"></path><path class="st0" d="M21.4,10.8c4,1.9,5.7,6.7,3.8,10.7c-0.1,0.2-0.2,0.4-0.3,0.6l-1.5-1.5c1.4-3,0.2-6.6-2.8-8l0,0\tc-0.5-0.2-0.7-0.8-0.5-1.3l0,0C20.4,10.7,21,10.5,21.4,10.8z"></path><path class="st0" d="M20,14.5c1.2,0.7,2,2,2,3.5c0,0.3,0,0.7-0.1,1L20,17.1V14.5z"></path><path class="st0" d="M17.9,11.7C18,11.8,18,11.9,18,12v3.1l-2.3-2.3l1.5-1.2C17.4,11.5,17.7,11.5,17.9,11.7z"></path></svg><svg version="1.1" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 36 36" style="enable-background:new 0 0 36 36;" xml:space="preserve"><path class="st0" d="M20,14.5c1.9,1.1,2.6,3.6,1.5,5.5c-0.3,0.6-0.9,1.1-1.5,1.5V14.5z"></path><path class="st0" d="M21.4,10.7c4,1.9,5.7,6.7,3.8,10.7c-0.8,1.7-2,3-3.7,3.8c-0.5,0.2-1.1,0-1.3-0.5l0,0c-0.2-0.5,0-1.1,0.5-1.3\tc2.9-1.5,4.1-4.9,2.7-8c-0.6-1.2-1.6-2.3-2.8-2.8c-0.5-0.2-0.7-0.8-0.5-1.3S20.8,10.5,21.4,10.7C21.3,10.7,21.3,10.7,21.4,10.7\tL21.4,10.7z"></path><path class="st0" d="M17.9,11.7c0.1,0.1,0.1,0.1,0.1,0.2l0.1,12c0,0.3-0.2,0.5-0.5,0.5c-0.1,0-0.2,0-0.3-0.1l-4.2-3.4h-1\tc-1.1,0-2-0.9-2-2v-2c0-1.1,0.9-2,2-2h1l4.1-3.3C17.4,11.5,17.7,11.5,17.9,11.7L17.9,11.7z"></path></svg></span></div><div class="refresh-stream"><span class="icon"><svg viewBox="0 0 36 36" version="1.1" xmlns="http://www.w3.org/2000/svg"><g id="终稿" stroke="none" stroke-width="1" fill-rule="evenodd" opacity="0.9"><g id="图标切图" transform="translate(-475.000000, -74.000000)" fill-rule="nonzero"><g id="编组-3" transform="translate(421.000000, 56.000000)"><g id="编组-12" transform="translate(54.000000, 18.000000)"><g id="icon_刷新" transform="translate(11.000000, 9.000000)"><path d="M1.1040804,5.51795009 L2.56593636,6.98003284 C2.20442812,7.67167421 2,8.45841034 2,9.29289322 C2,12.054317 4.23857625,14.2928932 7,14.2928932 L7,12.5 C7,12.3673918 7.05267842,12.2402148 7.14644661,12.1464466 C7.34170876,11.9511845 7.65829124,11.9511845 7.85355339,12.1464466 L7.85355339,12.1464466 L10.6464466,14.9393398 C10.8417088,15.134602 10.8417088,15.4511845 10.6464466,15.6464466 L10.6464466,15.6464466 L7.85355339,18.4393398 C7.7597852,18.533108 7.63260824,18.5857864 7.5,18.5857864 C7.22385763,18.5857864 7,18.3619288 7,18.0857864 L7,18.0857864 L7,16.2928932 C3.13400675,16.2928932 0,13.1588865 0,9.29289322 C0,7.90269507 0.405257589,6.6071499 1.1040804,5.51795009 Z M6.85355339,0.146446609 C6.94732158,0.240214799 7,0.367391755 7,0.5 L7,2.29289322 C10.8659932,2.29289322 14,5.42689997 14,9.29289322 C14,10.682663 13.5949921,11.977838 12.8965656,13.0668293 L11.4343158,11.6052711 C11.7956669,10.9137463 12,10.127182 12,9.29289322 C12,6.53146947 9.76142375,4.29289322 7,4.29289322 L7,6.08578644 C7,6.36192881 6.77614237,6.58578644 6.5,6.58578644 C6.36739176,6.58578644 6.2402148,6.53310802 6.14644661,6.43933983 L3.35355339,3.64644661 C3.15829124,3.45118446 3.15829124,3.13460197 3.35355339,2.93933983 L6.14644661,0.146446609 C6.34170876,-0.0488155365 6.65829124,-0.0488155365 6.85355339,0.146446609 Z" id="Combined-Shape"></path></g></g></g></g></g></svg></span></div><div class="frame-chasing"><div><span class="icon"><svg class="squirtle-svg-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 22 22"><path d="M16 5a1 1 0 00-1 1v4.615a1.431 1.431 0 00-.615-.829L7.21 5.23A1.439 1.439 0 005 6.445v9.11a1.44 1.44 0 002.21 1.215l7.175-4.555a1.436 1.436 0 00.616-.828V16a1 1 0 002 0V6C17 5.448 16.552 5 16 5z" style="transform: scale(0.75);transform-origin: center;"></path></svg></span></div></div></div><div class="danmaku"><div class="input-container"><input placeholder="发个弹幕呗～"><span>0/20</span></div><div class="send-danmaku">发送</div><div class="emoji-bg"></div><div class="emoji-sec"></div></div><div class="right"><div class="close"><div><span class="icon"><svg class="rua-cross" viewBox="0 0 100 100"><rect x="25" y="45" rx="5" ry="5" width="50" height="10" style="transform: rotate(45deg);"/><rect x="25" y="45" rx="5" ry="5" width="50" height="10" style="transform: rotate(135deg);"/></svg></span></div></div></div></div></div>`;let C=100,F=C,G=!1,H=null,K=!1,L=!1;u.onmousemove=()=>{clearTimeout(H),A.style.visibility='visible',B.firstElementChild.style.display='block',z.style.display='flex',H=setTimeout(k,1e3)},u.onclick=()=>{k()},B.onmouseenter=()=>{K=!0},B.onmouseleave=()=>{K=!1},B.getElementsByClassName('volume')[0].onmouseenter=()=>{B.getElementsByClassName('volume-control')[0].style.display='block'},B.getElementsByClassName('volume')[0].onmouseleave=()=>{E||(B.getElementsByClassName('volume-control')[0].style.display='none')};let M=B.getElementsByClassName('slider-rail')[0];M.onmousedown=(a)=>{a.stopPropagation(),E=!0;let b=f(M)[1]-100;0<=a.y-b&&53>=a.y-b&&(M.getElementsByClassName('slider-handle')[0].style.top=a.y-b+'px',C=r(100*(1-(a.y-b)/53)),B.getElementsByClassName('number')[0].innerText=C,M.getElementsByClassName('slider-track')[0].style.height=C+'%',w.volume=C/100,x.volume=C/100,0===C?(G=!G,F=C,B.getElementsByClassName('icon')[0].getElementsByTagName('svg')[1].style.display='none',B.getElementsByClassName('icon')[0].getElementsByTagName('svg')[0].style.display='block'):(G=!1,B.getElementsByClassName('icon')[0].getElementsByTagName('svg')[0].style.display='none',B.getElementsByClassName('icon')[0].getElementsByTagName('svg')[1].style.display='block')),M.onmousemove=(a)=>{a.stopPropagation(),0<=a.y-b&&53>=a.y-b&&(M.getElementsByClassName('slider-handle')[0].style.transition='none',M.getElementsByClassName('slider-track')[0].style.transition='none',M.getElementsByClassName('slider-handle')[0].style.top=a.y-b+'px',C=r(100*(1-(a.y-b)/53)),B.getElementsByClassName('number')[0].innerText=C,M.getElementsByClassName('slider-track')[0].style.height=C+'%',w.volume=C/100,x.volume=C/100,0===C?(G=!G,F=C,B.getElementsByClassName('icon')[0].getElementsByTagName('svg')[1].style.display='none',B.getElementsByClassName('icon')[0].getElementsByTagName('svg')[0].style.display='block'):(G=!1,B.getElementsByClassName('icon')[0].getElementsByTagName('svg')[0].style.display='none',B.getElementsByClassName('icon')[0].getElementsByTagName('svg')[1].style.display='block'))},M.onmouseup=(a)=>{a.stopPropagation(),M.onmousemove=null,M.onmouseup=null,M.getElementsByClassName('slider-handle')[0].style.transition='',M.getElementsByClassName('slider-track')[0].style.transition='',E=!1},M.onmouseleave=(a)=>{a.stopPropagation(),M.onmousemove=null,M.onmouseup=null,M.getElementsByClassName('slider-handle')[0].style.transition='',M.getElementsByClassName('slider-track')[0].style.transition=''}},B.getElementsByClassName('volume')[0].onwheel=(a)=>{C-=a.deltaY/10,100<C&&(C=100),0>C&&(C=0),0===C?(G=!0,B.getElementsByClassName('icon')[0].getElementsByTagName('svg')[1].style.display='none',B.getElementsByClassName('icon')[0].getElementsByTagName('svg')[0].style.display='block'):G&&(B.getElementsByClassName('icon')[0].getElementsByTagName('svg')[0].style.display='none',B.getElementsByClassName('icon')[0].getElementsByTagName('svg')[1].style.display='block',G=!1),C=r(C),w.volume=C/100,x.volume=C/100,B.getElementsByClassName('number')[0].innerText=C,M.getElementsByClassName('slider-handle')[0].style.top=53-53*(C/100)+'px',M.getElementsByClassName('slider-track')[0].style.height=C+'%'},B.getElementsByClassName('icon')[0].onmouseup=(a)=>{a.stopPropagation(),G?(B.getElementsByClassName('icon')[0].getElementsByTagName('svg')[0].style.display='none',B.getElementsByClassName('icon')[0].getElementsByTagName('svg')[1].style.display='block',C=F):(B.getElementsByClassName('icon')[0].getElementsByTagName('svg')[1].style.display='none',B.getElementsByClassName('icon')[0].getElementsByTagName('svg')[0].style.display='block',F=C,C=0),G=!G,w.volume=C/100,x.volume=C/100,B.getElementsByClassName('number')[0].innerText=C,M.getElementsByClassName('slider-handle')[0].style.top=53-53*(C/100)+'px',M.getElementsByClassName('slider-track')[0].style.height=C+'%'},B.getElementsByClassName('close')[0].onclick=()=>{null!=g&&g.destroy(),l.abort('user cancel'),n.abort('user cancel'),console.log('close '+a.uid),p(),u.remove(),D.delete(a.uid),b(t,D.size),null!=s&&s.stop()},B.getElementsByClassName('refresh-stream')[0].onclick=()=>{null!=g&&g.destroy()},B.getElementsByClassName('frame-chasing')[0].onclick=()=>{try{w.currentTime=w.buffered.end(0)-1}catch(a){}},B.classList.add('video-player-control');const N=document.createElement('div');N.style.display='none',N.classList.add('video-status-info-container'),N.id=`video-status-info-container-${a.room_id}`,u.append(N),u.append(z),u.append(B),t.append(u),h(a.uid,!0),console.log(I),0!=I&&setTimeout(()=>{e(a.room_id,w)},2e3),d(0===a.short_id?a.room_id:a.short_id,x,0),J&&(s=new q(a.area_v2_parent_id,a.area_v2_id,a.room_id,a.uid),s.E());let O=document.getElementById(`live-status-btn-${a.room_id}`);O.onclick=()=>{v=!v,v?(O.innerText='\u9690\u85CF\u7EDF\u8BA1\u4FE1\u606F',N.removeAttribute('style'),c(N)):(N.style.display='none',O.innerText='\u663E\u793A\u7EDF\u8BA1\u4FE1\u606F')};let P=await j(a.room_id),Q=await o(P.uid,a.uid),R=B.getElementsByClassName('danmaku')[0],S=[0,0],T=!0,U=!0;R.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].onfocus=()=>{L=!0},R.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].onblur=()=>{L=!1},R.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].addEventListener('compositionstart',()=>{T=!1,U=!1}),R.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].addEventListener('compositionend',()=>{T=!0}),R.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].onkeyup=(b)=>{13===b.keyCode&&U&&(b.preventDefault(),m(R.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].value,0,a.room_id,a.uid),R.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].value=''),T&&(U=!0),S=[R.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].selectionStart,R.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].selectionEnd],R.getElementsByClassName('input-container')[0].getElementsByTagName('span')[0].innerText=`${10>R.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].value.length?' ':''}${R.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].value.length}/${P.totalLength}`},R.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].onkeydown=(a)=>{'Enter'===a.code&&a.preventDefault()},R.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].onselect=(a)=>{S=[a.target.selectionStart,a.target.selectionEnd]},R.getElementsByClassName('send-danmaku')[0].onclick=()=>{m(R.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].value,0,a.room_id,a.uid),R.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].value='',R.getElementsByClassName('input-container')[0].getElementsByTagName('span')[0].innerText=`0/${P.totalLength}`},R.getElementsByClassName('input-container')[0].getElementsByTagName('span')[0].innerText=`0/${P.totalLength}`;let V=0;fetch('https://api.live.bilibili.com/xlive/web-ucenter/v2/emoticon/GetEmoticons?platform=pc&room_id='+a.room_id,{method:'GET',credentials:'include',body:null}).then((a)=>a.json()).then((b)=>{if(0===b.code){let c=R.getElementsByClassName('emoji-sec')[0];if(c.classList.add('emoji-tray'),0===b.code){const d=document.createElement('div'),f=document.createElement('div');f.classList.add('rua-emoji-header'),d.appendChild(f),c.appendChild(d),f.addEventListener('wheel',(a)=>{f.scrollLeft+=a.deltaY,f.scrollLeft+=a.deltaX,a.preventDefault()});const e=b.data.data;V>e.length&&(V=0);for(let b=0;b<e.length;b++){const d=document.createElement('div');d.classList.add('rua-header-item');const g=document.createElement('div');g.classList.add('rua-emoji-container'),b===V&&(d.classList.add('active'),g.classList.add('rua-emoji-container-show'),0===b&&g.classList.add('rua-emoji-container-show-xs')),d.innerHTML+=`<img src="${e[b].current_cover}"></div>`,d.onclick=()=>{for(let a=0;a<f.childNodes.length;a++)f.childNodes.item(a).classList.remove('active'),c.getElementsByClassName('rua-emoji-container')[a].classList.remove('rua-emoji-container-show'),0===a&&c.getElementsByClassName('rua-emoji-container')[a].classList.remove('rua-emoji-container-show-xs'),f.childNodes.item(a)===d&&(c.getElementsByClassName('rua-emoji-container')[a].classList.add('rua-emoji-container-show'),0===a&&c.getElementsByClassName('rua-emoji-container')[a].classList.add('rua-emoji-container-show-xs'),V=a);d.classList.add('active')},f.appendChild(d);for(let c=0;c<e[b].emoticons.length;c++){const d=document.createElement('div');d.classList.add('rua-emoji-icon'),d.classList.add('rua-emoji-item'),d.title=e[b].emoticons[c].emoji,0===b&&d.classList.add('rua-emoji-item-xs'),d.innerHTML+=`<div class="rua-emoji-requirement" style="background-color: ${e[b].emoticons[c].unlock_show_color};"><div class="rua-emoji-requirement-text">${e[b].emoticons[c].unlock_show_text}</div></div><img class="${1===e[b].emoticons[c].perm?'rua-emoji-icon-active':'rua-emoji-icon-inactive-new'}" src="${e[b].emoticons[c].url}">`,d.onclick=()=>{let f=R.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0];if(d.classList.contains('rua-emoji-icon-inactive-new')||0===b||m(e[b].emoticons[c].emoticon_unique,'systemEmoji',a.room_id,a.uid),0===b){if(f.selectionStart===f.selectionEnd)f.value=f.value.substring(0,f.selectionStart)+d.title+f.value.substring(f.selectionEnd,f.value.length);else{let a=f.value.substring(0,f.selectionStart),b=f.value.substring(f.selectionEnd,f.value.length);f.value=a+d.title+b}f.focus()}},g.append(d)}c.appendChild(g)}}}}).catch((a)=>{console.log(a)}),y.observe(w,{attributes:!0})}}async function h(a,b=!1){if(b&&(await o(s).then((a)=>{C=a})),1===G||-1===G&&1===C[0].medal_info.wearing_status)if(-1===G)p(C[0].medal_info.medal_id);else{F=a;for(const a of C)if(a.medal_info.target_id===F){p(a.medal_info.medal_id);break}}}function i(a){return fetch('https://api.live.bilibili.com/room/v1/Room/room_init?id='+a,{method:'GET',credentials:'include',body:null}).then((a)=>a.json()).then((a)=>{if(0===a.code)return{up:a.data.uid,roomid:a.data.room_id,liveStatus:a.data.live_status};throw a})}function j(a){return fetch('https://api.live.bilibili.com/xlive/web-room/v1/index/getInfoByUser?from=0&room_id='+a,{method:'GET',credentials:'include',body:null}).then((a)=>a.json()).then((a)=>{if(0===a.code){let b=0==a.data.privilege.privilege_type-1+1?4:a.data.privilege.privilege_type,c=a.data.info.uid,d=a.data.property.danmu.length;return{totalLength:d,uid:c,emojiRequiredPrivilege:b}}return{totalLength:0,uid:-1,emojiRequiredPrivilege:-1}}).catch(()=>({totalLength:0,uid:-1,emojiRequiredPrivilege:-1}))}function k(){try{chrome.runtime.sendMessage({msg:'get_LoginInfo'},function(a){t=a.res.split(',')[0],s=a.res.split(',')[1]}),chrome.runtime.sendMessage({msg:'get_LIVE_BUVID'},function(a){u=a.res.value})}catch(a){console.log(a)}}function l(){return r(Date.now()/1e3)}async function m(a,b,c,d){if(F!==d&&1===G){F=d;for(const a of C)if(a.medal_info.target_id===F){await p(a.medal_info.medal_id);break}}let e=new FormData;e.append('bubble','0'),e.append('msg',a),e.append('color','16777215'),e.append('mode','1'),b!==void 0&&'systemEmoji'===b&&e.append('dm_type','1'),e.append('fontsize','25'),e.append('rnd',l()+''),e.append('roomid',c),e.append('csrf',t),e.append('csrf_token',t),0!==a.length&&n(e)}function n(a){fetch('https://api.live.bilibili.com/msg/send?requestFrom=rua5',{method:'POST',credentials:'include',body:a}).then((a)=>a.json()).then((a)=>{console.log('sent'),0===a.message.length?'\u4F60\u6240\u5728\u7684\u5730\u533A\u6682\u65E0\u6CD5\u53D1\u8A00'===a.message&&console.log('Error:','\u4F60\u6240\u5728\u7684\u5730\u533A\u6682\u65E0\u6CD5\u53D1\u8A00'):console.log('Error:','\u4F60\u7684\u5F39\u5E55\u88AB\u7CFB\u7EDF\u541E\u4E86\uFF0C\u91CD\u8BD5\u4E00\u4E0B\u5427\u3002')}).catch((a)=>{console.log('Error:',a)})}function o(a,b){return fetch('https://api.live.bilibili.com/xlive/web-ucenter/user/MedalWall?target_id='+a,{method:'GET',credentials:'include',body:null}).then((a)=>a.json()).then((a)=>{if(0===a.code){if('undefined'!=typeof b){for(let c of a.data.list)if(c.medal_info.target_id===b)return{emojiRequiredMedalLevel:c.medal_info.level,medal_id:c.medal_info.medal_id,medal_name:c.medal_info.medal_name};return{emojiRequiredMedalLevel:0,medal_id:-1,medal_name:''}}return a.data.list}return{emojiRequiredMedalLevel:0,medal_id:-1,medal_name:''}}).catch(()=>({emojiRequiredMedalLevel:0,medal_id:-1,medal_name:''}))}function p(a){if('-1'!==t&&-1!==a&&0!==G){var b=new FormData;b.append('medal_id',a),b.append('csrf',t),b.append('csrf_token',t),fetch(-1===G?'https://api.live.bilibili.com/xlive/app-ucenter/v1/fansMedal/take_off':`https://api.live.bilibili.com/xlive/web-room/v1/fansMedal/wear`,{method:'POST',credentials:'include',body:b}).then(()=>{console.log('ware medal successful, MID='+a)})}}function q(a,b,c,d){function e(a){let b='';for(const c in a)b+=`${c}=${encodeURIComponent('id'===c||'device'===c?JSON.stringify(a[c]):a[c])}&`;return b.slice(0,-1)}function f(a,b){let c=JSON.stringify({platform:'web',parent_id:a.id[0],area_id:a.id[1],seq_id:a.id[2],room_id:a.id[3],buvid:a.device[0],uuid:a.device[1],ets:a.ets,time:a.time,ts:a.ts});for(let d of b)0===d?c=CryptoJS.HmacMD5(c,a.benchmark).toString(CryptoJS.enc.Hex):1===d?c=CryptoJS.HmacSHA1(c,a.benchmark).toString(CryptoJS.enc.Hex):2===d?c=CryptoJS.HmacSHA256(c,a.benchmark).toString(CryptoJS.enc.Hex):3===d?c=CryptoJS.HmacSHA224(c,a.benchmark).toString(CryptoJS.enc.Hex):4===d?c=CryptoJS.HmacSHA512(c,a.benchmark).toString(CryptoJS.enc.Hex):5===d?c=CryptoJS.HmacSHA384(c,a.benchmark).toString(CryptoJS.enc.Hex):void 0;return c}const g=window.navigator.userAgent;this.packageNumber=0,this.packagePayload={id:[a,b,this.packageNumber,c],device:[u,function(){let a='';for(let b=0;36>b;b++){const c=Math.floor(16*Math.random());a+=8===b||13===b||18===b||23===b?'-':14===b?'4':19===b?(8|3&c).toString(16):c.toString(16)}return a}()],ruid:d,ts:Date.now(),is_patch:0,heart_beat:[],ua:g},this.replayPayload={},this.timer=null,q.prototype.E=async function(){await fetch('https://live-trace.bilibili.com/xlive/data-interface/v1/x25Kn/E',{method:'POST',credentials:'include',headers:{"content-type":'application/x-www-form-urlencoded'},body:`${e(this.packagePayload)}&csrf_token=${t}&csrf=${t}&visit_id:`}).then((a)=>a.json()).then((d)=>{0===d.code&&(this.packageNumber++,this.timer=setInterval(()=>{this.X()},1e3*(d.data.heartbeat_interval-0)),this.replayPayload={id:[a,b,this.packageNumber,c],device:this.packagePayload.device,ruid:this.packagePayload.ruid,ets:d.data.timestamp,benchmark:d.data.secret_key,time:d.data.heartbeat_interval,ts:Date.now(),ua:g},this.replayPayload=Object.assign({s:f(this.replayPayload,d.data.secret_rule)},this.replayPayload))}).catch(()=>{this.stop(),this.E()})},q.prototype.X=async function(){await fetch('https://live-trace.bilibili.com/xlive/data-interface/v1/x25Kn/X',{method:'POST',credentials:'include',headers:{"content-type":'application/x-www-form-urlencoded'},body:`${e(this.replayPayload)}&csrf_token=${t}&csrf=${t}&visit_id:`}).then((a)=>a.json()).then((a)=>{0===a.code?(this.packageNumber++,this.replayPayload.id=[this.replayPayload.id[0],this.replayPayload.id[1],this.packageNumber,this.replayPayload.id[3]],this.replayPayload.benchmark=a.data.secret_key,this.replayPayload.time=a.data.heartbeat_interval,this.replayPayload.ets=a.data.timestamp,this.replayPayload.s=f(this.replayPayload,a.data.secret_rule)):(this.stop(),this.E())})},q.prototype.stop=function(){null!==this.timer&&(clearInterval(this.timer),this.timer=null)}}var r=Math.round;mpegts.LoggingControl.applyConfig({enableError:!1}),chrome.tabs.getCurrent().then((a)=>{chrome.windows.getCurrent().then((b)=>{chrome.storage.local.set({liveroomOn:[b.id,a.id]},()=>{})})}),chrome.windows.onFocusChanged.addListener(()=>{chrome.tabs.getCurrent().then((a)=>{chrome.windows.getCurrent().then((b)=>{chrome.storage.local.set({liveroomOn:[b.id,a.id]},()=>{})})})});let s,t,u,v=null,w=null,x=null,y=document.getElementsByClassName('control-bar')[0],z=document.getElementsByClassName('control-bar-bg')[0],A=null,B=!1,C=null,D=new Map,E=!1,F=-1,G=1,H=10,I=1e4,J=!0;k(),setInterval(k,3e3),setTimeout(()=>{o(s).then((a)=>{C=a})},100),window.addEventListener('focus',function(){(-1<F||0!=G)&&null!==C&&'undefined'!=typeof C&&h(F,1==G),a()}),a(),window.addEventListener('beforeunload',()=>{chrome.storage.local.set({liveroomOn:[-1,-1]},()=>{})}),!function(){v=document.getElementsByClassName('add-room')[0].getElementsByTagName('svg')[0],x=document.getElementsByClassName('setting')[0].getElementsByTagName('svg')[0],w=document.getElementsByClassName('fullscreen')[0].getElementsByTagName('svg')[0];let a=document.getElementById('setting-heart-beat'),f=document.getElementById('setting-quality'),g=document.getElementById('setting-medal-switch-on'),j=document.getElementById('setting-medal-switch-off'),k=document.getElementById('setting-medal-switch-none');document.body.addEventListener('mousemove',()=>{clearTimeout(A),y.style.opacity='1',z.style.visibility='unset',A=setTimeout(c,1e3)}),document.body.addEventListener('mouseup',()=>{for(let a=0;a<document.body.getElementsByClassName('volume-control').length;a++)document.body.getElementsByClassName('volume-control')[a].style.display='none'}),chrome.storage.sync.get(['liveroom-medal-switch','liveroom-reconnection-time','liveroom-quality','liveroom-heart-beat'],function(b){G=b['liveroom-medal-switch'];-1===G?k.setAttribute('checked','true'):0===G?j.setAttribute('checked','true'):1===G?g.setAttribute('checked','true'):void 0;J=b['liveroom-heart-beat'],a.checked=J,H=b['liveroom-reconnection-time'],I=b['liveroom-quality'],f.value=I}),g.addEventListener('change',()=>{G=1,chrome.storage.sync.set({"liveroom-medal-switch":G},()=>{})}),j.addEventListener('change',()=>{G=0,chrome.storage.sync.set({"liveroom-medal-switch":G},()=>{})}),k.addEventListener('change',()=>{G=-1,h(0,-1===G),chrome.storage.sync.set({"liveroom-medal-switch":G},()=>{})}),a.addEventListener('change',()=>{J=a.checked,chrome.storage.sync.set({"liveroom-heart-beat":J},function(){})}),f.addEventListener('change',()=>{console.log(f.value),I=f.value,chrome.storage.sync.set({"liveroom-quality":I},function(){})}),v.addEventListener('click',()=>{document.getElementsByClassName('panel-container')[0].removeEventListener('click',b),document.getElementsByClassName('panel-container')[0].style.zIndex='10',document.getElementsByClassName('panel-container')[0].style.display='block',document.getElementsByClassName('panel-container')[0].addEventListener('click',b),document.getElementsByClassName('add-room-panel')[0].style.display='flex',document.getElementsByClassName('add-room-panel')[0].addEventListener('click',(a)=>{a.stopPropagation()}),document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('input')[0].onkeyup=(a)=>{document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('input')[0].classList.contains('error-input')&&(document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('input')[0].classList.remove('error-input'),document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('span')[0].innerHTML='',document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('span')[0].removeAttribute('style')),'Enter'===a.code&&i(a.target.value).then((a)=>{if(1!==a.liveStatus)throw a;else e([a.up])}).catch((a)=>{console.log(a),document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('input')[0].classList.add('error-input'),document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('span')[0].setAttribute('style',`transform: translateY(0px);`),1===a.liveStatus?'\u76F4\u64AD\u95F4\u4E0D\u5B58\u5728'===a.msg&&(document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('span')[0].innerHTML='\u76F4\u64AD\u95F4\u4E0D\u5B58\u5728'):document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('span')[0].innerHTML='\u4E3B\u64AD\u672A\u5F00\u64AD'})},d()}),x.addEventListener('click',()=>{document.getElementsByClassName('panel-container')[0].removeEventListener('click',b),document.getElementsByClassName('panel-container')[0].style.zIndex='10',document.getElementsByClassName('panel-container')[0].style.display='block',document.getElementsByClassName('panel-container')[0].addEventListener('click',b),document.getElementsByClassName('setting-panel')[0].style.display='flex',document.getElementsByClassName('setting-panel')[0].addEventListener('click',(a)=>{a.stopPropagation()})}),w.addEventListener('click',()=>{B?document.exitFullscreen().then(()=>{B=!1}).catch(()=>{document.body.requestFullscreen().then(),B=!0}):document.body.requestFullscreen().then(()=>{B=!0}).catch(()=>{document.exitFullscreen().then(),B=!1})})}()}();