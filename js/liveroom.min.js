!function(){function a(){document.getElementsByClassName('panel-container')[0].style.zIndex='-1',document.getElementsByClassName('panel-container')[0].style.display='none',document.getElementsByClassName('add-room-panel')[0].style.display='none',document.getElementsByClassName('setting-panel')[0].style.display='none',document.getElementsByClassName('following-block')[0].innerHTML='',document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('input')[0].onkeyup=null,document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('input')[0].value='',document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('input')[0].classList.contains('error-input')&&(document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('input')[0].classList.remove('error-input'),document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('span')[0].innerHTML='',document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('span')[0].removeAttribute('style'))}function b(){x.style.opacity='0'}function c(){fetch('https://api.bilibili.com/x/v2/reply/at',{method:'GET',credentials:'include',body:null}).then((a)=>a.json()).then((a)=>{let b=[];if(0===a.code)for(let c=0;c<a.data.groups.length;c++)for(let d=0;d<a.data.groups[''+c].items.length;d++)b.push(a.data.groups[''+c].items[d+''].mid);return b}).then((a)=>{d(a)})}function d(b){fetch('https://api.live.bilibili.com/room/v1/Room/get_status_info_by_uids?requestFrom=rua5',{method:'POST',credentials:'omit',body:'{"uids": ['+b+']}'}).then((a)=>a.json()).then((c)=>{if(0===c.code){let d=c.data,f=document.getElementsByClassName('following-block')[0];if(1===b.length){let c=d[b[0]];e(c),a()}else for(let c=0;c<b.length;c++)if(void 0!==d[b[c]]&&1===d[b[c]].live_status){let g=d[b[c]],h=document.createElement('div');h.classList.add('following-liver'),h.innerHTML=`<div class="user-face"><img src="${g.face}"></div><div class="following-room-info"><span class="room-title">${g.title}</span><span class="user-name">${g.uname}</span></div>`,f.append(h),h.addEventListener('click',()=>{e(g),a()})}}})}function f(a){let b=[a.offsetLeft,a.offsetTop],c=a.offsetParent;for(;null!==c;)b[0]+=c.offsetLeft,b[1]+=c.offsetTop+c.clientTop,c=c.offsetParent;return b[0]+=a.clientWidth-60,b[1]+=a.clientHeight-60,b}async function e(a){function b(a,b){1===b?a.setAttribute('style',`--number-of-row:1; --number-of-column:1;`):2===b?a.setAttribute('style',`--number-of-row:1; --number-of-column:0.5;`):5>b?a.setAttribute('style',`--number-of-row:0.5; --number-of-column:0.5;`):7>b?a.setAttribute('style',`--number-of-row:0.5; --number-of-column:0.33;`):10>b?a.setAttribute('style',`--number-of-row:0.33; --number-of-column:0.33;`):13>b?a.setAttribute('style',`--number-of-row:0.5; --number-of-column:0.25;`):a.setAttribute('style',`--number-of-row:0.25; --number-of-column:0.25;`)}function c(a,b){function d(b,f,g){let h=null;flvjs.isSupported()&&(j=flvjs.createPlayer({type:'flv',isLive:!0,url:b[g].url}),j.attachMediaElement(f),f.addEventListener('sourceended',()=>{console.log('source ended')}),j.load(),j.play(),h=setTimeout(()=>{f.currentTime=f.buffered.end(0)-1},2e3),j.on(flvjs.Events.ERROR,(i)=>{console.log('error'),console.log(i),++g,j.unload(),clearTimeout(h),g===b.length?c(a,f):d(b,f,g)}))}fetch(`https://api.live.bilibili.com/room/v1/Room/playUrl?cid=${a}&qn=10000`,{method:'GET',credentials:'include',signal:e.signal,body:null}).then((a)=>a.json()).then((a)=>{if(0===a.code)d(a.data.durl,b,0);else throw a.code}).catch((d)=>{console.log(d),setTimeout(()=>{c(a,b)},1e3)})}let d,j=null,e=new AbortController;if(16>B.size&&!B.has(a.uid)){function k(){A||(u.style.visibility='hidden',v.firstElementChild.style.display='none')}function m(){s.onmousemove=null,v.onmouseenter=null,v.onmouseleave=null,v.getElementsByClassName('volume')[0].onmouseenter=null,v.getElementsByClassName('volume')[0].onmouseleave=null,D.onmousedown=null,D.onmouseleave=null,D.onmousemove=null,D.onmouseup=null,v.getElementsByClassName('volume')[0].onwheel=null,v.getElementsByClassName('icon')[0].onmouseup=null,v.getElementsByClassName('close')[0].onclick=null,G.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].onkeyup,G.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].onkeydown,G.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].onselect=null,G.getElementsByClassName('send-danmaku')[0].onclick=null,t.disconnect()}B.set(a.uid,a);let o=document.createElement('video'),r=document.getElementsByClassName('video-container')[0];b(r,B.size);let s=document.createElement('div'),t=new MutationObserver(function(f){f.forEach(async function(f){if('attributes'===f.type&&null===o.getAttribute('src')){let f=await h(a.room_id);1===f.liveStatus?c(a.room_id,o):(null!=j&&j.destroy(),e.abort('user cancel'),console.log('close '+a.uid),m(),s.remove(),B.delete(a.uid),b(r,B.size),d.stop())}})});s.classList.add('video-stream'),s.append(o);let u=document.createElement('div');u.setAttribute('style',`display: block; position: absolute; bottom: 0px; width: 100%; height: 56px; background-image: linear-gradient(rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.7)); visibility: hidden;`),s.append(u);let v=document.createElement('div');v.innerHTML+=`
            <div style="position: relative; user-select: none; z-index: 5; display: none">
                <div class="control-area">
                    <div class="left">
                        <div class="volume">
                            <div class="volume-control" style="display: none">
                                <div class="vertical-slider">
                                    <div class="number">100</div>
                                        <div class="slider-rail">
                                            <div class="slider-handle" style="top: 0px;"></div>
                                            <div class="slider-track" style="height: 100%;"></div>
                                        </div>
                                </div>
                            </div>
                            <span class="icon">
                                <svg version="1.1" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 36 36" style="enable-background:new 0 0 36 36; display: none;" xml:space="preserve">
                                    <path class="st0" d="M25.8,25.8c0.4,0.4,0.4,1,0,1.4s-1,0.4-1.4,0l-2.3-2.3c-0.2,0.1-0.4,0.2-0.6,0.3c-0.5,0.2-1.1,0-1.3-0.5\tc-0.2-0.5,0-1.1,0.5-1.3l0,0l-2.6-2.6v3.1c0,0.3-0.2,0.5-0.5,0.5c-0.1,0-0.2,0-0.3-0.1l-4.2-3.4h-1c-1.1,0-2-0.9-2-2v-2\tc0-1.1,0.9-2,2-2h0.2l-3.4-3.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0L25.8,25.8z"></path>
                                    <path class="st0" d="M21.4,10.8c4,1.9,5.7,6.7,3.8,10.7c-0.1,0.2-0.2,0.4-0.3,0.6l-1.5-1.5c1.4-3,0.2-6.6-2.8-8l0,0\tc-0.5-0.2-0.7-0.8-0.5-1.3l0,0C20.4,10.7,21,10.5,21.4,10.8z"></path>  <path class="st0" d="M20,14.5c1.2,0.7,2,2,2,3.5c0,0.3,0,0.7-0.1,1L20,17.1V14.5z"></path>
                                    <path class="st0" d="M17.9,11.7C18,11.8,18,11.9,18,12v3.1l-2.3-2.3l1.5-1.2C17.4,11.5,17.7,11.5,17.9,11.7z"></path>
                                </svg>
                                <svg version="1.1" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 36 36" style="enable-background:new 0 0 36 36;" xml:space="preserve">
                                    <path class="st0" d="M20,14.5c1.9,1.1,2.6,3.6,1.5,5.5c-0.3,0.6-0.9,1.1-1.5,1.5V14.5z"></path>
                                    <path class="st0" d="M21.4,10.7c4,1.9,5.7,6.7,3.8,10.7c-0.8,1.7-2,3-3.7,3.8c-0.5,0.2-1.1,0-1.3-0.5l0,0c-0.2-0.5,0-1.1,0.5-1.3\tc2.9-1.5,4.1-4.9,2.7-8c-0.6-1.2-1.6-2.3-2.8-2.8c-0.5-0.2-0.7-0.8-0.5-1.3S20.8,10.5,21.4,10.7C21.3,10.7,21.3,10.7,21.4,10.7\tL21.4,10.7z"></path>
                                    <path class="st0" d="M17.9,11.7c0.1,0.1,0.1,0.1,0.1,0.2l0.1,12c0,0.3-0.2,0.5-0.5,0.5c-0.1,0-0.2,0-0.3-0.1l-4.2-3.4h-1\tc-1.1,0-2-0.9-2-2v-2c0-1.1,0.9-2,2-2h1l4.1-3.3C17.4,11.5,17.7,11.5,17.9,11.7L17.9,11.7z"></path>
                                </svg>
                            </span>
                        </div>
                    </div>
                    <div class="danmaku">
                        <div class="input-container">
                            <input placeholder="发个弹幕呗～">
                            <span>0/20</span>
                        </div>
                        <div class="send-danmaku">发送</div>
                        <div class="emoji-bg"></div>
                        <div class="emoji-sec"></div>
                    </div>
                    <div class="right">
                        <div class="close">
                            <div>
                                <span class="icon">
                                    <svg class="rua-cross" viewBox="0 0 100 100" >
                                        <rect x="25" y="45" rx="5" ry="5" width="50" height="10" style="transform: rotate(45deg);"/>
                                        <rect x="25" y="45" rx="5" ry="5" width="50" height="10" style="transform: rotate(135deg);"/>
                                    </svg>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;let w=100,x=w,y=!1,z=null,A=!1;s.onmousemove=()=>{clearTimeout(z),u.style.visibility='visible',v.firstElementChild.style.display='block',z=setTimeout(k,1e3)},v.onmouseenter=()=>{A=!0},v.onmouseleave=()=>{A=!1},v.getElementsByClassName('volume')[0].onmouseenter=()=>{v.getElementsByClassName('volume-control')[0].style.display='block'},v.getElementsByClassName('volume')[0].onmouseleave=()=>{C||(v.getElementsByClassName('volume-control')[0].style.display='none')};let D=v.getElementsByClassName('slider-rail')[0];D.onmousedown=(a)=>{a.stopPropagation(),C=!0;let b=f(D)[1]-100;0<=a.y-b&&53>=a.y-b&&(D.getElementsByClassName('slider-handle')[0].style.top=a.y-b+'px',w=q(100*(1-(a.y-b)/53)),v.getElementsByClassName('number')[0].innerText=w,D.getElementsByClassName('slider-track')[0].style.height=w+'%',o.volume=w/100,0===w?(y=!y,x=w,v.getElementsByClassName('icon')[0].getElementsByTagName('svg')[1].style.display='none',v.getElementsByClassName('icon')[0].getElementsByTagName('svg')[0].style.display='block'):(y=!1,v.getElementsByClassName('icon')[0].getElementsByTagName('svg')[0].style.display='none',v.getElementsByClassName('icon')[0].getElementsByTagName('svg')[1].style.display='block')),D.onmousemove=(a)=>{a.stopPropagation(),0<=a.y-b&&53>=a.y-b&&(D.getElementsByClassName('slider-handle')[0].style.transition='none',D.getElementsByClassName('slider-track')[0].style.transition='none',D.getElementsByClassName('slider-handle')[0].style.top=a.y-b+'px',w=q(100*(1-(a.y-b)/53)),v.getElementsByClassName('number')[0].innerText=w,D.getElementsByClassName('slider-track')[0].style.height=w+'%',o.volume=w/100,0===w?(y=!y,x=w,v.getElementsByClassName('icon')[0].getElementsByTagName('svg')[1].style.display='none',v.getElementsByClassName('icon')[0].getElementsByTagName('svg')[0].style.display='block'):(y=!1,v.getElementsByClassName('icon')[0].getElementsByTagName('svg')[0].style.display='none',v.getElementsByClassName('icon')[0].getElementsByTagName('svg')[1].style.display='block'))},D.onmouseup=(a)=>{a.stopPropagation(),D.onmousemove=null,D.onmouseup=null,D.getElementsByClassName('slider-handle')[0].style.transition='',D.getElementsByClassName('slider-track')[0].style.transition='',C=!1},D.onmouseleave=(a)=>{a.stopPropagation(),D.onmousemove=null,D.onmouseup=null,D.getElementsByClassName('slider-handle')[0].style.transition='',D.getElementsByClassName('slider-track')[0].style.transition=''}},v.getElementsByClassName('volume')[0].onwheel=(a)=>{w-=a.deltaY/10,100<w&&(w=100),0>w&&(w=0),0===w?(y=!0,v.getElementsByClassName('icon')[0].getElementsByTagName('svg')[1].style.display='none',v.getElementsByClassName('icon')[0].getElementsByTagName('svg')[0].style.display='block'):y&&(v.getElementsByClassName('icon')[0].getElementsByTagName('svg')[0].style.display='none',v.getElementsByClassName('icon')[0].getElementsByTagName('svg')[1].style.display='block',y=!1),w=q(w),o.volume=w/100,v.getElementsByClassName('number')[0].innerText=w,D.getElementsByClassName('slider-handle')[0].style.top=53-53*(w/100)+'px',D.getElementsByClassName('slider-track')[0].style.height=w+'%'},v.getElementsByClassName('icon')[0].onmouseup=(a)=>{a.stopPropagation(),y?(v.getElementsByClassName('icon')[0].getElementsByTagName('svg')[0].style.display='none',v.getElementsByClassName('icon')[0].getElementsByTagName('svg')[1].style.display='block',w=x):(v.getElementsByClassName('icon')[0].getElementsByTagName('svg')[1].style.display='none',v.getElementsByClassName('icon')[0].getElementsByTagName('svg')[0].style.display='block',x=w,w=0),y=!y,o.volume=w/100,v.getElementsByClassName('number')[0].innerText=w,D.getElementsByClassName('slider-handle')[0].style.top=53-53*(w/100)+'px',D.getElementsByClassName('slider-track')[0].style.height=w+'%'},v.getElementsByClassName('close')[0].onclick=()=>{null!=j&&j.destroy(),e.abort('user cancel'),console.log('close '+a.uid),m(),s.remove(),B.delete(a.uid),b(r,B.size),d.stop()},v.classList.add('video-player-control'),s.append(v),r.append(s),g(a.uid,!0),c(a.room_id,o),d=new p(a.area_v2_parent_id,a.area_v2_id,a.room_id,a.uid),d.E();let E=await i(a.room_id),F=await n(E.uid,a.uid),G=v.getElementsByClassName('danmaku')[0],H=[0,0],I=!0,J=!0;G.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].addEventListener('compositionstart',()=>{I=!1,J=!1}),G.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].addEventListener('compositionend',()=>{I=!0}),G.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].onkeyup=(b)=>{13===b.keyCode&&J&&(b.preventDefault(),l(G.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].value,0,a.room_id,a.uid),G.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].value=''),I&&(J=!0),H=[G.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].selectionStart,G.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].selectionEnd],G.getElementsByClassName('input-container')[0].getElementsByTagName('span')[0].innerText=`${10>G.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].value.length?' ':''}${G.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].value.length}/${E.totalLength}`},G.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].onkeydown=(a)=>{'Enter'===a.code&&a.preventDefault()},G.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].onselect=(a)=>{H=[a.target.selectionStart,a.target.selectionEnd]},G.getElementsByClassName('send-danmaku')[0].onclick=()=>{l(G.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].value,0,a.room_id,a.uid),G.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].value='',G.getElementsByClassName('input-container')[0].getElementsByTagName('span')[0].innerText=`0/${E.totalLength}`},G.getElementsByClassName('input-container')[0].getElementsByTagName('span')[0].innerText=`0/${E.totalLength}`,fetch('https://api.live.bilibili.com/xlive/web-ucenter/v2/emoticon/GetEmoticons?platform=pc&room_id='+a.room_id,{method:'GET',credentials:'include',body:null}).then((a)=>a.json()).then((b)=>{if(0===b.code){let c=`<div style="display: flex; flex-wrap: wrap; margin: 0 7.5%;">`;for(let a=3;0<=a;a--)if(b.data.data[a]!==void 0&&null!==b.data.data[a]){c+=`<span class="emoji-header">${b.data.data[a].pkg_name}</span>`;for(let d=0;d<b.data.data[a].emoticons.length;d++)c+=`<div class="rua-emoji-icon-container"><div class="rua-emoji-icon ${1===b.data.data[a].emoticons[d].perm?'rua-emoji-icon-active':'rua-emoji-icon-inactive'}" title="${b.data.data[a].emoticons[d].emoji}" content="${b.data.data[a].emoticons[d].emoticon_unique}" style="background-image:url('${b.data.data[a].emoticons[d].url.replace('http://','https://')}');"></div><div class="rua-emoji-requirement" style="background-color: ${b.data.data[a].emoticons[d].unlock_show_color};"><div class="rua-emoji-requirement-text">${b.data.data[a].emoticons[d].unlock_show_text}</div></div></div>`}c+='</div>',G.getElementsByClassName('emoji-sec')[0].innerHTML=c;for(let b=0;b<G.getElementsByClassName('emoji-sec')[0].getElementsByClassName('rua-emoji-icon-container').length;b++)G.getElementsByClassName('emoji-sec')[0].getElementsByClassName('rua-emoji-icon')[b].onclick=(b)=>{b.target.classList.contains('rua-emoji-icon-active')&&(G.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].focus(),l(b.target.getAttribute('content'),'systemEmoji',a.room_id,a.uid))}}}).catch((a)=>{console.log(a)}),t.observe(o,{attributes:!0})}}async function g(a,b=!1){if(b&&(await n(r).then((a)=>{A=a})),1===E||-1===E&&1===A[0].medal_info.wearing_status){D=a;for(const a of A)if(a.medal_info.target_id===D){o(a.medal_info.medal_id);break}}}function h(a){return fetch('https://api.live.bilibili.com/room/v1/Room/room_init?id='+a,{method:'GET',credentials:'include',body:null}).then((a)=>a.json()).then((a)=>{if(0===a.code)return{up:a.data.uid,roomid:a.data.room_id,liveStatus:a.data.live_status};throw a})}function i(a){return fetch('https://api.live.bilibili.com/xlive/web-room/v1/index/getInfoByUser?from=0&room_id='+a,{method:'GET',credentials:'include',body:null}).then((a)=>a.json()).then((a)=>{if(0===a.code){let b=0==a.data.privilege.privilege_type-1+1?4:a.data.privilege.privilege_type,c=a.data.info.uid,d=a.data.property.danmu.length;return{totalLength:d,uid:c,emojiRequiredPrivilege:b}}return{totalLength:0,uid:-1,emojiRequiredPrivilege:-1}}).catch(()=>({totalLength:0,uid:-1,emojiRequiredPrivilege:-1}))}function j(){try{chrome.runtime.sendMessage({msg:'get_LoginInfo'},function(a){s=a.res.split(',')[0],r=a.res.split(',')[1]}),chrome.runtime.sendMessage({msg:'get_LIVE_BUVID'},function(a){t=a.res.value})}catch(a){console.log(a)}}function k(){return q(Date.now()/1e3)}async function l(a,b,c,d){if(D!==d&&1===E){D=d;for(const a of A)if(a.medal_info.target_id===D){await o(a.medal_info.medal_id);break}}let e=new FormData;e.append('bubble','0'),e.append('msg',a),e.append('color','16777215'),e.append('mode','1'),b!==void 0&&'systemEmoji'===b&&e.append('dm_type','1'),e.append('fontsize','25'),e.append('rnd',k()+''),e.append('roomid',c),e.append('csrf',s),e.append('csrf_token',s),0!==a.length&&m(e)}function m(a){fetch('https://api.live.bilibili.com/msg/send?requestFrom=rua5',{method:'POST',credentials:'include',body:a}).then((a)=>a.json()).then((a)=>{console.log('sent'),0===a.message.length?'\u4F60\u6240\u5728\u7684\u5730\u533A\u6682\u65E0\u6CD5\u53D1\u8A00'===a.message&&console.error('Error:','\u4F60\u6240\u5728\u7684\u5730\u533A\u6682\u65E0\u6CD5\u53D1\u8A00'):console.error('Error:','\u4F60\u7684\u5F39\u5E55\u88AB\u7CFB\u7EDF\u541E\u4E86\uFF0C\u91CD\u8BD5\u4E00\u4E0B\u5427\u3002')}).catch((a)=>{console.error('Error:',a)})}function n(a,b){return fetch('https://api.live.bilibili.com/xlive/web-ucenter/user/MedalWall?target_id='+a,{method:'GET',credentials:'include',body:null}).then((a)=>a.json()).then((a)=>{if(0===a.code){if('undefined'!=typeof b){for(let c of a.data.list)if(c.medal_info.target_id===b)return{emojiRequiredMedalLevel:c.medal_info.level,medal_id:c.medal_info.medal_id,medal_name:c.medal_info.medal_name};return{emojiRequiredMedalLevel:0,medal_id:-1,medal_name:''}}return a.data.list}return{emojiRequiredMedalLevel:0,medal_id:-1,medal_name:''}}).catch(()=>({emojiRequiredMedalLevel:0,medal_id:-1,medal_name:''}))}function o(a){if('-1'!==s&&-1!==a&&0!==E){var b=new FormData;b.append('medal_id',a),b.append('csrf',s),b.append('csrf_token',s),fetch(-1===E?'https://api.live.bilibili.com/xlive/app-ucenter/v1/fansMedal/take_off':`https://api.live.bilibili.com/xlive/web-room/v1/fansMedal/wear`,{method:'POST',credentials:'include',body:b}).then(()=>{console.log('ware medal successful, MID='+a)})}}function p(a,b,c,d){function e(a){let b='';for(const c in a)b+=`${c}=${encodeURIComponent('id'===c||'device'===c?JSON.stringify(a[c]):a[c])}&`;return b.slice(0,-1)}function f(a,b){let c=JSON.stringify({platform:'web',parent_id:a.id[0],area_id:a.id[1],seq_id:a.id[2],room_id:a.id[3],buvid:a.device[0],uuid:a.device[1],ets:a.ets,time:a.time,ts:a.ts});for(let d of b)0===d?c=CryptoJS.HmacMD5(c,a.benchmark).toString(CryptoJS.enc.Hex):1===d?c=CryptoJS.HmacSHA1(c,a.benchmark).toString(CryptoJS.enc.Hex):2===d?c=CryptoJS.HmacSHA256(c,a.benchmark).toString(CryptoJS.enc.Hex):3===d?c=CryptoJS.HmacSHA224(c,a.benchmark).toString(CryptoJS.enc.Hex):4===d?c=CryptoJS.HmacSHA512(c,a.benchmark).toString(CryptoJS.enc.Hex):5===d?c=CryptoJS.HmacSHA384(c,a.benchmark).toString(CryptoJS.enc.Hex):void 0;return c}const g=window.navigator.userAgent;this.packageNumber=0,this.packagePayload={id:[a,b,this.packageNumber,c],device:[t,function(){let a='';for(let b=0;36>b;b++){const c=Math.floor(16*Math.random());a+=8===b||13===b||18===b||23===b?'-':14===b?'4':19===b?(8|3&c).toString(16):c.toString(16)}return a}()],ruid:d,ts:Date.now(),is_patch:0,heart_beat:[],ua:g},this.replayPayload={},this.timer=null,p.prototype.E=async function(){await fetch('https://live-trace.bilibili.com/xlive/data-interface/v1/x25Kn/E',{method:'POST',credentials:'include',headers:{"content-type":'application/x-www-form-urlencoded'},body:`${e(this.packagePayload)}&csrf_token=${s}&csrf=${s}&visit_id:`}).then((a)=>a.json()).then((d)=>{0===d.code&&(this.packageNumber++,this.timer=setInterval(()=>{this.X()},1e3*(d.data.heartbeat_interval-0)),this.replayPayload={id:[a,b,this.packageNumber,c],device:this.packagePayload.device,ruid:this.packagePayload.ruid,ets:d.data.timestamp,benchmark:d.data.secret_key,time:d.data.heartbeat_interval,ts:Date.now(),ua:g},this.replayPayload=Object.assign({s:f(this.replayPayload,d.data.secret_rule)},this.replayPayload))}).catch(()=>{this.stop(),this.E()})},p.prototype.X=async function(){await fetch('https://live-trace.bilibili.com/xlive/data-interface/v1/x25Kn/X',{method:'POST',credentials:'include',headers:{"content-type":'application/x-www-form-urlencoded'},body:`${e(this.replayPayload)}&csrf_token=${s}&csrf=${s}&visit_id:`}).then((a)=>a.json()).then((a)=>{0===a.code&&(this.packageNumber++,this.replayPayload.id=[this.replayPayload.id[0],this.replayPayload.id[1],this.packageNumber,this.replayPayload.id[3]],this.replayPayload.benchmark=a.data.secret_key,this.replayPayload.time=a.data.heartbeat_interval,this.replayPayload.ets=a.data.timestamp,this.replayPayload.s=f(this.replayPayload,a.data.secret_rule))})},p.prototype.stop=function(){console.log(this.timer),null!==this.timer&&(clearInterval(this.timer),this.timer=null)}}var q=Math.round;let r,s,t,u=null,v=null,w=null,x=document.getElementsByClassName('control-bar')[0],y=null,z=!1,A=null,B=new Map,C=!1,D=-1,E=1,F=!0;j(),setInterval(j,3e3),setTimeout(()=>{n(r).then((a)=>{A=a})},100),window.addEventListener('focus',function(){-1<D&&null!==A&&'undefined'!=typeof A&&g(D)}),!function(){u=document.getElementsByClassName('add-room')[0].getElementsByTagName('svg')[0],w=document.getElementsByClassName('setting')[0].getElementsByTagName('svg')[0],v=document.getElementsByClassName('fullscreen')[0].getElementsByTagName('svg')[0];let e=document.getElementById('setting-heart-beat'),f=document.getElementById('setting-re-try'),g=document.getElementById('setting-quality'),i=document.getElementById('setting-medal-switch-on'),j=document.getElementById('setting-medal-switch-off'),k=document.getElementById('setting-medal-switch-none');document.body.addEventListener('mousemove',()=>{clearTimeout(y),x.style.opacity='1',y=setTimeout(b,1e3)}),document.body.addEventListener('mouseup',()=>{for(let a=0;a<document.body.getElementsByClassName('volume-control').length;a++)document.body.getElementsByClassName('volume-control')[a].style.display='none'}),chrome.storage.sync.get(['liveroom-medal-switch','liveroom-reconnection-time','liveroom-quality','liveroom-heart-beat'],(a)=>{E=a['liveroom-medal-switch'];-1===E?(k.setAttribute('value','on'),i.setAttribute('value','off'),j.setAttribute('value','off')):0===E?(j.setAttribute('value','on'),k.setAttribute('value','off'),i.setAttribute('value','off')):1===E?(i.setAttribute('value','on'),j.setAttribute('value','off'),k.setAttribute('value','off')):void 0;F=a['liveroom-heart-beat'],e.checked=F}),i.addEventListener('change',()=>{E=1,chrome.storage.sync.set({"liveroom-medal-switch":E},()=>{})}),j.addEventListener('change',()=>{E=0,chrome.storage.sync.set({"liveroom-medal-switch":E},()=>{})}),k.addEventListener('change',()=>{E=-1,chrome.storage.sync.set({"liveroom-medal-switch":E},()=>{})}),e.addEventListener('change',()=>{F=this.value,chrome.storage.sync.set({"liveroom-heart-beat":F},function(){})}),u.addEventListener('click',()=>{document.getElementsByClassName('panel-container')[0].removeEventListener('click',a),document.getElementsByClassName('panel-container')[0].style.zIndex='10',document.getElementsByClassName('panel-container')[0].style.display='block',document.getElementsByClassName('panel-container')[0].addEventListener('click',a),document.getElementsByClassName('add-room-panel')[0].style.display='flex',document.getElementsByClassName('add-room-panel')[0].addEventListener('click',(a)=>{a.stopPropagation()}),document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('input')[0].onkeyup=(a)=>{document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('input')[0].classList.contains('error-input')&&(document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('input')[0].classList.remove('error-input'),document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('span')[0].innerHTML='',document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('span')[0].removeAttribute('style')),'Enter'===a.code&&h(a.target.value).then((a)=>{if(1!==a.liveStatus)throw a;else d([a.up])}).catch((a)=>{console.log(a),document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('input')[0].classList.add('error-input'),document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('span')[0].setAttribute('style',`transform: translateY(0px);`),1===a.liveStatus?'\u76F4\u64AD\u95F4\u4E0D\u5B58\u5728'===a.msg&&(document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('span')[0].innerHTML='\u76F4\u64AD\u95F4\u4E0D\u5B58\u5728'):document.getElementsByClassName('add-room-panel')[0].getElementsByClassName('room-input')[0].getElementsByTagName('span')[0].innerHTML='\u4E3B\u64AD\u672A\u5F00\u64AD'})},c()}),w.addEventListener('click',()=>{document.getElementsByClassName('panel-container')[0].removeEventListener('click',a),document.getElementsByClassName('panel-container')[0].style.zIndex='10',document.getElementsByClassName('panel-container')[0].style.display='block',document.getElementsByClassName('panel-container')[0].addEventListener('click',a),document.getElementsByClassName('setting-panel')[0].style.display='flex',document.getElementsByClassName('setting-panel')[0].addEventListener('click',(a)=>{a.stopPropagation()})}),v.addEventListener('click',()=>{z?document.exitFullscreen().then(()=>{z=!1}).catch(()=>{document.body.requestFullscreen().then(),z=!0}):document.body.requestFullscreen().then(()=>{z=!0}).catch(()=>{document.exitFullscreen().then(),z=!1})})}()}();