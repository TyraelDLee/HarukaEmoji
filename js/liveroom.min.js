!function(){function a(){document.getElementsByClassName('panel-container')[0].style.zIndex='-1',document.getElementsByClassName('panel-container')[0].style.display='none',document.getElementsByClassName('add-room-panel')[0].style.display='none',document.getElementsByClassName('setting-panel')[0].style.display='none',document.getElementsByClassName('following-block')[0].innerHTML=''}function b(){q.style.opacity='0'}function c(){fetch('https://api.bilibili.com/x/v2/reply/at',{method:'GET',credentials:'include',body:null}).then((a)=>a.json()).then((a)=>{let b=[];if(0===a.code)for(let c=0;c<a.data.groups.length;c++)for(let d=0;d<a.data.groups[''+c].items.length;d++)b.push(a.data.groups[''+c].items[d+''].mid);return b}).then((b)=>{fetch('https://api.live.bilibili.com/room/v1/Room/get_status_info_by_uids?requestFrom=rua5',{method:'POST',credentials:'omit',body:'{"uids": ['+b+']}'}).then((a)=>a.json()).then((c)=>{if(0===c.code){let d=c.data,f=document.getElementsByClassName('following-block')[0];for(let c=0;c<b.length;c++)if(d[b[c]]!==void 0&&1===d[b[c]].live_status){let g=d[b[c]],h=document.createElement('div');h.classList.add('following-liver'),h.innerHTML=`<div class="user-face"><img src="${g.face}"></div><div class="following-room-info"><span class="room-title">${g.title}</span><span class="user-name">${g.uname}</span></div>`,f.append(h),h.addEventListener('click',()=>{e(g),a()})}}})})}function d(a){let b=[a.offsetLeft,a.offsetTop],c=a.offsetParent;for(;null!==c;)b[0]+=c.offsetLeft,b[1]+=c.offsetTop+c.clientTop,c=c.offsetParent;return b[0]+=a.clientWidth-60,b[1]+=a.clientHeight-60,b}async function e(a){function b(a,b){1===b?a.setAttribute('style',`--number-of-row:1; --number-of-column:1;`):2===b?a.setAttribute('style',`--number-of-row:1; --number-of-column:0.5;`):5>b?a.setAttribute('style',`--number-of-row:0.5; --number-of-column:0.5;`):7>b?a.setAttribute('style',`--number-of-row:0.5; --number-of-column:0.33;`):10>b?a.setAttribute('style',`--number-of-row:0.33; --number-of-column:0.33;`):13>b?a.setAttribute('style',`--number-of-row:0.5; --number-of-column:0.25;`):a.setAttribute('style',`--number-of-row:0.25; --number-of-column:0.25;`)}function c(a){return fetch('https://api.live.bilibili.com/room/v1/Room/room_init?id='+a,{method:'GET',credentials:'include',body:null}).then((a)=>a.json()).then((a)=>0===a.code?{up:a.data.uid,roomid:a.data.room_id}:void setTimeout(c,1e3)).catch(()=>{setTimeout(c,1e3)})}function e(a){return fetch('https://api.live.bilibili.com/xlive/web-room/v1/index/getInfoByUser?from=0&room_id='+a,{method:'GET',credentials:'include',body:null}).then((a)=>a.json()).then((a)=>{if(0===a.code){let b=0==a.data.privilege.privilege_type-1+1?4:a.data.privilege.privilege_type,c=a.data.info.uid,d=a.data.property.danmu.length;return{totalLength:d,uid:c,emojiRequiredPrivilege:b}}}).catch(()=>{setTimeout(e,1e3)})}function f(a,b){function c(b,d,h){flvjs.isSupported()&&(g=flvjs.createPlayer({type:'flv',isLive:!0,url:b[h].url}),g.attachMediaElement(d),d.addEventListener('sourceended',()=>{console.log('source ended')}),g.load(),g.play(),g.on(flvjs.Events.ERROR,(i)=>{console.log('error'),console.log(i),++h,g.unload(),h===b.length?f(a,d):c(b,d,h)}))}fetch(`https://api.live.bilibili.com/room/v1/Room/playUrl?cid=${a}&qn=10000`,{method:'GET',credentials:'include',signal:i.signal,body:null}).then((a)=>a.json()).then((a)=>{0===a.code&&c(a.data.durl,b,0)}).catch((c)=>{f(a,b),console.log(c)})}let g=null,i=new AbortController;if(16>t.size&&!t.has(a.uid)){function l(){x||(p.style.visibility='hidden',q.firstElementChild.style.display='none')}t.set(a.uid,a);let m=document.createElement('video'),n=document.getElementsByClassName('video-container')[0];b(n,t.size);let o=document.createElement('div');o.classList.add('video-stream'),o.append(m);let p=document.createElement('div');p.setAttribute('style',`display: block; position: absolute; bottom: 0px; width: 100%; height: 56px; background-image: linear-gradient(rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.7)); visibility: hidden;`),o.append(p);let q=document.createElement('div');q.innerHTML+=`
            <div style="position: relative; user-select: none; z-index: 5; display: none">
                <div class="control-area">
                    <div class="left">
                        <div class="volume">
                            <div class="volume-control" style="display: none">
                                <div class="vertical-slider">
                                    <div class="number">100</div>
                                        <div class="slider-rail">
                                            <div class="slider-handle" style="top: 0px;"></div>
                                            <div class="slider-track" style="height: 100%;"></div>
                                        </div>
                                </div>
                            </div>
                            <span class="icon">
                                <svg version="1.1" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 36 36" style="enable-background:new 0 0 36 36; display: none;" xml:space="preserve">
                                    <path class="st0" d="M25.8,25.8c0.4,0.4,0.4,1,0,1.4s-1,0.4-1.4,0l-2.3-2.3c-0.2,0.1-0.4,0.2-0.6,0.3c-0.5,0.2-1.1,0-1.3-0.5\tc-0.2-0.5,0-1.1,0.5-1.3l0,0l-2.6-2.6v3.1c0,0.3-0.2,0.5-0.5,0.5c-0.1,0-0.2,0-0.3-0.1l-4.2-3.4h-1c-1.1,0-2-0.9-2-2v-2\tc0-1.1,0.9-2,2-2h0.2l-3.4-3.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0L25.8,25.8z"></path>
                                    <path class="st0" d="M21.4,10.8c4,1.9,5.7,6.7,3.8,10.7c-0.1,0.2-0.2,0.4-0.3,0.6l-1.5-1.5c1.4-3,0.2-6.6-2.8-8l0,0\tc-0.5-0.2-0.7-0.8-0.5-1.3l0,0C20.4,10.7,21,10.5,21.4,10.8z"></path>  <path class="st0" d="M20,14.5c1.2,0.7,2,2,2,3.5c0,0.3,0,0.7-0.1,1L20,17.1V14.5z"></path>
                                    <path class="st0" d="M17.9,11.7C18,11.8,18,11.9,18,12v3.1l-2.3-2.3l1.5-1.2C17.4,11.5,17.7,11.5,17.9,11.7z"></path>
                                </svg>
                                <svg version="1.1" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" viewBox="0 0 36 36" style="enable-background:new 0 0 36 36;" xml:space="preserve">
                                    <path class="st0" d="M20,14.5c1.9,1.1,2.6,3.6,1.5,5.5c-0.3,0.6-0.9,1.1-1.5,1.5V14.5z"></path>
                                    <path class="st0" d="M21.4,10.7c4,1.9,5.7,6.7,3.8,10.7c-0.8,1.7-2,3-3.7,3.8c-0.5,0.2-1.1,0-1.3-0.5l0,0c-0.2-0.5,0-1.1,0.5-1.3\tc2.9-1.5,4.1-4.9,2.7-8c-0.6-1.2-1.6-2.3-2.8-2.8c-0.5-0.2-0.7-0.8-0.5-1.3S20.8,10.5,21.4,10.7C21.3,10.7,21.3,10.7,21.4,10.7\tL21.4,10.7z"></path>
                                    <path class="st0" d="M17.9,11.7c0.1,0.1,0.1,0.1,0.1,0.2l0.1,12c0,0.3-0.2,0.5-0.5,0.5c-0.1,0-0.2,0-0.3-0.1l-4.2-3.4h-1\tc-1.1,0-2-0.9-2-2v-2c0-1.1,0.9-2,2-2h1l4.1-3.3C17.4,11.5,17.7,11.5,17.9,11.7L17.9,11.7z"></path>
                                </svg>
                            </span>
                        </div>
                    </div>
                    <div class="danmaku">
                        <div class="input-container">
                            <input placeholder="发个弹幕呗～">
                            <span>0/20</span>
                        </div>
                        <div class="send-danmaku">发送</div>
                        <div class="emoji-bg"></div>
                        <div class="emoji-sec">
                            <table></table>
                        </div>
                    </div>
                    <div class="right">
                        <div class="close">
                            <div>
                                <span class="icon">
                                    <svg class="rua-cross" viewBox="0 0 100 100" >
                                        <rect x="25" y="45" rx="5" ry="5" width="50" height="10" style="transform: rotate(45deg);"/>
                                        <rect x="25" y="45" rx="5" ry="5" width="50" height="10" style="transform: rotate(135deg);"/>
                                    </svg>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;let r=100,s=r,v=!1,w=null,x=!1;o.onmousemove=()=>{clearTimeout(w),p.style.visibility='visible',q.firstElementChild.style.display='block',w=setTimeout(l,1e3)},q.onmouseenter=()=>{x=!0},q.onmouseleave=()=>{x=!1},q.getElementsByClassName('volume')[0].onmouseenter=()=>{q.getElementsByClassName('volume-control')[0].style.display='block'},q.getElementsByClassName('volume')[0].onmouseleave=()=>{u||(q.getElementsByClassName('volume-control')[0].style.display='none')};let y=q.getElementsByClassName('slider-rail')[0];y.onmousedown=(a)=>{a.stopPropagation(),u=!0;let b=d(y)[1]-100;0<=a.y-b&&53>=a.y-b&&(y.getElementsByClassName('slider-handle')[0].style.top=a.y-b+'px',r=k(100*(1-(a.y-b)/53)),q.getElementsByClassName('number')[0].innerText=r,y.getElementsByClassName('slider-track')[0].style.height=r+'%',m.volume=r/100,0===r?(v=!v,s=r,q.getElementsByClassName('icon')[0].getElementsByTagName('svg')[1].style.display='none',q.getElementsByClassName('icon')[0].getElementsByTagName('svg')[0].style.display='block'):(v=!1,q.getElementsByClassName('icon')[0].getElementsByTagName('svg')[0].style.display='none',q.getElementsByClassName('icon')[0].getElementsByTagName('svg')[1].style.display='block')),y.onmousemove=(a)=>{a.stopPropagation(),0<=a.y-b&&53>=a.y-b&&(y.getElementsByClassName('slider-handle')[0].style.transition='none',y.getElementsByClassName('slider-track')[0].style.transition='none',y.getElementsByClassName('slider-handle')[0].style.top=a.y-b+'px',r=k(100*(1-(a.y-b)/53)),q.getElementsByClassName('number')[0].innerText=r,y.getElementsByClassName('slider-track')[0].style.height=r+'%',m.volume=r/100,0===r?(v=!v,s=r,q.getElementsByClassName('icon')[0].getElementsByTagName('svg')[1].style.display='none',q.getElementsByClassName('icon')[0].getElementsByTagName('svg')[0].style.display='block'):(v=!1,q.getElementsByClassName('icon')[0].getElementsByTagName('svg')[0].style.display='none',q.getElementsByClassName('icon')[0].getElementsByTagName('svg')[1].style.display='block'))},y.onmouseup=(a)=>{a.stopPropagation(),y.onmousemove=null,y.onmouseup=null,y.getElementsByClassName('slider-handle')[0].style.transition='',y.getElementsByClassName('slider-track')[0].style.transition='',u=!1},y.onmouseleave=(a)=>{a.stopPropagation(),y.onmousemove=null,y.onmouseup=null,y.getElementsByClassName('slider-handle')[0].style.transition='',y.getElementsByClassName('slider-track')[0].style.transition=''}},q.getElementsByClassName('volume')[0].onwheel=(a)=>{r+=a.deltaY,100<r&&(r=100),0>r&&(r=0),m.volume=r/100,q.getElementsByClassName('number')[0].innerText=r,y.getElementsByClassName('slider-handle')[0].style.top=53-53*(r/100)+'px',y.getElementsByClassName('slider-track')[0].style.height=r+'%'},q.getElementsByClassName('icon')[0].onmouseup=(a)=>{a.stopPropagation(),v?(q.getElementsByClassName('icon')[0].getElementsByTagName('svg')[0].style.display='none',q.getElementsByClassName('icon')[0].getElementsByTagName('svg')[1].style.display='block',r=s):(q.getElementsByClassName('icon')[0].getElementsByTagName('svg')[1].style.display='none',q.getElementsByClassName('icon')[0].getElementsByTagName('svg')[0].style.display='block',s=r,r=0),v=!v,m.volume=r/100,q.getElementsByClassName('number')[0].innerText=r,y.getElementsByClassName('slider-handle')[0].style.top=53-53*(r/100)+'px',y.getElementsByClassName('slider-track')[0].style.height=r+'%'},q.getElementsByClassName('close')[0].onclick=()=>{null!=g&&g.unload(),i.abort('user cancel'),console.log('close '+a.uid),o.remove(),t.delete(a.uid),b(n,t.size)},q.classList.add('video-player-control'),o.append(q),n.append(o),f(a.room_id,m);let z=await e(a.room_id),A=await c(a.room_id),B=await j(A.up,z.uid),C=q.getElementsByClassName('danmaku')[0],D=[0,0],E=!0,F=!0;C.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].addEventListener('compositionstart',()=>{E=!1,F=!1}),C.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].addEventListener('compositionend',()=>{E=!0}),C.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].addEventListener('keyup',(a)=>{13===a.keyCode&&F&&(a.preventDefault(),h(C.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].value,0,A.roomid),C.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].value=''),E&&(F=!0),D=[C.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].selectionStart,C.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].selectionEnd],C.getElementsByClassName('input-container')[0].getElementsByTagName('span')[0].innerText=`${10>C.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].value.length?' ':''}${C.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].value.length}/${z.totalLength}`}),C.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].addEventListener('keydown',(a)=>{'Enter'===a.code&&a.preventDefault()}),C.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].addEventListener('select',(a)=>{D=[a.target.selectionStart,a.target.selectionEnd]}),C.getElementsByClassName('send-danmaku')[0].onclick=()=>{h(C.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].value,0,A.roomid),C.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].value='',C.getElementsByClassName('input-container')[0].getElementsByTagName('span')[0].innerText=`0/${z.totalLength}`},C.getElementsByClassName('input-container')[0].getElementsByTagName('span')[0].innerText=`0/${z.totalLength}`,fetch('https://api.live.bilibili.com/xlive/web-ucenter/v2/emoticon/GetEmoticons?platform=pc&room_id='+a.room_id,{method:'GET',credentials:'include',body:null}).then((a)=>a.json()).then((b)=>{if(0===b.code){let c='';for(let a=2;0<=a;a--)if(b.data.data[a]!==void 0&&null!==b.data.data[a]){c+=`</tr></tbody><thead><tr><th colspan='4' class='rua-table-header'>${b.data.data[a].pkg_name}</th></tr></thead><tbody><tr>`;for(let d,e=0;e<b.data.data[a].emoticons.length;e++)d=z.emojiRequiredPrivilege<=b.data.data[a].emoticons[e].identity&&b.data.data[a].emoticons[e].unlock_need_level<=B.emojiRequiredMedalLevel,0==e%8&&0!==e&&(c+='</tr><tr>'),c+=`<td colspan="1" title="${b.data.data[a].emoticons[e].emoji}" id="${b.data.data[a].emoticons[e].emoticon_unique}"><div  class="rua-emoji-icon ${d?'rua-emoji-icon-active':'rua-emoji-icon-inactive'}" style="width:60px; height:60px; background-image:url('${b.data.data[a].emoticons[e].url.replace('http://','https://')}');"></div><div class="rua-emoji-requirement" style="background-color: ${b.data.data[a].emoticons[e].unlock_show_color};"><div class="rua-emoji-requirement-text">${b.data.data[a].emoticons[e].unlock_show_text}</div></div></td>`}c+='</tr></tbody>',C.getElementsByClassName('emoji-sec')[0].getElementsByTagName('table')[0].innerHTML=c;for(let b,c=0;c<C.getElementsByClassName('emoji-sec')[0].getElementsByTagName('table')[0].rows.length;c++){b=C.getElementsByClassName('emoji-sec')[0].getElementsByTagName('table')[0].rows[c].cells;for(let c=0;c<b.length;c++){const d=b[c].getElementsByTagName('div')[0];b[c].onclick=function(b){0===b.button&&d.classList.contains('rua-emoji-icon-active')&&(C.getElementsByClassName('input-container')[0].getElementsByTagName('input')[0].focus(),h(this.id,'systemEmoji',a.room_id))}}}}}).catch(()=>{})}}function f(){try{chrome.runtime.sendMessage({msg:'get_LoginInfo'},function(a){m=a.res.split(',')[0],l=a.res.split(',')[1]})}catch(a){}}function g(){return k(Date.now()/1e3)}function h(a,b,c){let d=new FormData;d.append('bubble','0'),d.append('msg',a),d.append('color','16777215'),d.append('mode','1'),b!==void 0&&'systemEmoji'===b&&d.append('dm_type','1'),d.append('fontsize','25'),d.append('rnd',g()+''),d.append('roomid',c),d.append('csrf',m),d.append('csrf_token',m),0!==a.length&&i(d)}function i(a){fetch('https://api.live.bilibili.com/msg/send?requestFrom=rua5',{method:'POST',credentials:'include',body:a}).then((a)=>a.json()).then((a)=>{console.log('sent'),0===a.message.length?'\u4F60\u6240\u5728\u7684\u5730\u533A\u6682\u65E0\u6CD5\u53D1\u8A00'===a.message&&console.error('Error:','\u4F60\u6240\u5728\u7684\u5730\u533A\u6682\u65E0\u6CD5\u53D1\u8A00'):console.error('Error:','\u4F60\u7684\u5F39\u5E55\u88AB\u7CFB\u7EDF\u541E\u4E86\uFF0C\u91CD\u8BD5\u4E00\u4E0B\u5427\u3002')}).catch((a)=>{console.error('Error:',a)})}function j(a,b){return fetch('https://api.live.bilibili.com/xlive/web-ucenter/user/MedalWall?target_id='+b,{method:'GET',credentials:'include',body:null}).then((a)=>a.json()).then((b)=>{if(0===b.code)for(let c of b.data.list)if(c.medal_info.target_id===a)return{emojiRequiredMedalLevel:c.medal_info.level,medal_id:c.medal_info.medal_id,medal_name:c.medal_info.medal_name}}).catch(()=>{})}var k=Math.round;let l,m,n=null,o=null,p=null,q=document.getElementsByClassName('control-bar')[0],r=null,s=!1,t=new Map,u=!1;f(),setInterval(f,3e3),!function(){n=document.getElementsByClassName('add-room')[0].getElementsByTagName('svg')[0],p=document.getElementsByClassName('setting')[0].getElementsByTagName('svg')[0],o=document.getElementsByClassName('fullscreen')[0].getElementsByTagName('svg')[0],document.body.addEventListener('mousemove',()=>{clearTimeout(r),q.style.opacity='1',r=setTimeout(b,1e3)}),document.body.addEventListener('mouseup',()=>{for(let a=0;a<document.body.getElementsByClassName('volume-control').length;a++)document.body.getElementsByClassName('volume-control')[a].style.display='none'}),n.addEventListener('click',()=>{document.getElementsByClassName('panel-container')[0].removeEventListener('click',a),document.getElementsByClassName('panel-container')[0].style.zIndex='10',document.getElementsByClassName('panel-container')[0].style.display='block',document.getElementsByClassName('panel-container')[0].addEventListener('click',a),document.getElementsByClassName('add-room-panel')[0].style.display='flex',document.getElementsByClassName('add-room-panel')[0].addEventListener('click',(a)=>{a.stopPropagation()}),c()}),p.addEventListener('click',()=>{document.getElementsByClassName('panel-container')[0].removeEventListener('click',a),document.getElementsByClassName('panel-container')[0].style.zIndex='10',document.getElementsByClassName('panel-container')[0].style.display='block',document.getElementsByClassName('panel-container')[0].addEventListener('click',a),document.getElementsByClassName('setting-panel')[0].style.display='flex',document.getElementsByClassName('setting-panel')[0].addEventListener('click',(a)=>{a.stopPropagation()}),c()}),o.addEventListener('click',()=>{s?document.exitFullscreen().then(()=>{s=!1}).catch(()=>{document.body.requestFullscreen().then(),s=!0}):document.body.requestFullscreen().then(()=>{s=!0}).catch(()=>{document.exitFullscreen().then(),s=!1})})}()}();