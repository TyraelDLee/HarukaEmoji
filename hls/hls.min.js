(function t(e){(function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"==typeof globalThis?e||self:globalThis,e.Hls=t())})(this,function(){"use strict";var a=Math.ceil,r=Math.exp,n=Number.POSITIVE_INFINITY,i=Number.isFinite,d=Math.round,o=Math.min,s=Math.abs,l=Number.MAX_SAFE_INTEGER,u=Math.floor,c=Math.pow,f=Math.max,g=String.fromCharCode;function m(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),a.push.apply(a,r)}return a}function p(e){for(var t=1,a;t<arguments.length;t++)a=null==arguments[t]?{}:arguments[t],t%2?m(Object(a),!0).forEach(function(t){h(e,t,a[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):m(Object(a)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))});return e}function y(e,t){for(var a=0,r;a<t.length;a++)r=t[a],r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,x(r.key),r)}function T(e,t,a){return t&&y(e.prototype,t),a&&y(e,a),Object.defineProperty(e,"prototype",{writable:!1}),e}function h(e,t,a){return t=x(t),t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function E(){return E=Object.assign?Object.assign.bind():function(e){for(var t=1,a;t<arguments.length;t++)for(var r in a=arguments[t],a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r]);return e},E.apply(this,arguments)}function S(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,R(e,t)}function L(e){return L=Object.setPrototypeOf?Object.getPrototypeOf.bind():function t(e){return e.__proto__||Object.getPrototypeOf(e)},L(e)}function R(e,t){return R=Object.setPrototypeOf?Object.setPrototypeOf.bind():function a(e,t){return e.__proto__=t,e},R(e,t)}function A(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}function v(e,t,a){return v=A()?Reflect.construct.bind():function n(e,t,r){var i=[null];i.push.apply(i,t);var a=Function.bind.apply(e,i),d=new a;return r&&R(d,r.prototype),d},v.apply(null,arguments)}function I(e){return-1!==Function.toString.call(e).indexOf("[native code]")}function D(e){var t="function"==typeof Map?new Map:void 0;return D=function a(e){function r(){return v(e,arguments,L(this).constructor)}if(null===e||!I(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if("undefined"!=typeof t){if(t.has(e))return t.get(e);t.set(e,r)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),R(r,e)},D(e)}function k(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _(e,t){if(e){if("string"==typeof e)return b(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);return"Object"===a&&e.constructor&&(a=e.constructor.name),"Map"===a||"Set"===a?Array.from(e):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?b(e,t):void 0}}function b(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,r=Array(t);a<t;a++)r[a]=e[a];return r}function C(e,t){var a="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(a)return(a=a.call(e)).next.bind(a);if(Array.isArray(e)||(a=_(e))||t&&e&&"number"==typeof e.length){a&&(e=a);var r=0;return function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function P(e,t){if("object"!=typeof e||null===e)return e;var a=e[Symbol.toPrimitive];if(void 0!==a){var r=a.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}function x(e){var t=P(e,"string");return"symbol"==typeof t?t:t+""}function F(e){var t=self.console[e];return t?t.bind(self.console,"["+e+"] >"):Sr}function O(e){for(var t=arguments.length,a=Array(1<t?t-1:0),r=1;r<t;r++)a[r-1]=arguments[r];a.forEach(function(t){Rr[t]=e[t]?e[t].bind(e):F(t)})}function N(e,t){if(self.console&&!0===e||"object"==typeof e){O(e,"debug","log","info","warn","error");try{Rr.log("Debug logs enabled for \""+t+"\" in hls.js version 1.4.12")}catch(t){Rr=Lr}}else Rr=Lr}function M(e){return"ID"!==e&&"CLASS"!==e&&"START-DATE"!==e&&"DURATION"!==e&&"END-DATE"!==e&&"END-ON-NEXT"!==e}function w(e){return"SCTE35-OUT"===e||"SCTE35-IN"===e}function B(e){return Uint8Array.from(atob(e),function(e){return e.charCodeAt(0)})}function U(e){var t=H(e).subarray(0,16),a=new Uint8Array(16);return a.set(t,16-t.length),a}function G(e){var t=function r(e,t,a){var n=e[t];e[t]=e[a],e[a]=n};t(e,0,3),t(e,1,2),t(e,4,5),t(e,6,7)}function K(e){var t=e.split(":"),a=null;if("data"===t[0]&&2===t.length){var r=t[1].split(";"),n=r[r.length-1].split(",");if(2===n.length){var i="base64"===n[0],d=n[1];i?(r.splice(-1,1),a=B(d)):a=U(d)}}return a}function H(e){return Uint8Array.from(unescape(encodeURIComponent(e)),function(e){return e.charCodeAt(0)})}function V(e){return e===Nr.FAIRPLAY?Or.FAIRPLAY:e===Nr.PLAYREADY?Or.PLAYREADY:e===Nr.WIDEVINE?Or.WIDEVINE:e===Nr.CLEARKEY?Or.CLEARKEY:void 0}function W(e){if(e===Mr.WIDEVINE)return Or.WIDEVINE}function Y(e){return e===Or.FAIRPLAY?Nr.FAIRPLAY:e===Or.PLAYREADY?Nr.PLAYREADY:e===Or.WIDEVINE?Nr.WIDEVINE:e===Or.CLEARKEY?Nr.CLEARKEY:void 0}function q(e){var t=e.drmSystems,a=e.widevineLicenseUrl,r=t?[Or.FAIRPLAY,Or.WIDEVINE,Or.PLAYREADY,Or.CLEARKEY].filter(function(e){return!!t[e]}):[];return!r[Or.WIDEVINE]&&a&&r.push(Or.WIDEVINE),r}function z(e,t,a,r){var n;switch(e){case Or.FAIRPLAY:n=["cenc","sinf"];break;case Or.WIDEVINE:case Or.PLAYREADY:n=["cenc"];break;case Or.CLEARKEY:n=["cenc","keyids"];break;default:throw new Error("Unknown key-system: "+e)}return j(n,t,a,r)}function j(e,t,a,r){var n={initDataTypes:e,persistentState:r.persistentState||"not-allowed",distinctiveIdentifier:r.distinctiveIdentifier||"not-allowed",sessionTypes:r.sessionTypes||[r.sessionType||"temporary"],audioCapabilities:t.map(function(e){return{contentType:"audio/mp4; codecs=\""+e+"\"",robustness:r.audioRobustness||"",encryptionScheme:r.audioEncryptionScheme||null}}),videoCapabilities:a.map(function(e){return{contentType:"video/mp4; codecs=\""+e+"\"",robustness:r.videoRobustness||"",encryptionScheme:r.videoEncryptionScheme||null}})};return[n]}function X(e,t,a){return Uint8Array.prototype.slice?e.slice(t,a):new Uint8Array(Array.prototype.slice.call(e,t,a))}function Q(){return gi||"undefined"==typeof self.TextDecoder||(gi=new self.TextDecoder("utf-8")),gi}function Z(e){return g.apply(null,e)}function $(e,t){var a=e[t]<<8|e[t+1];return 0>a?65536+a:a}function J(e,t){var a=ee(e,t);return 0>a?4294967296+a:a}function ee(e,t){return e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3]}function te(e,t,a){e[t]=a>>24,e[t+1]=255&a>>16,e[t+2]=255&a>>8,e[t+3]=255&a}function ae(e,t){var a=[];if(!t.length)return a;for(var r=e.byteLength,n=0;n<r;){var d=J(e,n),o=Z(e.subarray(n+4,n+8)),s=1<d?n+d:r;if(o===t[0])if(1===t.length)a.push(e.subarray(n+8,s));else{var l=ae(e.subarray(n+8,s),t.slice(1));l.length&&tn.apply(a,l)}n=s}return a}function re(e){var t=[],a=e[0],r=8,n=J(e,r);r+=4;var d=0,o=0;r+=0===a?8:16,r+=2;var s=e.length+o,l=$(e,r);r+=2;for(var u=0;u<l;u++){var c=r,f=J(e,c);c+=4;var g=2147483647&f,m=(2147483648&f)>>>31;if(1===m)return Ar.warn("SIDX has hierarchical references (not supported)"),null;var p=J(e,c);c+=4,t.push({referenceSize:g,subsegmentDuration:p,info:{duration:p/n,start:s,end:s+g-1}}),s+=g,c+=4,r=c}return{earliestPresentationTime:0,timescale:n,version:a,referencesCount:l,references:t}}function ne(e){for(var t=[],a=ae(e,["moov","trak"]),r=0;r<a.length;r++){var n=a[r],d=ae(n,["tkhd"])[0];if(d){var o=d[0],s=0===o?12:20,l=J(d,s),u=ae(n,["mdia","mdhd"])[0];if(u){o=u[0],s=0===o?12:20;var c=J(u,s),f=ae(n,["mdia","hdlr"])[0];if(f){var g=Z(f.subarray(8,12)),m={soun:br.AUDIO,vide:br.VIDEO}[g];if(m){var p=ae(n,["mdia","minf","stbl","stsd"])[0],y=void 0;p&&(y=Z(p.subarray(12,16))),t[l]={timescale:c,type:m},t[m]={timescale:c,id:l,codec:y}}}}}}var T=ae(e,["moov","mvex","trex"]);return T.forEach(function(e){var a=J(e,4),r=t[a];r&&(r.default={duration:J(e,12),flags:J(e,20)})}),t}function ie(e,t){if(!e||!t)return e;var a=t.keyId;if(a&&t.isCommonEncryption){var r=ae(e,["moov","trak"]);r.forEach(function(e){var t=ae(e,["mdia","minf","stbl","stsd"])[0],r=t.subarray(8),n=ae(r,["enca"]),i=0<n.length;i||(n=ae(r,["encv"])),n.forEach(function(e){var t=i?e.subarray(28):e.subarray(78),r=ae(t,["sinf"]);r.forEach(function(e){var t=de(e);if(t){var r=t.subarray(8,24);r.some(function(e){return 0!==e})||(Ar.log("[eme] Patching keyId in 'enc"+(i?"a":"v")+">sinf>>tenc' box: "+Jr.hexDump(r)+" -> "+Jr.hexDump(a)),t.set(a,8))}})})})}return e}function de(e){var t=ae(e,["schm"])[0];if(t){var a=Z(t.subarray(4,8));if("cbcs"===a||"cenc"===a)return ae(e,["schi","tenc"])[0]}return Ar.error("[eme] missing 'schm' box"),null}function oe(e,t){return ae(t,["moof","traf"]).reduce(function(t,a){var r=ae(a,["tfdt"])[0],n=r[0],i=ae(a,["tfhd"]).reduce(function(t,a){var i=J(a,4),d=e[i];if(d){var o=J(r,4);if(1===n){if(4294967295===o)return Ar.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"),t;o*=4294967296,o+=J(r,8)}var s=d.timescale||9e4,l=o/s;if(isFinite(l)&&(null===t||l<t))return l}return t},null);return null!==i&&isFinite(i)&&(null===t||i<t)?i:t},null)}function se(e,t){for(var a=0,r=0,n=0,d=ae(e,["moof","traf"]),o=0;o<d.length;o++){var s=d[o],l=ae(s,["tfhd"])[0],u=J(l,4),c=t[u];if(c){var f=c.default,g=J(l,0)|(null==f?void 0:f.flags),m=null==f?void 0:f.duration;8&g&&(2&g?m=J(l,12):m=J(l,8));for(var p=c.timescale||9e4,y=ae(s,["trun"]),T=0;T<y.length;T++){if(a=le(y[T]),!a&&m){var h=J(y[T],4);a=m*h}c.type===br.VIDEO?r+=a/p:c.type===br.AUDIO&&(n+=a/p)}}}if(0===r&&0===n){for(var E=0,S=ae(e,["sidx"]),L=0,R;L<S.length;L++)R=re(S[L]),null!=R&&R.references&&(E+=R.references.reduce(function(e,t){return e+t.info.duration||0},0));return E}return r?r:n}function le(e){var t=J(e,0),a=8;1&t&&(a+=4),4&t&&(a+=4);for(var r=0,n=J(e,4),d=0;d<n;d++){if(256&t){var o=J(e,a);r+=o,a+=4}512&t&&(a+=4),1024&t&&(a+=4),2048&t&&(a+=4)}return r}function ue(e,t,a){ae(t,["moof","traf"]).forEach(function(t){ae(t,["tfhd"]).forEach(function(r){var n=J(r,4),i=e[n];if(i){var d=i.timescale||9e4;ae(t,["tfdt"]).forEach(function(e){var t=e[0],r=J(e,4);if(0===t)r-=a*d,r=f(r,0),te(e,4,r);else{r*=c(2,32),r+=J(e,8),r-=a*d,r=f(r,0);var n=u(r/4294967296),i=u(r%4294967296);te(e,4,n),te(e,8,i)}})}})})}function ce(e){var t={valid:null,remainder:null},a=ae(e,["moof"]);if(!a)return t;if(2>a.length)return t.remainder=e,t;var r=a[a.length-1];return t.valid=X(e,0,r.byteOffset-8),t.remainder=X(e,r.byteOffset-8),t}function fe(e,t){var a=new Uint8Array(e.length+t.length);return a.set(e),a.set(t,e.length),a}function ge(e,t){var a=[],r=t.samples,n=t.timescale,i=t.id,d=!1,o=ae(r,["moof"]);return o.map(function(o){var s=o.byteOffset-8,l=ae(o,["traf"]);l.map(function(o){var l=ae(o,["tfdt"]).map(function(e){var t=e[0],a=J(e,4);return 1===t&&(a*=c(2,32),a+=J(e,8)),a/n})[0];return void 0!==l&&(e=l),ae(o,["tfhd"]).map(function(l){var u=J(l,4),c=16777215&J(l,0),f=0!=(1&c),g=0!=(2&c),m=0!=(8&c),p=0,y=0!=(16&c),T=0,h=0!=(32&c),E=8;u===i&&(f&&(E+=8),g&&(E+=4),m&&(p=J(l,E),E+=4),y&&(T=J(l,E),E+=4),h&&(E+=4),"video"===t.type&&(d=me(t.codec)),ae(o,["trun"]).map(function(i){var o=i[0],l=16777215&J(i,0),u=0!=(1&l),c=0,f=0!=(4&l),g=0!=(256&l),m=0,y=0!=(512&l),h=0,E=0!=(1024&l),S=0!=(2048&l),L=0,R=J(i,4),A=8;u&&(c=J(i,A),A+=4),f&&(A+=4);for(var v=c+s,I=0;I<R;I++){if(g?(m=J(i,A),A+=4):m=p,y?(h=J(i,A),A+=4):h=T,E&&(A+=4),S&&(L=0===o?J(i,A):ee(i,A),A+=4),t.type===br.VIDEO)for(var D=0,k;D<h;){if(k=J(r,v),v+=4,pe(d,r[v])){var _=r.subarray(v,v+k);ye(_,d?2:1,e+L/n,a)}v+=k,D+=k+4}e+=m/n}}))})})}),a}function me(e){if(!e)return!1;var t=e.indexOf("."),a=0>t?e:e.substring(0,t);return"hvc1"===a||"hev1"===a||"dvh1"===a||"dvhe"===a}function pe(e,t){if(e){var a=63&t>>1;return 39==a||40===a}var r=31&t;return 6==r}function ye(e,t,a,r){var n=Te(e),d=0;d+=t;for(var o=0,s=0,l=!1,u=0;d<n.length;){o=0;do{if(d>=n.length)break;u=n[d++],o+=u}while(255===u);s=0;do{if(d>=n.length)break;u=n[d++],s+=u}while(255===u);var c=n.length-d;if(!l&&4===o&&d<n.length){l=!0;var f=n[d++];if(181===f){var g=$(n,d);if(d+=2,49===g){var m=J(n,d);if(d+=4,1195456820===m){var p=n[d++];if(3===p){var y=n[d++],T=31&y,h=64&y,E=h?2+3*T:0,S=new Uint8Array(E);if(h){S[0]=y;for(var L=1;L<E;L++)S[L]=n[d++]}r.push({type:p,payloadType:o,pts:a,bytes:S})}}}}}else if(5===o&&s<c){if(l=!0,16<s){for(var R=[],A=0,v;16>A;A++)v=n[d++].toString(16),R.push(1==v.length?"0"+v:v),(3==A||5===A||7===A||9===A)&&R.push("-");for(var I=s-16,D=new Uint8Array(I),k=0;k<I;k++)D[k]=n[d++];r.push({payloadType:o,pts:a,uuid:R.join(""),userData:$r(D),userDataBytes:D})}}else if(s<c)d+=s;else if(s>c)break}}function Te(e){for(var t=e.byteLength,a=[],r=1;r<t-2;)0===e[r]&&0===e[r+1]&&3===e[r+2]?(a.push(r+2),r+=2):r++;if(0===a.length)return e;var n=t-a.length,d=new Uint8Array(n),o=0;for(r=0;r<n;o++,r++)o===a[0]&&(o++,a.shift()),d[r]=e[o];return d}function he(e){var t=Number.isSafeInteger,a=e[0],r="",n="",i=0,d=0,o=0,s=0,u=0,f=0;if(0===a){for(;"\0"!==Z(e.subarray(f,f+1));)r+=Z(e.subarray(f,f+1)),f+=1;for(r+=Z(e.subarray(f,f+1)),f+=1;"\0"!==Z(e.subarray(f,f+1));)n+=Z(e.subarray(f,f+1)),f+=1;n+=Z(e.subarray(f,f+1)),f+=1,i=J(e,12),d=J(e,16),s=J(e,20),u=J(e,24),f=28}else if(1===a){f+=4,i=J(e,f),f+=4;var g=J(e,f);f+=4;var m=J(e,f);for(f+=4,o=c(2,32)*g+m,t(o)||(o=l,Ar.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),s=J(e,f),f+=4,u=J(e,f),f+=4;"\0"!==Z(e.subarray(f,f+1));)r+=Z(e.subarray(f,f+1)),f+=1;for(r+=Z(e.subarray(f,f+1)),f+=1;"\0"!==Z(e.subarray(f,f+1));)n+=Z(e.subarray(f,f+1)),f+=1;n+=Z(e.subarray(f,f+1)),f+=1}var p=e.subarray(f,e.byteLength);return{schemeIdUri:r,value:n,timeScale:i,presentationTime:o,presentationTimeDelta:d,eventDuration:s,id:u,payload:p}}function Ee(e){for(var t=arguments.length,a=Array(1<t?t-1:0),r=1;r<t;r++)a[r-1]=arguments[r];for(var n=a.length,d=8,o=n;o--;)d+=a[o].byteLength;var s=new Uint8Array(d);for(s[0]=255&d>>24,s[1]=255&d>>16,s[2]=255&d>>8,s[3]=255&d,s.set(e,4),(o=0,d=8);o<n;o++)s.set(a[o],d),d+=a[o].byteLength;return s}function Se(e,t,a){if(16!==e.byteLength)throw new RangeError("Invalid system id");var r,n;if(t){r=1,n=new Uint8Array(16*t.length);for(var i=0,d;i<t.length;i++){if(d=t[i],16!==d.byteLength)throw new RangeError("Invalid key");n.set(d,16*i)}}else r=0,n=new Uint8Array;var o;0<r?(o=new Uint8Array(4),0<t.length&&new DataView(o.buffer).setUint32(0,t.length,!1)):o=new Uint8Array;var s=new Uint8Array(4);return a&&0<a.byteLength&&new DataView(s.buffer).setUint32(0,a.byteLength,!1),Ee([112,115,115,104],new Uint8Array([r,0,0,0]),e,o,n,s,a||new Uint8Array)}function Le(e){if(!(e instanceof ArrayBuffer)||32>e.byteLength)return null;var t={version:0,systemId:"",kids:null,data:null},a=new DataView(e),r=a.getUint32(0);if(e.byteLength!==r&&44<r)return null;var n=a.getUint32(4);if(1886614376!==n)return null;if(t.version=a.getUint32(8)>>>24,1<t.version)return null;t.systemId=Jr.hexDump(new Uint8Array(e,12,16));var d=a.getUint32(28);if(0===t.version){if(r-32<d)return null;t.data=new Uint8Array(e,32,d)}else if(1===t.version){t.kids=[];for(var o=0;o<d;o++)t.kids.push(new Uint8Array(e,32+16*o,16))}return t}function Re(e){for(var t=new Uint8Array(16),a=12;16>a;a++)t[a]=255&e>>8*(15-a);return t}function Ae(e){return dn.test(e)}function ve(e,t,a){if(null!==e.variableList||e.hasVariableRefs)for(var r=a.length;r--;){var n=a[r],d=t[n];d&&(t[n]=Ie(e,d))}}function Ie(e,t){if(null!==e.variableList||e.hasVariableRefs){var a=e.variableList;return t.replace(dn,function(t){var r=t.substring(2,t.length-1),n=null==a?void 0:a[r];return void 0===n?(e.playlistParsingError||(e.playlistParsingError=new Error("Missing preceding EXT-X-DEFINE tag for Variable Reference: \""+r+"\"")),t):n})}return t}function De(e,t,a){var r=e.variableList;r||(e.variableList=r={});var n,i;if("QUERYPARAM"in t){n=t.QUERYPARAM;try{var d=new self.URL(a).searchParams;if(d.has(n))i=d.get(n);else throw new Error("\""+n+"\" does not match any query parameter in URI: \""+a+"\"")}catch(t){e.playlistParsingError||(e.playlistParsingError=new Error("EXT-X-DEFINE QUERYPARAM: "+t.message))}}else n=t.NAME,i=t.VALUE;n in r?e.playlistParsingError||(e.playlistParsingError=new Error("EXT-X-DEFINE duplicate Variable Name declarations: \""+n+"\"")):r[n]=i||""}function ke(e,t,a){var r=t.IMPORT;if(a&&r in a){var n=e.variableList;n||(e.variableList=n={}),n[r]=a[r]}else e.playlistParsingError||(e.playlistParsingError=new Error("EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: \""+r+"\""))}function _e(){return"undefined"==typeof self?void 0:self.MediaSource||self.WebKitMediaSource}function be(e,t){var a=on[t];return!!a&&!0===a[e.slice(0,4)]}function Ce(e,t){var a;return null!=(a=null==sn?void 0:sn.isTypeSupported((t||"video")+"/mp4;codecs=\""+e+"\""))&&a}function Pe(e,t,a){var r=new Dr(e),n,i;ve(a,r,["KEYFORMAT","KEYFORMATVERSIONS","URI","IV","URI"]);var d=null==(n=r.METHOD)?"":n,o=r.URI,s=r.hexadecimalInteger("IV"),l=r.KEYFORMATVERSIONS,u=null==(i=r.KEYFORMAT)?"identity":i;o&&r.IV&&!s&&Ar.error("Invalid IV: "+r.IV);var c=o?mn.resolve(o,t):"",f=(l?l:"1").split("/").map(Number).filter(Number.isFinite);return new nn(d,c,u,f,s)}function xe(e){var t=new Dr(e),a=t.decimalFloatingPoint("TIME-OFFSET");return yr(a)?a:null}function Fe(e,t){["video","audio","text"].forEach(function(a){var r=e.filter(function(e){return be(e,a)});if(r.length){var n=r.filter(function(e){return 0===e.lastIndexOf("avc1",0)||0===e.lastIndexOf("mp4a",0)});t[a+"Codec"]=0<n.length?n[0]:r[0],e=e.filter(function(e){return-1===r.indexOf(e)})}}),t.unknownCodecs=e}function Oe(e,t,a){var r=t[a];r&&(e[a]=r)}function Ne(e,t){for(var a=e[t],r=t,n;r--;){if(n=e[r],!n)return;n.programDateTime=a.programDateTime-1e3*n.duration,a=n}}function Me(e,t){e.rawProgramDateTime?e.programDateTime=Date.parse(e.rawProgramDateTime):null!=t&&t.programDateTime&&(e.programDateTime=t.endProgramDateTime),yr(e.programDateTime)||(e.programDateTime=null,e.rawProgramDateTime=null)}function we(e,t,a,r){e.relurl=t.URI,t.BYTERANGE&&e.setByteRange(t.BYTERANGE),e.level=a,e.sn="initSegment",r&&(e.levelkeys=r),e.initSegment=null}function Be(e,t,a){e.levelkeys=t;var r=a.encryptedFragments;(!r.length||r[r.length-1].levelkeys!==t)&&Object.keys(t).some(function(e){return t[e].isCommonEncryption})&&r.push(e)}function Ue(e){var t=e.type;return t===pn.AUDIO_TRACK?yn.AUDIO:t===pn.SUBTITLE_TRACK?yn.SUBTITLE:yn.MAIN}function Ge(e,t){var a=e.url;return(void 0===a||0===a.indexOf("data:"))&&(a=t.url),a}function Ke(e,t){var a;try{a=new Event("addtrack")}catch(e){a=document.createEvent("Event"),a.initEvent("addtrack",!1,!1)}a.track=e,t.dispatchEvent(a)}function He(e,t){var a=e.mode;if("disabled"===a&&(e.mode="hidden"),e.cues&&!e.cues.getCueById(t.id))try{if(e.addCue(t),!e.cues.getCueById(t.id))throw new Error("addCue is failed for: "+t)}catch(a){Ar.debug("[texttrack-utils]: "+a);try{var r=new self.TextTrackCue(t.startTime,t.endTime,t.text);r.id=t.id,e.addCue(r)}catch(e){Ar.debug("[texttrack-utils]: Legacy TextTrackCue fallback failed: "+e)}}"disabled"===a&&(e.mode=a)}function Ve(e){var t=e.mode;if("disabled"===t&&(e.mode="hidden"),e.cues)for(var a=e.cues.length;a--;)e.removeCue(e.cues[a]);"disabled"===t&&(e.mode=t)}function We(e,t,a,r){var n=e.mode;if("disabled"===n&&(e.mode="hidden"),e.cues&&0<e.cues.length)for(var d=qe(e.cues,t,a),o=0;o<d.length;o++)(!r||r(d[o]))&&e.removeCue(d[o]);"disabled"===n&&(e.mode=n)}function Ye(e,t){if(t<e[0].startTime)return 0;var a=e.length-1;if(t>e[a].endTime)return-1;for(var r=0,n=a,i;r<=n;)if(i=u((n+r)/2),t<e[i].startTime)n=i-1;else if(t>e[i].startTime&&r<a)r=i+1;else return i;return e[r].startTime-t<t-e[n].startTime?r:n}function qe(e,t,a){var r=[],n=Ye(e,t);if(-1<n)for(var d=n,o=e.length,s;d<o;d++)if(s=e[d],s.startTime>=t&&s.endTime<=a)r.push(s);else if(s.startTime>a)return r;return r}function ze(){return"undefined"==typeof self?void 0:self.WebKitDataCue||self.VTTCue||self.TextTrackCue}function je(e,t){return e.getTime()/1e3-t}function Xe(e){return Uint8Array.from(e.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer}function Qe(e,t){var a=e.canSkipUntil,r=e.canSkipDateRanges,n=e.endSN,i=void 0===t?0:t-n;return a&&i<a?r?An.v2:An.Yes:An.No}function Ze(e,t){var a=t.startPTS;if(yr(a)){var r=0,n;t.sn>e.sn?(r=a-e.start,n=e):(r=e.start-a,n=t),n.duration!==r&&(n.duration=r)}else if(t.sn>e.sn){var i=e.cc===t.cc;t.start=i&&e.minEndPTS?e.start+(e.minEndPTS-e.start):e.start+e.duration}else t.start=f(e.start-t.duration,0)}function $e(e,t,a,r,n,d){var l=r-a;0>=l&&(Ar.warn("Fragment should have a positive duration",t),r=a+t.duration,d=n+t.duration);var u=a,c=r,g=t.startPTS,m=t.endPTS;if(yr(g)){var p=s(g-a);t.deltaPTS=yr(t.deltaPTS)?f(p,t.deltaPTS):p,u=f(a,g),a=o(a,g),n=o(n,t.startDTS),c=o(r,m),r=f(r,m),d=f(d,t.endDTS)}var y=a-t.start;0!==t.start&&(t.start=a),t.duration=r-t.start,t.startPTS=a,t.maxStartPTS=u,t.startDTS=n,t.endPTS=r,t.minEndPTS=c,t.endDTS=d;var T=t.sn;if(!e||T<e.startSN||T>e.endSN)return 0;var h=T-e.startSN,E=e.fragments,S;for(E[h]=t,S=h;0<S;S--)Ze(E[S],E[S-1]);for(S=h;S<E.length-1;S++)Ze(E[S],E[S+1]);return e.fragmentHint&&Ze(E[E.length-1],e.fragmentHint),e.PTSKnown=e.alignedSliding=!0,y}function Je(e,t){for(var a=null,r=e.fragments,n=r.length-1,d;0<=n;n--)if(d=r[n].initSegment,d){a=d;break}e.fragmentHint&&delete e.fragmentHint.endPTS;var o=0,s;if(at(e,t,function(e,r){e.relurl&&(o=e.cc-r.cc),yr(e.startPTS)&&yr(e.endPTS)&&(r.start=r.startPTS=e.startPTS,r.startDTS=e.startDTS,r.maxStartPTS=e.maxStartPTS,r.endPTS=e.endPTS,r.endDTS=e.endDTS,r.minEndPTS=e.minEndPTS,r.duration=e.endPTS-e.startPTS,r.duration&&(s=r),t.PTSKnown=t.alignedSliding=!0),r.elementaryStreams=e.elementaryStreams,r.loader=e.loader,r.stats=e.stats,r.urlId=e.urlId,e.initSegment&&(r.initSegment=e.initSegment,a=e.initSegment)}),a){var l=t.fragmentHint?t.fragments.concat(t.fragmentHint):t.fragments;l.forEach(function(e){var t;e.initSegment&&e.initSegment.relurl!==(null==(t=a)?void 0:t.relurl)||(e.initSegment=a)})}if(t.skippedSegments)if(t.deltaUpdateFailed=t.fragments.some(function(e){return!e}),t.deltaUpdateFailed){Ar.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(var u=t.skippedSegments;u--;)t.fragments.shift();t.startSN=t.fragments[0].sn,t.startCC=t.fragments[0].cc}else t.canSkipDateRanges&&(t.dateRanges=et(e.dateRanges,t.dateRanges,t.recentlyRemovedDateranges));var c=t.fragments;if(o){Ar.warn("discontinuity sliding from playlist, take drift into account");for(var f=0;f<c.length;f++)c[f].cc+=o}t.skippedSegments&&(t.startCC=t.fragments[0].cc),tt(e.partList,t.partList,function(e,t){t.elementaryStreams=e.elementaryStreams,t.stats=e.stats}),s?$e(t,s,s.startPTS,s.endPTS,s.startDTS,s.endDTS):rt(e,t),c.length&&(t.totalduration=t.edge-c[0].start),t.driftStartTime=e.driftStartTime,t.driftStart=e.driftStart;var g=t.advancedDateTime;if(t.advanced&&g){var m=t.edge;t.driftStart||(t.driftStartTime=g,t.driftStart=m),t.driftEndTime=g,t.driftEnd=m}else t.driftEndTime=e.driftEndTime,t.driftEnd=e.driftEnd,t.advancedDateTime=e.advancedDateTime}function et(e,t,a){var r=E({},e);return a&&a.forEach(function(e){delete r[e]}),Object.keys(t).forEach(function(e){var a=new kr(t[e].attr,r[e]);a.isValid?r[e]=a:Ar.warn("Ignoring invalid Playlist Delta Update DATERANGE tag: \""+JSON.stringify(t[e].attr)+"\"")}),r}function tt(e,t,a){if(e&&t)for(var r=0,n=0,d=e.length;n<=d;n++){var o=e[n],s=t[n+r];o&&s&&o.index===s.index&&o.fragment.sn===s.fragment.sn?a(o,s):r--}}function at(e,t,a){for(var r=t.skippedSegments,n=f(e.startSN,t.startSN)-t.startSN,d=(e.fragmentHint?1:0)+(r?t.endSN:o(e.endSN,t.endSN))-t.startSN,s=t.startSN-e.startSN,l=t.fragmentHint?t.fragments.concat(t.fragmentHint):t.fragments,u=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments,c=n;c<=d;c++){var g=u[s+c],m=l[c];r&&!m&&c<r&&(m=t.fragments[c]=g),g&&m&&a(g,m)}}function rt(e,t){var a=t.startSN+t.skippedSegments-e.startSN,r=e.fragments;0>a||a>=r.length||nt(t,r[a].start)}function nt(e,t){if(t){for(var a=e.fragments,r=e.skippedSegments;r<a.length;r++)a[r].start+=t;e.fragmentHint&&(e.fragmentHint.start+=t)}}function it(e,t){void 0===t&&(t=1/0);var a=1e3*e.targetduration;if(e.updated){var r=e.fragments,n=4;if(r.length&&a*n>t){var i=1e3*r[r.length-1].duration;i<a&&(a=i)}}else a/=2;return d(a)}function dt(e,t,a){if(!(null!=e&&e.details))return null;var r=e.details,n=r.fragments[t-r.startSN];return n?n:(n=r.fragmentHint,n&&n.sn===t?n:t<r.startSN&&a&&a.sn===t?a:null)}function ot(e,t,a){var r;return null!=e&&e.details?st(null==(r=e.details)?void 0:r.partList,t,a):null}function st(e,t,a){if(e)for(var r=e.length,n;r--;)if(n=e[r],n.index===a&&n.fragment.sn===t)return n;return null}function lt(e){switch(e.details){case Er.FRAG_LOAD_TIMEOUT:case Er.KEY_LOAD_TIMEOUT:case Er.LEVEL_LOAD_TIMEOUT:case Er.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function ut(e,t){var a=lt(t);return e.default[(a?"timeout":"error")+"Retry"]}function ct(e,t){var a="linear"===e.backoff?1:c(2,t);return o(a*e.retryDelayMs,e.maxRetryDelayMs)}function ft(e){return p(p({},e),{errorRetry:null,timeoutRetry:null})}function gt(e,t,a,r){return!!e&&t<e.maxNumRetry&&(mt(r)||!!a)}function mt(e){return 0===e&&!1===navigator.onLine||!!e&&(400>e||499<e)}function pt(e,t,a){if(null===t||!Array.isArray(e)||!e.length||!yr(t))return null;var r=e[0].programDateTime;if(t<(r||0))return null;var n=e[e.length-1].endProgramDateTime;if(t>=(n||0))return null;a=a||0;for(var i=0,d;i<e.length;++i)if(d=e[i],ht(t,a,d))return d;return null}function yt(e,t,a,r){void 0===a&&(a=0),void 0===r&&(r=0);var n=null;if(e?n=t[e.sn-t[0].sn+1]||null:0===a&&0===t[0].start&&(n=t[0]),n&&0===Tt(a,r,n))return n;var i=Dn.search(t,Tt.bind(null,a,r));return i&&(i!==e||!n)?i:n}function Tt(e,t,a){if(void 0===e&&(e=0),void 0===t&&(t=0),a.start<=e&&a.start+a.duration>e)return 0;var r=o(t,a.duration+(a.deltaPTS?a.deltaPTS:0));return a.start+a.duration-r<=e?1:a.start-r>e&&a.start?-1:0}function ht(e,t,a){var r=1e3*o(t,a.duration+(a.deltaPTS?a.deltaPTS:0)),n=a.endProgramDateTime||0;return n-r>e}function Et(e,t){return Dn.search(e,function(e){return e.cc<t?1:e.cc>t?-1:0})}function St(e,t,a){if(300000<performance.now()-e.lastErrorPerfMs)return!0;var r=e.details;if(t.details===Er.FRAG_GAP&&r&&t.frag){var n=t.frag.start,i=yt(null,r.fragments,n);if(i&&!i.gap)return!0}if(a&&e.errors.length<a.errors.length){var d=e.errors[e.errors.length-1];if(r&&d.frag&&t.frag&&s(d.frag.start-t.frag.start)>3*r.targetduration)return!0}return!1}function Lt(e,t,a){a&&("audio"===t?(!e.audioGroupIds&&(e.audioGroupIds=[]),e.audioGroupIds[e.url.length-1]=a):"text"==t&&(!e.textGroupIds&&(e.textGroupIds=[]),e.textGroupIds[e.url.length-1]=a))}function Rt(e){var t={};e.forEach(function(e){var a=e.groupId||"";e.id=t[a]=t[a]||0,t[a]++})}function At(e){var t,a,r;return e.buffered&&(e.body.gap||(null==(t=e.range.video)?void 0:t.partial)||(null==(a=e.range.audio)?void 0:a.partial)||(null==(r=e.range.audiovideo)?void 0:r.partial))}function vt(e){return e.type+"_"+e.level+"_"+e.urlId+"_"+e.sn}function It(e,t){void 0===t&&(t=null);var a=t||e,r={frag:e,part:t,responseType:"arraybuffer",url:a.url,headers:{},rangeStart:0,rangeEnd:0},n=a.byteRangeStartOffset,i=a.byteRangeEndOffset;if(yr(n)&&yr(i)){var d=n,o=i,s;if("initSegment"===e.sn&&"AES-128"===(null==(s=e.decryptdata)?void 0:s.method)){var l=i-n;l%16&&(o=i+(16-l%16)),0!==n&&(r.resetIV=!0,d=n-16)}r.rangeStart=d,r.rangeEnd=o}return r}function Dt(e,t){var a=new Error("GAP "+(e.gap?"tag":"attribute")+" found"),r={type:hr.MEDIA_ERROR,details:Er.FRAG_GAP,fatal:!1,frag:e,error:a,networkDetails:null};return t&&(r.part=t),(t?t:e).stats.aborted=!0,new Mn(r)}function kt(){return{start:0,executeStart:0,executeEnd:0,end:0}}function _t(e,t){for(var a=null,r=0,n=e.length,d;r<n;r++)if(d=e[r],d&&d.cc===t){a=d;break}return a}function bt(e,t,a){return!!(t.details&&(a.endCC>a.startCC||e&&e.cc<a.startCC))}function Ct(e,t,a){var r=e.fragments,n=t.fragments;if(!n.length||!r.length)return void Ar.log("No fragments to align");var i=_t(r,n[0].cc);return i&&(!i||i.startPTS)?i:void Ar.log("No frag in previous level to align on")}function Pt(e,t){if(e){var a=e.start+t;e.start=e.startPTS=a,e.endPTS=a+e.duration}}function xt(e,t){for(var a=t.fragments,r=0,n=a.length;r<n;r++)Pt(a[r],e);t.fragmentHint&&Pt(t.fragmentHint,e),t.alignedSliding=!0}function Ft(e,t,a){t&&(Ot(e,a,t),!a.alignedSliding&&t.details&&Nt(a,t.details),!a.alignedSliding&&t.details&&!a.skippedSegments&&rt(t.details,a))}function Ot(e,t,a){if(bt(e,a,t)){var r=Ct(a.details,t);r&&yr(r.start)&&(Ar.log("Adjusting PTS using last level due to CC increase within current level "+t.url),xt(r.start,t))}}function Nt(e,t){if(t.fragments.length&&e.hasProgramDateTime&&t.hasProgramDateTime){var a=t.fragments[0].programDateTime,r=e.fragments[0].programDateTime,n=(r-a)/1e3+t.fragments[0].start;n&&yr(n)&&(Ar.log("Adjusting PTS using programDateTime delta "+(r-a)+"ms, sliding:"+n.toFixed(3)+" "+e.url+" "),xt(n,e))}}function Mt(e,t){if(e.hasProgramDateTime&&t.hasProgramDateTime){var a=e.fragments,r=t.fragments;if(a.length&&r.length){var n=d(r.length/2)-1,i=r[n],o=_t(a,i.cc)||a[d(a.length/2)-1],s=i.programDateTime,l=o.programDateTime;if(null!==s&&null!==l){var u=(l-s)/1e3-(o.start-i.start);xt(u,e)}}}}function wt(e){var t=e.byteLength,a=t&&new DataView(e.buffer).getUint8(t-1);return a?X(e,0,t-a):e}function Bt(){return self.SourceBuffer||self.WebKitSourceBuffer}function Ut(){var e=_e();if(!e)return!1;var t=Bt(),a=e&&"function"==typeof e.isTypeSupported&&e.isTypeSupported("video/mp4; codecs=\"avc1.42E01E,mp4a.40.2\""),r=!t||t.prototype&&"function"==typeof t.prototype.appendBuffer&&"function"==typeof t.prototype.remove;return!!a&&!!r}function Gt(){var e=Bt(),t;return"function"==typeof(null==e||null==(t=e.prototype)?void 0:t.changeType)}function Kt(e,t){return void 0===e&&(e=""),void 0===t&&(t=9e4),{type:e,id:-1,pid:-1,inputTimeScale:t,sequenceNumber:-1,samples:[],dropped:0}}function Ht(e,t,a,r){var n=navigator.userAgent.toLowerCase(),i=r,d=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],o,s,l,u;o=((192&t[a+2])>>>6)+1;var c=(60&t[a+2])>>>2;return c>d.length-1?void e.trigger(Tr.ERROR,{type:hr.MEDIA_ERROR,details:Er.FRAG_PARSING_ERROR,fatal:!0,reason:"invalid ADTS sampling index:"+c}):(l=(1&t[a+2])<<2,l|=(192&t[a+3])>>>6,Ar.log("manifest codec:"+r+", ADTS type:"+o+", samplingIndex:"+c),/firefox/i.test(n)?6<=c?(o=5,u=[,,,,],s=c-3):(o=2,u=[,,],s=c):-1===n.indexOf("android")?(o=5,u=[,,,,],r&&(-1!==r.indexOf("mp4a.40.29")||-1!==r.indexOf("mp4a.40.5"))||!r&&6<=c?s=c-3:((r&&-1!==r.indexOf("mp4a.40.2")&&(6<=c&&1===l||/vivaldi/i.test(n))||!r&&1===l)&&(o=2,u=[,,]),s=c)):(o=2,u=[,,],s=c),u[0]=o<<3,u[0]|=(14&c)>>1,u[1]|=(1&c)<<7,u[1]|=l<<3,5===o&&(u[1]|=(14&s)>>1,u[2]=(1&s)<<7,u[2]|=8,u[3]=0),{config:u,samplerate:d[c],channelCount:l,codec:"mp4a.40."+o,manifestCodec:i})}function Vt(e,t){return 255===e[t]&&240==(246&e[t+1])}function Wt(e,t){return 1&e[t+1]?7:9}function Yt(e,t){return(3&e[t+3])<<11|e[t+4]<<3|(224&e[t+5])>>>5}function qt(e,t){return t+5<e.length}function zt(e,t){return t+1<e.length&&Vt(e,t)}function jt(e,t){return qt(e,t)&&Vt(e,t)&&Yt(e,t)<=e.length-t}function Xt(e,t){if(zt(e,t)){var a=Wt(e,t);if(t+a>=e.length)return!1;var r=Yt(e,t);if(r<=a)return!1;var n=t+r;return n===e.length||zt(e,n)}return!1}function Qt(e,t,a,r,n){if(!e.samplerate){var i=Ht(t,a,r,n);if(!i)return;e.config=i.config,e.samplerate=i.samplerate,e.channelCount=i.channelCount,e.codec=i.codec,e.manifestCodec=i.manifestCodec,Ar.log("parsed codec:"+e.codec+", rate:"+i.samplerate+", channels:"+i.channelCount)}}function Zt(e){return 92160000/e}function $t(e,t){var a=Wt(e,t);if(t+a<=e.length){var r=Yt(e,t)-a;if(0<r)return{headerLength:a,frameLength:r}}}function Jt(e,t,a,r,n){var i=Zt(e.samplerate),d=r+n*i,o=$t(t,a),s;if(o){var l=o.frameLength,u=o.headerLength,c=u+l,g=f(0,a+c-t.length);g?(s=new Uint8Array(c-u),s.set(t.subarray(a+u,t.length),0)):s=t.subarray(a+u,a+c);var m={unit:s,pts:d};return g||e.samples.push(m),{sample:m,length:c,missing:g}}var p=t.length-a;s=new Uint8Array(p),s.set(t.subarray(a,t.length),0);var y={unit:s,pts:d};return{sample:y,length:p,missing:-1}}function ea(e,t,a,r,n){if(!(a+24>t.length)){var i=ta(t,a);if(i&&a+i.frameLength<=t.length){var d=9e4*i.samplesPerFrame/i.sampleRate,o=r+n*d,s={unit:t.subarray(a,a+i.frameLength),pts:o,dts:o};return e.config=[],e.channelCount=i.channelCount,e.samplerate=i.sampleRate,e.samples.push(s),{sample:s,length:i.frameLength,missing:0}}}}function ta(e,t){var a=3&e[t+1]>>3,r=3&e[t+1]>>1,n=15&e[t+2]>>4,i=3&e[t+2]>>2;if(1!=a&&0!==n&&15!==n&&3!==i){var d=1&e[t+2]>>1,o=e[t+3]>>6,s=3===a?3-r:3===r?3:4,l=1e3*ti[14*s+n-1],c=3===a?0:2===a?1:2,f=ai[3*c+i],g=3===o?1:2,m=ri[a][r],p=ni[r],y=8*m*p,T=u(m*l/f+d)*p;if(null===ei){var h=navigator.userAgent||"",E=h.match(/Chrome\/(\d+)/i);ei=E?parseInt(E[1]):0}var S=!!ei&&87>=ei;return S&&2===r&&224e3<=l&&0===o&&(e[t+3]=128|e[t+3]),{sampleRate:f,channelCount:g,frameLength:T,samplesPerFrame:y}}}function aa(e,t){return 255===e[t]&&224==(224&e[t+1])&&0!=(6&e[t+1])}function ra(e,t){return t+1<e.length&&aa(e,t)}function na(e,t){var a=4;return aa(e,t)&&4<=e.length-t}function ia(e,t){if(t+1<e.length&&aa(e,t)){var a=4,r=ta(e,t),n=4;null!=r&&r.frameLength&&(n=r.frameLength);var i=t+n;return i===e.length||ra(e,i)}return!1}function da(e,t,a,r){return{key:e,frame:!1,pts:t,dts:a,units:[],debug:r,length:0}}function oa(e,t){return((31&e[t+1])<<8)+e[t+2]}function sa(e,t){return(31&e[t+10])<<8|e[t+11]}function la(e,t,a,r){var n={audio:-1,avc:-1,id3:-1,segmentCodec:"aac"},i=(15&e[t+1])<<8|e[t+2],d=t+3+i-4,o=(15&e[t+10])<<8|e[t+11];for(t+=12+o;t<d;){var s=oa(e,t);switch(e[t]){case 207:if(!r){Ar.log("ADTS AAC with AES-128-CBC frame encryption found in unencrypted stream");break}case 15:-1===n.audio&&(n.audio=s);break;case 21:-1===n.id3&&(n.id3=s);break;case 219:if(!r){Ar.log("H.264 with AES-128-CBC slice encryption found in unencrypted stream");break}case 27:-1===n.avc&&(n.avc=s);break;case 3:case 4:!0!==a.mpeg&&!0!==a.mp3?Ar.log("MPEG audio found, not supported in this browser"):-1===n.audio&&(n.audio=s,n.segmentCodec="mp3");break;case 36:Ar.warn("Unsupported HEVC stream type found")}t+=((15&e[t+3])<<8|e[t+4])+5}return n}function ua(e){var t=0,a=e.data,r,n,o,s,l;if(!e||0===e.size)return null;for(;19>a[0].length&&1<a.length;){var u=new Uint8Array(a[0].length+a[1].length);u.set(a[0]),u.set(a[1],a[0].length),a[0]=u,a.splice(1,1)}r=a[0];var c=(r[0]<<16)+(r[1]<<8)+r[2];if(1===c){if(n=(r[4]<<8)+r[5],n&&n>e.size-6)return null;var f=r[7];192&f&&(s=536870912*(14&r[9])+4194304*(255&r[10])+16384*(254&r[11])+128*(255&r[12])+(254&r[13])/2,64&f?(l=536870912*(14&r[14])+4194304*(255&r[15])+16384*(254&r[16])+128*(255&r[17])+(254&r[18])/2,5400000<s-l&&(Ar.warn(d((s-l)/9e4)+"s delta between PTS and DTS, align them"),s=l)):l=s),o=r[8];var g=o+9;if(e.size<=g)return null;e.size-=g;for(var m=new Uint8Array(e.size),p=0,y=a.length;p<y;p++){r=a[p];var T=r.byteLength;if(g)if(g>T){g-=T;continue}else r=r.subarray(g),T-=g,g=0;m.set(r,t),t+=T}return n&&(n-=o+3),{data:m,pts:s,dts:l,len:n}}return null}function ca(e,t){if(e.units.length&&e.frame){if(void 0===e.pts){var a=t.samples,r=a.length;if(r){var n=a[r-1];e.pts=n.pts,e.dts=n.dts}else return void t.dropped++}t.samples.push(e)}e.debug.length&&Ar.log(e.pts+"/"+e.dts+":"+e.debug)}function fa(e,t,a,r){void 0===a&&(a=1),void 0===r&&(r=!1);var n=e*t*a;return r?d(n):n}function ga(e,t,a,r){return void 0===a&&(a=1),void 0===r&&(r=!1),fa(e,t,1/a,r)}function ma(e,t){return void 0===t&&(t=!1),fa(e,1e3,1/90000,t)}function pa(e,t){return void 0===t&&(t=1),fa(e,90000,1/t)}function ya(e,t){var a;if(null===t)return e;for(a=t<e?-8589934592:8589934592;4294967296<s(e-t);)e+=a;return e}function Ta(e){for(var t=0;t<e.length;t++)if(e[t].key)return t;return-1}function ha(e,t,a,r){var n=e.samples.length;if(n){for(var i=e.inputTimeScale,d=0,o;d<n;d++)o=e.samples[d],o.pts=ya(o.pts-a.baseTime*i/a.timescale,t*i)/i,o.dts=ya(o.dts-r.baseTime*i/r.timescale,t*i)/i;var s=e.samples;return e.samples=[],{samples:s}}}function Ea(e,t,a){var r=e.samples.length;if(r){for(var n=e.inputTimeScale,i=0,d;i<r;i++)d=e.samples[i],d.pts=ya(d.pts-a.baseTime*n/a.timescale,t*n)/n;e.samples.sort(function(e,t){return e.pts-t.pts});var o=e.samples;return e.samples=[],{samples:o}}}function Sa(e,t,a,r){if(null===e)return!0;var n=f(r,1),i=t-e.baseTime/e.timescale;return s(i-a)>n}function La(e,t){var a=null==e?void 0:e.codec;return a&&4<a.length?a:"hvc1"===a||"hev1"===a?"hvc1.1.6.L120.90":"av01"===a?"av01.0.04M.08":"avc1"===a||t===br.VIDEO?"avc1.42e01e":"mp4a.40.5"}function Ra(e,t){var a=null;return 0<e.byteLength&&null!=t&&null!=t.key&&null!==t.iv&&null!=t.method&&(a=t),a}function Aa(e){return"then"in e&&e.then instanceof Function}function va(e,t){if(ka(t.remuxResult))return!1;var a=[],r=t.remuxResult,n=r.audio,i=r.video;return n&&Ia(a,n),i&&Ia(a,i),e.postMessage({event:"transmuxComplete",data:t},a),!0}function Ia(e,t){t.data1&&e.push(t.data1.buffer),t.data2&&e.push(t.data2.buffer)}function Da(e,t,a){var r=t.reduce(function(t,a){return va(e,a)||t},!1);r||e.postMessage({event:"transmuxComplete",data:t[0]}),e.postMessage({event:"flush",data:a})}function ka(e){return!e.audio&&!e.video&&!e.text&&!e.id3&&!e.initSegment}function _a(){return"function"==typeof t}function ba(){var e=new self.Blob(["var exports={};var module={exports:exports};function define(f){f()};define.amd=true;("+t.toString()+")(true);"],{type:"text/javascript"}),a=self.URL.createObjectURL(e),r=new self.Worker(a);return{worker:r,objectURL:a}}function Ca(e){var t=new self.URL(e,self.location.href).href,a=new self.Worker(t);return{worker:a,scriptURL:t}}function Pa(e,t){for(var a=new Uint8Array(t),r=0,n=0,d;n<e.length;n++)d=e[n],a.set(d,r),r+=d.length;return a}function xa(e,t){if(e.length!==t.length)return!1;for(var a=0;a<e.length;a++)if(!Fa(e[a].attrs,t[a].attrs))return!1;return!0}function Fa(e,t){var a=e["STABLE-RENDITION-ID"];return a?a===t["STABLE-RENDITION-ID"]:!["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED"].some(function(a){return e[a]!==t[a]})}function Oa(e){for(var t=[],a=0,r;a<e.length;a++)r=e[a],("subtitles"===r.kind||"captions"===r.kind)&&r.label&&t.push(e[a]);return t}function Na(e,t,a){a.a=e,a.b=t}function Ma(e,t,a){return a.a===e&&a.b===t}function wa(){return{a:null,b:null}}function Ba(e){function t(e,t,a,r){return 3600*(0|e)+60*(0|t)+(0|a)+parseFloat(r||0)}var a=e.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return a?59<parseFloat(a[2])?t(a[2],a[3],0,a[4]):t(a[1],a[2],a[3],a[4]):null}function Ua(e,t,a,r){var n=r?e.split(r):[e];for(var d in n)if("string"==typeof n[d]){var o=n[d].split(a);if(2===o.length){var s=o[0],l=o[1];t(s,l)}}}function Ga(e,t,a){function r(){var t=Ba(e);if(null===t)throw new Error("Malformed timestamp: "+d);return e=e.replace(/^[^\sa-zA-Z-]+/,""),t}function n(e,t){var r=new Td;Ua(e,function(e,t){var n;switch(e){case"region":for(var d=a.length-1;0<=d;d--)if(a[d].id===t){r.set(e,a[d].region);break}break;case"vertical":r.alt(e,t,["rl","lr"]);break;case"line":n=t.split(","),r.integer(e,n[0]),r.percent(e,n[0])&&r.set("snapToLines",!1),r.alt(e,n[0],["auto"]),2===n.length&&r.alt("lineAlign",n[1],["start",Ed,"end"]);break;case"position":n=t.split(","),r.percent(e,n[0]),2===n.length&&r.alt("positionAlign",n[1],["start",Ed,"end","line-left","line-right","auto"]);break;case"size":r.percent(e,t);break;case"align":r.alt(e,t,["start",Ed,"end","left","right"])}},/:/,/\s/),t.region=r.get("region",null),t.vertical=r.get("vertical","");var n=r.get("line","auto");"auto"===n&&-1===hd.line&&(n=-1),t.line=n,t.lineAlign=r.get("lineAlign","start"),t.snapToLines=r.get("snapToLines",!0),t.size=r.get("size",100),t.align=r.get("align",Ed);var i=r.get("position","auto");"auto"===i&&50===hd.position&&(i="start"===t.align||"left"===t.align?0:"end"===t.align||"right"===t.align?100:50),t.position=i}function i(){e=e.replace(/^\s+/,"")}var d=e;if(i(),t.startTime=r(),i(),"-->"!==e.slice(0,3))throw new Error("Malformed time stamp (time stamps must be separated by '-->'): "+d);e=e.slice(3),i(),t.endTime=r(),i(),n(e,t)}function Ka(e){return e.replace(/<br(?: \/)?>/gi,"\n")}function Ha(e,t,a){return vd(e.toString())+vd(t.toString())+vd(a)}function Va(e,t,a,r,n,i,d){var o=new Sd,s=$r(new Uint8Array(e)).trim().replace(Ld,"\n").split("\n"),l=[],u=t?pa(t.baseTime,t.timescale):0,c="00:00.000",g=0,m=0,p=!0,y;o.oncue=function(e){var i=a[r],d=a.ccOffset,o=(g-u)/9e4;if(null!=i&&i.new&&(void 0===m?Id(a,r,o):d=a.ccOffset=i.start),o){if(!t)return void(y=new Error("Missing initPTS for VTT MPEGTS"));d=o-a.presentationOffset}var s=e.endTime-e.startTime,c=ya(9e4*(e.startTime+d-m),9e4*n)/9e4;e.startTime=f(c,0),e.endTime=f(c+s,0);var p=e.text.trim();e.text=decodeURIComponent(encodeURIComponent(p)),e.id||(e.id=Ha(e.startTime,e.endTime,p)),0<e.endTime&&l.push(e)},o.onparsingerror=function(e){y=e},o.onflush=function(){return y?void d(y):void i(l)},s.forEach(function(e){if(p){if(Rd(e,"X-TIMESTAMP-MAP=")){p=!1,e.slice(16).split(",").forEach(function(e){Rd(e,"LOCAL:")?c=e.slice(6):Rd(e,"MPEGTS:")&&(g=parseInt(e.slice(7)))});try{m=Ad(c)/1e3}catch(e){y=e}return}""===e&&(p=!1)}o.parse(e+"\n")}),o.flush()}function Wa(e,t,a,r){var n=ae(new Uint8Array(e),["mdat"]);if(0===n.length)return void r(new Error("Could not parse IMSC1 mdat"));var i=n.map(function(e){return $r(e)}),d=ga(t.baseTime,1,t.timescale);try{i.forEach(function(e){return a(Ya(e,d))})}catch(e){r(e)}}function Ya(e,t){var a=new DOMParser,r=a.parseFromString(e,"text/xml"),n=r.getElementsByTagName("tt")[0];if(!n)throw new Error("Invalid ttml");var i={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},d=Object.keys(i).reduce(function(e,t){return e[t]=n.getAttribute("ttp:"+t)||i[t],e},{}),o="preserve"!==n.getAttribute("xml:space"),s=za(qa(n,"styling","style")),l=za(qa(n,"layout","region")),u=qa(n,"body","[begin]");return[].map.call(u,function(e){var a=ja(e,o);if(!a||!e.hasAttribute("begin"))return null;var r=$a(e.getAttribute("begin"),d),n=$a(e.getAttribute("dur"),d),i=$a(e.getAttribute("end"),d);if(null===r)throw Za(e);if(null===i){if(null===n)throw Za(e);i=r+n}var u=new pd(r-t,i-t,a);u.id=Ha(u.startTime,u.endTime,u.text);var c=l[e.getAttribute("region")],f=s[e.getAttribute("style")],g=Xa(c,f,s),m=g.textAlign;if(m){var p=bd[m];p&&(u.lineAlign=p),u.align=m}return E(u,g),u}).filter(function(e){return null!==e})}function qa(e,t,a){var r=e.getElementsByTagName(t)[0];return r?[].slice.call(r.querySelectorAll(a)):[]}function za(e){return e.reduce(function(e,t){var a=t.getAttribute("xml:id");return a&&(e[a]=t),e},{})}function ja(e,t){return[].slice.call(e.childNodes).reduce(function(e,a,r){var n;return"br"===a.nodeName&&r?e+"\n":null!=(n=a.childNodes)&&n.length?ja(a,t):t?e+a.textContent.trim().replace(/\s+/g," "):e+a.textContent},"")}function Xa(e,t,a){var r="http://www.w3.org/ns/ttml#styling",n=null,i=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"],d=null!=e&&e.hasAttribute("style")?e.getAttribute("style"):null;return d&&a.hasOwnProperty(d)&&(n=a[d]),i.reduce(function(a,r){var i=Qa(t,"http://www.w3.org/ns/ttml#styling",r)||Qa(e,"http://www.w3.org/ns/ttml#styling",r)||Qa(n,"http://www.w3.org/ns/ttml#styling",r);return i&&(a[r]=i),a},{})}function Qa(e,t,a){return e?e.hasAttributeNS(t,a)?e.getAttributeNS(t,a):null:null}function Za(e){return new Error("Could not parse ttml timestamp "+e)}function $a(e,t){if(!e)return null;var a=Ba(e);return null===a&&(kd.test(e)?a=Ja(e,t):_d.test(e)&&(a=er(e,t))),a}function Ja(e,t){var a=kd.exec(e),r=(0|a[4])+(0|a[5])/t.subFrameRate;return 3600*(0|a[1])+60*(0|a[2])+(0|a[3])+r/t.frameRate}function er(e,t){var a=_d.exec(e),r=+a[1],n=a[2];return"h"===n?3600*r:"m"===n?60*r:"ms"===n?1e3*r:"f"===n?r/t.frameRate:"t"===n?r/t.tickRate:r}function tr(e,t){return!!e&&e.label===t.name&&!(e.textTrack1||e.textTrack2)}function ar(e,t,a,r){return o(t,r)-f(e,a)}function rr(){return{ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}}}function nr(e,t,a,r){e&&Object.keys(t).forEach(function(n){var i=e.filter(function(e){return e.groupId===n}).map(function(e){var i=E({},e);return i.details=void 0,i.attrs=new Dr(i.attrs),i.url=i.attrs.URI=ir(e.url,e.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",a),i.groupId=i.attrs["GROUP-ID"]=t[n],i.attrs["PATHWAY-ID"]=r,i});e.push.apply(e,i)})}function ir(e,t,a,r){var n=r.HOST,i=r.PARAMS,d=r[a],o;t&&(o=null==d?void 0:d[t],o&&(e=o));var s=new self.URL(e);return n&&!o&&(s.host=n),i&&Object.keys(i).sort().forEach(function(e){e&&s.searchParams.set(e,i[e])}),s.href}function dr(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch(t){}return!1}function or(e,t){var a={method:"GET",mode:"cors",credentials:"same-origin",signal:t,headers:new self.Headers(E({},e.headers))};return e.rangeEnd&&a.headers.set("Range","bytes="+e.rangeStart+"-"+(e.rangeEnd-1+"")),a}function sr(e){var t=Kd.exec(e);if(t)return parseInt(t[2])-parseInt(t[1])+1}function lr(e){var t=e.get("Content-Range");if(t){var a=sr(t);if(yr(a))return a}var r=e.get("Content-Length");if(r)return parseInt(r)}function ur(e,t){return new self.Request(e.url,t)}function cr(e,t){if((t.liveSyncDurationCount||t.liveMaxLatencyDurationCount)&&(t.liveSyncDuration||t.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(void 0!==t.liveMaxLatencyDurationCount&&(void 0===t.liveSyncDurationCount||t.liveMaxLatencyDurationCount<=t.liveSyncDurationCount))throw new Error("Illegal hls.js config: \"liveMaxLatencyDurationCount\" must be greater than \"liveSyncDurationCount\"");if(void 0!==t.liveMaxLatencyDuration&&(void 0===t.liveSyncDuration||t.liveMaxLatencyDuration<=t.liveSyncDuration))throw new Error("Illegal hls.js config: \"liveMaxLatencyDuration\" must be greater than \"liveSyncDuration\"");var a=fr(e),r=["manifest","level","frag"],n=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return r.forEach(function(e){var r=("level"===e?"playlist":e)+"LoadPolicy",i=void 0===t[r],d=[];n.forEach(function(n){var o=e+"Loading"+n,s=t[o];if(void 0!==s&&i){d.push(o);var l=a[r].default;t[r]={default:l},"TimeOut"===n?(l.maxLoadTimeMs=s,l.maxTimeToFirstByteMs=s):"MaxRetry"===n?(l.errorRetry.maxNumRetry=s,l.timeoutRetry.maxNumRetry=s):"RetryDelay"===n?(l.errorRetry.retryDelayMs=s,l.timeoutRetry.retryDelayMs=s):"MaxRetryTimeout"===n?(l.errorRetry.maxRetryDelayMs=s,l.timeoutRetry.maxRetryDelayMs=s):void 0}}),d.length&&Ar.warn("hls.js config: \""+d.join("\", \"")+"\" setting(s) are deprecated, use \""+r+"\": "+JSON.stringify(t[r]))}),p(p({},a),t)}function fr(e){return e&&"object"==typeof e?Array.isArray(e)?e.map(fr):Object.keys(e).reduce(function(t,a){return t[a]=fr(e[a]),t},{}):e}function gr(e){var t=e.loader;if(t!==Hd&&t!==Gd)Ar.log("[config]: Custom loader detected, cannot enable progressive streaming"),e.progressive=!1;else{var a=dr();a&&(e.loader=Hd,e.progressive=!0,e.enableSoftwareAES=!0,Ar.log("[config]: Progressive streaming enabled, using FetchLoader"))}}var mr={exports:{}};(function(e,t){(function(t){var a=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,r=/^(?=([^\/?#]*))\1([^]*)$/,n=/(?:\/|^)\.(?=\/)/g,i=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,d={buildAbsoluteURL:function(e,t,a){if(a=a||{},e=e.trim(),t=t.trim(),!t){if(!a.alwaysNormalize)return e;var n=d.parseURL(e);if(!n)throw new Error("Error trying to parse base URL.");return n.path=d.normalizePath(n.path),d.buildURLFromParts(n)}var i=d.parseURL(t);if(!i)throw new Error("Error trying to parse relative URL.");if(i.scheme)return a.alwaysNormalize?(i.path=d.normalizePath(i.path),d.buildURLFromParts(i)):t;var o=d.parseURL(e);if(!o)throw new Error("Error trying to parse base URL.");if(!o.netLoc&&o.path&&"/"!==o.path[0]){var s=r.exec(o.path);o.netLoc=s[1],o.path=s[2]}o.netLoc&&!o.path&&(o.path="/");var l={scheme:o.scheme,netLoc:i.netLoc,path:null,params:i.params,query:i.query,fragment:i.fragment};if(!i.netLoc&&(l.netLoc=o.netLoc,"/"!==i.path[0]))if(!i.path)l.path=o.path,i.params||(l.params=o.params,!i.query&&(l.query=o.query));else{var u=o.path,c=u.substring(0,u.lastIndexOf("/")+1)+i.path;l.path=d.normalizePath(c)}return null===l.path&&(l.path=a.alwaysNormalize?d.normalizePath(i.path):i.path),d.buildURLFromParts(l)},parseURL:function(e){var t=a.exec(e);return t?{scheme:t[1]||"",netLoc:t[2]||"",path:t[3]||"",params:t[4]||"",query:t[5]||"",fragment:t[6]||""}:null},normalizePath:function(e){for(e=e.split("").reverse().join("").replace(n,"");e.length!==(e=e.replace(i,"")).length;);return e.split("").reverse().join("")},buildURLFromParts:function(e){return e.scheme+e.netLoc+e.path+e.params+e.query+e.fragment}};e.exports=d})()})(mr);var pr=mr.exports,yr=i||function(e){return"number"==typeof e&&isFinite(e)},Tr=function(e){return e.MEDIA_ATTACHING="hlsMediaAttaching",e.MEDIA_ATTACHED="hlsMediaAttached",e.MEDIA_DETACHING="hlsMediaDetaching",e.MEDIA_DETACHED="hlsMediaDetached",e.BUFFER_RESET="hlsBufferReset",e.BUFFER_CODECS="hlsBufferCodecs",e.BUFFER_CREATED="hlsBufferCreated",e.BUFFER_APPENDING="hlsBufferAppending",e.BUFFER_APPENDED="hlsBufferAppended",e.BUFFER_EOS="hlsBufferEos",e.BUFFER_FLUSHING="hlsBufferFlushing",e.BUFFER_FLUSHED="hlsBufferFlushed",e.MANIFEST_LOADING="hlsManifestLoading",e.MANIFEST_LOADED="hlsManifestLoaded",e.MANIFEST_PARSED="hlsManifestParsed",e.LEVEL_SWITCHING="hlsLevelSwitching",e.LEVEL_SWITCHED="hlsLevelSwitched",e.LEVEL_LOADING="hlsLevelLoading",e.LEVEL_LOADED="hlsLevelLoaded",e.LEVEL_UPDATED="hlsLevelUpdated",e.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",e.LEVELS_UPDATED="hlsLevelsUpdated",e.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",e.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",e.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",e.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",e.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",e.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",e.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",e.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",e.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",e.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",e.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",e.CUES_PARSED="hlsCuesParsed",e.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",e.INIT_PTS_FOUND="hlsInitPtsFound",e.FRAG_LOADING="hlsFragLoading",e.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",e.FRAG_LOADED="hlsFragLoaded",e.FRAG_DECRYPTED="hlsFragDecrypted",e.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",e.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",e.FRAG_PARSING_METADATA="hlsFragParsingMetadata",e.FRAG_PARSED="hlsFragParsed",e.FRAG_BUFFERED="hlsFragBuffered",e.FRAG_CHANGED="hlsFragChanged",e.FPS_DROP="hlsFpsDrop",e.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",e.ERROR="hlsError",e.DESTROYING="hlsDestroying",e.KEY_LOADING="hlsKeyLoading",e.KEY_LOADED="hlsKeyLoaded",e.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",e.BACK_BUFFER_REACHED="hlsBackBufferReached",e}({}),hr=function(e){return e.NETWORK_ERROR="networkError",e.MEDIA_ERROR="mediaError",e.KEY_SYSTEM_ERROR="keySystemError",e.MUX_ERROR="muxError",e.OTHER_ERROR="otherError",e}({}),Er=function(e){return e.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",e.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",e.KEY_SYSTEM_NO_SESSION="keySystemNoSession",e.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",e.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",e.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",e.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",e.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",e.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",e.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",e.MANIFEST_LOAD_ERROR="manifestLoadError",e.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",e.MANIFEST_PARSING_ERROR="manifestParsingError",e.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",e.LEVEL_EMPTY_ERROR="levelEmptyError",e.LEVEL_LOAD_ERROR="levelLoadError",e.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",e.LEVEL_PARSING_ERROR="levelParsingError",e.LEVEL_SWITCH_ERROR="levelSwitchError",e.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",e.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",e.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",e.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",e.FRAG_LOAD_ERROR="fragLoadError",e.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",e.FRAG_DECRYPT_ERROR="fragDecryptError",e.FRAG_PARSING_ERROR="fragParsingError",e.FRAG_GAP="fragGap",e.REMUX_ALLOC_ERROR="remuxAllocError",e.KEY_LOAD_ERROR="keyLoadError",e.KEY_LOAD_TIMEOUT="keyLoadTimeOut",e.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",e.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",e.BUFFER_APPEND_ERROR="bufferAppendError",e.BUFFER_APPENDING_ERROR="bufferAppendingError",e.BUFFER_STALLED_ERROR="bufferStalledError",e.BUFFER_FULL_ERROR="bufferFullError",e.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",e.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",e.INTERNAL_EXCEPTION="internalException",e.INTERNAL_ABORTED="aborted",e.UNKNOWN="unknown",e}({}),Sr=function e(){},Lr={trace:Sr,debug:Sr,log:Sr,warn:Sr,info:Sr,error:Sr},Rr=Lr,Ar=Rr,vr=/^(\d+)x(\d+)$/,Ir=/(.+?)=(".*?"|.*?)(?:,|$)/g,Dr=function(){function e(t){for(var a in"string"==typeof t&&(t=e.parseAttrList(t)),t)t.hasOwnProperty(a)&&("X-"===a.substring(0,2)&&(this.clientAttrs=this.clientAttrs||[],this.clientAttrs.push(a)),this[a]=t[a])}var t=e.prototype;return t.decimalInteger=function t(e){var a=parseInt(this[e],10);return a>l?1/0:a},t.hexadecimalInteger=function t(e){if(this[e]){var a=(this[e]||"0x").slice(2);a=(1&a.length?"0":"")+a;for(var r=new Uint8Array(a.length/2),n=0;n<a.length/2;n++)r[n]=parseInt(a.slice(2*n,2*n+2),16);return r}return null},t.hexadecimalIntegerAsNumber=function t(e){var a=parseInt(this[e],16);return a>l?1/0:a},t.decimalFloatingPoint=function t(e){return parseFloat(this[e])},t.optionalFloat=function a(e,t){var r=this[e];return r?parseFloat(r):t},t.enumeratedString=function t(e){return this[e]},t.bool=function t(e){return"YES"===this[e]},t.decimalResolution=function t(e){var a=vr.exec(this[e]);return null===a?void 0:{width:parseInt(a[1],10),height:parseInt(a[2],10)}},e.parseAttrList=function t(e){var a={},r="\"",n;for(Ir.lastIndex=0;null!==(n=Ir.exec(e));){var i=n[2];0===i.indexOf(r)&&i.lastIndexOf(r)===i.length-1&&(i=i.slice(1,-1));var d=n[1].trim();a[d]=i}return a},e}(),kr=function(){function e(e,t){if(this.attr=void 0,this._startDate=void 0,this._endDate=void 0,this._badValueForSameId=void 0,t){var a=t.attr;for(var r in a)if(Object.prototype.hasOwnProperty.call(e,r)&&e[r]!==a[r]){Ar.warn("DATERANGE tag attribute: \""+r+"\" does not match for tags with ID: \""+e.ID+"\""),this._badValueForSameId=r;break}e=E(new Dr({}),a,e)}if(this.attr=e,this._startDate=new Date(e["START-DATE"]),"END-DATE"in this.attr){var n=new Date(this.attr["END-DATE"]);yr(n.getTime())&&(this._endDate=n)}}return T(e,[{key:"id",get:function e(){return this.attr.ID}},{key:"class",get:function e(){return this.attr.CLASS}},{key:"startDate",get:function e(){return this._startDate}},{key:"endDate",get:function e(){if(this._endDate)return this._endDate;var t=this.duration;return null===t?null:new Date(this._startDate.getTime()+1e3*t)}},{key:"duration",get:function e(){if("DURATION"in this.attr){var t=this.attr.decimalFloatingPoint("DURATION");if(yr(t))return t}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}},{key:"plannedDuration",get:function e(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}},{key:"endOnNext",get:function e(){return this.attr.bool("END-ON-NEXT")}},{key:"isValid",get:function e(){return!!this.id&&!this._badValueForSameId&&yr(this.startDate.getTime())&&(null===this.duration||0<=this.duration)&&(!this.endOnNext||!!this.class)}}]),e}(),_r=function e(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}},br={AUDIO:"audio",VIDEO:"video",AUDIOVIDEO:"audiovideo"},Cr=function(){function e(e){var t;this._byteRange=null,this._url=null,this.baseurl=void 0,this.relurl=void 0,this.elementaryStreams=(t={},t[br.AUDIO]=null,t[br.VIDEO]=null,t[br.AUDIOVIDEO]=null,t),this.baseurl=e}var t=e.prototype;return t.setByteRange=function a(e,t){var r=e.split("@",2),n=[];n[0]=1===r.length?t?t.byteRangeEndOffset:0:parseInt(r[1]),n[1]=parseInt(r[0])+n[0],this._byteRange=n},T(e,[{key:"byteRange",get:function e(){return this._byteRange?this._byteRange:[]}},{key:"byteRangeStartOffset",get:function e(){return this.byteRange[0]}},{key:"byteRangeEndOffset",get:function e(){return this.byteRange[1]}},{key:"url",get:function e(){return!this._url&&this.baseurl&&this.relurl&&(this._url=pr.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""},set:function t(e){this._url=e}}]),e}(),Pr=function(e){function t(t,a){var r;return r=e.call(this,a)||this,r._decryptdata=null,r.rawProgramDateTime=null,r.programDateTime=null,r.tagList=[],r.duration=0,r.sn=0,r.levelkeys=void 0,r.type=void 0,r.loader=null,r.keyLoader=null,r.level=-1,r.cc=0,r.startPTS=void 0,r.endPTS=void 0,r.startDTS=void 0,r.endDTS=void 0,r.start=0,r.deltaPTS=void 0,r.maxStartPTS=void 0,r.minEndPTS=void 0,r.stats=new _r,r.urlId=0,r.data=void 0,r.bitrateTest=!1,r.title=null,r.initSegment=null,r.endList=void 0,r.gap=void 0,r.type=t,r}S(t,e);var a=t.prototype;return a.setKeyFormat=function t(e){if(this.levelkeys){var a=this.levelkeys[e];a&&!this._decryptdata&&(this._decryptdata=a.getDecryptData(this.sn))}},a.abortRequests=function e(){var t,a;null==(t=this.loader)?void 0:t.abort(),null==(a=this.keyLoader)?void 0:a.abort()},a.setElementaryStreamInfo=function d(e,t,a,r,n,i){void 0===i&&(i=!1);var s=this.elementaryStreams,l=s[e];return l?void(l.startPTS=o(l.startPTS,t),l.endPTS=f(l.endPTS,a),l.startDTS=o(l.startDTS,r),l.endDTS=f(l.endDTS,n)):void(s[e]={startPTS:t,endPTS:a,startDTS:r,endDTS:n,partial:i})},a.clearElementaryStreamInfo=function e(){var t=this.elementaryStreams;t[br.AUDIO]=null,t[br.VIDEO]=null,t[br.AUDIOVIDEO]=null},T(t,[{key:"decryptdata",get:function e(){var t=this.levelkeys;if(!t&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkeys&&!this.levelkeys.NONE){var a=this.levelkeys.identity;if(a)this._decryptdata=a.getDecryptData(this.sn);else{var r=Object.keys(this.levelkeys);if(1===r.length)return this._decryptdata=this.levelkeys[r[0]].getDecryptData(this.sn)}}return this._decryptdata}},{key:"end",get:function e(){return this.start+this.duration}},{key:"endProgramDateTime",get:function e(){if(null===this.programDateTime)return null;if(!yr(this.programDateTime))return null;var t=yr(this.duration)?this.duration:0;return this.programDateTime+1e3*t}},{key:"encrypted",get:function e(){var t;if(null!=(t=this._decryptdata)&&t.encrypted)return!0;if(this.levelkeys){var a=Object.keys(this.levelkeys),r=a.length;if(1<r||1===r&&this.levelkeys[a[0]].encrypted)return!0}return!1}}]),t}(Cr),xr=function(e){function t(t,a,r,n,i){var d;d=e.call(this,r)||this,d.fragOffset=0,d.duration=0,d.gap=!1,d.independent=!1,d.relurl=void 0,d.fragment=void 0,d.index=void 0,d.stats=new _r,d.duration=t.decimalFloatingPoint("DURATION"),d.gap=t.bool("GAP"),d.independent=t.bool("INDEPENDENT"),d.relurl=t.enumeratedString("URI"),d.fragment=a,d.index=n;var o=t.enumeratedString("BYTERANGE");return o&&d.setByteRange(o,i),i&&(d.fragOffset=i.fragOffset+i.duration),d}return S(t,e),T(t,[{key:"start",get:function e(){return this.fragment.start+this.fragOffset}},{key:"end",get:function e(){return this.start+this.duration}},{key:"loaded",get:function e(){var t=this.elementaryStreams;return!!(t.audio||t.video||t.audiovideo)}}]),t}(Cr),Fr=function(){function e(e){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.live=!0,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.availabilityDelay=void 0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=e}var t=e.prototype;return t.reloaded=function t(e){if(!e)return this.advanced=!0,void(this.updated=!0);var a=this.lastPartSn-e.lastPartSn,r=this.lastPartIndex-e.lastPartIndex;this.updated=this.endSN!==e.endSN||!!r||!!a||!this.live,this.advanced=this.endSN>e.endSN||0<a||0===a&&0<r,this.misses=this.updated||this.advanced?u(.6*e.misses):e.misses+1,this.availabilityDelay=e.availabilityDelay},T(e,[{key:"hasProgramDateTime",get:function e(){return!!this.fragments.length&&yr(this.fragments[this.fragments.length-1].programDateTime)}},{key:"levelTargetDuration",get:function e(){return this.averagetargetduration||this.targetduration||10}},{key:"drift",get:function e(){var t=this.driftEndTime-this.driftStartTime;if(0<t){var a=this.driftEnd-this.driftStart;return 1e3*a/t}return 1}},{key:"edge",get:function e(){return this.partEnd||this.fragmentEnd}},{key:"partEnd",get:function e(){var t;return null!=(t=this.partList)&&t.length?this.partList[this.partList.length-1].end:this.fragmentEnd}},{key:"fragmentEnd",get:function e(){var t;return null!=(t=this.fragments)&&t.length?this.fragments[this.fragments.length-1].end:0}},{key:"age",get:function e(){return this.advancedDateTime?f(Date.now()-this.advancedDateTime,0)/1e3:0}},{key:"lastPartIndex",get:function e(){var t;return null!=(t=this.partList)&&t.length?this.partList[this.partList.length-1].index:-1}},{key:"lastPartSn",get:function e(){var t;return null!=(t=this.partList)&&t.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}}]),e}(),Or={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},Nr={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.streamingkeydelivery",PLAYREADY:"com.microsoft.playready",WIDEVINE:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"},Mr={WIDEVINE:"edef8ba979d64acea3c827dcd51d21ed"},wr=function(){return"undefined"!=typeof self&&self.navigator&&self.navigator.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null}(),Br=function a(e,t){return!!(t+10<=e.length&&73===e[t]&&68===e[t+1]&&51===e[t+2]&&255>e[t+3]&&255>e[t+4]&&128>e[t+6]&&128>e[t+7]&&128>e[t+8]&&128>e[t+9])},Ur=function a(e,t){return!!(t+10<=e.length&&51===e[t]&&68===e[t+1]&&73===e[t+2]&&255>e[t+3]&&255>e[t+4]&&128>e[t+6]&&128>e[t+7]&&128>e[t+8]&&128>e[t+9])},Gr=function a(e,t){for(var r=t,n=0;Br(e,t);){n+=10;var i=Kr(e,t+6);n+=i,Ur(e,t+10)&&(n+=10),t+=n}return 0<n?e.subarray(r,r+n):void 0},Kr=function a(e,t){var r=0;return r=(127&e[t])<<21,r|=(127&e[t+1])<<14,r|=(127&e[t+2])<<7,r|=127&e[t+3],r},Hr=function a(e,t){return Br(e,t)&&Kr(e,t+6)+10<=e.length-t},Vr=function t(e){for(var a=qr(e),r=0,n;r<a.length;r++)if(n=a[r],Wr(n))return Zr(n)},Wr=function t(e){return e&&"PRIV"===e.key&&"com.apple.streaming.transportStreamTimestamp"===e.info},Yr=function t(e){var a=g(e[0],e[1],e[2],e[3]),r=Kr(e,4),n=10;return{type:a,size:r,data:e.subarray(n,n+r)}},qr=function t(e){for(var a=0,r=[],n;Br(e,a);){n=Kr(e,a+6),a+=10;for(var i=a+n;a+8<i;){var d=Yr(e.subarray(a)),o=zr(d);o&&r.push(o),a+=d.size+10}Ur(e,a)&&(a+=10)}return r},zr=function t(e){return"PRIV"===e.type?jr(e):"W"===e.type[0]?Qr(e):Xr(e)},jr=function t(e){if(!(2>e.size)){var a=$r(e.data,!0),r=new Uint8Array(e.data.subarray(a.length+1));return{key:e.type,info:a,data:r.buffer}}},Xr=function t(e){if(!(2>e.size)){if("TXXX"===e.type){var a=1,r=$r(e.data.subarray(a),!0);a+=r.length+1;var n=$r(e.data.subarray(a));return{key:e.type,info:r,data:n}}var i=$r(e.data.subarray(1));return{key:e.type,data:i}}},Qr=function t(e){if("WXXX"===e.type){if(2>e.size)return;var a=1,r=$r(e.data.subarray(a),!0);a+=r.length+1;var n=$r(e.data.subarray(a));return{key:e.type,info:r,data:n}}var i=$r(e.data);return{key:e.type,data:i}},Zr=function t(e){if(8===e.data.byteLength){var a=new Uint8Array(e.data),r=1&a[3],n=(a[4]<<23)+(a[5]<<15)+(a[6]<<7)+a[7];return n/=45,r&&(n+=47721858.84),d(n)}},$r=function a(e,t){void 0===t&&(t=!1);var r=Q();if(r){var n=r.decode(e);if(t){var d=n.indexOf("\0");return-1===d?n:n.substring(0,d)}return n.replace(/\0/g,"")}for(var o=e.length,s="",l=0,u,f,m;l<o;){if(u=e[l++],0===u&&t)return s;if(0!==u&&3!==u)switch(u>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:s+=g(u);break;case 12:case 13:f=e[l++],s+=g((31&u)<<6|63&f);break;case 14:f=e[l++],m=e[l++],s+=g((15&u)<<12|(63&f)<<6|(63&m)<<0)}}return s},Jr={hexDump:function t(e){for(var a="",r=0,n;r<e.length;r++)n=e[r].toString(16),2>n.length&&(n="0"+n),a+=n;return a}},en=c(2,32)-1,tn=[].push,an={video:1,audio:2,id3:3,text:4},rn={},nn=function(){function e(e,t,a,r,n){void 0===r&&(r=[1]),void 0===n&&(n=null),this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=e,this.uri=t,this.keyFormat=a,this.keyFormatVersions=r,this.iv=n,this.encrypted=!!e&&"NONE"!==e,this.isCommonEncryption=this.encrypted&&"AES-128"!==e}e.clearKeyUriToKeyIdMap=function e(){rn={}};var t=e.prototype;return t.isSupported=function e(){if(this.method){if("AES-128"===this.method||"NONE"===this.method)return!0;if("identity"===this.keyFormat)return"SAMPLE-AES"===this.method;switch(this.keyFormat){case Nr.FAIRPLAY:case Nr.WIDEVINE:case Nr.PLAYREADY:case Nr.CLEARKEY:return-1!==["ISO-23001-7","SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)}}return!1},t.getDecryptData=function a(t){if(!this.encrypted||!this.uri)return null;if("AES-128"===this.method&&this.uri&&!this.iv){"number"!=typeof t&&("AES-128"===this.method&&!this.iv&&Ar.warn("missing IV for initialization segment with method=\""+this.method+"\" - compliance issue"),t=0);var r=Re(t),n=new e(this.method,this.uri,"identity",this.keyFormatVersions,r);return n}var i=K(this.uri);if(i)switch(this.keyFormat){case Nr.WIDEVINE:this.pssh=i,22<=i.length&&(this.keyId=i.subarray(i.length-22,i.length-6));break;case Nr.PLAYREADY:{var d=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=Se(d,null,i);var o=new Uint16Array(i.buffer,i.byteOffset,i.byteLength/2),s=g.apply(null,Array.from(o)),u=s.substring(s.indexOf("<"),s.length),c=new DOMParser,f=c.parseFromString(u,"text/xml"),m=f.getElementsByTagName("KID")[0];if(m){var p=m.childNodes[0]?m.childNodes[0].nodeValue:m.getAttribute("VALUE");if(p){var y=B(p).subarray(0,16);G(y),this.keyId=y}}break}default:{var T=i.subarray(0,16);if(16!==T.length){var h=new Uint8Array(16);h.set(T,16-T.length),T=h}this.keyId=T;break}}if(!this.keyId||16!==this.keyId.byteLength){var E=rn[this.uri];if(!E){var S=Object.keys(rn).length%l;E=new Uint8Array(16);var L=new DataView(E.buffer,12,4);L.setUint32(0,S),rn[this.uri]=E}this.keyId=E}return this},e}(),dn=/\{\$([a-zA-Z0-9-_]+)\}/g,on={audio:{a3ds:!0,"ac-3":!0,"ac-4":!0,alac:!0,alaw:!0,dra1:!0,"dts+":!0,"dts-":!0,dtsc:!0,dtse:!0,dtsh:!0,"ec-3":!0,enca:!0,g719:!0,g726:!0,m4ae:!0,mha1:!0,mha2:!0,mhm1:!0,mhm2:!0,mlpa:!0,mp4a:!0,"raw ":!0,Opus:!0,opus:!0,samr:!0,sawb:!0,sawp:!0,sevc:!0,sqcp:!0,ssmv:!0,twos:!0,ulaw:!0},video:{avc1:!0,avc2:!0,avc3:!0,avc4:!0,avcp:!0,av01:!0,drac:!0,dva1:!0,dvav:!0,dvh1:!0,dvhe:!0,encv:!0,hev1:!0,hvc1:!0,mjp2:!0,mp4v:!0,mvc1:!0,mvc2:!0,mvc3:!0,mvc4:!0,resv:!0,rv60:!0,s263:!0,svc1:!0,svc2:!0,"vc-1":!0,vp08:!0,vp09:!0},text:{stpp:!0,wvtt:!0}},sn=_e(),ln=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,un=/#EXT-X-MEDIA:(.*)/g,cn=/^#EXT(?:INF|-X-TARGETDURATION):/m,fn=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[\S ]*)/.source,/#EXT-X-BYTERANGE:*(.+)/.source,/#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/#.*/.source].join("|"),"g"),gn=new RegExp([/#(EXTM3U)/.source,/#EXT-X-(DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|")),mn=function(){function e(){}return e.findGroup=function a(e,t){for(var r=0,n;r<e.length;r++)if(n=e[r],n.id===t)return n},e.convertAVC1ToAVCOTI=function t(e){var a=e.split(".");if(2<a.length){var r=a.shift()+".";return r+=parseInt(a.shift()).toString(16),r+=("000"+parseInt(a.shift()).toString(16)).slice(-4),r}return e},e.resolve=function a(e,t){return pr.buildAbsoluteURL(t,e,{alwaysNormalize:!0})},e.isMediaPlaylist=function t(e){return cn.test(e)},e.parseMasterPlaylist=function r(t,a){var n=Ae(t),i={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:n},d=[];ln.lastIndex=0;for(var o;null!=(o=ln.exec(t));)if(o[1]){var s=new Dr(o[1]),l;ve(i,s,["CODECS","SUPPLEMENTAL-CODECS","ALLOWED-CPC","PATHWAY-ID","STABLE-VARIANT-ID","AUDIO","VIDEO","SUBTITLES","CLOSED-CAPTIONS","NAME"]);var u=Ie(i,o[2]),c={attrs:s,bitrate:s.decimalInteger("AVERAGE-BANDWIDTH")||s.decimalInteger("BANDWIDTH"),name:s.NAME,url:e.resolve(u,a)},f=s.decimalResolution("RESOLUTION");f&&(c.width=f.width,c.height=f.height),Fe((s.CODECS||"").split(/[ ,]+/).filter(function(e){return e}),c),c.videoCodec&&-1!==c.videoCodec.indexOf("avc1")&&(c.videoCodec=e.convertAVC1ToAVCOTI(c.videoCodec)),null!=(l=c.unknownCodecs)&&l.length||d.push(c),i.levels.push(c)}else if(o[3]){var g=o[3],m=o[4];switch(g){case"SESSION-DATA":{var p=new Dr(m);ve(i,p,["DATA-ID","LANGUAGE","VALUE","URI"]);var y=p["DATA-ID"];y&&(null===i.sessionData&&(i.sessionData={}),i.sessionData[y]=p);break}case"SESSION-KEY":{var T=Pe(m,a,i);T.encrypted&&T.isSupported()?(null===i.sessionKeys&&(i.sessionKeys=[]),i.sessionKeys.push(T)):Ar.warn("[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: \""+m+"\"");break}case"DEFINE":{{var h=new Dr(m);ve(i,h,["NAME","VALUE","QUERYPARAM"]),De(i,h,a)}break}case"CONTENT-STEERING":{var E=new Dr(m);ve(i,E,["SERVER-URI","PATHWAY-ID"]),i.contentSteering={uri:e.resolve(E["SERVER-URI"],a),pathwayId:E["PATHWAY-ID"]||"."};break}case"START":{i.startTimeOffset=xe(m);break}}}var S=0<d.length&&d.length<i.levels.length;return i.levels=S?d:i.levels,0===i.levels.length&&(i.playlistParsingError=new Error("no levels found in manifest")),i},e.parseMasterPlaylistMedia=function n(t,a,r){var i={},d=r.levels,o={AUDIO:d.map(function(e){return{id:e.attrs.AUDIO,audioCodec:e.audioCodec}}),SUBTITLES:d.map(function(e){return{id:e.attrs.SUBTITLES,textCodec:e.textCodec}}),"CLOSED-CAPTIONS":[]},s=0,l;for(un.lastIndex=0;null!==(l=un.exec(t));){var u=new Dr(l[1]),c=u.TYPE;if(c){var f=o[c],g=i[c]||[];i[c]=g,ve(r,u,["URI","GROUP-ID","LANGUAGE","ASSOC-LANGUAGE","STABLE-RENDITION-ID","NAME","INSTREAM-ID","CHARACTERISTICS","CHANNELS"]);var m={attrs:u,bitrate:0,id:s++,groupId:u["GROUP-ID"]||"",instreamId:u["INSTREAM-ID"],name:u.NAME||u.LANGUAGE||"",type:c,default:u.bool("DEFAULT"),autoselect:u.bool("AUTOSELECT"),forced:u.bool("FORCED"),lang:u.LANGUAGE,url:u.URI?e.resolve(u.URI,a):""};if(null!=f&&f.length){var p=e.findGroup(f,m.groupId)||f[0];Oe(m,p,"audioCodec"),Oe(m,p,"textCodec")}g.push(m)}}return i},e.parseLevelPlaylist=function o(e,t,a,r,n,d){var s=new Fr(t),l=s.fragments,u=null,c=0,g=0,m=0,p=0,y=null,T=new Pr(r,t),h=-1,S=!1,L,R,A;for(fn.lastIndex=0,s.m3u8=e,s.hasVariableRefs=Ae(e);null!==(L=fn.exec(e));){S&&(S=!1,T=new Pr(r,t),T.start=m,T.sn=c,T.cc=p,T.level=a,u&&(T.initSegment=u,T.rawProgramDateTime=u.rawProgramDateTime,u.rawProgramDateTime=null));var v=L[1];if(v){T.duration=parseFloat(v);var I=(" "+L[2]).slice(1);T.title=I||null,T.tagList.push(I?["INF",v,I]:["INF",v])}else if(L[3]){if(yr(T.duration)){T.start=m,A&&Be(T,A,s),T.sn=c,T.level=a,T.cc=p,T.urlId=n,l.push(T);var D=(" "+L[3]).slice(1);T.relurl=Ie(s,D),Me(T,y),y=T,m+=T.duration,c++,g=0,S=!0}}else if(L[4]){var k=(" "+L[4]).slice(1);y?T.setByteRange(k,y):T.setByteRange(k)}else if(L[5])T.rawProgramDateTime=(" "+L[5]).slice(1),T.tagList.push(["PROGRAM-DATE-TIME",T.rawProgramDateTime]),-1===h&&(h=l.length);else{if(L=L[0].match(gn),!L){Ar.warn("No matches on slow regex match for level playlist!");continue}for(R=1;R<L.length&&"undefined"==typeof L[R];R++);var _=(" "+L[R]).slice(1),b=(" "+L[R+1]).slice(1),C=L[R+2]?(" "+L[R+2]).slice(1):"";switch(_){case"PLAYLIST-TYPE":s.type=b.toUpperCase();break;case"MEDIA-SEQUENCE":c=s.startSN=parseInt(b);break;case"SKIP":{var P=new Dr(b);ve(s,P,["RECENTLY-REMOVED-DATERANGES"]);var x=P.decimalInteger("SKIPPED-SEGMENTS");if(yr(x)){s.skippedSegments=x;for(var F=x;F--;)l.unshift(null);c+=x}var O=P.enumeratedString("RECENTLY-REMOVED-DATERANGES");O&&(s.recentlyRemovedDateranges=O.split("\t"));break}case"TARGETDURATION":s.targetduration=f(parseInt(b),1);break;case"VERSION":s.version=parseInt(b);break;case"EXTM3U":break;case"ENDLIST":s.live=!1;break;case"#":(b||C)&&T.tagList.push(C?[b,C]:[b]);break;case"DISCONTINUITY":p++,T.tagList.push(["DIS"]);break;case"GAP":T.gap=!0,T.tagList.push([_]);break;case"BITRATE":T.tagList.push([_,b]);break;case"DATERANGE":{var N=new Dr(b);ve(s,N,["ID","CLASS","START-DATE","END-DATE","SCTE35-CMD","SCTE35-OUT","SCTE35-IN"]),ve(s,N,N.clientAttrs);var M=new kr(N,s.dateRanges[N.ID]);M.isValid||s.skippedSegments?s.dateRanges[M.id]=M:Ar.warn("Ignoring invalid DATERANGE tag: \""+b+"\""),T.tagList.push(["EXT-X-DATERANGE",b]);break}case"DEFINE":{{var w=new Dr(b);ve(s,w,["NAME","VALUE","IMPORT","QUERYPARAM"]),"IMPORT"in w?ke(s,w,d):De(s,w,t)}break}case"DISCONTINUITY-SEQUENCE":p=parseInt(b);break;case"KEY":{var B=Pe(b,t,s);if(B.isSupported()){if("NONE"===B.method){A=void 0;break}A||(A={}),A[B.keyFormat]&&(A=E({},A)),A[B.keyFormat]=B}else Ar.warn("[Keys] Ignoring invalid EXT-X-KEY tag: \""+b+"\"");break}case"START":s.startTimeOffset=xe(b);break;case"MAP":{var U=new Dr(b);if(ve(s,U,["BYTERANGE","URI"]),T.duration){var G=new Pr(r,t);we(G,U,a,A),u=G,T.initSegment=u,u.rawProgramDateTime&&!T.rawProgramDateTime&&(T.rawProgramDateTime=u.rawProgramDateTime)}else we(T,U,a,A),u=T,S=!0;break}case"SERVER-CONTROL":{var K=new Dr(b);s.canBlockReload=K.bool("CAN-BLOCK-RELOAD"),s.canSkipUntil=K.optionalFloat("CAN-SKIP-UNTIL",0),s.canSkipDateRanges=0<s.canSkipUntil&&K.bool("CAN-SKIP-DATERANGES"),s.partHoldBack=K.optionalFloat("PART-HOLD-BACK",0),s.holdBack=K.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{var H=new Dr(b);s.partTarget=H.decimalFloatingPoint("PART-TARGET");break}case"PART":{var V=s.partList;V||(V=s.partList=[]);var W=0<g?V[V.length-1]:void 0,Y=g++,q=new Dr(b);ve(s,q,["BYTERANGE","URI"]);var z=new xr(q,T,t,Y,W);V.push(z),T.duration+=z.duration;break}case"PRELOAD-HINT":{var j=new Dr(b);ve(s,j,["URI"]),s.preloadHint=j;break}case"RENDITION-REPORT":{var X=new Dr(b);ve(s,X,["URI"]),s.renditionReports=s.renditionReports||[],s.renditionReports.push(X);break}default:Ar.warn("line parsed but not handled: "+L)}}}y&&!y.relurl?(l.pop(),m-=y.duration,s.partList&&(s.fragmentHint=y)):s.partList&&(Me(T,y),T.cc=p,s.fragmentHint=T,A&&Be(T,A,s));var Q=l.length,Z=l[0],$=l[Q-1];if(m+=s.skippedSegments*s.targetduration,0<m&&Q&&$){s.averagetargetduration=m/Q;var J=$.sn;s.endSN="initSegment"===J?0:J,s.live||($.endList=!0),Z&&(s.startCC=Z.cc)}else s.endSN=0,s.startCC=0;return s.fragmentHint&&(m+=s.fragmentHint.duration),s.totalduration=m,s.endCC=p,0<h&&Ne(l,h),s},e}(),pn={MANIFEST:"manifest",LEVEL:"level",AUDIO_TRACK:"audioTrack",SUBTITLE_TRACK:"subtitleTrack"},yn={MAIN:"main",AUDIO:"audio",SUBTITLE:"subtitle"},Tn=function(){function e(e){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.hls=e,this.registerListeners()}var t=e.prototype;return t.startLoad=function t(e){},t.stopLoad=function e(){this.destroyInternalLoaders()},t.registerListeners=function e(){var t=this.hls;t.on(Tr.MANIFEST_LOADING,this.onManifestLoading,this),t.on(Tr.LEVEL_LOADING,this.onLevelLoading,this),t.on(Tr.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),t.on(Tr.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)},t.unregisterListeners=function e(){var t=this.hls;t.off(Tr.MANIFEST_LOADING,this.onManifestLoading,this),t.off(Tr.LEVEL_LOADING,this.onLevelLoading,this),t.off(Tr.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),t.off(Tr.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)},t.createInternalLoader=function t(e){var a=this.hls.config,r=a.pLoader,n=a.loader,i=r||n,d=new i(a);return this.loaders[e.type]=d,d},t.getInternalLoader=function t(e){return this.loaders[e.type]},t.resetInternalLoader=function t(e){this.loaders[e]&&delete this.loaders[e]},t.destroyInternalLoaders=function e(){for(var t in this.loaders){var a=this.loaders[t];a&&a.destroy(),this.resetInternalLoader(t)}},t.destroy=function e(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()},t.onManifestLoading=function a(e,t){var r=t.url;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:pn.MANIFEST,url:r,deliveryDirectives:null})},t.onLevelLoading=function a(e,t){var r=t.id,n=t.level,i=t.url,d=t.deliveryDirectives;this.load({id:r,level:n,responseType:"text",type:pn.LEVEL,url:i,deliveryDirectives:d})},t.onAudioTrackLoading=function a(e,t){var r=t.id,n=t.groupId,i=t.url,d=t.deliveryDirectives;this.load({id:r,groupId:n,level:null,responseType:"text",type:pn.AUDIO_TRACK,url:i,deliveryDirectives:d})},t.onSubtitleTrackLoading=function a(e,t){var r=t.id,n=t.groupId,i=t.url,d=t.deliveryDirectives;this.load({id:r,groupId:n,level:null,responseType:"text",type:pn.SUBTITLE_TRACK,url:i,deliveryDirectives:d})},t.load=function t(e){var a=this,r=this.hls.config,n=this.getInternalLoader(e),i;if(n){var d=n.context;if(d&&d.url===e.url)return void Ar.trace("[playlist-loader]: playlist request ongoing");Ar.log("[playlist-loader]: aborting previous loader for type: "+e.type),n.abort()}var s;if(s=e.type===pn.MANIFEST?r.manifestLoadPolicy.default:E({},r.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),n=this.createInternalLoader(e),null!=(i=e.deliveryDirectives)&&i.part){var l;if(e.type===pn.LEVEL&&null!==e.level?l=this.hls.levels[e.level].details:e.type===pn.AUDIO_TRACK&&null!==e.id?l=this.hls.audioTracks[e.id].details:e.type===pn.SUBTITLE_TRACK&&null!==e.id&&(l=this.hls.subtitleTracks[e.id].details),l){var u=l.partTarget,c=l.targetduration;if(u&&c){var g=1e3*f(3*u,.8*c);s=E({},s,{maxTimeToFirstByteMs:o(g,s.maxTimeToFirstByteMs),maxLoadTimeMs:o(g,s.maxTimeToFirstByteMs)})}}}var m=s.errorRetry||s.timeoutRetry||{},p={loadPolicy:s,timeout:s.maxLoadTimeMs,maxRetry:m.maxNumRetry||0,retryDelay:m.retryDelayMs||0,maxRetryDelay:m.maxRetryDelayMs||0},y={onSuccess:function i(e,t,r,n){var d=a.getInternalLoader(r);a.resetInternalLoader(r.type);var o=e.data;return 0===o.indexOf("#EXTM3U")?void(t.parsing.start=performance.now(),mn.isMediaPlaylist(o)?a.handleTrackOrLevelPlaylist(e,t,r,n||null,d):a.handleMasterPlaylist(e,t,r,n)):void a.handleManifestParsingError(e,r,new Error("no EXTM3U delimiter"),n||null,t)},onError:function i(e,t,r,n){a.handleNetworkError(t,r,!1,e,n)},onTimeout:function n(e,t,r){a.handleNetworkError(t,r,!0,void 0,e)}};n.load(e,p,y)},t.handleMasterPlaylist=function n(e,t,a,r){var i=this.hls,d=e.data,o=Ge(e,a),s=mn.parseMasterPlaylist(d,o);if(s.playlistParsingError)return void this.handleManifestParsingError(e,a,s.playlistParsingError,r,t);var l=s.contentSteering,u=s.levels,c=s.sessionData,f=s.sessionKeys,g=s.startTimeOffset,m=s.variableList;this.variableList=m;var p=mn.parseMasterPlaylistMedia(d,o,s),y=p.AUDIO,T=void 0===y?[]:y,h=p.SUBTITLES,E=p["CLOSED-CAPTIONS"];if(T.length){var S=T.some(function(e){return!e.url});S||!u[0].audioCodec||u[0].attrs.AUDIO||(Ar.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),T.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new Dr({}),bitrate:0,url:""}))}i.trigger(Tr.MANIFEST_LOADED,{levels:u,audioTracks:T,subtitles:h,captions:E,contentSteering:l,url:o,stats:t,networkDetails:r,sessionData:c,sessionKeys:f,startTimeOffset:g,variableList:m})},t.handleTrackOrLevelPlaylist=function i(e,t,a,r,n){var d=this.hls,o=a.id,s=a.level,l=a.type,u=Ge(e,a),c=yr(o)?o:0,f=yr(s)?s:c,g=Ue(a),m=mn.parseLevelPlaylist(e.data,u,f,g,c,this.variableList);if(l===pn.MANIFEST){var p={attrs:new Dr({}),bitrate:0,details:m,name:"",url:u};d.trigger(Tr.MANIFEST_LOADED,{levels:[p],audioTracks:[],url:u,stats:t,networkDetails:r,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}t.parsing.end=performance.now(),a.levelDetails=m,this.handlePlaylistLoaded(m,e,t,a,r,n)},t.handleManifestParsingError=function i(e,t,a,r,n){this.hls.trigger(Tr.ERROR,{type:hr.NETWORK_ERROR,details:Er.MANIFEST_PARSING_ERROR,fatal:t.type===pn.MANIFEST,url:e.url,err:a,error:a,reason:a.message,response:e,context:t,networkDetails:r,stats:n})},t.handleNetworkError=function i(e,t,a,r,n){void 0===a&&(a=!1);var d="A network "+(a?"timeout":"error"+(r?" (status "+r.code+")":""))+" occurred while loading "+e.type;e.type===pn.LEVEL?d+=": "+e.level+" id: "+e.id:(e.type===pn.AUDIO_TRACK||e.type===pn.SUBTITLE_TRACK)&&(d+=" id: "+e.id+" group-id: \""+e.groupId+"\"");var o=new Error(d);Ar.warn("[playlist-loader]: "+d);var s=Er.UNKNOWN,l=!1,u=this.getInternalLoader(e);switch(e.type){case pn.MANIFEST:s=a?Er.MANIFEST_LOAD_TIMEOUT:Er.MANIFEST_LOAD_ERROR,l=!0;break;case pn.LEVEL:s=a?Er.LEVEL_LOAD_TIMEOUT:Er.LEVEL_LOAD_ERROR,l=!1;break;case pn.AUDIO_TRACK:s=a?Er.AUDIO_TRACK_LOAD_TIMEOUT:Er.AUDIO_TRACK_LOAD_ERROR,l=!1;break;case pn.SUBTITLE_TRACK:s=a?Er.SUBTITLE_TRACK_LOAD_TIMEOUT:Er.SUBTITLE_LOAD_ERROR,l=!1}u&&this.resetInternalLoader(e.type);var c={type:hr.NETWORK_ERROR,details:s,fatal:l,url:e.url,loader:u,context:e,error:o,networkDetails:t,stats:n};if(r){var f=(null==t?void 0:t.url)||e.url;c.response=p({url:f,data:void 0},r)}this.hls.trigger(Tr.ERROR,c)},t.handlePlaylistLoaded=function d(e,t,a,r,n,i){var o=this.hls,s=r.type,l=r.level,u=r.id,c=r.groupId,f=r.deliveryDirectives,g=Ge(t,r),m=Ue(r),p="number"==typeof r.level&&m===yn.MAIN?l:void 0;if(!e.fragments.length){var y=new Error("No Segments found in Playlist");return void o.trigger(Tr.ERROR,{type:hr.NETWORK_ERROR,details:Er.LEVEL_EMPTY_ERROR,fatal:!1,url:g,error:y,reason:y.message,response:t,context:r,level:p,parent:m,networkDetails:n,stats:a})}e.targetduration||(e.playlistParsingError=new Error("Missing Target Duration"));var T=e.playlistParsingError;return T?void o.trigger(Tr.ERROR,{type:hr.NETWORK_ERROR,details:Er.LEVEL_PARSING_ERROR,fatal:!1,url:g,error:T,reason:T.message,response:t,context:r,level:p,parent:m,networkDetails:n,stats:a}):void(e.live&&i&&(i.getCacheAge&&(e.ageHeader=i.getCacheAge()||0),(!i.getCacheAge||isNaN(e.ageHeader))&&(e.ageHeader=0)),s===pn.MANIFEST||s===pn.LEVEL?o.trigger(Tr.LEVEL_LOADED,{details:e,level:p||0,id:u||0,stats:a,networkDetails:n,deliveryDirectives:f}):s===pn.AUDIO_TRACK?o.trigger(Tr.AUDIO_TRACK_LOADED,{details:e,id:u||0,groupId:c||"",stats:a,networkDetails:n,deliveryDirectives:f}):s===pn.SUBTITLE_TRACK?o.trigger(Tr.SUBTITLE_TRACK_LOADED,{details:e,id:u||0,groupId:c||"",stats:a,networkDetails:n,deliveryDirectives:f}):void 0)},e}(),hn={audioId3:"org.id3",dateRange:"com.apple.quicktime.HLS",emsg:"https://aomedia.org/emsg/ID3"},En=function(){var t=Number.MAX_VALUE,a=ze();try{new a(0,n,"")}catch(a){return t}return n}(),Sn=function(){function e(e){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=e,this._registerListeners()}var t=e.prototype;return t.destroy=function e(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=null},t._registerListeners=function e(){var t=this.hls;t.on(Tr.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(Tr.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(Tr.MANIFEST_LOADING,this.onManifestLoading,this),t.on(Tr.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),t.on(Tr.BUFFER_FLUSHING,this.onBufferFlushing,this),t.on(Tr.LEVEL_UPDATED,this.onLevelUpdated,this)},t._unregisterListeners=function e(){var t=this.hls;t.off(Tr.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(Tr.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(Tr.MANIFEST_LOADING,this.onManifestLoading,this),t.off(Tr.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),t.off(Tr.BUFFER_FLUSHING,this.onBufferFlushing,this),t.off(Tr.LEVEL_UPDATED,this.onLevelUpdated,this)},t.onMediaAttached=function a(e,t){this.media=t.media},t.onMediaDetaching=function e(){this.id3Track&&(Ve(this.id3Track),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={})},t.onManifestLoading=function e(){this.dateRangeCuesAppended={}},t.createTrack=function t(e){var a=this.getID3Track(e.textTracks);return a.mode="hidden",a},t.getID3Track=function t(e){if(this.media){for(var a=0,r;a<e.length;a++)if(r=e[a],"metadata"===r.kind&&"id3"===r.label)return Ke(r,this.media),r;return this.media.addTextTrack("metadata","id3")}},t.onFragParsingMetadata=function a(e,t){if(this.media){var r=this.hls.config,n=r.enableEmsgMetadataCues,d=r.enableID3MetadataCues;if(n||d){var o=t.samples;this.id3Track||(this.id3Track=this.createTrack(this.media));for(var s=ze(),l=0,u;l<o.length;l++)if(u=o[l].type,(u!==hn.emsg||n)&&d){var c=qr(o[l].data);if(c){var f=o[l].pts,g=f+o[l].duration;g>En&&(g=En);var m=g-f;0>=m&&(g=f+.25);for(var p=0,y;p<c.length;p++)if(y=c[p],!Wr(y)){this.updateId3CueEnds(f,u);var T=new s(f,g,"");T.value=y,u&&(T.type=u),this.id3Track.addCue(T)}}}}}},t.updateId3CueEnds=function a(e,t){var r=null==(n=this.id3Track)?void 0:n.cues,n;if(r)for(var d=r.length,o;d--;)o=r[d],o.type===t&&o.startTime<e&&o.endTime===En&&(o.endTime=e)},t.onBufferFlushing=function a(e,t){var r=t.startOffset,n=t.endOffset,i=t.type,d=this.id3Track,o=this.hls;if(o){var s=o.config,l=s.enableEmsgMetadataCues,u=s.enableID3MetadataCues;if(d&&(l||u)){var c;c="audio"===i?function t(e){return e.type===hn.audioId3&&u}:"video"===i?function t(e){return e.type===hn.emsg&&l}:function t(e){return e.type===hn.audioId3&&u||e.type===hn.emsg&&l},We(d,r,n,c)}}},t.onLevelUpdated=function a(e,t){var r=this,n=t.details;if(this.media&&n.hasProgramDateTime&&this.hls.config.enableDateRangeMetadataCues){var d=this.dateRangeCuesAppended,o=this.id3Track,s=n.dateRanges,l=Object.keys(s);if(o)for(var u=Object.keys(d).filter(function(e){return!l.includes(e)}),c=function e(){var t=u[f];Object.keys(d[t].cues).forEach(function(e){o.removeCue(d[t].cues[e])}),delete d[t]},f=u.length;f--;)c();var g=n.fragments[n.fragments.length-1];if(0!==l.length&&yr(null==g?void 0:g.programDateTime)){this.id3Track||(this.id3Track=this.createTrack(this.media));for(var m=g.programDateTime/1e3-g.start,p=ze(),y=function e(){var t=l[T],a=s[t],n=d[t],i=(null==n?void 0:n.cues)||{},o=(null==n?void 0:n.durationKnown)||!1,u=je(a.startDate,m),c=En,f=a.endDate;if(f)c=je(f,m),o=!0;else if(a.endOnNext&&!o){var g=l.reduce(function(e,t){var r=s[t];return r.class===a.class&&r.id!==t&&r.startDate>a.startDate&&e.push(r),e},[]).sort(function(e,t){return e.startDate.getTime()-t.startDate.getTime()})[0];g&&(c=je(g.startDate,m),o=!0)}for(var y=Object.keys(a.attr),h=0,E;h<y.length;h++)if(E=y[h],!!M(E)){var S=i[E];if(S)o&&!n.durationKnown&&(S.endTime=c);else{var L=a.attr[E];S=new p(u,c,""),w(E)&&(L=Xe(L)),S.value={key:E,data:L},S.type=hn.dateRange,S.id=t,r.id3Track.addCue(S),i[E]=S}}d[t]={cues:i,dateRange:a,durationKnown:o}},T=0;T<l.length;T++)y()}}},e}(),Ln=function(){function e(e){var t=this;this.hls=void 0,this.config=void 0,this.media=null,this.levelDetails=null,this.currentTime=0,this.stallCount=0,this._latency=null,this.timeupdateHandler=function(){return t.timeupdate()},this.hls=e,this.config=e.config,this.registerListeners()}var t=e.prototype;return t.destroy=function e(){this.unregisterListeners(),this.onMediaDetaching(),this.levelDetails=null,this.hls=this.timeupdateHandler=null},t.registerListeners=function e(){this.hls.on(Tr.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(Tr.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.on(Tr.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(Tr.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.on(Tr.ERROR,this.onError,this)},t.unregisterListeners=function e(){this.hls.off(Tr.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(Tr.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.off(Tr.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(Tr.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.off(Tr.ERROR,this.onError,this)},t.onMediaAttached=function a(e,t){this.media=t.media,this.media.addEventListener("timeupdate",this.timeupdateHandler)},t.onMediaDetaching=function e(){this.media&&(this.media.removeEventListener("timeupdate",this.timeupdateHandler),this.media=null)},t.onManifestLoading=function e(){this.levelDetails=null,this._latency=null,this.stallCount=0},t.onLevelUpdated=function a(e,t){var r=t.details;this.levelDetails=r,r.advanced&&this.timeupdate(),!r.live&&this.media&&this.media.removeEventListener("timeupdate",this.timeupdateHandler)},t.onError=function a(e,t){var r;t.details!==Er.BUFFER_STALLED_ERROR||(this.stallCount++,null!=(r=this.levelDetails)&&r.live&&Ar.warn("[playback-rate-controller]: Stall detected, adjusting target latency"))},t.timeupdate=function e(){var t=this.media,a=this.levelDetails;if(t&&a){this.currentTime=t.currentTime;var n=this.computeLatency();if(null!==n){this._latency=n;var i=this.config,s=i.lowLatencyMode,l=i.maxLiveSyncPlaybackRate;if(s&&1!==l){var u=this.targetLatency;if(null!==u){var c=n-u,g=o(this.maxLatency,u+a.targetduration),m=c<g;if(a.live&&m&&.05<c&&1<this.forwardBufferLength){var p=o(2,f(1,l)),y=d(20*(2/(1+r(-.75*c-this.edgeStalled))))/20;t.playbackRate=o(p,f(1,y))}else 1!==t.playbackRate&&0!==t.playbackRate&&(t.playbackRate=1)}}}}},t.estimateLiveEdge=function e(){var t=this.levelDetails;return null===t?null:t.edge+t.age},t.computeLatency=function e(){var t=this.estimateLiveEdge();return null===t?null:t-this.currentTime},T(e,[{key:"latency",get:function e(){return this._latency||0}},{key:"maxLatency",get:function e(){var t=this.config,a=this.levelDetails;return void 0===t.liveMaxLatencyDuration?a?t.liveMaxLatencyDurationCount*a.targetduration:0:t.liveMaxLatencyDuration}},{key:"targetLatency",get:function e(){var t=this.levelDetails;if(null===t)return null;var a=t.holdBack,r=t.partHoldBack,n=t.targetduration,i=this.config,d=i.liveSyncDuration,s=i.liveSyncDurationCount,l=i.lowLatencyMode,u=this.hls.userConfig,c=l?r||a:a;(u.liveSyncDuration||u.liveSyncDurationCount||0===c)&&(c=void 0===d?s*n:d);var f=n,g=1;return c+o(this.stallCount*g,f)}},{key:"liveSyncPosition",get:function e(){var t=this.estimateLiveEdge(),a=this.targetLatency,r=this.levelDetails;if(null===t||null===a||null===r)return null;var n=r.edge,i=t-a-this.edgeStalled,d=n-r.totalduration,s=n-(this.config.lowLatencyMode&&r.partTarget||r.targetduration);return o(f(d,i),s)}},{key:"drift",get:function e(){var t=this.levelDetails;return null===t?1:t.drift}},{key:"edgeStalled",get:function e(){var t=this.levelDetails;if(null===t)return 0;var a=3*(this.config.lowLatencyMode&&t.partTarget||t.targetduration);return f(t.age-a,0)}},{key:"forwardBufferLength",get:function e(){var t=this.media,a=this.levelDetails;if(!t||!a)return 0;var r=t.buffered.length;return(r?t.buffered.end(r-1):a.edge)-this.currentTime}}]),e}(),Rn=["NONE","TYPE-0","TYPE-1",null],An={No:"",Yes:"YES",v2:"v2"},vn=function(){function e(e,t,a){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=e,this.part=t,this.skip=a}var t=e.prototype;return t.addDirectives=function t(e){var a=new self.URL(e);return void 0!==this.msn&&a.searchParams.set("_HLS_msn",this.msn.toString()),void 0!==this.part&&a.searchParams.set("_HLS_part",this.part.toString()),this.skip&&a.searchParams.set("_HLS_skip",this.skip),a.href},e}(),In=function(){function e(e){this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.videoCodec=void 0,this.width=void 0,this.unknownCodecs=void 0,this.audioGroupIds=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.textGroupIds=void 0,this.url=void 0,this._urlId=0,this.url=[e.url],this._attrs=[e.attrs],this.bitrate=e.bitrate,e.details&&(this.details=e.details),this.id=e.id||0,this.name=e.name,this.width=e.width||0,this.height=e.height||0,this.audioCodec=e.audioCodec,this.videoCodec=e.videoCodec,this.unknownCodecs=e.unknownCodecs,this.codecSet=[e.videoCodec,e.audioCodec].filter(function(e){return e}).join(",").replace(/\.[^.,]+/g,"")}var t=e.prototype;return t.addFallback=function t(e){this.url.push(e.url),this._attrs.push(e.attrs)},T(e,[{key:"maxBitrate",get:function e(){return f(this.realBitrate,this.bitrate)}},{key:"attrs",get:function e(){return this._attrs[this._urlId]}},{key:"pathwayId",get:function e(){return this.attrs["PATHWAY-ID"]||"."}},{key:"uri",get:function e(){return this.url[this._urlId]||""}},{key:"urlId",get:function e(){return this._urlId},set:function t(e){var a=e%this.url.length;this._urlId!==a&&(this.fragmentError=0,this.loadError=0,this.details=void 0,this._urlId=a)}},{key:"audioGroupId",get:function e(){var t;return null==(t=this.audioGroupIds)?void 0:t[this.urlId]}},{key:"textGroupId",get:function e(){var t;return null==(t=this.textGroupIds)?void 0:t[this.urlId]}}]),e}(),Dn={search:function a(e,t){for(var r=0,n=e.length-1,i=null,d=null;r<=n;){i=0|(r+n)/2,d=e[i];var o=t(d);if(0<o)r=i+1;else if(0>o)n=i-1;else return d}return null}},kn={DoNothing:0,SendEndCallback:1,SendAlternateToPenaltyBox:2,RemoveAlternatePermanently:3,InsertDiscontinuity:4,RetryRequest:5},_n={None:0,MoveAllAlternatesMatchingHost:1,MoveAllAlternatesMatchingHDCP:2,SwitchToSDR:4},bn=function(){function e(e){this.hls=void 0,this.playlistError=0,this.penalizedRenditions={},this.log=void 0,this.warn=void 0,this.error=void 0,this.hls=e,this.log=Ar.log.bind(Ar,"[info]:"),this.warn=Ar.warn.bind(Ar,"[warning]:"),this.error=Ar.error.bind(Ar,"[error]:"),this.registerListeners()}var t=e.prototype;return t.registerListeners=function e(){var t=this.hls;t.on(Tr.ERROR,this.onError,this),t.on(Tr.MANIFEST_LOADING,this.onManifestLoading,this),t.on(Tr.LEVEL_UPDATED,this.onLevelUpdated,this)},t.unregisterListeners=function e(){var t=this.hls;t&&(t.off(Tr.ERROR,this.onError,this),t.off(Tr.ERROR,this.onErrorOut,this),t.off(Tr.MANIFEST_LOADING,this.onManifestLoading,this),t.off(Tr.LEVEL_UPDATED,this.onLevelUpdated,this))},t.destroy=function e(){this.unregisterListeners(),this.hls=null,this.penalizedRenditions={}},t.startLoad=function t(e){this.playlistError=0},t.stopLoad=function e(){},t.getVariantLevelIndex=function t(e){return(null==e?void 0:e.type)===yn.MAIN?e.level:this.hls.loadLevel},t.onManifestLoading=function e(){this.playlistError=0,this.penalizedRenditions={}},t.onLevelUpdated=function e(){this.playlistError=0},t.onError=function a(e,t){var r,n;if(!t.fatal){var i=this.hls,d=t.context;switch(t.details){case Er.FRAG_LOAD_ERROR:case Er.FRAG_LOAD_TIMEOUT:case Er.KEY_LOAD_ERROR:case Er.KEY_LOAD_TIMEOUT:return void(t.errorAction=this.getFragRetryOrSwitchAction(t));case Er.FRAG_PARSING_ERROR:if(null!=(r=t.frag)&&r.gap)return void(t.errorAction={action:kn.DoNothing,flags:_n.None});case Er.FRAG_GAP:case Er.FRAG_DECRYPT_ERROR:return t.errorAction=this.getFragRetryOrSwitchAction(t),void(t.errorAction.action=kn.SendAlternateToPenaltyBox);case Er.LEVEL_EMPTY_ERROR:case Er.LEVEL_PARSING_ERROR:{var o=t.parent===yn.MAIN?t.level:i.loadLevel,s,l;t.details===Er.LEVEL_EMPTY_ERROR&&null!=(s=t.context)&&null!=(l=s.levelDetails)&&l.live?t.errorAction=this.getPlaylistRetryOrSwitchAction(t,o):(t.levelRetry=!1,t.errorAction=this.getLevelSwitchAction(t,o))}return;case Er.LEVEL_LOAD_ERROR:case Er.LEVEL_LOAD_TIMEOUT:return void("number"==typeof(null==d?void 0:d.level)&&(t.errorAction=this.getPlaylistRetryOrSwitchAction(t,d.level)));case Er.AUDIO_TRACK_LOAD_ERROR:case Er.AUDIO_TRACK_LOAD_TIMEOUT:case Er.SUBTITLE_LOAD_ERROR:case Er.SUBTITLE_TRACK_LOAD_TIMEOUT:if(d){var u=i.levels[i.loadLevel];if(u&&(d.type===pn.AUDIO_TRACK&&d.groupId===u.audioGroupId||d.type===pn.SUBTITLE_TRACK&&d.groupId===u.textGroupId))return t.errorAction=this.getPlaylistRetryOrSwitchAction(t,i.loadLevel),t.errorAction.action=kn.SendAlternateToPenaltyBox,void(t.errorAction.flags=_n.MoveAllAlternatesMatchingHost)}return;case Er.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:{var c=i.levels[i.loadLevel],f=null==c?void 0:c.attrs["HDCP-LEVEL"];f&&(t.errorAction={action:kn.SendAlternateToPenaltyBox,flags:_n.MoveAllAlternatesMatchingHDCP,hdcpLevel:f})}return;case Er.BUFFER_ADD_CODEC_ERROR:case Er.REMUX_ALLOC_ERROR:return void(t.errorAction=this.getLevelSwitchAction(t,null==(n=t.level)?i.loadLevel:n));case Er.INTERNAL_EXCEPTION:case Er.BUFFER_APPENDING_ERROR:case Er.BUFFER_APPEND_ERROR:case Er.BUFFER_FULL_ERROR:case Er.LEVEL_SWITCH_ERROR:case Er.BUFFER_STALLED_ERROR:case Er.BUFFER_SEEK_OVER_HOLE:case Er.BUFFER_NUDGE_ON_STALL:return void(t.errorAction={action:kn.DoNothing,flags:_n.None})}if(t.type===hr.KEY_SYSTEM_ERROR){var g=this.getVariantLevelIndex(t.frag);return t.levelRetry=!1,void(t.errorAction=this.getLevelSwitchAction(t,g))}}},t.getPlaylistRetryOrSwitchAction=function a(e,t){var r=this.hls,n=ut(r.config.playlistLoadPolicy,e),i=this.playlistError++,d=null==(s=e.response)?void 0:s.code,o=gt(n,i,lt(e),d),s;if(o)return{action:kn.RetryRequest,flags:_n.None,retryConfig:n,retryCount:i};var l=this.getLevelSwitchAction(e,t);return n&&(l.retryConfig=n,l.retryCount=i),l},t.getFragRetryOrSwitchAction=function t(e){var a=this.hls,r=this.getVariantLevelIndex(e.frag),n=a.levels[r],i=a.config,d=i.fragLoadPolicy,o=i.keyLoadPolicy,s=ut(e.details.startsWith("key")?o:d,e),l=a.levels.reduce(function(e,t){return e+t.fragmentError},0);if(n){var u;e.details!==Er.FRAG_GAP&&n.fragmentError++;var c=null==(u=e.response)?void 0:u.code,f=gt(s,l,lt(e),c);if(f)return{action:kn.RetryRequest,flags:_n.None,retryConfig:s,retryCount:l}}var g=this.getLevelSwitchAction(e,r);return s&&(g.retryConfig=s,g.retryCount=l),g},t.getLevelSwitchAction=function a(e,t){var r=this.hls;(null===t||void 0===t)&&(t=r.loadLevel);var n=this.hls.levels[t];if(n&&(n.loadError++,r.autoLevelEnabled)){for(var d=-1,o=r.levels,s=r.loadLevel,l=r.minAutoLevel,u=r.maxAutoLevel,c=null==(y=e.frag)?void 0:y.type,f=null==(T=e.context)?{}:T,g=f.type,m=f.groupId,p=o.length,y,T,h;p--;)if(h=(p+s)%o.length,h!==s&&h>=l&&h<=u&&0===o[h].loadError){var E=o[h];if(e.details===Er.FRAG_GAP&&e.frag){var S=o[h].details;if(S){var L=yt(e.frag,S.fragments,e.frag.start);if(null!=L&&L.gap)continue}}else if(g===pn.AUDIO_TRACK&&m===E.audioGroupId||g===pn.SUBTITLE_TRACK&&m===E.textGroupId)continue;else if(c===yn.AUDIO&&n.audioGroupId===E.audioGroupId||c===yn.SUBTITLE&&n.textGroupId===E.textGroupId)continue;d=h;break}if(-1<d&&r.loadLevel!==d)return e.levelRetry=!0,this.playlistError=0,{action:kn.SendAlternateToPenaltyBox,flags:_n.None,nextAutoLevel:d}}return{action:kn.SendAlternateToPenaltyBox,flags:_n.MoveAllAlternatesMatchingHost}},t.onErrorOut=function a(e,t){var r;switch(null==(r=t.errorAction)?void 0:r.action){case kn.DoNothing:break;case kn.SendAlternateToPenaltyBox:this.sendAlternateToPenaltyBox(t),t.errorAction.resolved||t.details===Er.FRAG_GAP||(t.fatal=!0)}if(t.fatal)return void this.hls.stopLoad()},t.sendAlternateToPenaltyBox=function t(e){var a=this.hls,r=e.errorAction;if(r){var n=r.flags,i=r.hdcpLevel,d=r.nextAutoLevel;n===_n.None?this.switchLevel(e,d):n===_n.MoveAllAlternatesMatchingHost?r.resolved||(r.resolved=this.redundantFailover(e)):n===_n.MoveAllAlternatesMatchingHDCP?(i&&(a.maxHdcpLevel=Rn[Rn.indexOf(i)-1],r.resolved=!0),this.warn("Restricting playback to HDCP-LEVEL of \""+a.maxHdcpLevel+"\" or lower")):void 0,r.resolved||this.switchLevel(e,d)}},t.switchLevel=function a(e,t){void 0!==t&&e.errorAction&&(this.warn("switching to level "+t+" after "+e.details),this.hls.nextAutoLevel=t,e.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel)},t.redundantFailover=function t(e){var a=this,r=this.hls,n=this.penalizedRenditions,d=e.parent===yn.MAIN?e.level:r.loadLevel,o=r.levels[d],s=o.url.length,l=e.frag?e.frag.urlId:o.urlId;o.urlId===l&&(!e.frag||o.details)&&this.penalizeRendition(o,e);for(var u=function t(){var i=(l+c)%s,u=n[i];if(!u||St(u,e,n[l]))return a.warn("Switching to Redundant Stream "+(i+1)+"/"+s+": \""+o.url[i]+"\" after "+e.details),a.playlistError=0,r.levels.forEach(function(e){e.urlId=i}),r.nextLoadLevel=d,{v:!0}},c=1,f;c<s;c++)if(f=u(),"object"==typeof f)return f.v;return!1},t.penalizeRendition=function a(e,t){var r=this.penalizedRenditions,n=r[e.urlId]||{lastErrorPerfMs:0,errors:[],details:void 0};n.lastErrorPerfMs=performance.now(),n.errors.push(t),n.details=e.details,r[e.urlId]=n},e}(),Cn=function(){function e(e,t){this.hls=void 0,this.timer=-1,this.requestScheduled=-1,this.canLoad=!1,this.log=void 0,this.warn=void 0,this.log=Ar.log.bind(Ar,t+":"),this.warn=Ar.warn.bind(Ar,t+":"),this.hls=e}var t=e.prototype;return t.destroy=function e(){this.clearTimer(),this.hls=this.log=this.warn=null},t.clearTimer=function e(){clearTimeout(this.timer),this.timer=-1},t.startLoad=function e(){this.canLoad=!0,this.requestScheduled=-1,this.loadPlaylist()},t.stopLoad=function e(){this.canLoad=!1,this.clearTimer()},t.switchParams=function a(e,t){var r=null==t?void 0:t.renditionReports;if(r){for(var n=-1,d=0;d<r.length;d++){var s=r[d],l=void 0;try{l=new self.URL(s.URI,t.url).href}catch(e){Ar.warn("Could not construct new URL for Rendition Report: "+e),l=s.URI||""}if(l===e){n=d;break}else l===e.substring(0,l.length)&&(n=d)}if(-1!==n){var u=r[n],c=parseInt(u["LAST-MSN"])||(null==t?void 0:t.lastPartSn),f=parseInt(u["LAST-PART"])||(null==t?void 0:t.lastPartIndex);if(this.hls.config.lowLatencyMode){var g=o(t.age-t.partTarget,t.targetduration);0<=f&&g>t.partTarget&&(f+=1)}return new vn(c,0<=f?f:void 0,An.No)}}},t.loadPlaylist=function t(e){-1===this.requestScheduled&&(this.requestScheduled=self.performance.now())},t.shouldLoadPlaylist=function t(e){return this.canLoad&&!!e&&!!e.url&&(!e.details||e.details.live)},t.shouldReloadPlaylist=function t(e){return-1===this.timer&&-1===this.requestScheduled&&this.shouldLoadPlaylist(e)},t.playlistLoaded=function r(e,t,a){var n=this,i=t.details,s=t.stats,l=self.performance.now(),c=s.loading.first?f(0,l-s.loading.first):0;if(i.advancedDateTime=Date.now()-c,i.live||null!=a&&a.live){if(i.reloaded(a),a&&this.log("live playlist "+e+" "+(i.advanced?"REFRESHED "+i.lastPartSn+"-"+i.lastPartIndex:i.updated?"UPDATED":"MISSED")),a&&0<i.fragments.length&&Je(a,i),!this.canLoad||!i.live)return;var g=void 0,m=void 0,p;if(i.canBlockReload&&i.endSN&&i.advanced){var y=this.hls.config.lowLatencyMode,T=i.lastPartSn,h=i.endSN,E=i.lastPartIndex,S=-1!==E,L=T===h,R=y?0:E;S?(g=L?h+1:T,m=L?R:E+1):g=h+1;var A=i.age,v=A+i.ageHeader,I=o(v-i.partTarget,1.5*i.targetduration);if(0<I){if(a&&I>a.tuneInGoal)this.warn("CDN Tune-in goal increased from: "+a.tuneInGoal+" to: "+I+" with playlist age: "+i.age),I=0;else{var D=u(I/i.targetduration);if(g+=D,void 0!==m){var k=d(I%i.targetduration/i.partTarget);m+=k}this.log("CDN Tune-in age: "+i.ageHeader+"s last advanced "+A.toFixed(2)+"s goal: "+I+" skip sn "+D+" to part "+m)}i.tuneInGoal=I}if(p=this.getDeliveryDirectives(i,t.deliveryDirectives,g,m),y||!L)return void this.loadPlaylist(p)}else(i.canBlockReload||i.canSkipUntil)&&(p=this.getDeliveryDirectives(i,t.deliveryDirectives,g,m));var _=this.hls.mainForwardBufferInfo,b=_?_.end-_.len:0,C=1e3*(i.edge-b),P=it(i,C);i.updated&&l>this.requestScheduled+P&&(this.requestScheduled=s.loading.start),void 0!==g&&i.canBlockReload?this.requestScheduled=s.loading.first+P-(1e3*i.partTarget||1e3):-1===this.requestScheduled||this.requestScheduled+P<l?this.requestScheduled=l:0>=this.requestScheduled-l&&(this.requestScheduled+=P);var x=this.requestScheduled-l;x=f(0,x),this.log("reload live playlist "+e+" in "+d(x)+" ms"),this.timer=self.setTimeout(function(){return n.loadPlaylist(p)},x)}else this.clearTimer()},t.getDeliveryDirectives=function n(e,t,a,r){var i=Qe(e,a);return null!=t&&t.skip&&e.deltaUpdateFailed&&(a=t.msn,r=t.part,i=An.No),new vn(a,r,i)},t.checkRetry=function t(e){var a=this,r=e.details,n=lt(e),i=e.errorAction,d=i||{},o=d.action,s=d.retryCount,l=void 0===s?0:s,u=d.retryConfig,c=!!i&&!!u&&(o===kn.RetryRequest||!i.resolved&&o===kn.SendAlternateToPenaltyBox);if(c){var f;if(this.requestScheduled=-1,l>=u.maxNumRetry)return!1;if(n&&null!=(f=e.context)&&f.deliveryDirectives)this.warn("Retrying playlist loading "+(l+1)+"/"+u.maxNumRetry+" after \""+r+"\" without delivery-directives"),this.loadPlaylist();else{var g=ct(u,l);this.timer=self.setTimeout(function(){return a.loadPlaylist()},g),this.warn("Retrying playlist loading "+(l+1)+"/"+u.maxNumRetry+" after \""+r+"\" in "+g+"ms")}e.levelRetry=!0,i.resolved=!0}return c},e}(),Pn=function(e){function t(t,a){var r;return r=e.call(this,t,"[level-controller]")||this,r._levels=[],r._firstLevel=-1,r._startLevel=void 0,r.currentLevel=null,r.currentLevelIndex=-1,r.manualLevelIndex=-1,r.steering=void 0,r.onParsedComplete=void 0,r.steering=a,r._registerListeners(),r}S(t,e);var a=t.prototype;return a._registerListeners=function e(){var t=this.hls;t.on(Tr.MANIFEST_LOADING,this.onManifestLoading,this),t.on(Tr.MANIFEST_LOADED,this.onManifestLoaded,this),t.on(Tr.LEVEL_LOADED,this.onLevelLoaded,this),t.on(Tr.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(Tr.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),t.on(Tr.FRAG_LOADED,this.onFragLoaded,this),t.on(Tr.ERROR,this.onError,this)},a._unregisterListeners=function e(){var t=this.hls;t.off(Tr.MANIFEST_LOADING,this.onManifestLoading,this),t.off(Tr.MANIFEST_LOADED,this.onManifestLoaded,this),t.off(Tr.LEVEL_LOADED,this.onLevelLoaded,this),t.off(Tr.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(Tr.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),t.off(Tr.FRAG_LOADED,this.onFragLoaded,this),t.off(Tr.ERROR,this.onError,this)},a.destroy=function t(){this._unregisterListeners(),this.steering=null,this.resetLevels(),e.prototype.destroy.call(this)},a.startLoad=function t(){var a=this._levels;a.forEach(function(e){e.loadError=0,e.fragmentError=0}),e.prototype.startLoad.call(this)},a.resetLevels=function e(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[]},a.onManifestLoading=function a(e,t){this.resetLevels()},a.onManifestLoaded=function a(e,t){var r=[],n={},i;t.levels.forEach(function(e){var t=e.attrs,a;-1!==(null==(a=e.audioCodec)?void 0:a.indexOf("mp4a.40.34"))&&(mi||(mi=/chrome|firefox/i.test(navigator.userAgent)),mi&&(e.audioCodec=void 0));var d=t.AUDIO,o=t.CODECS,s=t["FRAME-RATE"],l=t["PATHWAY-ID"],u=t.RESOLUTION,c=t.SUBTITLES,f=(l||".")+"-",g=""+f+e.bitrate+"-"+u+"-"+s+"-"+o;i=n[g],i?i.addFallback(e):(i=new In(e),n[g]=i,r.push(i)),Lt(i,"audio",d),Lt(i,"text",c)}),this.filterAndSortMediaOptions(r,t)},a.filterAndSortMediaOptions=function a(e,t){var r=this,n=[],d=[],o=!1,s=!1,l=!1,u=e.filter(function(e){var t=e.audioCodec,a=e.videoCodec,r=e.width,n=e.height,i=e.unknownCodecs;return o||(o=!!(r&&n)),s||(s=!!a),l||(l=!!t),!(null!=i&&i.length)&&(!t||Ce(t,"audio"))&&(!a||Ce(a,"video"))});if((o||s)&&l&&(u=u.filter(function(e){var t=e.videoCodec,a=e.width,r=e.height;return!!t||!!(a&&r)})),0===u.length)return void Promise.resolve().then(function(){if(r.hls){var e=new Error("no level with compatible codecs found in manifest");r.hls.trigger(Tr.ERROR,{type:hr.MEDIA_ERROR,details:Er.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:t.url,error:e,reason:e.message})}});t.audioTracks&&(n=t.audioTracks.filter(function(e){return!e.audioCodec||Ce(e.audioCodec,"audio")}),Rt(n)),t.subtitles&&(d=t.subtitles,Rt(d));var c=u.slice(0);u.sort(function(e,t){return e.attrs["HDCP-LEVEL"]===t.attrs["HDCP-LEVEL"]?e.bitrate===t.bitrate?e.attrs["FRAME-RATE"]===t.attrs["FRAME-RATE"]?e.attrs.SCORE===t.attrs.SCORE?o&&e.height!==t.height?e.height-t.height:0:e.attrs.decimalFloatingPoint("SCORE")-t.attrs.decimalFloatingPoint("SCORE"):e.attrs.decimalFloatingPoint("FRAME-RATE")-t.attrs.decimalFloatingPoint("FRAME-RATE"):e.bitrate-t.bitrate:(e.attrs["HDCP-LEVEL"]||"")>(t.attrs["HDCP-LEVEL"]||"")?1:-1});var f=c[0];if(this.steering&&(u=this.steering.filterParsedLevels(u),u.length!==c.length))for(var g=0;g<c.length;g++)if(c[g].pathwayId===u[0].pathwayId){f=c[g];break}this._levels=u;for(var m=0;m<u.length;m++)if(u[m]===f){this._firstLevel=m,this.log("manifest loaded, "+u.length+" level(s) found, first bitrate: "+f.bitrate);break}var p=l&&!s,y={levels:u,audioTracks:n,subtitleTracks:d,sessionData:t.sessionData,sessionKeys:t.sessionKeys,firstLevel:this._firstLevel,stats:t.stats,audio:l,video:s,altAudio:!p&&n.some(function(e){return!!e.url})};this.hls.trigger(Tr.MANIFEST_PARSED,y),(this.hls.config.autoStartLoad||this.hls.forceStartLoad)&&this.hls.startLoad(this.hls.config.startPosition)},a.onError=function a(e,t){t.fatal||!t.context||t.context.type===pn.LEVEL&&t.context.level===this.level&&this.checkRetry(t)},a.onFragLoaded=function a(e,t){var r=t.frag;if(void 0!==r&&r.type===yn.MAIN){var n=this._levels[r.level];void 0!==n&&(n.loadError=0)}},a.onLevelLoaded=function a(e,t){var r=t.level,n=t.details,i=this._levels[r],d;if(!i){var o;return this.warn("Invalid level index "+r),void(null!=(o=t.deliveryDirectives)&&o.skip&&(n.deltaUpdateFailed=!0))}r===this.currentLevelIndex?(0===i.fragmentError&&(i.loadError=0),this.playlistLoaded(r,t,i.details)):null!=(d=t.deliveryDirectives)&&d.skip&&(n.deltaUpdateFailed=!0)},a.onAudioTrackSwitched=function a(e,t){var r=this.currentLevel;if(r){var n=this.hls.audioTracks[t.id].groupId;if(r.audioGroupIds&&r.audioGroupId!==n){for(var d=-1,o=0;o<r.audioGroupIds.length;o++)if(r.audioGroupIds[o]===n){d=o;break}-1!==d&&d!==r.urlId&&(r.urlId=d,this.canLoad&&this.startLoad())}}},a.loadPlaylist=function a(t){e.prototype.loadPlaylist.call(this);var r=this.currentLevelIndex,n=this.currentLevel;if(n&&this.shouldLoadPlaylist(n)){var i=n.urlId,d=n.uri;if(t)try{d=t.addDirectives(d)}catch(e){this.warn("Could not construct new URL with HLS Delivery Directives: "+e)}var o=n.attrs["PATHWAY-ID"];this.log("Loading level index "+r+(void 0===(null==t?void 0:t.msn)?"":" at sn "+t.msn+" part "+t.part)+" with"+(o?" Pathway "+o:"")+" URI "+(i+1)+"/"+n.url.length+" "+d),this.clearTimer(),this.hls.trigger(Tr.LEVEL_LOADING,{url:d,level:r,id:i,deliveryDirectives:t||null})}},a.removeLevel=function a(e,t){var r=this,n=function r(e,a){return a!==t},i=this._levels.filter(function(a,i){return i!==e||(1<a.url.length&&void 0!==t?(a.url=a.url.filter(n),a.audioGroupIds&&(a.audioGroupIds=a.audioGroupIds.filter(n)),a.textGroupIds&&(a.textGroupIds=a.textGroupIds.filter(n)),a.urlId=0,!0):(r.steering&&r.steering.removeLevel(a),!1))});this.hls.trigger(Tr.LEVELS_UPDATED,{levels:i})},a.onLevelsUpdated=function a(e,t){var r=t.levels;r.forEach(function(e,t){var a=e.details;null!=a&&a.fragments&&a.fragments.forEach(function(e){e.level=t})}),this._levels=r},T(t,[{key:"levels",get:function e(){return 0===this._levels.length?null:this._levels}},{key:"level",get:function e(){return this.currentLevelIndex},set:function t(e){var a=this._levels;if(0!==a.length){if(0>e||e>=a.length){var r=new Error("invalid level idx"),n=0>e;if(this.hls.trigger(Tr.ERROR,{type:hr.OTHER_ERROR,details:Er.LEVEL_SWITCH_ERROR,level:e,fatal:n,error:r,reason:r.message}),n)return;e=o(e,a.length-1)}var i=this.currentLevelIndex,d=this.currentLevel,s=d?d.attrs["PATHWAY-ID"]:void 0,l=a[e],u=l.attrs["PATHWAY-ID"];if(this.currentLevelIndex=e,this.currentLevel=l,!(i===e&&l.details&&d&&s===u)){this.log("Switching to level "+e+(u?" with Pathway "+u:"")+" from level "+i+(s?" with Pathway "+s:""));var c=E({},l,{level:e,maxBitrate:l.maxBitrate,attrs:l.attrs,uri:l.uri,urlId:l.urlId});delete c._attrs,delete c._urlId,this.hls.trigger(Tr.LEVEL_SWITCHING,c);var f=l.details;if(!f||f.live){var g=this.switchParams(l.uri,null==d?void 0:d.details);this.loadPlaylist(g)}}}}},{key:"manualLevel",get:function e(){return this.manualLevelIndex},set:function t(e){this.manualLevelIndex=e,void 0===this._startLevel&&(this._startLevel=e),-1!==e&&(this.level=e)}},{key:"firstLevel",get:function e(){return this._firstLevel},set:function t(e){this._firstLevel=e}},{key:"startLevel",get:function e(){if(void 0===this._startLevel){var t=this.hls.config.startLevel;return void 0===t?this._firstLevel:t}return this._startLevel},set:function t(e){this._startLevel=e}},{key:"nextLoadLevel",get:function e(){return-1===this.manualLevelIndex?this.hls.nextAutoLevel:this.manualLevelIndex},set:function t(e){this.level=e,-1===this.manualLevelIndex&&(this.hls.nextAutoLevel=e)}}]),t}(Cn),xn={NOT_LOADED:"NOT_LOADED",APPENDING:"APPENDING",PARTIAL:"PARTIAL",OK:"OK"},Fn=function(){function e(e){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=e,this._registerListeners()}var t=e.prototype;return t._registerListeners=function e(){var t=this.hls;t.on(Tr.BUFFER_APPENDED,this.onBufferAppended,this),t.on(Tr.FRAG_BUFFERED,this.onFragBuffered,this),t.on(Tr.FRAG_LOADED,this.onFragLoaded,this)},t._unregisterListeners=function e(){var t=this.hls;t.off(Tr.BUFFER_APPENDED,this.onBufferAppended,this),t.off(Tr.FRAG_BUFFERED,this.onFragBuffered,this),t.off(Tr.FRAG_LOADED,this.onFragLoaded,this)},t.destroy=function e(){this._unregisterListeners(),this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null},t.getAppendedFrag=function a(e,t){var r=this.activePartLists[t];if(r)for(var n=r.length,d,o;n--&&(d=r[n],!!d);)if(o=d.end,d.start<=e&&null!==o&&e<=o)return d;return this.getBufferedFrag(e,t)},t.getBufferedFrag=function a(e,t){for(var r=this.fragments,n=Object.keys(r),d=n.length,o;d--;)if(o=r[n[d]],(null==o?void 0:o.body.type)===t&&o.buffered){var s=o.body;if(s.start<=e&&e<=s.end)return s}return null},t.detectEvictedFragments=function n(e,t,a,r){var i=this;this.timeRanges&&(this.timeRanges[e]=t);var d=(null==r?void 0:r.fragment.sn)||-1;Object.keys(this.fragments).forEach(function(r){var n=i.fragments[r];if(n&&!(d>=n.body.sn)){if(!n.buffered&&!n.loaded)return void(n.body.type===a&&i.removeFragment(n.body));var o=n.range[e];o&&o.time.some(function(e){var a=!i.isTimeBuffered(e.startPTS,e.endPTS,t);return a&&i.removeFragment(n.body),a})}})},t.detectPartialFragments=function t(e){var a=this,r=this.timeRanges,n=e.frag,i=e.part;if(r&&"initSegment"!==n.sn){var d=vt(n),o=this.fragments[d];if(!(!o||o.buffered&&n.gap)){var s=!n.relurl;if(Object.keys(r).forEach(function(e){var t=n.elementaryStreams[e];if(t){var d=r[e],l=s||!0===t.partial;o.range[e]=a.getBufferedTimes(n,i,l,d)}}),o.loaded=null,Object.keys(o.range).length){o.buffered=!0;var l=o.body.endList=n.endList||o.body.endList;l&&(this.endListFragments[o.body.type]=o),At(o)||this.removeParts(n.sn-1,n.type)}else this.removeFragment(o.body)}}},t.removeParts=function a(e,t){var r=this.activePartLists[t];r&&(this.activePartLists[t]=r.filter(function(t){return t.fragment.sn>=e}))},t.fragBuffered=function a(e,t){var r=vt(e),n=this.fragments[r];!n&&t&&(n=this.fragments[r]={body:e,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},e.gap&&(this.hasGaps=!0)),n&&(n.loaded=null,n.buffered=!0)},t.getBufferedTimes=function n(e,t,a,r){for(var d={time:[],partial:a},s=e.start,l=e.end,u=e.minEndPTS||l,c=e.maxStartPTS||s,g=0;g<r.length;g++){var m=r.start(g)-this.bufferPadding,p=r.end(g)+this.bufferPadding;if(c>=m&&u<=p){d.time.push({startPTS:f(s,r.start(g)),endPTS:o(l,r.end(g))});break}else if(s<p&&l>m)d.partial=!0,d.time.push({startPTS:f(s,r.start(g)),endPTS:o(l,r.end(g))});else if(l<=m)break}return d},t.getPartialFragment=function t(e){var a=null,r=0,n=this.bufferPadding,i=this.fragments,d,s,l;return Object.keys(i).forEach(function(t){var u=i[t];!u||At(u)&&(s=u.body.start-n,l=u.body.end+n,e>=s&&e<=l&&(d=o(e-s,l-e),r<=d&&(a=u.body,r=d)))}),a},t.isEndListAppended=function t(e){var a=this.endListFragments[e];return void 0!==a&&(a.buffered||At(a))},t.getState=function t(e){var a=vt(e),r=this.fragments[a];return r?r.buffered?At(r)?xn.PARTIAL:xn.OK:xn.APPENDING:xn.NOT_LOADED},t.isTimeBuffered=function r(e,t,a){for(var n=0,d,o;n<a.length;n++){if(d=a.start(n)-this.bufferPadding,o=a.end(n)+this.bufferPadding,e>=d&&t<=o)return!0;if(t<=d)return!1}return!1},t.onFragLoaded=function a(e,t){var r=t.frag,n=t.part;if(!("initSegment"===r.sn||r.bitrateTest)){var i=n?null:t,d=vt(r);this.fragments[d]={body:r,appendedPTS:null,loaded:i,buffered:!1,range:Object.create(null)}}},t.onBufferAppended=function a(e,t){var r=this,n=t.frag,i=t.part,d=t.timeRanges;if("initSegment"!==n.sn){var o=n.type;if(i){var s=this.activePartLists[o];s||(this.activePartLists[o]=s=[]),s.push(i)}this.timeRanges=d,Object.keys(d).forEach(function(e){var t=d[e];r.detectEvictedFragments(e,t,o,i)})}},t.onFragBuffered=function a(e,t){this.detectPartialFragments(t)},t.hasFragment=function t(e){var a=vt(e);return!!this.fragments[a]},t.hasParts=function t(e){var a;return!!(null!=(a=this.activePartLists[e])&&a.length)},t.removeFragmentsInRange=function i(e,t,a,r,n){var d=this;r&&!this.hasGaps||Object.keys(this.fragments).forEach(function(i){var o=d.fragments[i];if(o){var s=o.body;s.type!==a||r&&!s.gap||s.start<t&&s.end>e&&(o.buffered||n)&&d.removeFragment(s)}})},t.removeFragment=function t(e){var a=vt(e);e.stats.loaded=0,e.clearElementaryStreamInfo();var r=this.activePartLists[e.type];if(r){var n=e.sn;this.activePartLists[e.type]=r.filter(function(e){return e.fragment.sn!==n})}delete this.fragments[a],e.endList&&delete this.endListFragments[e.type]},t.removeAllFragments=function e(){this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1},e}(),On=c(2,17),Nn=function(){function e(e){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=e}var t=e.prototype;return t.destroy=function e(){this.loader&&(this.loader.destroy(),this.loader=null)},t.abort=function e(){this.loader&&this.loader.abort()},t.load=function a(e,t){var r=this,n=e.url;if(!n)return Promise.reject(new Mn({type:hr.NETWORK_ERROR,details:Er.FRAG_LOAD_ERROR,fatal:!1,frag:e,error:new Error("Fragment does not have a "+(n?"part list":"url")),networkDetails:null}));this.abort();var i=this.config,d=i.fLoader,o=i.loader;return new Promise(function(a,s){if(r.loader&&r.loader.destroy(),e.gap){if(e.tagList.some(function(e){return"GAP"===e[0]}))return void s(Dt(e));e.gap=!1}var l=r.loader=e.loader=d?new d(i):new o(i),u=It(e),c=ft(i.fragLoadPolicy.default),f={loadPolicy:c,timeout:c.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:"initSegment"===e.sn?1/0:On};e.stats=l.stats,l.load(u,f,{onSuccess:function o(t,n,i,d){r.resetLoader(e,l);var s=t.data;i.resetIV&&e.decryptdata&&(e.decryptdata.iv=new Uint8Array(s.slice(0,16)),s=s.slice(16)),a({frag:e,part:null,payload:s,networkDetails:d})},onError:function o(t,a,i,d){r.resetLoader(e,l),s(new Mn({type:hr.NETWORK_ERROR,details:Er.FRAG_LOAD_ERROR,fatal:!1,frag:e,response:p({url:n,data:void 0},t),error:new Error("HTTP Error "+t.code+" "+t.text),networkDetails:i,stats:d}))},onAbort:function i(t,a,n){r.resetLoader(e,l),s(new Mn({type:hr.NETWORK_ERROR,details:Er.INTERNAL_ABORTED,fatal:!1,frag:e,error:new Error("Aborted"),networkDetails:n,stats:t}))},onTimeout:function i(t,a,n){r.resetLoader(e,l),s(new Mn({type:hr.NETWORK_ERROR,details:Er.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,error:new Error("Timeout after "+f.timeout+"ms"),networkDetails:n,stats:t}))},onProgress:function d(a,r,n,i){t&&t({frag:e,part:null,payload:n,networkDetails:i})}})})},t.loadPart=function r(e,t,a){var n=this;this.abort();var i=this.config,d=i.fLoader,o=i.loader;return new Promise(function(r,s){if(n.loader&&n.loader.destroy(),e.gap||t.gap)return void s(Dt(e,t));var l=n.loader=e.loader=d?new d(i):new o(i),u=It(e,t),c=ft(i.fragLoadPolicy.default),f={loadPolicy:c,timeout:c.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:On};t.stats=l.stats,l.load(u,f,{onSuccess:function u(i,d,o,s){n.resetLoader(e,l),n.updateStatsFromPart(e,t);var c={frag:e,part:t,payload:i.data,networkDetails:s};a(c),r(c)},onError:function o(a,r,i,d){n.resetLoader(e,l),s(new Mn({type:hr.NETWORK_ERROR,details:Er.FRAG_LOAD_ERROR,fatal:!1,frag:e,part:t,response:p({url:u.url,data:void 0},a),error:new Error("HTTP Error "+a.code+" "+a.text),networkDetails:i,stats:d}))},onAbort:function d(a,r,i){e.stats.aborted=t.stats.aborted,n.resetLoader(e,l),s(new Mn({type:hr.NETWORK_ERROR,details:Er.INTERNAL_ABORTED,fatal:!1,frag:e,part:t,error:new Error("Aborted"),networkDetails:i,stats:a}))},onTimeout:function d(a,r,i){n.resetLoader(e,l),s(new Mn({type:hr.NETWORK_ERROR,details:Er.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,part:t,error:new Error("Timeout after "+f.timeout+"ms"),networkDetails:i,stats:a}))}})})},t.updateStatsFromPart=function a(e,t){var r=e.stats,n=t.stats,i=n.total;if(r.loaded+=n.loaded,i){var s=d(e.duration/t.duration),l=o(d(r.loaded/i),s),u=s-l,c=u*d(r.loaded/l);r.total=r.loaded+c}else r.total=f(r.loaded,r.total);var g=r.loading,m=n.loading;g.start?g.first+=m.first-m.start:(g.start=m.start,g.first=m.first),g.end=m.end},t.resetLoader=function a(e,t){e.loader=null,this.loader===t&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),t.destroy()},e}(),Mn=function(e){function t(t){var a;return a=e.call(this,t.error.message)||this,a.data=void 0,a.data=t,a}return S(t,e),t}(D(Error)),wn=function(){function e(e){this.config=void 0,this.keyUriToKeyInfo={},this.emeController=null,this.config=e}var t=e.prototype;return t.abort=function t(e){for(var a in this.keyUriToKeyInfo){var r=this.keyUriToKeyInfo[a].loader;if(r){if(e&&e!==r.context.frag.type)return;r.abort()}}},t.detach=function e(){for(var t in this.keyUriToKeyInfo){var a=this.keyUriToKeyInfo[t];(a.mediaKeySessionContext||a.decryptdata.isCommonEncryption)&&delete this.keyUriToKeyInfo[t]}},t.destroy=function e(){for(var t in this.detach(),this.keyUriToKeyInfo){var a=this.keyUriToKeyInfo[t].loader;a&&a.destroy()}this.keyUriToKeyInfo={}},t.createKeyLoadError=function i(e,t,a,r,n){return void 0===t&&(t=Er.KEY_LOAD_ERROR),new Mn({type:hr.NETWORK_ERROR,details:t,fatal:!1,frag:e,response:n,error:a,networkDetails:r})},t.loadClear=function a(e,t){var r=this;if(this.emeController&&this.config.emeEnabled)for(var n=e.sn,d=e.cc,o=function e(){var a=t[s];if(d<=a.cc&&("initSegment"===n||"initSegment"===a.sn||n<a.sn))return r.emeController.selectKeySystemFormat(a).then(function(e){a.setKeyFormat(e)}),"break"},s=0,l;s<t.length&&(l=o(),"break"!==l);s++);},t.load=function t(e){var a=this;return!e.decryptdata&&e.encrypted&&this.emeController?this.emeController.selectKeySystemFormat(e).then(function(t){return a.loadInternal(e,t)}):this.loadInternal(e)},t.loadInternal=function a(e,t){var r,n;t&&e.setKeyFormat(t);var i=e.decryptdata;if(!i){var d=new Error(t?"Expected frag.decryptdata to be defined after setting format "+t:"Missing decryption data on fragment in onKeyLoading");return Promise.reject(this.createKeyLoadError(e,Er.KEY_LOAD_ERROR,d))}var o=i.uri;if(!o)return Promise.reject(this.createKeyLoadError(e,Er.KEY_LOAD_ERROR,new Error("Invalid key URI: \""+o+"\"")));var s=this.keyUriToKeyInfo[o];if(null!=(r=s)&&r.decryptdata.key)return i.key=s.decryptdata.key,Promise.resolve({frag:e,keyInfo:s});if(null!=(n=s)&&n.keyLoadPromise){var l;switch(null==(l=s.mediaKeySessionContext)?void 0:l.keyStatus){case void 0:case"status-pending":case"usable":case"usable-in-future":return s.keyLoadPromise.then(function(t){return i.key=t.keyInfo.decryptdata.key,{frag:e,keyInfo:s}})}}switch(s=this.keyUriToKeyInfo[o]={decryptdata:i,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},i.method){case"ISO-23001-7":case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":return"identity"===i.keyFormat?this.loadKeyHTTP(s,e):this.loadKeyEME(s,e);case"AES-128":return this.loadKeyHTTP(s,e);default:return Promise.reject(this.createKeyLoadError(e,Er.KEY_LOAD_ERROR,new Error("Key supplied with unsupported METHOD: \""+i.method+"\"")))}},t.loadKeyEME=function a(e,t){var r={frag:t,keyInfo:e};if(this.emeController&&this.config.emeEnabled){var n=this.emeController.loadKey(r);if(n)return(e.keyLoadPromise=n.then(function(t){return e.mediaKeySessionContext=t,r})).catch(function(t){throw e.keyLoadPromise=null,t})}return Promise.resolve(r)},t.loadKeyHTTP=function a(e,t){var r=this,n=this.config,i=n.loader,d=new i(n);return t.keyLoader=e.loader=d,e.keyLoadPromise=new Promise(function(a,i){var o={keyInfo:e,frag:t,responseType:"arraybuffer",url:e.decryptdata.uri},s=n.keyLoadPolicy.default,l={loadPolicy:s,timeout:s.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},u={onSuccess:function o(e,t,n,d){var s=n.frag,l=n.keyInfo,u=n.url;return s.decryptdata&&l===r.keyUriToKeyInfo[u]?void(l.decryptdata.key=s.decryptdata.key=new Uint8Array(e.data),s.keyLoader=null,l.loader=null,a({frag:s,keyInfo:l})):i(r.createKeyLoadError(s,Er.KEY_LOAD_ERROR,new Error("after key load, decryptdata unset or changed"),d))},onError:function s(e,a,n,d){r.resetLoader(a),i(r.createKeyLoadError(t,Er.KEY_LOAD_ERROR,new Error("HTTP Error "+e.code+" loading key "+e.text),n,p({url:o.url,data:void 0},e)))},onTimeout:function d(e,a,n){r.resetLoader(a),i(r.createKeyLoadError(t,Er.KEY_LOAD_TIMEOUT,new Error("key loading timed out"),n))},onAbort:function d(e,a,n){r.resetLoader(a),i(r.createKeyLoadError(t,Er.INTERNAL_ABORTED,new Error("key loading aborted"),n))}};d.load(o,l,u)})},t.resetLoader=function t(e){var a=e.frag,r=e.keyInfo,n=e.url,i=r.loader;a.keyLoader===i&&(a.keyLoader=null,r.loader=null),delete this.keyUriToKeyInfo[n],i&&i.destroy()},e}(),Bn=function(){function e(){this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}var t=e.prototype;return t.destroy=function e(){this.onHandlerDestroying(),this.onHandlerDestroyed()},t.onHandlerDestroying=function e(){this.clearNextTick(),this.clearInterval()},t.onHandlerDestroyed=function e(){},t.hasInterval=function e(){return!!this._tickInterval},t.hasNextTick=function e(){return!!this._tickTimer},t.setInterval=function t(e){return!this._tickInterval&&(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,e),!0)},t.clearInterval=function e(){return!!this._tickInterval&&(self.clearInterval(this._tickInterval),this._tickInterval=null,!0)},t.clearNextTick=function e(){return!!this._tickTimer&&(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0)},t.tick=function e(){this._tickCallCount++,1===this._tickCallCount&&(this.doTick(),1<this._tickCallCount&&this.tickImmediate(),this._tickCallCount=0)},t.tickImmediate=function e(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)},t.doTick=function e(){},e}(),Un={length:0,start:function e(){return 0},end:function e(){return 0}},Gn=function(){function e(){}return e.isBuffered=function r(t,a){try{if(t)for(var n=e.getBuffered(t),d=0;d<n.length;d++)if(a>=n.start(d)&&a<=n.end(d))return!0}catch(e){}return!1},e.bufferInfo=function n(t,a,r){try{if(t){var d=e.getBuffered(t),o=[],s;for(s=0;s<d.length;s++)o.push({start:d.start(s),end:d.end(s)});return this.bufferedInfo(o,a,r)}}catch(e){}return{len:0,start:a,end:a,nextStart:void 0}},e.bufferedInfo=function r(e,t,a){t=f(0,t),e.sort(function(e,t){var a=e.start-t.start;return a?a:t.end-e.end});var n=[];if(a){for(var d=0,o;d<e.length;d++)if(o=n.length,o){var s=n[o-1].end;e[d].start-s<a?e[d].end>s&&(n[o-1].end=e[d].end):n.push(e[d])}else n.push(e[d]);}else n=e;for(var l=0,u=t,c=t,g=0,m;g<n.length;g++){var p=n[g].start,y=n[g].end;if(t+a>=p&&t<y)u=p,c=y,l=c-t;else if(t+a<p){m=p;break}}return{len:l,start:u||0,end:c||0,nextStart:m}},e.getBuffered=function t(e){try{return e.buffered}catch(t){return Ar.log("failed to get media.buffered",t),Un}},e}(),Kn=function d(e,t,a,r,n,i){void 0===r&&(r=0),void 0===n&&(n=-1),void 0===i&&(i=!1),this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=kt(),this.buffering={audio:kt(),video:kt(),audiovideo:kt()},this.level=e,this.sn=t,this.id=a,this.size=r,this.part=n,this.partial=i},Hn=function(){function e(e,t){this.subtle=void 0,this.aesIV=void 0,this.subtle=e,this.aesIV=t}var t=e.prototype;return t.decrypt=function a(e,t){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},t,e)},e}(),Vn=function(){function e(e,t){this.subtle=void 0,this.key=void 0,this.subtle=e,this.key=t}var t=e.prototype;return t.expandKey=function e(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])},e}(),Wn=function(){function e(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}var t=e.prototype;return t.uint8ArrayToUint32Array_=function t(e){for(var a=new DataView(e),r=new Uint32Array(4),n=0;4>n;n++)r[n]=a.getUint32(4*n);return r},t.initTable=function e(){var a=this.sBox,r=this.invSBox,n=this.subMix,o=n[0],s=n[1],l=n[2],u=n[3],c=this.invSubMix,f=c[0],g=c[1],m=c[2],p=c[3],y=new Uint32Array(256),d=0,T=0,h=0;for(h=0;256>h;h++)y[h]=128>h?h<<1:283^h<<1;for(h=0;256>h;h++){var E=T^T<<1^T<<2^T<<3^T<<4;E=99^(E>>>8^255&E),a[d]=E,r[E]=d;var S=y[d],L=y[S],R=y[L],A=257*y[E]^16843008*E;o[d]=A<<24|A>>>8,s[d]=A<<16|A>>>16,l[d]=A<<8|A>>>24,u[d]=A,A=16843009*R^65537*L^257*S^16843008*d,f[E]=A<<24|A>>>8,g[E]=A<<16|A>>>16,m[E]=A<<8|A>>>24,p[E]=A,d?(d=S^y[y[y[R^S]]],T^=y[y[T]]):d=T=1}},t.expandKey=function a(e){for(var r=this.uint8ArrayToUint32Array_(e),n=!0,i=0;i<r.length&&n;)n=r[i]===this.key[i],i++;if(!n){this.key=r;var d=this.keySize=r.length;if(4!==d&&6!==d&&8!==d)throw new Error("Invalid aes key size="+d);var o=this.ksRows=4*(d+6+1),s=this.keySchedule=new Uint32Array(o),l=this.invKeySchedule=new Uint32Array(o),u=this.sBox,c=this.rcon,f=this.invSubMix,g=f[0],m=f[1],p=f[2],y=f[3],T,h,E,S;for(T=0;T<o;T++){if(T<d){E=s[T]=r[T];continue}S=E,0==T%d?(S=S<<8|S>>>24,S=u[S>>>24]<<24|u[255&S>>>16]<<16|u[255&S>>>8]<<8|u[255&S],S^=c[0|T/d]<<24):6<d&&4==T%d&&(S=u[S>>>24]<<24|u[255&S>>>16]<<16|u[255&S>>>8]<<8|u[255&S]),s[T]=E=(s[T-d]^S)>>>0}for(h=0;h<o;h++)T=o-h,S=3&h?s[T]:s[T-4],l[h]=4>h||4>=T?S:g[u[S>>>24]]^m[u[255&S>>>16]]^p[u[255&S>>>8]]^y[u[255&S]],l[h]>>>=0}},t.networkToHostOrderSwap=function t(e){return e<<24|(65280&e)<<8|(16711680&e)>>8|e>>>24},t.decrypt=function r(e,t,a){for(var n=this.keySize+6,d=this.invKeySchedule,o=this.invSBox,s=this.invSubMix,l=s[0],u=s[1],c=s[2],f=s[3],g=this.uint8ArrayToUint32Array_(a),m=g[0],p=g[1],y=g[2],T=g[3],h=new Int32Array(e),E=new Int32Array(h.length),S=this.networkToHostOrderSwap,L,R,A,v,I,D,k,_,b,C,P,x,F,O;t<h.length;){for(b=S(h[t]),C=S(h[t+1]),P=S(h[t+2]),x=S(h[t+3]),I=b^d[0],D=x^d[1],k=P^d[2],_=C^d[3],F=4,O=1;O<n;O++)L=l[I>>>24]^u[255&D>>16]^c[255&k>>8]^f[255&_]^d[F],R=l[D>>>24]^u[255&k>>16]^c[255&_>>8]^f[255&I]^d[F+1],A=l[k>>>24]^u[255&_>>16]^c[255&I>>8]^f[255&D]^d[F+2],v=l[_>>>24]^u[255&I>>16]^c[255&D>>8]^f[255&k]^d[F+3],I=L,D=R,k=A,_=v,F+=4;L=o[I>>>24]<<24^o[255&D>>16]<<16^o[255&k>>8]<<8^o[255&_]^d[F],R=o[D>>>24]<<24^o[255&k>>16]<<16^o[255&_>>8]<<8^o[255&I]^d[F+1],A=o[k>>>24]<<24^o[255&_>>16]<<16^o[255&I>>8]<<8^o[255&D]^d[F+2],v=o[_>>>24]<<24^o[255&I>>16]<<16^o[255&D>>8]<<8^o[255&k]^d[F+3],E[t]=S(L^m),E[t+1]=S(v^p),E[t+2]=S(A^y),E[t+3]=S(R^T),m=b,p=C,y=P,T=x,t+=4}return E.buffer},e}(),Yn=function(){function e(e,t){var a=void 0===t?{}:t,r=a.removePKCS7Padding,n=void 0===r||r;if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.useSoftware=e.enableSoftwareAES,this.removePKCS7Padding=n,n)try{var i=self.crypto;i&&(this.subtle=i.subtle||i.webkitSubtle)}catch(t){}null===this.subtle&&(this.useSoftware=!0)}var t=e.prototype;return t.destroy=function e(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null},t.isSync=function e(){return this.useSoftware},t.flush=function e(){var t=this.currentResult,a=this.remainderData;if(!t||a)return this.reset(),null;var r=new Uint8Array(t);return this.reset(),this.removePKCS7Padding?wt(r):r},t.reset=function e(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)},t.decrypt=function r(e,t,a){var n=this;return this.useSoftware?new Promise(function(r,i){n.softwareDecrypt(new Uint8Array(e),t,a);var d=n.flush();d?r(d.buffer):i(new Error("[softwareDecrypt] Failed to decrypt data"))}):this.webCryptoDecrypt(new Uint8Array(e),t,a)},t.softwareDecrypt=function r(e,t,a){var n=this.currentIV,i=this.currentResult,d=this.remainderData;this.logOnce("JS AES decrypt"),d&&(e=fe(d,e),this.remainderData=null);var o=this.getValidChunk(e);if(!o.length)return null;n&&(a=n);var s=this.softwareDecrypter;s||(s=this.softwareDecrypter=new Wn),s.expandKey(t);var l=i;return this.currentResult=s.decrypt(o.buffer,0,a),this.currentIV=X(o,-16).buffer,l?l:null},t.webCryptoDecrypt=function r(e,t,a){var n=this,i=this.subtle;return this.key===t&&this.fastAesKey||(this.key=t,this.fastAesKey=new Vn(i,t)),this.fastAesKey.expandKey().then(function(t){if(!i)return Promise.reject(new Error("web crypto not initialized"));n.logOnce("WebCrypto AES decrypt");var r=new Hn(i,new Uint8Array(a));return r.decrypt(e.buffer,t)}).catch(function(r){return Ar.warn("[decrypter]: WebCrypto Error, disable WebCrypto API, "+r.name+": "+r.message),n.onWebCryptoError(e,t,a)})},t.onWebCryptoError=function r(e,t,a){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(e,t,a);var n=this.flush();if(n)return n.buffer;throw new Error("WebCrypto and softwareDecrypt: failed to decrypt data")},t.getValidChunk=function t(e){var a=e,r=e.length-e.length%16;return r!==e.length&&(a=X(e,0,r),this.remainderData=X(e,r)),a},t.logOnce=function t(e){this.logEnabled&&(Ar.log("[decrypter]: "+e),this.logEnabled=!1)},e}(),qn={toString:function t(e){for(var a="",r=e.length,n=0;n<r;n++)a+="["+e.start(n).toFixed(3)+"-"+e.end(n).toFixed(3)+"]";return a}},zn={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS",WAITING_LEVEL:"WAITING_LEVEL"},jn=function(e){function t(t,a,r,n,i){var d;return d=e.call(this)||this,d.hls=void 0,d.fragPrevious=null,d.fragCurrent=null,d.fragmentTracker=void 0,d.transmuxer=null,d._state=zn.STOPPED,d.playlistType=void 0,d.media=null,d.mediaBuffer=null,d.config=void 0,d.bitrateTest=!1,d.lastCurrentTime=0,d.nextLoadPosition=0,d.startPosition=0,d.startTimeOffset=null,d.loadedmetadata=!1,d.retryDate=0,d.levels=null,d.fragmentLoader=void 0,d.keyLoader=void 0,d.levelLastLoaded=null,d.startFragRequested=!1,d.decrypter=void 0,d.initPTS=[],d.onvseeking=null,d.onvended=null,d.logPrefix="",d.log=void 0,d.warn=void 0,d.playlistType=i,d.logPrefix=n,d.log=Ar.log.bind(Ar,n+":"),d.warn=Ar.warn.bind(Ar,n+":"),d.hls=t,d.fragmentLoader=new Nn(t.config),d.keyLoader=r,d.fragmentTracker=a,d.config=t.config,d.decrypter=new Yn(t.config),t.on(Tr.MANIFEST_LOADED,d.onManifestLoaded,k(d)),d}S(t,e);var a=t.prototype;return a.doTick=function e(){this.onTickEnd()},a.onTickEnd=function e(){},a.startLoad=function t(e){},a.stopLoad=function e(){this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);var t=this.fragCurrent;null!=t&&t.loader&&(t.abortRequests(),this.fragmentTracker.removeFragment(t)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=zn.STOPPED},a._streamEnded=function a(e,t){if(t.live||e.nextStart||!e.end||!this.media)return!1;var r=t.partList;if(null!=r&&r.length){var n=r[r.length-1],i=Gn.isBuffered(this.media,n.start+n.duration/2);return i}var d=t.fragments[t.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(d)},a.getLevelDetails=function e(){if(this.levels&&null!==this.levelLastLoaded){var t;return null==(t=this.levels[this.levelLastLoaded])?void 0:t.details}},a.onMediaAttached=function a(e,t){var r=this.media=this.mediaBuffer=t.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvended=this.onMediaEnded.bind(this),r.addEventListener("seeking",this.onvseeking),r.addEventListener("ended",this.onvended);var n=this.config;this.levels&&n.autoStartLoad&&this.state===zn.STOPPED&&this.startLoad(n.startPosition)},a.onMediaDetaching=function e(){var t=this.media;null!=t&&t.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),t&&this.onvseeking&&this.onvended&&(t.removeEventListener("seeking",this.onvseeking),t.removeEventListener("ended",this.onvended),this.onvseeking=this.onvended=null),this.keyLoader&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loadedmetadata=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()},a.onMediaSeeking=function e(){var t=this.config,a=this.fragCurrent,r=this.media,n=this.mediaBuffer,i=this.state,d=r?r.currentTime:0,o=Gn.bufferInfo(n?n:r,d,t.maxBufferHole);if(this.log("media seeking to "+(yr(d)?d.toFixed(3):d)+", state: "+i),this.state===zn.ENDED)this.resetLoadingState();else if(a){var s=t.maxFragLookUpTolerance,l=a.start-s,u=a.start+a.duration+s;if(!o.len||u<o.start||l>o.end){var c=d>u;(d<l||c)&&(c&&a.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),a.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}r&&(this.fragmentTracker.removeFragmentsInRange(d,1/0,this.playlistType,!0),this.lastCurrentTime=d),this.loadedmetadata||o.len||(this.nextLoadPosition=this.startPosition=d),this.tickImmediate()},a.onMediaEnded=function e(){this.startPosition=this.lastCurrentTime=0},a.onManifestLoaded=function a(e,t){this.startTimeOffset=t.startTimeOffset,this.initPTS=[]},a.onHandlerDestroying=function t(){this.stopLoad(),e.prototype.onHandlerDestroying.call(this)},a.onHandlerDestroyed=function t(){this.state=zn.STOPPED,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,e.prototype.onHandlerDestroyed.call(this)},a.loadFragment=function r(e,t,a){this._loadFragForPlayback(e,t,a)},a._loadFragForPlayback=function r(e,t,a){var n=this,i=function a(t){return n.fragContextChanged(e)?(n.warn("Fragment "+e.sn+(t.part?" p: "+t.part.index:"")+" of level "+e.level+" was dropped during download."),void n.fragmentTracker.removeFragment(e)):void(e.stats.chunkCount++,n._handleFragmentLoadProgress(t))};this._doFragLoad(e,t,a,i).then(function(t){if(t){var a=n.state;return n.fragContextChanged(e)?void(a!==zn.FRAG_LOADING&&(n.fragCurrent||a!==zn.PARSING)||(n.fragmentTracker.removeFragment(e),n.state=zn.IDLE)):void("payload"in t&&(n.log("Loaded fragment "+e.sn+" of level "+e.level),n.hls.trigger(Tr.FRAG_LOADED,t)),n._handleFragmentLoadComplete(t))}}).catch(function(t){n.state===zn.STOPPED||n.state===zn.ERROR||(n.warn(t),n.resetFragmentLoading(e))})},a.clearTrackerIfNeeded=function t(e){var a=this.fragmentTracker,r=a.getState(e),n;if(r===xn.APPENDING){var i=e.type,d=this.getFwdBufferInfo(this.mediaBuffer,i),o=f(e.duration,d?d.len:this.config.maxBufferLength);this.reduceMaxBufferLength(o)&&a.removeFragment(e)}else 0===(null==(n=this.mediaBuffer)?void 0:n.buffered.length)?a.removeAllFragments():a.hasParts(e.type)&&(a.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type}),a.getState(e)===xn.PARTIAL&&a.removeFragment(e))},a.checkLiveUpdate=function t(e){if(e.updated&&!e.live){var a=e.fragments[e.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:a,part:null,stats:a.stats,id:a.type})}e.fragments[0]||(e.deltaUpdateFailed=!0)},a.flushMainBuffer=function r(e,t,a){if(void 0===a&&(a=null),!!(e-t)){var n={startOffset:e,endOffset:t,type:a};this.hls.trigger(Tr.BUFFER_FLUSHING,n)}},a._loadInitSegment=function a(e,t){var r=this;this._doFragLoad(e,t).then(function(t){if(!t||r.fragContextChanged(e)||!r.levels)throw new Error("init load aborted");return t}).then(function(t){var a=r.hls,n=t.payload,i=e.decryptdata;if(n&&0<n.byteLength&&i&&i.key&&i.iv&&"AES-128"===i.method){var d=self.performance.now();return r.decrypter.decrypt(new Uint8Array(n),i.key.buffer,i.iv.buffer).catch(function(t){throw a.trigger(Tr.ERROR,{type:hr.MEDIA_ERROR,details:Er.FRAG_DECRYPT_ERROR,fatal:!1,error:t,reason:t.message,frag:e}),t}).then(function(r){var n=self.performance.now();return a.trigger(Tr.FRAG_DECRYPTED,{frag:e,payload:r,stats:{tstart:d,tdecrypt:n}}),t.payload=r,t})}return t}).then(function(a){var n=r.fragCurrent,i=r.hls,d=r.levels;if(!d)throw new Error("init load aborted, missing levels");var o=e.stats;r.state=zn.IDLE,t.fragmentError=0,e.data=new Uint8Array(a.payload),o.parsing.start=o.buffering.start=self.performance.now(),o.parsing.end=o.buffering.end=self.performance.now(),a.frag===n&&i.trigger(Tr.FRAG_BUFFERED,{stats:o,frag:n,part:null,id:e.type}),r.tick()}).catch(function(t){r.state===zn.STOPPED||r.state===zn.ERROR||(r.warn(t),r.resetFragmentLoading(e))})},a.fragContextChanged=function t(e){var a=this.fragCurrent;return!e||!a||e.level!==a.level||e.sn!==a.sn||e.urlId!==a.urlId},a.fragBufferedComplete=function a(e,t){var r=this.mediaBuffer?this.mediaBuffer:this.media,n,i,d,o;this.log("Buffered "+e.type+" sn: "+e.sn+(t?" part: "+t.index:"")+" of "+(this.playlistType===yn.MAIN?"level":"track")+" "+e.level+" (frag:["+(null==(n=e.startPTS)?NaN:n).toFixed(3)+"-"+(null==(i=e.endPTS)?NaN:i).toFixed(3)+"] > buffer:"+(r?qn.toString(Gn.getBuffered(r)):"(detached)")+")"),this.state=zn.IDLE,r&&(!this.loadedmetadata&&e.type==yn.MAIN&&r.buffered.length&&(null==(d=this.fragCurrent)?void 0:d.sn)===(null==(o=this.fragPrevious)?void 0:o.sn)&&(this.loadedmetadata=!0,this.seekToStartPos()),this.tick())},a.seekToStartPos=function e(){},a._handleFragmentLoadComplete=function t(e){var a=this.transmuxer;if(a){var r=e.frag,n=e.part,i=e.partsLoaded,d=!i||0===i.length||i.some(function(e){return!e}),o=new Kn(r.level,r.sn,r.stats.chunkCount+1,0,n?n.index:-1,!d);a.flush(o)}},a._handleFragmentLoadProgress=function t(e){},a._doFragLoad=function n(e,t,a,r){var i=this,d;void 0===a&&(a=null);var o=null==t?void 0:t.details;if(!this.levels||!o)throw new Error("frag load aborted, missing level"+(o?"":" detail")+"s");var s=null;if(e.encrypted&&!(null!=(d=e.decryptdata)&&d.key)?(this.log("Loading key for "+e.sn+" of ["+o.startSN+"-"+o.endSN+"], "+("[stream-controller]"===this.logPrefix?"level":"track")+" "+e.level),this.state=zn.KEY_LOADING,this.fragCurrent=e,s=this.keyLoader.load(e).then(function(e){if(!i.fragContextChanged(e.frag))return i.hls.trigger(Tr.KEY_LOADED,e),i.state===zn.KEY_LOADING&&(i.state=zn.IDLE),e}),this.hls.trigger(Tr.KEY_LOADING,{frag:e}),null===this.fragCurrent&&(s=Promise.reject(new Error("frag load aborted, context changed in KEY_LOADING")))):!e.encrypted&&o.encryptedFragments.length&&this.keyLoader.loadClear(e,o.encryptedFragments),a=f(e.start,a||0),this.config.lowLatencyMode&&"initSegment"!==e.sn){var l=o.partList;if(l&&r){a>e.end&&o.fragmentHint&&(e=o.fragmentHint);var u=this.getNextPart(l,e,a);if(-1<u){var c=l[u];this.log("Loading part sn: "+e.sn+" p: "+c.index+" cc: "+e.cc+" of playlist ["+o.startSN+"-"+o.endSN+"] parts [0-"+u+"-"+(l.length-1)+"] "+("[stream-controller]"===this.logPrefix?"level":"track")+": "+e.level+", target: "+parseFloat(a.toFixed(3))),this.nextLoadPosition=c.start+c.duration,this.state=zn.FRAG_LOADING;var g;return g=s?s.then(function(a){return!a||i.fragContextChanged(a.frag)?null:i.doFragPartsLoad(e,c,t,r)}).catch(function(e){return i.handleFragLoadError(e)}):this.doFragPartsLoad(e,c,t,r).catch(function(e){return i.handleFragLoadError(e)}),this.hls.trigger(Tr.FRAG_LOADING,{frag:e,part:c,targetBufferTime:a}),null===this.fragCurrent?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts")):g}if(!e.url||this.loadedEndOfParts(l,a))return Promise.resolve(null)}}this.log("Loading fragment "+e.sn+" cc: "+e.cc+" "+(o?"of ["+o.startSN+"-"+o.endSN+"] ":"")+("[stream-controller]"===this.logPrefix?"level":"track")+": "+e.level+", target: "+parseFloat(a.toFixed(3))),yr(e.sn)&&!this.bitrateTest&&(this.nextLoadPosition=e.start+e.duration),this.state=zn.FRAG_LOADING;var m=this.config.progressive,p;return p=m&&s?s.then(function(t){return!t||i.fragContextChanged(null==t?void 0:t.frag)?null:i.fragmentLoader.load(e,r)}).catch(function(e){return i.handleFragLoadError(e)}):Promise.all([this.fragmentLoader.load(e,m?r:void 0),s]).then(function(e){var t=e[0];return!m&&t&&r&&r(t),t}).catch(function(e){return i.handleFragLoadError(e)}),this.hls.trigger(Tr.FRAG_LOADING,{frag:e,targetBufferTime:a}),null===this.fragCurrent?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING")):p},a.doFragPartsLoad=function n(e,t,a,r){var i=this;return new Promise(function(n,d){var o=[],s=null==(u=a.details)?void 0:u.partList,l=function l(t){i.fragmentLoader.loadPart(e,t,r).then(function(r){o[t.index]=r;var d=r.part;i.hls.trigger(Tr.FRAG_LOADED,r);var u=ot(a,e.sn,t.index+1)||st(s,e.sn,t.index+1);return u?void l(u):n({frag:e,part:d,partsLoaded:o})}).catch(d)},u;l(t)})},a.handleFragLoadError=function t(e){if("data"in e){var a=e.data;e.data&&a.details===Er.INTERNAL_ABORTED?this.handleFragLoadAborted(a.frag,a.part):this.hls.trigger(Tr.ERROR,a)}else this.hls.trigger(Tr.ERROR,{type:hr.OTHER_ERROR,details:Er.INTERNAL_EXCEPTION,err:e,error:e,fatal:!0});return null},a._handleTransmuxerFlush=function t(e){var a=this.getCurrentContext(e);if(!a||this.state!==zn.PARSING)return void(this.fragCurrent||this.state===zn.STOPPED||this.state===zn.ERROR||(this.state=zn.IDLE));var r=a.frag,n=a.part,i=a.level,d=self.performance.now();r.stats.parsing.end=d,n&&(n.stats.parsing.end=d),this.updateLevelTiming(r,n,i,e.partial)},a.getCurrentContext=function t(e){var a=this.levels,r=this.fragCurrent,n=e.level,i=e.sn,d=e.part;if(!(null!=a&&a[n]))return this.warn("Levels object was unset while buffering fragment "+i+" of level "+n+". The current chunk will not be buffered."),null;var o=a[n],s=-1<d?ot(o,i,d):null,l=s?s.fragment:dt(o,i,r);return l?(r&&r!==l&&(l.stats=r.stats),{frag:l,part:s,level:o}):null},a.bufferFragmentData=function i(e,t,a,r,n){var d;if(e&&this.state===zn.PARSING){var o=e.data1,s=e.data2,l=o;if(o&&s&&(l=fe(o,s)),!!(null!=(d=l)&&d.length)){var u={type:e.type,frag:t,part:a,chunkMeta:r,parent:t.type,data:l};if(this.hls.trigger(Tr.BUFFER_APPENDING,u),e.dropped&&e.independent&&!a){if(n)return;this.flushBufferGap(t)}}}},a.flushBufferGap=function t(e){var a=this.media;if(a){if(!Gn.isBuffered(a,a.currentTime))return void this.flushMainBuffer(0,e.start);var r=a.currentTime,n=Gn.bufferInfo(a,r,0),i=e.duration,d=o(2*this.config.maxFragLookUpTolerance,.25*i),s=f(o(e.start-d,n.end-d),r+d);e.start-s>d&&this.flushMainBuffer(s,e.start)}},a.getFwdBufferInfo=function a(e,t){var r=this.getLoadPosition();return yr(r)?this.getFwdBufferInfoAtPos(e,r,t):null},a.getFwdBufferInfoAtPos=function r(e,t,a){var n=this.config.maxBufferHole,i=Gn.bufferInfo(e,t,n);if(0===i.len&&void 0!==i.nextStart){var d=this.fragmentTracker.getBufferedFrag(t,a);if(d&&i.nextStart<d.end)return Gn.bufferInfo(e,t,f(i.nextStart,n))}return i},a.getMaxBufferLength=function t(e){var a=this.config,r;return r=e?f(8*a.maxBufferSize/e,a.maxBufferLength):a.maxBufferLength,o(r,a.maxMaxBufferLength)},a.reduceMaxBufferLength=function t(e){var a=this.config,r=e||a.maxBufferLength;return!!(a.maxMaxBufferLength>=r)&&(a.maxMaxBufferLength/=2,this.warn("Reduce max buffer length to "+a.maxMaxBufferLength+"s"),!0)},a.getAppendedFrag=function a(e,t){var r=this.fragmentTracker.getAppendedFrag(e,yn.MAIN);return r&&"fragment"in r?r.fragment:r},a.getNextFragment=function a(e,t){var r=t.fragments,n=r.length;if(!n)return null;var i=this.config,d=r[0].start,o;if(t.live){var s=i.initialLiveManifestSize;if(n<s)return this.warn("Not enough fragments to start playback (have: "+n+", need: "+s+")"),null;t.PTSKnown||this.startFragRequested||-1!==this.startPosition||(o=this.getInitialLiveFragment(t,r),this.startPosition=o?this.hls.liveSyncPosition||o.start:e)}else e<=d&&(o=r[0]);if(!o){var l=i.lowLatencyMode?t.partEnd:t.fragmentEnd;o=this.getFragmentAtPosition(e,l,t)}return this.mapToInitFragWhenRequired(o)},a.isLoopLoading=function a(e,t){var r=this.fragmentTracker.getState(e);return(r===xn.OK||r===xn.PARTIAL&&!!e.gap)&&this.nextLoadPosition>t},a.getNextFragmentLoopLoading=function i(e,t,a,r,n){var d=e.gap,o=this.getNextFragment(this.nextLoadPosition,t);if(null===o)return o;if(e=o,d&&e&&!e.gap&&a.nextStart){var s=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,a.nextStart,r);if(null!==s&&a.len+s.len>=n)return this.log("buffer full after gaps in \""+r+"\" playlist starting at sn: "+e.sn),null}return e},a.mapToInitFragWhenRequired=function t(e){return null==e||!e.initSegment||null!=e&&e.initSegment.data||this.bitrateTest?e:e.initSegment},a.getNextPart=function r(e,t,a){for(var n=-1,d=!1,o=!0,s=0,l=e.length,u,c;s<l&&(u=e[s],o=o&&!u.independent,!(-1<n&&a<u.start));s++)c=u.loaded,c?n=-1:(d||u.independent||o)&&u.fragment===t&&(n=s),d=c;return n},a.loadedEndOfParts=function a(e,t){var r=e[e.length-1];return r&&t>r.start&&r.loaded},a.getInitialLiveFragment=function a(e,t){var r=this.fragPrevious,n=null;if(!r){var i=this.hls.liveSyncPosition;null!==i&&(n=this.getFragmentAtPosition(i,this.bitrateTest?e.fragmentEnd:e.edge,e))}else if(e.hasProgramDateTime&&(this.log("Live playlist, switching playlist, load frag with same PDT: "+r.programDateTime),n=pt(t,r.endProgramDateTime,this.config.maxFragLookUpTolerance)),!n){var d=r.sn+1;if(d>=e.startSN&&d<=e.endSN){var o=t[d-e.startSN];r.cc===o.cc&&(n=o,this.log("Live playlist, switching playlist, load frag with next SN: "+n.sn))}n||(n=Et(t,r.cc),n&&this.log("Live playlist, switching playlist, load frag with same CC: "+n.sn))}return n},a.getFragmentAtPosition=function r(e,t,a){var n=this.config,i=this.fragPrevious,d=a.fragments,o=a.endSN,s=a.fragmentHint,l=n.maxFragLookUpTolerance,u=a.partList,c=!!(n.lowLatencyMode&&null!=u&&u.length&&s);c&&s&&!this.bitrateTest&&(d=d.concat(s),o=s.sn);var f;if(e<t){var g=e>t-l?0:l;f=yt(i,d,e,g)}else f=d[d.length-1];if(f){var m=f.sn-a.startSN,p=this.fragmentTracker.getState(f);if((p===xn.OK||p===xn.PARTIAL&&f.gap)&&(i=f),i&&f.sn===i.sn&&(!c||u[0].fragment.sn>f.sn)){var y=i&&f.level===i.level;if(y){var T=d[m+1];f=f.sn<o&&this.fragmentTracker.getState(T)!==xn.OK?T:null}}}return f},a.synchronizeToLiveEdge=function t(e){var a=this.config,r=this.media;if(r){var n=this.hls.liveSyncPosition,i=r.currentTime,d=e.fragments[0].start,o=e.edge,s=i>=d-a.maxFragLookUpTolerance&&i<=o;if(null!==n&&r.duration>n&&(i<n||!s)){var l=void 0===a.liveMaxLatencyDuration?a.liveMaxLatencyDurationCount*e.targetduration:a.liveMaxLatencyDuration;(!s&&4>r.readyState||i<o-l)&&(!this.loadedmetadata&&(this.nextLoadPosition=n),r.readyState&&(this.warn("Playback: "+i.toFixed(3)+" is located too far from the end of live sliding playlist: "+o+", reset currentTime to : "+n.toFixed(3)),r.currentTime=n))}}},a.alignPlaylists=function a(e,t){var r=this.levels,n=this.levelLastLoaded,i=this.fragPrevious,d=null===n?null:r[n],o=e.fragments.length;if(!o)return this.warn("No fragments in live playlist"),0;var s=e.fragments[0].start,l=!t,u=e.alignedSliding&&yr(s);if(l||!u&&!s){Ft(i,d,e);var c=e.fragments[0].start;return this.log("Live playlist sliding: "+c.toFixed(2)+" start-sn: "+(t?t.startSN:"na")+"->"+e.startSN+" prev-sn: "+(i?i.sn:"na")+" fragments: "+o),c}return s},a.waitForCdnTuneIn=function t(e){var a=3;return e.live&&e.canBlockReload&&e.partTarget&&e.tuneInGoal>f(e.partHoldBack,3*e.partTarget)},a.setStartPosition=function a(e,t){var r=this.startPosition;if(r<t&&(r=-1),-1===r||-1===this.lastCurrentTime){var n=null!==this.startTimeOffset,i=n?this.startTimeOffset:e.startTimeOffset;null!==i&&yr(i)?(r=t+i,0>i&&(r+=e.totalduration),r=o(f(t,r),t+e.totalduration),this.log("Start time offset "+i+" found in "+(n?"multivariant":"media")+" playlist, adjust startPosition to "+r),this.startPosition=r):e.live?r=this.hls.liveSyncPosition||t:this.startPosition=r=0,this.lastCurrentTime=r}this.nextLoadPosition=r},a.getLoadPosition=function e(){var t=this.media,a=0;return this.loadedmetadata&&t?a=t.currentTime:this.nextLoadPosition&&(a=this.nextLoadPosition),a},a.handleFragLoadAborted=function a(e,t){this.transmuxer&&"initSegment"!==e.sn&&e.stats.aborted&&(this.warn("Fragment "+e.sn+(t?" part "+t.index:"")+" of level "+e.level+" was aborted"),this.resetFragmentLoading(e))},a.resetFragmentLoading=function t(e){this.fragCurrent&&(this.fragContextChanged(e)||this.state===zn.FRAG_LOADING_WAITING_RETRY)||(this.state=zn.IDLE)},a.onFragmentOrKeyLoadError=function a(e,t){if(t.chunkMeta&&!t.frag){var r=this.getCurrentContext(t.chunkMeta);r&&(t.frag=r.frag)}var n=t.frag;if(n&&n.type===e&&this.levels){if(this.fragContextChanged(n)){var i;return void this.warn("Frag load error must match current frag to retry "+n.url+" > "+(null==(i=this.fragCurrent)?void 0:i.url))}var d=t.details===Er.FRAG_GAP;d&&this.fragmentTracker.fragBuffered(n,!0);var o=t.errorAction,s=o||{},l=s.action,u=s.retryCount,c=void 0===u?0:u,f=s.retryConfig;if(o&&l===kn.RetryRequest&&f){var g;this.resetStartWhenNotLoaded(null==(g=this.levelLastLoaded)?n.level:g);var m=ct(f,c);this.warn("Fragment "+n.sn+" of "+e+" "+n.level+" errored with "+t.details+", retrying loading "+(c+1)+"/"+f.maxNumRetry+" in "+m+"ms"),o.resolved=!0,this.retryDate=self.performance.now()+m,this.state=zn.FRAG_LOADING_WAITING_RETRY}else f&&o?(this.resetFragmentErrors(e),c<f.maxNumRetry?!d&&(o.resolved=!0):Ar.warn(t.details+" reached or exceeded max retry ("+c+")")):this.state=(null==o?void 0:o.action)===kn.SendAlternateToPenaltyBox?zn.WAITING_LEVEL:zn.ERROR;this.tickImmediate()}},a.reduceLengthAndFlushBuffer=function t(e){if(this.state===zn.PARSING||this.state===zn.PARSED){var a=e.parent,r=this.getFwdBufferInfo(this.mediaBuffer,a),n=r&&.5<r.len;n&&this.reduceMaxBufferLength(r.len);var i=!n;return i&&this.warn("Buffer full error while media.currentTime is not buffered, flush "+a+" buffer"),e.frag&&(this.fragmentTracker.removeFragment(e.frag),this.nextLoadPosition=e.frag.start),this.resetLoadingState(),i}return!1},a.resetFragmentErrors=function t(e){e===yn.AUDIO&&(this.fragCurrent=null),this.loadedmetadata||(this.startFragRequested=!1),this.state!==zn.STOPPED&&(this.state=zn.IDLE)},a.afterBufferFlushed=function r(e,t,a){if(e){var n=Gn.getBuffered(e);this.fragmentTracker.detectEvictedFragments(t,n,a),this.state===zn.ENDED&&this.resetLoadingState()}},a.resetLoadingState=function e(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state=zn.IDLE},a.resetStartWhenNotLoaded=function t(e){if(!this.loadedmetadata){this.startFragRequested=!1;var a=this.levels?this.levels[e].details:null;null!=a&&a.live?(this.startPosition=-1,this.setStartPosition(a,0),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}},a.resetWhenMissingContext=function t(e){var a;this.warn("The loading context changed while buffering fragment "+e.sn+" of level "+e.level+". This chunk will not be buffered."),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(null==(a=this.levelLastLoaded)?e.level:a),this.resetLoadingState()},a.removeUnbufferedFrags=function t(e){void 0===e&&(e=0),this.fragmentTracker.removeFragmentsInRange(e,1/0,this.playlistType,!1,!0)},a.updateLevelTiming=function n(e,t,a,r){var i=this,d=a.details,o;if(!d)return void this.warn("level.details undefined");var s=Object.keys(e.elementaryStreams).reduce(function(t,n){var o=e.elementaryStreams[n];if(o){var s=o.endPTS-o.startPTS;if(0>=s)return i.warn("Could not parse fragment "+e.sn+" "+n+" duration reliably ("+s+")"),t||!1;var l=r?0:$e(d,e,o.startPTS,o.endPTS,o.startDTS,o.endDTS);return i.hls.trigger(Tr.LEVEL_PTS_UPDATED,{details:d,level:a,drift:l,type:n,frag:e,start:o.startPTS,end:o.endPTS}),!0}return t},!1);if(s)a.fragmentError=0;else if(null===(null==(o=this.transmuxer)?void 0:o.error)){var l=new Error("Found no media in fragment "+e.sn+" of level "+e.level+" resetting transmuxer to fallback to playlist timing");if(0===a.fragmentError&&(a.fragmentError++,e.gap=!0,this.fragmentTracker.removeFragment(e),this.fragmentTracker.fragBuffered(e,!0)),this.warn(l.message),this.hls.trigger(Tr.ERROR,{type:hr.MEDIA_ERROR,details:Er.FRAG_PARSING_ERROR,fatal:!1,error:l,frag:e,reason:"Found no media in msn "+e.sn+" of level \""+a.url+"\""}),!this.hls)return;this.resetTransmuxer()}this.state=zn.PARSED,this.hls.trigger(Tr.FRAG_PARSED,{frag:e,part:t})},a.resetTransmuxer=function e(){this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null)},a.recoverWorkerError=function t(e){if("demuxerWorker"===e.event){var a,r,n;this.fragmentTracker.removeAllFragments(),this.resetTransmuxer(),this.resetStartWhenNotLoaded(null==(a=null==(r=this.levelLastLoaded)?null==(n=this.fragCurrent)?void 0:n.level:r)?0:a),this.resetLoadingState()}},T(t,[{key:"state",get:function e(){return this._state},set:function t(e){var a=this._state;a!==e&&(this._state=e,this.log(a+"->"+e))}}]),t}(Bn),Xn=function(){function e(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}var t=e.prototype;return t.resetInitSegment=function n(e,t,a,r){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}},t.resetTimeStamp=function t(e){this.initPTS=e,this.resetContiguity()},t.resetContiguity=function e(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0},t.canParse=function a(e,t){return!1},t.appendFrame=function r(e,t,a){},t.demux=function a(e,t){this.cachedData&&(e=fe(this.cachedData,e),this.cachedData=null);var r=Gr(e,0),i=r?r.length:0,d=this._audioTrack,o=this._id3Track,s=r?Vr(r):void 0,l=e.length,u;for((null===this.basePTS||0===this.frameIndex&&yr(s))&&(this.basePTS=Qn(s,t,this.initPTS),this.lastPTS=this.basePTS),null===this.lastPTS&&(this.lastPTS=this.basePTS),r&&0<r.length&&o.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:r,type:hn.audioId3,duration:n});i<l;){if(this.canParse(e,i)){var c=this.appendFrame(d,e,i);c?(this.frameIndex++,this.lastPTS=c.sample.pts,i+=c.length,u=i):i=l}else Hr(e,i)?(r=Gr(e,i),o.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:r,type:hn.audioId3,duration:n}),i+=r.length,u=i):i++;if(i===l&&u!==l){var f=X(e,u);this.cachedData=this.cachedData?fe(this.cachedData,f):f}}return{audioTrack:d,videoTrack:Kt(),id3Track:o,textTrack:Kt()}},t.demuxSampleAes=function r(e,t,a){return Promise.reject(new Error("["+this+"] This demuxer does not support Sample-AES decryption"))},t.flush=function t(e){var a=this.cachedData;return a&&(this.cachedData=null,this.demux(a,0)),{audioTrack:this._audioTrack,videoTrack:Kt(),id3Track:this._id3Track,textTrack:Kt()}},t.destroy=function e(){},e}(),Qn=function r(e,t,a){if(yr(e))return 90*e;var n=a?9e4*a.baseTime/a.timescale:0;return 9e4*t+n},Zn=function(e){function t(t,a){var r;return r=e.call(this)||this,r.observer=void 0,r.config=void 0,r.observer=t,r.config=a,r}S(t,e);var a=t.prototype;return a.resetInitSegment=function i(t,a,r,n){e.prototype.resetInitSegment.call(this,t,a,r,n),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:a,duration:n,inputTimeScale:9e4,dropped:0}},t.probe=function t(e){if(!e)return!1;for(var a=Gr(e,0)||[],r=a.length,n=e.length;r<n;r++)if(Xt(e,r))return Ar.log("ADTS sync word found !"),!0;return!1},a.canParse=function a(e,t){return jt(e,t)},a.appendFrame=function r(e,t,a){Qt(e,this.observer,t,a,e.manifestCodec);var n=Jt(e,t,a,this.basePTS,this.frameIndex);if(n&&0===n.missing)return n},t}(Xn),$n=/\/emsg[-/]ID3/i,Jn=function(){function e(e,t){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=t}var t=e.prototype;return t.resetTimeStamp=function e(){},t.resetInitSegment=function n(e,t,a,r){var i=this.videoTrack=Kt("video",1),d=this.audioTrack=Kt("audio",1),o=this.txtTrack=Kt("text",1);if(this.id3Track=Kt("id3",1),this.timeOffset=0,!!(null!=e&&e.byteLength)){var s=ne(e);if(s.video){var l=s.video,u=l.id,c=l.timescale,f=l.codec;i.id=u,i.timescale=o.timescale=c,i.codec=f}if(s.audio){var g=s.audio,m=g.id,p=g.timescale,y=g.codec;d.id=m,d.timescale=p,d.codec=y}o.id=an.text,i.sampleDuration=0,i.duration=d.duration=r}},t.resetContiguity=function e(){this.remainderData=null},e.probe=function t(e){return e=16384<e.length?e.subarray(0,16384):e,0<ae(e,["moof"]).length},t.demux=function a(e,t){this.timeOffset=t;var r=e,n=this.videoTrack,i=this.txtTrack;if(this.config.progressive){this.remainderData&&(r=fe(this.remainderData,e));var d=ce(r);this.remainderData=d.remainder,n.samples=d.valid||new Uint8Array}else n.samples=r;var o=this.extractID3Track(n,t);return i.samples=ge(t,n),{videoTrack:n,audioTrack:this.audioTrack,id3Track:o,textTrack:this.txtTrack}},t.flush=function e(){var t=this.timeOffset,a=this.videoTrack,r=this.txtTrack;a.samples=this.remainderData||new Uint8Array,this.remainderData=null;var n=this.extractID3Track(a,this.timeOffset);return r.samples=ge(t,a),{videoTrack:a,audioTrack:Kt(),id3Track:n,textTrack:Kt()}},t.extractID3Track=function a(e,t){var r=this.id3Track;if(e.samples.length){var i=ae(e.samples,["emsg"]);i&&i.forEach(function(e){var a=he(e);if($n.test(a.schemeIdUri)){var i=yr(a.presentationTime)?a.presentationTime/a.timeScale:t+a.presentationTimeDelta/a.timeScale,d=4294967295===a.eventDuration?n:a.eventDuration/a.timeScale;.001>=d&&(d=n);var o=a.payload;r.samples.push({data:o,len:o.byteLength,dts:i,pts:i,type:hn.emsg,duration:d})}})}return r},t.demuxSampleAes=function r(e,t,a){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))},t.destroy=function e(){},e}(),ei=null,ti=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],ai=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],ri=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],ni=[0,1,1,4],ii=function(){function e(e){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=e,this.bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}var t=e.prototype;return t.loadWord=function e(){var t=this.data,a=this.bytesAvailable,r=t.byteLength-a,n=new Uint8Array(4),i=o(4,a);if(0===i)throw new Error("no bytes available");n.set(t.subarray(r,r+i)),this.word=new DataView(n.buffer).getUint32(0),this.bitsAvailable=8*i,this.bytesAvailable-=i},t.skipBits=function t(e){var a;e=o(e,8*this.bytesAvailable+this.bitsAvailable),this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(e-=this.bitsAvailable,a=e>>3,e-=a<<3,this.bytesAvailable-=a,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)},t.readBits=function t(e){var a=o(this.bitsAvailable,e),r=this.word>>>32-a;if(32<e&&Ar.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=a,0<this.bitsAvailable)this.word<<=a;else if(0<this.bytesAvailable)this.loadWord();else throw new Error("no bits available");return a=e-a,0<a&&this.bitsAvailable?r<<a|this.readBits(a):r},t.skipLZ=function e(){var t;for(t=0;t<this.bitsAvailable;++t)if(0!=(this.word&2147483648>>>t))return this.word<<=t,this.bitsAvailable-=t,t;return this.loadWord(),t+this.skipLZ()},t.skipUEG=function e(){this.skipBits(1+this.skipLZ())},t.skipEG=function e(){this.skipBits(1+this.skipLZ())},t.readUEG=function e(){var t=this.skipLZ();return this.readBits(t+1)-1},t.readEG=function e(){var t=this.readUEG();return 1&t?1+t>>>1:-1*(t>>>1)},t.readBoolean=function e(){return 1===this.readBits(1)},t.readUByte=function e(){return this.readBits(8)},t.readUShort=function e(){return this.readBits(16)},t.readUInt=function e(){return this.readBits(32)},t.skipScalingList=function t(e){for(var a=8,r=8,n=0,i;n<e;n++)0!==r&&(i=this.readEG(),r=(a+i+256)%256),a=0===r?a:r},t.readSPS=function e(){var t=0,r=0,n=0,d=0,o=this.readUByte.bind(this),s=this.readBits.bind(this),l=this.readUEG.bind(this),u=this.readBoolean.bind(this),c=this.skipBits.bind(this),f=this.skipEG.bind(this),g=this.skipUEG.bind(this),m=this.skipScalingList.bind(this),p,y,T;o();var h=o();if(s(5),c(3),o(),g(),100===h||110===h||122===h||244===h||44===h||83===h||86===h||118===h||128===h){var E=l();if(3===E&&c(1),g(),g(),c(1),u())for(y=3===E?12:8,T=0;T<y;T++)u()&&(6>T?m(16):m(64))}g();var S=l();if(0===S)l();else if(1===S)for(c(1),f(),f(),p=l(),T=0;T<p;T++)f();g(),c(1);var L=l(),R=l(),A=s(1);0===A&&c(1),c(1),u()&&(t=l(),r=l(),n=l(),d=l());var v=[1,1];if(u()&&u()){var I=o();switch(I){case 1:v=[1,1];break;case 2:v=[12,11];break;case 3:v=[10,11];break;case 4:v=[16,11];break;case 5:v=[40,33];break;case 6:v=[24,11];break;case 7:v=[20,11];break;case 8:v=[32,11];break;case 9:v=[80,33];break;case 10:v=[18,11];break;case 11:v=[15,11];break;case 12:v=[64,33];break;case 13:v=[160,99];break;case 14:v=[4,3];break;case 15:v=[3,2];break;case 16:v=[2,1];break;case 255:{v=[o()<<8|o(),o()<<8|o()];break}}}return{width:a(16*(L+1)-2*t-2*r),height:16*((2-A)*(R+1))-(A?2:4)*(n+d),pixelRatio:v}},t.readSliceType=function e(){return this.readUByte(),this.readUEG(),this.readUEG()},e}(),di=function(){function e(e,t,a){this.keyData=void 0,this.decrypter=void 0,this.keyData=a,this.decrypter=new Yn(t,{removePKCS7Padding:!1})}var t=e.prototype;return t.decryptBuffer=function t(e){return this.decrypter.decrypt(e,this.keyData.key.buffer,this.keyData.iv.buffer)},t.decryptAacSample=function r(e,t,a){var n=this,i=e[t].unit;if(!(16>=i.length)){var d=i.subarray(16,i.length-i.length%16),o=d.buffer.slice(d.byteOffset,d.byteOffset+d.length);this.decryptBuffer(o).then(function(r){var d=new Uint8Array(r);i.set(d,16),n.decrypter.isSync()||n.decryptAacSamples(e,t+1,a)})}},t.decryptAacSamples=function r(e,t,a){for(;;t++){if(t>=e.length)return void a();if(!(32>e[t].unit.length)&&(this.decryptAacSample(e,t,a),!this.decrypter.isSync()))return}},t.getAvcEncryptedData=function t(e){for(var a=16*u((e.length-48)/160)+16,r=new Int8Array(a),n=0,i=32;i<e.length-16;i+=160,n+=16)r.set(e.subarray(i,i+16),n);return r},t.getAvcDecryptedUnit=function a(e,t){for(var r=new Uint8Array(t),n=0,i=32;i<e.length-16;i+=160,n+=16)e.set(r.subarray(n,n+16),i);return e},t.decryptAvcSample=function i(e,t,a,r,n){var d=this,o=Te(n.data),s=this.getAvcEncryptedData(o);this.decryptBuffer(s.buffer).then(function(i){n.data=d.getAvcDecryptedUnit(o,i),d.decrypter.isSync()||d.decryptAvcSamples(e,t,a+1,r)})},t.decryptAvcSamples=function n(e,t,a,r){if(e instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;t++,a=0){if(t>=e.length)return void r();for(var i=e[t].units;;a++){if(a>=i.length)break;var d=i[a];if(!(48>=d.data.length||1!==d.type&&5!==d.type)&&(this.decryptAvcSample(e,t,a,r,d),!this.decrypter.isSync()))return}}},e}(),oi=188,si=function(){function e(e,t,a){this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._duration=0,this._pmtId=-1,this._avcTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.avcSample=null,this.remainderData=null,this.observer=e,this.config=t,this.typeSupported=a}e.probe=function a(t){var r=e.syncOffset(t);return 0<r&&Ar.warn("MPEG2-TS detected but first sync word found @ offset "+r),-1!==r},e.syncOffset=function t(e){for(var a=e.length,r=o(5*oi,e.length-oi)+1,n=0;n<r;){for(var d=!1,s=-1,l=0,u=n;u<a;u+=oi)if(71!==e[u]){if(l)return-1;break}else if(l++,-1===s&&(s=u,0!==s&&(r=o(s+99*oi,e.length-oi)+1)),d||(d=0===oa(e,u)),d&&1<l&&(0===s&&2<l||u+oi>r))return s;n++}return-1},e.createTrack=function a(e,t){return{container:"video"===e||"audio"===e?"video/mp2t":void 0,type:e,id:an[e],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:"audio"===e?t:void 0}};var t=e.prototype;return t.resetInitSegment=function i(t,a,r,n){this.pmtParsed=!1,this._pmtId=-1,this._avcTrack=e.createTrack("video"),this._audioTrack=e.createTrack("audio",n),this._id3Track=e.createTrack("id3"),this._txtTrack=e.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.avcSample=null,this.remainderData=null,this.audioCodec=a,this.videoCodec=r,this._duration=n},t.resetTimeStamp=function e(){},t.resetContiguity=function e(){var t=this._audioTrack,a=this._avcTrack,r=this._id3Track;t&&(t.pesData=null),a&&(a.pesData=null),r&&(r.pesData=null),this.aacOverFlow=null,this.avcSample=null,this.remainderData=null},t.demux=function i(t,a,r,n){void 0===r&&(r=!1),void 0===n&&(n=!1),r||(this.sampleAes=null);var d=this._avcTrack,o=this._audioTrack,s=this._id3Track,l=this._txtTrack,u=d.pid,c=d.pesData,g=o.pid,m=s.pid,p=o.pesData,y=s.pesData,T=null,h=this.pmtParsed,E=this._pmtId,S=t.length,L;if(this.remainderData&&(t=fe(this.remainderData,t),S=t.length,this.remainderData=null),S<oi&&!n)return this.remainderData=t,{audioTrack:o,videoTrack:d,id3Track:s,textTrack:l};var R=f(0,e.syncOffset(t));S-=(S-R)%oi,S<t.byteLength&&!n&&(this.remainderData=new Uint8Array(t.buffer,S,t.buffer.byteLength-S));for(var A=0,v=R;v<S;v+=oi)if(71===t[v]){var I=!!(64&t[v+1]),D=oa(t,v),k=(48&t[v+3])>>4,_=void 0;if(!(1<k))_=v+4;else if(_=v+5+t[v+4],_===v+oi)continue;switch(D){case u:I&&(c&&(L=ua(c))&&this.parseAVCPES(d,l,L,!1),c={data:[],size:0}),c&&(c.data.push(t.subarray(_,v+oi)),c.size+=v+oi-_);break;case g:if(I){if(p&&(L=ua(p)))switch(o.segmentCodec){case"aac":this.parseAACPES(o,L);break;case"mp3":this.parseMPEGPES(o,L)}p={data:[],size:0}}p&&(p.data.push(t.subarray(_,v+oi)),p.size+=v+oi-_);break;case m:I&&(y&&(L=ua(y))&&this.parseID3PES(s,L),y={data:[],size:0}),y&&(y.data.push(t.subarray(_,v+oi)),y.size+=v+oi-_);break;case 0:I&&(_+=t[_]+1),E=this._pmtId=sa(t,_);break;case E:{I&&(_+=t[_]+1);var b=la(t,_,this.typeSupported,r);u=b.avc,0<u&&(d.pid=u),g=b.audio,0<g&&(o.pid=g,o.segmentCodec=b.segmentCodec),m=b.id3,0<m&&(s.pid=m),null===T||h||(Ar.warn("MPEG-TS PMT found at "+v+" after unknown PID '"+T+"'. Backtracking to sync byte @"+R+" to parse all TS packets."),T=null,v=R-188),h=this.pmtParsed=!0;break}case 17:case 8191:break;default:T=D}}else A++;if(0<A){var C=new Error("Found "+A+" TS packet/s that do not start with 0x47");this.observer.emit(Tr.ERROR,Tr.ERROR,{type:hr.MEDIA_ERROR,details:Er.FRAG_PARSING_ERROR,fatal:!1,error:C,reason:C.message})}d.pesData=c,o.pesData=p,s.pesData=y;var P={audioTrack:o,videoTrack:d,id3Track:s,textTrack:l};return n&&this.extractRemainingSamples(P),P},t.flush=function e(){var t=this.remainderData;this.remainderData=null;var a;return a=t?this.demux(t,-1,!1,!0):{videoTrack:this._avcTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(a),this.sampleAes?this.decrypt(a,this.sampleAes):a},t.extractRemainingSamples=function t(e){var a=e.audioTrack,r=e.videoTrack,n=e.id3Track,i=e.textTrack,d=r.pesData,o=a.pesData,s=n.pesData,l;if(d&&(l=ua(d))?(this.parseAVCPES(r,i,l,!0),r.pesData=null):r.pesData=d,o&&(l=ua(o))){switch(a.segmentCodec){case"aac":this.parseAACPES(a,l);break;case"mp3":this.parseMPEGPES(a,l)}a.pesData=null}else null!=o&&o.size&&Ar.log("last AAC PES packet truncated,might overlap between fragments"),a.pesData=o;s&&(l=ua(s))?(this.parseID3PES(n,l),n.pesData=null):n.pesData=s},t.demuxSampleAes=function r(e,t,a){var n=this.demux(e,a,!0,!this.config.progressive),i=this.sampleAes=new di(this.observer,this.config,t);return this.decrypt(n,i)},t.decrypt=function a(e,t){return new Promise(function(a){var r=e.audioTrack,n=e.videoTrack;r.samples&&"aac"===r.segmentCodec?t.decryptAacSamples(r.samples,0,function(){n.samples?t.decryptAvcSamples(n.samples,0,0,function(){a(e)}):a(e)}):n.samples&&t.decryptAvcSamples(n.samples,0,0,function(){a(e)})})},t.destroy=function e(){this._duration=0},t.parseAVCPES=function n(e,t,a,r){var d=this,o=this.parseAVCNALu(e,a.data),s=this.avcSample,l=!1,u;a.data=null,s&&o.length&&!e.audFound&&(ca(s,e),s=this.avcSample=da(!1,a.pts,a.dts,"")),o.forEach(function(r){var n;switch(r.type){case 1:{var o=!1;u=!0;var c=r.data;if(l&&4<c.length){var f=new ii(c).readSliceType();(2===f||4===f||7===f||9===f)&&(o=!0)}if(o){var g;null!=(g=s)&&g.frame&&!s.key&&(ca(s,e),s=d.avcSample=null)}s||(s=d.avcSample=da(!0,a.pts,a.dts,"")),s.frame=!0,s.key=o;break}case 5:u=!0,null!=(n=s)&&n.frame&&!s.key&&(ca(s,e),s=d.avcSample=null),s||(s=d.avcSample=da(!0,a.pts,a.dts,"")),s.key=!0,s.frame=!0;break;case 6:{u=!0,ye(r.data,1,a.pts,t.samples);break}case 7:if(u=!0,l=!0,!e.sps){var m=r.data,p=new ii(m),y=p.readSPS();e.width=y.width,e.height=y.height,e.pixelRatio=y.pixelRatio,e.sps=[m],e.duration=d._duration;for(var T=m.subarray(1,4),E="avc1.",S=0,L;3>S;S++)L=T[S].toString(16),2>L.length&&(L="0"+L),E+=L;e.codec=E}break;case 8:u=!0,e.pps||(e.pps=[r.data]);break;case 9:u=!1,e.audFound=!0,s&&ca(s,e),s=d.avcSample=da(!1,a.pts,a.dts,"");break;case 12:u=!0;break;default:u=!1,s&&(s.debug+="unknown NAL "+r.type+" ")}if(s&&u){var R=s.units;R.push(r)}}),r&&s&&(ca(s,e),this.avcSample=null)},t.getLastNalUnit=function t(e){var a=this.avcSample,r,n;if(a&&0!==a.units.length||(a=e[e.length-1]),null!=(r=a)&&r.units){var i=a.units;n=i[i.length-1]}return n},t.parseAVCNALu=function a(e,t){var r=t.byteLength,n=e.naluState||0,d=n,o=[],s=0,l=-1,u=0,c,f,g;for(-1===n&&(l=0,u=31&t[0],n=0,s=1);s<r;){if(c=t[s++],!n){n=c?0:1;continue}if(1===n){n=c?0:2;continue}if(!c)n=3;else if(1===c){if(0<=l){var m={data:t.subarray(l,s-n-1),type:u};o.push(m)}else{var p=this.getLastNalUnit(e.samples);if(p&&(d&&s<=4-d&&p.state&&(p.data=p.data.subarray(0,p.data.byteLength-d)),f=s-n-1,0<f)){var y=new Uint8Array(p.data.byteLength+f);y.set(p.data,0),y.set(t.subarray(0,f),p.data.byteLength),p.data=y,p.state=0}}s<r?(g=31&t[s],l=s,u=g,n=0):n=-1}else n=0}if(0<=l&&0<=n){var T={data:t.subarray(l,r),type:u,state:n};o.push(T)}if(0===o.length){var h=this.getLastNalUnit(e.samples);if(h){var E=new Uint8Array(h.data.byteLength+t.byteLength);E.set(h.data,0),E.set(t,h.data.byteLength),h.data=E}}return e.naluState=n,o},t.parseAACPES=function a(e,t){var r=0,n=this.aacOverFlow,i=t.data;if(n){this.aacOverFlow=null;var d=n.missing,o=n.sample.unit.byteLength;if(-1===d){var s=new Uint8Array(o+i.byteLength);s.set(n.sample.unit,0),s.set(i,o),i=s}else{var l=o-d;n.sample.unit.set(i.subarray(0,d),l),e.samples.push(n.sample),r=n.missing}}var u,c;for(u=r,c=i.length;u<c-1&&!zt(i,u);u++);if(u!==r){var f=u<c-1,g;g=f?"AAC PES did not start with ADTS header,offset:"+u:"No ADTS header found in AAC PES";var m=new Error(g);if(Ar.warn("parsing error: "+g),this.observer.emit(Tr.ERROR,Tr.ERROR,{type:hr.MEDIA_ERROR,details:Er.FRAG_PARSING_ERROR,fatal:!1,levelRetry:f,error:m,reason:g}),!f)return}Qt(e,this.observer,i,u,this.audioCodec);var p;if(void 0!==t.pts)p=t.pts;else if(n){var y=Zt(e.samplerate);p=n.sample.pts+y}else return void Ar.warn("[tsdemuxer]: AAC PES unknown PTS");for(var T=0,h;u<c;)if(h=Jt(e,i,u,p,T),u+=h.length,!h.missing)for(T++;u<c-1&&!zt(i,u);u++);else{this.aacOverFlow=h;break}},t.parseMPEGPES=function a(e,t){var r=t.data,n=r.length,i=0,d=0,o=t.pts;if(void 0===o)return void Ar.warn("[tsdemuxer]: MPEG PES unknown PTS");for(;d<n;)if(ra(r,d)){var s=ea(e,r,d,o,i);if(s)d+=s.length,i++;else break}else d++},t.parseID3PES=function a(e,t){if(void 0===t.pts)return void Ar.warn("[tsdemuxer]: ID3 PES unknown PTS");var r=E({},t,{type:this._avcTrack?hn.emsg:hn.audioId3,duration:n});e.samples.push(r)},e}(),li=function(e){function t(){return e.apply(this,arguments)||this}S(t,e);var a=t.prototype;return a.resetInitSegment=function i(t,a,r,n){e.prototype.resetInitSegment.call(this,t,a,r,n),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:a,duration:n,inputTimeScale:9e4,dropped:0}},t.probe=function t(e){if(!e)return!1;for(var a=Gr(e,0)||[],r=a.length,n=e.length;r<n;r++)if(ia(e,r))return Ar.log("MPEG Audio sync word found !"),!0;return!1},a.canParse=function a(e,t){return na(e,t)},a.appendFrame=function r(e,t,a){return null===this.basePTS?void 0:ea(e,t,a,this.basePTS,this.frameIndex)},t}(Xn),ui=function(){function e(){}return e.getSilentFrame=function a(e,t){switch(e){case"mp4a.40.2":if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}},e}(),ci=c(2,32)-1,fi=function(){function e(){}return e.init=function t(){e.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};var a;for(a in e.types)e.types.hasOwnProperty(a)&&(e.types[a]=[a.charCodeAt(0),a.charCodeAt(1),a.charCodeAt(2),a.charCodeAt(3)]);var r=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),n=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);e.HDLR_TYPES={video:r,audio:n};var d=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),o=new Uint8Array([0,0,0,0,0,0,0,0]);e.STTS=e.STSC=e.STCO=o,e.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),e.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),e.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),e.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);var s=new Uint8Array([105,115,111,109]),l=new Uint8Array([97,118,99,49]),u=new Uint8Array([0,0,0,1]);e.FTYP=e.box(e.types.ftyp,s,u,s,l),e.DINF=e.box(e.types.dinf,e.box(e.types.dref,d))},e.box=function t(e){for(var a=8,r=arguments.length,n=Array(1<r?r-1:0),d=1;d<r;d++)n[d-1]=arguments[d];for(var o=n.length,s=o;o--;)a+=n[o].byteLength;var l=new Uint8Array(a);for(l[0]=255&a>>24,l[1]=255&a>>16,l[2]=255&a>>8,l[3]=255&a,l.set(e,4),(o=0,a=8);o<s;o++)l.set(n[o],a),a+=n[o].byteLength;return l},e.hdlr=function a(t){return e.box(e.types.hdlr,e.HDLR_TYPES[t])},e.mdat=function a(t){return e.box(e.types.mdat,t)},e.mdhd=function r(t,a){a*=t;var n=u(a/(ci+1)),i=u(a%(ci+1));return e.box(e.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,255&t>>24,255&t>>16,255&t>>8,255&t,n>>24,255&n>>16,255&n>>8,255&n,i>>24,255&i>>16,255&i>>8,255&i,85,196,0,0]))},e.mdia=function a(t){return e.box(e.types.mdia,e.mdhd(t.timescale,t.duration),e.hdlr(t.type),e.minf(t))},e.mfhd=function a(t){return e.box(e.types.mfhd,new Uint8Array([0,0,0,0,t>>24,255&t>>16,255&t>>8,255&t]))},e.minf=function a(t){return"audio"===t.type?e.box(e.types.minf,e.box(e.types.smhd,e.SMHD),e.DINF,e.stbl(t)):e.box(e.types.minf,e.box(e.types.vmhd,e.VMHD),e.DINF,e.stbl(t))},e.moof=function n(t,a,r){return e.box(e.types.moof,e.mfhd(t),e.traf(r,a))},e.moov=function a(t){for(var r=t.length,n=[];r--;)n[r]=e.trak(t[r]);return e.box.apply(null,[e.types.moov,e.mvhd(t[0].timescale,t[0].duration)].concat(n).concat(e.mvex(t)))},e.mvex=function a(t){for(var r=t.length,n=[];r--;)n[r]=e.trex(t[r]);return e.box.apply(null,[e.types.mvex].concat(n))},e.mvhd=function r(t,a){a*=t;var n=u(a/(ci+1)),i=u(a%(ci+1)),d=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,255&t>>24,255&t>>16,255&t>>8,255&t,n>>24,255&n>>16,255&n>>8,255&n,i>>24,255&i>>16,255&i>>8,255&i,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return e.box(e.types.mvhd,d)},e.sdtp=function a(t){var r=t.samples||[],n=new Uint8Array(4+r.length),d,o;for(d=0;d<r.length;d++)o=r[d].flags,n[d+4]=o.dependsOn<<4|o.isDependedOn<<2|o.hasRedundancy;return e.box(e.types.sdtp,n)},e.stbl=function a(t){return e.box(e.types.stbl,e.stsd(t),e.box(e.types.stts,e.STTS),e.box(e.types.stsc,e.STSC),e.box(e.types.stsz,e.STSZ),e.box(e.types.stco,e.STCO))},e.avc1=function a(t){var r=[],n=[],d,o,s;for(d=0;d<t.sps.length;d++)o=t.sps[d],s=o.byteLength,r.push(255&s>>>8),r.push(255&s),r=r.concat(Array.prototype.slice.call(o));for(d=0;d<t.pps.length;d++)o=t.pps[d],s=o.byteLength,n.push(255&s>>>8),n.push(255&s),n=n.concat(Array.prototype.slice.call(o));var l=e.box(e.types.avcC,new Uint8Array([1,r[3],r[4],r[5],255,224|t.sps.length].concat(r).concat([t.pps.length]).concat(n))),u=t.width,c=t.height,f=t.pixelRatio[0],g=t.pixelRatio[1];return e.box(e.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255&u>>8,255&u,255&c>>8,255&c,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),l,e.box(e.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),e.box(e.types.pasp,new Uint8Array([f>>24,255&f>>16,255&f>>8,255&f,g>>24,255&g>>16,255&g>>8,255&g])))},e.esds=function t(e){var a=e.config.length;return new Uint8Array([0,0,0,0,3,23+a,0,1,0,4,15+a,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([a]).concat(e.config).concat([6,1,2]))},e.mp4a=function a(t){var r=t.samplerate;return e.box(e.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channelCount,0,16,0,0,0,0,255&r>>8,255&r,0,0]),e.box(e.types.esds,e.esds(t)))},e.mp3=function a(t){var r=t.samplerate;return e.box(e.types[".mp3"],new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channelCount,0,16,0,0,0,0,255&r>>8,255&r,0,0]))},e.stsd=function a(t){return"audio"===t.type?"mp3"===t.segmentCodec&&"mp3"===t.codec?e.box(e.types.stsd,e.STSD,e.mp3(t)):e.box(e.types.stsd,e.STSD,e.mp4a(t)):e.box(e.types.stsd,e.STSD,e.avc1(t))},e.tkhd=function a(t){var r=t.id,n=t.duration*t.timescale,i=t.width,d=t.height,o=u(n/(ci+1)),s=u(n%(ci+1));return e.box(e.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,255&r>>24,255&r>>16,255&r>>8,255&r,0,0,0,0,o>>24,255&o>>16,255&o>>8,255&o,s>>24,255&s>>16,255&s>>8,255&s,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,255&i>>8,255&i,0,0,255&d>>8,255&d,0,0]))},e.traf=function r(t,a){var n=e.sdtp(t),i=t.id,d=u(a/(ci+1)),o=u(a%(ci+1));return e.box(e.types.traf,e.box(e.types.tfhd,new Uint8Array([0,0,0,0,i>>24,255&i>>16,255&i>>8,255&i])),e.box(e.types.tfdt,new Uint8Array([1,0,0,0,d>>24,255&d>>16,255&d>>8,255&d,o>>24,255&o>>16,255&o>>8,255&o])),e.trun(t,n.length+16+20+8+16+8+8),n)},e.trak=function a(t){return t.duration=t.duration||4294967295,e.box(e.types.trak,e.tkhd(t),e.mdia(t))},e.trex=function a(t){var r=t.id;return e.box(e.types.trex,new Uint8Array([0,0,0,0,r>>24,255&r>>16,255&r>>8,255&r,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))},e.trun=function r(t,a){var n=t.samples||[],d=n.length,o=12+16*d,s=new Uint8Array(o),l,u,c,f,g,m;for(a+=8+o,s.set(["video"===t.type?1:0,0,15,1,255&d>>>24,255&d>>>16,255&d>>>8,255&d,255&a>>>24,255&a>>>16,255&a>>>8,255&a],0),l=0;l<d;l++)u=n[l],c=u.duration,f=u.size,g=u.flags,m=u.cts,s.set([255&c>>>24,255&c>>>16,255&c>>>8,255&c,255&f>>>24,255&f>>>16,255&f>>>8,255&f,g.isLeading<<2|g.dependsOn,g.isDependedOn<<6|g.hasRedundancy<<4|g.paddingValue<<1|g.isNonSync,61440&g.degradPrio,15&g.degradPrio,255&m>>>24,255&m>>>16,255&m>>>8,255&m],12+16*l);return e.box(e.types.trun,s)},e.initSegment=function a(t){e.types||e.init();var r=e.moov(t),n=new Uint8Array(e.FTYP.byteLength+r.byteLength);return n.set(e.FTYP),n.set(r,e.FTYP.byteLength),n},e}(),gi,mi;fi.types=void 0,fi.HDLR_TYPES=void 0,fi.STTS=void 0,fi.STSC=void 0,fi.STCO=void 0,fi.STSZ=void 0,fi.VMHD=void 0,fi.SMHD=void 0,fi.STSD=void 0,fi.FTYP=void 0,fi.DINF=void 0;var pi=1024,yi=null,Ti=null,hi=function(){function e(e,t,a,r){if(this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.observer=e,this.config=t,this.typeSupported=a,this.ISGenerated=!1,null===yi){var n=navigator.userAgent||"",i=n.match(/Chrome\/(\d+)/i);yi=i?parseInt(i[1]):0}if(null===Ti){var d=navigator.userAgent.match(/Safari\/(\d+)/i);Ti=d?parseInt(d[1]):0}}var t=e.prototype;return t.destroy=function e(){},t.resetTimeStamp=function t(e){Ar.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=e},t.resetNextTimestamp=function e(){Ar.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1},t.resetInitSegment=function e(){Ar.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1},t.getVideoStartPts=function t(e){var a=!1,r=e.reduce(function(e,t){var r=t.pts-e;return-4294967296>r?(a=!0,ya(e,t.pts)):0<r?e:t.pts},e[0].pts);return a&&Ar.debug("PTS rollover detected"),r},t.remux=function s(e,t,a,r,n,i,d,o){var l=n,u=n,c=-1<e.pid,g=-1<t.pid,m=t.samples.length,p=0<e.samples.length,y=d&&0<m||1<m,T=(!c||p)&&(!g||y)||this.ISGenerated||d,h,E,S,L,R,A;if(T){this.ISGenerated||(S=this.generateIS(e,t,n,i));var v=this.isVideoContiguous,I=-1,D;if(y&&(I=Ta(t.samples),!v&&this.config.forceKeyFrameOnDiscontinuity))if(A=!0,0<I){Ar.warn("[mp4-remuxer]: Dropped "+I+" out of "+m+" video samples due to a missing keyframe");var k=this.getVideoStartPts(t.samples);t.samples=t.samples.slice(I),t.dropped+=I,u+=(t.samples[0].pts-k)/t.inputTimeScale,D=u}else-1===I&&(Ar.warn("[mp4-remuxer]: No keyframe found out of "+m+" video samples"),A=!1);if(this.ISGenerated){if(p&&y){var _=this.getVideoStartPts(t.samples),b=ya(e.samples[0].pts,_)-_,C=b/t.inputTimeScale;l+=f(0,C),u+=f(0,-C)}if(!p)y&&(h=this.remuxVideo(t,u,v,0));else if(e.samplerate||(Ar.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),S=this.generateIS(e,t,n,i)),E=this.remuxAudio(e,l,this.isAudioContiguous,i,g||y||o===yn.AUDIO?u:void 0),y){var P=E?E.endPTS-E.startPTS:0;t.inputTimeScale||(Ar.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),S=this.generateIS(e,t,n,i)),h=this.remuxVideo(t,u,v,P)}h&&(h.firstKeyFrame=I,h.independent=-1!==I,h.firstKeyFramePTS=D)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(a.samples.length&&(R=ha(a,n,this._initPTS,this._initDTS)),r.samples.length&&(L=Ea(r,n,this._initPTS))),{audio:E,video:h,initSegment:S,independent:A,text:L,id3:R}},t.generateIS=function n(e,t,a,r){var i=e.samples,s=t.samples,l=this.typeSupported,u={},c=this._initPTS,f=!c||r,g="audio/mp4",m,p,y;if(f&&(m=p=1/0),e.config&&i.length){switch(e.timescale=e.samplerate,e.segmentCodec){case"mp3":l.mpeg?(g="audio/mpeg",e.codec=""):l.mp3&&(e.codec="mp3")}u.audio={id:"audio",container:g,codec:e.codec,initSegment:"mp3"===e.segmentCodec&&l.mpeg?new Uint8Array(0):fi.initSegment([e]),metadata:{channelCount:e.channelCount}},f&&(y=e.inputTimeScale,c&&y===c.timescale?f=!1:m=p=i[0].pts-d(y*a))}if(t.sps&&t.pps&&s.length&&(t.timescale=t.inputTimeScale,u.video={id:"main",container:"video/mp4",codec:t.codec,initSegment:fi.initSegment([t]),metadata:{width:t.width,height:t.height}},f))if(y=t.inputTimeScale,!c||y!==c.timescale){var T=this.getVideoStartPts(s),h=d(y*a);p=o(p,ya(s[0].dts,T)-h),m=o(m,T-h)}else f=!1;return Object.keys(u).length?(this.ISGenerated=!0,f?(this._initPTS={baseTime:m,timescale:y},this._initDTS={baseTime:p,timescale:y}):m=y=void 0,{tracks:u,initPTS:m,timescale:y}):void 0},t.remuxVideo=function s(e,t,a,r){var l=Number.NEGATIVE_INFINITY,c=e.inputTimeScale,g=e.samples,m=[],p=g.length,y=this._initPTS,T=this.nextAvcDts,h=8,S=this.videoSampleDuration,L=n,R=l,A=!1,v,I;if(!a||null===T){var D=t*c,k=g[0].pts-ya(g[0].dts,g[0].pts);T=D-k}for(var _=y.baseTime*c/y.timescale,b=0,C;b<p;b++)C=g[b],C.pts=ya(C.pts-_,T),C.dts=ya(C.dts-_,T),C.dts<g[0<b?b-1:b].dts&&(A=!0);A&&g.sort(function(e,t){var a=e.dts-t.dts,r=e.pts-t.pts;return a||r}),v=g[0].dts,I=g[g.length-1].dts;var P=I-v,x=P?d(P/(p-1)):S||e.inputTimeScale/30;if(a){var F=v-T,O=F>x,N=-1>F;if((O||N)&&(O?Ar.warn("AVC: "+ma(F,!0)+" ms ("+F+"dts) hole between fragments detected, filling it"):Ar.warn("AVC: "+ma(-F,!0)+" ms ("+F+"dts) overlapping between fragments detected"),!N||T>=g[0].pts)){v=T;var M=g[0].pts-F;g[0].dts=v,g[0].pts=M,Ar.log("Video: First PTS/DTS adjusted: "+ma(M,!0)+"/"+ma(v,!0)+", delta: "+ma(F,!0)+" ms")}}v=f(0,v);for(var w=0,B=0,U=0;U<p;U++){for(var G=g[U],K=G.units,H=K.length,V=0,W=0;W<H;W++)V+=K[W].data.length;B+=V,w+=H,G.length=V,G.dts=f(G.dts,v),L=o(G.pts,L),R=f(G.pts,R)}I=g[p-1].dts;var Y=B+4*w+8,q;try{q=new Uint8Array(Y)}catch(e){return void this.observer.emit(Tr.ERROR,Tr.ERROR,{type:hr.MUX_ERROR,details:Er.REMUX_ALLOC_ERROR,fatal:!1,error:e,bytes:Y,reason:"fail allocating video mdat "+Y})}var z=new DataView(q.buffer);z.setUint32(0,Y),q.set(fi.types.mdat,4);for(var X=!1,Q=n,Z=n,$=l,J=l,ee=0;ee<p;ee++){for(var te=g[ee],ae=te.units,re=0,ne=0,ie=ae.length;ne<ie;ne++){var de=ae[ne],oe=de.data,se=de.data.byteLength;z.setUint32(h,se),h+=4,q.set(oe,h),h+=se,re+=4+se}var le=void 0;if(ee<p-1)S=g[ee+1].dts-te.dts,le=g[ee+1].pts-te.pts;else{var ue=this.config,ce=0<ee?te.dts-g[ee-1].dts:x;if(le=0<ee?te.pts-g[ee-1].pts:x,ue.stretchShortVideoTrack&&null!==this.nextAudioPts){var fe=u(ue.maxBufferHole*c),ge=(r?L+r*c:this.nextAudioPts)-te.pts;ge>fe?(S=ge-ce,0>S?S=ce:X=!0,Ar.log("[mp4-remuxer]: It is approximately "+ge/90+" ms to the next segment; using duration "+S/90+" ms for the last video frame.")):S=ce}else S=ce}var me=d(te.pts-te.dts);Q=o(Q,S),$=f($,S),Z=o(Z,le),J=f(J,le),m.push(new Ei(te.key,S,re,me))}if(m.length)if(yi){if(70>yi){var pe=m[0].flags;pe.dependsOn=2,pe.isNonSync=0}}else if(Ti&&J-Z<$-Q&&.025>x/$&&0===m[0].cts){Ar.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");for(var ye=v,Te=0,he=m.length;Te<he;Te++){var Ee=ye+m[Te].duration,Se=ye+m[Te].cts;if(Te<he-1){var Le=Ee+m[Te+1].cts;m[Te].duration=Le-Se}else m[Te].duration=Te?m[Te-1].duration:x;m[Te].cts=0,ye=Ee}}S=X||!S?x:S,this.nextAvcDts=T=I+S,this.videoSampleDuration=S,this.isVideoContiguous=!0;var Re=fi.moof(e.sequenceNumber++,v,E({},e,{samples:m})),Ae="video",ve={data1:Re,data2:q,startPTS:L/c,endPTS:(R+S)/c,startDTS:v/c,endDTS:T/c,type:Ae,hasAudio:!1,hasVideo:!0,nb:m.length,dropped:e.dropped};return e.samples=[],e.dropped=0,ve},t.remuxAudio=function o(e,t,a,r,n){var l=e.inputTimeScale,u=e.samplerate?e.samplerate:l,c=l/u,g="aac"===e.segmentCodec?pi:1152,m=g*c,p=this._initPTS,y="mp3"===e.segmentCodec&&this.typeSupported.mpeg,T=[],h=void 0!==n,S=e.samples,L=y?0:8,R=this.nextAudioPts||-1,A=t*l,v=p.baseTime*l/p.timescale;if(this.isAudioContiguous=a=a||S.length&&0<R&&(r&&9e3>s(A-R)||s(ya(S[0].pts-v,A)-R)<20*m),S.forEach(function(e){e.pts=ya(e.pts-v,A)}),!a||0>R){if(S=S.filter(function(e){return 0<=e.pts}),!S.length)return;R=0===n?0:r&&!h?f(0,A):S[0].pts}if("aac"===e.segmentCodec)for(var I=this.config.maxAudioFramesDrift,D=0,k=R;D<S.length;D++){var _=S[D],b=_.pts,C=b-k,P=s(1e3*C/l);if(C<=-I*m&&h)0===D&&(Ar.warn("Audio frame @ "+(b/l).toFixed(3)+"s overlaps nextAudioPts by "+d(1e3*C/l)+" ms."),this.nextAudioPts=R=k=b);else if(C>=I*m&&P<10000&&h){var x=d(C/m);k=b-x*m,0>k&&(x--,k+=m),0===D&&(this.nextAudioPts=R=k),Ar.warn("[mp4-remuxer]: Injecting "+x+" audio frame @ "+(k/l).toFixed(3)+"s due to "+d(1e3*C/l)+" ms gap.");for(var F=0;F<x;F++){var O=f(k,0),N=ui.getSilentFrame(e.manifestCodec||e.codec,e.channelCount);N||(Ar.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),N=_.unit.subarray()),S.splice(D,0,{unit:N,pts:O}),k+=m,D++}}_.pts=k,k+=m}for(var M=null,w=null,B=0,U=S.length,G;U--;)B+=S[U].unit.byteLength;for(var K=0,H=S.length;K<H;K++){var V=S[K],W=V.unit,Y=V.pts;if(null!==w){var q=T[K-1];q.duration=d((Y-w)/c)}else if(a&&"aac"===e.segmentCodec&&(Y=R),M=Y,0<B){B+=L;try{G=new Uint8Array(B)}catch(e){return void this.observer.emit(Tr.ERROR,Tr.ERROR,{type:hr.MUX_ERROR,details:Er.REMUX_ALLOC_ERROR,fatal:!1,error:e,bytes:B,reason:"fail allocating audio mdat "+B})}if(!y){var z=new DataView(G.buffer);z.setUint32(0,B),G.set(fi.types.mdat,4)}}else return;G.set(W,L);var X=W.byteLength;L+=X,T.push(new Ei(!0,g,X,0)),w=Y}var Q=T.length;if(Q){var Z=T[T.length-1];this.nextAudioPts=R=w+c*Z.duration;var $=y?new Uint8Array(0):fi.moof(e.sequenceNumber++,M/c,E({},e,{samples:T}));e.samples=[];var J=M/l,ee=R/l,te="audio",ae={data1:$,data2:G,startPTS:J,endPTS:ee,startDTS:J,endDTS:ee,type:te,hasAudio:!0,hasVideo:!1,nb:Q};return this.isAudioContiguous=!0,ae}},t.remuxEmptyAudio=function d(e,t,r,n){var o=e.inputTimeScale,s=e.samplerate?e.samplerate:o,l=o/s,u=this.nextAudioPts,c=this._initDTS,f=9e4*c.baseTime/c.timescale,g=(null===u?n.startDTS*o:u)+f,m=n.endDTS*o+f,p=l*pi,y=a((m-g)/p),T=ui.getSilentFrame(e.manifestCodec||e.codec,e.channelCount);if(Ar.warn("[mp4-remuxer]: remux empty Audio"),!T)return void Ar.trace("[mp4-remuxer]: Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec");for(var h=[],E=0,S;E<y;E++)S=g+E*p,h.push({unit:T,pts:S,dts:S});return e.samples=h,this.remuxAudio(e,t,r,!1)},e}(),Ei=function n(e,t,a,r){this.size=void 0,this.duration=void 0,this.cts=void 0,this.flags=void 0,this.duration=t,this.size=a,this.cts=r,this.flags=new Si(e)},Si=function t(e){this.isLeading=0,this.isDependedOn=0,this.hasRedundancy=0,this.degradPrio=0,this.dependsOn=1,this.isNonSync=1,this.dependsOn=e?2:1,this.isNonSync=e?0:1},Li=function(){function e(){this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null}var t=e.prototype;return t.destroy=function e(){},t.resetTimeStamp=function t(e){this.initPTS=e,this.lastEndTime=null},t.resetNextTimestamp=function e(){this.lastEndTime=null},t.resetInitSegment=function n(e,t,a,r){this.audioCodec=t,this.videoCodec=a,this.generateInitSegment(ie(e,r)),this.emitInitSegment=!0},t.generateInitSegment=function t(e){var a=this.audioCodec,r=this.videoCodec;if(!(null!=e&&e.byteLength))return this.initTracks=void 0,void(this.initData=void 0);var n=this.initData=ne(e);a||(a=La(n.audio,br.AUDIO)),r||(r=La(n.video,br.VIDEO));var i={};n.audio&&n.video?i.audiovideo={container:"video/mp4",codec:a+","+r,initSegment:e,id:"main"}:n.audio?i.audio={container:"audio/mp4",codec:a,initSegment:e,id:"audio"}:n.video?i.video={container:"video/mp4",codec:r,initSegment:e,id:"main"}:Ar.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=i},t.remux=function d(e,t,a,r,n,i){var o=this.initPTS,s=this.lastEndTime,l={audio:void 0,video:void 0,text:r,id3:a,initSegment:void 0},u,c;yr(s)||(s=this.lastEndTime=n||0);var f=t.samples;if(!(null!=f&&f.length))return l;var g={initPTS:void 0,timescale:1},m=this.initData;if(null!=(u=m)&&u.length||(this.generateInitSegment(f),m=this.initData),!(null!=(c=m)&&c.length))return Ar.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),l;this.emitInitSegment&&(g.tracks=this.initTracks,this.emitInitSegment=!1);var p=se(f,m),y=oe(m,f),T=null===y?n:y;(Sa(o,T,n,p)||g.timescale!==o.timescale&&i)&&(g.initPTS=T-n,o&&1===o.timescale&&Ar.warn("Adjusting initPTS by "+(g.initPTS-o.baseTime)),this.initPTS=o={baseTime:g.initPTS,timescale:1});var h=e?T-o.baseTime/o.timescale:s,E=h+p;ue(m,f,o.baseTime/o.timescale),0<p?this.lastEndTime=E:(Ar.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());var S=!!m.audio,L=!!m.video,R="";S&&(R+="audio"),L&&(R+="video");var A={data1:f,startPTS:h,startDTS:h,endPTS:E,endDTS:E,type:R,hasAudio:S,hasVideo:L,nb:1,dropped:0};return l.audio="audio"===A.type?A:void 0,l.video="audio"===A.type?void 0:A,l.initSegment=g,l.id3=ha(a,n,o,o),r.samples.length&&(l.text=Ea(r,n,o)),l},e}(),Ri;try{Ri=self.performance.now.bind(self.performance)}catch(e){Ar.debug("Unable to use Performance API on this environment"),Ri="undefined"!=typeof self&&self.Date.now}var Ai=[{demux:Jn,remux:Li},{demux:si,remux:hi},{demux:Zn,remux:hi},{demux:li,remux:hi}],vi=function(){function e(e,t,a,r,n){this.async=!1,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.vendor=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=e,this.typeSupported=t,this.config=a,this.vendor=r,this.id=n}var t=e.prototype;return t.configure=function t(e){this.transmuxConfig=e,this.decrypter&&this.decrypter.reset()},t.push=function n(e,t,a,r){var i=this,d=a.transmuxing;d.executeStart=Ri();var o=new Uint8Array(e),s=this.currentTransmuxState,l=this.transmuxConfig;r&&(this.currentTransmuxState=r);var u=r||s,c=u.contiguous,f=u.discontinuity,g=u.trackSwitch,m=u.accurateTimeOffset,p=u.timeOffset,y=u.initSegmentChange,T=l.audioCodec,h=l.videoCodec,E=l.defaultInitPts,S=l.duration,L=l.initSegmentData,R=Ra(o,t);if(R&&"AES-128"===R.method){var A=this.getDecrypter();if(A.isSync()){var v=A.softwareDecrypt(o,R.key.buffer,R.iv.buffer),I=-1<a.part;if(I&&(v=A.flush()),!v)return d.executeEnd=Ri(),Ii(a);o=new Uint8Array(v)}else return this.decryptionPromise=A.webCryptoDecrypt(o,R.key.buffer,R.iv.buffer).then(function(e){var t=i.push(e,null,a);return i.decryptionPromise=null,t}),this.decryptionPromise}var D=this.needsProbing(f,g);if(D){var k=this.configureTransmuxer(o);if(k)return Ar.warn("[transmuxer] "+k.message),this.observer.emit(Tr.ERROR,Tr.ERROR,{type:hr.MEDIA_ERROR,details:Er.FRAG_PARSING_ERROR,fatal:!1,error:k,reason:k.message}),d.executeEnd=Ri(),Ii(a)}(f||g||y||D)&&this.resetInitSegment(L,T,h,S,t),(f||y||D)&&this.resetInitialTimestamp(E),c||this.resetContiguity();var _=this.transmux(o,R,p,m,a),b=this.currentTransmuxState;return b.contiguous=!0,b.discontinuity=!1,b.trackSwitch=!1,d.executeEnd=Ri(),_},t.flush=function t(e){var a=this,r=e.transmuxing;r.executeStart=Ri();var n=this.decrypter,i=this.currentTransmuxState,d=this.decryptionPromise;if(d)return d.then(function(){return a.flush(e)});var o=[],s=i.timeOffset;if(n){var l=n.flush();l&&o.push(this.push(l,null,e))}var u=this.demuxer,c=this.remuxer;if(!u||!c)return r.executeEnd=Ri(),[Ii(e)];var f=u.flush(s);return Aa(f)?f.then(function(t){return a.flushRemux(o,t,e),o}):(this.flushRemux(o,f,e),o)},t.flushRemux=function r(e,t,a){var n=t.audioTrack,i=t.videoTrack,d=t.id3Track,o=t.textTrack,s=this.currentTransmuxState,l=s.accurateTimeOffset,u=s.timeOffset;Ar.log("[transmuxer.ts]: Flushed fragment "+a.sn+(-1<a.part?" p: "+a.part:"")+" of level "+a.level);var c=this.remuxer.remux(n,i,d,o,u,l,!0,this.id);e.push({remuxResult:c,chunkMeta:a}),a.transmuxing.executeEnd=Ri()},t.resetInitialTimestamp=function t(e){var a=this.demuxer,r=this.remuxer;a&&r&&(a.resetTimeStamp(e),r.resetTimeStamp(e))},t.resetContiguity=function e(){var t=this.demuxer,a=this.remuxer;t&&a&&(t.resetContiguity(),a.resetNextTimestamp())},t.resetInitSegment=function i(e,t,a,r,n){var d=this.demuxer,o=this.remuxer;d&&o&&(d.resetInitSegment(e,t,a,r),o.resetInitSegment(e,t,a,n))},t.destroy=function e(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)},t.transmux=function i(e,t,a,r,n){var d;return d=t&&"SAMPLE-AES"===t.method?this.transmuxSampleAes(e,t,a,r,n):this.transmuxUnencrypted(e,a,r,n),d},t.transmuxUnencrypted=function n(e,t,a,r){var i=this.demuxer.demux(e,t,!1,!this.config.progressive),d=i.audioTrack,o=i.videoTrack,s=i.id3Track,l=i.textTrack,u=this.remuxer.remux(d,o,s,l,t,a,!1,this.id);return{remuxResult:u,chunkMeta:r}},t.transmuxSampleAes=function i(e,t,a,r,n){var d=this;return this.demuxer.demuxSampleAes(e,t,a).then(function(e){var t=d.remuxer.remux(e.audioTrack,e.videoTrack,e.id3Track,e.textTrack,a,r,!1,d.id);return{remuxResult:t,chunkMeta:n}})},t.configureTransmuxer=function t(e){for(var a=this.config,r=this.observer,n=this.typeSupported,d=this.vendor,o=0,s=Ai.length,l;o<s;o++)if(Ai[o].demux.probe(e)){l=Ai[o];break}if(!l)return new Error("Failed to find demuxer by probing fragment data");var u=this.demuxer,c=this.remuxer,f=l.remux,g=l.demux;c&&c instanceof f||(this.remuxer=new f(r,a,n,d)),u&&u instanceof g||(this.demuxer=new g(r,a,n),this.probe=g.probe)},t.needsProbing=function a(e,t){return!this.demuxer||!this.remuxer||e||t},t.getDecrypter=function e(){var t=this.decrypter;return t||(t=this.decrypter=new Yn(this.config)),t},e}(),Ii=function t(e){return{remuxResult:{},chunkMeta:e}},Di=function i(e,t,a,r,n){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=e,this.videoCodec=t,this.initSegmentData=a,this.duration=r,this.defaultInitPts=n||null},ki=function d(e,t,a,r,n,i){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=e,this.contiguous=t,this.accurateTimeOffset=a,this.trackSwitch=r,this.timeOffset=n,this.initSegmentChange=i},_i={exports:{}};(function(e){function t(){}function a(e,t,a){this.fn=e,this.context=t,this.once=a||!1}function r(e,t,r,n,i){if("function"!=typeof r)throw new TypeError("The listener must be a function");var d=new a(r,n||e,i),s=o?o+t:t;return e._events[s]?e._events[s].fn?e._events[s]=[e._events[s],d]:e._events[s].push(d):(e._events[s]=d,e._eventsCount++),e}function n(e,a){0==--e._eventsCount?e._events=new t:delete e._events[a]}function i(){this._events=new t,this._eventsCount=0}var d=Object.prototype.hasOwnProperty,o="~";Object.create&&(t.prototype=Object.create(null),!new t().__proto__&&(o=!1)),i.prototype.eventNames=function e(){var t=[],a,r;if(0===this._eventsCount)return t;for(r in a=this._events)d.call(a,r)&&t.push(o?r.slice(1):r);return Object.getOwnPropertySymbols?t.concat(Object.getOwnPropertySymbols(a)):t},i.prototype.listeners=function t(e){var a=o?o+e:e,r=this._events[a];if(!r)return[];if(r.fn)return[r.fn];for(var n=0,d=r.length,s=Array(d);n<d;n++)s[n]=r[n].fn;return s},i.prototype.listenerCount=function t(e){var a=o?o+e:e,r=this._events[a];return r?r.fn?1:r.length:0},i.prototype.emit=function s(e,t,a,r,n,d){var l=o?o+e:e;if(!this._events[l])return!1;var u=this._events[l],c=arguments.length,f,g;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),c){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,a),!0;case 4:return u.fn.call(u.context,t,a,r),!0;case 5:return u.fn.call(u.context,t,a,r,n),!0;case 6:return u.fn.call(u.context,t,a,r,n,d),!0}for(g=1,f=Array(c-1);g<c;g++)f[g-1]=arguments[g];u.fn.apply(u.context,f)}else{var m=u.length,p;for(g=0;g<m;g++)switch(u[g].once&&this.removeListener(e,u[g].fn,void 0,!0),c){case 1:u[g].fn.call(u[g].context);break;case 2:u[g].fn.call(u[g].context,t);break;case 3:u[g].fn.call(u[g].context,t,a);break;case 4:u[g].fn.call(u[g].context,t,a,r);break;default:if(!f)for(p=1,f=Array(c-1);p<c;p++)f[p-1]=arguments[p];u[g].fn.apply(u[g].context,f)}}return!0},i.prototype.on=function n(e,t,a){return r(this,e,t,a,!1)},i.prototype.once=function n(e,t,a){return r(this,e,t,a,!0)},i.prototype.removeListener=function d(e,t,a,r){var s=o?o+e:e;if(!this._events[s])return this;if(!t)return n(this,s),this;var l=this._events[s];if(l.fn)l.fn!==t||r&&!l.once||a&&l.context!==a||n(this,s);else{for(var u=0,c=[],f=l.length;u<f;u++)(l[u].fn!==t||r&&!l[u].once||a&&l[u].context!==a)&&c.push(l[u]);c.length?this._events[s]=1===c.length?c[0]:c:n(this,s)}return this},i.prototype.removeAllListeners=function a(e){var r;return e?(r=o?o+e:e,this._events[r]&&n(this,r)):(this._events=new t,this._eventsCount=0),this},i.prototype.off=i.prototype.removeListener,i.prototype.addListener=i.prototype.on,i.prefixed=o,i.EventEmitter=i,e.exports=i})(_i);var bi=_i.exports,Ci=function t(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e["default"]:e}(bi);"undefined"!=typeof e&&e&&function t(e){var a=new Ci,r=function r(t,a){e.postMessage({event:t,data:a})};a.on(Tr.FRAG_DECRYPTED,r),a.on(Tr.ERROR,r);var n=function e(){var t=function t(e){var a=function a(t){r("workerLog",{logType:e,message:t})};Ar[e]=a};for(var a in Ar)t(a)};e.addEventListener("message",function(t){var i=t.data;switch(i.cmd){case"init":{var d=JSON.parse(i.config);e.transmuxer=new vi(a,i.typeSupported,d,i.vendor,i.id),N(d.debug,i.id),n(),r("init",null);break}case"configure":{e.transmuxer.configure(i.config);break}case"demux":{var o=e.transmuxer.push(i.data,i.decryptdata,i.chunkMeta,i.state);Aa(o)?(e.transmuxer.async=!0,o.then(function(t){va(e,t)}).catch(function(e){r(Tr.ERROR,{type:hr.MEDIA_ERROR,details:Er.FRAG_PARSING_ERROR,chunkMeta:i.chunkMeta,fatal:!1,error:e,err:e,reason:"transmuxer-worker push error"})})):(e.transmuxer.async=!1,va(e,o));break}case"flush":{var s=i.chunkMeta,l=e.transmuxer.flush(s),u=Aa(l);u||e.transmuxer.async?(!Aa(l)&&(l=Promise.resolve(l)),l.then(function(t){Da(e,t,s)}).catch(function(e){r(Tr.ERROR,{type:hr.MEDIA_ERROR,details:Er.FRAG_PARSING_ERROR,chunkMeta:i.chunkMeta,fatal:!1,error:e,err:e,reason:"transmuxer-worker flush error"})})):Da(e,l,s);break}}})}(self);var Pi=_e()||{isTypeSupported:function e(){return!1}},xi=function(){function e(e,t,a,r){var n=this;this.error=null,this.hls=void 0,this.id=void 0,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.onwmsg=void 0,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0;var i=e.config;this.hls=e,this.id=t,this.useWorker=!!i.enableWorker,this.onTransmuxComplete=a,this.onFlush=r;var d=function a(e,t){t=t||{},t.frag=n.frag,t.id=n.id,e===Tr.ERROR&&(n.error=t.error),n.hls.trigger(e,t)};this.observer=new Ci,this.observer.on(Tr.FRAG_DECRYPTED,d),this.observer.on(Tr.ERROR,d);var o={mp4:Pi.isTypeSupported("video/mp4"),mpeg:Pi.isTypeSupported("audio/mpeg"),mp3:Pi.isTypeSupported("audio/mp4; codecs=\"mp3\"")},s=navigator.vendor;if(this.useWorker&&"undefined"!=typeof Worker){var l=i.workerPath||_a();if(l){try{i.workerPath?(Ar.log("loading Web Worker "+i.workerPath+" for \""+t+"\""),this.workerContext=Ca(i.workerPath)):(Ar.log("injecting Web Worker for \""+t+"\""),this.workerContext=ba()),this.onwmsg=function(e){return n.onWorkerMessage(e)};var u=this.workerContext.worker;u.addEventListener("message",this.onwmsg),u.onerror=function(e){var a=new Error(e.message+"  ("+e.filename+":"+e.lineno+")");i.enableWorker=!1,Ar.warn("Error in \""+t+"\" Web Worker, fallback to inline"),n.hls.trigger(Tr.ERROR,{type:hr.OTHER_ERROR,details:Er.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:a})},u.postMessage({cmd:"init",typeSupported:o,vendor:s,id:t,config:JSON.stringify(i)})}catch(e){Ar.warn("Error setting up \""+t+"\" Web Worker, fallback to inline",e),this.resetWorker(),this.error=null,this.transmuxer=new vi(this.observer,o,i,s,t)}return}}this.transmuxer=new vi(this.observer,o,i,s,t)}var t=e.prototype;return t.resetWorker=function e(){if(this.workerContext){var t=this.workerContext,a=t.worker,r=t.objectURL;r&&self.URL.revokeObjectURL(r),a.removeEventListener("message",this.onwmsg),a.onerror=null,a.terminate(),this.workerContext=null}},t.destroy=function e(){if(this.workerContext)this.resetWorker(),this.onwmsg=void 0;else{var t=this.transmuxer;t&&(t.destroy(),this.transmuxer=null)}var a=this.observer;a&&a.removeAllListeners(),this.frag=null,this.observer=null,this.hls=null},t.push=function u(e,t,a,r,n,i,d,o,s,l){var c=this,f,g;s.transmuxing.start=self.performance.now();var m=this.transmuxer,p=i?i.start:n.start,y=n.decryptdata,T=this.frag,h=!(T&&n.cc===T.cc),E=!(T&&s.level===T.level),S=T?s.sn-T.sn:-1,L=this.part?s.part-this.part.index:-1,R=0===S&&1<s.id&&s.id===(null==T?void 0:T.stats.chunkCount),A=!E&&(1===S||0===S&&(1===L||R&&0>=L)),v=self.performance.now();(E||S||0===n.stats.parsing.start)&&(n.stats.parsing.start=v),i&&(L||!A)&&(i.stats.parsing.start=v);var I=!(T&&(null==(f=n.initSegment)?void 0:f.url)===(null==(g=T.initSegment)?void 0:g.url)),D=new ki(h,A,o,E,p,I);if(!A||h||I){Ar.log("[transmuxer-interface, "+n.type+"]: Starting new transmux session for sn: "+s.sn+" p: "+s.part+" level: "+s.level+" id: "+s.id+"\n        discontinuity: "+h+"\n        trackSwitch: "+E+"\n        contiguous: "+A+"\n        accurateTimeOffset: "+o+"\n        timeOffset: "+p+"\n        initSegmentChange: "+I);var k=new Di(a,r,t,d,l);this.configureTransmuxer(k)}if(this.frag=n,this.part=i,this.workerContext)this.workerContext.worker.postMessage({cmd:"demux",data:e,decryptdata:y,chunkMeta:s,state:D},e instanceof ArrayBuffer?[e]:[]);else if(m){var _=m.push(e,y,s,D);Aa(_)?(m.async=!0,_.then(function(e){c.handleTransmuxComplete(e)}).catch(function(e){c.transmuxerError(e,s,"transmuxer-interface push error")})):(m.async=!1,this.handleTransmuxComplete(_))}},t.flush=function t(e){var a=this;e.transmuxing.start=self.performance.now();var r=this.transmuxer;if(this.workerContext)this.workerContext.worker.postMessage({cmd:"flush",chunkMeta:e});else if(r){var n=r.flush(e),i=Aa(n);i||r.async?(!Aa(n)&&(n=Promise.resolve(n)),n.then(function(t){a.handleFlushResult(t,e)}).catch(function(t){a.transmuxerError(t,e,"transmuxer-interface flush error")})):this.handleFlushResult(n,e)}},t.transmuxerError=function r(e,t,a){this.hls&&(this.error=e,this.hls.trigger(Tr.ERROR,{type:hr.MEDIA_ERROR,details:Er.FRAG_PARSING_ERROR,chunkMeta:t,fatal:!1,error:e,err:e,reason:a}))},t.handleFlushResult=function a(e,t){var r=this;e.forEach(function(e){r.handleTransmuxComplete(e)}),this.onFlush(t)},t.onWorkerMessage=function t(e){var a=e.data,r=this.hls;switch(a.event){case"init":{var n=null==(i=this.workerContext)?void 0:i.objectURL,i;n&&self.URL.revokeObjectURL(n);break}case"transmuxComplete":{this.handleTransmuxComplete(a.data);break}case"flush":{this.onFlush(a.data);break}case"workerLog":Ar[a.data.logType]&&Ar[a.data.logType](a.data.message);break;default:{a.data=a.data||{},a.data.frag=this.frag,a.data.id=this.id,r.trigger(a.event,a.data);break}}},t.configureTransmuxer=function t(e){var a=this.transmuxer;this.workerContext?this.workerContext.worker.postMessage({cmd:"configure",config:e}):a&&a.configure(e)},t.handleTransmuxComplete=function t(e){e.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(e)},e}(),Fi=2,Oi=function(){function e(e,t,a,r){this.config=void 0,this.media=null,this.fragmentTracker=void 0,this.hls=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.config=e,this.media=t,this.fragmentTracker=a,this.hls=r}var t=e.prototype;return t.destroy=function e(){this.media=null,this.hls=this.fragmentTracker=null},t.poll=function a(e,t){var r=this.config,n=this.media,i=this.stalled;if(null!==n){var o=n.currentTime,s=n.seeking,l=this.seeking&&!s,u=!this.seeking&&s;if(this.seeking=s,o!==e){if(this.moved=!0,null!==i){if(this.stallReported){var c=self.performance.now()-i;Ar.warn("playback not stuck anymore @"+o+", after "+d(c)+"ms"),this.stallReported=!1}this.stalled=null,this.nudgeRetry=0}return}if(u||l)return void(this.stalled=null);if((!n.paused||s)&&!n.ended&&0!==n.playbackRate&&Gn.getBuffered(n).length){var g=Gn.bufferInfo(n,o,0),m=0<g.len,p=g.nextStart||0;if(m||p){if(s){var y=g.len>Fi,T=!p||t&&t.start<=o||p-o>Fi&&!this.fragmentTracker.getPartialFragment(o);if(y||T)return;this.moved=!1}if(!this.moved&&null!==this.stalled){var h=f(p,g.start||0)-o,E=this.hls.levels?this.hls.levels[this.hls.currentLevel]:null,S=null==E||null==(A=E.details)?void 0:A.live,L=S?2*E.details.targetduration:Fi,R=this.fragmentTracker.getPartialFragment(o),A;if(0<h&&(h<=L||R))return void this._trySkipBufferHole(R)}var v=self.performance.now();if(null===i)return void(this.stalled=v);var I=v-i;if(!(!s&&I>=250&&(this._reportStall(g),!this.media))){var D=Gn.bufferInfo(n,o,r.maxBufferHole);this._tryFixBufferStall(D,I)}}}}},t._tryFixBufferStall=function a(e,t){var r=this.config,n=this.fragmentTracker,i=this.media;if(null!==i){var d=i.currentTime,o=n.getPartialFragment(d);if(o){var s=this._trySkipBufferHole(o);if(s||!this.media)return}(e.len>r.maxBufferHole||e.nextStart&&e.nextStart-d<r.maxBufferHole)&&t>1e3*r.highBufferWatchdogPeriod&&(Ar.warn("Trying to nudge playhead over buffer-hole"),this.stalled=null,this._tryNudgeBuffer())}},t._reportStall=function t(e){var a=this.hls,r=this.media,n=this.stallReported;if(!n&&r){this.stallReported=!0;var i=new Error("Playback stalling at @"+r.currentTime+" due to low buffer ("+JSON.stringify(e)+")");Ar.warn(i.message),a.trigger(Tr.ERROR,{type:hr.MEDIA_ERROR,details:Er.BUFFER_STALLED_ERROR,fatal:!1,error:i,buffer:e.len})}},t._trySkipBufferHole=function t(e){var a=this.config,r=this.hls,n=this.media;if(null===n)return 0;var i=n.currentTime,d=Gn.bufferInfo(n,i,0),o=i<d.start?d.start:d.nextStart;if(o){var s=d.len<=a.maxBufferHole,l=0<d.len&&1>d.len&&3>n.readyState,u=o-i;if(0<u&&(s||l)){if(u>a.maxBufferHole){var c=this.fragmentTracker,g=!1;if(0===i){var m=c.getAppendedFrag(0,yn.MAIN);m&&o<m.end&&(g=!0)}if(!g){var p=e||c.getAppendedFrag(i,yn.MAIN);if(p){for(var y=!1,T=p.end,h;T<o;)if(h=c.getPartialFragment(T),h)T+=h.duration;else{y=!0;break}if(y)return 0}}}var E=f(o+.05,i+.1);if(Ar.warn("skipping hole, adjusting currentTime from "+i+" to "+E),this.moved=!0,this.stalled=null,n.currentTime=E,e&&!e.gap){var S=new Error("fragment loaded with buffer holes, seeking from "+i+" to "+E);r.trigger(Tr.ERROR,{type:hr.MEDIA_ERROR,details:Er.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:S,reason:S.message,frag:e})}return E}}return 0},t._tryNudgeBuffer=function e(){var t=this.config,a=this.hls,r=this.media,n=this.nudgeRetry;if(null!==r){var i=r.currentTime;if(this.nudgeRetry++,n<t.nudgeMaxRetry){var d=i+(n+1)*t.nudgeOffset,o=new Error("Nudging 'currentTime' from "+i+" to "+d);Ar.warn(o.message),r.currentTime=d,a.trigger(Tr.ERROR,{type:hr.MEDIA_ERROR,details:Er.BUFFER_NUDGE_ON_STALL,error:o,fatal:!1})}else{var s=new Error("Playhead still not moving while enough data buffered @"+i+" after "+t.nudgeMaxRetry+" nudges");Ar.error(s.message),a.trigger(Tr.ERROR,{type:hr.MEDIA_ERROR,details:Er.BUFFER_STALLED_ERROR,error:s,fatal:!0})}}},e}(),Ni=function(e){function t(t,a,r){var n;return n=e.call(this,t,a,r,"[stream-controller]",yn.MAIN)||this,n.audioCodecSwap=!1,n.gapController=null,n.level=-1,n._forceStartLoad=!1,n.altAudio=!1,n.audioOnly=!1,n.fragPlaying=null,n.onvplaying=null,n.onvseeked=null,n.fragLastKbps=0,n.couldBacktrack=!1,n.backtrackFragment=null,n.audioCodecSwitch=!1,n.videoBuffer=null,n._registerListeners(),n}S(t,e);var a=t.prototype;return a._registerListeners=function e(){var t=this.hls;t.on(Tr.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(Tr.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(Tr.MANIFEST_LOADING,this.onManifestLoading,this),t.on(Tr.MANIFEST_PARSED,this.onManifestParsed,this),t.on(Tr.LEVEL_LOADING,this.onLevelLoading,this),t.on(Tr.LEVEL_LOADED,this.onLevelLoaded,this),t.on(Tr.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),t.on(Tr.ERROR,this.onError,this),t.on(Tr.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.on(Tr.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),t.on(Tr.BUFFER_CREATED,this.onBufferCreated,this),t.on(Tr.BUFFER_FLUSHED,this.onBufferFlushed,this),t.on(Tr.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(Tr.FRAG_BUFFERED,this.onFragBuffered,this)},a._unregisterListeners=function e(){var t=this.hls;t.off(Tr.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(Tr.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(Tr.MANIFEST_LOADING,this.onManifestLoading,this),t.off(Tr.MANIFEST_PARSED,this.onManifestParsed,this),t.off(Tr.LEVEL_LOADED,this.onLevelLoaded,this),t.off(Tr.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),t.off(Tr.ERROR,this.onError,this),t.off(Tr.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.off(Tr.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),t.off(Tr.BUFFER_CREATED,this.onBufferCreated,this),t.off(Tr.BUFFER_FLUSHED,this.onBufferFlushed,this),t.off(Tr.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(Tr.FRAG_BUFFERED,this.onFragBuffered,this)},a.onHandlerDestroying=function e(){this._unregisterListeners(),this.onMediaDetaching()},a.startLoad=function t(e){if(this.levels){var a=this.lastCurrentTime,r=this.hls;if(this.stopLoad(),this.setInterval(100),this.level=-1,!this.startFragRequested){var n=r.startLevel;-1===n&&(r.config.testBandwidth&&1<this.levels.length?(n=0,this.bitrateTest=!0):n=r.nextAutoLevel),this.level=r.nextLoadLevel=n,this.loadedmetadata=!1}0<a&&-1===e&&(this.log("Override startPosition with lastCurrentTime @"+a.toFixed(3)),e=a),this.state=zn.IDLE,this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}else this._forceStartLoad=!0,this.state=zn.STOPPED},a.stopLoad=function t(){this._forceStartLoad=!1,e.prototype.stopLoad.call(this)},a.doTick=function e(){switch(this.state){case zn.WAITING_LEVEL:{var t=this.levels,a=this.level,r=null==t||null==(n=t[a])?void 0:n.details,n;if(r&&(!r.live||this.levelLastLoaded===this.level)){if(this.waitForCdnTuneIn(r))break;this.state=zn.IDLE;break}else if(this.hls.nextLoadLevel!==this.level){this.state=zn.IDLE;break}break}case zn.FRAG_LOADING_WAITING_RETRY:{var i=self.performance.now(),d=this.retryDate,o;(!d||i>=d||null!=(o=this.media)&&o.seeking)&&(this.resetStartWhenNotLoaded(this.level),this.state=zn.IDLE)}}this.state===zn.IDLE&&this.doTickIdle(),this.onTickEnd()},a.onTickEnd=function t(){e.prototype.onTickEnd.call(this),this.checkBuffer(),this.checkFragmentChanged()},a.doTickIdle=function e(){var t=this.hls,a=this.levelLastLoaded,r=this.levels,n=this.media,i=t.config,d=t.nextLoadLevel;if(null!==a&&(n||!this.startFragRequested&&i.startFragPrefetch)&&!(this.altAudio&&this.audioOnly)&&null!=r&&r[d]){var o=r[d],s=this.getMainFwdBufferInfo();if(null!==s){var l=this.getLevelDetails();if(l&&this._streamEnded(s,l)){var u={};return this.altAudio&&(u.type="video"),this.hls.trigger(Tr.BUFFER_EOS,u),void(this.state=zn.ENDED)}t.loadLevel!==d&&-1===t.manualLevel&&this.log("Adapting to level "+d+" from level "+this.level),this.level=t.nextLoadLevel=d;var c=o.details;if(!c||this.state===zn.WAITING_LEVEL||c.live&&this.levelLastLoaded!==d)return this.level=d,void(this.state=zn.WAITING_LEVEL);var f=s.len,g=this.getMaxBufferLength(o.maxBitrate);if(!(f>=g)){this.backtrackFragment&&this.backtrackFragment.start>s.end&&(this.backtrackFragment=null);var m=this.backtrackFragment?this.backtrackFragment.start:s.end,p=this.getNextFragment(m,c);if(this.couldBacktrack&&!this.fragPrevious&&p&&"initSegment"!==p.sn&&this.fragmentTracker.getState(p)!==xn.OK){var y=(null==(E=this.backtrackFragment)?p:E).sn,T=y-c.startSN,h=c.fragments[T-1],E;h&&p.cc===h.cc&&(p=h,this.fragmentTracker.removeFragment(h))}else this.backtrackFragment&&s.len&&(this.backtrackFragment=null);if(p&&this.isLoopLoading(p,m)){var S=p.gap;if(!S){var L=this.audioOnly&&!this.altAudio?br.AUDIO:br.VIDEO,R=(L===br.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;R&&this.afterBufferFlushed(R,L,yn.MAIN)}p=this.getNextFragmentLoopLoading(p,c,s,yn.MAIN,g)}p&&(p.initSegment&&!p.initSegment.data&&!this.bitrateTest&&(p=p.initSegment),this.loadFragment(p,o,m))}}}},a.loadFragment=function n(t,a,r){var i=this.fragmentTracker.getState(t);this.fragCurrent=t,i===xn.NOT_LOADED||i===xn.PARTIAL?"initSegment"===t.sn?this._loadInitSegment(t,a):this.bitrateTest?(this.log("Fragment "+t.sn+" of level "+t.level+" is being downloaded to test bitrate and will not be buffered"),this._loadBitrateTestFrag(t,a)):(this.startFragRequested=!0,e.prototype.loadFragment.call(this,t,a,r)):this.clearTrackerIfNeeded(t)},a.getBufferedFrag=function t(e){return this.fragmentTracker.getBufferedFrag(e,yn.MAIN)},a.followingBufferedFrag=function t(e){return e?this.getBufferedFrag(e.end+.5):null},a.immediateLevelSwitch=function e(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)},a.nextLevelSwitch=function e(){var t=this.levels,a=this.media;if(null!=a&&a.readyState){var r=this.getAppendedFrag(a.currentTime),n;r&&1<r.start&&this.flushMainBuffer(0,r.start-1);var i=this.getLevelDetails();if(null!=i&&i.live){var d=this.getMainFwdBufferInfo();if(!d||d.len<2*i.targetduration)return}if(!a.paused&&t){var s=this.hls.nextLoadLevel,l=t[s],u=this.fragLastKbps;n=u&&this.fragCurrent?this.fragCurrent.duration*l.maxBitrate/(1e3*u)+1:0}else n=0;var c=this.getBufferedFrag(a.currentTime+n);if(c){var g=this.followingBufferedFrag(c);if(g){this.abortCurrentFrag();var m=g.maxStartPTS?g.maxStartPTS:g.start,p=g.duration,y=f(c.end,m+o(f(p-this.config.maxFragLookUpTolerance,.5*p),.75*p));this.flushMainBuffer(y,Number.POSITIVE_INFINITY)}}}},a.abortCurrentFrag=function e(){var t=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,t&&(t.abortRequests(),this.fragmentTracker.removeFragment(t)),this.state){case zn.KEY_LOADING:case zn.FRAG_LOADING:case zn.FRAG_LOADING_WAITING_RETRY:case zn.PARSING:case zn.PARSED:this.state=zn.IDLE}this.nextLoadPosition=this.getLoadPosition()},a.flushMainBuffer=function r(t,a){e.prototype.flushMainBuffer.call(this,t,a,this.altAudio?"video":null)},a.onMediaAttached=function r(t,a){e.prototype.onMediaAttached.call(this,t,a);var n=a.media;this.onvplaying=this.onMediaPlaying.bind(this),this.onvseeked=this.onMediaSeeked.bind(this),n.addEventListener("playing",this.onvplaying),n.addEventListener("seeked",this.onvseeked),this.gapController=new Oi(this.config,n,this.fragmentTracker,this.hls)},a.onMediaDetaching=function t(){var a=this.media;a&&this.onvplaying&&this.onvseeked&&(a.removeEventListener("playing",this.onvplaying),a.removeEventListener("seeked",this.onvseeked),this.onvplaying=this.onvseeked=null,this.videoBuffer=null),this.fragPlaying=null,this.gapController&&(this.gapController.destroy(),this.gapController=null),e.prototype.onMediaDetaching.call(this)},a.onMediaPlaying=function e(){this.tick()},a.onMediaSeeked=function e(){var t=this.media,a=t?t.currentTime:null;yr(a)&&this.log("Media seeked to "+a.toFixed(3));var r=this.getMainFwdBufferInfo();return null===r||0===r.len?void this.warn("Main forward buffer length on \"seeked\" event "+(r?r.len:"empty")+")"):void this.tick()},a.onManifestLoading=function e(){this.log("Trigger BUFFER_RESET"),this.hls.trigger(Tr.BUFFER_RESET,void 0),this.fragmentTracker.removeAllFragments(),this.couldBacktrack=!1,this.startPosition=this.lastCurrentTime=0,this.levels=this.fragPlaying=this.backtrackFragment=null,this.altAudio=this.audioOnly=!1},a.onManifestParsed=function a(e,t){var r=!1,n=!1,i;t.levels.forEach(function(e){i=e.audioCodec,i&&(-1!==i.indexOf("mp4a.40.2")&&(r=!0),-1!==i.indexOf("mp4a.40.5")&&(n=!0))}),this.audioCodecSwitch=r&&n&&!Gt(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=t.levels,this.startFragRequested=!1},a.onLevelLoading=function a(e,t){var r=this.levels;if(r&&this.state===zn.IDLE){var n=r[t.level];(!n.details||n.details.live&&this.levelLastLoaded!==t.level||this.waitForCdnTuneIn(n.details))&&(this.state=zn.WAITING_LEVEL)}},a.onLevelLoaded=function a(e,t){var r=this.levels,n=t.level,i=t.details,d=i.totalduration,o;if(!r)return void this.warn("Levels were reset while loading level "+n);this.log("Level "+n+" loaded ["+i.startSN+","+i.endSN+"]"+(i.lastPartSn?"[part-"+i.lastPartSn+"-"+i.lastPartIndex+"]":"")+", cc ["+i.startCC+", "+i.endCC+"] duration:"+d);var s=r[n],l=this.fragCurrent;l&&(this.state===zn.FRAG_LOADING||this.state===zn.FRAG_LOADING_WAITING_RETRY)&&(l.level!==t.level||l.urlId!==s.urlId)&&l.loader&&this.abortCurrentFrag();var u=0;if(i.live||null!=(o=s.details)&&o.live){if(this.checkLiveUpdate(i),i.deltaUpdateFailed)return;u=this.alignPlaylists(i,s.details)}if(s.details=i,this.levelLastLoaded=n,this.hls.trigger(Tr.LEVEL_UPDATED,{details:i,level:n}),this.state===zn.WAITING_LEVEL){if(this.waitForCdnTuneIn(i))return;this.state=zn.IDLE}this.startFragRequested?i.live&&this.synchronizeToLiveEdge(i):this.setStartPosition(i,u),this.tick()},a._handleFragmentLoadProgress=function t(e){var a=e.frag,r=e.part,n=e.payload,i=this.levels,d;if(!i)return void this.warn("Levels were reset while fragment load was in progress. Fragment "+a.sn+" of level "+a.level+" will not be buffered");var o=i[a.level],s=o.details;if(!s)return this.warn("Dropping fragment "+a.sn+" of level "+a.level+" after level details were reset"),void this.fragmentTracker.removeFragment(a);var l=o.videoCodec,u=s.PTSKnown||!s.live,c=null==(d=a.initSegment)?void 0:d.data,f=this._getAudioCodec(o),g=this.transmuxer=this.transmuxer||new xi(this.hls,yn.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),m=r?r.index:-1,p=-1!==m,y=new Kn(a.level,a.sn,a.stats.chunkCount,n.byteLength,m,p),T=this.initPTS[a.cc];g.push(n,c,f,l,a,r,s.totalduration,u,y,T)},a.onAudioTrackSwitching=function a(e,t){var r=this.altAudio,i=!!t.url;if(!i){if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;var d=this.fragCurrent;d&&(this.log("Switching to main audio track, cancel main fragment load"),d.abortRequests(),this.fragmentTracker.removeFragment(d)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();var o=this.hls;r&&(o.trigger(Tr.BUFFER_FLUSHING,{startOffset:0,endOffset:n,type:null}),this.fragmentTracker.removeAllFragments()),o.trigger(Tr.AUDIO_TRACK_SWITCHED,t)}},a.onAudioTrackSwitched=function a(e,t){var r=t.id,n=!!this.hls.audioTracks[r].url;if(n){var i=this.videoBuffer;i&&this.mediaBuffer!==i&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=i)}this.altAudio=n,this.tick()},a.onBufferCreated=function a(e,t){var r=t.tracks,n=!1,i,d;for(var o in r){var s=r[o];if("main"!==s.id)n=!0;else if(d=o,i=s,"video"===o){var l=r[o];l&&(this.videoBuffer=l.buffer)}}n&&i?(this.log("Alternate track found, use "+d+".buffered to schedule main fragment loading"),this.mediaBuffer=i.buffer):this.mediaBuffer=this.media},a.onFragBuffered=function a(e,t){var r=t.frag,n=t.part;if(!(r&&r.type!==yn.MAIN)){if(this.fragContextChanged(r))return this.warn("Fragment "+r.sn+(n?" p: "+n.index:"")+" of level "+r.level+" finished buffering, but was aborted. state: "+this.state),void(this.state===zn.PARSED&&(this.state=zn.IDLE));var i=n?n.stats:r.stats;this.fragLastKbps=d(8*i.total/(i.buffering.end-i.loading.first)),"initSegment"!==r.sn&&(this.fragPrevious=r),this.fragBufferedComplete(r,n)}},a.onError=function a(e,t){var r;if(t.fatal)return void(this.state=zn.ERROR);switch(t.details){case Er.FRAG_GAP:case Er.FRAG_PARSING_ERROR:case Er.FRAG_DECRYPT_ERROR:case Er.FRAG_LOAD_ERROR:case Er.FRAG_LOAD_TIMEOUT:case Er.KEY_LOAD_ERROR:case Er.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(yn.MAIN,t);break;case Er.LEVEL_LOAD_ERROR:case Er.LEVEL_LOAD_TIMEOUT:case Er.LEVEL_PARSING_ERROR:t.levelRetry||this.state!==zn.WAITING_LEVEL||(null==(r=t.context)?void 0:r.type)!==pn.LEVEL||(this.state=zn.IDLE);break;case Er.BUFFER_FULL_ERROR:if(!t.parent||"main"!==t.parent)return;this.reduceLengthAndFlushBuffer(t)&&this.flushMainBuffer(0,Number.POSITIVE_INFINITY);break;case Er.INTERNAL_EXCEPTION:this.recoverWorkerError(t)}},a.checkBuffer=function e(){var t=this.media,a=this.gapController;if(t&&a&&t.readyState){if(this.loadedmetadata||!Gn.getBuffered(t).length){var r=this.state===zn.IDLE?null:this.fragCurrent;a.poll(this.lastCurrentTime,r)}this.lastCurrentTime=t.currentTime}},a.onFragLoadEmergencyAborted=function e(){this.state=zn.IDLE,this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition),this.tickImmediate()},a.onBufferFlushed=function a(e,t){var r=t.type;if(r!==br.AUDIO||this.audioOnly&&!this.altAudio){var n=(r===br.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;this.afterBufferFlushed(n,r,yn.MAIN)}},a.onLevelsUpdated=function a(e,t){this.levels=t.levels},a.swapAudioCodec=function e(){this.audioCodecSwap=!this.audioCodecSwap},a.seekToStartPos=function e(){var t=this.media;if(t){var a=t.currentTime,r=this.startPosition;if(0<=r&&a<r){if(t.seeking)return void this.log("could not seek to "+r+", already seeking at "+a);var n=Gn.getBuffered(t),i=n.length?n.start(0):0,d=i-r;0<d&&(d<this.config.maxBufferHole||d<this.config.maxFragLookUpTolerance)&&(this.log("adjusting start position by "+d+" to match buffer start"),r+=d,this.startPosition=r),this.log("seek to target start position "+r+" from current time "+a),t.currentTime=r}}},a._getAudioCodec=function t(e){var a=this.config.defaultAudioCodec||e.audioCodec;return this.audioCodecSwap&&a&&(this.log("Swapping audio codec"),a=-1===a.indexOf("mp4a.40.5")?"mp4a.40.5":"mp4a.40.2"),a},a._loadBitrateTestFrag=function a(e,t){var r=this;e.bitrateTest=!0,this._doFragLoad(e,t).then(function(a){var n=r.hls;if(a&&!r.fragContextChanged(e)){t.fragmentError=0,r.state=zn.IDLE,r.startFragRequested=!1,r.bitrateTest=!1;var i=e.stats;i.parsing.start=i.parsing.end=i.buffering.start=i.buffering.end=self.performance.now(),n.trigger(Tr.FRAG_LOADED,a),e.bitrateTest=!1}})},a._handleTransmuxComplete=function t(e){var a="main",r=this.hls,n=e.remuxResult,i=e.chunkMeta,d=this.getCurrentContext(i),o;if(!d)return void this.resetWhenMissingContext(i);var s=d.frag,l=d.part,u=d.level,c=n.video,f=n.text,g=n.id3,m=n.initSegment,p=u.details,y=this.altAudio?void 0:n.audio;if(this.fragContextChanged(s))return void this.fragmentTracker.removeFragment(s);if(this.state=zn.PARSING,m){if(null!=m&&m.tracks){var T=s.initSegment||s;this._bufferInitSegment(u,m.tracks,T,i),r.trigger(Tr.FRAG_PARSING_INIT_SEGMENT,{frag:T,id:a,tracks:m.tracks})}var h=m.initPTS,E=m.timescale;yr(h)&&(this.initPTS[s.cc]={baseTime:h,timescale:E},r.trigger(Tr.INIT_PTS_FOUND,{frag:s,id:a,initPTS:h,timescale:E}))}if(c&&p&&"initSegment"!==s.sn){var S=p.fragments[s.sn-1-p.startSN],L=s.sn===p.startSN,R=!S||s.cc>S.cc;if(!1!==n.independent){var A=c.startPTS,v=c.endPTS,I=c.startDTS,D=c.endDTS;if(l)l.elementaryStreams[c.type]={startPTS:A,endPTS:v,startDTS:I,endDTS:D};else if(c.firstKeyFrame&&c.independent&&1===i.id&&!R&&(this.couldBacktrack=!0),c.dropped&&c.independent){var k=this.getMainFwdBufferInfo(),_=(k?k.end:this.getLoadPosition())+this.config.maxBufferHole,b=c.firstKeyFramePTS?c.firstKeyFramePTS:A;if(!L&&_<b-this.config.maxBufferHole&&!R)return void this.backtrack(s);R&&(s.gap=!0),s.setElementaryStreamInfo(c.type,s.start,v,s.start,D,!0)}s.setElementaryStreamInfo(c.type,A,v,I,D),this.backtrackFragment&&(this.backtrackFragment=s),this.bufferFragmentData(c,s,l,i,L||R)}else if(L||R)s.gap=!0;else return void this.backtrack(s)}if(y){var C=y.startPTS,P=y.endPTS,x=y.startDTS,F=y.endDTS;l&&(l.elementaryStreams[br.AUDIO]={startPTS:C,endPTS:P,startDTS:x,endDTS:F}),s.setElementaryStreamInfo(br.AUDIO,C,P,x,F),this.bufferFragmentData(y,s,l,i)}if(p&&null!=g&&null!=(o=g.samples)&&o.length){var O={id:a,frag:s,details:p,samples:g.samples};r.trigger(Tr.FRAG_PARSING_METADATA,O)}if(p&&f){var N={id:a,frag:s,details:p,samples:f.samples};r.trigger(Tr.FRAG_PARSING_USERDATA,N)}},a._bufferInitSegment=function n(e,t,a,r){var i=this;if(this.state===zn.PARSING){this.audioOnly=!!t.audio&&!t.video,this.altAudio&&!this.audioOnly&&delete t.audio;var d=t.audio,o=t.video,s=t.audiovideo;if(d){var l=e.audioCodec,u=navigator.userAgent.toLowerCase();this.audioCodecSwitch&&(l&&(-1===l.indexOf("mp4a.40.5")?l="mp4a.40.5":l="mp4a.40.2"),1!==d.metadata.channelCount&&-1===u.indexOf("firefox")&&(l="mp4a.40.5")),-1!==u.indexOf("android")&&"audio/mpeg"!==d.container&&(l="mp4a.40.2",this.log("Android: force audio codec to "+l)),e.audioCodec&&e.audioCodec!==l&&this.log("Swapping manifest audio codec \""+e.audioCodec+"\" for \""+l+"\""),d.levelCodec=l,d.id="main",this.log("Init audio buffer, container:"+d.container+", codecs[selected/level/parsed]=["+(l||"")+"/"+(e.audioCodec||"")+"/"+d.codec+"]")}o&&(o.levelCodec=e.videoCodec,o.id="main",this.log("Init video buffer, container:"+o.container+", codecs[level/parsed]=["+(e.videoCodec||"")+"/"+o.codec+"]")),s&&this.log("Init audiovideo buffer, container:"+s.container+", codecs[level/parsed]=["+(e.attrs.CODECS||"")+"/"+s.codec+"]"),this.hls.trigger(Tr.BUFFER_CODECS,t),Object.keys(t).forEach(function(e){var n=t[e],d=n.initSegment;null!=d&&d.byteLength&&i.hls.trigger(Tr.BUFFER_APPENDING,{type:e,data:d,frag:a,part:null,chunkMeta:r,parent:a.type})}),this.tick()}},a.getMainFwdBufferInfo=function e(){return this.getFwdBufferInfo(this.mediaBuffer?this.mediaBuffer:this.media,yn.MAIN)},a.backtrack=function t(e){this.couldBacktrack=!0,this.backtrackFragment=e,this.resetTransmuxer(),this.flushBufferGap(e),this.fragmentTracker.removeFragment(e),this.fragPrevious=null,this.nextLoadPosition=e.start,this.state=zn.IDLE},a.checkFragmentChanged=function e(){var t=this.media,a=null;if(t&&1<t.readyState&&!1===t.seeking){var r=t.currentTime;if(Gn.isBuffered(t,r)?a=this.getAppendedFrag(r):Gn.isBuffered(t,r+.1)&&(a=this.getAppendedFrag(r+.1)),a){this.backtrackFragment=null;var n=this.fragPlaying,i=a.level;n&&a.sn===n.sn&&n.level===i&&a.urlId===n.urlId||(this.fragPlaying=a,this.hls.trigger(Tr.FRAG_CHANGED,{frag:a}),(!n||n.level!==i)&&this.hls.trigger(Tr.LEVEL_SWITCHED,{level:i}))}}},T(t,[{key:"nextLevel",get:function e(){var t=this.nextBufferedFrag;return t?t.level:-1}},{key:"currentFrag",get:function e(){var t=this.media;return t?this.fragPlaying||this.getAppendedFrag(t.currentTime):null}},{key:"currentProgramDateTime",get:function e(){var t=this.media;if(t){var a=t.currentTime,r=this.currentFrag;if(r&&yr(a)&&yr(r.programDateTime)){var n=r.programDateTime+1e3*(a-r.start);return new Date(n)}}return null}},{key:"currentLevel",get:function e(){var t=this.currentFrag;return t?t.level:-1}},{key:"nextBufferedFrag",get:function e(){var t=this.currentFrag;return t?this.followingBufferedFrag(t):null}},{key:"forceStartLoad",get:function e(){return this._forceStartLoad}}]),t}(jn),Mi=function(){function e(e,t,a){var n=Math.log;void 0===t&&(t=0),void 0===a&&(a=0),this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=e,this.alpha_=e?r(n(.5)/e):0,this.estimate_=t,this.totalWeight_=a}var t=e.prototype;return t.sample=function a(e,t){var r=c(this.alpha_,e);this.estimate_=t*(1-r)+r*this.estimate_,this.totalWeight_+=e},t.getTotalWeight=function e(){return this.totalWeight_},t.getEstimate=function e(){if(this.alpha_){var t=1-c(this.alpha_,this.totalWeight_);if(t)return this.estimate_/t}return this.estimate_},e}(),wi=function(){function e(e,t,a,r){void 0===r&&(r=100),this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=a,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new Mi(e),this.fast_=new Mi(t),this.defaultTTFB_=r,this.ttfb_=new Mi(e)}var t=e.prototype;return t.update=function a(e,t){var r=this.slow_,n=this.fast_,i=this.ttfb_;r.halfLife!==e&&(this.slow_=new Mi(e,r.getEstimate(),r.getTotalWeight())),n.halfLife!==t&&(this.fast_=new Mi(t,n.getEstimate(),n.getTotalWeight())),i.halfLife!==e&&(this.ttfb_=new Mi(e,i.getEstimate(),i.getTotalWeight()))},t.sample=function a(e,t){e=f(e,this.minDelayMs_);var r=8*t,n=e/1e3,i=r/n;this.fast_.sample(n,i),this.slow_.sample(n,i)},t.sampleTTFB=function t(e){var a=Math.sqrt,n=e/1e3,i=a(2)*r(-c(n,2)/2);this.ttfb_.sample(i,f(e,5))},t.canEstimate=function e(){return this.fast_.getTotalWeight()>=this.minWeight_},t.getEstimate=function e(){return this.canEstimate()?o(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_},t.getEstimateTTFB=function e(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_},t.destroy=function e(){},e}(),Bi=function(){function e(e){this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=0,this._nextAutoLevel=-1,this.timer=-1,this.onCheck=this._abandonRulesCheck.bind(this),this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.bwEstimator=void 0,this.hls=e;var t=e.config;this.bwEstimator=new wi(t.abrEwmaSlowVoD,t.abrEwmaFastVoD,t.abrEwmaDefaultEstimate),this.registerListeners()}var t=e.prototype;return t.registerListeners=function e(){var t=this.hls;t.on(Tr.FRAG_LOADING,this.onFragLoading,this),t.on(Tr.FRAG_LOADED,this.onFragLoaded,this),t.on(Tr.FRAG_BUFFERED,this.onFragBuffered,this),t.on(Tr.LEVEL_SWITCHING,this.onLevelSwitching,this),t.on(Tr.LEVEL_LOADED,this.onLevelLoaded,this)},t.unregisterListeners=function e(){var t=this.hls;t.off(Tr.FRAG_LOADING,this.onFragLoading,this),t.off(Tr.FRAG_LOADED,this.onFragLoaded,this),t.off(Tr.FRAG_BUFFERED,this.onFragBuffered,this),t.off(Tr.LEVEL_SWITCHING,this.onLevelSwitching,this),t.off(Tr.LEVEL_LOADED,this.onLevelLoaded,this)},t.destroy=function e(){this.unregisterListeners(),this.clearTimer(),this.hls=this.onCheck=null,this.fragCurrent=this.partCurrent=null},t.onFragLoading=function a(e,t){var r=t.frag,n;this.ignoreFragment(r)||(this.fragCurrent=r,this.partCurrent=null==(n=t.part)?null:n,this.clearTimer(),this.timer=self.setInterval(this.onCheck,100))},t.onLevelSwitching=function a(e,t){this.clearTimer()},t.getTimeToLoadFrag=function n(e,t,a,r){var i=e+a/t,d=r?this.lastLevelLoadSec:0;return i+d},t.onLevelLoaded=function a(e,t){var r=this.hls.config,n=t.stats,i=n.total,d=n.bwEstimate;yr(i)&&yr(d)&&(this.lastLevelLoadSec=8*i/d),t.details.live?this.bwEstimator.update(r.abrEwmaSlowLive,r.abrEwmaFastLive):this.bwEstimator.update(r.abrEwmaSlowVoD,r.abrEwmaFastVoD)},t._abandonRulesCheck=function e(){var t=this.fragCurrent,a=this.partCurrent,r=this.hls,i=r.autoLevelEnabled,l=r.media;if(t&&l){var u=performance.now(),c=a?a.stats:t.stats,g=a?a.duration:t.duration,m=u-c.loading.start;if(c.aborted||c.loaded&&c.loaded===c.total||0===t.level)return this.clearTimer(),void(this._nextAutoLevel=-1);if(i&&!l.paused&&l.playbackRate&&l.readyState){var p=r.mainForwardBufferInfo;if(null!==p){var y=this.bwEstimator.getEstimateTTFB(),T=s(l.playbackRate);if(!(m<=f(y,1e3*(g/(2*T))))){var h=p.len/T;if(!(h>=2*g/T)){var E=c.loading.first?c.loading.first-c.loading.start:-1,S=c.loaded&&-1<E,L=this.bwEstimator.getEstimate(),R=r.levels,A=r.minAutoLevel,v=R[t.level],I=c.total||f(c.loaded,d(g*v.maxBitrate/8)),D=m-E;1>D&&S&&(D=o(m,8*c.loaded/L));var k=S?1e3*c.loaded/D:0,_=k?(I-c.loaded)/k:8*I/L+y/1e3;if(!(_<=h)){var b=k?8*k:L,C=n,P;for(P=t.level-1;P>A;P--){var x=R[P].maxBitrate;if(C=this.getTimeToLoadFrag(y/1e3,b,g*x,!R[P].details),C<h)break}C>=_||C>10*g||(r.nextLoadLevel=P,S?this.bwEstimator.sample(m-o(y,E),c.loaded):this.bwEstimator.sampleTTFB(m),this.clearTimer(),Ar.warn("[abr] Fragment "+t.sn+(a?" part "+a.index:"")+" of level "+t.level+" is loading too slowly;\n      Time to underbuffer: "+h.toFixed(3)+" s\n      Estimated load time for current fragment: "+_.toFixed(3)+" s\n      Estimated load time for down switch fragment: "+C.toFixed(3)+" s\n      TTFB estimate: "+E+"\n      Current BW estimate: "+(yr(L)?(L/1024).toFixed(3):"Unknown")+" Kb/s\n      New BW estimate: "+(this.bwEstimator.getEstimate()/1024).toFixed(3)+" Kb/s\n      Aborting and switching to level "+P),t.loader&&(this.fragCurrent=this.partCurrent=null,t.abortRequests()),r.trigger(Tr.FRAG_LOAD_EMERGENCY_ABORTED,{frag:t,part:a,stats:c}))}}}}}}},t.onFragLoaded=function a(e,t){var r=t.frag,n=t.part,i=n?n.stats:r.stats;if(r.type===yn.MAIN&&this.bwEstimator.sampleTTFB(i.loading.first-i.loading.start),!this.ignoreFragment(r)){if(this.clearTimer(),this.lastLoadedFragLevel=r.level,this._nextAutoLevel=-1,this.hls.config.abrMaxWithRealBitrate){var o=n?n.duration:r.duration,s=this.hls.levels[r.level],l=(s.loaded?s.loaded.bytes:0)+i.loaded,u=(s.loaded?s.loaded.duration:0)+o;s.loaded={bytes:l,duration:u},s.realBitrate=d(8*l/u)}if(r.bitrateTest){var c={stats:i,frag:r,part:n,id:r.type};this.onFragBuffered(Tr.FRAG_BUFFERED,c),r.bitrateTest=!1}}},t.onFragBuffered=function a(e,t){var r=t.frag,n=t.part,i=null!=n&&n.stats.loaded?n.stats:r.stats;if(!i.aborted&&!this.ignoreFragment(r)){var d=i.parsing.end-i.loading.start-o(i.loading.first-i.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(d,i.loaded),i.bwEstimate=this.bwEstimator.getEstimate(),this.bitrateTestDelay=r.bitrateTest?d/1e3:0}},t.ignoreFragment=function t(e){return e.type!==yn.MAIN||"initSegment"===e.sn},t.clearTimer=function e(){self.clearInterval(this.timer)},t.getNextABRAutoLevel=function e(){var t=this.fragCurrent,a=this.partCurrent,r=this.hls,n=r.maxAutoLevel,i=r.config,l=r.minAutoLevel,u=r.media,c=a?a.duration:t?t.duration:0,g=u&&0!==u.playbackRate?s(u.playbackRate):1,m=this.bwEstimator?this.bwEstimator.getEstimate():i.abrEwmaDefaultEstimate,p=r.mainForwardBufferInfo,y=(p?p.len:0)/g,T=this.findBestLevel(m,l,n,y,i.abrBandWidthFactor,i.abrBandWidthUpFactor);if(0<=T)return T;Ar.trace("[abr] "+(y?"rebuffering expected":"buffer is empty")+", finding optimal quality level");var h=c?o(c,i.maxStarvationDelay):i.maxStarvationDelay,E=i.abrBandWidthFactor,S=i.abrBandWidthUpFactor;if(!y){var L=this.bitrateTestDelay;if(L){var R=c?o(c,i.maxLoadingDelay):i.maxLoadingDelay;h=R-L,Ar.trace("[abr] bitrate test took "+d(1e3*L)+"ms, set first fragment max fetchDuration to "+d(1e3*h)+" ms"),E=S=1}}return T=this.findBestLevel(m,l,n,y+h,E,S),f(T,0)},t.findBestLevel=function l(e,t,a,r,n,s){for(var u=this.fragCurrent,c=this.partCurrent,g=this.lastLoadedFragLevel,m=this.hls.levels,p=m[g],y=!!(null!=p&&null!=(A=p.details)&&A.live),T=null==p?void 0:p.codecSet,h=c?c.duration:u?u.duration:0,E=this.bwEstimator.getEstimateTTFB()/1e3,S=t,L=-1,R=a,A,v;R>=t;R--){if(v=m[R],!v||T&&v.codecSet!==T){v&&(S=o(R,S),L=f(R,L));continue}-1!==L&&Ar.trace("[abr] Skipped level(s) "+S+"-"+L+" with CODECS:\""+m[L].attrs.CODECS+"\"; not compatible with \""+p.attrs.CODECS+"\"");var I=v.details,D=(c?null==I?void 0:I.partTarget:null==I?void 0:I.averagetargetduration)||h,k=void 0;k=R<=g?n*e:s*e;var _=m[R].maxBitrate,b=this.getTimeToLoadFrag(E,k,_*D,void 0===I);if(Ar.trace("[abr] level:"+R+" adjustedbw-bitrate:"+d(k-_)+" avgDuration:"+D.toFixed(1)+" maxFetchDuration:"+r.toFixed(1)+" fetchDuration:"+b.toFixed(1)),k>_&&(0===b||!yr(b)||y&&!this.bitrateTestDelay||b<r))return R}return-1},T(e,[{key:"nextAutoLevel",get:function e(){var t=this._nextAutoLevel,a=this.bwEstimator;if(-1!==t&&!a.canEstimate())return t;var r=this.getNextABRAutoLevel();if(-1!==t){var n=this.hls.levels;if(n.length>f(t,r)&&n[t].loadError<=n[r].loadError)return t}return-1!==t&&(r=o(t,r)),r},set:function t(e){this._nextAutoLevel=e}}]),e}(),Ui=function(){function e(){this.chunks=[],this.dataLength=0}var t=e.prototype;return t.push=function t(e){this.chunks.push(e),this.dataLength+=e.length},t.flush=function e(){var t=this.chunks,a=this.dataLength,r;return t.length?(r=1===t.length?t[0]:Pa(t,a),this.reset(),r):new Uint8Array(0)},t.reset=function e(){this.chunks.length=0,this.dataLength=0},e}(),Gi=100,Ki=function(e){function t(t,a,r){var n;return n=e.call(this,t,a,r,"[audio-stream-controller]",yn.AUDIO)||this,n.videoBuffer=null,n.videoTrackCC=-1,n.waitingVideoCC=-1,n.bufferedTrack=null,n.switchingTrack=null,n.trackId=-1,n.waitingData=null,n.mainDetails=null,n.bufferFlushed=!1,n.cachedTrackLoadedData=null,n._registerListeners(),n}S(t,e);var a=t.prototype;return a.onHandlerDestroying=function e(){this._unregisterListeners(),this.mainDetails=null,this.bufferedTrack=null,this.switchingTrack=null},a._registerListeners=function e(){var t=this.hls;t.on(Tr.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(Tr.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(Tr.MANIFEST_LOADING,this.onManifestLoading,this),t.on(Tr.LEVEL_LOADED,this.onLevelLoaded,this),t.on(Tr.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),t.on(Tr.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.on(Tr.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.on(Tr.ERROR,this.onError,this),t.on(Tr.BUFFER_RESET,this.onBufferReset,this),t.on(Tr.BUFFER_CREATED,this.onBufferCreated,this),t.on(Tr.BUFFER_FLUSHED,this.onBufferFlushed,this),t.on(Tr.INIT_PTS_FOUND,this.onInitPtsFound,this),t.on(Tr.FRAG_BUFFERED,this.onFragBuffered,this)},a._unregisterListeners=function e(){var t=this.hls;t.off(Tr.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(Tr.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(Tr.MANIFEST_LOADING,this.onManifestLoading,this),t.off(Tr.LEVEL_LOADED,this.onLevelLoaded,this),t.off(Tr.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),t.off(Tr.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.off(Tr.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.off(Tr.ERROR,this.onError,this),t.off(Tr.BUFFER_RESET,this.onBufferReset,this),t.off(Tr.BUFFER_CREATED,this.onBufferCreated,this),t.off(Tr.BUFFER_FLUSHED,this.onBufferFlushed,this),t.off(Tr.INIT_PTS_FOUND,this.onInitPtsFound,this),t.off(Tr.FRAG_BUFFERED,this.onFragBuffered,this)},a.onInitPtsFound=function a(e,t){var r=t.frag,n=t.id,i=t.initPTS,d=t.timescale;if("main"===n){var o=r.cc;this.initPTS[r.cc]={baseTime:i,timescale:d},this.log("InitPTS for cc: "+o+" found from main: "+i),this.videoTrackCC=o,this.state===zn.WAITING_INIT_PTS&&this.tick()}},a.startLoad=function t(e){if(!this.levels)return this.startPosition=e,void(this.state=zn.STOPPED);var a=this.lastCurrentTime;this.stopLoad(),this.setInterval(Gi),0<a&&-1===e?(this.log("Override startPosition with lastCurrentTime @"+a.toFixed(3)),e=a,this.state=zn.IDLE):(this.loadedmetadata=!1,this.state=zn.WAITING_TRACK),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()},a.doTick=function t(){switch(this.state){case zn.IDLE:this.doTickIdle();break;case zn.WAITING_TRACK:{var a=this.levels,r=this.trackId,n=null==a||null==(i=a[r])?void 0:i.details,i;if(n){if(this.waitForCdnTuneIn(n))break;this.state=zn.WAITING_INIT_PTS}break}case zn.FRAG_LOADING_WAITING_RETRY:{var d=performance.now(),o=this.retryDate,s;(!o||d>=o||null!=(s=this.media)&&s.seeking)&&(this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded(this.trackId),this.state=zn.IDLE);break}case zn.WAITING_INIT_PTS:{var l=this.waitingData;if(l){var u=l.frag,c=l.part,f=l.cache,g=l.complete;if(void 0!==this.initPTS[u.cc]){this.waitingData=null,this.waitingVideoCC=-1,this.state=zn.FRAG_LOADING;var m=f.flush(),p={frag:u,part:c,payload:m,networkDetails:null};this._handleFragmentLoadProgress(p),g&&e.prototype._handleFragmentLoadComplete.call(this,p)}else if(this.videoTrackCC!==this.waitingVideoCC)this.log("Waiting fragment cc ("+u.cc+") cancelled because video is at cc "+this.videoTrackCC),this.clearWaitingFragment();else{var y=this.getLoadPosition(),T=Gn.bufferInfo(this.mediaBuffer,y,this.config.maxBufferHole),h=Tt(T.end,this.config.maxFragLookUpTolerance,u);0>h&&(this.log("Waiting fragment cc ("+u.cc+") @ "+u.start+" cancelled because another fragment at "+T.end+" is needed"),this.clearWaitingFragment())}}else this.state=zn.IDLE}}this.onTickEnd()},a.clearWaitingFragment=function e(){var t=this.waitingData;t&&(this.fragmentTracker.removeFragment(t.frag),this.waitingData=null,this.waitingVideoCC=-1,this.state=zn.IDLE)},a.resetLoadingState=function t(){this.clearWaitingFragment(),e.prototype.resetLoadingState.call(this)},a.onTickEnd=function e(){var t=this.media;null!=t&&t.readyState&&(this.lastCurrentTime=t.currentTime)},a.doTickIdle=function e(){var t=this.hls,a=this.levels,r=this.media,n=this.trackId,i=t.config;if(null!=a&&a[n]&&(r||!this.startFragRequested&&i.startFragPrefetch)){var d=a[n],o=d.details;if(!o||o.live&&this.levelLastLoaded!==n||this.waitForCdnTuneIn(o))return void(this.state=zn.WAITING_TRACK);var s=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&s&&(this.bufferFlushed=!1,this.afterBufferFlushed(s,br.AUDIO,yn.AUDIO));var l=this.getFwdBufferInfo(s,yn.AUDIO);if(null!==l){var u=this.bufferedTrack,c=this.switchingTrack;if(!c&&this._streamEnded(l,o))return t.trigger(Tr.BUFFER_EOS,{type:"audio"}),void(this.state=zn.ENDED);var f=this.getFwdBufferInfo(this.videoBuffer?this.videoBuffer:this.media,yn.MAIN),g=l.len,m=this.getMaxBufferLength(null==f?void 0:f.len);if(!(g>=m)||c){var p=o.fragments,y=p[0].start,T=l.end;if(c&&r){var h=this.getLoadPosition();u&&c.attrs!==u.attrs&&(T=h),o.PTSKnown&&h<y&&(l.end>y||l.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),r.currentTime=y+.05)}var E=this.getNextFragment(T,o),S=!1;if(E&&this.isLoopLoading(E,T)&&(S=!!E.gap,E=this.getNextFragmentLoopLoading(E,o,l,yn.MAIN,m)),!E)return void(this.bufferFlushed=!0);var L=f&&E.start>f.end+o.targetduration;if(L||!(null!=f&&f.len)&&l.len){var R=this.getAppendedFrag(E.start,yn.MAIN);if(null===R)return;if(S||(S=!!R.gap||!!L&&0===f.len),L&&!S||S&&l.nextStart&&l.nextStart<R.end)return}this.loadFragment(E,d,T)}}}},a.getMaxBufferLength=function a(t){var r=e.prototype.getMaxBufferLength.call(this);return t?o(f(r,t),this.config.maxMaxBufferLength):r},a.onMediaDetaching=function t(){this.videoBuffer=null,e.prototype.onMediaDetaching.call(this)},a.onAudioTracksUpdated=function a(e,t){var r=t.audioTracks;this.resetTransmuxer(),this.levels=r.map(function(e){return new In(e)})},a.onAudioTrackSwitching=function a(e,t){var r=!!t.url;this.trackId=t.id;var n=this.fragCurrent;n&&(n.abortRequests(),this.removeUnbufferedFrags(n.start)),this.resetLoadingState(),r?this.setInterval(Gi):this.resetTransmuxer(),r?(this.switchingTrack=t,this.state=zn.IDLE):(this.switchingTrack=null,this.bufferedTrack=t,this.state=zn.STOPPED),this.tick()},a.onManifestLoading=function e(){this.fragmentTracker.removeAllFragments(),this.startPosition=this.lastCurrentTime=0,this.bufferFlushed=!1,this.levels=this.mainDetails=this.waitingData=this.bufferedTrack=this.cachedTrackLoadedData=this.switchingTrack=null,this.startFragRequested=!1,this.trackId=this.videoTrackCC=this.waitingVideoCC=-1},a.onLevelLoaded=function a(e,t){this.mainDetails=t.details,null!==this.cachedTrackLoadedData&&(this.hls.trigger(Tr.AUDIO_TRACK_LOADED,this.cachedTrackLoadedData),this.cachedTrackLoadedData=null)},a.onAudioTrackLoaded=function a(e,t){var r;if(null==this.mainDetails)return void(this.cachedTrackLoadedData=t);var n=this.levels,i=t.details,d=t.id;if(!n)return void this.warn("Audio tracks were reset while loading level "+d);this.log("Track "+d+" loaded ["+i.startSN+","+i.endSN+"]"+(i.lastPartSn?"[part-"+i.lastPartSn+"-"+i.lastPartIndex+"]":"")+",duration:"+i.totalduration);var o=n[d],s=0;if(i.live||null!=(r=o.details)&&r.live){this.checkLiveUpdate(i);var l=this.mainDetails;if(i.deltaUpdateFailed||!l)return;!o.details&&i.hasProgramDateTime&&l.hasProgramDateTime?(Mt(i,l),s=i.fragments[0].start):s=this.alignPlaylists(i,o.details)}o.details=i,this.levelLastLoaded=d,this.startFragRequested||!this.mainDetails&&i.live||this.setStartPosition(o.details,s),this.state!==zn.WAITING_TRACK||this.waitForCdnTuneIn(i)||(this.state=zn.IDLE),this.tick()},a._handleFragmentLoadProgress=function t(e){var a=e.frag,r=e.part,n=e.payload,i=this.config,d=this.trackId,o=this.levels,s;if(!o)return void this.warn("Audio tracks were reset while fragment load was in progress. Fragment "+a.sn+" of level "+a.level+" will not be buffered");var l=o[d];if(!l)return void this.warn("Audio track is undefined on fragment load progress");var u=l.details;if(!u)return this.warn("Audio track details undefined on fragment load progress"),void this.removeUnbufferedFrags(a.start);var c=i.defaultAudioCodec||l.audioCodec||"mp4a.40.2",f=this.transmuxer;f||(f=this.transmuxer=new xi(this.hls,yn.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));var g=this.initPTS[a.cc],m=null==(s=a.initSegment)?void 0:s.data;if(void 0!==g){var p=!1,y=r?r.index:-1,T=-1!==y,h=new Kn(a.level,a.sn,a.stats.chunkCount,n.byteLength,y,T);f.push(n,m,c,"",a,r,u.totalduration,!1,h,g)}else{this.log("Unknown video PTS for cc "+a.cc+", waiting for video PTS before demuxing audio frag "+a.sn+" of ["+u.startSN+" ,"+u.endSN+"],track "+d);var E=this.waitingData=this.waitingData||{frag:a,part:r,cache:new Ui,complete:!1},S=E.cache;S.push(new Uint8Array(n)),this.waitingVideoCC=this.videoTrackCC,this.state=zn.WAITING_INIT_PTS}},a._handleFragmentLoadComplete=function a(t){return this.waitingData?void(this.waitingData.complete=!0):void e.prototype._handleFragmentLoadComplete.call(this,t)},a.onBufferReset=function e(){this.mediaBuffer=this.videoBuffer=null,this.loadedmetadata=!1},a.onBufferCreated=function a(e,t){var r=t.tracks.audio;r&&(this.mediaBuffer=r.buffer||null),t.tracks.video&&(this.videoBuffer=t.tracks.video.buffer||null)},a.onFragBuffered=function a(e,t){var r=t.frag,n=t.part;if(r.type!==yn.AUDIO){if(!this.loadedmetadata&&r.type===yn.MAIN){var i=this.videoBuffer||this.media;if(i){var d=Gn.getBuffered(i);d.length&&(this.loadedmetadata=!0)}}return}if(this.fragContextChanged(r))return void this.warn("Fragment "+r.sn+(n?" p: "+n.index:"")+" of level "+r.level+" finished buffering, but was aborted. state: "+this.state+", audioSwitch: "+(this.switchingTrack?this.switchingTrack.name:"false"));if("initSegment"!==r.sn){this.fragPrevious=r;var o=this.switchingTrack;o&&(this.bufferedTrack=o,this.switchingTrack=null,this.hls.trigger(Tr.AUDIO_TRACK_SWITCHED,p({},o)))}this.fragBufferedComplete(r,n)},a.onError=function r(t,a){var n;if(a.fatal)return void(this.state=zn.ERROR);switch(a.details){case Er.FRAG_GAP:case Er.FRAG_PARSING_ERROR:case Er.FRAG_DECRYPT_ERROR:case Er.FRAG_LOAD_ERROR:case Er.FRAG_LOAD_TIMEOUT:case Er.KEY_LOAD_ERROR:case Er.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(yn.AUDIO,a);break;case Er.AUDIO_TRACK_LOAD_ERROR:case Er.AUDIO_TRACK_LOAD_TIMEOUT:case Er.LEVEL_PARSING_ERROR:a.levelRetry||this.state!==zn.WAITING_TRACK||(null==(n=a.context)?void 0:n.type)!==pn.AUDIO_TRACK||(this.state=zn.IDLE);break;case Er.BUFFER_FULL_ERROR:if(!a.parent||"audio"!==a.parent)return;this.reduceLengthAndFlushBuffer(a)&&(this.bufferedTrack=null,e.prototype.flushMainBuffer.call(this,0,Number.POSITIVE_INFINITY,"audio"));break;case Er.INTERNAL_EXCEPTION:this.recoverWorkerError(a)}},a.onBufferFlushed=function a(e,t){var r=t.type;r===br.AUDIO&&(this.bufferFlushed=!0,this.state===zn.ENDED&&(this.state=zn.IDLE))},a._handleTransmuxComplete=function t(e){var a="audio",r=this.hls,n=e.remuxResult,i=e.chunkMeta,d=this.getCurrentContext(i),o;if(!d)return void this.resetWhenMissingContext(i);var s=d.frag,l=d.part,u=d.level,c=u.details,f=n.audio,g=n.text,m=n.id3,p=n.initSegment;if(this.fragContextChanged(s)||!c)return void this.fragmentTracker.removeFragment(s);if(this.state=zn.PARSING,this.switchingTrack&&f&&this.completeAudioSwitch(this.switchingTrack),null!=p&&p.tracks){var y=s.initSegment||s;this._bufferInitSegment(p.tracks,y,i),r.trigger(Tr.FRAG_PARSING_INIT_SEGMENT,{frag:y,id:a,tracks:p.tracks})}if(f){var T=f.startPTS,h=f.endPTS,S=f.startDTS,L=f.endDTS;l&&(l.elementaryStreams[br.AUDIO]={startPTS:T,endPTS:h,startDTS:S,endDTS:L}),s.setElementaryStreamInfo(br.AUDIO,T,h,S,L),this.bufferFragmentData(f,s,l,i)}if(null!=m&&null!=(o=m.samples)&&o.length){var R=E({id:a,frag:s,details:c},m);r.trigger(Tr.FRAG_PARSING_METADATA,R)}if(g){var A=E({id:a,frag:s,details:c},g);r.trigger(Tr.FRAG_PARSING_USERDATA,A)}},a._bufferInitSegment=function r(e,t,a){if(this.state===zn.PARSING){e.video&&delete e.video;var n=e.audio;if(n){n.levelCodec=n.codec,n.id="audio",this.log("Init audio buffer, container:"+n.container+", codecs[parsed]=["+n.codec+"]"),this.hls.trigger(Tr.BUFFER_CODECS,e);var i=n.initSegment;if(null!=i&&i.byteLength){var d={type:"audio",frag:t,part:null,chunkMeta:a,parent:t.type,data:i};this.hls.trigger(Tr.BUFFER_APPENDING,d)}this.tick()}}},a.loadFragment=function n(t,a,r){var i=this.fragmentTracker.getState(t);if(this.fragCurrent=t,this.switchingTrack||i===xn.NOT_LOADED||i===xn.PARTIAL){var d;"initSegment"===t.sn?this._loadInitSegment(t,a):null!=(d=a.details)&&d.live&&!this.initPTS[t.cc]?(this.log("Waiting for video PTS in continuity counter "+t.cc+" of live stream before loading audio fragment "+t.sn+" of level "+this.trackId),this.state=zn.WAITING_INIT_PTS):(this.startFragRequested=!0,e.prototype.loadFragment.call(this,t,a,r))}else this.clearTrackerIfNeeded(t)},a.completeAudioSwitch=function a(t){var r=this.hls,n=this.media,i=this.bufferedTrack,d=null==i?void 0:i.attrs,o=t.attrs;n&&d&&(d.CHANNELS!==o.CHANNELS||d.NAME!==o.NAME||d.LANGUAGE!==o.LANGUAGE)&&(this.log("Switching audio track : flushing all audio"),e.prototype.flushMainBuffer.call(this,0,Number.POSITIVE_INFINITY,"audio")),this.bufferedTrack=t,this.switchingTrack=null,r.trigger(Tr.AUDIO_TRACK_SWITCHED,p({},t))},t}(jn),Hi=function(e){function t(t){var a;return a=e.call(this,t,"[audio-track-controller]")||this,a.tracks=[],a.groupId=null,a.tracksInGroup=[],a.trackId=-1,a.currentTrack=null,a.selectDefaultTrack=!0,a.registerListeners(),a}S(t,e);var a=t.prototype;return a.registerListeners=function e(){var t=this.hls;t.on(Tr.MANIFEST_LOADING,this.onManifestLoading,this),t.on(Tr.MANIFEST_PARSED,this.onManifestParsed,this),t.on(Tr.LEVEL_LOADING,this.onLevelLoading,this),t.on(Tr.LEVEL_SWITCHING,this.onLevelSwitching,this),t.on(Tr.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.on(Tr.ERROR,this.onError,this)},a.unregisterListeners=function e(){var t=this.hls;t.off(Tr.MANIFEST_LOADING,this.onManifestLoading,this),t.off(Tr.MANIFEST_PARSED,this.onManifestParsed,this),t.off(Tr.LEVEL_LOADING,this.onLevelLoading,this),t.off(Tr.LEVEL_SWITCHING,this.onLevelSwitching,this),t.off(Tr.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.off(Tr.ERROR,this.onError,this)},a.destroy=function t(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,e.prototype.destroy.call(this)},a.onManifestLoading=function e(){this.tracks=[],this.groupId=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0},a.onManifestParsed=function a(e,t){this.tracks=t.audioTracks||[]},a.onAudioTrackLoaded=function a(e,t){var r=t.id,n=t.groupId,i=t.details,d=this.tracksInGroup[r];if(!d||d.groupId!==n)return void this.warn("Track with id:"+r+" and group:"+n+" not found in active group "+d.groupId);var o=d.details;d.details=t.details,this.log("audio-track "+r+" \""+d.name+"\" lang:"+d.lang+" group:"+n+" loaded ["+i.startSN+"-"+i.endSN+"]"),r===this.trackId&&this.playlistLoaded(r,t,o)},a.onLevelLoading=function a(e,t){this.switchLevel(t.level)},a.onLevelSwitching=function a(e,t){this.switchLevel(t.level)},a.switchLevel=function t(e){var a=this.hls.levels[e];if(null!=a&&a.audioGroupIds){var r=a.audioGroupIds[a.urlId];if(this.groupId!==r){this.groupId=r||null;var n=this.tracks.filter(function(e){return!r||e.groupId===r});this.selectDefaultTrack&&!n.some(function(e){return e.default})&&(this.selectDefaultTrack=!1),this.tracksInGroup=n;var i={audioTracks:n};this.log("Updating audio tracks, "+n.length+" track(s) found in group:"+r),this.hls.trigger(Tr.AUDIO_TRACKS_UPDATED,i),this.selectInitialTrack()}else this.shouldReloadPlaylist(this.currentTrack)&&this.setAudioTrack(this.trackId)}},a.onError=function a(e,t){t.fatal||!t.context||t.context.type===pn.AUDIO_TRACK&&t.context.id===this.trackId&&t.context.groupId===this.groupId&&(this.requestScheduled=-1,this.checkRetry(t))},a.setAudioTrack=function t(e){var a=this.tracksInGroup;if(0>e||e>=a.length)return void this.warn("Invalid id passed to audio-track controller");this.clearTimer();var r=this.currentTrack;a[this.trackId];var n=a[e],i=n.groupId,d=n.name;if(this.log("Switching to audio-track "+e+" \""+d+"\" lang:"+n.lang+" group:"+i),this.trackId=e,this.currentTrack=n,this.selectDefaultTrack=!1,this.hls.trigger(Tr.AUDIO_TRACK_SWITCHING,p({},n)),!n.details||n.details.live){var o=this.switchParams(n.url,null==r?void 0:r.details);this.loadPlaylist(o)}},a.selectInitialTrack=function e(){var t=this.tracksInGroup,a=this.findTrackId(this.currentTrack)|this.findTrackId(null);if(-1!==a)this.setAudioTrack(a);else{var r=new Error("No track found for running audio group-ID: "+this.groupId+" track count: "+t.length);this.warn(r.message),this.hls.trigger(Tr.ERROR,{type:hr.MEDIA_ERROR,details:Er.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:r})}},a.findTrackId=function t(e){for(var a=this.tracksInGroup,r=0,n;r<a.length;r++)if(n=a[r],!this.selectDefaultTrack||n.default){if(!e||void 0!==e.attrs["STABLE-RENDITION-ID"]&&e.attrs["STABLE-RENDITION-ID"]===n.attrs["STABLE-RENDITION-ID"])return n.id;if(e.name===n.name&&e.lang===n.lang)return n.id}return-1},a.loadPlaylist=function a(t){e.prototype.loadPlaylist.call(this);var r=this.tracksInGroup[this.trackId];if(this.shouldLoadPlaylist(r)){var n=r.id,i=r.groupId,d=r.url;if(t)try{d=t.addDirectives(d)}catch(e){this.warn("Could not construct new URL with HLS Delivery Directives: "+e)}this.log("loading audio-track playlist "+n+" \""+r.name+"\" lang:"+r.lang+" group:"+i),this.clearTimer(),this.hls.trigger(Tr.AUDIO_TRACK_LOADING,{url:d,id:n,groupId:i,deliveryDirectives:t||null})}},T(t,[{key:"audioTracks",get:function e(){return this.tracksInGroup}},{key:"audioTrack",get:function e(){return this.trackId},set:function t(e){this.selectDefaultTrack=!1,this.setAudioTrack(e)}}]),t}(Cn),Vi=500,Wi=function(e){function t(t,a,r){var n;return n=e.call(this,t,a,r,"[subtitle-stream-controller]",yn.SUBTITLE)||this,n.levels=[],n.currentTrackId=-1,n.tracksBuffered=[],n.mainDetails=null,n._registerListeners(),n}S(t,e);var a=t.prototype;return a.onHandlerDestroying=function e(){this._unregisterListeners(),this.mainDetails=null},a._registerListeners=function e(){var t=this.hls;t.on(Tr.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(Tr.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(Tr.MANIFEST_LOADING,this.onManifestLoading,this),t.on(Tr.LEVEL_LOADED,this.onLevelLoaded,this),t.on(Tr.ERROR,this.onError,this),t.on(Tr.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),t.on(Tr.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),t.on(Tr.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.on(Tr.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),t.on(Tr.BUFFER_FLUSHING,this.onBufferFlushing,this),t.on(Tr.FRAG_BUFFERED,this.onFragBuffered,this)},a._unregisterListeners=function e(){var t=this.hls;t.off(Tr.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(Tr.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(Tr.MANIFEST_LOADING,this.onManifestLoading,this),t.off(Tr.LEVEL_LOADED,this.onLevelLoaded,this),t.off(Tr.ERROR,this.onError,this),t.off(Tr.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),t.off(Tr.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),t.off(Tr.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.off(Tr.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),t.off(Tr.BUFFER_FLUSHING,this.onBufferFlushing,this),t.off(Tr.FRAG_BUFFERED,this.onFragBuffered,this)},a.startLoad=function t(e){this.stopLoad(),this.state=zn.IDLE,this.setInterval(Vi),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()},a.onManifestLoading=function e(){this.mainDetails=null,this.fragmentTracker.removeAllFragments()},a.onMediaDetaching=function t(){this.tracksBuffered=[],e.prototype.onMediaDetaching.call(this)},a.onLevelLoaded=function a(e,t){this.mainDetails=t.details},a.onSubtitleFragProcessed=function a(e,t){var r=t.frag,n=t.success;if(this.fragPrevious=r,this.state=zn.IDLE,!!n){var d=this.tracksBuffered[this.currentTrackId];if(d){for(var o=r.start,s=0,l;s<d.length;s++)if(o>=d[s].start&&o<=d[s].end){l=d[s];break}var u=r.start+r.duration;l?l.end=u:(l={start:o,end:u},d.push(l)),this.fragmentTracker.fragBuffered(r)}}},a.onBufferFlushing=function a(e,t){var r=t.startOffset,i=t.endOffset;if(0===r&&i!==n){var d=i-1;if(0>=d)return;t.endOffsetSubtitles=f(0,d),this.tracksBuffered.forEach(function(e){for(var t=0;t<e.length;){if(e[t].end<=d){e.shift();continue}else if(e[t].start<d)e[t].start=d;else break;t++}}),this.fragmentTracker.removeFragmentsInRange(r,d,yn.SUBTITLE)}},a.onFragBuffered=function a(e,t){if(!this.loadedmetadata&&t.frag.type===yn.MAIN){var r;null!=(r=this.media)&&r.buffered.length&&(this.loadedmetadata=!0)}},a.onError=function a(e,t){var r=t.frag;(null==r?void 0:r.type)===yn.SUBTITLE&&(this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==zn.STOPPED&&(this.state=zn.IDLE))},a.onSubtitleTracksUpdated=function a(e,t){var r=this,n=t.subtitleTracks;return xa(this.levels,n)?void(this.levels=n.map(function(e){return new In(e)})):void(this.tracksBuffered=[],this.levels=n.map(function(e){var t=new In(e);return r.tracksBuffered[t.id]=[],t}),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,yn.SUBTITLE),this.fragPrevious=null,this.mediaBuffer=null)},a.onSubtitleTrackSwitch=function a(e,t){if(this.currentTrackId=t.id,!this.levels.length||-1===this.currentTrackId)return void this.clearInterval();var r=this.levels[this.currentTrackId];this.mediaBuffer=null!=r&&r.details?this.mediaBufferTimeRanges:null,r&&this.setInterval(Vi)},a.onSubtitleTrackLoaded=function a(e,t){var r=t.details,n=t.id,i=this.currentTrackId,d=this.levels,o;if(d.length){var s=d[i];if(!(n>=d.length)&&n===i&&s){this.mediaBuffer=this.mediaBufferTimeRanges;var l=0;if(r.live||null!=(o=s.details)&&o.live){var u=this.mainDetails;if(r.deltaUpdateFailed||!u)return;var c=u.fragments[0];s.details?(l=this.alignPlaylists(r,s.details),0===l&&c&&(l=c.start,nt(r,l))):r.hasProgramDateTime&&u.hasProgramDateTime?(Mt(r,u),l=r.fragments[0].start):c&&(l=c.start,nt(r,l))}if(s.details=r,this.levelLastLoaded=n,this.startFragRequested||!this.mainDetails&&r.live||this.setStartPosition(s.details,l),this.tick(),r.live&&!this.fragCurrent&&this.media&&this.state===zn.IDLE){var f=yt(null,r.fragments,this.media.currentTime,0);f||(this.warn("Subtitle playlist not aligned with playback"),s.details=void 0)}}}},a._handleFragmentLoadComplete=function t(e){var a=this,r=e.frag,n=e.payload,i=r.decryptdata,d=this.hls;if(!this.fragContextChanged(r)&&n&&0<n.byteLength&&i&&i.key&&i.iv&&"AES-128"===i.method){var o=performance.now();this.decrypter.decrypt(new Uint8Array(n),i.key.buffer,i.iv.buffer).catch(function(e){throw d.trigger(Tr.ERROR,{type:hr.MEDIA_ERROR,details:Er.FRAG_DECRYPT_ERROR,fatal:!1,error:e,reason:e.message,frag:r}),e}).then(function(e){var t=performance.now();d.trigger(Tr.FRAG_DECRYPTED,{frag:r,payload:e,stats:{tstart:o,tdecrypt:t}})}).catch(function(e){a.warn(e.name+": "+e.message),a.state=zn.IDLE})}},a.doTick=function e(){if(!this.media)return void(this.state=zn.IDLE);if(this.state===zn.IDLE){var t=this.currentTrackId,a=this.levels,r=a[t];if(!a.length||!r||!r.details)return;var n=this.config,i=this.getLoadPosition(),d=Gn.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],i,n.maxBufferHole),o=d.end,s=d.len,l=this.getFwdBufferInfo(this.media,yn.MAIN),u=r.details,c=this.getMaxBufferLength(null==l?void 0:l.len)+u.levelTargetDuration;if(s>c)return;var g=u.fragments,m=g.length,p=u.edge,y=null,T=this.fragPrevious;if(o<p){var h=n.maxFragLookUpTolerance,E=o>p-h?0:h;y=yt(T,g,f(g[0].start,o),E),!y&&T&&T.start<g[0].start&&(y=g[0])}else y=g[m-1];if(!y)return;if(y=this.mapToInitFragWhenRequired(y),"initSegment"!==y.sn){var S=y.sn-u.startSN,L=g[S-1];L&&L.cc===y.cc&&this.fragmentTracker.getState(L)===xn.NOT_LOADED&&(y=L)}this.fragmentTracker.getState(y)===xn.NOT_LOADED&&this.loadFragment(y,r,o)}},a.getMaxBufferLength=function a(t){var r=e.prototype.getMaxBufferLength.call(this);return t?f(r,t):r},a.loadFragment=function n(t,a,r){this.fragCurrent=t,"initSegment"===t.sn?this._loadInitSegment(t,a):(this.startFragRequested=!0,e.prototype.loadFragment.call(this,t,a,r))},T(t,[{key:"mediaBufferTimeRanges",get:function e(){return new Yi(this.tracksBuffered[this.currentTrackId]||[])}}]),t}(jn),Yi=function t(e){this.buffered=void 0;var a=function n(t,a,r){if(a>>>=0,a>r-1)throw new DOMException("Failed to execute '"+t+"' on 'TimeRanges': The index provided ("+a+") is greater than the maximum bound ("+r+")");return e[a][t]};this.buffered={get length(){return e.length},end:function r(t){return a("end",t,e.length)},start:function r(t){return a("start",t,e.length)}}},qi=function(e){function t(t){var a;return a=e.call(this,t,"[subtitle-track-controller]")||this,a.media=null,a.tracks=[],a.groupId=null,a.tracksInGroup=[],a.trackId=-1,a.selectDefaultTrack=!0,a.queuedDefaultTrack=-1,a.trackChangeListener=function(){return a.onTextTracksChanged()},a.asyncPollTrackChange=function(){return a.pollTrackChange(0)},a.useTextTrackPolling=!1,a.subtitlePollingInterval=-1,a._subtitleDisplay=!0,a.registerListeners(),a}S(t,e);var a=t.prototype;return a.destroy=function t(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.trackChangeListener=this.asyncPollTrackChange=null,e.prototype.destroy.call(this)},a.registerListeners=function e(){var t=this.hls;t.on(Tr.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(Tr.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(Tr.MANIFEST_LOADING,this.onManifestLoading,this),t.on(Tr.MANIFEST_PARSED,this.onManifestParsed,this),t.on(Tr.LEVEL_LOADING,this.onLevelLoading,this),t.on(Tr.LEVEL_SWITCHING,this.onLevelSwitching,this),t.on(Tr.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.on(Tr.ERROR,this.onError,this)},a.unregisterListeners=function e(){var t=this.hls;t.off(Tr.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(Tr.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(Tr.MANIFEST_LOADING,this.onManifestLoading,this),t.off(Tr.MANIFEST_PARSED,this.onManifestParsed,this),t.off(Tr.LEVEL_LOADING,this.onLevelLoading,this),t.off(Tr.LEVEL_SWITCHING,this.onLevelSwitching,this),t.off(Tr.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.off(Tr.ERROR,this.onError,this)},a.onMediaAttached=function a(e,t){this.media=t.media,this.media&&(-1<this.queuedDefaultTrack&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))},a.pollTrackChange=function t(e){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.trackChangeListener,e)},a.onMediaDetaching=function e(){if(this.media){self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||this.media.textTracks.removeEventListener("change",this.asyncPollTrackChange),-1<this.trackId&&(this.queuedDefaultTrack=this.trackId);var t=Oa(this.media.textTracks);t.forEach(function(e){Ve(e)}),this.subtitleTrack=-1,this.media=null}},a.onManifestLoading=function e(){this.tracks=[],this.groupId=null,this.tracksInGroup=[],this.trackId=-1,this.selectDefaultTrack=!0},a.onManifestParsed=function a(e,t){this.tracks=t.subtitleTracks},a.onSubtitleTrackLoaded=function a(e,t){var r=t.id,n=t.details,i=this.trackId,d=this.tracksInGroup[i];if(!d)return void this.warn("Invalid subtitle track id "+r);var o=d.details;d.details=t.details,this.log("subtitle track "+r+" loaded ["+n.startSN+"-"+n.endSN+"]"),r===this.trackId&&this.playlistLoaded(r,t,o)},a.onLevelLoading=function a(e,t){this.switchLevel(t.level)},a.onLevelSwitching=function a(e,t){this.switchLevel(t.level)},a.switchLevel=function t(e){var a=this.hls.levels[e];if(null!=a&&a.textGroupIds){var r=a.textGroupIds[a.urlId],n=this.tracksInGroup?this.tracksInGroup[this.trackId]:void 0;if(this.groupId!==r){var i=this.tracks.filter(function(e){return!r||e.groupId===r});this.tracksInGroup=i;var d=this.findTrackId(null==n?void 0:n.name)||this.findTrackId();this.groupId=r||null;var o={subtitleTracks:i};this.log("Updating subtitle tracks, "+i.length+" track(s) found in \""+r+"\" group-id"),this.hls.trigger(Tr.SUBTITLE_TRACKS_UPDATED,o),-1!==d&&this.setSubtitleTrack(d,n)}else this.shouldReloadPlaylist(n)&&this.setSubtitleTrack(this.trackId,n)}},a.findTrackId=function t(e){for(var a=this.tracksInGroup,r=0,n;r<a.length;r++)if(n=a[r],(!this.selectDefaultTrack||n.default)&&(!e||e===n.name))return n.id;return-1},a.onError=function a(e,t){t.fatal||!t.context||t.context.type===pn.SUBTITLE_TRACK&&t.context.id===this.trackId&&t.context.groupId===this.groupId&&this.checkRetry(t)},a.loadPlaylist=function a(t){e.prototype.loadPlaylist.call(this);var r=this.tracksInGroup[this.trackId];if(this.shouldLoadPlaylist(r)){var n=r.id,i=r.groupId,d=r.url;if(t)try{d=t.addDirectives(d)}catch(e){this.warn("Could not construct new URL with HLS Delivery Directives: "+e)}this.log("Loading subtitle playlist for id "+n),this.hls.trigger(Tr.SUBTITLE_TRACK_LOADING,{url:d,id:n,groupId:i,deliveryDirectives:t||null})}},a.toggleTrackModes=function t(e){var a=this,r=this.media,n=this.trackId;if(r){var i=Oa(r.textTracks),d=i.filter(function(e){return e.groupId===a.groupId});if(-1===e)[].slice.call(i).forEach(function(e){e.mode="disabled"});else{var o=d[n];o&&(o.mode="disabled")}var s=d[e];s&&(s.mode=this.subtitleDisplay?"showing":"hidden")}},a.setSubtitleTrack=function a(e,t){var r=this.tracksInGroup,n;if(!this.media)return void(this.queuedDefaultTrack=e);if(this.trackId!==e&&this.toggleTrackModes(e),!(this.trackId===e&&(-1===e||null!=(n=r[e])&&n.details)||-1>e||e>=r.length)){this.clearTimer();var i=r[e];if(this.log("Switching to subtitle-track "+e+(i?" \""+i.name+"\" lang:"+i.lang+" group:"+i.groupId:"")),this.trackId=e,i){var d=i.id,o=i.groupId,s=void 0===o?"":o,l=i.name,u=i.type,c=i.url;this.hls.trigger(Tr.SUBTITLE_TRACK_SWITCH,{id:d,groupId:s,name:l,type:u,url:c});var f=this.switchParams(i.url,null==t?void 0:t.details);this.loadPlaylist(f)}else this.hls.trigger(Tr.SUBTITLE_TRACK_SWITCH,{id:e})}},a.onTextTracksChanged=function e(){if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),this.media&&this.hls.config.renderTextTracksNatively){for(var t=-1,a=Oa(this.media.textTracks),r=0;r<a.length;r++)if("hidden"===a[r].mode)t=r;else if("showing"===a[r].mode){t=r;break}this.subtitleTrack!==t&&(this.subtitleTrack=t)}},T(t,[{key:"subtitleDisplay",get:function e(){return this._subtitleDisplay},set:function t(e){this._subtitleDisplay=e,-1<this.trackId&&this.toggleTrackModes(this.trackId)}},{key:"subtitleTracks",get:function e(){return this.tracksInGroup}},{key:"subtitleTrack",get:function e(){return this.trackId},set:function t(e){this.selectDefaultTrack=!1;var a=this.tracksInGroup?this.tracksInGroup[this.trackId]:void 0;this.setSubtitleTrack(e,a)}}]),t}(Cn),zi=function(){function e(e){this.buffers=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.buffers=e}var t=e.prototype;return t.append=function a(e,t){var r=this.queues[t];r.push(e),1===r.length&&this.buffers[t]&&this.executeNext(t)},t.insertAbort=function a(e,t){var r=this.queues[t];r.unshift(e),this.executeNext(t)},t.appendBlocker=function t(e){var a=new Promise(function(e){n=e}),r={execute:n,onStart:function e(){},onComplete:function e(){},onError:function e(){}},n;return this.append(r,e),a},t.executeNext=function a(t){var r=this.buffers,n=this.queues,i=r[t],d=n[t];if(d.length){var o=d[0];try{o.execute()}catch(a){Ar.warn("[buffer-operation-queue]: Unhandled exception executing the current operation"),o.onError(a),null!=i&&i.updating||(d.shift(),this.executeNext(t))}}},t.shiftAndExecuteNext=function t(e){this.queues[e].shift(),this.executeNext(e)},t.current=function t(e){return this.queues[e][0]},e}(),ji=_e(),Xi=/([ha]vc.)(?:\.[^.,]+)+/,Qi=function(){function e(e){var t=this;this.details=null,this._objectUrl=null,this.operationQueue=void 0,this.listeners=void 0,this.hls=void 0,this.bufferCodecEventsExpected=0,this._bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.appendError=0,this.tracks={},this.pendingTracks={},this.sourceBuffer=void 0,this._onMediaSourceOpen=function(){var e=t.media,a=t.mediaSource;Ar.log("[buffer-controller]: Media source opened"),e&&(e.removeEventListener("emptied",t._onMediaEmptied),t.updateMediaElementDuration(),t.hls.trigger(Tr.MEDIA_ATTACHED,{media:e})),a&&a.removeEventListener("sourceopen",t._onMediaSourceOpen),t.checkPendingTracks()},this._onMediaSourceClose=function(){Ar.log("[buffer-controller]: Media source closed")},this._onMediaSourceEnded=function(){Ar.log("[buffer-controller]: Media source ended")},this._onMediaEmptied=function(){var e=t.media,a=t._objectUrl;e&&e.src!==a&&Ar.error("Media element src was set while attaching MediaSource ("+a+" > "+e.src+")")},this.hls=e,this._initSourceBuffer(),this.registerListeners()}var t=e.prototype;return t.hasSourceTypes=function e(){return 0<this.getSourceBufferTypes().length||0<Object.keys(this.pendingTracks).length},t.destroy=function e(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=null},t.registerListeners=function e(){var t=this.hls;t.on(Tr.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(Tr.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(Tr.MANIFEST_LOADING,this.onManifestLoading,this),t.on(Tr.MANIFEST_PARSED,this.onManifestParsed,this),t.on(Tr.BUFFER_RESET,this.onBufferReset,this),t.on(Tr.BUFFER_APPENDING,this.onBufferAppending,this),t.on(Tr.BUFFER_CODECS,this.onBufferCodecs,this),t.on(Tr.BUFFER_EOS,this.onBufferEos,this),t.on(Tr.BUFFER_FLUSHING,this.onBufferFlushing,this),t.on(Tr.LEVEL_UPDATED,this.onLevelUpdated,this),t.on(Tr.FRAG_PARSED,this.onFragParsed,this),t.on(Tr.FRAG_CHANGED,this.onFragChanged,this)},t.unregisterListeners=function e(){var t=this.hls;t.off(Tr.MEDIA_ATTACHING,this.onMediaAttaching,this),t.off(Tr.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(Tr.MANIFEST_LOADING,this.onManifestLoading,this),t.off(Tr.MANIFEST_PARSED,this.onManifestParsed,this),t.off(Tr.BUFFER_RESET,this.onBufferReset,this),t.off(Tr.BUFFER_APPENDING,this.onBufferAppending,this),t.off(Tr.BUFFER_CODECS,this.onBufferCodecs,this),t.off(Tr.BUFFER_EOS,this.onBufferEos,this),t.off(Tr.BUFFER_FLUSHING,this.onBufferFlushing,this),t.off(Tr.LEVEL_UPDATED,this.onLevelUpdated,this),t.off(Tr.FRAG_PARSED,this.onFragParsed,this),t.off(Tr.FRAG_CHANGED,this.onFragChanged,this)},t._initSourceBuffer=function e(){this.sourceBuffer={},this.operationQueue=new zi(this.sourceBuffer),this.listeners={audio:[],video:[],audiovideo:[]},this.lastMpegAudioChunk=null},t.onManifestLoading=function e(){this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=0,this.details=null},t.onManifestParsed=function a(e,t){var r=2;(!t.audio||t.video)&&t.altAudio&&!0||(r=1),this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=r,Ar.log(this.bufferCodecEventsExpected+" bufferCodec event(s) expected")},t.onMediaAttaching=function a(e,t){var r=this.media=t.media;if(r&&ji){var n=this.mediaSource=new ji;n.addEventListener("sourceopen",this._onMediaSourceOpen),n.addEventListener("sourceended",this._onMediaSourceEnded),n.addEventListener("sourceclose",this._onMediaSourceClose),r.src=self.URL.createObjectURL(n),this._objectUrl=r.src,r.addEventListener("emptied",this._onMediaEmptied)}},t.onMediaDetaching=function e(){var t=this.media,a=this.mediaSource,r=this._objectUrl;if(a){if(Ar.log("[buffer-controller]: media source detaching"),"open"===a.readyState)try{a.endOfStream()}catch(e){Ar.warn("[buffer-controller]: onMediaDetaching: "+e.message+" while calling endOfStream")}this.onBufferReset(),a.removeEventListener("sourceopen",this._onMediaSourceOpen),a.removeEventListener("sourceended",this._onMediaSourceEnded),a.removeEventListener("sourceclose",this._onMediaSourceClose),t&&(t.removeEventListener("emptied",this._onMediaEmptied),r&&self.URL.revokeObjectURL(r),t.src===r?(t.removeAttribute("src"),t.load()):Ar.warn("[buffer-controller]: media.src was changed by a third party - skip cleanup")),this.mediaSource=null,this.media=null,this._objectUrl=null,this.bufferCodecEventsExpected=this._bufferCodecEventsTotal,this.pendingTracks={},this.tracks={}}this.hls.trigger(Tr.MEDIA_DETACHED,void 0)},t.onBufferReset=function e(){var t=this;this.getSourceBufferTypes().forEach(function(e){var a=t.sourceBuffer[e];try{a&&(t.removeBufferListeners(e),t.mediaSource&&t.mediaSource.removeSourceBuffer(a),t.sourceBuffer[e]=void 0)}catch(t){Ar.warn("[buffer-controller]: Failed to reset the "+e+" buffer",t)}}),this._initSourceBuffer()},t.onBufferCodecs=function a(e,t){var r=this,n=this.getSourceBufferTypes().length;Object.keys(t).forEach(function(e){if(n){var a=r.tracks[e];if(a&&"function"==typeof a.buffer.changeType){var i=t[e],d=i.id,o=i.codec,s=i.levelCodec,l=i.container,u=i.metadata,c=(a.levelCodec||a.codec).replace(Xi,"$1"),f=(s||o).replace(Xi,"$1");if(c!==f){var g=l+";codecs="+(s||o);r.appendChangeType(e,g),Ar.log("[buffer-controller]: switching codec "+c+" to "+f),r.tracks[e]={buffer:a.buffer,codec:o,container:l,levelCodec:s,metadata:u,id:d}}}}else r.pendingTracks[e]=t[e]}),n||(this.bufferCodecEventsExpected=f(this.bufferCodecEventsExpected-1,0),this.mediaSource&&"open"===this.mediaSource.readyState&&this.checkPendingTracks())},t.appendChangeType=function r(t,a){var n=this,i=this.operationQueue,d={execute:function e(){var r=n.sourceBuffer[t];r&&(Ar.log("[buffer-controller]: changing "+t+" sourceBuffer type to "+a),r.changeType(a)),i.shiftAndExecuteNext(t)},onStart:function e(){},onComplete:function e(){},onError:function e(a){Ar.warn("[buffer-controller]: Failed to change "+t+" SourceBuffer type",a)}};i.append(d,t)},t.onBufferAppending=function a(e,t){var r=this,n=this.hls,i=this.operationQueue,d=this.tracks,o=t.data,l=t.type,u=t.frag,c=t.part,f=t.chunkMeta,g=f.buffering[l],m=self.performance.now();g.start=m;var p=u.stats.buffering,y=c?c.stats.buffering:null;0===p.start&&(p.start=m),y&&0===y.start&&(y.start=m);var T=d.audio,h=!1;"audio"===l&&"audio/mpeg"===(null==T?void 0:T.container)&&(h=!this.lastMpegAudioChunk||1===f.id||this.lastMpegAudioChunk.sn!==f.sn,this.lastMpegAudioChunk=f);var E=u.start,S={execute:function e(){if(g.executeStart=self.performance.now(),h){var t=r.sourceBuffer[l];if(t){var a=E-t.timestampOffset;.1<=s(a)&&(Ar.log("[buffer-controller]: Updating audio SourceBuffer timestampOffset to "+E+" (delta: "+a+") sn: "+u.sn+")"),t.timestampOffset=E)}}r.appendExecutor(o,l)},onStart:function e(){},onComplete:function e(){var t=self.performance.now();g.executeEnd=g.end=t,0===p.first&&(p.first=t),y&&0===y.first&&(y.first=t);var a=r.sourceBuffer,n={};for(var i in a)n[i]=Gn.getBuffered(a[i]);r.appendError=0,r.hls.trigger(Tr.BUFFER_APPENDED,{type:l,frag:u,part:c,chunkMeta:f,parent:u.type,timeRanges:n})},onError:function t(e){Ar.error("[buffer-controller]: Error encountered while trying to append to the "+l+" SourceBuffer",e);var a={type:hr.MEDIA_ERROR,parent:u.type,details:Er.BUFFER_APPEND_ERROR,frag:u,part:c,chunkMeta:f,error:e,err:e,fatal:!1};e.code===DOMException.QUOTA_EXCEEDED_ERR?a.details=Er.BUFFER_FULL_ERROR:(r.appendError++,a.details=Er.BUFFER_APPEND_ERROR,r.appendError>n.config.appendErrorMaxRetry&&(Ar.error("[buffer-controller]: Failed "+n.config.appendErrorMaxRetry+" times to append segment in sourceBuffer"),a.fatal=!0)),n.trigger(Tr.ERROR,a)}};i.append(S,l)},t.onBufferFlushing=function a(e,t){var r=this,n=this.operationQueue,i=function n(a){return{execute:r.removeExecutor.bind(r,a,t.startOffset,t.endOffset),onStart:function e(){},onComplete:function e(){r.hls.trigger(Tr.BUFFER_FLUSHED,{type:a})},onError:function e(t){Ar.warn("[buffer-controller]: Failed to remove from "+a+" SourceBuffer",t)}}};t.type?n.append(i(t.type),t.type):this.getSourceBufferTypes().forEach(function(e){n.append(i(e),e)})},t.onFragParsed=function a(e,t){var r=this,n=t.frag,i=t.part,d=[],o=i?i.elementaryStreams:n.elementaryStreams;o[br.AUDIOVIDEO]?d.push("audiovideo"):(o[br.AUDIO]&&d.push("audio"),o[br.VIDEO]&&d.push("video"));var s=function e(){var t=self.performance.now();n.stats.buffering.end=t,i&&(i.stats.buffering.end=t);var a=i?i.stats:n.stats;r.hls.trigger(Tr.FRAG_BUFFERED,{frag:n,part:i,stats:a,id:n.type})};0===d.length&&Ar.warn("Fragments must have at least one ElementaryStreamType set. type: "+n.type+" level: "+n.level+" sn: "+n.sn),this.blockBuffers(s,d)},t.onFragChanged=function a(e,t){this.flushBackBuffer()},t.onBufferEos=function a(e,t){var r=this,n=this.getSourceBufferTypes().reduce(function(e,a){var n=r.sourceBuffer[a];return n&&(!t.type||t.type===a)&&(n.ending=!0,!n.ended&&(n.ended=!0,Ar.log("[buffer-controller]: "+a+" sourceBuffer now EOS"))),e&&(!n||n.ended)},!0);n&&(Ar.log("[buffer-controller]: Queueing mediaSource.endOfStream()"),this.blockBuffers(function(){r.getSourceBufferTypes().forEach(function(e){var t=r.sourceBuffer[e];t&&(t.ending=!1)});var e=r.mediaSource;return e&&"open"===e.readyState?void(Ar.log("[buffer-controller]: Calling mediaSource.endOfStream()"),e.endOfStream()):void(e&&Ar.info("[buffer-controller]: Could not call mediaSource.endOfStream(). mediaSource.readyState: "+e.readyState))}))},t.onLevelUpdated=function a(e,t){var r=t.details;r.fragments.length&&(this.details=r,this.getSourceBufferTypes().length?this.blockBuffers(this.updateMediaElementDuration.bind(this)):this.updateMediaElementDuration())},t.flushBackBuffer=function e(){var t=this.hls,a=this.details,r=this.media,n=this.sourceBuffer;if(r&&null!==a){var i=this.getSourceBufferTypes();if(i.length){var d=a.live&&null!==t.config.liveBackBufferLength?t.config.liveBackBufferLength:t.config.backBufferLength;if(yr(d)&&!(0>d)){var o=r.currentTime,s=a.levelTargetDuration,l=f(d,s),c=u(o/s)*s-l;i.forEach(function(e){var r=n[e];if(r){var i=Gn.getBuffered(r);if(0<i.length&&c>i.start(0)){if(t.trigger(Tr.BACK_BUFFER_REACHED,{bufferEnd:c}),a.live)t.trigger(Tr.LIVE_BACK_BUFFER_REACHED,{bufferEnd:c});else if(r.ended&&i.end(i.length-1)-o<2*s)return void Ar.info("[buffer-controller]: Cannot flush "+e+" back buffer while SourceBuffer is in ended state");t.trigger(Tr.BUFFER_FLUSHING,{startOffset:0,endOffset:c,type:e})}}})}}}},t.updateMediaElementDuration=function e(){if(this.details&&this.media&&this.mediaSource&&"open"===this.mediaSource.readyState){var t=this.details,a=this.hls,r=this.media,n=this.mediaSource,i=t.fragments[0].start+t.totalduration,d=r.duration,o=yr(n.duration)?n.duration:0;t.live&&a.config.liveDurationInfinity?(Ar.log("[buffer-controller]: Media Source duration is set to Infinity"),n.duration=1/0,this.updateSeekableRange(t)):(i>o&&i>d||!yr(d))&&(Ar.log("[buffer-controller]: Updating Media Source duration to "+i.toFixed(3)),n.duration=i)}},t.updateSeekableRange=function t(e){var a=this.mediaSource,r=e.fragments,n=r.length;if(n&&e.live&&null!=a&&a.setLiveSeekableRange){var i=f(0,r[0].start),d=f(i,i+e.totalduration);a.setLiveSeekableRange(i,d)}},t.checkPendingTracks=function e(){var t=this.bufferCodecEventsExpected,a=this.operationQueue,r=this.pendingTracks,n=Object.keys(r).length;if(n&&!t||2===n){this.createSourceBuffers(r),this.pendingTracks={};var i=this.getSourceBufferTypes();if(i.length)this.hls.trigger(Tr.BUFFER_CREATED,{tracks:this.tracks}),i.forEach(function(e){a.executeNext(e)});else{var d=new Error("could not create source buffer for media codec(s)");this.hls.trigger(Tr.ERROR,{type:hr.MEDIA_ERROR,details:Er.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:d,reason:d.message})}}},t.createSourceBuffers=function t(e){var a=this.sourceBuffer,r=this.mediaSource;if(!r)throw Error("createSourceBuffers called when mediaSource was null");for(var n in e)if(!a[n]){var i=e[n];if(!i)throw Error("source buffer exists for track "+n+", however track does not");var d=i.levelCodec||i.codec,o=i.container+";codecs="+d;Ar.log("[buffer-controller]: creating sourceBuffer("+o+")");try{var s=a[n]=r.addSourceBuffer(o),l=n;this.addBufferListener(l,"updatestart",this._onSBUpdateStart),this.addBufferListener(l,"updateend",this._onSBUpdateEnd),this.addBufferListener(l,"error",this._onSBUpdateError),this.tracks[n]={buffer:s,codec:d,container:i.container,levelCodec:i.levelCodec,metadata:i.metadata,id:i.id}}catch(e){Ar.error("[buffer-controller]: error while trying to add sourceBuffer: "+e.message),this.hls.trigger(Tr.ERROR,{type:hr.MEDIA_ERROR,details:Er.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:e,mimeType:o})}}},t._onSBUpdateStart=function t(e){var a=this.operationQueue,r=a.current(e);r.onStart()},t._onSBUpdateEnd=function t(e){var a=this.operationQueue,r=a.current(e);r.onComplete(),a.shiftAndExecuteNext(e)},t._onSBUpdateError=function a(e,t){var r=new Error(e+" SourceBuffer error");Ar.error("[buffer-controller]: "+r,t),this.hls.trigger(Tr.ERROR,{type:hr.MEDIA_ERROR,details:Er.BUFFER_APPENDING_ERROR,error:r,fatal:!1});var n=this.operationQueue.current(e);n&&n.onError(t)},t.removeExecutor=function r(e,t,a){var n=this.media,i=this.mediaSource,d=this.operationQueue,s=this.sourceBuffer,l=s[e];if(!n||!i||!l)return Ar.warn("[buffer-controller]: Attempting to remove from the "+e+" SourceBuffer, but it does not exist"),void d.shiftAndExecuteNext(e);var u=yr(n.duration)?n.duration:1/0,c=yr(i.duration)?i.duration:1/0,g=f(0,t),m=o(a,u,c);m>g&&!l.ending?(l.ended=!1,Ar.log("[buffer-controller]: Removing ["+g+","+m+"] from the "+e+" SourceBuffer"),l.remove(g,m)):d.shiftAndExecuteNext(e)},t.appendExecutor=function a(e,t){var r=this.operationQueue,n=this.sourceBuffer,i=n[t];return i?void(i.ended=!1,i.appendBuffer(e)):(Ar.warn("[buffer-controller]: Attempting to append to the "+t+" SourceBuffer, but it does not exist"),void r.shiftAndExecuteNext(t))},t.blockBuffers=function a(e,t){var r=this;if(void 0===t&&(t=this.getSourceBufferTypes()),!t.length)return Ar.log("[buffer-controller]: Blocking operation requested, but no SourceBuffers exist"),void Promise.resolve().then(e);var n=this.operationQueue,i=t.map(function(e){return n.appendBlocker(e)});Promise.all(i).then(function(){e(),t.forEach(function(e){var t=r.sourceBuffer[e];null!=t&&t.updating||n.shiftAndExecuteNext(e)})})},t.getSourceBufferTypes=function e(){return Object.keys(this.sourceBuffer)},t.addBufferListener=function r(e,t,a){var n=this.sourceBuffer[e];if(n){var i=a.bind(this,e);this.listeners[e].push({event:t,listener:i}),n.addEventListener(t,i)}},t.removeBufferListeners=function t(e){var a=this.sourceBuffer[e];a&&this.listeners[e].forEach(function(e){a.removeEventListener(e.event,e.listener)})},e}(),Zi={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},$i=function t(e){var a=e;return Zi.hasOwnProperty(e)&&(a=Zi[e]),g(a)},Ji=15,ed=100,td={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},ad={17:2,18:4,21:6,22:8,23:10,19:13,20:15},rd={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},nd={25:2,26:4,29:6,30:8,31:10,27:13,28:15},id=["white","green","blue","cyan","red","yellow","magenta","black","transparent"],dd=function(){function e(){this.time=null,this.verboseLevel=0}var t=e.prototype;return t.log=function a(e,t){if(this.verboseLevel>=e){var r="function"==typeof t?t():t;Ar.log(this.time+" ["+e+"] "+r)}},e}(),od=function t(e){for(var a=[],r=0;r<e.length;r++)a.push(e[r].toString(16));return a},sd=function(){function e(e,t,a,r,n){this.foreground=void 0,this.underline=void 0,this.italics=void 0,this.background=void 0,this.flash=void 0,this.foreground=e||"white",this.underline=t||!1,this.italics=a||!1,this.background=r||"black",this.flash=n||!1}var t=e.prototype;return t.reset=function e(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1},t.setStyles=function t(e){for(var a=["foreground","underline","italics","background","flash"],r=0,n;r<a.length;r++)n=a[r],e.hasOwnProperty(n)&&(this[n]=e[n])},t.isDefault=function e(){return"white"===this.foreground&&!this.underline&&!this.italics&&"black"===this.background&&!this.flash},t.equals=function t(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash},t.copy=function t(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash},t.toString=function e(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash},e}(),ld=function(){function e(e,t,a,r,n,i){this.uchar=void 0,this.penState=void 0,this.uchar=e||" ",this.penState=new sd(t,a,r,n,i)}var t=e.prototype;return t.reset=function e(){this.uchar=" ",this.penState.reset()},t.setChar=function a(e,t){this.uchar=e,this.penState.copy(t)},t.setPenState=function t(e){this.penState.copy(e)},t.equals=function t(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)},t.copy=function t(e){this.uchar=e.uchar,this.penState.copy(e.penState)},t.isEmpty=function e(){return" "===this.uchar&&this.penState.isDefault()},e}(),ud=function(){function e(e){this.chars=void 0,this.pos=void 0,this.currPenState=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chars=[];for(var t=0;t<ed;t++)this.chars.push(new ld);this.logger=e,this.pos=0,this.currPenState=new sd}var t=e.prototype;return t.equals=function t(e){for(var a=!0,r=0;r<ed;r++)if(!this.chars[r].equals(e.chars[r])){a=!1;break}return a},t.copy=function t(e){for(var a=0;a<ed;a++)this.chars[a].copy(e.chars[a])},t.isEmpty=function e(){for(var t=!0,a=0;a<ed;a++)if(!this.chars[a].isEmpty()){t=!1;break}return t},t.setCursor=function t(e){this.pos!==e&&(this.pos=e),0>this.pos?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>ed&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=ed)},t.moveCursor=function t(e){var a=this.pos+e;if(1<e)for(var r=this.pos+1;r<a+1;r++)this.chars[r].setPenState(this.currPenState);this.setCursor(a)},t.backSpace=function e(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)},t.insertChar=function t(e){var a=this;144<=e&&this.backSpace();var r=$i(e);return this.pos>=ed?void this.logger.log(0,function(){return"Cannot insert "+e.toString(16)+" ("+r+") at position "+a.pos+". Skipping it!"}):void(this.chars[this.pos].setChar(r,this.currPenState),this.moveCursor(1))},t.clearFromPos=function t(e){var a;for(a=e;a<ed;a++)this.chars[a].reset()},t.clear=function e(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()},t.clearToEndOfRow=function e(){this.clearFromPos(this.pos)},t.getTextString=function e(){for(var t=[],a=!0,r=0,n;r<ed;r++)n=this.chars[r].uchar," "!==n&&(a=!1),t.push(n);return a?"":t.join("")},t.setPenStyles=function t(e){this.currPenState.setStyles(e);var a=this.chars[this.pos];a.setPenState(this.currPenState)},e}(),cd=function(){function e(e){this.rows=void 0,this.currRow=void 0,this.nrRollUpRows=void 0,this.lastOutputScreen=void 0,this.logger=void 0,this.rows=[];for(var t=0;t<Ji;t++)this.rows.push(new ud(e));this.logger=e,this.currRow=Ji-1,this.nrRollUpRows=null,this.lastOutputScreen=null,this.reset()}var t=e.prototype;return t.reset=function e(){for(var t=0;t<Ji;t++)this.rows[t].clear();this.currRow=Ji-1},t.equals=function t(e){for(var a=!0,r=0;r<Ji;r++)if(!this.rows[r].equals(e.rows[r])){a=!1;break}return a},t.copy=function t(e){for(var a=0;a<Ji;a++)this.rows[a].copy(e.rows[a])},t.isEmpty=function e(){for(var t=!0,a=0;a<Ji;a++)if(!this.rows[a].isEmpty()){t=!1;break}return t},t.backSpace=function e(){var t=this.rows[this.currRow];t.backSpace()},t.clearToEndOfRow=function e(){var t=this.rows[this.currRow];t.clearToEndOfRow()},t.insertChar=function t(e){var a=this.rows[this.currRow];a.insertChar(e)},t.setPen=function t(e){var a=this.rows[this.currRow];a.setPenStyles(e)},t.moveCursor=function t(e){var a=this.rows[this.currRow];a.moveCursor(e)},t.setCursor=function t(e){this.logger.log(2,"setCursor: "+e);var a=this.rows[this.currRow];a.setCursor(e)},t.setPAC=function t(e){this.logger.log(2,function(){return"pacData = "+JSON.stringify(e)});var a=e.row-1;if(this.nrRollUpRows&&a<this.nrRollUpRows-1&&(a=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==a){for(var r=0;r<Ji;r++)this.rows[r].clear();var n=this.currRow+1-this.nrRollUpRows,d=this.lastOutputScreen;if(d){var o=d.rows[n].cueStartTime,s=this.logger.time;if(o&&null!==s&&o<s)for(var l=0;l<this.nrRollUpRows;l++)this.rows[a-this.nrRollUpRows+l+1].copy(d.rows[n+l])}}this.currRow=a;var u=this.rows[this.currRow];if(null!==e.indent){var c=e.indent,g=f(c-1,0);u.setCursor(e.indent),e.color=u.chars[g].penState.foreground}var m={foreground:e.color,underline:e.underline,italics:e.italics,background:"black",flash:!1};this.setPen(m)},t.setBkgData=function t(e){this.logger.log(2,function(){return"bkgData = "+JSON.stringify(e)}),this.backSpace(),this.setPen(e),this.insertChar(32)},t.setRollUpRows=function t(e){this.nrRollUpRows=e},t.rollUp=function e(){var t=this;if(null===this.nrRollUpRows)return void this.logger.log(3,"roll_up but nrRollUpRows not set yet");this.logger.log(1,function(){return t.getDisplayText()});var a=this.currRow+1-this.nrRollUpRows,r=this.rows.splice(a,1)[0];r.clear(),this.rows.splice(this.currRow,0,r),this.logger.log(2,"Rolling up")},t.getDisplayText=function t(e){e=e||!1;for(var a=[],r="",n=-1,d=0,o;d<Ji;d++)o=this.rows[d].getTextString(),o&&(n=d+1,e?a.push("Row "+n+": '"+o+"'"):a.push(o.trim()));return 0<a.length&&(e?r="["+a.join(" | ")+"]":r=a.join("\n")),r},t.getTextAndFormat=function e(){return this.rows},e}(),fd=function(){function e(e,t,a){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=e,this.outputFilter=t,this.mode=null,this.verbose=0,this.displayedMemory=new cd(a),this.nonDisplayedMemory=new cd(a),this.lastOutputScreen=new cd(a),this.currRollUpRow=this.displayedMemory.rows[Ji-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=a}var t=e.prototype;return t.reset=function e(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[Ji-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null},t.getHandler=function e(){return this.outputFilter},t.setHandler=function t(e){this.outputFilter=e},t.setPAC=function t(e){this.writeScreen.setPAC(e)},t.setBkgData=function t(e){this.writeScreen.setBkgData(e)},t.setMode=function t(e){e===this.mode||(this.mode=e,this.logger.log(2,function(){return"MODE="+e}),"MODE_POP-ON"===this.mode?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),"MODE_ROLL-UP"!==this.mode&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)},t.insertChars=function t(e){for(var a=this,r=0;r<e.length;r++)this.writeScreen.insertChar(e[r]);var n=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,function(){return n+": "+a.writeScreen.getDisplayText(!0)}),("MODE_PAINT-ON"===this.mode||"MODE_ROLL-UP"===this.mode)&&(this.logger.log(1,function(){return"DISPLAYED: "+a.displayedMemory.getDisplayText(!0)}),this.outputDataUpdate())},t.ccRCL=function e(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")},t.ccBS=function e(){this.logger.log(2,"BS - BackSpace"),"MODE_TEXT"===this.mode||(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())},t.ccAOF=function e(){},t.ccAON=function e(){},t.ccDER=function e(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()},t.ccRU=function t(e){this.logger.log(2,"RU("+e+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(e)},t.ccFON=function e(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})},t.ccRDC=function e(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")},t.ccTR=function e(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")},t.ccRTD=function e(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")},t.ccEDM=function e(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)},t.ccCR=function e(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)},t.ccENM=function e(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()},t.ccEOC=function e(){var t=this;if(this.logger.log(2,"EOC - End Of Caption"),"MODE_POP-ON"===this.mode){var a=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=a,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,function(){return"DISP: "+t.displayedMemory.getDisplayText()})}this.outputDataUpdate(!0)},t.ccTO=function t(e){this.logger.log(2,"TO("+e+") - Tab Offset"),this.writeScreen.moveCursor(e)},t.ccMIDROW=function t(e){var a={flash:!1,underline:1==e%2,italics:46<=e};if(!a.italics){var r=u(e/2)-16,n=["white","green","blue","cyan","red","yellow","magenta"];a.foreground=n[r]}else a.foreground="white";this.logger.log(2,"MIDROW: "+JSON.stringify(a)),this.writeScreen.setPen(a)},t.outputDataUpdate=function t(e){void 0===e&&(e=!1);var a=this.logger.time;null===a||this.outputFilter&&(null!==this.cueStartTime||this.displayedMemory.isEmpty()?!this.displayedMemory.equals(this.lastOutputScreen)&&(this.outputFilter.newCue(this.cueStartTime,a,this.lastOutputScreen),e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:a):this.cueStartTime=a,this.lastOutputScreen.copy(this.displayedMemory))},t.cueSplitAtTime=function t(e){this.outputFilter&&!this.displayedMemory.isEmpty()&&(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e)},e}(),gd=function(){function e(e,t,a){this.channels=void 0,this.currentChannel=0,this.cmdHistory=void 0,this.logger=void 0;var r=new dd;this.channels=[null,new fd(e,t,r),new fd(e+1,a,r)],this.cmdHistory=wa(),this.logger=r}var t=e.prototype;return t.getHandler=function t(e){return this.channels[e].getHandler()},t.setHandler=function a(e,t){this.channels[e].setHandler(t)},t.addData=function r(e,t){var n=!1,d,o,s;this.logger.time=e;for(var l=0;l<t.length;l+=2){if(o=127&t[l],s=127&t[l+1],0===o&&0===s)continue;else this.logger.log(3,"["+od([t[l],t[l+1]])+"] -> ("+od([o,s])+")");if(d=this.parseCmd(o,s),d||(d=this.parseMidrow(o,s)),d||(d=this.parsePAC(o,s)),d||(d=this.parseBackgroundAttributes(o,s)),!d&&(n=this.parseChars(o,s),n)){var u=this.currentChannel;if(u&&0<u){var c=this.channels[u];c.insertChars(n)}else this.logger.log(2,"No channel found yet. TEXT-MODE?")}d||n||this.logger.log(2,"Couldn't parse cleaned data "+od([o,s])+" orig: "+od([t[l],t[l+1]]))}},t.parseCmd=function a(e,t){var r=this.cmdHistory,n=(20===e||28===e||21===e||29===e)&&32<=t&&47>=t,i=(23===e||31===e)&&33<=t&&35>=t;if(!(n||i))return!1;if(Ma(e,t,r))return Na(null,null,r),this.logger.log(3,"Repeated command ("+od([e,t])+") is dropped"),!0;var d=20===e||21===e||23===e?1:2,o=this.channels[d];return 20===e||21===e||28===e||29===e?32===t?o.ccRCL():33===t?o.ccBS():34===t?o.ccAOF():35===t?o.ccAON():36===t?o.ccDER():37===t?o.ccRU(2):38===t?o.ccRU(3):39===t?o.ccRU(4):40===t?o.ccFON():41===t?o.ccRDC():42===t?o.ccTR():43===t?o.ccRTD():44===t?o.ccEDM():45===t?o.ccCR():46===t?o.ccENM():47==t&&o.ccEOC():o.ccTO(t-32),Na(e,t,r),this.currentChannel=d,!0},t.parseMidrow=function a(e,t){var r=0;if((17===e||25===e)&&32<=t&&47>=t){if(r=17===e?1:2,r!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;var n=this.channels[r];return!!n&&(n.ccMIDROW(t),this.logger.log(3,"MIDROW ("+od([e,t])+")"),!0)}return!1},t.parsePAC=function a(e,t){var r=this.cmdHistory,n=(17<=e&&23>=e||25<=e&&31>=e)&&64<=t&&127>=t,i=(16===e||24===e)&&64<=t&&95>=t,d;if(!(n||i))return!1;if(Ma(e,t,r))return Na(null,null,r),!0;var o=23>=e?1:2;d=64<=t&&95>=t?1===o?td[e]:rd[e]:1===o?ad[e]:nd[e];var s=this.channels[o];return!!s&&(s.setPAC(this.interpretPAC(d,t)),Na(e,t,r),this.currentChannel=o,!0)},t.interpretPAC=function a(e,t){var r={color:null,italics:!1,indent:null,underline:!1,row:e},n;return n=95<t?t-96:t-64,r.underline=1==(1&n),13>=n?r.color=["white","green","blue","cyan","red","yellow","magenta","white"][u(n/2)]:15>=n?(r.italics=!0,r.color="white"):r.indent=4*u((n-16)/2),r},t.parseChars=function a(e,t){var r=null,n=null,i;if(25<=e?(i=2,n=e-8):(i=1,n=e),17<=n&&19>=n){var d;d=17===n?t+80:18===n?t+112:t+144,this.logger.log(2,"Special char '"+$i(d)+"' in channel "+i),r=[d]}else 32<=e&&127>=e&&(r=0===t?[e]:[e,t]);if(r){var o=od(r);this.logger.log(3,"Char codes =  "+o.join(",")),Na(e,t,this.cmdHistory)}return r},t.parseBackgroundAttributes=function a(e,t){var r=(16===e||24===e)&&32<=t&&47>=t,n=(23===e||31===e)&&45<=t&&47>=t;if(!(r||n))return!1;var i={},d;16===e||24===e?(d=u((t-32)/2),i.background=id[d],1==t%2&&(i.background+="_semi")):45===t?i.background="transparent":(i.foreground="black",47==t&&(i.underline=!0));var o=23>=e?1:2,s=this.channels[o];return s.setBkgData(i),Na(e,t,this.cmdHistory),!0},t.reset=function e(){for(var t=0,a;t<Object.keys(this.channels).length;t++)a=this.channels[t],a&&a.reset();this.cmdHistory=wa()},t.cueSplitAtTime=function t(e){for(var a=0,r;a<this.channels.length;a++)r=this.channels[a],r&&r.cueSplitAtTime(e)},e}(),md=function(){function e(e,t){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=e,this.trackName=t}var t=e.prototype;return t.dispatchCue=function e(){null===this.startTime||(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)},t.newCue=function r(e,t,a){(null===this.startTime||this.startTime>e)&&(this.startTime=e),this.endTime=t,this.screen=a,this.timelineController.createCaptionsTrack(this.trackName)},t.reset=function e(){this.cueRanges=[],this.startTime=null},e}(),pd=function(){function e(e,t){if("string"!=typeof t)return!1;if(!Array.isArray(e))return!1;var a=t.toLowerCase();return!!~e.indexOf(a)&&a}function t(t){return e(i,t)}function a(t){return e(d,t)}function r(e){for(var t=arguments.length,a=Array(1<t?t-1:0),r=1;r<t;r++)a[r-1]=arguments[r];for(var n=1,d;n<arguments.length;n++)for(var o in d=arguments[n],d)e[o]=d[o];return e}function n(e,n,i){var d=this,o={enumerable:!0};d.hasBeenReset=!1;var s="",l=!1,u=e,c=n,f=i,g=null,m="",p=!0,y="auto",T="start",h=50,E="middle",S=50,L="middle";Object.defineProperty(d,"id",r({},o,{get:function e(){return s},set:function t(e){s=""+e}})),Object.defineProperty(d,"pauseOnExit",r({},o,{get:function e(){return l},set:function t(e){l=!!e}})),Object.defineProperty(d,"startTime",r({},o,{get:function e(){return u},set:function t(e){if("number"!=typeof e)throw new TypeError("Start time must be set to a number.");u=e,this.hasBeenReset=!0}})),Object.defineProperty(d,"endTime",r({},o,{get:function e(){return c},set:function t(e){if("number"!=typeof e)throw new TypeError("End time must be set to a number.");c=e,this.hasBeenReset=!0}})),Object.defineProperty(d,"text",r({},o,{get:function e(){return f},set:function t(e){f=""+e,this.hasBeenReset=!0}})),Object.defineProperty(d,"region",r({},o,{get:function e(){return g},set:function t(e){g=e,this.hasBeenReset=!0}})),Object.defineProperty(d,"vertical",r({},o,{get:function e(){return m},set:function a(e){var r=t(e);if(!1===r)throw new SyntaxError("An invalid or illegal string was specified.");m=r,this.hasBeenReset=!0}})),Object.defineProperty(d,"snapToLines",r({},o,{get:function e(){return p},set:function t(e){p=!!e,this.hasBeenReset=!0}})),Object.defineProperty(d,"line",r({},o,{get:function e(){return y},set:function t(e){if("number"!=typeof e&&"auto"!==e)throw new SyntaxError("An invalid number or illegal string was specified.");y=e,this.hasBeenReset=!0}})),Object.defineProperty(d,"lineAlign",r({},o,{get:function e(){return T},set:function t(e){var r=a(e);if(!r)throw new SyntaxError("An invalid or illegal string was specified.");T=r,this.hasBeenReset=!0}})),Object.defineProperty(d,"position",r({},o,{get:function e(){return h},set:function t(e){if(0>e||100<e)throw new Error("Position must be between 0 and 100.");h=e,this.hasBeenReset=!0}})),Object.defineProperty(d,"positionAlign",r({},o,{get:function e(){return E},set:function t(e){var r=a(e);if(!r)throw new SyntaxError("An invalid or illegal string was specified.");E=r,this.hasBeenReset=!0}})),Object.defineProperty(d,"size",r({},o,{get:function e(){return S},set:function t(e){if(0>e||100<e)throw new Error("Size must be between 0 and 100.");S=e,this.hasBeenReset=!0}})),Object.defineProperty(d,"align",r({},o,{get:function e(){return L},set:function t(e){var r=a(e);if(!r)throw new SyntaxError("An invalid or illegal string was specified.");L=r,this.hasBeenReset=!0}})),d.displayState=void 0}if("undefined"!=typeof self&&self.VTTCue)return self.VTTCue;var i=["","lr","rl"],d=["start","middle","end","left","right"];return n.prototype.getCueAsHTML=function(){var e=self.WebVTT;return e.convertCueToDOMTree(self,this.text)},n}(),yd=function(){function e(){}var t=e.prototype;return t.decode=function a(e,t){if(!e)return"";if("string"!=typeof e)throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))},e}(),Td=function(){function e(){this.values=Object.create(null)}var t=e.prototype;return t.set=function a(e,t){this.get(e)||""===t||(this.values[e]=t)},t.get=function r(e,t,a){return a?this.has(e)?this.values[e]:t[a]:this.has(e)?this.values[e]:t},t.has=function t(e){return e in this.values},t.alt=function a(e,t,r){for(var i=0;i<r.length;++i)if(t===r[i]){this.set(e,t);break}},t.integer=function a(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))},t.percent=function a(e,t){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(t)){var a=parseFloat(t);if(0<=a&&100>=a)return this.set(e,a),!0}return!1},e}(),hd=new pd(0,0,""),Ed="middle"===hd.align?"middle":"center",Sd=function(){function e(){this.state="INITIAL",this.buffer="",this.decoder=new yd,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}var t=e.prototype;return t.parse=function t(e){function a(){var e=n.buffer,t=0;for(e=Ka(e);t<e.length&&"\r"!==e[t]&&"\n"!==e[t];)++t;var a=e.slice(0,t);return"\r"===e[t]&&++t,"\n"===e[t]&&++t,n.buffer=e.slice(t),a}function r(e){Ua(e,function(e,t){},/:/)}var n=this;e&&(n.buffer+=n.decoder.decode(e,{stream:!0}));try{var i="";if("INITIAL"===n.state){if(!/\r\n|\n/.test(n.buffer))return this;i=a();var d=i.match(/^(ï»¿)?WEBVTT([ \t].*)?$/);if(!(null!=d&&d[0]))throw new Error("Malformed WebVTT signature.");n.state="HEADER"}for(var o=!1;n.buffer;){if(!/\r\n|\n/.test(n.buffer))return this;switch(o?o=!1:i=a(),n.state){case"HEADER":/:/.test(i)?r(i):!i&&(n.state="ID");continue;case"NOTE":i||(n.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(i)){n.state="NOTE";break}if(!i)continue;if(n.cue=new pd(0,0,""),n.state="CUE",-1===i.indexOf("-->")){n.cue.id=i;continue}case"CUE":if(!n.cue){n.state="BADCUE";continue}try{Ga(i,n.cue,n.regionList)}catch(t){n.cue=null,n.state="BADCUE";continue}n.state="CUETEXT";continue;case"CUETEXT":{var s=-1!==i.indexOf("-->");if(!i||s&&(o=!0)){n.oncue&&n.cue&&n.oncue(n.cue),n.cue=null,n.state="ID";continue}if(null===n.cue)continue;n.cue.text&&(n.cue.text+="\n"),n.cue.text+=i}continue;case"BADCUE":i||(n.state="ID")}}}catch(t){"CUETEXT"===n.state&&n.cue&&n.oncue&&n.oncue(n.cue),n.cue=null,n.state="INITIAL"===n.state?"BADWEBVTT":"BADCUE"}return this},t.flush=function e(){var t=this;try{if((t.cue||"HEADER"===t.state)&&(t.buffer+="\n\n",t.parse()),"INITIAL"===t.state||"BADWEBVTT"===t.state)throw new Error("Malformed WebVTT signature.")}catch(a){t.onparsingerror&&t.onparsingerror(a)}return t.onflush&&t.onflush(),this},e}(),Ld=/\r\n|\n\r|\n|\r/g,Rd=function r(e,t,a){return void 0===a&&(a=0),e.slice(a,a+t.length)===t},Ad=function t(e){var a=parseInt(e.slice(-3)),r=parseInt(e.slice(-6,-4)),n=parseInt(e.slice(-9,-7)),i=9<e.length?parseInt(e.substring(0,e.indexOf(":"))):0;if(!yr(a)||!yr(r)||!yr(n)||!yr(i))throw Error("Malformed X-TIMESTAMP-MAP: Local:"+e);return a+=1e3*r,a+=60000*n,a+=3600000*i,a},vd=function t(e){for(var t=5381,a=e.length;a;)t=33*t^e.charCodeAt(--a);return(t>>>0).toString()},Id=function r(e,t,a){var n=e[t],i=e[n.prevCC];if(!i||!i.new&&n.new)return e.ccOffset=e.presentationOffset=n.start,void(n.new=!1);for(;null!=(d=i)&&d.new;){var d;e.ccOffset+=n.start-i.start,n.new=!1,n=i,i=e[n.prevCC]}e.presentationOffset=a},Dd="stpp.ttml.im1t",kd=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,_d=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,bd={left:"start",center:"center",right:"end",start:"start",end:"end"},Cd=function(){function e(e){if(this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=rr(),this.captionsProperties=void 0,this.hls=e,this.config=e.config,this.Cues=e.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},this.config.enableCEA708Captions){var t=new md(this,"textTrack1"),a=new md(this,"textTrack2"),r=new md(this,"textTrack3"),n=new md(this,"textTrack4");this.cea608Parser1=new gd(1,t,a),this.cea608Parser2=new gd(3,r,n)}e.on(Tr.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(Tr.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(Tr.MANIFEST_LOADING,this.onManifestLoading,this),e.on(Tr.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(Tr.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(Tr.FRAG_LOADING,this.onFragLoading,this),e.on(Tr.FRAG_LOADED,this.onFragLoaded,this),e.on(Tr.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.on(Tr.FRAG_DECRYPTED,this.onFragDecrypted,this),e.on(Tr.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(Tr.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.on(Tr.BUFFER_FLUSHING,this.onBufferFlushing,this)}var t=e.prototype;return t.destroy=function e(){var t=this.hls;t.off(Tr.MEDIA_ATTACHING,this.onMediaAttaching,this),t.off(Tr.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(Tr.MANIFEST_LOADING,this.onManifestLoading,this),t.off(Tr.MANIFEST_LOADED,this.onManifestLoaded,this),t.off(Tr.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),t.off(Tr.FRAG_LOADING,this.onFragLoading,this),t.off(Tr.FRAG_LOADED,this.onFragLoaded,this),t.off(Tr.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),t.off(Tr.FRAG_DECRYPTED,this.onFragDecrypted,this),t.off(Tr.INIT_PTS_FOUND,this.onInitPtsFound,this),t.off(Tr.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),t.off(Tr.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=this.cea608Parser1=this.cea608Parser2=null},t.addCues=function d(e,t,a,r,n){for(var s=!1,l=n.length;l--;){var u=n[l],c=ar(u[0],u[1],t,a);if(0<=c&&(u[0]=o(u[0],t),u[1]=f(u[1],a),s=!0,.5<c/(a-t)))return}if(s||n.push([t,a]),this.config.renderTextTracksNatively){var g=this.captionsTracks[e];this.Cues.newCue(g,t,a,r)}else{var m=this.Cues.newCue(null,t,a,r);this.hls.trigger(Tr.CUES_PARSED,{type:"captions",cues:m,track:e})}},t.onInitPtsFound=function a(e,t){var r=this,n=t.frag,i=t.id,d=t.initPTS,o=t.timescale,s=this.unparsedVttFrags;"main"===i&&(this.initPTS[n.cc]={baseTime:d,timescale:o}),s.length&&(this.unparsedVttFrags=[],s.forEach(function(e){r.onFragLoaded(Tr.FRAG_LOADED,e)}))},t.getExistingTrack=function t(e){var a=this.media;if(a)for(var r=0,n;r<a.textTracks.length;r++)if(n=a.textTracks[r],n[e])return n;return null},t.createCaptionsTrack=function t(e){this.config.renderTextTracksNatively?this.createNativeTrack(e):this.createNonNativeTrack(e)},t.createNativeTrack=function t(e){if(!this.captionsTracks[e]){var a=this.captionsProperties,r=this.captionsTracks,n=this.media,i=a[e],d=i.label,o=i.languageCode,s=this.getExistingTrack(e);if(!s){var l=this.createTextTrack("captions",d,o);l&&(l[e]=!0,r[e]=l)}else r[e]=s,Ve(r[e]),Ke(r[e],n)}},t.createNonNativeTrack=function t(e){if(!this.nonNativeCaptionsTracks[e]){var a=this.captionsProperties[e];if(a){var r=a.label,n={_id:e,label:r,kind:"captions",default:!!a.media&&!!a.media.default,closedCaptions:a.media};this.nonNativeCaptionsTracks[e]=n,this.hls.trigger(Tr.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[n]})}}},t.createTextTrack=function r(e,t,a){var n=this.media;return n?n.addTextTrack(e,t,a):void 0},t.onMediaAttaching=function a(e,t){this.media=t.media,this._cleanTracks()},t.onMediaDetaching=function e(){var t=this.captionsTracks;Object.keys(t).forEach(function(e){Ve(t[e]),delete t[e]}),this.nonNativeCaptionsTracks={}},t.onManifestLoading=function e(){this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=rr(),this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())},t._cleanTracks=function e(){var t=this.media;if(t){var a=t.textTracks;if(a)for(var r=0;r<a.length;r++)Ve(a[r])}},t.onSubtitleTracksUpdated=function a(e,t){var r=this,n=t.subtitleTracks||[],i=n.some(function(e){return e.textCodec===Dd});if(this.config.enableWebVTT||i&&this.config.enableIMSC1){var d=xa(this.tracks,n);if(d)return void(this.tracks=n);if(this.textTracks=[],this.tracks=n,this.config.renderTextTracksNatively){var o=this.media?this.media.textTracks:null;this.tracks.forEach(function(e,t){var a;if(o&&t<o.length){for(var n=null,d=0;d<o.length;d++)if(tr(o[d],e)){n=o[d];break}n&&(a=n)}if(a)Ve(a);else{var s=r._captionsOrSubtitlesFromCharacteristics(e);a=r.createTextTrack(s,e.name,e.lang),a&&(a.mode="disabled")}a&&(a.groupId=e.groupId,r.textTracks.push(a))})}else if(this.tracks.length){var s=this.tracks.map(function(e){return{label:e.name,kind:e.type.toLowerCase(),default:e.default,subtitleTrack:e}});this.hls.trigger(Tr.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:s})}}},t._captionsOrSubtitlesFromCharacteristics=function t(e){if(e.attrs.CHARACTERISTICS){var a=/transcribes-spoken-dialog/gi.test(e.attrs.CHARACTERISTICS),r=/describes-music-and-sound/gi.test(e.attrs.CHARACTERISTICS);if(a&&r)return"captions"}return"subtitles"},t.onManifestLoaded=function a(e,t){var r=this;this.config.enableCEA708Captions&&t.captions&&t.captions.forEach(function(e){var t=/(?:CC|SERVICE)([1-4])/.exec(e.instreamId);if(t){var a="textTrack"+t[1],n=r.captionsProperties[a];n&&(n.label=e.name,e.lang&&(n.languageCode=e.lang),n.media=e)}})},t.closedCaptionsForLevel=function t(e){var a=this.hls.levels[e.level];return null==a?void 0:a.attrs["CLOSED-CAPTIONS"]},t.onFragLoading=function a(e,t){var r=this.cea608Parser1,n=this.cea608Parser2,i=this.lastSn,d=this.lastPartIndex;if(this.enabled&&r&&n&&t.frag.type===yn.MAIN){var o=t.frag.sn,s=null==(l=null==t||null==(u=t.part)?void 0:u.index)?-1:l,l,u;o===i+1||o===i&&s===d+1||(r.reset(),n.reset()),this.lastSn=o,this.lastPartIndex=s}},t.onFragLoaded=function a(e,t){var r=t.frag,n=t.payload;if(r.type===yn.SUBTITLE)if(n.byteLength){var i=r.decryptdata,d=("stats"in t);if(null==i||!i.encrypted||d){var o=this.tracks[r.level],s=this.vttCCs;s[r.cc]||(s[r.cc]={start:r.start,prevCC:this.prevCC,new:!0},this.prevCC=r.cc),o&&o.textCodec===Dd?this._parseIMSC1(r,n):this._parseVTTs(t)}}else this.hls.trigger(Tr.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:r,error:new Error("Empty subtitle payload")})},t._parseIMSC1=function a(e,t){var r=this,n=this.hls;Wa(t,this.initPTS[e.cc],function(t){r._appendCues(t,e.level),n.trigger(Tr.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})},function(t){Ar.log("Failed to parse IMSC1: "+t),n.trigger(Tr.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e,error:t})})},t._parseVTTs=function t(e){var a=this,r=e.frag,n=e.payload,i=this.initPTS,d=this.unparsedVttFrags,o=i.length-1,s;if(!i[r.cc]&&-1===o)return void d.push(e);var l=this.hls,u=null!=(s=r.initSegment)&&s.data?fe(r.initSegment.data,new Uint8Array(n)):n;Va(u,this.initPTS[r.cc],this.vttCCs,r.cc,r.start,function(e){a._appendCues(e,r.level),l.trigger(Tr.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:r})},function(t){var i="Missing initPTS for VTT MPEGTS"===t.message;i?d.push(e):a._fallbackToIMSC1(r,n),Ar.log("Failed to parse VTT cue: "+t),i&&o>r.cc||l.trigger(Tr.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:r,error:t})})},t._fallbackToIMSC1=function a(e,t){var r=this,n=this.tracks[e.level];n.textCodec||Wa(t,this.initPTS[e.cc],function(){n.textCodec=Dd,r._parseIMSC1(e,t)},function(){n.textCodec="wvtt"})},t._appendCues=function a(e,t){var r=this.hls;if(this.config.renderTextTracksNatively){var n=this.textTracks[t];if(!n||"disabled"===n.mode)return;e.forEach(function(e){return He(n,e)})}else{var i=this.tracks[t];if(!i)return;var d=i.default?"default":"subtitles"+t;r.trigger(Tr.CUES_PARSED,{type:"subtitles",cues:e,track:d})}},t.onFragDecrypted=function a(e,t){var r=t.frag;r.type===yn.SUBTITLE&&this.onFragLoaded(Tr.FRAG_LOADED,t)},t.onSubtitleTracksCleared=function e(){this.tracks=[],this.captionsTracks={}},t.onFragParsingUserdata=function a(e,t){var r=this.cea608Parser1,n=this.cea608Parser2;if(this.enabled&&r&&n){var d=t.frag,o=t.samples;if(d.type!==yn.MAIN||"NONE"!==this.closedCaptionsForLevel(d))for(var s=0,l;s<o.length;s++)if(l=o[s].bytes,l){var u=this.extractCea608Data(l);r.addData(o[s].pts,u[0]),n.addData(o[s].pts,u[1])}}},t.onBufferFlushing=function a(e,t){var r=t.startOffset,n=t.endOffset,i=t.endOffsetSubtitles,d=t.type,o=this.media;if(o&&!(o.currentTime<n)){if(!d||"video"===d){var s=this.captionsTracks;Object.keys(s).forEach(function(e){return We(s[e],r,n)})}if(this.config.renderTextTracksNatively&&0===r&&void 0!==i){var l=this.textTracks;Object.keys(l).forEach(function(e){return We(l[e],r,i)})}}},t.extractCea608Data=function t(e){for(var a=[[],[]],r=31&e[0],n=2,i=0;i<r;i++){var d=e[n++],o=127&e[n++],s=127&e[n++];if(0!==o||0!==s){var l=0!=(4&d);if(l){var u=3&d;(0==u||1===u)&&(a[u].push(o),a[u].push(s))}}}return a},e}(),Pd=function(){function e(e){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=e,this.autoLevelCapping=n,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}var t=e.prototype;return t.setStreamController=function t(e){this.streamController=e},t.destroy=function e(){this.unregisterListener(),this.hls.config.capLevelToPlayerSize&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null},t.registerListeners=function e(){var t=this.hls;t.on(Tr.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),t.on(Tr.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(Tr.MANIFEST_PARSED,this.onManifestParsed,this),t.on(Tr.BUFFER_CODECS,this.onBufferCodecs,this),t.on(Tr.MEDIA_DETACHING,this.onMediaDetaching,this)},t.unregisterListener=function e(){var t=this.hls;t.off(Tr.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),t.off(Tr.MEDIA_ATTACHING,this.onMediaAttaching,this),t.off(Tr.MANIFEST_PARSED,this.onManifestParsed,this),t.off(Tr.BUFFER_CODECS,this.onBufferCodecs,this),t.off(Tr.MEDIA_DETACHING,this.onMediaDetaching,this)},t.onFpsDropLevelCapping=function a(e,t){var r=this.hls.levels[t.droppedLevel];this.isLevelAllowed(r)&&this.restrictedLevels.push({bitrate:r.bitrate,height:r.height,width:r.width})},t.onMediaAttaching=function a(e,t){this.media=t.media instanceof HTMLVideoElement?t.media:null,this.clientRect=null},t.onManifestParsed=function a(e,t){var r=this.hls;this.restrictedLevels=[],this.firstLevel=t.firstLevel,r.config.capLevelToPlayerSize&&t.video&&this.startCapping()},t.onBufferCodecs=function a(e,t){var r=this.hls;r.config.capLevelToPlayerSize&&t.video&&this.startCapping()},t.onMediaDetaching=function e(){this.stopCapping()},t.detectPlayerSize=function e(){if(this.media&&0<this.mediaHeight&&0<this.mediaWidth){var t=this.hls.levels;if(t.length){var a=this.hls;a.autoLevelCapping=this.getMaxLevel(t.length-1),a.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=a.autoLevelCapping}}},t.getMaxLevel=function a(t){var r=this,n=this.hls.levels;if(!n.length)return-1;var i=n.filter(function(e,a){return r.isLevelAllowed(e)&&a<=t});return this.clientRect=null,e.getMaxLevelByMediaSize(i,this.mediaWidth,this.mediaHeight)},t.startCapping=function e(){this.timer||(this.autoLevelCapping=n,this.hls.firstLevel=this.getMaxLevel(this.firstLevel),self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())},t.stopCapping=function e(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=n,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)},t.getDimensions=function e(){if(this.clientRect)return this.clientRect;var t=this.media,a={width:0,height:0};if(t){var r=t.getBoundingClientRect();a.width=r.width,a.height=r.height,a.width||a.height||(a.width=r.right-r.left||t.width||0,a.height=r.bottom-r.top||t.height||0)}return this.clientRect=a,a},t.isLevelAllowed=function t(e){var a=this.restrictedLevels;return!a.some(function(t){return e.bitrate===t.bitrate&&e.width===t.width&&e.height===t.height})},e.getMaxLevelByMediaSize=function r(e,t,a){if(!(null!=e&&e.length))return-1;for(var n=function a(e,t){return!t||e.width!==t.width||e.height!==t.height},d=e.length-1,o=0,s;o<e.length;o+=1)if(s=e[o],(s.width>=t||s.height>=a)&&n(s,e[o+1])){d=o;break}return d},T(e,[{key:"mediaWidth",get:function e(){return this.getDimensions().width*this.contentScaleFactor}},{key:"mediaHeight",get:function e(){return this.getDimensions().height*this.contentScaleFactor}},{key:"contentScaleFactor",get:function e(){var t=1;if(!this.hls.config.ignoreDevicePixelRatio)try{t=self.devicePixelRatio}catch(t){}return t}}]),e}(),xd=function(){function e(e){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=e,this.registerListeners()}var t=e.prototype;return t.setStreamController=function t(e){this.streamController=e},t.registerListeners=function e(){this.hls.on(Tr.MEDIA_ATTACHING,this.onMediaAttaching,this)},t.unregisterListeners=function e(){this.hls.off(Tr.MEDIA_ATTACHING,this.onMediaAttaching,this)},t.destroy=function e(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null},t.onMediaAttaching=function a(e,t){var r=this.hls.config;if(r.capLevelOnFPSDrop){var n=t.media instanceof self.HTMLVideoElement?t.media:null;this.media=n,n&&"function"==typeof n.getVideoPlaybackQuality&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),r.fpsDroppedMonitoringPeriod)}},t.checkFPS=function r(e,t,a){var n=performance.now();if(t){if(this.lastTime){var i=n-this.lastTime,d=a-this.lastDroppedFrames,o=t-this.lastDecodedFrames,s=1e3*d/i,l=this.hls;if(l.trigger(Tr.FPS_DROP,{currentDropped:d,currentDecoded:o,totalDroppedFrames:a}),0<s&&d>l.config.fpsDroppedMonitoringThreshold*o){var u=l.currentLevel;Ar.warn("drop FPS ratio greater than max allowed value for currentLevel: "+u),0<u&&(-1===l.autoLevelCapping||l.autoLevelCapping>=u)&&(--u,l.trigger(Tr.FPS_DROP_LEVEL_CAPPING,{level:u,droppedLevel:l.currentLevel}),l.autoLevelCapping=u,this.streamController.nextLevelSwitch())}}this.lastTime=n,this.lastDroppedFrames=a,this.lastDecodedFrames=t}},t.checkFPSInterval=function e(){var t=this.media;if(t)if(this.isVideoPlaybackQualityAvailable){var a=t.getVideoPlaybackQuality();this.checkFPS(t,a.totalVideoFrames,a.droppedVideoFrames)}else this.checkFPS(t,t.webkitDecodedFrameCount,t.webkitDroppedFrameCount)},e}(),Fd="[eme]",Od=function(){function e(t){this.hls=void 0,this.config=void 0,this.media=null,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.setMediaKeysQueue=e.CDMCleanupPromise?[e.CDMCleanupPromise]:[],this.onMediaEncrypted=this._onMediaEncrypted.bind(this),this.onWaitingForKey=this._onWaitingForKey.bind(this),this.debug=Ar.debug.bind(Ar,Fd),this.log=Ar.log.bind(Ar,Fd),this.warn=Ar.warn.bind(Ar,Fd),this.error=Ar.error.bind(Ar,Fd),this.hls=t,this.config=t.config,this.registerListeners()}var t=e.prototype;return t.destroy=function e(){this.unregisterListeners(),this.onMediaDetached();var t=this.config;t.requestMediaKeySystemAccessFunc=null,t.licenseXhrSetup=t.licenseResponseCallback=void 0,t.drmSystems=t.drmSystemOptions={},this.hls=this.onMediaEncrypted=this.onWaitingForKey=this.keyIdToKeySessionPromise=null,this.config=null},t.registerListeners=function e(){this.hls.on(Tr.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(Tr.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(Tr.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(Tr.MANIFEST_LOADED,this.onManifestLoaded,this)},t.unregisterListeners=function e(){this.hls.off(Tr.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(Tr.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(Tr.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(Tr.MANIFEST_LOADED,this.onManifestLoaded,this)},t.getLicenseServerUrl=function t(e){var a=this.config,r=a.drmSystems,n=a.widevineLicenseUrl,i=r[e];if(i)return i.licenseUrl;if(e===Or.WIDEVINE&&n)return n;throw new Error("no license server URL configured for key-system \""+e+"\"")},t.getServerCertificateUrl=function t(e){var a=this.config.drmSystems,r=a[e];return r?r.serverCertificateUrl:void this.log("No Server Certificate in config.drmSystems[\""+e+"\"]")},t.attemptKeySystemAccess=function t(e){var a=this,r=this.hls.levels,n=function a(e,t,r){return!!e&&r.indexOf(e)===t},i=r.map(function(e){return e.audioCodec}).filter(n),d=r.map(function(e){return e.videoCodec}).filter(n);return 0===i.length+d.length&&d.push("avc1.42e01e"),new Promise(function(t,r){var n=function n(e){var o=e.shift();a.getMediaKeysPromise(o,i,d).then(function(e){return t({keySystem:o,mediaKeys:e})}).catch(function(t){e.length?n(e):t instanceof Nd?r(t):r(new Nd({type:hr.KEY_SYSTEM_ERROR,details:Er.KEY_SYSTEM_NO_ACCESS,error:t,fatal:!0},t.message))})};n(e)})},t.requestMediaKeySystemAccess=function a(e,t){var r=this.config.requestMediaKeySystemAccessFunc;if("function"!=typeof r){var n="Configured requestMediaKeySystemAccess is not a function "+r;return null===wr&&"http:"===self.location.protocol&&(n="navigator.requestMediaKeySystemAccess is not available over insecure protocol "+location.protocol),Promise.reject(new Error(n))}return r(e,t)},t.getMediaKeysPromise=function r(e,t,a){var n=this,i=z(e,t,a,this.config.drmSystemOptions),d=this.keySystemAccessPromises[e],o=null==d?void 0:d.keySystemAccess;if(!o){this.log("Requesting encrypted media \""+e+"\" key-system access with config: "+JSON.stringify(i)),o=this.requestMediaKeySystemAccess(e,i);var s=this.keySystemAccessPromises[e]={keySystemAccess:o};return o.catch(function(t){n.log("Failed to obtain access to key-system \""+e+"\": "+t)}),o.then(function(t){n.log("Access for key-system \""+t.keySystem+"\" obtained");var a=n.fetchServerCertificate(e);return n.log("Create media-keys for \""+e+"\""),s.mediaKeys=t.createMediaKeys().then(function(t){return n.log("Media-keys created for \""+e+"\""),a.then(function(a){return a?n.setMediaKeysServerCertificate(t,e,a):t})}),s.mediaKeys.catch(function(t){n.error("Failed to create media-keys for \""+e+"\"}: "+t)}),s.mediaKeys})}return o.then(function(){return d.mediaKeys})},t.createMediaKeySessionContext=function t(e){var a=e.decryptdata,r=e.keySystem,n=e.mediaKeys;this.log("Creating key-system session \""+r+"\" keyId: "+Jr.hexDump(a.keyId||[]));var i=n.createSession(),d={decryptdata:a,keySystem:r,mediaKeys:n,mediaKeysSession:i,keyStatus:"status-pending"};return this.mediaKeySessions.push(d),d},t.renewKeySession=function t(e){var a=e.decryptdata;if(a.pssh){var r=this.createMediaKeySessionContext(e),n=this.getKeyIdString(a),i="cenc";this.keyIdToKeySessionPromise[n]=this.generateRequestWithPreferredKeySession(r,i,a.pssh,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(e)},t.getKeyIdString=function t(e){if(!e)throw new Error("Could not read keyId of undefined decryptdata");if(null===e.keyId)throw new Error("keyId is null");return Jr.hexDump(e.keyId)},t.updateKeySession=function a(e,t){var r=e.mediaKeysSession,n;return this.log("Updating key-session \""+r.sessionId+"\" for keyID "+Jr.hexDump((null==(n=e.decryptdata)?void 0:n.keyId)||[])+"\n      } (data length: "+(t?t.byteLength:t)+")"),r.update(t)},t.selectKeySystemFormat=function t(e){var a=Object.keys(e.levelkeys||{});return this.keyFormatPromise||(this.log("Selecting key-system from fragment (sn: "+e.sn+" "+e.type+": "+e.level+") key formats "+a.join(", ")),this.keyFormatPromise=this.getKeyFormatPromise(a)),this.keyFormatPromise},t.getKeyFormatPromise=function t(e){var a=this;return new Promise(function(t,r){var n=q(a.config),i=e.map(V).filter(function(e){return!!e&&-1!==n.indexOf(e)});return a.getKeySystemSelectionPromise(i).then(function(e){var a=e.keySystem,n=Y(a);n?t(n):r(new Error("Unable to find format for key-system \""+a+"\""))}).catch(r)})},t.loadKey=function t(e){var a=this,r=e.keyInfo.decryptdata,n=this.getKeyIdString(r),i="(keyId: "+n+" format: \""+r.keyFormat+"\" method: "+r.method+" uri: "+r.uri+")";this.log("Starting session for key "+i);var d=this.keyIdToKeySessionPromise[n];return d||(d=this.keyIdToKeySessionPromise[n]=this.getKeySystemForKeyPromise(r).then(function(t){var n=t.keySystem,d=t.mediaKeys;return a.throwIfDestroyed(),a.log("Handle encrypted media sn: "+e.frag.sn+" "+e.frag.type+": "+e.frag.level+" using key "+i),a.attemptSetMediaKeys(n,d).then(function(){a.throwIfDestroyed();var e=a.createMediaKeySessionContext({keySystem:n,mediaKeys:d,decryptdata:r}),t="cenc";return a.generateRequestWithPreferredKeySession(e,t,r.pssh,"playlist-key")})}),d.catch(function(e){return a.handleError(e)})),d},t.throwIfDestroyed=function t(e){if(!this.hls)throw new Error("invalid state")},t.handleError=function t(e){this.hls&&(this.error(e.message),e instanceof Nd?this.hls.trigger(Tr.ERROR,e.data):this.hls.trigger(Tr.ERROR,{type:hr.KEY_SYSTEM_ERROR,details:Er.KEY_SYSTEM_NO_KEYS,error:e,fatal:!0}))},t.getKeySystemForKeyPromise=function t(e){var a=this.getKeyIdString(e),r=this.keyIdToKeySessionPromise[a];if(!r){var n=V(e.keyFormat),i=n?[n]:q(this.config);return this.attemptKeySystemAccess(i)}return r},t.getKeySystemSelectionPromise=function t(e){if(e.length||(e=q(this.config)),0===e.length)throw new Nd({type:hr.KEY_SYSTEM_ERROR,details:Er.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},"Missing key-system license configuration options "+JSON.stringify({drmSystems:this.config.drmSystems}));return this.attemptKeySystemAccess(e)},t._onMediaEncrypted=function t(e){var a=this,r=e.initDataType,n=e.initData;if(this.debug("\""+e.type+"\" event: init data type: \""+r+"\""),null!==n){var d,o;if("sinf"===r&&this.config.drmSystems[Or.FAIRPLAY]){var s=Z(new Uint8Array(n));try{var l=B(JSON.parse(s).sinf),u=de(new Uint8Array(l));if(!u)return;d=u.subarray(8,24),o=Or.FAIRPLAY}catch(e){return void this.warn("Failed to parse sinf \"encrypted\" event message initData")}}else{var c=Le(n);if(null===c)return;0===c.version&&c.systemId===Mr.WIDEVINE&&c.data&&(d=c.data.subarray(8,24)),o=W(c.systemId)}if(o&&d){for(var f=Jr.hexDump(d),g=this.keyIdToKeySessionPromise,m=this.mediaKeySessions,p=g[f],y=function e(){var t=m[T],i=t.decryptdata;if(i.pssh||!i.keyId)return"continue";var o=Jr.hexDump(i.keyId);if(f===o||-1!==i.uri.replace(/-/g,"").indexOf(f))return p=g[o],delete g[o],i.pssh=new Uint8Array(n),i.keyId=d,p=g[f]=p.then(function(){return a.generateRequestWithPreferredKeySession(t,r,n,"encrypted-event-key-match")}),"break"},T=0,h;T<m.length&&(h=y(),"continue"===h||"break"!==h);T++);p||(p=g[f]=this.getKeySystemSelectionPromise([o]).then(function(e){var t=e.keySystem,i=e.mediaKeys,o;a.throwIfDestroyed();var s=new nn("ISO-23001-7",f,null==(o=Y(t))?"":o);return s.pssh=new Uint8Array(n),s.keyId=d,a.attemptSetMediaKeys(t,i).then(function(){a.throwIfDestroyed();var e=a.createMediaKeySessionContext({decryptdata:s,keySystem:t,mediaKeys:i});return a.generateRequestWithPreferredKeySession(e,r,n,"encrypted-event-no-match")})})),p.catch(function(e){return a.handleError(e)})}}},t._onWaitingForKey=function t(e){this.log("\""+e.type+"\" event")},t.attemptSetMediaKeys=function a(e,t){var r=this,n=this.setMediaKeysQueue.slice();this.log("Setting media-keys for \""+e+"\"");var i=Promise.all(n).then(function(){if(!r.media)throw new Error("Attempted to set mediaKeys without media element attached");return r.media.setMediaKeys(t)});return this.setMediaKeysQueue.push(i),i.then(function(){r.log("Media-keys set for \""+e+"\""),n.push(i),r.setMediaKeysQueue=r.setMediaKeysQueue.filter(function(e){return-1===n.indexOf(e)})})},t.generateRequestWithPreferredKeySession=function n(e,t,a,r){var i=this,d=null==(o=this.config.drmSystems)||null==(s=o[e.keySystem])?void 0:s.generateRequest,o,s;if(d)try{var l=d.call(this.hls,t,a,e);if(!l)throw new Error("Invalid response from configured generateRequest filter");t=l.initDataType,a=e.decryptdata.pssh=l.initData?new Uint8Array(l.initData):null}catch(e){var u;if(this.warn(e.message),null!=(u=this.hls)&&u.config.debug)throw e}if(null===a)return this.log("Skipping key-session request for \""+r+"\" (no initData)"),Promise.resolve(e);var c=this.getKeyIdString(e.decryptdata);this.log("Generating key-session request for \""+r+"\": "+c+" (init data type: "+t+" length: "+(a?a.byteLength:null)+")");var f=new Ci;e.mediaKeysSession.onmessage=function(t){var a=e.mediaKeysSession;if(!a)return void f.emit("error",new Error("invalid state"));var r=t.messageType,n=t.message;i.log("\""+r+"\" message event for session \""+a.sessionId+"\" message size: "+n.byteLength),"license-request"===r||"license-renewal"===r?i.renewLicense(e,n).catch(function(e){i.handleError(e),f.emit("error",e)}):"license-release"===r?e.keySystem===Or.FAIRPLAY&&(i.updateKeySession(e,H("acknowledged")),i.removeSession(e)):i.warn("unhandled media key message type \""+r+"\"")},e.mediaKeysSession.onkeystatuseschange=function(t){var a=e.mediaKeysSession;if(!a)return void f.emit("error",new Error("invalid state"));i.onKeyStatusChange(e);var r=e.keyStatus;f.emit("keyStatus",r),"expired"===r&&(i.warn(e.keySystem+" expired for key "+c),i.renewKeySession(e))};var g=new Promise(function(e,t){f.on("error",t),f.on("keyStatus",function(a){a.startsWith("usable")?e():"output-restricted"===a?t(new Nd({type:hr.KEY_SYSTEM_ERROR,details:Er.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED,fatal:!1},"HDCP level output restricted")):"internal-error"===a?t(new Nd({type:hr.KEY_SYSTEM_ERROR,details:Er.KEY_SYSTEM_STATUS_INTERNAL_ERROR,fatal:!0},"key status changed to \""+a+"\"")):"expired"===a?t(new Error("key expired while generating request")):i.warn("unhandled key status change \""+a+"\"")})});return e.mediaKeysSession.generateRequest(t,a).then(function(){var t;i.log("Request generated for key-session \""+(null==(t=e.mediaKeysSession)?void 0:t.sessionId)+"\" keyId: "+c)}).catch(function(e){throw new Nd({type:hr.KEY_SYSTEM_ERROR,details:Er.KEY_SYSTEM_NO_SESSION,error:e,fatal:!1},"Error generating key-session request: "+e)}).then(function(){return g}).catch(function(t){throw f.removeAllListeners(),i.removeSession(e),t}).then(function(){return f.removeAllListeners(),e})},t.onKeyStatusChange=function t(e){var a=this;e.mediaKeysSession.keyStatuses.forEach(function(t,r){a.log("key status change \""+t+"\" for keyStatuses keyId: "+Jr.hexDump("buffer"in r?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):new Uint8Array(r))+" session keyId: "+Jr.hexDump(new Uint8Array(e.decryptdata.keyId||[]))+" uri: "+e.decryptdata.uri),e.keyStatus=t})},t.fetchServerCertificate=function t(e){var a=this.config,r=a.loader,n=new r(a),i=this.getServerCertificateUrl(e);return i?(this.log("Fetching serverCertificate for \""+e+"\""),new Promise(function(t,r){var d={responseType:"arraybuffer",url:i},o=a.certLoadPolicy.default,s={loadPolicy:o,timeout:o.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},l={onSuccess:function i(e,a,r,n){t(e.data)},onError:function s(t,a,n,o){r(new Nd({type:hr.KEY_SYSTEM_ERROR,details:Er.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:n,response:p({url:d.url,data:void 0},t)},"\""+e+"\" certificate request failed ("+i+"). Status: "+t.code+" ("+t.text+")"))},onTimeout:function o(t,a,n){r(new Nd({type:hr.KEY_SYSTEM_ERROR,details:Er.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:n,response:{url:d.url,data:void 0}},"\""+e+"\" certificate request timed out ("+i+")"))},onAbort:function n(e,t,a){r(new Error("aborted"))}};n.load(d,s,l)})):Promise.resolve()},t.setMediaKeysServerCertificate=function r(e,t,a){var n=this;return new Promise(function(r,i){e.setServerCertificate(a).then(function(i){n.log("setServerCertificate "+(i?"success":"not supported by CDM")+" ("+(null==a?void 0:a.byteLength)+") on \""+t+"\""),r(e)}).catch(function(e){i(new Nd({type:hr.KEY_SYSTEM_ERROR,details:Er.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:e,fatal:!0},e.message))})})},t.renewLicense=function a(e,t){var r=this;return this.requestLicense(e,new Uint8Array(t)).then(function(t){return r.updateKeySession(e,new Uint8Array(t)).catch(function(e){throw new Nd({type:hr.KEY_SYSTEM_ERROR,details:Er.KEY_SYSTEM_SESSION_UPDATE_FAILED,error:e,fatal:!0},e.message)})})},t.setupLicenseXHR=function n(e,t,a,r){var i=this,d=this.config.licenseXhrSetup;return d?Promise.resolve().then(function(){if(!a.decryptdata)throw new Error("Key removed");return d.call(i.hls,e,t,a,r)}).catch(function(n){if(!a.decryptdata)throw n;return e.open("POST",t,!0),d.call(i.hls,e,t,a,r)}).then(function(a){e.readyState||e.open("POST",t,!0);var n=a?a:r;return{xhr:e,licenseChallenge:n}}):(e.open("POST",t,!0),Promise.resolve({xhr:e,licenseChallenge:r}))},t.requestLicense=function a(e,t){var r=this,n=this.config.keyLoadPolicy.default;return new Promise(function(a,i){var d=r.getLicenseServerUrl(e.keySystem);r.log("Sending license request to URL: "+d);var o=new XMLHttpRequest;o.responseType="arraybuffer",o.onreadystatechange=function(){if(!r.hls||!e.mediaKeysSession)return i(new Error("invalid state"));if(4===o.readyState)if(200===o.status){r._requestLicenseFailureCount=0;var s=o.response;r.log("License received "+(s instanceof ArrayBuffer?s.byteLength:s));var l=r.config.licenseResponseCallback;if(l)try{s=l.call(r.hls,o,d,e)}catch(e){r.error(e)}a(s)}else{var u=n.errorRetry,c=u?u.maxNumRetry:0;if(r._requestLicenseFailureCount++,r._requestLicenseFailureCount>c||400<=o.status&&500>o.status)i(new Nd({type:hr.KEY_SYSTEM_ERROR,details:Er.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0,networkDetails:o,response:{url:d,data:void 0,code:o.status,text:o.statusText}},"License Request XHR failed ("+d+"). Status: "+o.status+" ("+o.statusText+")"));else{var f=c-r._requestLicenseFailureCount+1;r.warn("Retrying license request, "+f+" attempts left"),r.requestLicense(e,t).then(a,i)}}},e.licenseXhr&&e.licenseXhr.readyState!==XMLHttpRequest.DONE&&e.licenseXhr.abort(),e.licenseXhr=o,r.setupLicenseXHR(o,d,e,t).then(function(e){var t=e.xhr,a=e.licenseChallenge;t.send(a)})})},t.onMediaAttached=function a(e,t){if(this.config.emeEnabled){var r=t.media;this.media=r,r.addEventListener("encrypted",this.onMediaEncrypted),r.addEventListener("waitingforkey",this.onWaitingForKey)}},t.onMediaDetached=function t(){var a=this,r=this.media,n=this.mediaKeySessions;r&&(r.removeEventListener("encrypted",this.onMediaEncrypted),r.removeEventListener("waitingforkey",this.onWaitingForKey),this.media=null),this._requestLicenseFailureCount=0,this.setMediaKeysQueue=[],this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},nn.clearKeyUriToKeyIdMap();var i=n.length;e.CDMCleanupPromise=Promise.all(n.map(function(e){return a.removeSession(e)}).concat(null==r?void 0:r.setMediaKeys(null).catch(function(e){a.log("Could not clear media keys: "+e+". media.src: "+(null==r?void 0:r.src))}))).then(function(){i&&(a.log("finished closing key sessions and clearing media keys"),n.length=0)}).catch(function(e){a.log("Could not close sessions and clear media keys: "+e+". media.src: "+(null==r?void 0:r.src))})},t.onManifestLoading=function e(){this.keyFormatPromise=null},t.onManifestLoaded=function a(e,t){var r=t.sessionKeys;if(r&&this.config.emeEnabled&&!this.keyFormatPromise){var n=r.reduce(function(e,t){return-1===e.indexOf(t.keyFormat)&&e.push(t.keyFormat),e},[]);this.log("Selecting key-system from session-keys "+n.join(", ")),this.keyFormatPromise=this.getKeyFormatPromise(n)}},t.removeSession=function t(e){var a=this,r=e.mediaKeysSession,n=e.licenseXhr;if(r){this.log("Remove licenses and keys and close session "+r.sessionId),r.onmessage=null,r.onkeystatuseschange=null,n&&n.readyState!==XMLHttpRequest.DONE&&n.abort(),e.mediaKeysSession=e.decryptdata=e.licenseXhr=void 0;var i=this.mediaKeySessions.indexOf(e);return-1<i&&this.mediaKeySessions.splice(i,1),r.remove().catch(function(e){a.log("Could not remove session: "+e)}).then(function(){return r.close()}).catch(function(e){a.log("Could not close session: "+e)})}},e}();Od.CDMCleanupPromise=void 0;var Nd=function(e){function t(t,a){var r;return r=e.call(this,a)||this,r.data=void 0,t.error||(t.error=new Error(a)),r.data=t,t.err=t.error,r}return S(t,e),t}(D(Error)),Md={MANIFEST:"m",AUDIO:"a",VIDEO:"v",MUXED:"av",INIT:"i",CAPTION:"c",TIMED_TEXT:"tt",KEY:"k",OTHER:"o"},wd=function(){function e(t){var a=this;this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=function(){a.initialized&&(a.starved=!0),a.buffering=!0},this.onPlaying=function(){a.initialized||(a.initialized=!0),a.buffering=!1},this.applyPlaylistData=function(e){try{a.apply(e,{ot:Md.MANIFEST,su:!a.initialized})}catch(e){Ar.warn("Could not generate manifest CMCD data.",e)}},this.applyFragmentData=function(e){try{var t=e.frag,r=a.hls.levels[t.level],n=a.getObjectType(t),i={d:1e3*t.duration,ot:n};(n===Md.VIDEO||n===Md.AUDIO||n==Md.MUXED)&&(i.br=r.bitrate/1e3,i.tb=a.getTopBandwidth(n)/1e3,i.bl=a.getBufferLength(n)),a.apply(e,i)}catch(e){Ar.warn("Could not generate segment CMCD data.",e)}},this.hls=t;var r=this.config=t.config,n=r.cmcd;null!=n&&(r.pLoader=this.createPlaylistLoader(),r.fLoader=this.createFragmentLoader(),this.sid=n.sessionId||e.uuid(),this.cid=n.contentId,this.useHeaders=!0===n.useHeaders,this.registerListeners())}var t=e.prototype;return t.registerListeners=function e(){var t=this.hls;t.on(Tr.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(Tr.MEDIA_DETACHED,this.onMediaDetached,this),t.on(Tr.BUFFER_CREATED,this.onBufferCreated,this)},t.unregisterListeners=function e(){var t=this.hls;t.off(Tr.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(Tr.MEDIA_DETACHED,this.onMediaDetached,this),t.off(Tr.BUFFER_CREATED,this.onBufferCreated,this)},t.destroy=function e(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null},t.onMediaAttached=function a(e,t){this.media=t.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)},t.onMediaDetached=function e(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)},t.onBufferCreated=function a(e,t){var r,n;this.audioBuffer=null==(r=t.tracks.audio)?void 0:r.buffer,this.videoBuffer=null==(n=t.tracks.video)?void 0:n.buffer},t.createData=function e(){var t;return{v:1,sf:"h",sid:this.sid,cid:this.cid,pr:null==(t=this.media)?void 0:t.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}},t.apply=function r(t,a){void 0===a&&(a={}),E(a,this.createData());var n=a.ot===Md.INIT||a.ot===Md.VIDEO||a.ot===Md.MUXED;if(this.starved&&n&&(a.bs=!0,a.su=!0,this.starved=!1),null==a.su&&(a.su=this.buffering),this.useHeaders){var i=e.toHeaders(a);if(!Object.keys(i).length)return;t.headers||(t.headers={}),E(t.headers,i)}else{var d=e.toQuery(a);if(!d)return;t.url=e.appendQueryToUri(t.url,d)}},t.getObjectType=function t(e){var a=e.type;return"subtitle"===a?Md.TIMED_TEXT:"initSegment"===e.sn?Md.INIT:"audio"===a?Md.AUDIO:"main"===a?this.hls.audioTracks.length?Md.VIDEO:Md.MUXED:void 0},t.getTopBandwidth=function t(e){var a=0,r=this.hls,n;if(e===Md.AUDIO)n=r.audioTracks;else{var i=r.maxAutoLevel,d=-1<i?i+1:r.levels.length;n=r.levels.slice(0,d)}for(var o=C(n),s,l;!(s=o()).done;)l=s.value,l.bitrate>a&&(a=l.bitrate);return 0<a?a:NaN},t.getBufferLength=function t(e){var a=this.hls.media,r=e===Md.AUDIO?this.audioBuffer:this.videoBuffer;if(!r||!a)return NaN;var n=Gn.bufferInfo(r,a.currentTime,this.config.maxBufferHole);return 1e3*n.len},t.createPlaylistLoader=function e(){var t=this.config.pLoader,a=this.applyPlaylistData,r=t||this.config.loader;return function(){function e(e){this.loader=void 0,this.loader=new r(e)}var t=e.prototype;return t.destroy=function e(){this.loader.destroy()},t.abort=function e(){this.loader.abort()},t.load=function n(e,t,r){a(e),this.loader.load(e,t,r)},T(e,[{key:"stats",get:function e(){return this.loader.stats}},{key:"context",get:function e(){return this.loader.context}}]),e}()},t.createFragmentLoader=function e(){var t=this.config.fLoader,a=this.applyFragmentData,r=t||this.config.loader;return function(){function e(e){this.loader=void 0,this.loader=new r(e)}var t=e.prototype;return t.destroy=function e(){this.loader.destroy()},t.abort=function e(){this.loader.abort()},t.load=function n(e,t,r){a(e),this.loader.load(e,t,r)},T(e,[{key:"stats",get:function e(){return this.loader.stats}},{key:"context",get:function e(){return this.loader.context}}]),e}()},e.uuid=function e(){var t=URL.createObjectURL(new Blob),e=t.toString();return URL.revokeObjectURL(t),e.slice(e.lastIndexOf("/")+1)},e.serialize=function t(e){for(var a=[],r=function t(e){var a=Number.isNaN;return!a(e)&&null!=e&&""!==e&&!1!==e},n=function t(e){return d(e)},i=function t(e){return 100*n(e/100)},o=function t(e){return encodeURIComponent(e)},s={br:n,d:n,bl:i,dl:i,mtp:i,nor:o,rtp:i,tb:n},l=Object.keys(e||{}).sort(),u=C(l),c;!(c=u()).done;){var f=c.value,g=e[f];if(r(g)&&("v"!==f||1!==g)&&("pr"!=f||1!==g)){var m=s[f];m&&(g=m(g));var p=typeof g,y=void 0;y="ot"===f||"sf"===f||"st"===f?f+"="+g:"boolean"===p?f:"number"===p?f+"="+g:f+"="+JSON.stringify(g),a.push(y)}}return a.join(",")},e.toHeaders=function a(t){for(var r=Object.keys(t),n={},d=["Object","Request","Session","Status"],o=[{},{},{},{}],s={br:0,d:0,ot:0,tb:0,bl:1,dl:1,mtp:1,nor:1,nrr:1,su:1,cid:2,pr:2,sf:2,sid:2,st:2,v:2,bs:3,rtp:3},l=0,u=r;l<u.length;l++){var c=u[l],f=null==s[c]?1:s[c];o[f][c]=t[c]}for(var g=0,m;g<o.length;g++)m=e.serialize(o[g]),m&&(n["CMCD-"+d[g]]=m);return n},e.toQuery=function a(t){return"CMCD="+encodeURIComponent(e.serialize(t))},e.appendQueryToUri=function a(e,t){if(!t)return e;var r=e.includes("?")?"&":"?";return""+e+r+t},e}(),Bd=function(){function e(e){this.hls=void 0,this.log=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this.pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=e,this.log=Ar.log.bind(Ar,"[content-steering]:"),this.registerListeners()}var t=e.prototype;return t.registerListeners=function e(){var t=this.hls;t.on(Tr.MANIFEST_LOADING,this.onManifestLoading,this),t.on(Tr.MANIFEST_LOADED,this.onManifestLoaded,this),t.on(Tr.MANIFEST_PARSED,this.onManifestParsed,this),t.on(Tr.ERROR,this.onError,this)},t.unregisterListeners=function e(){var t=this.hls;t&&(t.off(Tr.MANIFEST_LOADING,this.onManifestLoading,this),t.off(Tr.MANIFEST_LOADED,this.onManifestLoaded,this),t.off(Tr.MANIFEST_PARSED,this.onManifestParsed,this),t.off(Tr.ERROR,this.onError,this))},t.startLoad=function e(){if(this.started=!0,self.clearTimeout(this.reloadTimer),this.enabled&&this.uri)if(this.updated){var t=f(1e3*this.timeToLoad-(performance.now()-this.updated),0);this.scheduleRefresh(this.uri,t)}else this.loadSteeringManifest(this.uri)},t.stopLoad=function e(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),self.clearTimeout(this.reloadTimer)},t.destroy=function e(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null},t.removeLevel=function t(e){var a=this.levels;a&&(this.levels=a.filter(function(t){return t!==e}))},t.onManifestLoading=function e(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null},t.onManifestLoaded=function a(e,t){var r=t.contentSteering;null===r||(this.pathwayId=r.pathwayId,this.uri=r.uri,this.started&&this.startLoad())},t.onManifestParsed=function a(e,t){this.audioTracks=t.audioTracks,this.subtitleTracks=t.subtitleTracks},t.onError=function a(e,t){var r=t.errorAction;if((null==r?void 0:r.action)===kn.SendAlternateToPenaltyBox&&r.flags===_n.MoveAllAlternatesMatchingHost){var n=this.pathwayPriority,i=this.pathwayId;this.penalizedPathways[i]||(this.penalizedPathways[i]=performance.now()),!n&&this.levels&&(n=this.levels.reduce(function(e,t){return-1===e.indexOf(t.pathwayId)&&e.push(t.pathwayId),e},[])),n&&1<n.length&&(this.updatePathwayPriority(n),r.resolved=this.pathwayId!==i)}},t.filterParsedLevels=function t(e){this.levels=e;var a=this.getLevelsForPathway(this.pathwayId);if(0===a.length){var r=e[0].pathwayId;this.log("No levels found in Pathway "+this.pathwayId+". Setting initial Pathway to \""+r+"\""),a=this.getLevelsForPathway(r),this.pathwayId=r}return a.length===e.length?e:(this.log("Found "+a.length+"/"+e.length+" levels in Pathway \""+this.pathwayId+"\""),a)},t.getLevelsForPathway=function t(e){return null===this.levels?[]:this.levels.filter(function(t){return e===t.pathwayId})},t.updatePathwayPriority=function t(e){this.pathwayPriority=e;var a=this.penalizedPathways,r=performance.now(),n;Object.keys(a).forEach(function(e){r-a[e]>3e5&&delete a[e]});for(var d=0,o;d<e.length;d++)if(o=e[d],!a[o]){if(o===this.pathwayId)return;var s=this.hls.nextLoadLevel,l=this.hls.levels[s];if(n=this.getLevelsForPathway(o),0<n.length){this.log("Setting Pathway to \""+o+"\""),this.pathwayId=o,this.hls.trigger(Tr.LEVELS_UPDATED,{levels:n});var u=this.hls.levels[s];l&&u&&this.levels&&(u.attrs["STABLE-VARIANT-ID"]!==l.attrs["STABLE-VARIANT-ID"]&&u.bitrate!==l.bitrate&&this.log("Unstable Pathways change from bitrate "+l.bitrate+" to "+u.bitrate),this.hls.nextLoadLevel=s);break}}},t.clonePathways=function t(e){var a=this,r=this.levels;if(r){var n={},i={};e.forEach(function(e){var t=e.ID,d=e["BASE-ID"],o=e["URI-REPLACEMENT"];if(!r.some(function(e){return e.pathwayId===t})){var s=a.getLevelsForPathway(d).map(function(e){var a=E({},e);a.details=void 0,a.url=ir(e.uri,e.attrs["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",o);var r=new Dr(e.attrs);r["PATHWAY-ID"]=t;var d=r.AUDIO&&r.AUDIO+"_clone_"+t,s=r.SUBTITLES&&r.SUBTITLES+"_clone_"+t;d&&(n[r.AUDIO]=d,r.AUDIO=d),s&&(i[r.SUBTITLES]=s,r.SUBTITLES=s),a.attrs=r;var l=new In(a);return Lt(l,"audio",d),Lt(l,"text",s),l});r.push.apply(r,s),nr(a.audioTracks,n,o,t),nr(a.subtitleTracks,i,o,t)}})}},t.loadSteeringManifest=function t(e){var a=this,r=this.hls.config,n=r.loader;this.loader&&this.loader.destroy(),this.loader=new n(r);var i;try{i=new self.URL(e)}catch(t){return this.enabled=!1,void this.log("Failed to parse Steering Manifest URI: "+e)}if("data:"!==i.protocol){var d=0|(this.hls.bandwidthEstimate||r.abrEwmaDefaultEstimate);i.searchParams.set("_HLS_pathway",this.pathwayId),i.searchParams.set("_HLS_throughput",""+d)}var o={responseType:"json",url:i.href},s=r.steeringManifestLoadPolicy.default,l=s.errorRetry||s.timeoutRetry||{},u={loadPolicy:s,timeout:s.maxLoadTimeMs,maxRetry:l.maxNumRetry||0,retryDelay:l.retryDelayMs||0,maxRetryDelay:l.maxRetryDelayMs||0},c={onSuccess:function d(e,t,r,n){a.log("Loaded steering manifest: \""+i+"\"");var o=e.data;if(1!==o.VERSION)return void a.log("Steering VERSION "+o.VERSION+" not supported!");a.updated=performance.now(),a.timeToLoad=o.TTL;var s=o["RELOAD-URI"],l=o["PATHWAY-CLONES"],u=o["PATHWAY-PRIORITY"];if(s)try{a.uri=new self.URL(s,i).href}catch(e){return a.enabled=!1,void a.log("Failed to parse Steering Manifest RELOAD-URI: "+s)}a.scheduleRefresh(a.uri||r.url),l&&a.clonePathways(l),u&&a.updatePathwayPriority(u)},onError:function i(e,t,r,n){if(a.log("Error loading steering manifest: "+e.code+" "+e.text+" ("+t.url+")"),a.stopLoad(),410===e.code)return a.enabled=!1,void a.log("Steering manifest "+t.url+" no longer available");var d=1e3*a.timeToLoad;if(429===e.code){var o=a.loader;if("function"==typeof(null==o?void 0:o.getResponseHeader)){var s=o.getResponseHeader("Retry-After");s&&(d=1e3*parseFloat(s))}return void a.log("Steering manifest "+t.url+" rate limited")}a.scheduleRefresh(a.uri||t.url,d)},onTimeout:function n(e,t,r){a.log("Timeout loading steering manifest ("+t.url+")"),a.scheduleRefresh(a.uri||t.url)}};this.log("Requesting steering manifest: "+i),this.loader.load(o,u,c)},t.scheduleRefresh=function a(e,t){var r=this;void 0===t&&(t=1e3*this.timeToLoad),self.clearTimeout(this.reloadTimer),this.reloadTimer=self.setTimeout(function(){r.loadSteeringManifest(e)},t)},e}(),Ud=/^age:\s*[\d.]+\s*$/im,Gd=function(){function e(e){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=void 0,this.loader=null,this.stats=void 0,this.xhrSetup=e?e.xhrSetup||null:null,this.stats=new _r,this.retryDelay=0}var t=e.prototype;return t.destroy=function e(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null},t.abortInternal=function e(){var t=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),t&&(t.onreadystatechange=null,t.onprogress=null,4!==t.readyState&&(this.stats.aborted=!0,t.abort()))},t.abort=function e(){var t;this.abortInternal(),null!=(t=this.callbacks)&&t.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)},t.load=function r(e,t,a){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=e,this.config=t,this.callbacks=a,this.loadInternal()},t.loadInternal=function e(){var t=this,a=this.config,r=this.context;if(a){var n=this.loader=new self.XMLHttpRequest,i=this.stats;i.loading.first=0,i.loaded=0,i.aborted=!1;var d=this.xhrSetup;d?Promise.resolve().then(function(){return t.stats.aborted?void 0:d(n,r.url)}).catch(function(e){return n.open("GET",r.url,!0),d(n,r.url)}).then(function(){t.stats.aborted||t.openAndSendXhr(n,r,a)}).catch(function(e){t.callbacks.onError({code:n.status,text:e.message},r,n,i)}):this.openAndSendXhr(n,r,a)}},t.openAndSendXhr=function r(e,t,a){e.readyState||e.open("GET",t.url,!0);var n=this.context.headers,i=a.loadPolicy,d=i.maxTimeToFirstByteMs,o=i.maxLoadTimeMs;if(n)for(var s in n)e.setRequestHeader(s,n[s]);t.rangeEnd&&e.setRequestHeader("Range","bytes="+t.rangeStart+"-"+(t.rangeEnd-1)),e.onreadystatechange=this.readystatechange.bind(this),e.onprogress=this.loadprogress.bind(this),e.responseType=t.responseType,self.clearTimeout(this.requestTimeout),a.timeout=d&&yr(d)?d:o,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),a.timeout),e.send()},t.readystatechange=function e(){var t=this.context,a=this.loader,r=this.stats;if(t&&a){var n=a.readyState,i=this.config;if(!r.aborted&&2<=n&&(0===r.loading.first&&(r.loading.first=f(self.performance.now(),r.loading.start),i.timeout!==i.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),i.timeout=i.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),i.loadPolicy.maxLoadTimeMs-(r.loading.first-r.loading.start)))),4===n)){self.clearTimeout(this.requestTimeout),a.onreadystatechange=null,a.onprogress=null;var d=a.status,o="text"!==a.responseType;if(200<=d&&300>d&&(o&&a.response||null!==a.responseText)){r.loading.end=f(self.performance.now(),r.loading.first);var s=o?a.response:a.responseText,l="arraybuffer"===a.responseType?s.byteLength:s.length;if(r.loaded=r.total=l,r.bwEstimate=8e3*r.total/(r.loading.end-r.loading.first),!this.callbacks)return;var u=this.callbacks.onProgress;if(u&&u(r,t,s,a),!this.callbacks)return;var c={url:a.responseURL,data:s,code:d};this.callbacks.onSuccess(c,r,t,a)}else{var g=i.loadPolicy.errorRetry,m=r.retry;gt(g,m,!1,d)?this.retry(g):(Ar.error(d+" while loading "+t.url),this.callbacks.onError({code:d,text:a.statusText},t,a,r))}}}},t.loadtimeout=function e(){var t=null==(r=this.config)?void 0:r.loadPolicy.timeoutRetry,a=this.stats.retry,r;if(gt(t,a,!0))this.retry(t);else{Ar.warn("timeout while loading "+this.context.url);var n=this.callbacks;n&&(this.abortInternal(),n.onTimeout(this.stats,this.context,this.loader))}},t.retry=function t(e){var a=this.context,r=this.stats;this.retryDelay=ct(e,r.retry),r.retry++,Ar.warn((status?"HTTP Status "+status:"Timeout")+" while loading "+a.url+", retrying "+r.retry+"/"+e.maxNumRetry+" in "+this.retryDelay+"ms"),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)},t.loadprogress=function t(e){var a=this.stats;a.loaded=e.loaded,e.lengthComputable&&(a.total=e.total)},t.getCacheAge=function e(){var t=null;if(this.loader&&Ud.test(this.loader.getAllResponseHeaders())){var a=this.loader.getResponseHeader("age");t=a?parseFloat(a):null}return t},t.getResponseHeader=function t(e){return this.loader&&new RegExp("^"+e+":\\s*[\\d.]+\\s*$","im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(e):null},e}(),Kd=/(\d+)-(\d+)\/(\d+)/,Hd=function(){function e(e){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=void 0,this.response=void 0,this.controller=void 0,this.context=void 0,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=e.fetchSetup||ur,this.controller=new self.AbortController,this.stats=new _r}var t=e.prototype;return t.destroy=function e(){this.loader=this.callbacks=null,this.abortInternal()},t.abortInternal=function e(){var t=this.response;null!=t&&t.ok||(this.stats.aborted=!0,this.controller.abort())},t.abort=function e(){var t;this.abortInternal(),null!=(t=this.callbacks)&&t.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)},t.load=function r(e,t,a){var n=this,i=this.stats;if(i.loading.start)throw new Error("Loader can only be used once.");i.loading.start=self.performance.now();var d=or(e,this.controller.signal),o=a.onProgress,s="arraybuffer"===e.responseType,l=s?"byteLength":"length",u=t.loadPolicy,c=u.maxTimeToFirstByteMs,g=u.maxLoadTimeMs;this.context=e,this.config=t,this.callbacks=a,this.request=this.fetchSetup(e,d),self.clearTimeout(this.requestTimeout),t.timeout=c&&yr(c)?c:g,this.requestTimeout=self.setTimeout(function(){n.abortInternal(),a.onTimeout(i,e,n.response)},t.timeout),self.fetch(this.request).then(function(r){n.response=n.loader=r;var d=f(self.performance.now(),i.loading.start);if(self.clearTimeout(n.requestTimeout),t.timeout=g,n.requestTimeout=self.setTimeout(function(){n.abortInternal(),a.onTimeout(i,e,n.response)},g-(d-i.loading.start)),!r.ok){var l=r.status,u=r.statusText;throw new Vd(u||"fetch, bad network response",l,r)}return i.loading.first=d,i.total=lr(r.headers)||i.total,o&&yr(t.highWaterMark)?n.loadProgressively(r,i,e,t.highWaterMark,o):s?r.arrayBuffer():"json"===e.responseType?r.json():r.text()}).then(function(r){var d=n.response;self.clearTimeout(n.requestTimeout),i.loading.end=f(self.performance.now(),i.loading.first);var s=r[l];s&&(i.loaded=i.total=s);var u={url:d.url,data:r,code:d.status};o&&!yr(t.highWaterMark)&&o(i,e,r,d),a.onSuccess(u,i,e,d)}).catch(function(t){if(self.clearTimeout(n.requestTimeout),!i.aborted){var r=t?t.code||0:0,d=t?t.message:null;a.onError({code:r,text:d},e,t?t.details:null,i)}})},t.getCacheAge=function e(){var t=null;if(this.response){var a=this.response.headers.get("age");t=a?parseFloat(a):null}return t},t.getResponseHeader=function t(e){return this.response?this.response.headers.get(e):null},t.loadProgressively=function i(e,t,a,r,n){void 0===r&&(r=0);var d=new Ui,o=e.body.getReader(),s=function i(){return o.read().then(function(o){if(o.done)return d.dataLength&&n(t,a,d.flush(),e),Promise.resolve(new ArrayBuffer(0));var s=o.value,l=s.length;return t.loaded+=l,l<r||d.dataLength?(d.push(s),d.dataLength>=r&&n(t,a,d.flush(),e)):n(t,a,s,e),i()}).catch(function(){return Promise.reject()})};return s()},e}(),Vd=function(e){function t(t,a,r){var n;return n=e.call(this,t)||this,n.code=void 0,n.details=void 0,n.code=a,n.details=r,n}return S(t,e),t}(D(Error)),Wd=/\s/,Yd={newCue:function i(e,t,a,n){for(var d=[],s=self.VTTCue||self.TextTrackCue,l=0,f,g,m,p,y;l<n.rows.length;l++)if(f=n.rows[l],m=!0,p=0,y="",!f.isEmpty()){for(var T=0,h;T<f.chars.length;T++)Wd.test(f.chars[T].uchar)&&m?p++:(y+=f.chars[T].uchar,m=!1);f.cueStartTime=t,t===a&&(a+=1e-4),16<=p?p--:p++;var E=Ka(y.trim()),S=Ha(t,a,E);null!=e&&null!=(h=e.cues)&&h.getCueById(S)||(g=new s(t,a,E),g.id=S,g.line=l+1,g.align="left",g.position=10+o(80,10*u(8*p/32)),d.push(g))}return e&&d.length&&(d.sort(function(e,t){return"auto"===e.line||"auto"===t.line?0:8<e.line&&8<t.line?t.line-e.line:e.line-t.line}),d.forEach(function(t){return He(e,t)})),d}},qd=p(p({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,maxBufferSize:60000000,maxBufferHole:.1,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.25,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,loader:Gd,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:Bi,bufferController:Qi,capLevelController:Pd,errorController:bn,fpsController:xd,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:wr,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableID3MetadataCues:!0,certLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null}},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},function e(){return{cueHandler:Yd,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}}()),{},{subtitleStreamController:Wi,subtitleTrackController:qi,timelineController:Cd,audioStreamController:Ki,audioTrackController:Hi,emeController:Od,cmcdController:wd,contentSteeringController:Bd}),zd=function(){function e(t){void 0===t&&(t={}),this.config=void 0,this.userConfig=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this._emitter=new Ci,this._autoLevelCapping=void 0,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this.url=null,N(t.debug||!1,"Hls instance");var a=this.config=cr(e.DefaultConfig,t);this.userConfig=t,this._autoLevelCapping=-1,a.progressive&&gr(a);var r=a.abrController,n=a.bufferController,i=a.capLevelController,d=a.errorController,o=a.fpsController,s=new d(this),l=this.abrController=new r(this),u=this.bufferController=new n(this),c=this.capLevelController=new i(this),f=new o(this),g=new Tn(this),m=new Sn(this),p=a.contentSteeringController,y=p?new p(this):null,T=this.levelController=new Pn(this,y),h=new Fn(this),E=new wn(this.config),S=this.streamController=new Ni(this,h,E);c.setStreamController(S),f.setStreamController(S);var L=[g,T,S];y&&L.splice(1,0,y),this.networkControllers=L;var R=[l,u,c,f,m,h];this.audioTrackController=this.createController(a.audioTrackController,L);var A=a.audioStreamController;A&&L.push(new A(this,h,E)),this.subtitleTrackController=this.createController(a.subtitleTrackController,L);var v=a.subtitleStreamController;v&&L.push(new v(this,h,E)),this.createController(a.timelineController,R),E.emeController=this.emeController=this.createController(a.emeController,R),this.cmcdController=this.createController(a.cmcdController,R),this.latencyController=this.createController(Ln,R),this.coreComponents=R,L.push(s);var I=s.onErrorOut;"function"==typeof I&&this.on(Tr.ERROR,I,s)}e.isSupported=function e(){return Ut()};var t=e.prototype;return t.createController=function a(e,t){if(e){var r=new e(this);return t&&t.push(r),r}return null},t.on=function r(e,t,a){void 0===a&&(a=this),this._emitter.on(e,t,a)},t.once=function r(e,t,a){void 0===a&&(a=this),this._emitter.once(e,t,a)},t.removeAllListeners=function t(e){this._emitter.removeAllListeners(e)},t.off=function n(e,t,a,r){void 0===a&&(a=this),this._emitter.off(e,t,a,r)},t.listeners=function t(e){return this._emitter.listeners(e)},t.emit=function r(e,t,a){return this._emitter.emit(e,t,a)},t.trigger=function r(t,a){if(this.config.debug)return this.emit(t,t,a);try{return this.emit(t,t,a)}catch(a){Ar.error("An internal error happened while handling event "+t+". Error message: \""+a.message+"\". Here is a stacktrace:",a),this.trigger(Tr.ERROR,{type:hr.OTHER_ERROR,details:Er.INTERNAL_EXCEPTION,fatal:!1,event:t,error:a})}return!1},t.listenerCount=function t(e){return this._emitter.listenerCount(e)},t.destroy=function e(){Ar.log("destroy"),this.trigger(Tr.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this.url=null,this.networkControllers.forEach(function(e){return e.destroy()}),this.networkControllers.length=0,this.coreComponents.forEach(function(e){return e.destroy()}),this.coreComponents.length=0;var t=this.config;t.xhrSetup=t.fetchSetup=void 0,this.userConfig=null},t.attachMedia=function t(e){Ar.log("attachMedia"),this._media=e,this.trigger(Tr.MEDIA_ATTACHING,{media:e})},t.detachMedia=function e(){Ar.log("detachMedia"),this.trigger(Tr.MEDIA_DETACHING,void 0),this._media=null},t.loadSource=function t(e){this.stopLoad();var a=this.media,r=this.url,n=this.url=pr.buildAbsoluteURL(self.location.href,e,{alwaysNormalize:!0});Ar.log("loadSource:"+n),a&&r&&(r!==n||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(a)),this.trigger(Tr.MANIFEST_LOADING,{url:e})},t.startLoad=function t(e){void 0===e&&(e=-1),Ar.log("startLoad("+e+")"),this.networkControllers.forEach(function(t){t.startLoad(e)})},t.stopLoad=function e(){Ar.log("stopLoad"),this.networkControllers.forEach(function(e){e.stopLoad()})},t.swapAudioCodec=function e(){Ar.log("swapAudioCodec"),this.streamController.swapAudioCodec()},t.recoverMediaError=function e(){Ar.log("recoverMediaError");var t=this._media;this.detachMedia(),t&&this.attachMedia(t)},t.removeLevel=function a(e,t){void 0===t&&(t=0),this.levelController.removeLevel(e,t)},T(e,[{key:"levels",get:function e(){var t=this.levelController.levels;return t?t:[]}},{key:"currentLevel",get:function e(){return this.streamController.currentLevel},set:function t(e){Ar.log("set currentLevel:"+e),this.loadLevel=e,this.abrController.clearTimer(),this.streamController.immediateLevelSwitch()}},{key:"nextLevel",get:function e(){return this.streamController.nextLevel},set:function t(e){Ar.log("set nextLevel:"+e),this.levelController.manualLevel=e,this.streamController.nextLevelSwitch()}},{key:"loadLevel",get:function e(){return this.levelController.level},set:function t(e){Ar.log("set loadLevel:"+e),this.levelController.manualLevel=e}},{key:"nextLoadLevel",get:function e(){return this.levelController.nextLoadLevel},set:function t(e){this.levelController.nextLoadLevel=e}},{key:"firstLevel",get:function e(){return f(this.levelController.firstLevel,this.minAutoLevel)},set:function t(e){Ar.log("set firstLevel:"+e),this.levelController.firstLevel=e}},{key:"startLevel",get:function e(){return this.levelController.startLevel},set:function t(e){Ar.log("set startLevel:"+e),-1!==e&&(e=f(e,this.minAutoLevel)),this.levelController.startLevel=e}},{key:"capLevelToPlayerSize",get:function e(){return this.config.capLevelToPlayerSize},set:function t(e){var a=!!e;a!==this.config.capLevelToPlayerSize&&(a?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=a)}},{key:"autoLevelCapping",get:function e(){return this._autoLevelCapping},set:function t(e){this._autoLevelCapping!==e&&(Ar.log("set autoLevelCapping:"+e),this._autoLevelCapping=e)}},{key:"bandwidthEstimate",get:function e(){var t=this.abrController.bwEstimator;return t?t.getEstimate():NaN}},{key:"ttfbEstimate",get:function e(){var t=this.abrController.bwEstimator;return t?t.getEstimateTTFB():NaN}},{key:"maxHdcpLevel",get:function e(){return this._maxHdcpLevel},set:function t(e){-1<Rn.indexOf(e)&&(this._maxHdcpLevel=e)}},{key:"autoLevelEnabled",get:function e(){return-1===this.levelController.manualLevel}},{key:"manualLevel",get:function e(){return this.levelController.manualLevel}},{key:"minAutoLevel",get:function e(){var t=this.levels,a=this.config.minAutoBitrate;if(!t)return 0;for(var r=t.length,n=0;n<r;n++)if(t[n].maxBitrate>=a)return n;return 0}},{key:"maxAutoLevel",get:function e(){var t=this.levels,a=this.autoLevelCapping,r=this.maxHdcpLevel,n;if(n=-1===a&&t&&t.length?t.length-1:a,r)for(var d=n,o;d--;)if(o=t[d].attrs["HDCP-LEVEL"],o&&o<=r)return d;return n}},{key:"nextAutoLevel",get:function e(){return o(f(this.abrController.nextAutoLevel,this.minAutoLevel),this.maxAutoLevel)},set:function t(e){this.abrController.nextAutoLevel=f(this.minAutoLevel,e)}},{key:"playingDate",get:function e(){return this.streamController.currentProgramDateTime}},{key:"mainForwardBufferInfo",get:function e(){return this.streamController.getMainFwdBufferInfo()}},{key:"audioTracks",get:function e(){var t=this.audioTrackController;return t?t.audioTracks:[]}},{key:"audioTrack",get:function e(){var t=this.audioTrackController;return t?t.audioTrack:-1},set:function t(e){var a=this.audioTrackController;a&&(a.audioTrack=e)}},{key:"subtitleTracks",get:function e(){var t=this.subtitleTrackController;return t?t.subtitleTracks:[]}},{key:"subtitleTrack",get:function e(){var t=this.subtitleTrackController;return t?t.subtitleTrack:-1},set:function t(e){var a=this.subtitleTrackController;a&&(a.subtitleTrack=e)}},{key:"media",get:function e(){return this._media}},{key:"subtitleDisplay",get:function e(){var t=this.subtitleTrackController;return!!t&&t.subtitleDisplay},set:function t(e){var a=this.subtitleTrackController;a&&(a.subtitleDisplay=e)}},{key:"lowLatencyMode",get:function e(){return this.config.lowLatencyMode},set:function t(e){this.config.lowLatencyMode=e}},{key:"liveSyncPosition",get:function e(){return this.latencyController.liveSyncPosition}},{key:"latency",get:function e(){return this.latencyController.latency}},{key:"maxLatency",get:function e(){return this.latencyController.maxLatency}},{key:"targetLatency",get:function e(){return this.latencyController.targetLatency}},{key:"drift",get:function e(){return this.latencyController.drift}},{key:"forceStartLoad",get:function e(){return this.streamController.forceStartLoad}}],[{key:"version",get:function e(){return"1.4.12"}},{key:"Events",get:function e(){return Tr}},{key:"ErrorTypes",get:function e(){return hr}},{key:"ErrorDetails",get:function e(){return Er}},{key:"DefaultConfig",get:function t(){return e.defaultConfig?e.defaultConfig:qd},set:function a(t){e.defaultConfig=t}}]),e}();return zd.defaultConfig=void 0,zd})})(!1);